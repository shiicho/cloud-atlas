# 05 - ç½‘ç»œæ€§èƒ½ï¼ˆNetwork Performanceï¼‰

> **ç›®æ ‡**ï¼šä½¿ç”¨ ssã€iperf3ã€tcpdump åˆ†æç½‘ç»œæ€§èƒ½ç“¶é¢ˆï¼Œå»ºç«‹ç½‘ç»œåŸºçº¿  
> **å‰ç½®**ï¼šLX09-01 USE Methodã€LX06 ç½‘ç»œåŸºç¡€ï¼ˆssã€TCP/IPï¼‰  
> **æ—¶é—´**ï¼šâš¡ 25 åˆ†é’Ÿï¼ˆé€Ÿè¯»ï¼‰/ ğŸ”¬ 90 åˆ†é’Ÿï¼ˆå®Œæ•´å®æ“ï¼‰  
> **å®æˆ˜åœºæ™¯**ï¼šã‚¿ã‚¤ãƒ ã‚»ãƒ¼ãƒ«æ™‚ã®ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆå•é¡Œèª¿æŸ»ã€ECã‚µã‚¤ãƒˆé‹ç”¨  

---

## å°†å­¦åˆ°çš„å†…å®¹

1. ç†è§£ç½‘ç»œæ€§èƒ½å››å¤§æŒ‡æ ‡ï¼šBandwidthã€Latencyã€Packet Lossã€Jitter
2. ä½¿ç”¨ ss å‘½ä»¤æ·±å…¥åˆ†æ socket çŠ¶æ€å’Œé˜Ÿåˆ—æ·±åº¦
3. ä½¿ç”¨ iperf3 å»ºç«‹ç½‘ç»œåŸºçº¿ï¼ˆTCP/UDP ååé‡ï¼‰
4. ä½¿ç”¨ ip -s link å’Œ ethtool -S æ£€æŸ¥æ¥å£ç»Ÿè®¡
5. ç†è§£ TCP ç¼“å†²åŒºè°ƒä¼˜åŸºç¡€ï¼ˆnet.ipv4.tcp_rmem/wmemï¼‰
6. ä½¿ç”¨ tcpdump ä»æ€§èƒ½è§’åº¦åˆ†æå»¶è¿Ÿå’Œé‡ä¼ 

---

## å…ˆè·‘èµ·æ¥ï¼ï¼ˆ10 åˆ†é’Ÿï¼‰

> åœ¨æ·±å…¥ç†è®ºä¹‹å‰ï¼Œå…ˆä½“éªŒç½‘ç»œæ€§èƒ½æ•°æ®é‡‡é›†ã€‚  
> è¿è¡Œè¿™äº›å‘½ä»¤ï¼Œè§‚å¯Ÿè¾“å‡º â€” è¿™å°±æ˜¯ä½ å°†è¦ç³»ç»ŸåŒ–æŒæ¡çš„æŠ€èƒ½ã€‚  

```bash
# Socket ç»Ÿè®¡æ‘˜è¦ â€” æ•´ä½“è¿æ¥çŠ¶æ€
ss -s

# è¯¦ç»† TCP è¿æ¥çŠ¶æ€ â€” è°åœ¨é€šä¿¡ï¼Ÿ
ss -ntp state established | head -20

# æŸ¥çœ‹ socket é˜Ÿåˆ—æ·±åº¦ â€” æœ‰æ•°æ®å †ç§¯å—ï¼Ÿ
ss -ntp | awk '$2 > 0 || $3 > 0 {print}' | head -10

# ç½‘ç»œæ¥å£ç»Ÿè®¡ â€” æœ‰ä¸¢åŒ…/é”™è¯¯å—ï¼Ÿ
ip -s link show | head -30

# TCP å†…éƒ¨ä¿¡æ¯ â€” é‡ä¼ ã€RTTã€cwnd
ss -ti state established | head -20
```

**ä½ åˆšåˆšæ•è·äº†ç³»ç»Ÿçš„ç½‘ç»œæ€§èƒ½å¿«ç…§ï¼**

- `ss -s` å‘Šè¯‰ä½ è¿æ¥æ€»æ•°å’Œå„çŠ¶æ€åˆ†å¸ƒ
- `ss -ntp` æ˜¾ç¤ºæ¯ä¸ªè¿æ¥çš„è¯¦ç»†ä¿¡æ¯
- `Recv-Q/Send-Q` æ˜¾ç¤º socket é˜Ÿåˆ—æ·±åº¦ï¼ˆæ•°æ®å †ç§¯æƒ…å†µï¼‰
- `ip -s link` æ˜¾ç¤ºæ¥å£çº§åˆ«çš„åŒ…è®¡æ•°ã€é”™è¯¯ã€ä¸¢å¼ƒ
- `ss -ti` æ˜¾ç¤º TCP å†…éƒ¨çŠ¶æ€ï¼ˆé‡ä¼ ã€RTTã€æ‹¥å¡çª—å£ï¼‰

**è¿™äº›æ•°å­—æ„å‘³ç€ä»€ä¹ˆï¼Ÿæ­£å¸¸è¿˜æ˜¯å¼‚å¸¸ï¼Ÿ**

è®©æˆ‘ä»¬ç”¨ USE Method ç³»ç»Ÿæ€§åœ°åˆ†æç½‘ç»œæ€§èƒ½ã€‚

---

## Step 1 - ç½‘ç»œæ€§èƒ½çš„ USE Method è§†è§’ï¼ˆ10 åˆ†é’Ÿï¼‰

### 1.1 å›é¡¾ USE Method

åœ¨ [Lesson 01](../01-use-methodology/) ä¸­ï¼Œæˆ‘ä»¬å­¦ä¹ äº† USE Methodã€‚å¯¹äºç½‘ç»œèµ„æºï¼š

| ç»´åº¦ | ç½‘ç»œå«ä¹‰ | æ£€æŸ¥å‘½ä»¤ |
|------|----------|----------|
| **U**tilization | å¸¦å®½ä½¿ç”¨ç‡ | `ip -s link`, `sar -n DEV`, `ethtool -S` |
| **S**aturation | Socket é˜Ÿåˆ—æ·±åº¦ã€è¿æ¥æ’é˜Ÿ | `ss -nmp`, `netstat -s (overflows)` |
| **E**rrors | ä¸¢åŒ…ã€é‡ä¼ ã€CRC é”™è¯¯ | `ip -s link (errors, dropped)`, `ss -ti (retrans)` |

### 1.2 ç½‘ç»œæ€§èƒ½å››å¤§æŒ‡æ ‡

<!-- DIAGRAM: network-metrics-overview -->
```
ç½‘ç»œæ€§èƒ½å››å¤§æŒ‡æ ‡
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                                         â”‚
  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
  â”‚   â”‚ Bandwidthï¼ˆå¸¦å®½ï¼‰   â”‚           â”‚ Latencyï¼ˆå»¶è¿Ÿï¼‰     â”‚              â”‚
  â”‚   â”‚ å•ä½ï¼šMbps, Gbps   â”‚           â”‚ å•ä½ï¼šms, us        â”‚              â”‚
  â”‚   â”‚                    â”‚           â”‚                    â”‚              â”‚
  â”‚   â”‚ æ•°æ®ä¼ è¾“é€Ÿç‡       â”‚           â”‚ æ•°æ®å¾€è¿”æ—¶é—´        â”‚              â”‚
  â”‚   â”‚ "ç®¡é“æœ‰å¤šç²—"       â”‚           â”‚ "ç®¡é“æœ‰å¤šé•¿"        â”‚              â”‚
  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
  â”‚                                                                         â”‚
  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
  â”‚   â”‚ Packet Lossï¼ˆä¸¢åŒ…ï¼‰â”‚           â”‚ Jitterï¼ˆæŠ–åŠ¨ï¼‰      â”‚              â”‚
  â”‚   â”‚ å•ä½ï¼š%            â”‚           â”‚ å•ä½ï¼šms            â”‚              â”‚
  â”‚   â”‚                    â”‚           â”‚                    â”‚              â”‚
  â”‚   â”‚ æ•°æ®åŒ…ä¸¢å¤±æ¯”ä¾‹     â”‚           â”‚ å»¶è¿Ÿçš„æ³¢åŠ¨ç¨‹åº¦      â”‚              â”‚
  â”‚   â”‚ "ç®¡é“æ¼äº†å¤šå°‘"     â”‚           â”‚ "å»¶è¿Ÿç¨³å®šå—"        â”‚              â”‚
  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
  â”‚                                                                         â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                                         â”‚
  â”‚   å¸¦å®½å†³å®šååé‡ä¸Šé™                                                     â”‚
  â”‚   å»¶è¿Ÿå†³å®šå“åº”æ—¶é—´                                                       â”‚
  â”‚   ä¸¢åŒ…å¯¼è‡´é‡ä¼ å’Œå»¶è¿ŸæŠ–åŠ¨                                                 â”‚
  â”‚   æŠ–åŠ¨å½±å“å®æ—¶åº”ç”¨ï¼ˆVoIPã€è§†é¢‘ã€æ¸¸æˆï¼‰                                    â”‚
  â”‚                                                                         â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
<!-- /DIAGRAM -->

### 1.3 æŒ‡æ ‡ä¹‹é—´çš„å…³ç³»

**å¸¦å®½-å»¶è¿Ÿä¹˜ç§¯ï¼ˆBDPï¼‰** æ˜¯ç†è§£ TCP æ€§èƒ½çš„å…³é”®ï¼š

```
BDP = Bandwidth Ã— RTT

ä¾‹å¦‚ï¼š
- 1 Gbps é“¾è·¯ï¼Œ10ms RTT
- BDP = 1,000,000,000 bits/s Ã— 0.010 s = 10,000,000 bits = 1.25 MB

è¿™æ„å‘³ç€ï¼šè¦å……åˆ†åˆ©ç”¨è¿™æ¡é“¾è·¯ï¼ŒTCP çª—å£è‡³å°‘éœ€è¦ 1.25 MB
```

å¦‚æœ TCP ç¼“å†²åŒºå°äº BDPï¼Œå¸¦å®½æ— æ³•è¢«å……åˆ†åˆ©ç”¨ï¼

---

## Step 2 - ss å‘½ä»¤æ·±å…¥ï¼šSocket é˜Ÿåˆ—ä¸ TCP å†…éƒ¨çŠ¶æ€ï¼ˆ20 åˆ†é’Ÿï¼‰

> **å‰ç½®çŸ¥è¯†**ï¼šå¦‚æœä½ è¿˜ä¸ç†Ÿæ‚‰ ss åŸºç¡€ç”¨æ³•ï¼Œè¯·å…ˆé˜…è¯» [LX06-05 å¥—æ¥å­—æ£€æŸ¥](../../lx06-networking/05-sockets/)  

### 2.1 ss -sï¼šç»Ÿè®¡æ‘˜è¦

```bash
ss -s
```

```
Total: 342
TCP:   128 (estab 89, closed 12, orphaned 0, timewait 27)

Transport    Total     IP        IPv6
RAW          0         0         0
UDP          8         6         2
TCP          116       98        18
INET         124       104       20
FRAG         0         0         0
```

**å…³é”®æŒ‡æ ‡**ï¼š

| æŒ‡æ ‡ | å«ä¹‰ | è­¦å‘Šé˜ˆå€¼ |
|------|------|----------|
| `estab` | å·²å»ºç«‹è¿æ¥æ•° | å–å†³äºä¸šåŠ¡ï¼Œä½†æŒç»­å¢é•¿éœ€å…³æ³¨ |
| `timewait` | ç­‰å¾…å…³é—­çš„è¿æ¥ | é«˜å¹¶å‘æ­£å¸¸ï¼Œä½†è¿‡å¤šï¼ˆ>10000ï¼‰å¯èƒ½è€—å°½ç«¯å£ |
| `orphaned` | å­¤å„¿è¿æ¥ï¼ˆæ— è¿›ç¨‹å…³è”ï¼‰ | > 0 éœ€è¦è°ƒæŸ¥ |

### 2.2 ss -nmpï¼šè¯¦ç»†è¿æ¥çŠ¶æ€ä¸å†…å­˜

```bash
# æŸ¥çœ‹æ‰€æœ‰ TCP è¿æ¥çš„è¯¦ç»†ä¿¡æ¯
ss -nmp

# åªçœ‹ ESTABLISHED çŠ¶æ€
ss -nmp state established
```

```
Netid  State   Recv-Q  Send-Q   Local Address:Port   Peer Address:Port   Process
tcp    ESTAB   0       0        10.0.1.52:22         203.0.113.50:54321   users:(("sshd",pid=1234,fd=4))
                        skmem:(r0,rb131072,t0,tb87040,f0,w0,o0,bl0,d0)
tcp    ESTAB   45678   0        10.0.1.52:80         198.51.100.10:45678  users:(("nginx",pid=5678,fd=8))
                        skmem:(r45678,rb262144,t0,tb87040,f2304,w0,o0,bl0,d12)
```

**Recv-Q å’Œ Send-Q è§£è¯»**ï¼š

<!-- DIAGRAM: socket-queue-explanation -->
```
Socket é˜Ÿåˆ—æ·±åº¦è§£è¯»ï¼ˆæ€§èƒ½å…³é”®æŒ‡æ ‡ï¼ï¼‰
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

å¯¹äº LISTEN çŠ¶æ€çš„ socketï¼š
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  Recv-Q = ç­‰å¾… accept() çš„è¿æ¥æ•°ï¼ˆSYN backlogï¼‰
  Send-Q = backlog æœ€å¤§å€¼

  ä¾‹å¦‚ï¼štcp  LISTEN  128  128  0.0.0.0:80  0.0.0.0:*
        Recv-Q=128 â†’ âš ï¸ backlog å·²æ»¡ï¼æ–°è¿æ¥å¯èƒ½è¢«æ‹’ç»


å¯¹äº ESTABLISHED çŠ¶æ€çš„ socketï¼š
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  Recv-Q = æ”¶åˆ°ä½†åº”ç”¨è¿˜æ²¡è¯»å–çš„æ•°æ®ï¼ˆå­—èŠ‚ï¼‰
  Send-Q = å·²å‘é€ä½†è¿˜æ²¡è¢«å¯¹ç«¯ç¡®è®¤çš„æ•°æ®ï¼ˆå­—èŠ‚ï¼‰

        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                                                               â”‚
        â”‚   ç½‘ç»œ                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                åº”ç”¨ç¨‹åº  â”‚
        â”‚   â”€â”€â”€â”€â–¶  Recv-Q é˜Ÿåˆ—  â”‚            â”‚  read() â”€â”€â”€â”€â–¶          â”‚
        â”‚          â•â•â•â•â•â•â•â•     â”‚   Socket   â”‚                         â”‚
        â”‚                       â”‚            â”‚                         â”‚
        â”‚   â—€â”€â”€â”€â”€  Send-Q é˜Ÿåˆ—  â”‚            â”‚  write() â—€â”€â”€â”€â”€         â”‚
        â”‚          â•â•â•â•â•â•â•â•     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
        â”‚                                                               â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  Recv-Q æŒç»­ > 0ï¼šåº”ç”¨è¯»å–å¤ªæ…¢ï¼ˆConsumer ç“¶é¢ˆï¼‰
  Send-Q æŒç»­ > 0ï¼šç½‘ç»œå‘é€æ…¢æˆ–å¯¹ç«¯å¤„ç†æ…¢

  æ­£å¸¸æƒ…å†µï¼šRecv-Q å’Œ Send-Q åº”è¯¥æ¥è¿‘ 0 æˆ–å¿«é€Ÿå˜åŒ–
  å¼‚å¸¸æƒ…å†µï¼šé˜Ÿåˆ—æŒç»­å¢é•¿ï¼Œè¯´æ˜å¤„ç†è·Ÿä¸ä¸Š
```
<!-- /DIAGRAM -->

### 2.3 ss -tiï¼šTCP å†…éƒ¨ä¿¡æ¯

```bash
# æŸ¥çœ‹ TCP å†…éƒ¨çŠ¶æ€ï¼ˆé‡ä¼ ã€RTTã€æ‹¥å¡çª—å£ï¼‰
ss -ti state established | head -30

# æŸ¥çœ‹ç‰¹å®šç«¯å£
ss -ti '( sport = :80 or sport = :443 )'
```

```
ESTAB  0  0  10.0.1.52:80  198.51.100.10:45678
     cubic wscale:7,7 rto:204 rtt:3.5/0.5 ato:40 mss:1460 pmtu:1500 rcvmss:1460
     advmss:1460 cwnd:10 bytes_sent:12345 bytes_acked:12345 bytes_received:5678
     segs_out:100 segs_in:80 data_segs_out:50 data_segs_in:40 send 33.4Mbps
     lastsnd:1000 lastrcv:500 lastack:500 pacing_rate 66.8Mbps delivery_rate 25Mbps
     delivered:51 app_limited busy:2000ms retrans:0/2 rcv_space:29200 rcv_ssthresh:29200
```

**å…³é”®å­—æ®µè§£è¯»**ï¼š

| å­—æ®µ | å«ä¹‰ | æ­£å¸¸å€¼ |
|------|------|--------|
| `rtt:3.5/0.5` | å¾€è¿”æ—¶é—´/æ ‡å‡†å·®ï¼ˆmsï¼‰ | LAN < 1ms, WAN < 100ms |
| `cwnd:10` | æ‹¥å¡çª—å£ï¼ˆMSS å€æ•°ï¼‰ | åº”è¯¥ç¨³å®šæˆ–å¢é•¿ |
| `retrans:0/2` | å½“å‰é‡ä¼ /æ€»é‡ä¼ æ¬¡æ•° | 0 æœ€å¥½ï¼Œå¶å°” 1-2 å¯æ¥å— |
| `send 33.4Mbps` | å½“å‰å‘é€é€Ÿç‡ | ä¸å¸¦å®½å¯¹æ¯” |
| `delivery_rate` | å®é™…æ•°æ®ä¼ è¾“é€Ÿç‡ | è¶Šæ¥è¿‘å¸¦å®½è¶Šå¥½ |

### 2.4 å®æˆ˜ï¼šæ‰¾å‡ºæœ‰é—®é¢˜çš„è¿æ¥

```bash
# æ‰¾å‡º Recv-Q ä¸ä¸º 0 çš„è¿æ¥ï¼ˆåº”ç”¨è¯»å–æ…¢ï¼‰
ss -ntp | awk '$2 > 0 {print "Recv-Qå †ç§¯:", $0}'

# æ‰¾å‡º Send-Q ä¸ä¸º 0 çš„è¿æ¥ï¼ˆå‘é€ç¼“æ…¢ï¼‰
ss -ntp | awk '$3 > 0 {print "Send-Qå †ç§¯:", $0}'

# æ‰¾å‡ºæœ‰é‡ä¼ çš„è¿æ¥
ss -ti state established | grep -E "retrans:[1-9]" -B1

# æ‰¾å‡º RTT å¼‚å¸¸é«˜çš„è¿æ¥ï¼ˆ> 100msï¼‰
ss -ti state established | grep -E "rtt:[0-9]{3,}" -B1
```

---

## Step 3 - iperf3ï¼šç½‘ç»œåŸºçº¿æµ‹è¯•ï¼ˆ15 åˆ†é’Ÿï¼‰

### 3.1 ä¸ºä»€ä¹ˆéœ€è¦ iperf3ï¼Ÿ

**æ²¡æœ‰åŸºçº¿ï¼Œä½ æ— æ³•åˆ¤æ–­ç½‘ç»œæ˜¯å¦æ­£å¸¸ã€‚**

```
åœºæ™¯ï¼šç”¨æˆ·æŠ¥å‘Š"ç½‘ç»œæ…¢"
  - æ²¡æœ‰åŸºçº¿ï¼š"æ…¢åˆ°ä»€ä¹ˆç¨‹åº¦ï¼Ÿ"
  - æœ‰åŸºçº¿ï¼š"æ­£å¸¸ 800 Mbpsï¼Œç°åœ¨åªæœ‰ 50 Mbpsï¼Œç¡®è®¤å¼‚å¸¸ï¼"
```

iperf3 æ˜¯ç½‘ç»œæ€§èƒ½åŸºçº¿æµ‹è¯•çš„æ ‡å‡†å·¥å…·ã€‚

### 3.2 åŸºæœ¬ç”¨æ³•

```bash
# å®‰è£… iperf3
# Ubuntu/Debian
sudo apt install iperf3

# RHEL/AlmaLinux
sudo dnf install iperf3
```

**æœåŠ¡ç«¯**ï¼ˆè¢«æµ‹è¯•çš„ç›®æ ‡æœºå™¨ï¼‰ï¼š

```bash
# å¯åŠ¨ iperf3 æœåŠ¡ï¼ˆé»˜è®¤ç«¯å£ 5201ï¼‰
iperf3 -s

# åå°è¿è¡Œ
iperf3 -s -D
```

**å®¢æˆ·ç«¯**ï¼ˆå‘èµ·æµ‹è¯•çš„æœºå™¨ï¼‰ï¼š

```bash
# åŸºæœ¬ TCP æµ‹è¯•ï¼ˆ10 ç§’ï¼‰
iperf3 -c <server_ip>

# æŒ‡å®šæµ‹è¯•æ—¶é•¿
iperf3 -c <server_ip> -t 30

# åŒå‘æµ‹è¯•
iperf3 -c <server_ip> --bidir

# UDP æµ‹è¯•ï¼ˆæŒ‡å®šç›®æ ‡å¸¦å®½ï¼‰
iperf3 -c <server_ip> -u -b 100M
```

### 3.3 è¾“å‡ºè§£è¯»

```
[ ID] Interval           Transfer     Bitrate         Retr  Cwnd
[  5]   0.00-1.00   sec   112 MBytes   940 Mbits/sec    0   3.12 MBytes
[  5]   1.00-2.00   sec   112 MBytes   938 Mbits/sec    0   3.12 MBytes
[  5]   2.00-3.00   sec   111 MBytes   932 Mbits/sec    2   2.25 MBytes
...
- - - - - - - - - - - - - - - - - - - - - - - - -
[ ID] Interval           Transfer     Bitrate         Retr
[  5]   0.00-10.00  sec  1.09 GBytes   936 Mbits/sec    2    sender
[  5]   0.00-10.01  sec  1.09 GBytes   935 Mbits/sec         receiver
```

| åˆ— | å«ä¹‰ |
|----|------|
| `Transfer` | ä¼ è¾“æ•°æ®é‡ |
| `Bitrate` | ååé‡ï¼ˆå¸¦å®½åˆ©ç”¨ç‡ï¼‰ |
| `Retr` | é‡ä¼ æ¬¡æ•°ï¼ˆè¶Šå°‘è¶Šå¥½ï¼‰ |
| `Cwnd` | æ‹¥å¡çª—å£å¤§å° |

### 3.4 UDP æµ‹è¯•

```bash
# UDP æµ‹è¯•ï¼ˆå¸¦å®½è®¾ä¸º 100 Mbpsï¼‰
iperf3 -c <server_ip> -u -b 100M -t 10
```

```
[ ID] Interval           Transfer     Bitrate         Jitter    Lost/Total Datagrams
[  5]   0.00-10.00  sec   119 MBytes  99.8 Mbits/sec  0.045 ms  12/85714 (0.014%)  sender
[  5]   0.00-10.01  sec   119 MBytes  99.8 Mbits/sec  0.045 ms  12/85702 (0.014%)  receiver
```

UDP æµ‹è¯•é¢å¤–æ˜¾ç¤ºï¼š
- `Jitter`ï¼šæŠ–åŠ¨ï¼ˆè¶Šå°è¶Šå¥½ï¼Œå®æ—¶åº”ç”¨è¦æ±‚ < 30msï¼‰
- `Lost/Total`ï¼šä¸¢åŒ…ç‡ï¼ˆ0% æœ€å¥½ï¼Œ< 1% å¯æ¥å—ï¼‰

### 3.5 å¹¶è¡Œæµæµ‹è¯•

```bash
# ä½¿ç”¨ 4 ä¸ªå¹¶è¡Œæµï¼ˆæµ‹è¯•èšåˆå¸¦å®½ï¼‰
iperf3 -c <server_ip> -P 4
```

**ä¸ºä»€ä¹ˆéœ€è¦å¹¶è¡Œæµï¼Ÿ**

å•ä¸ª TCP æµå¯èƒ½æ— æ³•å……åˆ†åˆ©ç”¨é«˜å¸¦å®½-é«˜å»¶è¿Ÿé“¾è·¯ï¼ˆBDP é™åˆ¶ï¼‰ã€‚

---

## Step 4 - æ¥å£ç»Ÿè®¡ï¼šip -s link ä¸ ethtool -Sï¼ˆ10 åˆ†é’Ÿï¼‰

### 4.1 ip -s linkï¼šåŒ…çº§åˆ«ç»Ÿè®¡

```bash
ip -s link show eth0
```

```
2: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UP
    link/ether 0a:1b:2c:3d:4e:5f brd ff:ff:ff:ff:ff:ff
    RX:  bytes  packets  errors  dropped  overrun  mcast
    12345678901  9876543  0       12       0        54321
    TX:  bytes  packets  errors  dropped  carrier  collsns
    98765432109  8765432  0       5        0        0
```

**USE Method è§†è§’**ï¼š

| å­—æ®µ | USE ç»´åº¦ | è¯´æ˜ |
|------|----------|------|
| `bytes/packets` | Utilization | æµé‡ç»Ÿè®¡ |
| `dropped` | Saturation | å› é˜Ÿåˆ—æ»¡è€Œä¸¢å¼ƒ |
| `errors` | Errors | ç¡¬ä»¶/é©±åŠ¨é”™è¯¯ |
| `overrun` | Saturation | æ¥æ”¶ç¼“å†²åŒºæº¢å‡º |

### 4.2 ethtool -Sï¼šé©±åŠ¨çº§è¯¦ç»†ç»Ÿè®¡

```bash
# æŸ¥çœ‹ç½‘å¡é©±åŠ¨çº§ç»Ÿè®¡ï¼ˆæ›´è¯¦ç»†ï¼‰
sudo ethtool -S eth0 | head -50
```

```
NIC statistics:
     rx_packets: 9876543
     tx_packets: 8765432
     rx_bytes: 12345678901
     tx_bytes: 98765432109
     rx_errors: 0
     tx_errors: 0
     rx_dropped: 0
     tx_dropped: 0
     ...
     rx_queue_0_packets: 3456789
     rx_queue_0_bytes: 4567890123
     rx_queue_0_drops: 12
     ...
```

**å…³é”®æŒ‡æ ‡**ï¼š

| æŒ‡æ ‡ | å«ä¹‰ | è­¦å‘Šæ¡ä»¶ |
|------|------|----------|
| `rx_dropped` | æ¥æ”¶ä¸¢åŒ… | > 0 éœ€è°ƒæŸ¥ |
| `tx_dropped` | å‘é€ä¸¢åŒ… | > 0 éœ€è°ƒæŸ¥ |
| `rx_queue_N_drops` | ç‰¹å®šé˜Ÿåˆ—ä¸¢åŒ… | > 0 å¯èƒ½éœ€è¦è°ƒæ•´é˜Ÿåˆ— |
| `rx_crc_errors` | CRC æ ¡éªŒé”™è¯¯ | > 0 å¯èƒ½æ˜¯çº¿ç¼†é—®é¢˜ |
| `rx_fifo_errors` | FIFO æº¢å‡º | > 0 è¡¨ç¤ºå¤„ç†ä¸è¿‡æ¥ |

### 4.3 æŸ¥çœ‹ç½‘å¡èƒ½åŠ›

```bash
# æŸ¥çœ‹ç½‘å¡é€Ÿåº¦å’Œåå•†çŠ¶æ€
sudo ethtool eth0 | grep -E "Speed|Duplex|Link"
```

```
	Speed: 10000Mb/s
	Duplex: Full
	Link detected: yes
```

```bash
# æŸ¥çœ‹ç½‘å¡æ”¯æŒçš„åŠŸèƒ½
sudo ethtool -k eth0 | grep -E "tcp-segmentation|generic-receive"
```

---

## Step 5 - TCP ç¼“å†²åŒºè°ƒä¼˜å…¥é—¨ï¼ˆ15 åˆ†é’Ÿï¼‰

### 5.1 ä¸ºä»€ä¹ˆéœ€è¦è°ƒä¼˜ TCP ç¼“å†²åŒºï¼Ÿ

å›é¡¾ BDPï¼ˆå¸¦å®½-å»¶è¿Ÿä¹˜ç§¯ï¼‰ï¼š

```
é«˜å¸¦å®½ + é«˜å»¶è¿Ÿ = éœ€è¦æ›´å¤§çš„ TCP ç¼“å†²åŒº

ä¾‹å¦‚ï¼šè·¨å›½é“¾è·¯
- å¸¦å®½ï¼š1 Gbps
- RTTï¼š200 msï¼ˆæ—¥æœ¬åˆ°ç¾å›½ï¼‰
- BDP = 1 Gbps Ã— 0.2 s = 200 Mbits = 25 MB

å¦‚æœ TCP ç¼“å†²åŒºåªæœ‰ 256 KBï¼ˆé»˜è®¤ï¼‰ï¼Œåªèƒ½åˆ©ç”¨çº¦ 1% çš„å¸¦å®½ï¼
```

### 5.2 ç›¸å…³å†…æ ¸å‚æ•°

```bash
# æŸ¥çœ‹å½“å‰ TCP ç¼“å†²åŒºè®¾ç½®
sysctl net.ipv4.tcp_rmem
sysctl net.ipv4.tcp_wmem
sysctl net.core.rmem_max
sysctl net.core.wmem_max
```

```
net.ipv4.tcp_rmem = 4096    131072    6291456
                   æœ€å°     é»˜è®¤      æœ€å¤§
net.ipv4.tcp_wmem = 4096    16384     4194304
net.core.rmem_max = 212992
net.core.wmem_max = 212992
```

**å‚æ•°è§£é‡Š**ï¼š

| å‚æ•° | å«ä¹‰ |
|------|------|
| `tcp_rmem` | TCP æ¥æ”¶ç¼“å†²åŒºï¼ˆmin, default, maxï¼‰ |
| `tcp_wmem` | TCP å‘é€ç¼“å†²åŒºï¼ˆmin, default, maxï¼‰ |
| `rmem_max` | å•ä¸ª socket æ¥æ”¶ç¼“å†²åŒºçš„ç¡¬ä¸Šé™ |
| `wmem_max` | å•ä¸ª socket å‘é€ç¼“å†²åŒºçš„ç¡¬ä¸Šé™ |

### 5.3 å®‰å…¨çš„è°ƒä¼˜ç¤ºä¾‹

> **è­¦å‘Š**ï¼šæ°¸è¿œå…ˆæµ‹é‡åŸºçº¿ï¼Œå†åšè°ƒä¼˜ï¼  

```bash
# æŸ¥çœ‹å½“å‰åŸºçº¿
iperf3 -c <server_ip> -t 30

# ä¸´æ—¶è°ƒæ•´ï¼ˆé‡å¯åæ¢å¤ï¼‰
sudo sysctl -w net.core.rmem_max=16777216
sudo sysctl -w net.core.wmem_max=16777216
sudo sysctl -w net.ipv4.tcp_rmem="4096 131072 16777216"
sudo sysctl -w net.ipv4.tcp_wmem="4096 65536 16777216"

# å†æ¬¡æµ‹è¯•
iperf3 -c <server_ip> -t 30

# å¯¹æ¯”ç»“æœ
```

### 5.4 æŒä¹…åŒ–é…ç½®

å¦‚æœæµ‹è¯•è¯æ˜æœ‰æ•ˆï¼ŒæŒä¹…åŒ–åˆ°é…ç½®æ–‡ä»¶ï¼š

```bash
# /etc/sysctl.d/99-network-tuning.conf
# é«˜ååé‡ç½‘ç»œè°ƒä¼˜
# è­¦å‘Šï¼šä»…åœ¨æµ‹é‡è¯æ˜æœ‰æ•ˆåå¯ç”¨

# å¢å¤§ socket ç¼“å†²åŒºä¸Šé™
net.core.rmem_max = 16777216
net.core.wmem_max = 16777216

# å¢å¤§ TCP ç¼“å†²åŒº
net.ipv4.tcp_rmem = 4096 131072 16777216
net.ipv4.tcp_wmem = 4096 65536 16777216

# å¢å¤§è¿æ¥é˜Ÿåˆ—
net.core.somaxconn = 65535
net.ipv4.tcp_max_syn_backlog = 65535
```

```bash
# åº”ç”¨é…ç½®
sudo sysctl -p /etc/sysctl.d/99-network-tuning.conf
```

---

## Step 6 - tcpdump æ€§èƒ½åˆ†æï¼šå»¶è¿Ÿä¸é‡ä¼ ï¼ˆ15 åˆ†é’Ÿï¼‰

> **å‰ç½®çŸ¥è¯†**ï¼šå¦‚æœä½ è¿˜ä¸ç†Ÿæ‚‰ tcpdump åŸºç¡€ç”¨æ³•ï¼Œè¯·å…ˆé˜…è¯» [LX06-08 tcpdump ä¸æŠ“åŒ…åˆ†æ](../../lx06-networking/08-tcpdump/)  

### 6.1 ä»æ€§èƒ½è§’åº¦ä½¿ç”¨ tcpdump

tcpdump ä¸ä»…ç”¨äºæ’æŸ¥è¿æ¥é—®é¢˜ï¼Œä¹Ÿæ˜¯æ€§èƒ½åˆ†æçš„åˆ©å™¨ã€‚

```bash
# æŠ“å–ç‰¹å®šç«¯å£çš„ TCP æµé‡ï¼Œæ˜¾ç¤ºæ—¶é—´æˆ³
sudo tcpdump -i eth0 -nn -tttt port 80 -c 100

# åªæŠ“é‡ä¼ åŒ…ï¼ˆæ€§èƒ½é—®é¢˜å…³é”®ä¿¡å·ï¼‰
sudo tcpdump -i eth0 -nn 'tcp[tcpflags] & (tcp-syn|tcp-fin) == 0 and tcp[4:4] = tcp[8:4]'
```

### 6.2 è¯†åˆ«é‡ä¼ 

```bash
# ä½¿ç”¨æ›´ç°ä»£çš„æ–¹å¼ï¼ˆéœ€è¦è¾ƒæ–°å†…æ ¸ï¼‰
sudo tcpdump -i eth0 -nn -v 'tcp' | grep -i retransmit

# æˆ–è€…æŠ“åŒ…ååˆ†æ
sudo tcpdump -i eth0 -nn -w /tmp/capture.pcap port 80
tcpdump -nn -r /tmp/capture.pcap | grep -E '\[R\]|\[S\].*\[S\]'
```

### 6.3 è®¡ç®—å»¶è¿Ÿ

æŠ“å– SYN/SYN-ACK æ¥è®¡ç®— RTTï¼š

```bash
# æŠ“å–æ¡æ‰‹åŒ…
sudo tcpdump -i eth0 -nn -tttt 'tcp[tcpflags] & (tcp-syn) != 0' -c 20
```

```
2026-01-10 14:30:01.123456 IP 10.0.1.52.45678 > 203.0.113.50.80: Flags [S], ...
2026-01-10 14:30:01.126789 IP 203.0.113.50.80 > 10.0.1.52.45678: Flags [S.], ...
```

**RTT = 126789 - 123456 = 3.333 ms**

### 6.4 æ€§èƒ½ç›¸å…³çš„ tcpdump è¿‡æ»¤å™¨

```bash
# åªçœ‹æ•°æ®åŒ…ï¼ˆæ’é™¤ ACK-onlyï¼‰
sudo tcpdump -i eth0 -nn 'tcp[tcpflags] & tcp-push != 0'

# çœ‹çª—å£ä¸º 0 çš„åŒ…ï¼ˆæµæ§ä¿¡å·ï¼‰
sudo tcpdump -i eth0 -nn 'tcp[14:2] = 0'

# çœ‹ RST åŒ…ï¼ˆè¿æ¥å¼‚å¸¸é‡ç½®ï¼‰
sudo tcpdump -i eth0 -nn 'tcp[tcpflags] & tcp-rst != 0'
```

---

## Step 7 - ç½‘ç»œæ€§èƒ½ Cheatsheetï¼ˆ5 åˆ†é’Ÿï¼‰

```bash
# ==============================================================================
# ç½‘ç»œæ€§èƒ½åˆ†æ Cheatsheet
# ==============================================================================

# --- Socket ç»Ÿè®¡ ---
ss -s                              # æ€»ä½“ç»Ÿè®¡
ss -nmp state established          # è¯¦ç»†è¿æ¥ä¿¡æ¯ï¼ˆå«å†…å­˜ï¼‰
ss -ti state established           # TCP å†…éƒ¨çŠ¶æ€ï¼ˆRTT, é‡ä¼ ï¼‰

# --- æ‰¾é—®é¢˜è¿æ¥ ---
ss -ntp | awk '$2 > 0'             # Recv-Q å †ç§¯ï¼ˆåº”ç”¨è¯»æ…¢ï¼‰
ss -ntp | awk '$3 > 0'             # Send-Q å †ç§¯ï¼ˆå‘é€æ…¢ï¼‰
ss -ti | grep -E "retrans:[1-9]"   # æœ‰é‡ä¼ çš„è¿æ¥

# --- æ¥å£ç»Ÿè®¡ ---
ip -s link show eth0               # åŒ…çº§åˆ«ç»Ÿè®¡
sudo ethtool -S eth0               # é©±åŠ¨çº§è¯¦ç»†ç»Ÿè®¡
sudo ethtool eth0                  # é€Ÿåº¦/åŒå·¥çŠ¶æ€

# --- iperf3 åŸºçº¿æµ‹è¯• ---
iperf3 -s                          # æœåŠ¡ç«¯
iperf3 -c <ip> -t 30               # TCP æµ‹è¯• 30 ç§’
iperf3 -c <ip> --bidir             # åŒå‘æµ‹è¯•
iperf3 -c <ip> -u -b 100M          # UDP æµ‹è¯•
iperf3 -c <ip> -P 4                # 4 å¹¶è¡Œæµ

# --- TCP ç¼“å†²åŒº ---
sysctl net.ipv4.tcp_rmem           # TCP æ¥æ”¶ç¼“å†²
sysctl net.ipv4.tcp_wmem           # TCP å‘é€ç¼“å†²
sysctl net.core.rmem_max           # æ¥æ”¶ç¼“å†²ç¡¬ä¸Šé™
sysctl net.core.wmem_max           # å‘é€ç¼“å†²ç¡¬ä¸Šé™

# --- tcpdump æ€§èƒ½åˆ†æ ---
sudo tcpdump -i eth0 -nn -tttt port 80 -c 100    # å¸¦æ—¶é—´æˆ³
sudo tcpdump -i eth0 -nn 'tcp[tcpflags] & tcp-rst != 0'  # åªçœ‹ RST

# --- å¿«é€Ÿæ£€æŸ¥ ---
ping -c 10 <ip>                    # åŸºæœ¬å»¶è¿Ÿå’Œä¸¢åŒ…
mtr <ip>                           # è·¯å¾„å»¶è¿Ÿåˆ†æ
traceroute <ip>                    # è·¯ç”±è·Ÿè¸ª
```

---

## Step 8 - Lab åœºæ™¯ï¼šç½‘ç»œé»‘æ´ï¼ˆTCP Buffer Issueï¼‰ï¼ˆ15 åˆ†é’Ÿï¼‰

> **åœºæ™¯æ¥æº**ï¼šGemini ç”Ÿæˆçš„ Japan IT åœºæ™¯ - "The Network Black Hole"  
>
> **èƒŒæ™¯**ï¼šECã‚µã‚¤ãƒˆï¼ˆç”µå•†ç½‘ç«™ï¼‰åœ¨ ã‚¿ã‚¤ãƒ ã‚»ãƒ¼ãƒ«ï¼ˆé™æ—¶ç‰¹å–ï¼‰æœŸé—´ï¼Œååé‡åœ¨ 10 Gbps ç½‘å¡ä¸Šåªèƒ½è¾¾åˆ° 1 Gbpsã€‚ç½‘ç»œå›¢é˜Ÿè¯´"ç½‘ç»œæ­£å¸¸"ï¼Œä½†åº”ç”¨å›¢é˜Ÿè¯´"æ•°æ®ä¼ è¾“æ…¢"ã€‚  

### 8.1 é—®é¢˜ç°è±¡

```bash
# æ£€æŸ¥ç½‘å¡é€Ÿåº¦
sudo ethtool eth0 | grep Speed
# Speed: 10000Mb/s

# ä½† iperf3 æµ‹è¯•åªæœ‰ ~1 Gbps
iperf3 -c backend-server -t 10
# [ ID] Interval           Transfer     Bitrate
# [  5]   0.00-10.00  sec  1.12 GBytes   962 Mbits/sec    sender
```

### 8.2 è¯Šæ–­æ­¥éª¤

**Step Aï¼šæ£€æŸ¥ socket é˜Ÿåˆ—**

```bash
ss -nmp state established | grep backend-server
```

```
tcp  ESTAB  262144  0  10.0.1.52:45678  10.0.1.100:8080
                      skmem:(r262144,rb262144,t0,tb87040,f0,w0,o0,bl0,d0)
```

**å‘ç°**ï¼š`Recv-Q = 262144`ï¼Œæ¥æ”¶ç¼“å†²åŒºæ»¡äº†ï¼

**Step Bï¼šæ£€æŸ¥ TCP å†…éƒ¨çŠ¶æ€**

```bash
ss -ti state established | grep -A1 backend-server
```

```
ESTAB  262144  0  10.0.1.52:45678  10.0.1.100:8080
     cubic wscale:7,7 rto:204 rtt:0.5/0.1 cwnd:10 rcv_space:262144
     rcv_ssthresh:262144 ...
```

**å‘ç°**ï¼š`rcv_space = 262144`ï¼ˆ256 KBï¼‰ï¼Œå¯¹äºé«˜å¸¦å®½é“¾è·¯å¤ªå°äº†ï¼

**Step Cï¼šæ£€æŸ¥ç³»ç»Ÿé™åˆ¶**

```bash
sysctl net.core.rmem_max
# net.core.rmem_max = 262144
```

**æ ¹å› **ï¼š`rmem_max` é™åˆ¶äº† TCP æ¥æ”¶ç¼“å†²åŒºï¼Œæ— æ³•æ‰©å±•åˆ° BDP éœ€è¦çš„å¤§å°ã€‚

### 8.3 ä¿®å¤

```bash
# ä¸´æ—¶è°ƒæ•´
sudo sysctl -w net.core.rmem_max=16777216
sudo sysctl -w net.ipv4.tcp_rmem="4096 131072 16777216"

# éªŒè¯
iperf3 -c backend-server -t 10
# [ ID] Interval           Transfer     Bitrate
# [  5]   0.00-10.00  sec  9.31 GBytes   8.00 Gbits/sec    sender
```

ååé‡ä» 1 Gbps æå‡åˆ° 8 Gbpsï¼

---

## Step 9 - Lab åœºæ™¯ï¼šéšå½¢å»¶è¿Ÿï¼ˆDNS Timeoutï¼‰ï¼ˆ15 åˆ†é’Ÿï¼‰

> **åœºæ™¯æ¥æº**ï¼šGemini ç”Ÿæˆçš„ Japan IT åœºæ™¯ - "The Invisible Delay"  
>
> **èƒŒæ™¯**ï¼šAWS RDS è¿æ¥éšæœºå‡ºç°æ°å¥½ 5 ç§’çš„å»¶è¿Ÿã€‚ä¸æ˜¯æ¯æ¬¡éƒ½æ…¢ï¼Œä½†å‘ç”Ÿæ—¶å¿…å®šæ˜¯ 5 ç§’ã€‚  

### 9.1 é—®é¢˜ç°è±¡

```bash
# å¤§å¤šæ•°æ—¶å€™æ­£å¸¸
time mysql -h db.example.com -e "SELECT 1"
# real    0m0.050s

# å¶å°”æ…¢ 5 ç§’
time mysql -h db.example.com -e "SELECT 1"
# real    0m5.051s  â† æ°å¥½å¤š 5 ç§’ï¼
```

### 9.2 è¯Šæ–­æ­¥éª¤

**Step Aï¼šæŠ“åŒ…åˆ†æ DNS**

```bash
sudo tcpdump -i eth0 -nn port 53
```

```
14:30:01.001 IP 10.0.1.52.45678 > 10.0.0.2.53: 12345+ AAAA? db.example.com. (32)
14:30:06.001 IP 10.0.1.52.45679 > 10.0.0.2.53: 12346+ A? db.example.com. (32)
14:30:06.010 IP 10.0.0.2.53 > 10.0.1.52.45679: 12346 1/0/0 A 10.0.2.100 (48)
```

**å‘ç°**ï¼š
1. å…ˆå‘é€ AAAA æŸ¥è¯¢ï¼ˆIPv6ï¼‰
2. ç­‰å¾… 5 ç§’è¶…æ—¶
3. å†å‘é€ A æŸ¥è¯¢ï¼ˆIPv4ï¼‰
4. IPv4 ç«‹å³è¿”å›

### 9.3 æ ¹å› 

ç³»ç»Ÿé…ç½®äº† IPv6ï¼Œä½† DNS æœåŠ¡å™¨æˆ–ç½‘ç»œä¸æ”¯æŒ IPv6ã€‚

```bash
# æ£€æŸ¥
cat /etc/resolv.conf
# nameserver 10.0.0.2
# options timeout:5  â† 5 ç§’è¶…æ—¶ï¼

# æ£€æŸ¥ IPv6
ip -6 addr show
# inet6 fe80::1/64 scope link
```

### 9.4 ä¿®å¤é€‰é¡¹

**é€‰é¡¹ 1ï¼šç¦ç”¨ IPv6 DNS æŸ¥è¯¢**

```bash
# /etc/gai.conf
precedence ::ffff:0:0/96  100
```

**é€‰é¡¹ 2ï¼šåœ¨ resolv.conf ä¸­æ·»åŠ é€‰é¡¹**

```bash
# /etc/resolv.conf
options single-request-reopen
```

**é€‰é¡¹ 3ï¼šç¡®ä¿ DNS æœåŠ¡å™¨æ”¯æŒ IPv6**

```bash
# æ£€æŸ¥ DNS æœåŠ¡å™¨æ˜¯å¦å“åº” AAAA
dig AAAA db.example.com @10.0.0.2
```

---

## Mini-Projectï¼šç½‘ç»œåŸºçº¿æŠ¥å‘Šï¼ˆ20 åˆ†é’Ÿï¼‰

### é¡¹ç›®ç›®æ ‡

ä½¿ç”¨ iperf3 å»ºç«‹å†…ç½‘ç½‘ç»œåŸºçº¿ï¼Œè®°å½•å¸¦å®½ã€å»¶è¿Ÿã€ä¸¢åŒ…ç‡ã€‚

### 10.1 åˆ›å»ºåŸºçº¿è„šæœ¬

```bash
#!/bin/bash
# network-baseline.sh - ç½‘ç»œæ€§èƒ½åŸºçº¿é‡‡é›†è„šæœ¬
# ç”¨äº ã‚¿ã‚¤ãƒ ã‚»ãƒ¼ãƒ« å‰çš„ç½‘ç»œæ€§èƒ½ç¡®è®¤

# é…ç½®
IPERF_SERVER="${1:-}"
DURATION=30
OUTPUT_DIR="network_baseline_$(date +%Y%m%d_%H%M%S)"

if [ -z "$IPERF_SERVER" ]; then
    echo "ç”¨æ³•: $0 <iperf3æœåŠ¡å™¨IP>"
    exit 1
fi

mkdir -p "$OUTPUT_DIR"
cd "$OUTPUT_DIR"

echo "============================================"
echo "  ç½‘ç»œæ€§èƒ½åŸºçº¿é‡‡é›†"
echo "  ç›®æ ‡æœåŠ¡å™¨: $IPERF_SERVER"
echo "  é‡‡é›†æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
echo "============================================"

# ç³»ç»Ÿä¿¡æ¯
{
    echo "=== ç³»ç»Ÿä¿¡æ¯ ==="
    uname -a
    echo ""
    echo "=== ç½‘ç»œæ¥å£ ==="
    ip -br link
    echo ""
    echo "=== é»˜è®¤ç½‘å…³ ==="
    ip route | grep default
} > system_info.txt

# Step 1: åŸºç¡€è¿é€šæ€§
echo ""
echo "[Step 1] åŸºç¡€è¿é€šæ€§æµ‹è¯•..."
{
    echo "=== Ping æµ‹è¯• ==="
    ping -c 20 "$IPERF_SERVER"
} > ping_test.txt 2>&1

# æå– ping ç»Ÿè®¡
PING_STATS=$(tail -2 ping_test.txt | head -1)
echo "  Ping ç»Ÿè®¡: $PING_STATS"

# Step 2: TCP ååé‡
echo ""
echo "[Step 2] TCP ååé‡æµ‹è¯• (${DURATION}ç§’)..."
iperf3 -c "$IPERF_SERVER" -t "$DURATION" -J > tcp_test.json 2>&1

if [ $? -eq 0 ]; then
    TCP_BW=$(jq -r '.end.sum_sent.bits_per_second' tcp_test.json 2>/dev/null | awk '{printf "%.2f Mbps", $1/1000000}')
    TCP_RETRANS=$(jq -r '.end.sum_sent.retransmits' tcp_test.json 2>/dev/null)
    echo "  TCP ååé‡: $TCP_BW"
    echo "  é‡ä¼ æ¬¡æ•°: $TCP_RETRANS"
else
    echo "  TCP æµ‹è¯•å¤±è´¥ï¼Œè¯·ç¡®è®¤ iperf3 æœåŠ¡ç«¯è¿è¡Œä¸­"
fi

# Step 3: UDP æµ‹è¯•ï¼ˆä¸¢åŒ…ç‡å’ŒæŠ–åŠ¨ï¼‰
echo ""
echo "[Step 3] UDP æµ‹è¯• (100 Mbps, ${DURATION}ç§’)..."
iperf3 -c "$IPERF_SERVER" -u -b 100M -t "$DURATION" -J > udp_test.json 2>&1

if [ $? -eq 0 ]; then
    UDP_LOSS=$(jq -r '.end.sum.lost_percent' udp_test.json 2>/dev/null)
    UDP_JITTER=$(jq -r '.end.sum.jitter_ms' udp_test.json 2>/dev/null)
    echo "  UDP ä¸¢åŒ…ç‡: ${UDP_LOSS}%"
    echo "  UDP æŠ–åŠ¨: ${UDP_JITTER} ms"
else
    echo "  UDP æµ‹è¯•å¤±è´¥"
fi

# Step 4: åŒå‘æµ‹è¯•
echo ""
echo "[Step 4] åŒå‘ååé‡æµ‹è¯•..."
iperf3 -c "$IPERF_SERVER" --bidir -t 10 -J > bidir_test.json 2>&1

# Step 5: Socket çŠ¶æ€å¿«ç…§
echo ""
echo "[Step 5] Socket çŠ¶æ€å¿«ç…§..."
{
    echo "=== ss -s ==="
    ss -s
    echo ""
    echo "=== å½“å‰è¿æ¥ç»Ÿè®¡ ==="
    ss -tan | awk '{print $1}' | sort | uniq -c | sort -rn
} > socket_stats.txt

# Step 6: æ¥å£ç»Ÿè®¡
echo ""
echo "[Step 6] æ¥å£ç»Ÿè®¡..."
{
    echo "=== ip -s link ==="
    ip -s link show
} > interface_stats.txt

# ç”Ÿæˆæ‘˜è¦æŠ¥å‘Š
echo ""
echo "[ç”Ÿæˆæ‘˜è¦æŠ¥å‘Š...]"

{
    echo "============================================"
    echo "  ç½‘ç»œæ€§èƒ½åŸºçº¿æŠ¥å‘Š"
    echo "  é‡‡é›†æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
    echo "  ç›®æ ‡æœåŠ¡å™¨: $IPERF_SERVER"
    echo "============================================"
    echo ""
    echo "## è¿é€šæ€§"
    echo "$PING_STATS"
    echo ""
    echo "## TCP ååé‡"
    if [ -f tcp_test.json ]; then
        echo "- å¸¦å®½: $TCP_BW"
        echo "- é‡ä¼ : $TCP_RETRANS"
    fi
    echo ""
    echo "## UDP æ€§èƒ½"
    if [ -f udp_test.json ]; then
        echo "- ä¸¢åŒ…ç‡: ${UDP_LOSS}%"
        echo "- æŠ–åŠ¨: ${UDP_JITTER} ms"
    fi
    echo ""
    echo "## å»ºè®®"
    if [ -n "$TCP_RETRANS" ] && [ "$TCP_RETRANS" -gt 0 ]; then
        echo "- âš ï¸  æ£€æµ‹åˆ°é‡ä¼ ï¼Œå»ºè®®æ£€æŸ¥ç½‘ç»œè´¨é‡"
    fi
    if [ -n "$UDP_LOSS" ] && [ "$(echo "$UDP_LOSS > 1" | bc -l 2>/dev/null)" = "1" ]; then
        echo "- âš ï¸  UDP ä¸¢åŒ…ç‡è¶…è¿‡ 1%ï¼Œå¯èƒ½å½±å“å®æ—¶åº”ç”¨"
    fi
    echo ""
    echo "============================================"
} > summary.txt

cat summary.txt

echo ""
echo "============================================"
echo "  åŸºçº¿é‡‡é›†å®Œæˆï¼"
echo "  è¾“å‡ºç›®å½•: $(pwd)"
echo "============================================"
```

### 10.2 è¿è¡ŒåŸºçº¿é‡‡é›†

```bash
chmod +x network-baseline.sh

# åœ¨ç›®æ ‡æœåŠ¡å™¨ä¸Šå¯åŠ¨ iperf3
ssh target-server 'iperf3 -s -D'

# è¿è¡ŒåŸºçº¿é‡‡é›†
./network-baseline.sh <target-server-ip>
```

### 10.3 æ£€æŸ¥æ¸…å•

å®Œæˆ Mini-Project åï¼Œç¡®è®¤ä½ æœ‰ï¼š

- [ ] è®°å½•äº† ping å»¶è¿Ÿå’Œä¸¢åŒ…ç‡
- [ ] è®°å½•äº† TCP ååé‡å’Œé‡ä¼ æ¬¡æ•°
- [ ] è®°å½•äº† UDP ä¸¢åŒ…ç‡å’ŒæŠ–åŠ¨
- [ ] è®°å½•äº† socket çŠ¶æ€åˆ†å¸ƒ
- [ ] è®°å½•äº†æ¥å£ç»Ÿè®¡
- [ ] ä¿å­˜äº†åŸºçº¿æŠ¥å‘Šä¾›æœªæ¥å¯¹æ¯”

---

## åæ¨¡å¼ï¼šå¸¸è§é”™è¯¯

### é”™è¯¯ 1ï¼šå¿½ç•¥ Socket é˜Ÿåˆ—æ·±åº¦

```bash
# é”™è¯¯ï¼šåªçœ‹è¿æ¥æ•°
ss -tan | wc -l
# "10000 ä¸ªè¿æ¥ï¼Œçœ‹èµ·æ¥æ­£å¸¸..."

# æ­£ç¡®ï¼šæ£€æŸ¥é˜Ÿåˆ—æ·±åº¦
ss -ntp | awk '$2 > 0 || $3 > 0'
# Recv-Q=65535 çš„è¿æ¥è¯´æ˜åº”ç”¨å¤„ç†ä¸è¿‡æ¥ï¼
```

### é”™è¯¯ 2ï¼šè°ƒä¼˜å‰ä¸æµ‹é‡

```bash
# é”™è¯¯ï¼šç›´æ¥æŠ„ç½‘ä¸Šé…ç½®
echo 'net.core.rmem_max = 16777216' >> /etc/sysctl.conf
sysctl -p
# "ç½‘ä¸Šè¯´è¿™æ ·å¥½..."

# æ­£ç¡®ï¼šå…ˆæµ‹é‡åŸºçº¿
iperf3 -c server -t 30 > before.txt
sysctl -w net.core.rmem_max=16777216
iperf3 -c server -t 30 > after.txt
diff before.txt after.txt
# è¯æ˜æœ‰æ•ˆå†æŒä¹…åŒ–
```

### é”™è¯¯ 3ï¼šåªæµ‹å•å‘

```bash
# é”™è¯¯ï¼šåªæµ‹å®¢æˆ·ç«¯åˆ°æœåŠ¡å™¨
iperf3 -c server

# æ­£ç¡®ï¼šåŒå‘æµ‹è¯•
iperf3 -c server --bidir
# ä¸Šè¡Œå’Œä¸‹è¡Œå¯èƒ½æœ‰ä¸åŒç“¶é¢ˆ
```

---

## èŒåœºå°è´´å£«ï¼ˆJapan IT Contextï¼‰

### ã‚¿ã‚¤ãƒ ã‚»ãƒ¼ãƒ«å¯¾å¿œï¼ˆé™æ—¶ç‰¹å–å¯¹åº”ï¼‰

åœ¨æ—¥æœ¬ EC ç½‘ç«™è¿è¥ä¸­ï¼Œã‚¿ã‚¤ãƒ ã‚»ãƒ¼ãƒ«ï¼ˆé™æ—¶ç‰¹å–ï¼‰æ˜¯ç½‘ç»œå‹åŠ›æœ€å¤§çš„æ—¶åˆ»ã€‚

| æ—¥è¯­æœ¯è¯­ | è¯»éŸ³ | å«ä¹‰ | æœ¬è¯¾å¯¹åº” |
|----------|------|------|----------|
| ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆ | ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆ | Throughput | iperf3 æµ‹è¯• |
| ãƒ¬ã‚¤ãƒ†ãƒ³ã‚· | ãƒ¬ã‚¤ãƒ†ãƒ³ã‚· | Latency | ss -ti, ping |
| ãƒ‘ã‚±ãƒƒãƒˆãƒ­ã‚¹ | ãƒ‘ã‚±ãƒƒãƒˆãƒ­ã‚¹ | Packet Loss | UDP æµ‹è¯• |
| ãƒãƒƒãƒ•ã‚¡ | ãƒãƒƒãƒ•ã‚¡ | Buffer | TCP ç¼“å†²åŒº |
| ãƒœãƒˆãƒ«ãƒãƒƒã‚¯ | ãƒœãƒˆãƒ«ãƒãƒƒã‚¯ | Bottleneck | é˜Ÿåˆ—æ·±åº¦åˆ†æ |
| è¼»è¼³ | ãµããã† | Congestion | cwnd, é‡ä¼  |

### æ€§èƒ½å•é¡Œå ±å‘Šæ›¸

```markdown
## æ€§èƒ½å•é¡Œå ±å‘Šæ›¸

### ç™ºç”Ÿæ—¥æ™‚
2026-01-10 14:00 JSTï¼ˆã‚¿ã‚¤ãƒ ã‚»ãƒ¼ãƒ«é–‹å§‹æ™‚ï¼‰

### ç—‡çŠ¶
- ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆãŒ 1 Gbps ã§é ­æ‰“ã¡
- 10 Gbps NIC ã«å¯¾ã—ã¦ 10% ã—ã‹åˆ©ç”¨ã§ãã¦ã„ãªã„

### èª¿æŸ»çµæœï¼ˆUSE Methodï¼‰

#### Network
- Utilization: 1 Gbps / 10 Gbps = 10%
- Saturation: Recv-Q = 262144ï¼ˆãƒãƒƒãƒ•ã‚¡æº€æ¯ï¼‰âš ï¸
- Errors: é‡ä¼ ãªã—

### æ ¹æœ¬åŸå› 
net.core.rmem_max = 262144 KB ãŒãƒœãƒˆãƒ«ãƒãƒƒã‚¯ã€‚
BDP = 10 Gbps Ã— 0.5 ms = 625 KB å¿…è¦ã ãŒã€256 KB ã§åˆ¶é™ã•ã‚Œã¦ã„ãŸã€‚

### å¯¾ç­–
1. net.core.rmem_max ã‚’ 16 MB ã«æ‹¡å¼µ
2. net.ipv4.tcp_rmem ã® max ã‚’ 16 MB ã«è¨­å®š
3. è¨­å®šå¤‰æ›´å¾Œã€ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆãŒ 8 Gbps ã«æ”¹å–„

### ã‚¨ãƒ“ãƒ‡ãƒ³ã‚¹
- iperf3 before: 962 Mbps
- iperf3 after: 8.00 Gbps
- æ·»ä»˜: tcp_test_before.json, tcp_test_after.json
```

---

## é¢è¯•å‡†å¤‡ï¼ˆInterview Prepï¼‰

### Q1: ss ã® Recv-Q ãŒå¢—åŠ ã—ã¦ã„ã‚‹æ„å‘³ã¯ï¼Ÿ

**å›ç­”è¦ç‚¹**ï¼š

```
Recv-Q ã¯ã‚½ã‚±ãƒƒãƒˆã®å—ä¿¡ã‚­ãƒ¥ãƒ¼æ·±åº¦ã§ã™ã€‚

ESTABLISHED çŠ¶æ…‹ã®å ´åˆï¼š
- Recv-Q > 0 ã¯ã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å—ä¿¡ã—ãŸãŒã€
  ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒã¾ã  read() ã—ã¦ã„ãªã„ãƒã‚¤ãƒˆæ•°
- æŒç¶šçš„ã«é«˜ã„å ´åˆã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å‡¦ç†ãŒè¿½ã„ã¤ã„ã¦ã„ãªã„
  ï¼ˆConsumer ãŒãƒœãƒˆãƒ«ãƒãƒƒã‚¯ï¼‰

LISTEN çŠ¶æ…‹ã®å ´åˆï¼š
- accept() ã‚’å¾…ã£ã¦ã„ã‚‹æ¥ç¶šæ•°
- backlog ä¸Šé™ã«é”ã™ã‚‹ã¨æ–°è¦æ¥ç¶šãŒæ‹’å¦ã•ã‚Œã‚‹

å¯¾å‡¦ï¼šã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å‡¦ç†èƒ½åŠ›å‘ä¸Šã€ã¾ãŸã¯è² è·åˆ†æ•£
```

### Q2: iperf3 ã§ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ã‚’å–ã‚‹ç†ç”±ã¯ï¼Ÿ

**å›ç­”è¦ç‚¹**ï¼š

```
ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ãŒãªã„ã¨ã€ã€Œé…ã„ã€ã®åŸºæº–ãŒã‚ã‹ã‚Šã¾ã›ã‚“ã€‚

ç†ç”±ï¼š
1. æ­£å¸¸æ™‚ã®æ€§èƒ½ã‚’æ•°å€¤ã§è¨˜éŒ²
2. å•é¡Œç™ºç”Ÿæ™‚ã«æ¯”è¼ƒå¯èƒ½
3. å¤‰æ›´ã®åŠ¹æœã‚’è¨¼æ˜ã§ãã‚‹ï¼ˆã‚¨ãƒ“ãƒ‡ãƒ³ã‚¹ï¼‰
4. SLA é”æˆã®ç¢ºèª

æ¡å–ã‚¿ã‚¤ãƒŸãƒ³ã‚°ï¼š
- æœ¬ç•ªãƒªãƒªãƒ¼ã‚¹å‰
- å¤§è¦æ¨¡ã‚¤ãƒ™ãƒ³ãƒˆå‰ï¼ˆã‚¿ã‚¤ãƒ ã‚»ãƒ¼ãƒ«ãªã©ï¼‰
- å®šæœŸçš„ï¼ˆæœˆæ¬¡ãªã©ï¼‰
- ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å¤‰æ›´å¾Œ
```

### Q3: TCP ãƒãƒƒãƒ•ã‚¡ã‚’å¤§ããã™ã‚Œã°å¿…ãšé€Ÿããªã‚Šã¾ã™ã‹ï¼Ÿ

**å›ç­”è¦ç‚¹**ï¼š

```
ã„ã„ãˆã€å¿…ãšã—ã‚‚ãã†ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

åŠ¹æœãŒã‚ã‚‹å ´åˆï¼š
- é«˜å¸¯åŸŸ Ã— é«˜é…å»¶ã®ãƒªãƒ³ã‚¯ï¼ˆBDP ãŒå¤§ãã„ï¼‰
- ç¾åœ¨ã®ãƒãƒƒãƒ•ã‚¡ãŒ BDP ã‚ˆã‚Šå°ã•ã„å ´åˆ

åŠ¹æœãŒãªã„/æ‚ªåŒ–ã™ã‚‹å ´åˆï¼š
- ãƒœãƒˆãƒ«ãƒãƒƒã‚¯ãŒå¸¯åŸŸã‚„CPUã®å ´åˆ
- ãƒ¡ãƒ¢ãƒªãƒªã‚½ãƒ¼ã‚¹ãŒé™ã‚‰ã‚Œã¦ã„ã‚‹å ´åˆ
- å¤šæ•°ã®ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ãŒã‚ã‚‹å ´åˆï¼ˆå„æ¥ç¶šã«ãƒãƒƒãƒ•ã‚¡å‰²å½“ï¼‰

åŸå‰‡ï¼šå¿…ãšè¨ˆæ¸¬ã—ã¦ã‹ã‚‰å¤‰æ›´ã€‚ç›²ç›®çš„ãªãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ã¯ç¦ç‰©ã€‚
```

---

## æ£€æŸ¥æ¸…å•

å®Œæˆæœ¬è¯¾åï¼Œä½ åº”è¯¥èƒ½å¤Ÿï¼š

- [ ] è§£é‡Šç½‘ç»œæ€§èƒ½å››å¤§æŒ‡æ ‡ï¼ˆBandwidth, Latency, Packet Loss, Jitterï¼‰
- [ ] ä½¿ç”¨ ss -nmp åˆ†æ socket é˜Ÿåˆ—æ·±åº¦
- [ ] ä½¿ç”¨ ss -ti æŸ¥çœ‹ TCP å†…éƒ¨çŠ¶æ€ï¼ˆRTT, cwnd, retransï¼‰
- [ ] ä½¿ç”¨ iperf3 å»ºç«‹ TCP/UDP ç½‘ç»œåŸºçº¿
- [ ] ä½¿ç”¨ ip -s link å’Œ ethtool -S æ£€æŸ¥æ¥å£ç»Ÿè®¡
- [ ] è§£é‡Š TCP ç¼“å†²åŒºå‚æ•°ï¼ˆtcp_rmem, tcp_wmem, rmem_maxï¼‰
- [ ] è¯†åˆ«"TCP Buffer Issue"å¯¼è‡´çš„ååé‡ç“¶é¢ˆ
- [ ] è¯†åˆ«"DNS Timeout"å¯¼è‡´çš„éšå½¢å»¶è¿Ÿ
- [ ] é¿å…"è°ƒä¼˜å‰ä¸æµ‹é‡"çš„åæ¨¡å¼

---

## æœ¬è¯¾å°ç»“

| æ¦‚å¿µ | è¦ç‚¹ |
|------|------|
| å››å¤§æŒ‡æ ‡ | Bandwidth, Latency, Packet Loss, Jitter |
| USE for Network | U=å¸¦å®½åˆ©ç”¨ç‡, S=é˜Ÿåˆ—æ·±åº¦, E=ä¸¢åŒ…/é”™è¯¯ |
| ss æ ¸å¿ƒç”¨æ³• | `-s` ç»Ÿè®¡, `-nmp` è¯¦æƒ…, `-ti` TCP å†…éƒ¨ |
| Recv-Q/Send-Q | æŒç»­ > 0 è¡¨ç¤ºå¤„ç†è·Ÿä¸ä¸Š |
| iperf3 | åŸºçº¿æµ‹è¯•æ ‡å‡†å·¥å…· |
| BDP | å¸¦å®½ Ã— å»¶è¿Ÿï¼Œå†³å®šæ‰€éœ€ç¼“å†²åŒºå¤§å° |
| TCP ç¼“å†²åŒº | rmem_max, wmem_max æ˜¯ç¡¬ä¸Šé™ |
| æ ¸å¿ƒåŸåˆ™ | å…ˆæµ‹é‡åŸºçº¿ï¼Œå†åšè°ƒä¼˜ |

---

## å»¶ä¼¸é˜…è¯»

- [Brendan Gregg - Network Performance](https://www.brendangregg.com/blog/2017-09-18/linux-perf-analysis-60s.html)
- [Linux TCP Tuning](https://www.kernel.org/doc/html/latest/networking/ip-sysctl.html)
- [iperf3 Documentation](https://iperf.fr/iperf-doc.php)
- ä¸Šä¸€è¯¾ï¼š[04 - I/O åˆ†æ](../04-io-analysis/)
- ä¸‹ä¸€è¯¾ï¼š[06 - strace ç³»ç»Ÿè°ƒç”¨è¿½è¸ª](../06-strace/)
- ç›¸å…³è¯¾ç¨‹ï¼š[LX06-05 å¥—æ¥å­—æ£€æŸ¥](../../lx06-networking/05-sockets/)ã€[LX06-08 tcpdump](../../lx06-networking/08-tcpdump/)

---

## ç³»åˆ—å¯¼èˆª

[<-- 04 - I/O åˆ†æ](../04-io-analysis/) | [ç³»åˆ—é¦–é¡µ](../) | [06 - strace -->](../06-strace/)
