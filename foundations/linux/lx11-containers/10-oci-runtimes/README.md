# 10 - OCI è¿è¡Œæ—¶ï¼šruncã€containerd ä¸ CRI-O

> **ç›®æ ‡**ï¼šç†è§£å®¹å™¨è¿è¡Œæ—¶å±‚çº§æ¶æ„ï¼ŒåŒºåˆ†ä½çº§è¿è¡Œæ—¶ï¼ˆruncï¼‰å’Œé«˜çº§è¿è¡Œæ—¶ï¼ˆcontainerd/CRI-Oï¼‰ï¼ŒæŒæ¡ OCI è§„èŒƒæ ¸å¿ƒæ¦‚å¿µ  
> **å‰ç½®**ï¼š[Lesson 09 - å®¹å™¨å®‰å…¨](../09-container-security/)ï¼›ç†è§£ Namespaceã€cgroupsã€OverlayFS åŸºç¡€  
> **æ—¶é—´**ï¼šâš¡ 40 åˆ†é’Ÿï¼ˆé€Ÿè¯»ï¼‰/ ğŸ”¬ 150 åˆ†é’Ÿï¼ˆå®Œæ•´å®æ“ï¼‰  
> **åœºæ™¯**ï¼šã‚³ãƒ³ãƒ†ãƒŠãƒ©ãƒ³ã‚¿ã‚¤ãƒ é¸å®šï¼ˆå®¹å™¨è¿è¡Œæ—¶é€‰å‹ï¼‰ï¼ŒKubernetes è¿ç»´  

---

## å°†å­¦åˆ°çš„å†…å®¹

1. ç†è§£ OCI è§„èŒƒï¼ˆRuntime Specã€Image Specã€Distribution Specï¼‰
2. åŒºåˆ†ä½çº§è¿è¡Œæ—¶ï¼ˆruncã€crunï¼‰å’Œé«˜çº§è¿è¡Œæ—¶ï¼ˆcontainerdã€CRI-Oï¼‰
3. ä½¿ç”¨ runc ç›´æ¥è¿è¡Œ OCI å®¹å™¨
4. ä½¿ç”¨ containerd çš„ ctr å‘½ä»¤ç®¡ç†å®¹å™¨
5. ç†è§£ Kubernetes CRI æ¥å£åŠè¿è¡Œæ—¶é€‰å‹

---

## å…ˆè·‘èµ·æ¥ï¼š5 åˆ†é’Ÿç”¨ runc ç›´æ¥è¿è¡Œå®¹å™¨

> **ä¸è®²åŸç†ï¼Œå…ˆåŠ¨æ‰‹ï¼** ä½ é©¬ä¸Šå°±èƒ½ç»•è¿‡ Dockerï¼Œç›´æ¥ä½¿ç”¨ OCI ä½çº§è¿è¡Œæ—¶è¿è¡Œå®¹å™¨ã€‚  

### å‡†å¤‡ OCI Bundle

```bash
# 1. åˆ›å»º OCI bundle ç›®å½•ç»“æ„
mkdir -p ~/oci-demo/rootfs

# 2. ä½¿ç”¨ Docker å¯¼å‡º rootfsï¼ˆæœ€ç®€å•çš„æ–¹å¼ï¼‰
docker export $(docker create alpine:latest) | tar -C ~/oci-demo/rootfs -xf -

# 3. è¿›å…¥ bundle ç›®å½•
cd ~/oci-demo

# 4. ç”Ÿæˆé»˜è®¤ config.jsonï¼ˆOCI è¿è¡Œæ—¶è§„èŒƒï¼‰
runc spec
```

### æŸ¥çœ‹ç”Ÿæˆçš„ config.json

```bash
# æŸ¥çœ‹å…³é”®é…ç½®
cat config.json | head -50
```

è¾“å‡ºï¼ˆéƒ¨åˆ†ï¼‰ï¼š

```json
{
    "ociVersion": "1.0.2-dev",
    "process": {
        "terminal": true,
        "user": { "uid": 0, "gid": 0 },
        "args": ["sh"],
        "env": [
            "PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin",
            "TERM=xterm"
        ],
        "cwd": "/"
    },
    "root": {
        "path": "rootfs",
        "readonly": true
    },
    "hostname": "runc",
    "mounts": [
        { "destination": "/proc", "type": "proc", "source": "proc" },
        { "destination": "/dev", "type": "tmpfs", "source": "tmpfs" }
    ],
    "linux": {
        "namespaces": [
            { "type": "pid" },
            { "type": "network" },
            { "type": "ipc" },
            { "type": "uts" },
            { "type": "mount" }
        ]
    }
}
```

### è¿è¡Œå®¹å™¨

```bash
# è¿è¡Œ OCI å®¹å™¨ï¼ˆéœ€è¦ root æƒé™ï¼‰
sudo runc run mycontainer
```

è¾“å‡ºï¼š

```
/ # hostname
runc
/ # ps aux
PID   USER     TIME  COMMAND
    1 root      0:00 sh
    2 root      0:00 ps aux
/ # exit
```

**æˆåŠŸï¼** ä½ åˆšåˆšç»•è¿‡äº† Dockerï¼Œç›´æ¥ä½¿ç”¨ OCI ä½çº§è¿è¡Œæ—¶è¿è¡Œäº†å®¹å™¨ã€‚

### å¿«é€Ÿæ¸…ç†

```bash
# åˆ é™¤å®¹å™¨ï¼ˆå¦‚æœæ²¡æœ‰è‡ªåŠ¨åˆ é™¤ï¼‰
sudo runc delete mycontainer 2>/dev/null

# æ¸…ç† bundle ç›®å½•
rm -rf ~/oci-demo
```

---

**ä½ åˆšåˆšåšäº†ä»€ä¹ˆï¼Ÿ**

```
OCI å®¹å™¨è¿è¡Œæµç¨‹ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Docker/Kubernetes/Podman  (ç”¨æˆ·ç•Œé¢å±‚)                              â”‚
â”‚  "docker run alpine"                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  containerd / CRI-O  (é«˜çº§è¿è¡Œæ—¶)                                    â”‚
â”‚  - é•œåƒæ‹‰å–/å­˜å‚¨                                                     â”‚
â”‚  - å®¹å™¨ç”Ÿå‘½å‘¨æœŸç®¡ç†                                                   â”‚
â”‚  - å¿«ç…§ç®¡ç† (snapshotter)                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚ OCI Runtime Spec
                                     â”‚ (config.json)
                                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  runc / crun / youki  (ä½çº§è¿è¡Œæ—¶)  â† ä½ åˆšåˆšç›´æ¥ä½¿ç”¨äº†è¿™å±‚ï¼          â”‚
â”‚  - è¯»å– config.json                                                 â”‚
â”‚  - åˆ›å»º Namespace                                                    â”‚
â”‚  - é…ç½® cgroups                                                      â”‚
â”‚  - æ‰§è¡Œå®¹å™¨è¿›ç¨‹                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Linux Kernel                                                        â”‚
â”‚  namespaces / cgroups / overlayfs / seccomp                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

ä½ è·³è¿‡äº† Docker å’Œ containerdï¼Œç›´æ¥æ“ä½œäº†æœ€åº•å±‚çš„ runcï¼

---

## å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ

### OCI è§„èŒƒçš„ä¸‰å¤§ç»„æˆ

**OCIï¼ˆOpen Container Initiativeï¼‰** æ˜¯å®¹å™¨æ ‡å‡†åŒ–ç»„ç»‡ï¼Œå®šä¹‰äº†ä¸‰ä¸ªæ ¸å¿ƒè§„èŒƒï¼š

| è§„èŒƒ | ä½œç”¨ | å…³é”®æ–‡ä»¶/æ ¼å¼ |
|------|------|---------------|
| **Runtime Spec** | å®šä¹‰å¦‚ä½•è¿è¡Œå®¹å™¨ | `config.json` |
| **Image Spec** | å®šä¹‰é•œåƒæ ¼å¼ | manifest, layers, config |
| **Distribution Spec** | å®šä¹‰é•œåƒåˆ†å‘ | Registry API |

**ä¸ºä»€ä¹ˆéœ€è¦ OCI è§„èŒƒï¼Ÿ**

```
æ²¡æœ‰ OCI ä¹‹å‰ï¼ˆDocker ä¸“æœ‰ï¼‰ï¼š

   Docker Client  â”€â”€â”€â”€â”€â”€â–¶  Docker Daemon  â”€â”€â”€â”€â”€â”€â–¶  Docker ä¸“æœ‰æ ¼å¼
        â”‚                       â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              ç´§å¯†è€¦åˆ

æœ‰äº† OCI ä¹‹åï¼ˆæ ‡å‡†åŒ–ï¼‰ï¼š

   Docker          â”€â”
   Podman          â”€â”¼â”€â”€â–¶  OCI æ ‡å‡†æ¥å£  â”€â”€â–¶  runc/crun
   Kubernetes      â”€â”¤                           â”‚
   ä»»ä½•å·¥å…·...     â”€â”˜                           â–¼
                                          Linux Kernel
              æ¾è€¦åˆï¼Œå¯äº’æ¢
```

### è¿è¡Œæ—¶å±‚çº§æ¶æ„

**å®¹å™¨è¿è¡Œæ—¶åˆ†ä¸ºä¸¤ä¸ªå±‚çº§**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    é«˜çº§è¿è¡Œæ—¶ (High-level Runtime)                   â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚      containerd           â”‚  â”‚         CRI-O                 â”‚   â”‚
â”‚  â”‚  - Docker é»˜è®¤ä½¿ç”¨         â”‚  â”‚  - Kubernetes ä¸“ç”¨            â”‚   â”‚
â”‚  â”‚  - é•œåƒç®¡ç†               â”‚  â”‚  - æœ€å°åŒ–è®¾è®¡                  â”‚   â”‚
â”‚  â”‚  - å®¹å™¨ç”Ÿå‘½å‘¨æœŸ           â”‚  â”‚  - OpenShift é»˜è®¤             â”‚   â”‚
â”‚  â”‚  - ctr å‘½ä»¤è¡Œå·¥å…·         â”‚  â”‚                               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â”‚  èŒè´£ï¼šé•œåƒæ‹‰å–ã€å­˜å‚¨ã€å¿«ç…§ã€å®¹å™¨ç”Ÿå‘½å‘¨æœŸç®¡ç†                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                                     â”‚ OCI Runtime Spec
                                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ä½çº§è¿è¡Œæ—¶ (Low-level Runtime)                    â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚     runc      â”‚  â”‚     crun      â”‚  â”‚        youki            â”‚  â”‚
â”‚  â”‚  Go è¯­è¨€      â”‚  â”‚  C è¯­è¨€       â”‚  â”‚     Rust è¯­è¨€           â”‚  â”‚
â”‚  â”‚  OCI å‚è€ƒå®ç° â”‚  â”‚  æ›´å¿«æ›´å°     â”‚  â”‚    å®‰å…¨æ€§é«˜             â”‚  â”‚
â”‚  â”‚  æœ€æˆç†Ÿ       â”‚  â”‚  é«˜å¯†åº¦åœºæ™¯   â”‚  â”‚    å®éªŒæ€§               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                     â”‚
â”‚  èŒè´£ï¼šåˆ›å»º namespaceã€é…ç½® cgroupsã€æ‰§è¡Œå®¹å™¨è¿›ç¨‹                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ ¸å¿ƒæ¦‚å¿µï¼šOCI Runtime Spec

### config.json å…³é”®å­—æ®µ

OCI Runtime Spec å®šä¹‰äº† `config.json` çš„ç»“æ„ï¼Œè¿™æ˜¯ä½çº§è¿è¡Œæ—¶çš„ã€Œæ‰§è¡ŒåˆåŒã€ï¼š

```json
{
    "ociVersion": "1.0.2-dev",

    "process": {
        "terminal": true,
        "user": { "uid": 0, "gid": 0 },
        "args": ["nginx", "-g", "daemon off;"],
        "env": ["PATH=/usr/bin"],
        "cwd": "/"
    },

    "root": {
        "path": "rootfs",
        "readonly": false
    },

    "hostname": "web-server",

    "mounts": [
        {
            "destination": "/proc",
            "type": "proc",
            "source": "proc"
        }
    ],

    "linux": {
        "namespaces": [
            { "type": "pid" },
            { "type": "network" },
            { "type": "mount" },
            { "type": "ipc" },
            { "type": "uts" }
        ],
        "resources": {
            "memory": { "limit": 536870912 },
            "cpu": { "quota": 50000, "period": 100000 }
        }
    }
}
```

**å­—æ®µè¯´æ˜**ï¼š

| å­—æ®µ | ä½œç”¨ | å¯¹åº”å†…æ ¸æœºåˆ¶ |
|------|------|-------------|
| `process` | å®¹å™¨å†…æ‰§è¡Œçš„è¿›ç¨‹ | exec() |
| `root` | å®¹å™¨æ ¹æ–‡ä»¶ç³»ç»Ÿ | pivot_root() |
| `hostname` | å®¹å™¨ä¸»æœºå | UTS namespace |
| `namespaces` | å¯ç”¨çš„éš”ç¦»ç±»å‹ | clone() flags |
| `resources` | èµ„æºé™åˆ¶ | cgroups |

### OCI Runtime Spec v1.3 æ›´æ–°ï¼ˆ2025-2026ï¼‰

```
OCI Runtime Spec æœ€è¿‘æ›´æ–°:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  v1.2.0 (2024)                                                      â”‚
â”‚  - idmap mounts æ”¯æŒ                                                 â”‚
â”‚  - æ”¹è¿›çš„ seccomp é…ç½®                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  v1.3.0 (Nov 2025)                                                  â”‚
â”‚  - å¢å¼ºçš„ cgroup v2 æ”¯æŒ                                             â”‚
â”‚  - æ›´å¥½çš„ rootless å®¹å™¨æ”¯æŒ                                          â”‚
â”‚  - æ–°çš„ lifecycle hooks                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ ¸å¿ƒæ¦‚å¿µï¼šrunc vs crun

### å¯¹æ¯”

| ç‰¹æ€§ | runc | crun |
|------|------|------|
| **è¯­è¨€** | Go | C |
| **äºŒè¿›åˆ¶å¤§å°** | ~10MB | ~300KB |
| **å¯åŠ¨é€Ÿåº¦** | åŸºå‡† | å¿« 50% ä»¥ä¸Š |
| **å†…å­˜å ç”¨** | è¾ƒé«˜ï¼ˆGo runtimeï¼‰ | æä½ |
| **æˆç†Ÿåº¦** | ç”Ÿäº§çº§ï¼ŒOCI å‚è€ƒå®ç° | ç”Ÿäº§çº§ï¼ŒRed Hat æ”¯æŒ |
| **é€‚ç”¨åœºæ™¯** | é€šç”¨ | é«˜å¯†åº¦ã€FaaSã€è¾¹ç¼˜è®¡ç®— |

### ä¸ºä»€ä¹ˆ crun æ›´å¿«ï¼Ÿ

```
runc (Go):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  runc äºŒè¿›åˆ¶                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Go Runtime (GC, goroutines, etc.) â”‚  â”‚  â† å¯åŠ¨å¼€é”€
â”‚  â”‚  ~8MB é¢å¤–å¼€é”€                      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  OCI å®ç°é€»è¾‘                       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

crun (C):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  crun äºŒè¿›åˆ¶                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  OCI å®ç°é€»è¾‘                       â”‚  â”‚  â† ç›´æ¥æ‰§è¡Œ
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

é«˜å¯†åº¦åœºæ™¯ï¼ˆ1000+ å®¹å™¨ï¼‰ï¼š
- runc: æ¯æ¬¡å¯åŠ¨éƒ½åŠ è½½ Go runtime
- crun: ç›´æ¥æ‰§è¡Œï¼Œå¯åŠ¨æ—¶é—´å’Œå†…å­˜å ç”¨æ˜¾è‘—é™ä½
```

### crun åœ¨ç”Ÿäº§ç¯å¢ƒçš„é‡‡ç”¨ï¼ˆ2025-2026ï¼‰

- **Podman**: æ”¯æŒ crun ä½œä¸ºé»˜è®¤è¿è¡Œæ—¶
- **OpenShift**: é«˜å¯†åº¦å·¥ä½œè´Ÿè½½æ¨è crun
- **Serverless/FaaS**: å†·å¯åŠ¨ä¼˜åŒ–é¦–é€‰

---

## æ ¸å¿ƒæ¦‚å¿µï¼šcontainerd

### containerd æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         containerd                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Content Store  â”‚  â”‚   Snapshotter   â”‚  â”‚  Container Service â”‚  â”‚
â”‚  â”‚  (é•œåƒå±‚å­˜å‚¨)   â”‚  â”‚  (å¿«ç…§ç®¡ç†)     â”‚  â”‚  (å®¹å™¨ç”Ÿå‘½å‘¨æœŸ)     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                    gRPC API                                  â”‚    â”‚
â”‚  â”‚  - é•œåƒæ‹‰å–/æ¨é€    - å®¹å™¨åˆ›å»º/å¯åŠ¨/åœæ­¢    - å¿«ç…§æ“ä½œ       â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                    Shim API                                  â”‚    â”‚
â”‚  â”‚                containerd-shim-runc-v2                       â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                              â”‚                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   runc / crun    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ctr å‘½ä»¤åŸºç¡€æ“ä½œ

`ctr` æ˜¯ containerd çš„åŸç”Ÿå‘½ä»¤è¡Œå·¥å…·ï¼š

```bash
# æ‹‰å–é•œåƒ
sudo ctr images pull docker.io/library/alpine:latest

# åˆ—å‡ºé•œåƒ
sudo ctr images list

# è¿è¡Œå®¹å™¨ï¼ˆäº¤äº’å¼ï¼‰
sudo ctr run -t --rm docker.io/library/alpine:latest test1 sh

# åˆ›å»ºå®¹å™¨ï¼ˆä¸å¯åŠ¨ï¼‰
sudo ctr containers create docker.io/library/alpine:latest mycontainer

# å¯åŠ¨å®¹å™¨
sudo ctr tasks start -d mycontainer

# åˆ—å‡ºè¿è¡Œä¸­çš„ä»»åŠ¡
sudo ctr tasks list

# è¿›å…¥å®¹å™¨
sudo ctr tasks exec -t --exec-id shell1 mycontainer sh

# åœæ­¢å¹¶åˆ é™¤
sudo ctr tasks kill mycontainer
sudo ctr containers delete mycontainer
```

### containerd 2.0+ æ›´æ–°ï¼ˆ2025-2026ï¼‰

```
containerd 2.0 å…³é”®å˜åŒ–ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç§»é™¤ Kubernetes CRI v1alpha2 æ”¯æŒ                                   â”‚
â”‚  - åªä¿ç•™ CRI v1 API                                                 â”‚
â”‚  - æ—§ç‰ˆ Kubernetes (< 1.24) éœ€è¦å‡çº§                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ”¹è¿›çš„ Sandbox API                                                  â”‚
â”‚  - æ›´å¥½çš„ Pod ç”Ÿå‘½å‘¨æœŸç®¡ç†                                           â”‚
â”‚  - æ”¯æŒæ–°çš„æ²™ç®±éš”ç¦»æŠ€æœ¯                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Transfer Service                                                    â”‚
â”‚  - ç»Ÿä¸€çš„é•œåƒä¼ è¾“ API                                                â”‚
â”‚  - æ›´å¥½çš„é•œåƒæµå¼ä¼ è¾“æ”¯æŒ                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ ¸å¿ƒæ¦‚å¿µï¼šCRI-O

### CRI-O å®šä½

**CRI-O** æ˜¯ä¸“ä¸º Kubernetes è®¾è®¡çš„å®¹å™¨è¿è¡Œæ—¶ï¼š

```
CRI-O è®¾è®¡å“²å­¦ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        "Just enough for Kubernetes"                  â”‚
â”‚                                                                     â”‚
â”‚  åªå®ç° Kubernetes éœ€è¦çš„åŠŸèƒ½ï¼Œä¸å¤šä¸å°‘                               â”‚
â”‚                                                                     â”‚
â”‚  å¯¹æ¯” containerd:                                                    â”‚
â”‚  - containerd: é€šç”¨å®¹å™¨è¿è¡Œæ—¶ï¼ŒåŠŸèƒ½ä¸°å¯Œ                              â”‚
â”‚  - CRI-O: Kubernetes ä¸“ç”¨ï¼ŒåŠŸèƒ½ç²¾ç®€                                  â”‚
â”‚                                                                     â”‚
â”‚  ä¼˜åŠ¿ï¼š                                                              â”‚
â”‚  - æ›´å°çš„æ”»å‡»é¢                                                      â”‚
â”‚  - æ›´ç®€å•çš„å‡çº§ï¼ˆä¸ Kubernetes ç‰ˆæœ¬å¯¹é½ï¼‰                             â”‚
â”‚  - æ›´å°‘çš„ä¾èµ–                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### CRI-O vs containerd

| ç‰¹æ€§ | containerd | CRI-O |
|------|------------|-------|
| **å®šä½** | é€šç”¨å®¹å™¨è¿è¡Œæ—¶ | Kubernetes ä¸“ç”¨ |
| **åŠŸèƒ½** | å®Œæ•´ï¼ˆæ”¯æŒç‹¬ç«‹ä½¿ç”¨ï¼‰ | æœ€å°åŒ–ï¼ˆåªæ”¯æŒ K8sï¼‰ |
| **é»˜è®¤ä½¿ç”¨è€…** | Docker, é€šç”¨ K8s | OpenShift, RHEL |
| **é•œåƒæ„å»º** | æ”¯æŒ | ä¸æ”¯æŒï¼ˆéœ€ buildahï¼‰ |
| **ç‰ˆæœ¬ç­–ç•¥** | ç‹¬ç«‹ç‰ˆæœ¬ | ä¸ K8s ç‰ˆæœ¬å¯¹é½ |

---

## æ ¸å¿ƒæ¦‚å¿µï¼šKubernetes CRI

### CRI æ¶æ„

**CRIï¼ˆContainer Runtime Interfaceï¼‰** æ˜¯ Kubernetes ä¸å®¹å™¨è¿è¡Œæ—¶çš„æ ‡å‡†æ¥å£ï¼š

```
Kubernetes CRI æ¶æ„ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Kubernetes Node                              â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                        kubelet                               â”‚    â”‚
â”‚  â”‚                                                              â”‚    â”‚
â”‚  â”‚  Pod ç®¡ç†ï¼š                                                  â”‚    â”‚
â”‚  â”‚  - æ¥æ”¶ Pod Spec                                             â”‚    â”‚
â”‚  â”‚  - è°ƒç”¨ CRI åˆ›å»º Sandbox                                     â”‚    â”‚
â”‚  â”‚  - è°ƒç”¨ CRI åˆ›å»º Container                                   â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                              â”‚                                      â”‚
â”‚                              â”‚ CRI (gRPC)                           â”‚
â”‚                              â”‚                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                containerd / CRI-O                             â”‚  â”‚
â”‚  â”‚                                                               â”‚  â”‚
â”‚  â”‚  RuntimeService:              ImageService:                   â”‚  â”‚
â”‚  â”‚  - RunPodSandbox             - PullImage                      â”‚  â”‚
â”‚  â”‚  - CreateContainer           - ListImages                     â”‚  â”‚
â”‚  â”‚  - StartContainer            - RemoveImage                    â”‚  â”‚
â”‚  â”‚  - StopContainer                                              â”‚  â”‚
â”‚  â”‚  - RemoveContainer                                            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                              â”‚                                      â”‚
â”‚                              â”‚ OCI Runtime Spec                     â”‚
â”‚                              â”‚                                      â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚
â”‚                    â”‚   runc / crun     â”‚                            â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### RuntimeClass

**RuntimeClass** å…è®¸åœ¨åŒä¸€é›†ç¾¤ä¸­ä½¿ç”¨ä¸åŒçš„è¿è¡Œæ—¶ï¼š

```yaml
# RuntimeClass å®šä¹‰
apiVersion: node.k8s.io/v1
kind: RuntimeClass
metadata:
  name: high-performance
handler: crun  # ä½¿ç”¨ crun ä½œä¸ºè¿è¡Œæ—¶
---
# Pod ä½¿ç”¨ç‰¹å®š RuntimeClass
apiVersion: v1
kind: Pod
metadata:
  name: fast-pod
spec:
  runtimeClassName: high-performance  # æŒ‡å®šè¿è¡Œæ—¶
  containers:
  - name: app
    image: myapp:latest
```

**å…¸å‹ä½¿ç”¨åœºæ™¯**ï¼š

| RuntimeClass | è¿è¡Œæ—¶ | ç”¨é€” |
|--------------|--------|------|
| `default` | runc | é€šç”¨å·¥ä½œè´Ÿè½½ |
| `high-performance` | crun | é«˜å¯†åº¦ã€ä½å»¶è¿Ÿ |
| `gvisor` | runsc | å¼ºéš”ç¦»ã€å¤šç§Ÿæˆ· |
| `kata` | kata-runtime | VM çº§éš”ç¦» |

---

## åŠ¨æ‰‹ç»ƒä¹ 

### Lab 1ï¼šä½¿ç”¨ runc ç›´æ¥è¿è¡Œå®¹å™¨

**ç›®æ ‡**ï¼šæ·±å…¥ç†è§£ OCI bundle ç»“æ„å’Œ runc å·¥ä½œåŸç†ã€‚

**è¿è¡Œæ¼”ç¤ºè„šæœ¬**ï¼š

```bash
cd ~/cloud-atlas/foundations/linux/lx11-containers/10-oci-runtimes/code
./runc-demo.sh
```

**æˆ–æ‰‹åŠ¨æ‰§è¡Œ**ï¼š

**æ­¥éª¤ 1ï¼šå‡†å¤‡ OCI Bundle**

```bash
# åˆ›å»ºç›®å½•ç»“æ„
mkdir -p ~/runc-lab/mycontainer/rootfs

# å¯¼å‡º Alpine rootfs
docker export $(docker create alpine:latest) | tar -C ~/runc-lab/mycontainer/rootfs -xf -

# è¿›å…¥ bundle ç›®å½•
cd ~/runc-lab/mycontainer

# ç”Ÿæˆ config.json
runc spec
```

**æ­¥éª¤ 2ï¼šä¿®æ”¹ config.json**

```bash
# ä¿®æ”¹å¯åŠ¨å‘½ä»¤ä¸ºè¿è¡Œ top
sed -i 's/"sh"/"top", "-b"/' config.json

# ä¿®æ”¹ hostname
sed -i 's/"runc"/"my-oci-container"/' config.json

# æŸ¥çœ‹ä¿®æ”¹ç»“æœ
grep -A5 '"args"' config.json
grep '"hostname"' config.json
```

**æ­¥éª¤ 3ï¼šè¿è¡Œå®¹å™¨**

```bash
# å‰å°è¿è¡Œï¼ˆCtrl+C é€€å‡ºï¼‰
sudo runc run mycontainer

# æˆ–åå°è¿è¡Œ
sudo runc run -d mycontainer

# åˆ—å‡ºå®¹å™¨
sudo runc list

# æŸ¥çœ‹å®¹å™¨çŠ¶æ€
sudo runc state mycontainer
```

è¾“å‡ºç¤ºä¾‹ï¼š

```json
{
  "ociVersion": "1.0.2-dev",
  "id": "mycontainer",
  "pid": 12345,
  "status": "running",
  "bundle": "/home/user/runc-lab/mycontainer",
  "rootfs": "/home/user/runc-lab/mycontainer/rootfs",
  "created": "2025-01-04T10:00:00.000000000Z"
}
```

**æ­¥éª¤ 4ï¼šè¿›å…¥å®¹å™¨**

```bash
# exec è¿›å…¥å®¹å™¨
sudo runc exec -t mycontainer sh

# åœ¨å®¹å™¨å†…éªŒè¯
/ # hostname
my-oci-container
/ # ps aux
/ # exit
```

**æ­¥éª¤ 5ï¼šæ¸…ç†**

```bash
sudo runc kill mycontainer SIGKILL
sudo runc delete mycontainer
rm -rf ~/runc-lab
```

---

### Lab 2ï¼šrunc vs crun æ€§èƒ½å¯¹æ¯”

**ç›®æ ‡**ï¼šæ¯”è¾ƒ runc å’Œ crun çš„å¯åŠ¨æ€§èƒ½ã€‚

**å‡†å¤‡å·¥ä½œ**ï¼š

```bash
# å®‰è£… crunï¼ˆUbuntu/Debianï¼‰
sudo apt-get install -y crun

# æˆ–ï¼ˆRHEL/CentOSï¼‰
sudo dnf install -y crun

# éªŒè¯å®‰è£…
runc --version
crun --version
```

**å‡†å¤‡ OCI Bundle**ï¼š

```bash
mkdir -p ~/runtime-compare/test/rootfs
docker export $(docker create alpine:latest) | tar -C ~/runtime-compare/test/rootfs -xf -
cd ~/runtime-compare/test
runc spec

# ä¿®æ”¹ä¸ºéäº¤äº’å¼å‘½ä»¤
sed -i 's/"sh"/"echo", "hello"/' config.json
sed -i 's/"terminal": true/"terminal": false/' config.json
```

**æ€§èƒ½å¯¹æ¯”æµ‹è¯•**ï¼š

```bash
# runc å¯åŠ¨æ—¶é—´ï¼ˆ10 æ¬¡å¹³å‡ï¼‰
echo "Testing runc..."
for i in {1..10}; do
  time sudo runc run --rm test-runc-$i 2>&1 | grep real
done

# crun å¯åŠ¨æ—¶é—´ï¼ˆ10 æ¬¡å¹³å‡ï¼‰
echo "Testing crun..."
for i in {1..10}; do
  time sudo crun run --rm test-crun-$i 2>&1 | grep real
done
```

**å…¸å‹ç»“æœ**ï¼š

```
runc å¹³å‡å¯åŠ¨æ—¶é—´:  ~100-150ms
crun å¹³å‡å¯åŠ¨æ—¶é—´:  ~40-60ms
æ€§èƒ½æå‡:          ~50-60%
```

**æ¸…ç†**ï¼š

```bash
rm -rf ~/runtime-compare
```

---

### Lab 3ï¼šcontainerd ctr æ“ä½œ

**ç›®æ ‡**ï¼šä½¿ç”¨ ctr ç›´æ¥æ“ä½œ containerdã€‚

**éªŒè¯ containerd è¿è¡Œ**ï¼š

```bash
# æ£€æŸ¥ containerd çŠ¶æ€
sudo systemctl status containerd

# å¦‚æœä½¿ç”¨ Dockerï¼Œcontainerd å·²ç»åœ¨è¿è¡Œ
sudo ctr version
```

**é•œåƒæ“ä½œ**ï¼š

```bash
# æ‹‰å–é•œåƒï¼ˆæ³¨æ„å®Œæ•´é•œåƒåï¼‰
sudo ctr images pull docker.io/library/nginx:alpine

# åˆ—å‡ºé•œåƒ
sudo ctr images list

# æŸ¥çœ‹é•œåƒè¯¦æƒ…
sudo ctr images info docker.io/library/nginx:alpine
```

**å®¹å™¨æ“ä½œ**ï¼š

```bash
# åˆ›å»ºå¹¶è¿è¡Œå®¹å™¨
sudo ctr run -d docker.io/library/nginx:alpine nginx-test

# åˆ—å‡ºè¿è¡Œä¸­çš„å®¹å™¨
sudo ctr containers list
sudo ctr tasks list

# æŸ¥çœ‹å®¹å™¨è¯¦æƒ…
sudo ctr containers info nginx-test

# è¿›å…¥å®¹å™¨
sudo ctr tasks exec -t --exec-id exec1 nginx-test sh

# åœ¨å®¹å™¨å†…
/ # curl localhost
/ # exit

# åœæ­¢å®¹å™¨
sudo ctr tasks kill nginx-test

# åˆ é™¤å®¹å™¨
sudo ctr containers delete nginx-test
```

**Namespace æ“ä½œ**ï¼š

```bash
# åˆ—å‡ºæ‰€æœ‰ namespace
sudo ctr namespaces list

# Docker ä½¿ç”¨çš„ namespace
sudo ctr -n moby containers list  # Docker çš„ namespace æ˜¯ "moby"

# Kubernetes ä½¿ç”¨çš„ namespace
sudo ctr -n k8s.io containers list  # K8s çš„ namespace æ˜¯ "k8s.io"
```

---

## èŒåœºå°è´´å£«

### æ—¥æœ¬ IT ç°åœºå¸¸è§åœºæ™¯

**åœºæ™¯ 1ï¼šã‚³ãƒ³ãƒ†ãƒŠãƒ©ãƒ³ã‚¿ã‚¤ãƒ é¸å®šï¼ˆå®¹å™¨è¿è¡Œæ—¶é€‰å‹ï¼‰**

```
çŠ¶æ³ï¼š
æ–°è¦ Kubernetes ã‚¯ãƒ©ã‚¹ã‚¿ã®æ§‹ç¯‰ã§ã€containerd ã¨ CRI-O ã®é¸å®šã‚’æ±‚ã‚ã‚‰ã‚ŒãŸã€‚

é¸å®šåŸºæº–ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è€ƒæ…®äº‹é …                                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ—¢å­˜è³‡ç”£        â”‚ Docker ä½¿ç”¨ä¸­ â†’ containerd ãŒç§»è¡Œã—ã‚„ã™ã„         â”‚
â”‚                 â”‚ OpenShift çµŒé¨“ã‚ã‚Š â†’ CRI-O                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ é‹ç”¨ãƒãƒ¼ãƒ       â”‚ æ±ç”¨ãƒ„ãƒ¼ãƒ«å¿…è¦ â†’ containerdï¼ˆctr, nerdctl ä½¿ç”¨å¯ï¼‰â”‚
â”‚                 â”‚ K8s å°‚ç”¨ã§ååˆ† â†’ CRI-O                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ é«˜å¯†åº¦ãƒ¯ãƒ¼ã‚¯    â”‚ FaaS/Serverless â†’ crun + containerd/CRI-O        â”‚
â”‚ ãƒ­ãƒ¼ãƒ‰          â”‚ é€šå¸¸ãƒ¯ãƒ¼ã‚¯ãƒ­ãƒ¼ãƒ‰ â†’ runc ã§ååˆ†                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£    â”‚ æœ€å°æ”»æ’ƒé¢å„ªå…ˆ â†’ CRI-O                            â”‚
â”‚ è¦ä»¶            â”‚ æ©Ÿèƒ½å„ªå…ˆ â†’ containerd                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å ±å‘Šä¾‹ï¼š
ã€ŒDocker ã‹ã‚‰ã®ç§»è¡Œã‚’è€ƒæ…®ã—ã€containerd ã‚’æ¨å¥¨ã—ã¾ã™ã€‚
 é«˜å¯†åº¦ãƒ¯ãƒ¼ã‚¯ãƒ­ãƒ¼ãƒ‰ã«ã¯ crun ã‚’ RuntimeClass ã§è¨­å®šå¯èƒ½ã§ã™ã€‚ã€
```

**å ´æ™¯ 2ï¼šRuntimeClass ã®è¨­å®š**

```yaml
# é‹ç”¨ãƒãƒ¼ãƒ ã¸ã®èª¬æ˜è³‡æ–™

# 1. RuntimeClass å®šç¾©
apiVersion: node.k8s.io/v1
kind: RuntimeClass
metadata:
  name: crun-fast
handler: crun
---
# 2. é«˜ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ Pod ã§ã®ä½¿ç”¨
apiVersion: v1
kind: Pod
metadata:
  name: fast-job
spec:
  runtimeClassName: crun-fast  # crun ä½¿ç”¨
  containers:
  - name: worker
    image: worker:latest
    resources:
      limits:
        cpu: "2"
        memory: "4Gi"
```

**å ´æ™¯ 3ï¼šãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚° - ã‚³ãƒ³ãƒ†ãƒŠèµ·å‹•å¤±æ•—**

```bash
# å•é¡Œ: Pod ãŒ ContainerCreating ã®ã¾ã¾

# 1. kubelet ãƒ­ã‚°ç¢ºèª
journalctl -u kubelet | grep -i runtime | tail -20

# 2. containerd ãƒ­ã‚°ç¢ºèª
journalctl -u containerd | grep -i error | tail -20

# 3. ctr ã§ç›´æ¥ç¢ºèª
sudo ctr -n k8s.io containers list
sudo ctr -n k8s.io tasks list

# 4. runc çŠ¶æ…‹ç¢ºèª
sudo runc list

# ã‚ˆãã‚ã‚‹åŸå› ï¼š
# - RuntimeClass è¨­å®šãƒŸã‚¹
# - runc/crun ãƒã‚¤ãƒŠãƒªä¸è¶³
# - cgroup v1/v2 ä¸æ•´åˆ
```

### Kubernetes CRI ç†è§£ã®é‡è¦æ€§

```
é¢æ¥ã§ã‚ˆãèã‹ã‚Œã‚‹è³ªå•ï¼š

Q: Docker ã‹ã‚‰ containerd ã¸ã®ç§»è¡Œã§æ³¨æ„ç‚¹ã¯ï¼Ÿ
A:
1. docker CLI ãŒä½¿ãˆãªããªã‚‹ â†’ crictl ã¾ãŸã¯ nerdctl ä½¿ç”¨
2. ã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰ã¯åˆ¥ãƒ„ãƒ¼ãƒ«å¿…è¦ â†’ buildah, kaniko
3. ãƒ­ã‚°å½¢å¼ãŒå¤‰ã‚ã‚‹å¯èƒ½æ€§ â†’ ç›£è¦–è¨­å®šã®ç¢ºèª

Q: containerd ã¨ CRI-O ã®é•ã„ã¯ï¼Ÿ
A:
- containerd: æ±ç”¨çš„ã€Docker ã§ã‚‚ K8s ã§ã‚‚ä½¿ãˆã‚‹
- CRI-O: K8s å°‚ç”¨ã€æ©Ÿèƒ½ãŒçµã‚‰ã‚Œã¦ã„ã‚‹åˆ†ã‚·ãƒ³ãƒ—ãƒ«
- é¸å®šã¯ãƒãƒ¼ãƒ ã®ã‚¹ã‚­ãƒ«ã¨è¦ä»¶æ¬¡ç¬¬
```

---

## æ£€æŸ¥æ¸…å•

å®Œæˆæœ¬è¯¾åï¼Œä½ åº”è¯¥èƒ½å¤Ÿï¼š

- [ ] èª¬æ˜ OCI è§„èŒƒçš„ä¸‰å¤§ç»„æˆï¼ˆRuntime Specã€Image Specã€Distribution Specï¼‰
- [ ] åŒºåˆ†é«˜çº§è¿è¡Œæ—¶ï¼ˆcontainerdã€CRI-Oï¼‰å’Œä½çº§è¿è¡Œæ—¶ï¼ˆruncã€crunï¼‰
- [ ] åˆ›å»º OCI Bundle å¹¶ä½¿ç”¨ runc ç›´æ¥è¿è¡Œå®¹å™¨
- [ ] ç†è§£ config.json çš„å…³é”®å­—æ®µåŠå…¶å¯¹åº”çš„å†…æ ¸æœºåˆ¶
- [ ] æ¯”è¾ƒ runc å’Œ crun çš„å·®å¼‚ï¼Œè¯´æ˜ crun çš„é€‚ç”¨åœºæ™¯
- [ ] ä½¿ç”¨ ctr å‘½ä»¤ç®¡ç† containerd ä¸­çš„é•œåƒå’Œå®¹å™¨
- [ ] è§£é‡Š Kubernetes CRI æ¶æ„å’Œ RuntimeClass çš„ä½œç”¨
- [ ] åœ¨ containerd vs CRI-O é€‰å‹æ—¶æä¾›æŠ€æœ¯å»ºè®®
- [ ] æ’æŸ¥å®¹å™¨è¿è¡Œæ—¶ç›¸å…³é—®é¢˜ï¼ˆæ£€æŸ¥ runc/containerd æ—¥å¿—ï¼‰

---

## å»¶ä¼¸é˜…è¯»

### å®˜æ–¹æ–‡æ¡£

- [OCI Runtime Specification](https://github.com/opencontainers/runtime-spec)
- [OCI Image Specification](https://github.com/opencontainers/image-spec)
- [runc GitHub](https://github.com/opencontainers/runc)
- [crun GitHub](https://github.com/containers/crun)
- [containerd Documentation](https://containerd.io/docs/)
- [CRI-O Documentation](https://cri-o.io/)

### ç›¸å…³è¯¾ç¨‹

- [Lesson 01 - å®¹å™¨ vs è™šæ‹Ÿæœº](../01-containers-vs-vms/) - å®¹å™¨åŸºç¡€æ¦‚å¿µ
- [Lesson 09 - å®¹å™¨å®‰å…¨](../09-container-security/) - seccompã€Capabilities
- [Lesson 11 - å®¹å™¨æ•…éšœæ’æŸ¥](../11-debugging-troubleshooting/) - å®Œæ•´è°ƒè¯•æ–¹æ³•è®º
- [Lesson 12 - Capstone](../12-capstone/) - ä»é›¶æ„å»ºå®¹å™¨

### æ¨èé˜…è¯»

- *Container Security* by Liz Rice - åŒ…å«è¿è¡Œæ—¶å®‰å…¨ç« èŠ‚
- [Kubernetes CRI Plugin](https://kubernetes.io/docs/concepts/architecture/cri/) - K8s å®˜æ–¹ CRI æ–‡æ¡£
- [nerdctl](https://github.com/containerd/nerdctl) - containerd çš„ Docker å…¼å®¹ CLI

---

## ç³»åˆ—å¯¼èˆª

[<-- 09 - å®¹å™¨å®‰å…¨](../09-container-security/) | [Home](../) | [11 - å®¹å™¨æ•…éšœæ’æŸ¥ -->](../11-debugging-troubleshooting/)
