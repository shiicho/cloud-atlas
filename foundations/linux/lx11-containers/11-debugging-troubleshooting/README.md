# 11 - å®¹å™¨æ•…éšœæ’æŸ¥ï¼ˆDebugging & Troubleshootingï¼‰

> **ç›®æ ‡**ï¼šå»ºç«‹å®¹å™¨æ•…éšœæ’æŸ¥ç³»ç»Ÿæ–¹æ³•è®ºï¼Œæ•´åˆå‰ 10 è¯¾çŸ¥è¯†ï¼ŒæŒæ¡ OOM/ç½‘ç»œ/å­˜å‚¨/è¿›ç¨‹å››å¤§é—®é¢˜çš„å®šä½æŠ€å·§  
> **å‰ç½®**ï¼š[Lesson 10 - OCI è¿è¡Œæ—¶](../10-oci-runtimes/)ï¼›å»ºè®®å®Œæˆ Lesson 03 (nsenter)ã€06 (cgroups)ã€08 (ç½‘ç»œ)  
> **æ—¶é—´**ï¼šâš¡ 40 åˆ†é’Ÿï¼ˆé€Ÿè¯»ï¼‰/ ğŸ”¬ 150 åˆ†é’Ÿï¼ˆå®Œæ•´å®æ“ï¼‰  
> **åœºæ™¯**ï¼šéšœå®³å¯¾å¿œã‚¹ã‚­ãƒ«ï¼ˆæ•…éšœå¯¹åº”æŠ€èƒ½ï¼‰â€”â€” æ—¥æœ¬ IT è¿ç»´ç°åœºæœ€é‡è¦çš„èƒ½åŠ›  

---

## å°†å­¦åˆ°çš„å†…å®¹

1. å»ºç«‹å®¹å™¨æ•…éšœæ’æŸ¥ç³»ç»Ÿæ–¹æ³•è®ºï¼ˆ4 æ­¥å®šä½æ³•ï¼‰
2. è°ƒæŸ¥ã€Œé™é»˜ OOM Killã€â€”â€” å¤œé—´æ‰¹å¤„ç†æ¶ˆå¤±çš„çœŸç›¸
3. ä½¿ç”¨ nsenter è°ƒè¯• Distroless é»‘ç®±å®¹å™¨ï¼ˆæ—  shell/curl/pingï¼‰
4. å®šä½ã€Œç£ç›˜ç©ºé—´ä¹‹è°œã€â€”â€” Zabbix å‘Šè­¦ä½†å®¹å™¨å†…çœ‹ä¸åˆ°
5. ç»•è¿‡ docker exec è°ƒè¯•å¡æ­»å®¹å™¨

**æœ¬è¯¾æ˜¯ã€ŒæŠ€èƒ½æ•´åˆè¯¾ã€**ï¼šä½ å°†è¿ç”¨å‰ 10 è¯¾æ‰€æœ‰çŸ¥è¯†è§£å†³çœŸå®ç”Ÿäº§é—®é¢˜ã€‚

---

## å…ˆè·‘èµ·æ¥ï¼š5 åˆ†é’Ÿè°ƒæŸ¥ã€Œæ¶ˆå¤±çš„è¿›ç¨‹ã€

> **ä¸è®²åŸç†ï¼Œå…ˆåŠ¨æ‰‹ï¼** æ¨¡æ‹Ÿä¸€ä¸ªè¿›ç¨‹ã€Œç¥ç§˜æ¶ˆå¤±ã€çš„åœºæ™¯ï¼Œç„¶åæ‰¾åˆ°è¯æ®ã€‚  

### åˆ›å»ºå—é™ cgroup

```bash
# åˆ›å»º cgroupï¼Œé™åˆ¶å†…å­˜ 30MB
sudo mkdir /sys/fs/cgroup/mystery-gone
echo "30M" | sudo tee /sys/fs/cgroup/mystery-gone/memory.max

# å¯åŠ¨ä¸€ä¸ªã€Œä¼šæ¶ˆå¤±ã€çš„è¿›ç¨‹
sudo bash -c 'echo $$ > /sys/fs/cgroup/mystery-gone/cgroup.procs && stress --vm 1 --vm-bytes 50M --timeout 60s'
```

è¾“å‡ºï¼š

```
stress: info: [12345] dispatching hogs: 0 cpu, 0 io, 1 vm, 0 hdd
stress: FAIL: [12345] (415) <-- worker 12346 got signal 9
stress: WARN: [12345] (417) now reaping child worker processes
stress: FAIL: [12345] (451) failed run completed in 0s
```

è¿›ç¨‹ã€Œæ¶ˆå¤±ã€äº†ï¼æ²¡æœ‰ä»»ä½•åº”ç”¨æ—¥å¿—ã€‚è¿™å°±æ˜¯è¿ç»´ç°åœºçš„å…¸å‹é—®é¢˜ã€‚

### æ‰¾åˆ°è¯æ®

**è¯æ® 1ï¼šå†…æ ¸æ—¥å¿—**

```bash
dmesg | grep -i oom | tail -5
```

è¾“å‡ºï¼š

```
[xxxxx.xxxxxx] oom-kill:constraint=CONSTRAINT_MEMCG...
[xxxxx.xxxxxx] Memory cgroup out of memory: Killed process 12346 (stress)
```

**è¯æ® 2ï¼šcgroup äº‹ä»¶ç»Ÿè®¡**

```bash
cat /sys/fs/cgroup/mystery-gone/memory.events
```

è¾“å‡ºï¼š

```
low 0
high 0
max 1
oom 1
oom_kill 1
```

**oom_kill 1** â€”â€” é“è¯ï¼å†…æ ¸å› å†…å­˜é™åˆ¶æ€æ­»äº†è¿›ç¨‹ã€‚

### æ¸…ç†

```bash
sudo rmdir /sys/fs/cgroup/mystery-gone
```

---

**ä½ åˆšåˆšåšäº†ä»€ä¹ˆï¼Ÿ**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     æ•…éšœæ’æŸ¥é»„é‡‘æ³•åˆ™                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  åº”ç”¨æ—¥å¿—ï¼šç©º                                                        â”‚
â”‚       â”‚                                                             â”‚
â”‚       â–¼                                                             â”‚
â”‚  ã€Œè¿›ç¨‹æ¶ˆå¤±äº†ï¼Œä½†æˆ‘ä¸çŸ¥é“ä¸ºä»€ä¹ˆã€                                     â”‚
â”‚       â”‚                                                             â”‚
â”‚       â–¼                                                             â”‚
â”‚  å®¹å™¨æ—¥å¿—ä¸å¤Ÿï¼éœ€è¦æ£€æŸ¥å®¿ä¸»æœºï¼š                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ dmesg           â†’  å†…æ ¸æ€æ­»è¿›ç¨‹çš„è®°å½•                        â”‚   â”‚
â”‚  â”‚ memory.events   â†’  cgroup OOM äº‹ä»¶ç»Ÿè®¡                       â”‚   â”‚
â”‚  â”‚ audit.log       â†’  seccomp/SELinux æ‹’ç»                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â”‚  åæ¨¡å¼ï¼šã€Œåªçœ‹å®¹å™¨æ—¥å¿—ï¼Œä¸çœ‹å®¿ä¸»æœº dmesgã€                            â”‚
â”‚  â†’ OOM Kill å’Œ seccomp æ‹’ç»åªåœ¨å®¿ä¸»æœºå¯è§ï¼                          â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

è¿™å°±æ˜¯æœ¬è¯¾çš„æ ¸å¿ƒæ€æƒ³ï¼š**å®¹å™¨é—®é¢˜å¾€å¾€éœ€è¦ä»å®¿ä¸»æœºè§†è§’è¯Šæ–­**ã€‚

---

## æ ¸å¿ƒæ¦‚å¿µï¼šæ•…éšœæ’æŸ¥æ–¹æ³•è®º

### 4 æ­¥å®šä½æ³•

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å®¹å™¨æ•…éšœæ’æŸ¥ 4 æ­¥å®šä½æ³•                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  Step 1: ç¡®å®šé—®é¢˜ç±»å‹                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚   å¯åŠ¨å¤±è´¥   â”‚   è¿è¡Œæ—¶æ¶ˆå¤±  â”‚   ç½‘ç»œä¸é€š   â”‚   èµ„æºé—®é¢˜   â”‚      â”‚
â”‚  â”‚  (Startup)   â”‚  (Runtime)   â”‚  (Network)   â”‚  (Resource)  â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                                                     â”‚
â”‚  Step 2: æ”¶é›†è¯æ®                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ å®¹å™¨å±‚: docker logs, docker inspect                          â”‚   â”‚
â”‚  â”‚ å®¿ä¸»æœº: dmesg, journalctl, /var/log/audit/audit.log          â”‚   â”‚
â”‚  â”‚ cgroup: memory.events, cpu.stat, pids.current                â”‚   â”‚
â”‚  â”‚ Namespace: nsenter è¿›å…¥æ£€æŸ¥                                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â”‚  Step 3: éš”ç¦»é—®é¢˜å±‚                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚         åº”ç”¨å±‚ (App)                                          â”‚   â”‚
â”‚  â”‚              â†“                                                â”‚   â”‚
â”‚  â”‚         å®¹å™¨å±‚ (Container Runtime)                            â”‚   â”‚
â”‚  â”‚              â†“                                                â”‚   â”‚
â”‚  â”‚         å®¿ä¸»æœºå±‚ (Host OS)                                    â”‚   â”‚
â”‚  â”‚              â†“                                                â”‚   â”‚
â”‚  â”‚         å†…æ ¸å±‚ (Kernel: cgroups, namespaces, seccomp)         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â”‚  Step 4: éªŒè¯ä¿®å¤                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ å¤ç°é—®é¢˜ â†’ åº”ç”¨ä¿®å¤ â†’ éªŒè¯ä¿®å¤ â†’ ç›‘æ§é˜²æ­¢å¤å‘                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ—¥å¿—å±‚çº§ï¼šä»å“ªé‡Œæ‰¾è¯æ®ï¼Ÿ

| é—®é¢˜ç±»å‹ | åº”ç”¨æ—¥å¿— | å®¹å™¨æ—¥å¿— | å®¿ä¸»æœºæ—¥å¿— | cgroup æ–‡ä»¶ |
|----------|----------|----------|------------|-------------|
| OOM Kill | æ—  | æ— /çªç„¶åœæ­¢ | **dmesg æœ‰è®°å½•** | **memory.events** |
| seccomp æ‹’ç» | å¯èƒ½æœ‰ | å¯èƒ½æœ‰ | **dmesg/audit.log** | - |
| ç½‘ç»œä¸é€š | è¶…æ—¶é”™è¯¯ | - | - | - |
| CPU é™æµ | å˜æ…¢ | - | - | **cpu.stat** |
| ç£ç›˜æ»¡ | å†™å…¥å¤±è´¥ | - | df -h | - |

**å…³é”®è®¤è¯†**ï¼šå®¹å™¨æ—¥å¿—æ˜¯ã€Œåº”ç”¨è§†è§’ã€ï¼Œå®¿ä¸»æœºæ—¥å¿—æ˜¯ã€Œå†…æ ¸è§†è§’ã€ã€‚å¾ˆå¤šé—®é¢˜åªæœ‰å†…æ ¸çŸ¥é“ï¼

---

## åœºæ™¯ 1ï¼šSilent OOM Killï¼ˆé™é»˜ OOM Killï¼‰

### é—®é¢˜æè¿°

```
çŠ¶æ³ï¼š
æ¯å¤©å‡Œæ™¨ 3 ç‚¹ï¼Œå¤œé—´æ‰¹å¤„ç†å®¹å™¨çªç„¶æ¶ˆå¤±ã€‚
æ£€æŸ¥åº”ç”¨æ—¥å¿—ï¼šç©ºã€‚
æ£€æŸ¥ docker logsï¼šä»€ä¹ˆéƒ½æ²¡æœ‰ã€‚
å·¥ç¨‹å¸ˆéœ€è¦è¯æ˜æ˜¯å†…æ ¸æ€æ­»äº†è¿›ç¨‹ï¼Œè€Œéåº”ç”¨ bugã€‚

æ—¥æœ¬è¯­ï¼š
å¤œé–“ãƒãƒƒãƒãŒ 03:00 ã«ç•°å¸¸çµ‚äº†ã€‚ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚°ã«è¨˜éŒ²ãªã—ã€‚
```

### åŠ¨æ‰‹æ’æŸ¥

**è¿è¡Œæ¼”ç¤ºè„šæœ¬**ï¼š

```bash
cd ~/cloud-atlas/foundations/linux/lx11-containers/11-debugging-troubleshooting/code
sudo ./silent-oom-scenario.sh
```

**æˆ–æ‰‹åŠ¨æ‰§è¡Œ**ï¼š

**æ­¥éª¤ 1ï¼šæ¨¡æ‹Ÿå¤œé—´æ‰¹å¤„ç†ï¼ˆå— cgroup é™åˆ¶ï¼‰**

```bash
# åˆ›å»º cgroup æ¨¡æ‹Ÿ Kubernetes Pod èµ„æºé™åˆ¶
sudo mkdir -p /sys/fs/cgroup/batch-job
echo "100M" | sudo tee /sys/fs/cgroup/batch-job/memory.max

# è¿è¡Œã€Œæ‰¹å¤„ç†ã€ï¼ˆä¼šè¢« OOM Killï¼‰
sudo bash -c 'echo $$ > /sys/fs/cgroup/batch-job/cgroup.procs && stress --vm 1 --vm-bytes 200M --timeout 60s'
```

è¿›ç¨‹ç«‹å³æ¶ˆå¤±ï¼Œæ— ä»»ä½•åº”ç”¨è¾“å‡ºã€‚

**æ­¥éª¤ 2ï¼šæ”¶é›†è¯æ®**

```bash
# è¯æ® 1ï¼šå†…æ ¸æ—¥å¿—ï¼ˆæœ€å…³é”®ï¼ï¼‰
dmesg | grep -i oom | tail -10
```

è¾“å‡ºï¼š

```
[xxxxx.xxxxxx] oom-kill:constraint=CONSTRAINT_MEMCG,nodemask=...
[xxxxx.xxxxxx] Memory cgroup out of memory: Killed process XXXX (stress) ...
[xxxxx.xxxxxx] oom_reaper: reaped process XXXX (stress), now anon-rss:0kB ...
```

```bash
# è¯æ® 2ï¼šcgroup OOM äº‹ä»¶ç»Ÿè®¡
cat /sys/fs/cgroup/batch-job/memory.events
```

è¾“å‡ºï¼š

```
low 0
high 0
max 1
oom 1
oom_kill 1
oom_group_kill 0
```

```bash
# è¯æ® 3ï¼šjournalctl å†…æ ¸æ¶ˆæ¯
journalctl -k --since "5 minutes ago" | grep -i oom
```

**æ­¥éª¤ 3ï¼šç”Ÿæˆéšœå®³å ±å‘Šæ›¸ï¼ˆäº‹æ•…æŠ¥å‘Šï¼‰**

```markdown
## éšœå®³å ±å‘Šæ›¸

### äº‹è±¡
å¤œé–“ãƒãƒƒãƒå‡¦ç†ãŒ 03:00 ã«ç•°å¸¸çµ‚äº†ã€‚ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚°ã«è¨˜éŒ²ãªã—ã€‚

### åŸå› 
cgroup ãƒ¡ãƒ¢ãƒªåˆ¶é™ (100MB) ã«ã‚ˆã‚‹ OOM Killã€‚
ãƒãƒƒãƒå‡¦ç†ãŒ 200MB ä»¥ä¸Šã®ãƒ¡ãƒ¢ãƒªã‚’ä½¿ç”¨ã—ã‚ˆã†ã¨ã—ãŸã€‚

### è¨¼æ‹ 
1. dmesg å‡ºåŠ›ï¼š
   `Memory cgroup out of memory: Killed process XXXX (stress)`

2. memory.eventsï¼š
   `oom_kill 1`

3. memory.max è¨­å®šï¼š
   `100M`

### å¯¾ç­–
1. çŸ­æœŸï¼šãƒ¡ãƒ¢ãƒªåˆ¶é™ã‚’ 256M ã«å¼•ãä¸Šã’
2. é•·æœŸï¼šãƒãƒƒãƒå‡¦ç†ã®ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ã‚’æœ€é©åŒ–
3. ç›£è¦–ï¼šmemory.events ã® oom_kill ã‚’ Zabbix ã§ç›£è¦–
```

**æ­¥éª¤ 4ï¼šæ¸…ç†**

```bash
sudo rmdir /sys/fs/cgroup/batch-job 2>/dev/null
```

---

## åœºæ™¯ 2ï¼šDistroless Black Boxï¼ˆDistroless é»‘ç®±è°ƒè¯•ï¼‰

### é—®é¢˜æè¿°

```
çŠ¶æ³ï¼š
Go åº”ç”¨éƒ¨ç½²åœ¨ distroless é•œåƒä¸­ï¼ˆgcr.io/distroless/staticï¼‰ã€‚
åº”ç”¨æ— æ³•è¿æ¥ RDS æ•°æ®åº“ï¼Œä½†å®¹å™¨å†…æ²¡æœ‰ shellã€curlã€pingï¼
æ— æ³•ä½¿ç”¨ docker exec è°ƒè¯•ã€‚

æ—¥æœ¬è¯­ï¼š
æœ¬ç•ªç’°å¢ƒã§ã¯ debug ãƒ„ãƒ¼ãƒ«ã‚’å«ã¾ãªã„è»½é‡ã‚¤ãƒ¡ãƒ¼ã‚¸ãŒæ¨å¥¨ã•ã‚Œã‚‹ã€‚
nsenter ã¯ã“ã®ã‚ˆã†ãªç’°å¢ƒã§ã®ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°å¿…é ˆã‚¹ã‚­ãƒ«ã€‚
```

### åŠ¨æ‰‹æ’æŸ¥

**è¿è¡Œæ¼”ç¤ºè„šæœ¬**ï¼š

```bash
cd ~/cloud-atlas/foundations/linux/lx11-containers/11-debugging-troubleshooting/code
sudo ./distroless-debug-scenario.sh
```

**æˆ–æ‰‹åŠ¨æ‰§è¡Œ**ï¼š

**æ­¥éª¤ 1ï¼šå¯åŠ¨ã€Œæ— æ³•è°ƒè¯•ã€çš„å®¹å™¨**

```bash
# ä½¿ç”¨ alpine æ¨¡æ‹Ÿ distrolessï¼ˆåˆ é™¤ shell æ¥æ¨¡æ‹Ÿï¼‰
docker run -d --name distroless-app alpine sleep infinity

# å°è¯• exec è¿›å…¥ï¼ˆä¼šå¤±è´¥ï¼Œå› ä¸ºæˆ‘ä»¬å°†æ¨¡æ‹Ÿæ—  shellï¼‰
# docker exec -it distroless-app /bin/sh  # å‡è®¾å¤±è´¥
```

**æ­¥éª¤ 2ï¼šè·å–å®¹å™¨ PID**

```bash
# è·å–å®¹å™¨åœ¨å®¿ä¸»æœºä¸Šçš„ PID
PID=$(docker inspect --format '{{.State.Pid}}' distroless-app)
echo "Container PID: $PID"
```

**æ­¥éª¤ 3ï¼šä½¿ç”¨ nsenter è¿›å…¥ Network Namespace**

```bash
# åªè¿›å…¥ç½‘ç»œå‘½åç©ºé—´ï¼ˆä¸éœ€è¦å®¹å™¨å†…æœ‰ shellï¼‰
sudo nsenter -t $PID -n ip addr
```

è¾“å‡ºï¼š

```
1: lo: <LOOPBACK,UP,LOWER_UP> ...
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
42: eth0@if43: <BROADCAST,MULTICAST,UP,LOWER_UP> ...
    inet 172.17.0.2/16 brd 172.17.255.255 scope global eth0
       valid_lft forever preferred_lft forever
```

**æ­¥éª¤ 4ï¼šåœ¨å®¹å™¨ç½‘ç»œç©ºé—´æ‰§è¡Œè°ƒè¯•å‘½ä»¤**

```bash
# æµ‹è¯•ç½‘ç»œè¿é€šæ€§ï¼ˆä½¿ç”¨å®¿ä¸»æœºçš„ pingï¼‰
sudo nsenter -t $PID -n ping -c 3 8.8.8.8

# æ£€æŸ¥è·¯ç”±
sudo nsenter -t $PID -n ip route

# æ£€æŸ¥ DNS è§£æï¼ˆå¦‚æœå®¿ä¸»æœºæœ‰ nslookupï¼‰
sudo nsenter -t $PID -n nslookup google.com

# æŠ“åŒ…åˆ†æï¼ˆå¼ºå¤§ï¼ï¼‰
sudo nsenter -t $PID -n tcpdump -i eth0 -c 10
```

**æ­¥éª¤ 5ï¼šæ¨¡æ‹Ÿ RDS è¿æ¥é—®é¢˜æ’æŸ¥**

```bash
# æµ‹è¯•ç‰¹å®šç«¯å£è¿é€šæ€§ï¼ˆæ¨¡æ‹Ÿ RDS 3306ï¼‰
sudo nsenter -t $PID -n nc -zv 8.8.8.8 443

# å¦‚æœæ˜¯ DNS é—®é¢˜ï¼Œæ£€æŸ¥ /etc/resolv.conf
sudo nsenter -t $PID -m cat /etc/resolv.conf
```

**å…³é”®æŠ€å·§**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   nsenter é€‰æ‹©æ€§è¿›å…¥ Namespace                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  nsenter -t <PID> -n               # åªè¿›å…¥ Network NS              â”‚
â”‚  nsenter -t <PID> -m               # åªè¿›å…¥ Mount NS                â”‚
â”‚  nsenter -t <PID> -p               # åªè¿›å…¥ PID NS                  â”‚
â”‚  nsenter -t <PID> -n -m            # è¿›å…¥ Network + Mount           â”‚
â”‚  nsenter -t <PID> -a               # è¿›å…¥æ‰€æœ‰ NS                    â”‚
â”‚                                                                     â”‚
â”‚  æŠ€å·§ï¼š                                                              â”‚
â”‚  - ç½‘ç»œé—®é¢˜ï¼šåªè¿› -nï¼Œç”¨å®¿ä¸»æœºå·¥å…·ï¼ˆping, tcpdump, ncï¼‰              â”‚
â”‚  - æ–‡ä»¶é—®é¢˜ï¼šåªè¿› -mï¼ŒæŸ¥çœ‹å®¹å™¨æ–‡ä»¶ç³»ç»Ÿ                               â”‚
â”‚  - è¿›ç¨‹é—®é¢˜ï¼šè¿› -m -pï¼ŒæŸ¥çœ‹ /proc/1/...                             â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ­¥éª¤ 6ï¼šæ¸…ç†**

```bash
docker rm -f distroless-app
```

---

## åœºæ™¯ 3ï¼šDisk Space Mysteryï¼ˆç£ç›˜ç©ºé—´ä¹‹è°œï¼‰

### é—®é¢˜æè¿°

```
çŠ¶æ³ï¼š
Zabbix å‘Šè­¦ï¼šå®¿ä¸»æœºç£ç›˜ 100% æ»¡ã€‚
ä½†å®¹å™¨å†… du -sh / åªæ˜¾ç¤º 500MBã€‚
ã€Œéšè—ã€çš„ç£ç›˜ç©ºé—´å»å“ªäº†ï¼Ÿ

æ—¥æœ¬è¯­ï¼š
é‹ç”¨ç›£è¦–ã§ãƒ‡ã‚£ã‚¹ã‚¯å®¹é‡ã‚¢ãƒ©ãƒ¼ãƒˆã¯ã‚ˆãã‚ã‚‹ã€‚
ã‚³ãƒ³ãƒ†ãƒŠç’°å¢ƒã§ã¯ã€Œè¦‹ãˆãªã„ã€æ¶ˆè²»ãŒå•é¡Œã«ãªã‚Šã‚„ã™ã„ã€‚
```

### å¯èƒ½åŸå› 

1. **å·²åˆ é™¤ä½†ä»è¢«æ‰“å¼€çš„æ–‡ä»¶**ï¼šè¿›ç¨‹æŒæœ‰æ–‡ä»¶å¥æŸ„ï¼Œæ–‡ä»¶è™½åˆ é™¤ä½†ç©ºé—´æœªé‡Šæ”¾
2. **OverlayFS upper å±‚è†¨èƒ€**ï¼šå®¹å™¨å†…å†™å…¥å¤§é‡æ•°æ®åˆ° overlay è€Œé volume
3. **Docker æ—¥å¿—è†¨èƒ€**ï¼šJSON æ—¥å¿—æ–‡ä»¶æ— é™å¢é•¿
4. **æœªæ¸…ç†çš„æ‚¬ç©ºé•œåƒ**ï¼šdangling images å ç”¨ç©ºé—´

### åŠ¨æ‰‹æ’æŸ¥

**è¿è¡Œæ¼”ç¤ºè„šæœ¬**ï¼š

```bash
cd ~/cloud-atlas/foundations/linux/lx11-containers/11-debugging-troubleshooting/code
sudo ./disk-mystery-scenario.sh
```

**æˆ–æ‰‹åŠ¨æ‰§è¡Œ**ï¼š

**æ­¥éª¤ 1ï¼šæ£€æŸ¥å®¿ä¸»æœºç£ç›˜ä½¿ç”¨**

```bash
# å®¿ä¸»æœºè§†è§’
df -h /var/lib/docker
```

**æ­¥éª¤ 2ï¼šæ£€æŸ¥å·²åˆ é™¤ä½†æ‰“å¼€çš„æ–‡ä»¶**

```bash
# æŸ¥æ‰¾è¢«åˆ é™¤ä½†ä»è¢«æ‰“å¼€çš„æ–‡ä»¶ï¼ˆç©ºé—´æœªé‡Šæ”¾ï¼‰
sudo lsof +L1 | head -20

# æŒ‰å¤§å°æ’åº
sudo lsof +L1 2>/dev/null | awk 'NR>1 {print $7, $1, $9}' | sort -rn | head -10
```

è¾“å‡ºç¤ºä¾‹ï¼š

```
SIZE      COMMAND    NAME
104857600 java       /var/log/app.log (deleted)
52428800  nginx      /var/log/access.log (deleted)
```

**é—®é¢˜**ï¼šæ–‡ä»¶å·²åˆ é™¤ï¼ˆdeletedï¼‰ï¼Œä½†è¿›ç¨‹ä»æŒæœ‰å¥æŸ„ï¼Œç©ºé—´æœªé‡Šæ”¾ï¼

**è§£å†³æ–¹æ¡ˆ**ï¼š

```bash
# æ–¹æ³• 1ï¼šé‡å¯æŒæœ‰å¥æŸ„çš„è¿›ç¨‹
docker restart <container>

# æ–¹æ³• 2ï¼šæ¸…ç©ºæ–‡ä»¶å†…å®¹ï¼ˆä¸åˆ é™¤å¥æŸ„ï¼‰
# æ‰¾åˆ°è¿›ç¨‹ PID å’Œ FD
PID=<from lsof output>
FD=<from lsof output>
# æ¸…ç©º
: > /proc/$PID/fd/$FD
```

**æ­¥éª¤ 3ï¼šæ£€æŸ¥ OverlayFS upper å±‚**

```bash
# æŸ¥çœ‹å®¹å™¨çš„ overlay å­˜å‚¨
docker inspect <container> | jq '.[0].GraphDriver.Data'
```

è¾“å‡ºï¼š

```json
{
  "LowerDir": "/var/lib/docker/overlay2/.../diff:...",
  "MergedDir": "/var/lib/docker/overlay2/.../merged",
  "UpperDir": "/var/lib/docker/overlay2/.../diff",
  "WorkDir": "/var/lib/docker/overlay2/.../work"
}
```

```bash
# æ£€æŸ¥ UpperDir å¤§å°ï¼ˆå®¹å™¨è¿è¡Œæ—¶å†™å…¥çš„æ•°æ®ï¼‰
sudo du -sh /var/lib/docker/overlay2/<id>/diff
```

**é—®é¢˜**ï¼šå¦‚æœ UpperDir å¾ˆå¤§ï¼Œè¯´æ˜å®¹å™¨å†…å†™å…¥äº†å¤§é‡æ•°æ®åˆ° overlay è€Œé volumeã€‚

**æ­¥éª¤ 4ï¼šæ£€æŸ¥ Docker ç©ºé—´ä½¿ç”¨**

```bash
# Docker ç£ç›˜ä½¿ç”¨æ¦‚è§ˆ
docker system df

# è¯¦ç»†ä¿¡æ¯
docker system df -v
```

è¾“å‡ºï¼š

```
TYPE            TOTAL     ACTIVE    SIZE      RECLAIMABLE
Images          10        5         5.2GB     2.1GB (40%)
Containers      8         3         500MB     200MB (40%)
Local Volumes   5         3         10GB      5GB (50%)
Build Cache     0         0         0B        0B
```

**æ­¥éª¤ 5ï¼šæ¸…ç†æ‚¬ç©ºèµ„æº**

```bash
# æ¸…ç†æœªä½¿ç”¨çš„èµ„æº
docker system prune

# æ›´æ¿€è¿›çš„æ¸…ç†ï¼ˆåŒ…æ‹¬æœªä½¿ç”¨çš„ volumeï¼‰
docker system prune -a --volumes
```

**æ­¥éª¤ 6ï¼šä½¿ç”¨ nsenter è¿›å…¥ Mount Namespace æ£€æŸ¥**

```bash
PID=$(docker inspect --format '{{.State.Pid}}' <container>)

# è¿›å…¥ mount namespace æŸ¥çœ‹å®¹å™¨è§†è§’çš„ç£ç›˜ä½¿ç”¨
sudo nsenter -t $PID -m df -h

# æŸ¥æ‰¾å®¹å™¨å†…å¤§æ–‡ä»¶
sudo nsenter -t $PID -m find / -type f -size +100M 2>/dev/null
```

---

## åœºæ™¯ 4ï¼šStuck Container Processï¼ˆå¡æ­»çš„å®¹å™¨è¿›ç¨‹ï¼‰

### é—®é¢˜æè¿°

```
çŠ¶æ³ï¼š
Java å®¹å™¨åƒµæ­»ï¼Œdocker exec -it <container> /bin/bash æŒ‚èµ·æ— å“åº”ã€‚
docker logs æ²¡æœ‰æ–°è¾“å‡ºã€‚
éœ€è¦ä¸ä¾èµ– docker exec çš„è°ƒè¯•æ–¹æ³•ã€‚
```

### åŠ¨æ‰‹æ’æŸ¥

**æ­¥éª¤ 1ï¼šç¡®è®¤å®¹å™¨çŠ¶æ€**

```bash
docker ps | grep <container>
docker inspect --format '{{.State.Status}}' <container>
```

**æ­¥éª¤ 2ï¼šè·å–å®¹å™¨ PID**

```bash
PID=$(docker inspect --format '{{.State.Pid}}' <container>)
echo "Container PID: $PID"

# æ£€æŸ¥è¿›ç¨‹æ˜¯å¦å­˜åœ¨
ps -p $PID -o pid,stat,wchan,comm
```

è¾“å‡ºç¤ºä¾‹ï¼š

```
  PID STAT WCHAN         COMMAND
12345 Ds   io_schedule   java
```

**STAT = Ds** è¡¨ç¤ºè¿›ç¨‹åœ¨ä¸å¯ä¸­æ–­ç¡çœ çŠ¶æ€ï¼ˆç­‰å¾… I/Oï¼‰ã€‚

**æ­¥éª¤ 3ï¼šä½¿ç”¨ nsenter ç»•è¿‡ Docker daemon**

```bash
# è¿›å…¥ mount + pid namespace
sudo nsenter -t $PID -m -p /bin/bash

# æˆ–è€…ä½¿ç”¨å®¿ä¸»æœºçš„ shell ç›´æ¥æ£€æŸ¥
sudo nsenter -t $PID -m cat /proc/1/status
```

**æ­¥éª¤ 4ï¼šæ£€æŸ¥è¿›ç¨‹æ‰“å¼€çš„æ–‡ä»¶æè¿°ç¬¦**

```bash
# æŸ¥çœ‹è¿›ç¨‹æ‰“å¼€çš„æ‰€æœ‰æ–‡ä»¶
sudo ls -la /proc/$PID/fd

# æŸ¥çœ‹åœ¨ç­‰å¾…ä»€ä¹ˆ
sudo cat /proc/$PID/wchan
```

**æ­¥éª¤ 5ï¼šæ£€æŸ¥è¿›ç¨‹å †æ ˆ**

```bash
# å†…æ ¸æ€å †æ ˆ
sudo cat /proc/$PID/stack
```

è¾“å‡ºç¤ºä¾‹ï¼š

```
[<ffffffff...>] io_schedule+0x...
[<ffffffff...>] wait_on_page_bit+0x...
[<ffffffff...>] __filemap_fdatawait_range+0x...
```

ç­‰å¾… I/O å®Œæˆ â€”â€” å¯èƒ½æ˜¯ç£ç›˜æˆ–ç½‘ç»œé—®é¢˜ã€‚

**æ­¥éª¤ 6ï¼šç›´æ¥è¯»å–å®¹å™¨å†…æ—¥å¿—**

```bash
# è·å–å®¹å™¨æ ¹ç›®å½•
MERGED=$(docker inspect --format '{{.GraphDriver.Data.MergedDir}}' <container>)

# ç›´æ¥è¯»å–æ—¥å¿—ï¼ˆç»•è¿‡ docker execï¼‰
sudo tail -100 $MERGED/var/log/app.log
```

**æ­¥éª¤ 7ï¼šç”Ÿæˆ Thread dumpï¼ˆJava å®¹å™¨ï¼‰**

```bash
# å‘é€ SIGQUIT ç”Ÿæˆ thread dump
sudo kill -3 $PID

# æŸ¥çœ‹ thread dumpï¼ˆé€šå¸¸è¾“å‡ºåˆ° stdoutï¼‰
docker logs <container> --tail 1000
```

---

## æ•…éšœæ’æŸ¥æ¸…å•

```markdown
# å®¹å™¨æ•…éšœæ’æŸ¥æ¸…å•

## å¯åŠ¨å¤±è´¥

- [ ] `docker logs <container>` - æŸ¥çœ‹å®¹å™¨æ—¥å¿—
- [ ] `docker inspect <container>` - æ£€æŸ¥å®¹å™¨çŠ¶æ€å’Œé…ç½®
- [ ] `dmesg | grep -i seccomp` - æ£€æŸ¥ seccomp æ˜¯å¦é˜»æ­¢ç³»ç»Ÿè°ƒç”¨
- [ ] `docker inspect <container> | jq '.[0].HostConfig.CapDrop'` - æ£€æŸ¥ capability é…ç½®
- [ ] æ£€æŸ¥é•œåƒæ˜¯å¦æ­£ç¡®ï¼š`docker image inspect <image>`

## è¿è¡Œæ—¶æ¶ˆå¤±ï¼ˆSilent Deathï¼‰

- [ ] `dmesg | grep -i oom` - æ£€æŸ¥ OOM Killï¼ˆ**æœ€é‡è¦ï¼**ï¼‰
- [ ] `cat /sys/fs/cgroup/<path>/memory.events` - æ£€æŸ¥ cgroup OOM ç»Ÿè®¡
- [ ] `cat /sys/fs/cgroup/<path>/pids.current` vs `pids.max` - æ£€æŸ¥è¿›ç¨‹æ•°é™åˆ¶
- [ ] `docker logs <container>` - æ£€æŸ¥æœ€åæ—¥å¿—
- [ ] `journalctl -k | grep -i oom` - å†…æ ¸æ—¥å¿—å¤‡ç”¨æ–¹æ³•

## ç½‘ç»œé—®é¢˜

- [ ] è·å– PIDï¼š`docker inspect --format '{{.State.Pid}}' <container>`
- [ ] æ£€æŸ¥ IP é…ç½®ï¼š`nsenter -t <PID> -n ip addr`
- [ ] æ£€æŸ¥è·¯ç”±ï¼š`nsenter -t <PID> -n ip route`
- [ ] æµ‹è¯•è¿é€šæ€§ï¼š`nsenter -t <PID> -n ping <target>`
- [ ] æ£€æŸ¥ DNSï¼š`nsenter -t <PID> -n cat /etc/resolv.conf`
- [ ] æŠ“åŒ…ï¼š`nsenter -t <PID> -n tcpdump -i eth0 -c 20`
- [ ] æ£€æŸ¥ veth pairï¼š`ip link | grep veth`
- [ ] æ£€æŸ¥ bridgeï¼š`ip link show type bridge`
- [ ] æ£€æŸ¥ NAT è§„åˆ™ï¼š`nft list ruleset | grep -A5 postrouting`

## å­˜å‚¨é—®é¢˜

- [ ] å®¿ä¸»æœºç£ç›˜ï¼š`df -h /var/lib/docker`
- [ ] Docker ç©ºé—´ä½¿ç”¨ï¼š`docker system df -v`
- [ ] å·²åˆ é™¤ä½†æ‰“å¼€çš„æ–‡ä»¶ï¼š`lsof +L1`
- [ ] OverlayFS upper å±‚ï¼š`du -sh $(docker inspect --format '{{.GraphDriver.Data.UpperDir}}' <container>)`
- [ ] è¿›å…¥ mount namespace æ£€æŸ¥ï¼š`nsenter -t <PID> -m du -sh /`
- [ ] æ¸…ç†æ‚¬ç©ºèµ„æºï¼š`docker system prune`

## è¿›ç¨‹å¡æ­»

- [ ] è¿›ç¨‹çŠ¶æ€ï¼š`ps -p <PID> -o pid,stat,wchan,comm`
- [ ] æ‰“å¼€çš„æ–‡ä»¶ï¼š`ls -la /proc/<PID>/fd`
- [ ] ç­‰å¾…ä»€ä¹ˆï¼š`cat /proc/<PID>/wchan`
- [ ] å†…æ ¸æ€å †æ ˆï¼š`cat /proc/<PID>/stack`
- [ ] ä½¿ç”¨ nsenter ç»•è¿‡ docker execï¼š`nsenter -t <PID> -m -p /bin/bash`
- [ ] ç›´æ¥è¯»å–æ—¥å¿—ï¼š`cat <MergedDir>/var/log/app.log`

## å®‰å…¨é—®é¢˜ï¼ˆseccomp/capabilitiesï¼‰

- [ ] seccomp æ‹’ç»ï¼š`dmesg | grep -i seccomp`
- [ ] audit æ—¥å¿—ï¼š`cat /var/log/audit/audit.log | grep denied`
- [ ] è§£ç  syscallï¼š`ausyscall <number>`
- [ ] æ£€æŸ¥ capabilitiesï¼š`docker inspect <container> | jq '.[0].HostConfig.CapAdd'`
```

---

## åŠ¨æ‰‹ç»ƒä¹ 

### Lab 1ï¼šOOM Kill è°ƒæŸ¥

**ç›®æ ‡**ï¼šå®Œæ•´è°ƒæŸ¥ä¸€æ¬¡ OOM Kill äº‹ä»¶ã€‚

```bash
cd ~/cloud-atlas/foundations/linux/lx11-containers/11-debugging-troubleshooting/code
sudo ./lab-oom-investigation.sh
```

**æ‰‹åŠ¨æ­¥éª¤**ï¼š

1. åˆ›å»º cgroup é™åˆ¶å†…å­˜ä¸º 64MB
2. è¿è¡Œ stress åˆ†é… 128MB
3. æ”¶é›† dmesgã€memory.events è¯æ®
4. ç¼–å†™éšœå®³å ±å‘Šæ›¸

### Lab 2ï¼šDistroless ç½‘ç»œè°ƒè¯•

**ç›®æ ‡**ï¼šä½¿ç”¨ nsenter è°ƒè¯•æ—  shell å®¹å™¨çš„ç½‘ç»œé—®é¢˜ã€‚

```bash
cd ~/cloud-atlas/foundations/linux/lx11-containers/11-debugging-troubleshooting/code
sudo ./lab-distroless-debug.sh
```

**æ‰‹åŠ¨æ­¥éª¤**ï¼š

1. å¯åŠ¨ä¸€ä¸ªå®¹å™¨
2. è·å– PID
3. ä½¿ç”¨ `nsenter -t <PID> -n` è¿›å…¥ç½‘ç»œç©ºé—´
4. æ‰§è¡Œ `ip addr`ã€`ping`ã€`tcpdump`

### Lab 3ï¼šç£ç›˜ç©ºé—´æ’æŸ¥

**ç›®æ ‡**ï¼šæ‰¾åˆ°ã€Œéšè—ã€çš„ç£ç›˜ç©ºé—´æ¶ˆè€—ã€‚

```bash
cd ~/cloud-atlas/foundations/linux/lx11-containers/11-debugging-troubleshooting/code
sudo ./lab-disk-mystery.sh
```

**æ‰‹åŠ¨æ­¥éª¤**ï¼š

1. è¿è¡Œ `docker system df`
2. æ£€æŸ¥ `lsof +L1`
3. æ£€æŸ¥ OverlayFS upper å±‚
4. ä½¿ç”¨ nsenter è¿›å…¥ mount namespace æ£€æŸ¥

### Lab 4ï¼šå¡æ­»è¿›ç¨‹è°ƒè¯•

**ç›®æ ‡**ï¼šç»•è¿‡ docker exec è°ƒè¯•å¡æ­»å®¹å™¨ã€‚

```bash
cd ~/cloud-atlas/foundations/linux/lx11-containers/11-debugging-troubleshooting/code
sudo ./lab-stuck-process.sh
```

**æ‰‹åŠ¨æ­¥éª¤**ï¼š

1. è·å–å®¹å™¨ PID
2. æ£€æŸ¥ `/proc/<PID>/status`
3. æ£€æŸ¥ `/proc/<PID>/stack`
4. ä½¿ç”¨ nsenter è¿›å…¥æ£€æŸ¥

---

## èŒåœºå°è´´å£«

### æ—¥æœ¬ IT ç°åœºå¸¸è§åœºæ™¯

**åœºæ™¯ 1ï¼šå¤œé–“ãƒãƒƒãƒéšœå®³å¯¾å¿œ**

```
çŠ¶æ³ï¼š
æœå‡ºç¤¾ã™ã‚‹ã¨ã€å¤œé–“ãƒãƒƒãƒãŒå¤±æ•—ã—ã¦ã„ãŸã€‚
ã‚¢ãƒ—ãƒªãƒ­ã‚°ã«ã¯ä½•ã‚‚è¨˜éŒ²ã•ã‚Œã¦ã„ãªã„ã€‚

ç¢ºèªæ‰‹é †ï¼š
1. dmesg | grep -i oom
2. cat /sys/fs/cgroup/<container>/memory.events
3. journalctl -k | grep -i oom

å ±å‘Šæ›¸ã«æ·»ä»˜ã™ã¹ãã‚‚ã®ï¼š
- dmesg ã®å‡ºåŠ›ï¼ˆã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ä»˜ãï¼‰
- memory.events ã®å†…å®¹
- memory.max ã®è¨­å®šå€¤
- æ¨å¥¨å¯¾ç­–ï¼ˆãƒ¡ãƒ¢ãƒªå¢—åŠ  or ã‚¢ãƒ—ãƒªæœ€é©åŒ–ï¼‰
```

**åœºæ™¯ 2ï¼šæœ¬ç•ªç’°å¢ƒã® distroless ã‚³ãƒ³ãƒ†ãƒŠãƒ‡ãƒãƒƒã‚°**

```
çŠ¶æ³ï¼š
æœ¬ç•ªç’°å¢ƒã® Go ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒ RDS ã«æ¥ç¶šã§ããªã„ã€‚
ã‚³ãƒ³ãƒ†ãƒŠã¯ distroless ã§ shell ãŒãªã„ã€‚

å¯¾å¿œï¼š
1. docker inspect ã§ã‚³ãƒ³ãƒ†ãƒŠ PID å–å¾—
2. nsenter -t <PID> -n ã§ Network NS ã«å…¥ã‚‹
3. å®¿ä¸»æ©Ÿã® ping, nc, tcpdump ã‚’ä½¿ç”¨
4. DNS è¨­å®šç¢ºèªï¼šnsenter -t <PID> -m cat /etc/resolv.conf

å ±å‘Šï¼š
ã€Œnsenter ã‚’ä½¿ç”¨ã—ã¦ã‚³ãƒ³ãƒ†ãƒŠ Network Namespace ã§ãƒ‡ãƒãƒƒã‚°ã—ã¾ã—ãŸã€‚
 DNS è¨­å®šã«å•é¡ŒãŒã‚ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã—ãŸã€‚ã€
```

**åœºæ™¯ 3ï¼šç›£è¦–ã‚¢ãƒ©ãƒ¼ãƒˆï¼šãƒ‡ã‚£ã‚¹ã‚¯ 100%**

```
çŠ¶æ³ï¼š
Zabbix ã‹ã‚‰ disk full ã‚¢ãƒ©ãƒ¼ãƒˆã€‚
ã‚³ãƒ³ãƒ†ãƒŠå†…ã§ du -sh / ã—ã¦ã‚‚å°ã•ã„ã€‚

ç¢ºèªæ‰‹é †ï¼š
1. df -h /var/lib/docker
2. docker system df -v
3. lsof +L1ï¼ˆå‰Šé™¤æ¸ˆã¿ã ãŒã‚ªãƒ¼ãƒ—ãƒ³ã•ã‚Œã¦ã„ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰
4. overlay2 ã® upper dir ã‚µã‚¤ã‚ºç¢ºèª

ã‚ˆãã‚ã‚‹åŸå› ï¼š
- ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã®ç„¡é™æˆé•·
- å‰Šé™¤ã•ã‚ŒãŸãŒã‚ªãƒ¼ãƒ—ãƒ³ã•ã‚Œã¦ã„ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«
- overlay å±¤ã¸ã®æ›¸ãè¾¼ã¿ï¼ˆvolume ã‚’ä½¿ã†ã¹ãï¼‰
```

### éšœå®³å¯¾å¿œã‚¹ã‚­ãƒ«ã®é‡è¦æ€§

```
æ—¥æœ¬ IT é‹ç”¨ç¾å ´ã§ã®è©•ä¾¡ãƒã‚¤ãƒ³ãƒˆï¼š

1. éšœå®³ã®åˆ‡ã‚Šåˆ†ã‘èƒ½åŠ›
   - å•é¡ŒãŒã©ã®å±¤ã«ã‚ã‚‹ã‹ç´ æ—©ãç‰¹å®šã§ãã‚‹
   - é©åˆ‡ãªè¨¼æ‹ ã‚’åé›†ã§ãã‚‹

2. å ±å‘Šæ›¸ã®å“è³ª
   - æŠ€è¡“çš„è¨¼æ‹ ã‚’æ·»ä»˜ã™ã‚‹
   - åŸå› ã¨å¯¾ç­–ã‚’æ˜ç¢ºã«è¨˜è¼‰
   - å†ç™ºé˜²æ­¢ç­–ã‚’ææ¡ˆ

3. ãƒ„ãƒ¼ãƒ«ã®ç¿’ç†Ÿåº¦
   - nsenter, dmesg, lsof ãªã©ã‚’ä½¿ã„ã“ãªã›ã‚‹
   - Docker/Kubernetes ã®å†…éƒ¨æ§‹é€ ã‚’ç†è§£

éšœå®³å¯¾å¿œãŒã§ãã‚‹ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã¯ã€
æ—¥æœ¬ IT æ¥­ç•Œã§é«˜ãè©•ä¾¡ã•ã‚Œã¾ã™ã€‚
```

---

## æ£€æŸ¥æ¸…å•

å®Œæˆæœ¬è¯¾åï¼Œä½ åº”è¯¥èƒ½å¤Ÿï¼š

- [ ] ä½¿ç”¨ 4 æ­¥å®šä½æ³•ï¼ˆç¢ºå®šå•é¡Œé¡å‹ â†’ åé›†è¨¼æ‹  â†’ éš”é›¢å•é¡Œå±¤ â†’ é©—è¨¼ä¿®å¾©ï¼‰
- [ ] å¾ `dmesg` å’Œ `memory.events` æ‰¾åˆ° OOM Kill è¯æ®
- [ ] ä½¿ç”¨ `nsenter -t <PID> -n` è°ƒè¯•æ—  shell å®¹å™¨çš„ç½‘ç»œ
- [ ] ä½¿ç”¨ `lsof +L1` æ‰¾åˆ°å·²åˆ é™¤ä½†ä»å ç”¨ç©ºé—´çš„æ–‡ä»¶
- [ ] æ£€æŸ¥ OverlayFS upper å±‚æ‰¾åˆ°å®¹å™¨ç£ç›˜æ¶ˆè€—
- [ ] ç»•è¿‡ docker exec ä½¿ç”¨ `nsenter` è°ƒè¯•å¡æ­»å®¹å™¨
- [ ] æ£€æŸ¥ `/proc/<PID>/stack` äº†è§£è¿›ç¨‹é˜»å¡åŸå› 
- [ ] ç†è§£ã€Œåªçœ‹å®¹å™¨æ—¥å¿—ï¼Œä¸çœ‹å®¿ä¸»æœº dmesgã€è¿™ä¸ªåæ¨¡å¼
- [ ] ç¼–å†™æ—¥æœ¬ IT ç°åœºçš„éšœå®³å ±å‘Šæ›¸
- [ ] æ•´åˆè¿ç”¨å‰ 10 è¯¾çŸ¥è¯†è§£å†³å¤æ‚é—®é¢˜

---

## å»¶ä¼¸é˜…è¯»

### å®˜æ–¹æ–‡æ¡£

- [Docker Troubleshooting](https://docs.docker.com/config/daemon/)
- [Linux cgroups v2 - Memory Controller](https://docs.kernel.org/admin-guide/cgroup-v2.html#memory)
- [nsenter(1) - Linux manual page](https://man7.org/linux/man-pages/man1/nsenter.1.html)

### ç›¸å…³è¯¾ç¨‹

- [Lesson 03 - Namespace æ·±å…¥](../03-namespace-deep-dive/) - nsenter åŸºç¡€
- [Lesson 06 - cgroups v2 èµ„æºæ§åˆ¶](../06-cgroups-v2-resource-control/) - OOM è°ƒæŸ¥åŸºç¡€
- [Lesson 07 - OverlayFS](../07-overlay-filesystems/) - å­˜å‚¨å±‚åŸç†
- [Lesson 08 - å®¹å™¨ç½‘ç»œ](../08-container-networking/) - ç½‘ç»œè°ƒè¯•åŸºç¡€
- [Lesson 12 - Capstone](../12-capstone/) - ç»¼åˆè¿ç”¨æ‰€æœ‰çŸ¥è¯†

### æ¨èé˜…è¯»

- *Container Security* by Liz Rice - å®¹å™¨å®‰å…¨ä¸è°ƒè¯•
- *Systems Performance* by Brendan Gregg - ç³»ç»Ÿæ€§èƒ½åˆ†æ
- [BPF Performance Tools](https://github.com/iovisor/bcc) - é«˜çº§è°ƒè¯•å·¥å…·

---

## ç³»åˆ—å¯¼èˆª

[<-- 10 - OCI è¿è¡Œæ—¶](../10-oci-runtimes/) | [Home](../) | [12 - Capstone -->](../12-capstone/)
