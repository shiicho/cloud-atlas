# 03 - Namespace æ·±å…¥ï¼šunshare ä¸ nsenter

> **ç›®æ ‡**ï¼šæŒæ¡ unshare å’Œ nsenter å‘½ä»¤ï¼Œå­¦ä¼šä»å®¿ä¸»æœºçº§åˆ«è°ƒè¯•å®¹å™¨  
> **å‰ç½®**ï¼šå®Œæˆ [02 - Linux Namespace åŸºç¡€](../02-namespace-overview/)  
> **æ—¶é—´**ï¼šâš¡ 40 åˆ†é’Ÿï¼ˆé€Ÿè¯»ï¼‰/ ğŸ”¬ 150 åˆ†é’Ÿï¼ˆå®Œæ•´å®æ“ï¼‰  
> **åœºæ™¯**ï¼šæœ¬ç•ªç’°å¢ƒã§ã®ã‚³ãƒ³ãƒ†ãƒŠéšœå®³å¯¾å¿œï¼ˆç”Ÿäº§ç¯å¢ƒå®¹å™¨æ•…éšœå¤„ç†ï¼‰  

---

## å°†å­¦åˆ°çš„å†…å®¹

1. ä½¿ç”¨ `unshare` åˆ›å»ºå„ç§ Namespace
2. ä½¿ç”¨ `nsenter` è¿›å…¥ç°æœ‰ Namespace
3. ç†è§£ PID/Mount/UTS/IPC Namespace çš„å…·ä½“éš”ç¦»æ•ˆæœ
4. æŒæ¡ä»å®¿ä¸»æœºè°ƒè¯•å®¹å™¨çš„å…³é”®æŠ€å·§
5. å­¦ä¼šç»•è¿‡ `docker exec` çš„é™åˆ¶è¿›è¡Œæ•…éšœæ’æŸ¥

---

## å…ˆè·‘èµ·æ¥ï¼ï¼ˆ5 åˆ†é’Ÿï¼‰

> åœ¨å­¦ä¹ ç†è®ºä¹‹å‰ï¼Œå…ˆä½“éªŒ Namespace éš”ç¦»çš„å¨åŠ›ã€‚  

```bash
# åˆ›å»ºä¸€ä¸ªéš”ç¦»çš„ PID Namespace
# åœ¨é‡Œé¢ï¼Œä½ çš„ shell æ˜¯ PID 1ï¼
sudo unshare --pid --fork --mount-proc /bin/bash

# æŸ¥çœ‹è¿›ç¨‹åˆ—è¡¨â€”â€”åªæœ‰ä½ è‡ªå·±ï¼
ps aux

# ä½ çš„ PID æ˜¯ä»€ä¹ˆï¼Ÿ
echo $$

# é€€å‡ºéš”ç¦»ç¯å¢ƒ
exit

# å›åˆ°å®¿ä¸»æœºï¼ŒéªŒè¯ä½ çœ‹åˆ°çš„åªæ˜¯"å¹»è§‰"
ps aux | head -5
```

**ä½ åˆšåˆšä½“éªŒäº†ä»€ä¹ˆï¼Ÿ**

- åœ¨ `unshare` åˆ›å»ºçš„ç¯å¢ƒä¸­ï¼Œ`ps aux` åªæ˜¾ç¤ºä¸¤ä¸ªè¿›ç¨‹
- ä½ çš„ shell è¿›ç¨‹ PID æ˜¯ 1ï¼
- ä½†åœ¨å®¿ä¸»æœºä¸Šï¼Œè¿™åªæ˜¯ä¸€ä¸ªæ™®é€šè¿›ç¨‹

**è¿™å°±æ˜¯å®¹å™¨éš”ç¦»çš„æ ¸å¿ƒåŸç†ã€‚** ç°åœ¨è®©æˆ‘ä»¬æ·±å…¥ç†è§£ã€‚

---

## Step 1 - ç†è§£ unshare å‘½ä»¤ï¼ˆ20 åˆ†é’Ÿï¼‰

### 1.1 ä»€ä¹ˆæ˜¯ unshareï¼Ÿ

`unshare` æ˜¯ Linux åˆ›å»ºæ–° Namespace çš„å·¥å…·ã€‚å®ƒè®©è¿›ç¨‹"è„±ç¦»"çˆ¶è¿›ç¨‹çš„ Namespaceï¼Œè¿›å…¥ç‹¬ç«‹çš„éš”ç¦»ç¯å¢ƒã€‚

```bash
# æŸ¥çœ‹ unshare å¸®åŠ©
unshare --help
```

**å¸¸ç”¨é€‰é¡¹ï¼š**

| é€‰é¡¹ | å«ä¹‰ | åˆ›å»ºçš„ Namespace |
|------|------|------------------|
| `--pid` | è¿›ç¨‹éš”ç¦» | PID Namespace |
| `--mount` | æŒ‚è½½éš”ç¦» | Mount Namespace |
| `--net` | ç½‘ç»œéš”ç¦» | Network Namespace |
| `--uts` | ä¸»æœºåéš”ç¦» | UTS Namespace |
| `--ipc` | IPC éš”ç¦» | IPC Namespace |
| `--user` | ç”¨æˆ·éš”ç¦» | User Namespace |
| `--cgroup` | cgroup éš”ç¦» | Cgroup Namespace |

### 1.2 å…³é”®æ ‡å¿—ï¼š--fork å’Œ --mount-proc

åˆ›å»º PID Namespace æ—¶ï¼Œæœ‰ä¸¤ä¸ªé‡è¦æ ‡å¿—ï¼š

```
ä¸ºä»€ä¹ˆéœ€è¦ --forkï¼Ÿ

æ²¡æœ‰ --fork:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å®¿ä¸»æœº PID Namespace                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  unshare è¿›ç¨‹ (PID 12345)                        â”‚    â”‚
â”‚  â”‚     â””â”€â”€â–¶ åˆ›å»ºæ–° PID Namespace                    â”‚    â”‚
â”‚  â”‚                                                  â”‚    â”‚
â”‚  â”‚  é—®é¢˜ï¼šunshare è‡ªå·±åœ¨æ—§ Namespace ä¸­ï¼            â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æœ‰ --fork:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å®¿ä¸»æœº PID Namespace                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  unshare è¿›ç¨‹ (PID 12345)                        â”‚    â”‚
â”‚  â”‚     â””â”€â”€â–¶ fork() åˆ›å»ºå­è¿›ç¨‹                       â”‚    â”‚
â”‚  â”‚              â”‚                                   â”‚    â”‚
â”‚  â”‚              â–¼                                   â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚    â”‚
â”‚  â”‚  â”‚  æ–° PID Namespace                  â”‚          â”‚    â”‚
â”‚  â”‚  â”‚  å­è¿›ç¨‹ (PID 1 åœ¨æ–° NS ä¸­)         â”‚          â”‚    â”‚
â”‚  â”‚  â”‚  â””â”€â”€â–¶ exec /bin/bash              â”‚          â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

```
ä¸ºä»€ä¹ˆéœ€è¦ --mount-procï¼Ÿ

/proc æ˜¯è¿›ç¨‹ä¿¡æ¯çš„æ¥æºï¼š
  /proc/1/   â†’ PID 1 çš„ä¿¡æ¯
  /proc/2/   â†’ PID 2 çš„ä¿¡æ¯
  ...

æ²¡æœ‰é‡æ–°æŒ‚è½½ /procï¼š
  ps aux è¯»å–å®¿ä¸»æœºçš„ /proc
  â†’ æ˜¾ç¤ºå®¿ä¸»æœºçš„æ‰€æœ‰è¿›ç¨‹

ä½¿ç”¨ --mount-procï¼š
  åœ¨æ–° Namespace ä¸­é‡æ–°æŒ‚è½½ /proc
  â†’ ps aux åªæ˜¾ç¤ºæ–° Namespace çš„è¿›ç¨‹
```

### 1.3 åŠ¨æ‰‹å®éªŒï¼šPID Namespace

```bash
# å®éªŒ 1ï¼šæ²¡æœ‰ --fork çš„é—®é¢˜
sudo unshare --pid /bin/bash
echo $$  # ä¸æ˜¯ 1ï¼
ps aux   # çœ‹åˆ°æ‰€æœ‰è¿›ç¨‹
exit

# å®éªŒ 2ï¼šæ­£ç¡®ä½¿ç”¨ --fork
sudo unshare --pid --fork /bin/bash
echo $$  # è¿˜æ˜¯ä¸æ˜¯ 1ï¼Œå› ä¸º /proc æ²¡æ›´æ–°
ps aux   # çœ‹åˆ°æ‰€æœ‰è¿›ç¨‹ï¼ˆè¯»çš„æ˜¯å®¿ä¸»æœº /procï¼‰
exit

# å®éªŒ 3ï¼šå®Œæ•´çš„éš”ç¦»ï¼ˆæ¨èæ–¹å¼ï¼‰
sudo unshare --pid --fork --mount-proc /bin/bash
echo $$  # æ˜¯ 1ï¼
ps aux   # åªçœ‹åˆ°å½“å‰ Namespace çš„è¿›ç¨‹
exit
```

---

## Step 2 - å„ç§ Namespace å®è·µï¼ˆ30 åˆ†é’Ÿï¼‰

### 2.1 PID Namespace æ·±å…¥å®éªŒ

```bash
# ç»ˆç«¯ 1ï¼šåˆ›å»ºéš”ç¦»ç¯å¢ƒ
sudo unshare --pid --fork --mount-proc /bin/bash

# åœ¨éš”ç¦»ç¯å¢ƒä¸­
echo "æˆ‘æ˜¯ PID: $$"
sleep 3600 &
ps aux
```

```bash
# ç»ˆç«¯ 2ï¼šä»å®¿ä¸»æœºè§‚å¯Ÿ
# æ‰¾åˆ°åˆšæ‰çš„ bash è¿›ç¨‹
ps aux | grep "unshare\|sleep 3600"

# ä½ ä¼šçœ‹åˆ°ç±»ä¼¼ï¼š
# root      12345  ... unshare --pid --fork --mount-proc /bin/bash
# root      12346  ... /bin/bash
# root      12347  ... sleep 3600

# éš”ç¦»ç¯å¢ƒä¸­çš„ "PID 1" åœ¨å®¿ä¸»æœºæ˜¯ PID 12346
# éš”ç¦»ç¯å¢ƒä¸­çš„ "PID 2" åœ¨å®¿ä¸»æœºæ˜¯ PID 12347
```

**å…³é”®æ´å¯Ÿ**ï¼šçˆ¶ Namespace èƒ½çœ‹åˆ°å­ Namespace çš„æ‰€æœ‰è¿›ç¨‹ï¼Œä½†å­ Namespace çœ‹ä¸åˆ°çˆ¶ Namespace çš„è¿›ç¨‹ã€‚

### 2.2 Mount Namespace å®éªŒ

Mount Namespace è®©ä½ æ‹¥æœ‰ç‹¬ç«‹çš„æŒ‚è½½ç‚¹è§†å›¾ã€‚

```bash
# åˆ›å»º Mount Namespace
sudo unshare --mount /bin/bash

# åˆ›å»ºä¸´æ—¶ç›®å½•å¹¶æŒ‚è½½
mkdir -p /tmp/myroot
mount -t tmpfs none /tmp/myroot
echo "secret data" > /tmp/myroot/secret.txt

# éªŒè¯æŒ‚è½½å­˜åœ¨
mount | grep myroot
cat /tmp/myroot/secret.txt

# é€€å‡º
exit

# åœ¨å®¿ä¸»æœºéªŒè¯
mount | grep myroot  # æ²¡æœ‰ï¼
ls /tmp/myroot/      # ç›®å½•å­˜åœ¨ä½†æ˜¯ç©ºçš„
```

**ä¸ºä»€ä¹ˆï¼Ÿ** Mount Namespace ä¸­çš„æŒ‚è½½æ˜¯ç§æœ‰çš„ï¼Œé€€å‡ºåè‡ªåŠ¨å¸è½½ã€‚

### 2.3 UTS Namespace å®éªŒ

UTS Namespace éš”ç¦»ä¸»æœºåã€‚

```bash
# åˆ›å»º UTS Namespace
sudo unshare --uts /bin/bash

# æŸ¥çœ‹åŸä¸»æœºå
hostname

# ä¿®æ”¹ä¸»æœºå
hostname container-001

# éªŒè¯ä¿®æ”¹
hostname

# é€€å‡º
exit

# å®¿ä¸»æœºä¸»æœºåæœªå˜
hostname
```

**ç”¨é€”**ï¼šæ¯ä¸ªå®¹å™¨å¯ä»¥æœ‰è‡ªå·±çš„ä¸»æœºåï¼Œäº’ä¸å½±å“ã€‚

### 2.4 IPC Namespace å®éªŒ

IPC Namespace éš”ç¦»è¿›ç¨‹é—´é€šä¿¡ï¼ˆå…±äº«å†…å­˜ã€ä¿¡å·é‡ã€æ¶ˆæ¯é˜Ÿåˆ—ï¼‰ã€‚

```bash
# æŸ¥çœ‹å½“å‰ IPC èµ„æº
ipcs

# åˆ›å»º IPC Namespace
sudo unshare --ipc /bin/bash

# åœ¨æ–° Namespace ä¸­æŸ¥çœ‹ IPC
ipcs  # åº”è¯¥æ˜¯ç©ºçš„ï¼ˆæ²¡æœ‰ç»§æ‰¿å®¿ä¸»æœºçš„ IPC èµ„æºï¼‰

# åˆ›å»ºä¸€ä¸ªå…±äº«å†…å­˜æ®µ
ipcmk -M 1024

# éªŒè¯åˆ›å»º
ipcs

# é€€å‡º
exit

# å®¿ä¸»æœºçœ‹ä¸åˆ°åˆšæ‰åˆ›å»ºçš„å…±äº«å†…å­˜
ipcs
```

### 2.5 ç»„åˆå¤šä¸ª Namespace

å®¹å™¨é€šå¸¸åŒæ—¶ä½¿ç”¨å¤šä¸ª Namespaceï¼š

```bash
# æ¨¡æ‹Ÿå®¹å™¨ç¯å¢ƒï¼ˆå¤šä¸ª Namespace ç»„åˆï¼‰
sudo unshare --pid --fork --mount-proc --uts --ipc --mount /bin/bash

# éªŒè¯éš”ç¦»
hostname mycontainer    # ä¿®æ”¹ä¸»æœºå
hostname                # mycontainer
ps aux                  # åªæœ‰ Namespace å†…çš„è¿›ç¨‹
ipcs                    # ç‹¬ç«‹çš„ IPC

exit
```

---

## Step 3 - nsenterï¼šè¿›å…¥ç°æœ‰ Namespaceï¼ˆ30 åˆ†é’Ÿï¼‰

### 3.1 ä»€ä¹ˆæ˜¯ nsenterï¼Ÿ

`nsenter` è®©ä½ è¿›å…¥ä¸€ä¸ª**å·²å­˜åœ¨**çš„ Namespaceã€‚è¿™æ˜¯å®¹å™¨è°ƒè¯•çš„æ ¸å¿ƒå·¥å…·ã€‚

```
nsenter å·¥ä½œåŸç†ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å®¿ä¸»æœº                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  ä½ çš„ Shell (PID 1234)                               â”‚  â”‚
â”‚  â”‚                                                      â”‚  â”‚
â”‚  â”‚  nsenter -t 5678 -n                                  â”‚  â”‚
â”‚  â”‚       â”‚                                              â”‚  â”‚
â”‚  â”‚       â–¼                                              â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚
â”‚  â”‚  â”‚  å®¹å™¨è¿›ç¨‹ (PID 5678)                          â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  Network Namespace: inode 4026532456          â”‚   â”‚  â”‚
â”‚  â”‚  â”‚                                               â”‚   â”‚  â”‚
â”‚  â”‚  â”‚    â† nsenter è¿›å…¥è¿™ä¸ª Network Namespace       â”‚   â”‚  â”‚
â”‚  â”‚  â”‚    â† æ‰§è¡Œå‘½ä»¤ï¼ˆå¦‚ ip addrï¼‰                   â”‚   â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 nsenter é€‰é¡¹

| é€‰é¡¹ | å«ä¹‰ | ç”¨é€” |
|------|------|------|
| `-t PID` | ç›®æ ‡è¿›ç¨‹ PID | æŒ‡å®šè¦è¿›å…¥çš„ Namespace æ‰€å±è¿›ç¨‹ |
| `-n` | Network | è¿›å…¥ç½‘ç»œ Namespace |
| `-m` | Mount | è¿›å…¥æŒ‚è½½ Namespace |
| `-p` | PID | è¿›å…¥ PID Namespace |
| `-u` | UTS | è¿›å…¥ UTS Namespace |
| `-i` | IPC | è¿›å…¥ IPC Namespace |
| `-U` | User | è¿›å…¥ç”¨æˆ· Namespace |
| `-a` | All | è¿›å…¥æ‰€æœ‰ Namespace |

### 3.3 åŠ¨æ‰‹å®éªŒï¼šä½¿ç”¨ nsenter è°ƒè¯•å®¹å™¨

é¦–å…ˆï¼Œå¯åŠ¨ä¸€ä¸ªå®¹å™¨ï¼ˆå¦‚æœæ²¡æœ‰ Dockerï¼Œè·³åˆ° 3.4 ä½¿ç”¨ unshare æ›¿ä»£ï¼‰ï¼š

```bash
# å¯åŠ¨ä¸€ä¸ª nginx å®¹å™¨
docker run -d --name test-nginx nginx

# è·å–å®¹å™¨çš„ PID
PID=$(docker inspect --format '{{.State.Pid}}' test-nginx)
echo "å®¹å™¨ PID: $PID"
```

**åœºæ™¯ 1ï¼šè°ƒè¯•å®¹å™¨ç½‘ç»œ**

```bash
# åªè¿›å…¥ Network Namespace
sudo nsenter -t $PID -n ip addr

# æµ‹è¯•å®¹å™¨ç½‘ç»œè¿é€šæ€§
sudo nsenter -t $PID -n ping -c 3 8.8.8.8

# æŸ¥çœ‹å®¹å™¨è·¯ç”±è¡¨
sudo nsenter -t $PID -n ip route

# æŸ¥çœ‹å®¹å™¨ DNS é…ç½®
sudo nsenter -t $PID -n cat /etc/resolv.conf
```

**åœºæ™¯ 2ï¼šè°ƒè¯•å®¹å™¨æ–‡ä»¶ç³»ç»Ÿ**

```bash
# è¿›å…¥ Mount Namespace
sudo nsenter -t $PID -m ls /

# æŸ¥çœ‹ nginx é…ç½®
sudo nsenter -t $PID -m cat /etc/nginx/nginx.conf

# æŸ¥çœ‹å®¹å™¨å†…è¿›ç¨‹æ‰“å¼€çš„æ–‡ä»¶
sudo nsenter -t $PID -m -p ls -la /proc/1/fd
```

**åœºæ™¯ 3ï¼šå®Œæ•´è¿›å…¥å®¹å™¨**

```bash
# è¿›å…¥æ‰€æœ‰ Namespace
sudo nsenter -t $PID -a /bin/bash

# ç°åœ¨ä½ å°±åƒåœ¨å®¹å™¨å†…éƒ¨ä¸€æ ·
hostname
ps aux
ip addr
exit
```

æ¸…ç†ï¼š

```bash
docker stop test-nginx && docker rm test-nginx
```

### 3.4 æ—  Docker æ›¿ä»£å®éªŒ

å¦‚æœæ²¡æœ‰ Dockerï¼Œå¯ä»¥ç”¨ `unshare` åˆ›å»ºç›®æ ‡è¿›ç¨‹ï¼š

```bash
# ç»ˆç«¯ 1ï¼šåˆ›å»ºä¸€ä¸ªé•¿æœŸè¿è¡Œçš„éš”ç¦»è¿›ç¨‹
sudo unshare --pid --fork --mount-proc --net --uts /bin/bash -c "
hostname isolated-container
sleep 3600
"
```

```bash
# ç»ˆç«¯ 2ï¼šæ‰¾åˆ°è¿›ç¨‹å¹¶ä½¿ç”¨ nsenter
# æ‰¾åˆ° sleep è¿›ç¨‹çš„ PID
PID=$(pgrep -f "sleep 3600" | head -1)
echo "ç›®æ ‡ PID: $PID"

# è¿›å…¥ UTS Namespace æŸ¥çœ‹ä¸»æœºå
sudo nsenter -t $PID -u hostname

# è¿›å…¥ Network Namespace
sudo nsenter -t $PID -n ip addr

# è¿›å…¥ PID Namespaceï¼ˆéœ€è¦åŒæ—¶è¿›å…¥ Mount æ‰èƒ½çœ‹åˆ°æ­£ç¡®çš„ /procï¼‰
sudo nsenter -t $PID -p -m ps aux
```

---

## Step 4 - nsenter è°ƒè¯•æ¨¡å¼ï¼šç»•è¿‡ docker execï¼ˆ30 åˆ†é’Ÿï¼‰

### 4.1 ä¸ºä»€ä¹ˆéœ€è¦ nsenterï¼Ÿ

åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œ`docker exec` å¯èƒ½ä¸å¯ç”¨ï¼š

| åœºæ™¯ | é—®é¢˜ | nsenter ä¼˜åŠ¿ |
|------|------|-------------|
| Distroless é•œåƒ | æ—  shellã€æ— å·¥å…· | ä½¿ç”¨å®¿ä¸»æœºå·¥å…·è°ƒè¯•å®¹å™¨ç½‘ç»œ |
| docker exec å¡æ­» | daemon é—®é¢˜ | ç»•è¿‡ Docker daemon ç›´æ¥æ“ä½œ |
| æœ€å°æƒé™ç­–ç•¥ | ç¦æ­¢ docker exec | nsenter åªéœ€ root æƒé™ |
| CRI-O/containerd | ä¸åŒå·¥å…·é›† | nsenter é€šç”¨äºæ‰€æœ‰è¿è¡Œæ—¶ |

### 4.2 Distroless å®¹å™¨è°ƒè¯•æ¨¡å¼

**åœºæ™¯**ï¼šGo åº”ç”¨éƒ¨ç½²åœ¨ distroless é•œåƒä¸­ï¼Œæ— æ³•è¿æ¥æ•°æ®åº“ï¼Œéœ€è¦è°ƒè¯•ç½‘ç»œã€‚

```
Distroless é•œåƒç‰¹ç‚¹ï¼š
- æ—  shellï¼ˆ/bin/sh, /bin/bashï¼‰
- æ— è°ƒè¯•å·¥å…·ï¼ˆcurl, ping, ncï¼‰
- åªæœ‰åº”ç”¨äºŒè¿›åˆ¶æ–‡ä»¶

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Distroless Container                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                                                   â”‚  â”‚
â”‚  â”‚   /app/myapp  â† åªæœ‰è¿™ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶               â”‚  â”‚
â”‚  â”‚                                                   â”‚  â”‚
â”‚  â”‚   âŒ æ—  /bin/sh                                  â”‚  â”‚
â”‚  â”‚   âŒ æ—  curl, ping, nc                           â”‚  â”‚
â”‚  â”‚   âŒ docker exec æ— æ³•è¿›å…¥                        â”‚  â”‚
â”‚  â”‚                                                   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                         â”‚
â”‚  nsenter -t <PID> -n â† ä½¿ç”¨å®¿ä¸»æœºå·¥å…·è°ƒè¯•å®¹å™¨ç½‘ç»œ      â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**è°ƒè¯•æ­¥éª¤**ï¼š

```bash
# 1. æ‰¾åˆ°å®¹å™¨ PID
# Docker
PID=$(docker inspect --format '{{.State.Pid}}' <container>)

# containerd (crictl)
# PID=$(crictl inspect <container-id> | jq '.info.pid')

# 2. åªè¿›å…¥ Network Namespace è°ƒè¯•
# ä½¿ç”¨å®¿ä¸»æœºçš„ ping æµ‹è¯•è¿é€šæ€§
sudo nsenter -t $PID -n ping -c 3 database.internal

# ä½¿ç”¨å®¿ä¸»æœºçš„ curl æµ‹è¯• HTTP
sudo nsenter -t $PID -n curl -v http://api.internal:8080/health

# ä½¿ç”¨å®¿ä¸»æœºçš„ dig/nslookup æµ‹è¯• DNS
sudo nsenter -t $PID -n dig database.internal

# ä½¿ç”¨å®¿ä¸»æœºçš„ ss æŸ¥çœ‹è¿æ¥çŠ¶æ€
sudo nsenter -t $PID -n ss -tuln

# ä½¿ç”¨å®¿ä¸»æœºçš„ tcpdump æŠ“åŒ…
sudo nsenter -t $PID -n tcpdump -i eth0 -n port 5432
```

### 4.3 æ ‡å‡†è°ƒè¯•æ¨¡å¼æ¨¡æ¿

**nsenter-debug.sh**ï¼ˆå‚è€ƒ code/ ç›®å½•ï¼‰

```bash
#!/bin/bash
# nsenter è°ƒè¯•æ¨¡å¼æ¨¡æ¿

if [ -z "$1" ]; then
    echo "ç”¨æ³•: $0 <container-name-or-pid>"
    exit 1
fi

# è‡ªåŠ¨æ£€æµ‹ PID
if [[ "$1" =~ ^[0-9]+$ ]]; then
    PID=$1
elif command -v docker &>/dev/null; then
    PID=$(docker inspect --format '{{.State.Pid}}' "$1" 2>/dev/null)
elif command -v crictl &>/dev/null; then
    PID=$(crictl inspect "$1" 2>/dev/null | jq -r '.info.pid')
fi

if [ -z "$PID" ] || [ "$PID" = "null" ]; then
    echo "é”™è¯¯ï¼šæ— æ³•è·å– PID"
    exit 1
fi

echo "========================================"
echo "  nsenter è°ƒè¯•æ¨¡å¼"
echo "  ç›®æ ‡ PID: $PID"
echo "========================================"
echo ""

echo "ã€1. ç½‘ç»œè°ƒè¯•ã€‘"
echo "$ nsenter -t $PID -n ip addr"
sudo nsenter -t "$PID" -n ip addr
echo ""

echo "$ nsenter -t $PID -n ip route"
sudo nsenter -t "$PID" -n ip route
echo ""

echo "$ nsenter -t $PID -n ss -tuln"
sudo nsenter -t "$PID" -n ss -tuln
echo ""

echo "ã€2. è¿›ç¨‹è°ƒè¯•ã€‘"
echo "$ nsenter -t $PID -p -m ps aux"
sudo nsenter -t "$PID" -p -m ps aux 2>/dev/null || echo "éœ€è¦ --mount-proc æˆ–æ— æ³•è®¿é—®"
echo ""

echo "ã€3. æ–‡ä»¶ç³»ç»Ÿè°ƒè¯•ã€‘"
echo "$ nsenter -t $PID -m ls /"
sudo nsenter -t "$PID" -m ls /
echo ""

echo "ã€4. è¿›å…¥å®Œæ•´è°ƒè¯• shellã€‘"
echo "$ nsenter -t $PID -a /bin/bash"
echo "ï¼ˆè¿è¡Œ 'sudo nsenter -t $PID -a /bin/bash' è¿›å…¥ï¼‰"
```

### 4.4 é€‰æ‹©æ€§è¿›å…¥ Namespace çš„åœºæ™¯

| åœºæ™¯ | å‘½ä»¤ | è¯´æ˜ |
|------|------|------|
| ç½‘ç»œè°ƒè¯• | `nsenter -t PID -n` | åªè¿›å…¥ç½‘ç»œ NSï¼Œä½¿ç”¨å®¿ä¸»æœºå·¥å…· |
| æ–‡ä»¶æ£€æŸ¥ | `nsenter -t PID -m` | åªè¿›å…¥æŒ‚è½½ NSï¼ŒæŸ¥çœ‹å®¹å™¨æ–‡ä»¶ |
| è¿›ç¨‹è°ƒè¯• | `nsenter -t PID -m -p` | è¿›å…¥æŒ‚è½½+PID NS |
| å®Œæ•´è¿›å…¥ | `nsenter -t PID -a` | è¿›å…¥æ‰€æœ‰ NS |

---

## Step 5 - ç”Ÿäº§åœºæ™¯å®æˆ˜ï¼ˆ20 åˆ†é’Ÿï¼‰

### 5.1 åœºæ™¯ï¼šå¡æ­»çš„å®¹å™¨è¿›ç¨‹

**é—®é¢˜**ï¼šJava å®¹å™¨åƒµæ­»ï¼Œ`docker exec` æŒ‚èµ·æ— å“åº”ã€‚

```bash
# 1. æ‰¾åˆ°å®¹å™¨ PIDï¼ˆç»•è¿‡ Docker daemonï¼‰
PID=$(cat /proc/$(pgrep -f "docker-containerd-shim")/task/*/children | head -1)

# æˆ–è€…ç›´æ¥ä» /proc æŸ¥æ‰¾
ps aux | grep java  # æ‰¾åˆ° Java è¿›ç¨‹ PID

# 2. è¿›å…¥ Mount + PID Namespace è°ƒè¯•
sudo nsenter -t $PID -m -p /bin/bash

# 3. æ£€æŸ¥è¿›ç¨‹çŠ¶æ€
cat /proc/1/status | grep State

# 4. æ£€æŸ¥æ–‡ä»¶æè¿°ç¬¦ï¼ˆæ‰¾é˜»å¡ç‚¹ï¼‰
ls -la /proc/1/fd

# 5. æ£€æŸ¥è°ƒç”¨æ ˆ
cat /proc/1/stack  # å†…æ ¸æ ˆ
```

### 5.2 åœºæ™¯ï¼šæ£€æŸ¥å®¹å™¨ Namespace ä¿¡æ¯

```bash
# æŸ¥çœ‹è¿›ç¨‹çš„æ‰€æœ‰ Namespace
ls -la /proc/$PID/ns/

# è¾“å‡ºç¤ºä¾‹ï¼š
# lrwxrwxrwx 1 root root 0 Jan  4 12:00 cgroup -> 'cgroup:[4026531835]'
# lrwxrwxrwx 1 root root 0 Jan  4 12:00 ipc -> 'ipc:[4026532456]'
# lrwxrwxrwx 1 root root 0 Jan  4 12:00 mnt -> 'mnt:[4026532454]'
# lrwxrwxrwx 1 root root 0 Jan  4 12:00 net -> 'net:[4026532459]'
# lrwxrwxrwx 1 root root 0 Jan  4 12:00 pid -> 'pid:[4026532457]'
# lrwxrwxrwx 1 root root 0 Jan  4 12:00 user -> 'user:[4026531837]'
# lrwxrwxrwx 1 root root 0 Jan  4 12:00 uts -> 'uts:[4026532455]'

# æ¯”è¾ƒä¸¤ä¸ªè¿›ç¨‹æ˜¯å¦åœ¨åŒä¸€ Namespace
ls -la /proc/$PID1/ns/net
ls -la /proc/$PID2/ns/net
# inode ç›¸åŒ = åŒä¸€ Namespace
```

### 5.3 åœºæ™¯ï¼šä½¿ç”¨ lsns æŸ¥çœ‹ç³»ç»Ÿ Namespace

```bash
# åˆ—å‡ºæ‰€æœ‰ Namespace
sudo lsns

# æŒ‰ç±»å‹è¿‡æ»¤
sudo lsns -t net  # åªçœ‹ Network Namespace
sudo lsns -t pid  # åªçœ‹ PID Namespace

# æŸ¥çœ‹ç‰¹å®šè¿›ç¨‹çš„ Namespace
sudo lsns -p $PID
```

---

## èŒåœºå°è´´å£«ï¼ˆJapan IT Contextï¼‰

### æœ¬ç•ªç’°å¢ƒã§ã®ã‚³ãƒ³ãƒ†ãƒŠéšœå®³å¯¾å¿œ

åœ¨æ—¥æœ¬ä¼ä¸šçš„ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œ`docker exec` ç»å¸¸ä¸å¯ç”¨ï¼š

| åœºæ™¯ | æ—¥è¯­æœ¯è¯­ | nsenter è§£å†³æ–¹æ¡ˆ |
|------|----------|------------------|
| Distroless é•œåƒ | è»½é‡ã‚¤ãƒ¡ãƒ¼ã‚¸ | `nsenter -n` ç”¨å®¿ä¸»æœºå·¥å…· |
| ç¦æ­¢ docker exec | ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒãƒªã‚·ãƒ¼ | nsenter ç»•è¿‡ daemon |
| docker daemon å¼‚å¸¸ | Docker éšœå®³ | nsenter ç›´æ¥æ“ä½œ Namespace |
| Kubernetes CRI-O | K8s ç’°å¢ƒ | nsenter é€šç”¨äºæ‰€æœ‰è¿è¡Œæ—¶ |

### éšœå®³å¯¾å¿œã®åŸºæœ¬ãƒ•ãƒ­ãƒ¼

```
ã‚³ãƒ³ãƒ†ãƒŠéšœå®³å¯¾å¿œã®æ‰‹é †ï¼š

1. docker inspect ã§ PID å–å¾—
   â†’ å–å¾—ã§ããªã„å ´åˆï¼šps aux | grep <app>

2. nsenter -t <PID> -n ã§ç½‘ç»œè°ƒè¯•
   â†’ ping, curl, dig ã§æ¥ç¶šç¢ºèª

3. nsenter -t <PID> -m ã§æ–‡ä»¶ç³»ç»Ÿæ£€æŸ¥
   â†’ ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã€è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª

4. nsenter -t <PID> -m -p ã§è¿›ç¨‹è°ƒè¯•
   â†’ ps aux, /proc/<PID>/fd ç¢ºèª

5. è¨¼æ‹ ã‚’å ±å‘Šæ›¸ã«æ·»ä»˜
   â†’ ã‚³ãƒãƒ³ãƒ‰å‡ºåŠ›ã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ
```

### å¸¸è§æ—¥è¯­æœ¯è¯­

| æ—¥è¯­ | è¯»éŸ³ | å«ä¹‰ |
|------|------|------|
| åå‰ç©ºé–“ | ãªã¾ãˆãã†ã‹ã‚“ | Namespace |
| åˆ†é›¢ | ã¶ã‚“ã‚Š | Isolation |
| ãƒ‡ãƒãƒƒã‚° | ãƒ‡ãƒãƒƒã‚° | Debug |
| ã‚³ãƒ³ãƒ†ãƒŠå†… | ã‚³ãƒ³ãƒ†ãƒŠãªã„ | Inside container |
| ãƒ›ã‚¹ãƒˆå´ | ãƒ›ã‚¹ãƒˆãŒã‚ | Host side |

---

## æ£€æŸ¥æ¸…å•

å®Œæˆæœ¬è¯¾åï¼Œä½ åº”è¯¥èƒ½å¤Ÿï¼š

- [ ] ä½¿ç”¨ `unshare --pid --fork --mount-proc` åˆ›å»º PID Namespace
- [ ] è§£é‡Šä¸ºä»€ä¹ˆéœ€è¦ `--fork` å’Œ `--mount-proc` æ ‡å¿—
- [ ] ä½¿ç”¨ `unshare --mount` åˆ›å»ºç‹¬ç«‹æŒ‚è½½ç¯å¢ƒ
- [ ] ä½¿ç”¨ `unshare --uts` åˆ›å»ºç‹¬ç«‹ä¸»æœºåç¯å¢ƒ
- [ ] ä½¿ç”¨ `nsenter -t PID -n` è¿›å…¥å®¹å™¨ç½‘ç»œè°ƒè¯•
- [ ] ä½¿ç”¨ `nsenter -t PID -m` è¿›å…¥å®¹å™¨æ–‡ä»¶ç³»ç»Ÿ
- [ ] ä½¿ç”¨ `nsenter -t PID -a` å®Œæ•´è¿›å…¥å®¹å™¨
- [ ] è·å–å®¹å™¨è¿›ç¨‹ PIDï¼ˆdocker inspect æˆ– ps auxï¼‰
- [ ] ç»•è¿‡ docker exec è°ƒè¯• Distroless å®¹å™¨
- [ ] ä½¿ç”¨ lsns æŸ¥çœ‹ç³»ç»Ÿ Namespace

---

## æœ¬è¯¾å°ç»“

| æ¦‚å¿µ | è¦ç‚¹ |
|------|------|
| unshare | åˆ›å»ºæ–° Namespaceï¼Œè„±ç¦»çˆ¶è¿›ç¨‹çš„éš”ç¦»è¾¹ç•Œ |
| --fork | PID Namespace éœ€è¦ fork å­è¿›ç¨‹æˆä¸º PID 1 |
| --mount-proc | é‡æ–°æŒ‚è½½ /proc ä»¥æ­£ç¡®æ˜¾ç¤ºéš”ç¦»åçš„è¿›ç¨‹ |
| nsenter | è¿›å…¥å·²å­˜åœ¨çš„ Namespaceï¼Œç”¨äºè°ƒè¯• |
| é€‰æ‹©æ€§è¿›å…¥ | -n ç½‘ç»œã€-m æŒ‚è½½ã€-p PIDã€-a æ‰€æœ‰ |
| è°ƒè¯•æ¨¡å¼ | nsenter ç»•è¿‡ docker exec é™åˆ¶ |

---

## åæ¨¡å¼ï¼šå¸¸è§é”™è¯¯

### é”™è¯¯ 1ï¼šå¿˜è®° --fork å¯¼è‡´ PID ä¸æ˜¯ 1

```bash
# é”™è¯¯
sudo unshare --pid /bin/bash
echo $$  # ä¸æ˜¯ 1ï¼

# æ­£ç¡®
sudo unshare --pid --fork /bin/bash
echo $$  # æ˜¯ 1ï¼ˆå¦‚æœåŠ äº† --mount-procï¼‰
```

### é”™è¯¯ 2ï¼šnsenter åªè¿›å…¥ PID Namespace çœ‹ä¸åˆ°è¿›ç¨‹

```bash
# é”™è¯¯
sudo nsenter -t $PID -p ps aux
# æŠ¥é”™æˆ–æ˜¾ç¤ºå®¿ä¸»æœºè¿›ç¨‹

# æ­£ç¡®ï¼ˆéœ€è¦åŒæ—¶è¿›å…¥ Mount Namespaceï¼‰
sudo nsenter -t $PID -p -m ps aux
```

### é”™è¯¯ 3ï¼šä¾èµ– docker exec è€Œé nsenter

```bash
# docker exec çš„å±€é™ï¼š
# - éœ€è¦ Docker daemon æ­£å¸¸
# - Distroless é•œåƒæ— æ³•è¿›å…¥
# - å¯èƒ½è¢«å®‰å…¨ç­–ç•¥ç¦æ­¢

# nsenter çš„ä¼˜åŠ¿ï¼š
# - ç›´æ¥æ“ä½œ Namespaceï¼Œä¸ä¾èµ– daemon
# - ä½¿ç”¨å®¿ä¸»æœºå·¥å…·
# - åªéœ€ root æƒé™
```

---

## å»¶ä¼¸é˜…è¯»

- [Linux Namespaces man page](https://man7.org/linux/man-pages/man7/namespaces.7.html)
- [unshare(1) man page](https://man7.org/linux/man-pages/man1/unshare.1.html)
- [nsenter(1) man page](https://man7.org/linux/man-pages/man1/nsenter.1.html)
- ä¸‹ä¸€è¯¾ï¼š[04 - User Namespace ä¸ Rootless å®¹å™¨](../04-user-namespace-rootless/)
- ç›¸å…³è¯¾ç¨‹ï¼š[11 - å®¹å™¨æ•…éšœæ’æŸ¥](../11-debugging-troubleshooting/) - å®Œæ•´æ’æŸ¥æ–¹æ³•è®º

---

## é¢è¯•å‡†å¤‡ï¼ˆInterview Prepï¼‰

### Q1: unshare ã¨ nsenter ã®é•ã„ã¯ï¼Ÿ

**å›ç­”è¦ç‚¹**ï¼š

```
unshare:
- æ–°ã—ã„ Namespace ã‚’ä½œæˆ
- ç¾åœ¨ã®ãƒ—ãƒ­ã‚»ã‚¹ã‚’æ–° Namespace ã«ç§»å‹•
- ã‚³ãƒ³ãƒ†ãƒŠç’°å¢ƒã®æ§‹ç¯‰ã«ä½¿ç”¨

nsenter:
- æ—¢å­˜ã® Namespace ã«å…¥ã‚‹
- ä»–ã®ãƒ—ãƒ­ã‚»ã‚¹ã® Namespace ã‚’å…±æœ‰
- ã‚³ãƒ³ãƒ†ãƒŠã®ãƒ‡ãƒãƒƒã‚°ã«ä½¿ç”¨
```

### Q2: docker exec ãŒä½¿ãˆãªã„æ™‚ã®å¯¾å‡¦æ³•ã¯ï¼Ÿ

**å›ç­”è¦ç‚¹**ï¼š

```
1. docker inspect ã§ PID ã‚’å–å¾—
   PID=$(docker inspect --format '{{.State.Pid}}' <container>)

2. nsenter ã§Namespace ã«ç›´æ¥å…¥ã‚‹
   nsenter -t $PID -n  # ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯
   nsenter -t $PID -m  # ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ 
   nsenter -t $PID -a  # å…¨éƒ¨

3. ãƒ›ã‚¹ãƒˆã®ãƒ„ãƒ¼ãƒ«ã§ãƒ‡ãƒãƒƒã‚°
   nsenter -t $PID -n ping 8.8.8.8
   nsenter -t $PID -n tcpdump
```

### Q3: PID Namespace ã§ --fork ãŒå¿…è¦ãªç†ç”±ã¯ï¼Ÿ

**å›ç­”è¦ç‚¹**ï¼š

```
PID Namespace ã®ä½œæˆè€…è‡ªèº«ã¯å¤ã„ Namespace ã«æ®‹ã‚‹ã€‚
--fork ã§å­ãƒ—ãƒ­ã‚»ã‚¹ã‚’ä½œã‚Šã€ãã®å­ãƒ—ãƒ­ã‚»ã‚¹ãŒæ–° Namespace ã® PID 1 ã«ãªã‚‹ã€‚
ã“ã‚Œã«ã‚ˆã‚Šã€ãã®å­ãƒ—ãƒ­ã‚»ã‚¹ã‹ã‚‰è¦‹ã‚‹ã¨è‡ªåˆ†ãŒ init ãƒ—ãƒ­ã‚»ã‚¹ã€‚
```

---

## ç³»åˆ—å¯¼èˆª

[<- 02 - Namespace åŸºç¡€](../02-namespace-overview/) | [ç³»åˆ—é¦–é¡µ](../) | [04 - User Namespace -->](../04-user-namespace-rootless/)
