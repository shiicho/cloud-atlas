# 09 - å®¹å™¨å®‰å…¨ï¼šseccomp ä¸ Capabilities

> **ç›®æ ‡**ï¼šç†è§£å®¹å™¨å®‰å…¨è¾¹ç•Œï¼ŒæŒæ¡ seccomp å’Œ Capabilities é…ç½®ï¼Œè¯†åˆ«å¹¶é¿å…å¸¸è§å®‰å…¨åæ¨¡å¼  
> **å‰ç½®**ï¼š[Lesson 08 - å®¹å™¨ç½‘ç»œ](../08-container-networking/)ï¼›äº†è§£ [LX08-SECURITY ç¬¬ 6 è¯¾ Capabilities åŸºç¡€](../../lx08-security/)  
> **æ—¶é—´**ï¼šâš¡ 40 åˆ†é’Ÿï¼ˆé€Ÿè¯»ï¼‰/ ğŸ”¬ 150 åˆ†é’Ÿï¼ˆå®Œæ•´å®æ“ï¼‰  
> **åœºæ™¯**ï¼šã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»å¯¾å¿œï¼ˆå®‰å…¨å®¡è®¡åº”å¯¹ï¼‰  

---

## å°†å­¦åˆ°çš„å†…å®¹

1. ç†è§£å®¹å™¨å®‰å…¨è¾¹ç•Œçš„å¤šå±‚é˜²å¾¡ä½“ç³»
2. é…ç½®å’Œè°ƒè¯• seccomp profileï¼ˆç³»ç»Ÿè°ƒç”¨è¿‡æ»¤ï¼‰
3. ç®¡ç†å®¹å™¨ Capabilitiesï¼ˆç²¾ç»†æƒé™æ§åˆ¶ï¼‰
4. è¯†åˆ«å±é™©çš„å®‰å…¨åæ¨¡å¼ï¼ˆ--privileged, docker.sock ç­‰ï¼‰
5. ä½¿ç”¨ dmesgã€audit.logã€strace è°ƒè¯•å®‰å…¨é—®é¢˜

---

## å…ˆè·‘èµ·æ¥ï¼š5 åˆ†é’Ÿä½“éªŒ Capabilities é™åˆ¶

> **ä¸è®²åŸç†ï¼Œå…ˆåŠ¨æ‰‹ï¼** ä½ é©¬ä¸Šä¼šçœ‹åˆ°å®¹å™¨æƒé™è¢«ç²¾ç¡®æ§åˆ¶çš„æ•ˆæœã€‚  

### å‡†å¤‡å·¥ä½œ

ç¡®ä¿ Docker å·²å®‰è£…ï¼ˆæˆ–ä½¿ç”¨ Podmanï¼‰ï¼š

```bash
docker --version || podman --version
```

### å®éªŒï¼šDrop æ‰€æœ‰ Capabilities

```bash
# é»˜è®¤å®¹å™¨ï¼šå¯ä»¥æ‰§è¡Œ chown
docker run --rm alpine chown nobody /etc/passwd
echo "Exit code: $?"  # 0ï¼ˆæˆåŠŸï¼‰

# Drop æ‰€æœ‰ capabilitiesï¼šchown å¤±è´¥ï¼
docker run --rm --cap-drop=ALL alpine chown nobody /etc/passwd
echo "Exit code: $?"  # 1ï¼ˆå¤±è´¥ï¼‰
```

è¾“å‡ºï¼š

```
chown: /etc/passwd: Operation not permitted
Exit code: 1
```

### å®éªŒï¼šåªæ·»åŠ å¿…éœ€çš„ Capability

```bash
# Drop ALL + åªæ·»åŠ  CHOWN capability
docker run --rm --cap-drop=ALL --cap-add=CHOWN alpine chown nobody /etc/passwd
echo "Exit code: $?"  # 0ï¼ˆæˆåŠŸï¼‰
```

**ä½ åˆšåˆšåšäº†ä»€ä¹ˆï¼Ÿ**

```
é»˜è®¤å®¹å™¨                 --cap-drop=ALL            --cap-drop=ALL --cap-add=CHOWN
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CAP_CHOWN       â”‚     â”‚                 â”‚       â”‚ CAP_CHOWN       â”‚
â”‚ CAP_DAC_OVERRIDEâ”‚     â”‚ (æ—  Capability) â”‚       â”‚                 â”‚
â”‚ CAP_FOWNER      â”‚     â”‚                 â”‚       â”‚ (åªæœ‰ CHOWN)    â”‚
â”‚ CAP_SETUID      â”‚     â”‚  chown å¤±è´¥!    â”‚       â”‚  chown æˆåŠŸ!    â”‚
â”‚ ...14 more...   â”‚     â”‚                 â”‚       â”‚                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â†“                        â†“                         â†“
   æƒé™å¤ªå¤š              æƒé™ä¸è¶³                    åˆšåˆšå¥½!
```

è¿™å°±æ˜¯**æœ€å°æƒé™åŸåˆ™**åœ¨å®¹å™¨ä¸­çš„åº”ç”¨ã€‚

---

## å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ

### å®¹å™¨å®‰å…¨è¾¹ç•Œçš„å¤šå±‚é˜²å¾¡

å®¹å™¨å®‰å…¨ä¸æ˜¯å•ä¸€æœºåˆ¶ï¼Œè€Œæ˜¯å¤šå±‚é˜²å¾¡çš„ç»„åˆï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å®¹å™¨å®‰å…¨è¾¹ç•Œ                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  Layer 1: Namespace (å¯è§æ€§éš”ç¦»)                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ PID / Mount / Network / UTS / IPC / User / Cgroup          â”‚     â”‚
â”‚  â”‚ æ§åˆ¶è¿›ç¨‹ã€Œèƒ½çœ‹åˆ°ä»€ä¹ˆã€                                      â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                     â”‚
â”‚  Layer 2: cgroups (èµ„æºé™åˆ¶)                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ CPU / Memory / IO / PIDs                                    â”‚     â”‚
â”‚  â”‚ æ§åˆ¶è¿›ç¨‹ã€Œèƒ½ç”¨å¤šå°‘ã€                                        â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                     â”‚
â”‚  Layer 3: Capabilities (ç‰¹æƒåˆ†è§£)                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ CAP_NET_BIND_SERVICE / CAP_CHOWN / CAP_SYS_ADMIN / ...      â”‚     â”‚
â”‚  â”‚ æ§åˆ¶è¿›ç¨‹ã€Œèƒ½åšä»€ä¹ˆæ“ä½œã€                                    â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                     â”‚
â”‚  Layer 4: seccomp (ç³»ç»Ÿè°ƒç”¨è¿‡æ»¤)                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ å…è®¸/ç¦æ­¢ç‰¹å®šç³»ç»Ÿè°ƒç”¨                                       â”‚     â”‚
â”‚  â”‚ æ§åˆ¶è¿›ç¨‹ã€Œèƒ½è°ƒç”¨ä»€ä¹ˆå†…æ ¸æ¥å£ã€                              â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                     â”‚
â”‚  Layer 5: AppArmor/SELinux (MAC å¼ºåˆ¶è®¿é—®æ§åˆ¶)                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ åŸºäºç­–ç•¥çš„è®¿é—®æ§åˆ¶                                          â”‚     â”‚
â”‚  â”‚ æ§åˆ¶è¿›ç¨‹ã€Œèƒ½è®¿é—®ä»€ä¹ˆèµ„æºã€                                  â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

æœ¬è¯¾é‡ç‚¹ï¼š**Layer 3 (Capabilities)** å’Œ **Layer 4 (seccomp)**ã€‚

---

## æ ¸å¿ƒæ¦‚å¿µï¼šCapabilities

### å›é¡¾ï¼šä» LX08-SECURITY åˆ°å®¹å™¨

åœ¨ [LX08-SECURITY ç¬¬ 6 è¯¾](../../lx08-security/) ä¸­ï¼Œä½ å­¦ä¹ äº† Linux Capabilities çš„åŸºç¡€ï¼š

- ä¼ ç»Ÿ Unixï¼šroot (UID 0) æ‹¥æœ‰æ‰€æœ‰æƒé™ï¼Œæ™®é€šç”¨æˆ·å‡ ä¹æ²¡æœ‰
- Capabilitiesï¼šå°† root æƒé™åˆ†è§£ä¸º 40+ ä¸ªç»†ç²’åº¦èƒ½åŠ›
- æ–‡ä»¶ Capabilitiesï¼šä½¿ç”¨ `getcap`/`setcap` ç»™å¯æ‰§è¡Œæ–‡ä»¶èµ‹äºˆç‰¹å®šèƒ½åŠ›

**LX11 åœ¨æ­¤åŸºç¡€ä¸Šæ·»åŠ **ï¼š

- å®¹å™¨å¦‚ä½•ç»§æ‰¿å’Œé™åˆ¶ Capabilities
- `--cap-drop` å’Œ `--cap-add` çš„ä½¿ç”¨
- å®‰å…¨å®¡è®¡æ—¶å¦‚ä½•è§£é‡Š Capabilities é…ç½®

### Docker é»˜è®¤ Capabilities

Docker é»˜è®¤ä¿ç•™ 14 ä¸ª Capabilitiesï¼ˆå‡ºäºå…¼å®¹æ€§è€ƒè™‘ï¼‰ï¼š

```bash
# æŸ¥çœ‹å®¹å™¨çš„ Capabilities
docker run --rm alpine cat /proc/1/status | grep Cap
```

è¾“å‡ºï¼š

```
CapInh: 0000000000000000
CapPrm: 00000000a80425fb
CapEff: 00000000a80425fb
CapBnd: 00000000a80425fb
CapAmb: 0000000000000000
```

è§£ç  Capabilitiesï¼š

```bash
# å°† hex å€¼è§£ç ä¸ºå¯è¯»åç§°
capsh --decode=00000000a80425fb
```

è¾“å‡ºï¼š

```
0x00000000a80425fb=cap_chown,cap_dac_override,cap_fowner,cap_fsetid,
cap_kill,cap_setgid,cap_setuid,cap_setpcap,cap_net_bind_service,
cap_net_raw,cap_sys_chroot,cap_mknod,cap_audit_write,cap_setfcap
```

### å¸¸è§ Capabilities è¯´æ˜

| Capability | ä½œç”¨ | å®¹å™¨ä¸­çš„å…¸å‹ç”¨é€” |
|------------|------|------------------|
| `CAP_CHOWN` | æ”¹å˜æ–‡ä»¶æ‰€æœ‰è€… | å®‰è£…è½¯ä»¶åŒ… |
| `CAP_NET_BIND_SERVICE` | ç»‘å®š <1024 ç«¯å£ | Web æœåŠ¡å™¨ |
| `CAP_NET_RAW` | ä½¿ç”¨åŸå§‹å¥—æ¥å­— | ping, tcpdump |
| `CAP_SETUID` | åˆ‡æ¢ç”¨æˆ· ID | è¿›ç¨‹åˆ‡æ¢ç”¨æˆ· |
| `CAP_SYS_ADMIN` | ç³»ç»Ÿç®¡ç†ï¼ˆå±é™©ï¼ï¼‰ | **åº”é¿å…** |
| `CAP_SYS_PTRACE` | è°ƒè¯•å…¶ä»–è¿›ç¨‹ | è°ƒè¯•å·¥å…· |

### æœ€å°æƒé™é…ç½®

**å®‰å…¨æœ€ä½³å®è·µ**ï¼šDrop ALLï¼Œåªæ·»åŠ å¿…éœ€çš„ã€‚

```bash
# ç¤ºä¾‹ï¼šè¿è¡Œ Nginxï¼ˆéœ€è¦ç»‘å®š 80 ç«¯å£ï¼‰
docker run --rm \
  --cap-drop=ALL \
  --cap-add=NET_BIND_SERVICE \
  --cap-add=CHOWN \
  --cap-add=SETUID \
  --cap-add=SETGID \
  nginx:alpine
```

---

## æ ¸å¿ƒæ¦‚å¿µï¼šseccomp

### ä»€ä¹ˆæ˜¯ seccompï¼Ÿ

**seccomp (Secure Computing Mode)** æ˜¯ Linux å†…æ ¸çš„ç³»ç»Ÿè°ƒç”¨è¿‡æ»¤æœºåˆ¶ï¼š

- é™åˆ¶è¿›ç¨‹å¯ä»¥è°ƒç”¨çš„ç³»ç»Ÿè°ƒç”¨ï¼ˆsyscallï¼‰
- æ¯” Capabilities æ›´ç»†ç²’åº¦
- åœ¨ç³»ç»Ÿè°ƒç”¨æ‰§è¡Œå‰æ£€æŸ¥ï¼Œæ‹’ç»å±é™©è°ƒç”¨

### Docker é»˜è®¤ seccomp Profile

Docker é»˜è®¤å¯ç”¨ seccomp profileï¼Œé˜»æ­¢çº¦ 44 ä¸ªå±é™©ç³»ç»Ÿè°ƒç”¨ï¼š

```
Docker é»˜è®¤ seccomp é˜»æ­¢çš„ç³»ç»Ÿè°ƒç”¨ï¼ˆéƒ¨åˆ†ï¼‰ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç³»ç»Ÿè°ƒç”¨          â”‚ è¢«é˜»æ­¢åŸå›                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ mount            â”‚ æŒ‚è½½æ–‡ä»¶ç³»ç»Ÿ - å¯é€ƒé€¸å®¹å™¨                     â”‚
â”‚ umount           â”‚ å¸è½½æ–‡ä»¶ç³»ç»Ÿ                                  â”‚
â”‚ ptrace           â”‚ è¿›ç¨‹è¿½è¸ª - å¯è°ƒè¯•/åŠ«æŒå…¶ä»–è¿›ç¨‹                â”‚
â”‚ personality      â”‚ è®¾ç½®è¿›ç¨‹æ‰§è¡ŒåŸŸ - å¯ç»•è¿‡å®‰å…¨é™åˆ¶               â”‚
â”‚ keyctl           â”‚ å†…æ ¸å¯†é’¥ç®¡ç†                                  â”‚
â”‚ add_key          â”‚ æ·»åŠ å¯†é’¥åˆ°å†…æ ¸                                â”‚
â”‚ request_key      â”‚ è¯·æ±‚å†…æ ¸å¯†é’¥                                  â”‚
â”‚ init_module      â”‚ åŠ è½½å†…æ ¸æ¨¡å— - å¯å®Œå…¨æ§åˆ¶å†…æ ¸                 â”‚
â”‚ delete_module    â”‚ åˆ é™¤å†…æ ¸æ¨¡å—                                  â”‚
â”‚ kexec_load       â”‚ åŠ è½½æ–°å†…æ ¸ - å¯æ›¿æ¢è¿è¡Œçš„å†…æ ¸                 â”‚
â”‚ reboot           â”‚ é‡å¯ç³»ç»Ÿ                                      â”‚
â”‚ swapon/swapoff   â”‚ äº¤æ¢ç©ºé—´æ§åˆ¶                                  â”‚
â”‚ ...              â”‚ ...                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### éªŒè¯ seccomp ç”Ÿæ•ˆ

```bash
# å°è¯•åœ¨å®¹å™¨ä¸­æ‰§è¡Œ mountï¼ˆé»˜è®¤è¢«é˜»æ­¢ï¼‰
docker run --rm alpine mount -t proc proc /tmp
```

è¾“å‡ºï¼š

```
mount: permission denied (are you root?)
```

å³ä½¿æ˜¯ rootï¼Œseccomp ä¹Ÿé˜»æ­¢äº† `mount` ç³»ç»Ÿè°ƒç”¨ã€‚

---

## åŠ¨æ‰‹ç»ƒä¹ 

### Lab 1ï¼šseccomp Profile å®éªŒ

**ç›®æ ‡**ï¼šç†è§£ seccomp å¦‚ä½•é˜»æ­¢å±é™©ç³»ç»Ÿè°ƒç”¨ã€‚

**è¿è¡Œæ¼”ç¤ºè„šæœ¬**ï¼š

```bash
cd ~/cloud-atlas/foundations/linux/lx11-containers/09-container-security/code
./seccomp-demo.sh
```

**æˆ–æ‰‹åŠ¨æ‰§è¡Œ**ï¼š

**æ­¥éª¤ 1ï¼šéªŒè¯é»˜è®¤ seccomp é˜»æ­¢ unshare**

```bash
# unshare ç³»ç»Ÿè°ƒç”¨è¢«é»˜è®¤ profile é˜»æ­¢ï¼ˆé™¤éæœ‰ç‰¹å®š capabilityï¼‰
docker run --rm alpine unshare --fork --pid --mount-proc /bin/sh -c "echo PID: $$"
```

è¾“å‡ºï¼ˆå¯èƒ½å¤±è´¥æˆ–æˆåŠŸï¼Œå–å†³äº capabilityï¼‰ï¼š

```
unshare: unshare(0x60000000): Operation not permitted
```

**æ­¥éª¤ 2ï¼šç¦ç”¨ seccomp åå¯ä»¥æ‰§è¡Œ**

> **è­¦å‘Š**ï¼šä»…åœ¨éš”ç¦»æµ‹è¯•ç¯å¢ƒä¸­æ‰§è¡Œï¼  

```bash
# ç¦ç”¨ seccompï¼ˆå±é™©ï¼ï¼‰
docker run --rm --security-opt seccomp=unconfined alpine \
  unshare --fork --pid --mount-proc /bin/sh -c "echo PID: \$\$"
```

è¾“å‡ºï¼š

```
PID: 1
```

**æ­¥éª¤ 3ï¼šæŸ¥çœ‹è¢«é˜»æ­¢çš„è¯æ®ï¼ˆåœ¨å®¿ä¸»æœºï¼‰**

```bash
# æ£€æŸ¥å†…æ ¸æ—¥å¿—
dmesg | grep -i seccomp | tail -5
```

è¾“å‡ºç¤ºä¾‹ï¼š

```
[12345.678901] audit: type=1326 ... syscall=56 compat=0 ... exe="/bin/unshare" ...
```

syscall=56 æ˜¯ `clone` ç³»ç»Ÿè°ƒç”¨ï¼ˆunshare å†…éƒ¨ä½¿ç”¨ï¼‰ã€‚

---

### Lab 2ï¼šCapabilities å®éªŒ

**ç›®æ ‡**ï¼šä½¿ç”¨ `--cap-drop=ALL --cap-add=...` æœ€å°åŒ–æƒé™ã€‚

**è¿è¡Œæ¼”ç¤ºè„šæœ¬**ï¼š

```bash
cd ~/cloud-atlas/foundations/linux/lx11-containers/09-container-security/code
./capabilities-demo.sh
```

**æˆ–æ‰‹åŠ¨æ‰§è¡Œ**ï¼š

**æ­¥éª¤ 1ï¼šæ¼”ç¤º CAP_NET_RAWï¼ˆping éœ€è¦ï¼‰**

```bash
# é»˜è®¤å¯ä»¥ ping
docker run --rm alpine ping -c 1 8.8.8.8

# Drop CAP_NET_RAW åä¸èƒ½ ping
docker run --rm --cap-drop=NET_RAW alpine ping -c 1 8.8.8.8
```

è¾“å‡ºï¼š

```
PING 8.8.8.8 (8.8.8.8): 56 data bytes
ping: permission denied (are you root?)
```

**æ­¥éª¤ 2ï¼šæ¼”ç¤º CAP_NET_BIND_SERVICEï¼ˆç»‘å®šä½ç«¯å£ï¼‰**

```bash
# åˆ›å»ºæµ‹è¯•è„šæœ¬
docker run --rm alpine sh -c "nc -l -p 80 &"  # é»˜è®¤å¯ä»¥

# Drop åå¤±è´¥
docker run --rm --cap-drop=NET_BIND_SERVICE alpine sh -c "nc -l -p 80"
# å¯èƒ½éœ€è¦å®‰è£… nc: apk add netcat-openbsd
```

**æ­¥éª¤ 3ï¼šå®Œæ•´æœ€å°æƒé™ç¤ºä¾‹**

```bash
# Nginx æœ€å°æƒé™é…ç½®
docker run --rm -d \
  --name nginx-minimal \
  --cap-drop=ALL \
  --cap-add=NET_BIND_SERVICE \
  --cap-add=CHOWN \
  --cap-add=SETUID \
  --cap-add=SETGID \
  --cap-add=DAC_OVERRIDE \
  nginx:alpine

# éªŒè¯è¿è¡Œ
docker ps | grep nginx-minimal

# æ¸…ç†
docker rm -f nginx-minimal
```

---

### Lab 3ï¼šå®‰å…¨åæ¨¡å¼æ¼”ç¤º

> **è­¦å‘Š**ï¼šä»¥ä¸‹æ¼”ç¤ºä»…ç”¨äºæ•™è‚²ç›®çš„ï¼Œ**å¿…é¡»åœ¨éš”ç¦»çš„æµ‹è¯•ç¯å¢ƒä¸­æ‰§è¡Œ**ï¼  
> æ°¸è¿œä¸è¦åœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨è¿™äº›å±é™©é…ç½®ï¼  

**ç›®æ ‡**ï¼šç†è§£ä¸ºä»€ä¹ˆ `--privileged` å’Œ `docker.sock` æŒ‚è½½æ˜¯å±é™©çš„ã€‚

#### åæ¨¡å¼ 1ï¼š--privileged ç»•è¿‡æ‰€æœ‰éš”ç¦»

```bash
# æ¼”ç¤º --privileged å¯ä»¥è®¿é—®å®¿ä¸»æœºè®¾å¤‡
docker run --rm --privileged alpine ls /dev | head -20
```

è¾“å‡ºï¼ˆå¯ä»¥çœ‹åˆ°å®¿ä¸»æœºæ‰€æœ‰è®¾å¤‡ï¼‰ï¼š

```
autofs
bsg
btrfs-control
console
...
sda
sda1
...
```

**å±é™©**ï¼š`--privileged` å®¹å™¨å¯ä»¥ï¼š
- è®¿é—®æ‰€æœ‰è®¾å¤‡ï¼ˆåŒ…æ‹¬ç£ç›˜ï¼‰
- æŒ‚è½½å®¿ä¸»æœºæ–‡ä»¶ç³»ç»Ÿ
- åŠ è½½å†…æ ¸æ¨¡å—
- åŸºæœ¬ç­‰åŒäº root ç›´æ¥åœ¨å®¿ä¸»æœºæ‰§è¡Œ

```bash
# æ¼”ç¤ºï¼šprivileged å®¹å™¨å¯ä»¥æŒ‚è½½å®¿ä¸»æœºç£ç›˜ï¼
docker run --rm --privileged alpine sh -c "mkdir /hostroot && mount /dev/sda1 /hostroot && ls /hostroot" 2>/dev/null || echo "ï¼ˆéœ€è¦å®é™…ç£ç›˜è®¾å¤‡ï¼‰"
```

#### åæ¨¡å¼ 2ï¼šæŒ‚è½½ docker.sock

```bash
# æŒ‚è½½ docker.sock çš„å®¹å™¨å¯ä»¥æ§åˆ¶æ‰€æœ‰å®¹å™¨ï¼
docker run --rm -v /var/run/docker.sock:/var/run/docker.sock alpine sh -c "
  apk add --no-cache docker-cli >/dev/null 2>&1
  docker ps
"
```

è¾“å‡ºï¼ˆå¯ä»¥çœ‹åˆ°å®¿ä¸»æœºæ‰€æœ‰å®¹å™¨ï¼‰ï¼š

```
CONTAINER ID   IMAGE   ...
abc123         nginx   ...
def456         redis   ...
```

**å±é™©**ï¼šæ‹¥æœ‰ docker.sock è®¿é—®æƒçš„å®¹å™¨å¯ä»¥ï¼š
- æŸ¥çœ‹ã€å¯åŠ¨ã€åœæ­¢æ‰€æœ‰å®¹å™¨
- å¯åŠ¨ç‰¹æƒå®¹å™¨
- è®¿é—®å…¶ä»–å®¹å™¨çš„æ•°æ®
- **ç­‰åŒäºå®¿ä¸»æœº root æƒé™**

#### åæ¨¡å¼ 3ï¼šç¦ç”¨ seccomp

```bash
# --security-opt seccomp=unconfined å…è®¸æ‰€æœ‰ç³»ç»Ÿè°ƒç”¨
docker run --rm --security-opt seccomp=unconfined alpine whoami
```

è™½ç„¶çœ‹èµ·æ¥æ— å®³ï¼Œä½†ï¼š
- æ”»å‡»è€…å¯ä»¥åˆ©ç”¨å†…æ ¸æ¼æ´
- mountã€ptrace ç­‰å±é™©è°ƒç”¨ä¸å—é™
- å¤§å¤§å¢åŠ æ”»å‡»é¢

#### åæ¨¡å¼ 4ï¼šCAP_SYS_ADMIN æˆæƒ

```bash
# CAP_SYS_ADMIN æ˜¯æœ€å±é™©çš„ capability
docker run --rm --cap-add=SYS_ADMIN alpine cat /proc/1/status | grep Cap
```

**CAP_SYS_ADMIN å…è®¸**ï¼š
- æŒ‚è½½æ–‡ä»¶ç³»ç»Ÿ
- é…ç½®å†…æ ¸å‚æ•°
- ä½¿ç”¨ perf_event
- åŸºæœ¬æ¥è¿‘ root

---

## å®‰å…¨è°ƒè¯•æŠ€å·§

å½“å®¹å™¨å› å®‰å…¨ç­–ç•¥å¤±è´¥æ—¶ï¼Œå¦‚ä½•å®šä½é—®é¢˜ï¼Ÿ

### æ–¹æ³• 1ï¼šæ£€æŸ¥ dmesgï¼ˆseccomp æ‹’ç»ï¼‰

```bash
# åœ¨å®¿ä¸»æœºæ‰§è¡Œ
dmesg | grep -i seccomp | tail -10

# æˆ–ä½¿ç”¨ journalctl
journalctl -k | grep -i seccomp | tail -10
```

è¾“å‡ºç¤ºä¾‹ï¼š

```
[xxxxx.xxxxxx] audit: type=1326 audit(xxx): ... syscall=56 ... exe="/bin/unshare" ...
```

è§£ç  syscall ç¼–å·ï¼š

```bash
# syscall 56 æ˜¯ä»€ä¹ˆï¼Ÿ
ausyscall 56  # éœ€è¦ auditd åŒ…
# æˆ–æŸ¥è¡¨ï¼šhttps://filippo.io/linux-syscall-table/
```

### æ–¹æ³• 2ï¼šæ£€æŸ¥ audit.logï¼ˆSELinux/AppArmor æ‹’ç»ï¼‰

```bash
# æ£€æŸ¥å®¡è®¡æ—¥å¿—
sudo cat /var/log/audit/audit.log | grep -i denied | tail -10

# ä½¿ç”¨ ausearchï¼ˆæ›´æ˜“è¯»ï¼‰
sudo ausearch -m avc -ts recent
```

### æ–¹æ³• 3ï¼šä½¿ç”¨ strace è¿½è¸ªç³»ç»Ÿè°ƒç”¨

```bash
# åœ¨å®¹å™¨ä¸­è¿½è¸ªç³»ç»Ÿè°ƒç”¨
docker run --rm --cap-add=SYS_PTRACE alpine sh -c "
  apk add --no-cache strace >/dev/null 2>&1
  strace -f ping -c 1 8.8.8.8 2>&1 | head -30
"
```

**æ³¨æ„**ï¼š`strace` éœ€è¦ `CAP_SYS_PTRACE` capabilityã€‚

### è°ƒè¯•å·¥ä½œæµ

```
å®¹å™¨å¯åŠ¨/è¿è¡Œå¤±è´¥
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. æ£€æŸ¥å®¹å™¨æ—¥å¿—   â”‚  docker logs <container>
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ æ— æœ‰ç”¨ä¿¡æ¯ï¼Ÿ
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. æ£€æŸ¥ dmesg     â”‚  dmesg | grep -i seccomp
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  dmesg | grep -i oom
         â”‚ å‘ç° seccomp æ‹’ç»ï¼Ÿ
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. è§£ç  syscall   â”‚  ausyscall <number>
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ ç¡®è®¤éœ€è¦çš„ç³»ç»Ÿè°ƒç”¨
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. è°ƒæ•´ profile   â”‚  è‡ªå®šä¹‰ seccomp profile
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  æˆ–æ·»åŠ æ‰€éœ€ capability
```

---

## èŒåœºå°è´´å£«

### æ—¥æœ¬ IT ç°åœºå¸¸è§åœºæ™¯

**åœºæ™¯ 1ï¼šã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»ã§ã‚³ãƒ³ãƒ†ãƒŠæ¨©é™ç¢ºèªï¼ˆå®‰å…¨å®¡è®¡å®¹å™¨æƒé™ï¼‰**

```
ç›£æŸ»å“¡ï¼šã€Œã“ã®ã‚³ãƒ³ãƒ†ãƒŠã®æ¨©é™è¨­å®šã‚’èª¬æ˜ã—ã¦ãã ã•ã„ã€

ç¢ºèªã‚³ãƒãƒ³ãƒ‰ï¼š
# 1. å®¹å™¨çš„ capability é…ç½®
docker inspect <container> | jq '.[0].HostConfig.CapAdd'
docker inspect <container> | jq '.[0].HostConfig.CapDrop'

# 2. seccomp profile ç¢ºèª
docker inspect <container> | jq '.[0].HostConfig.SecurityOpt'

# 3. ç‰¹æ¨©ãƒ¢ãƒ¼ãƒ‰ç¢ºèªï¼ˆæœ€é‡è¦ï¼ï¼‰
docker inspect <container> | jq '.[0].HostConfig.Privileged'

å›ç­”ä¾‹ï¼š
ã€Œã“ã®ã‚³ãƒ³ãƒ†ãƒŠã¯ --cap-drop=ALL ã§å…¨ capability ã‚’å‰Šé™¤ã—ã€
 å¿…è¦æœ€å°é™ã® NET_BIND_SERVICE ã®ã¿è¿½åŠ ã—ã¦ã„ã¾ã™ã€‚
 --privileged ã¯ä½¿ç”¨ã—ã¦ã„ã¾ã›ã‚“ã€‚ã€
```

**åœºæ™¯ 2ï¼š--privileged ä½¿ç”¨ã®èª¬æ˜ã‚’æ±‚ã‚ã‚‰ã‚Œã‚‹**

```
çŠ¶æ³ï¼šé–‹ç™ºè€…ãŒ --privileged ã‚’ä½¿ã„ãŸã„ã¨è¨€ã†

å¯¾å¿œï¼š
1. ãªãœå¿…è¦ã‹å…·ä½“çš„ã«ç¢ºèª
2. ä»£æ›¿æ¡ˆã‚’ææ¡ˆ

ä»£æ›¿æ¡ˆä¾‹ï¼š
- mount ãŒå¿…è¦ â†’ CAP_SYS_ADMIN ã‚ˆã‚Šå®‰å…¨ãªè¨­è¨ˆã‚’æ¤œè¨
- ãƒ‡ãƒã‚¤ã‚¹ã‚¢ã‚¯ã‚»ã‚¹ â†’ --device=/dev/xxx ã§ç‰¹å®šãƒ‡ãƒã‚¤ã‚¹ã®ã¿
- ãƒ›ã‚¹ãƒˆãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ â†’ --network=hostï¼ˆprivileged ã‚ˆã‚Šç‹­ã„ï¼‰

å ±å‘Šï¼š
ã€Œ--privileged ã®ä»£ã‚ã‚Šã« --cap-add=XXX ã§å¯¾å¿œã—ã¾ã—ãŸã€‚
 ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯ã‚’æœ€å°åŒ–ã—ã¦ã„ã¾ã™ã€‚ã€
```

**åœºæ™¯ 3ï¼šã‚³ãƒ³ãƒ†ãƒŠèµ·å‹•å¤±æ•—ã®ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°**

```
å•é¡Œï¼šã‚¢ãƒ—ãƒªãŒã‚³ãƒ³ãƒ†ãƒŠã§èµ·å‹•ã—ãªã„

èª¿æŸ»æ‰‹é †ï¼š
1. docker logs <container>                    # ã‚¢ãƒ—ãƒªãƒ­ã‚°ç¢ºèª
2. dmesg | grep -i seccomp                    # seccomp æ‹’å¦ç¢ºèª
3. docker inspect <container> | grep -i cap   # capability ç¢ºèª

ã‚ˆãã‚ã‚‹åŸå› ï¼š
- CAP_NET_BIND_SERVICE ä¸è¶³ï¼ˆ80ç•ªãƒãƒ¼ãƒˆãƒã‚¤ãƒ³ãƒ‰å¤±æ•—ï¼‰
- seccomp ã§å¿…è¦ãª syscall ãŒæ‹’å¦
- CAP_CHOWN ä¸è¶³ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«æ¨©é™å¤‰æ›´å¤±æ•—ï¼‰
```

### å®‰å…¨é…ç½®ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

```markdown
## ã‚³ãƒ³ãƒ†ãƒŠã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### åŸºæœ¬è¨­å®š
- [ ] --privileged ã‚’ä½¿ç”¨ã—ã¦ã„ãªã„
- [ ] /var/run/docker.sock ã‚’ãƒã‚¦ãƒ³ãƒˆã—ã¦ã„ãªã„
- [ ] --security-opt seccomp=unconfined ã‚’ä½¿ç”¨ã—ã¦ã„ãªã„

### Capabilities
- [ ] --cap-drop=ALL ã‹ã‚‰å§‹ã‚ã¦ã„ã‚‹
- [ ] å¿…è¦æœ€å°é™ã® capability ã®ã¿è¿½åŠ 
- [ ] CAP_SYS_ADMIN ã‚’ä½¿ç”¨ã—ã¦ã„ãªã„

### ãƒ¦ãƒ¼ã‚¶ãƒ¼
- [ ] USER æŒ‡ä»¤ã§é root ãƒ¦ãƒ¼ã‚¶ãƒ¼æŒ‡å®š
- [ ] ã¾ãŸã¯ --user ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§é root å®Ÿè¡Œ

### ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ 
- [ ] --read-only ã§èª­ã¿å–ã‚Šå°‚ç”¨ï¼ˆå¯èƒ½ãªå ´åˆï¼‰
- [ ] æ©Ÿå¯†ãƒ‡ãƒ¼ã‚¿ã¯ volume ã§ãªã secret ä½¿ç”¨
```

---

## æ£€æŸ¥æ¸…å•

å®Œæˆæœ¬è¯¾åï¼Œä½ åº”è¯¥èƒ½å¤Ÿï¼š

- [ ] èª¬æ˜å®¹å™¨å®‰å…¨è¾¹ç•Œçš„å¤šå±‚é˜²å¾¡ä½“ç³»ï¼ˆNamespace, cgroups, Capabilities, seccompï¼‰
- [ ] ä½¿ç”¨ `--cap-drop=ALL --cap-add=...` é…ç½®æœ€å°æƒé™
- [ ] è§£é‡Š Docker é»˜è®¤ä¿ç•™çš„ 14 ä¸ª Capabilities åŠå…¶ä½œç”¨
- [ ] ç†è§£ seccomp é»˜è®¤ profile é˜»æ­¢çš„å±é™©ç³»ç»Ÿè°ƒç”¨
- [ ] ä½¿ç”¨ `dmesg` æŸ¥çœ‹ seccomp æ‹’ç»æ—¥å¿—
- [ ] è¯†åˆ« 4 å¤§å®‰å…¨åæ¨¡å¼åŠå…¶å±é™©æ€§ï¼š
  - `--privileged`
  - æŒ‚è½½ `docker.sock`
  - `--security-opt seccomp=unconfined`
  - `CAP_SYS_ADMIN`
- [ ] å‘å®‰å…¨å®¡è®¡è§£é‡Šå®¹å™¨æƒé™é…ç½®
- [ ] è°ƒè¯•å› å®‰å…¨ç­–ç•¥å¯¼è‡´çš„å®¹å™¨å¯åŠ¨å¤±è´¥

---

## å»¶ä¼¸é˜…è¯»

### å®˜æ–¹æ–‡æ¡£

- [Docker Security - Kernel namespaces](https://docs.docker.com/engine/security/)
- [Docker seccomp profiles](https://docs.docker.com/engine/security/seccomp/)
- [Linux Capabilities - man 7 capabilities](https://man7.org/linux/man-pages/man7/capabilities.7.html)
- [seccomp - Kernel Documentation](https://www.kernel.org/doc/Documentation/prctl/seccomp_filter.txt)

### ç›¸å…³è¯¾ç¨‹

- [LX08-SECURITY ç¬¬ 6 è¯¾ - Linux Capabilities](../../lx08-security/) - Capabilities åŸºç¡€
- [Lesson 04 - User Namespace](../04-user-namespace-rootless/) - ç”¨æˆ·éš”ç¦»å’Œ rootless å®¹å™¨
- [Lesson 11 - å®¹å™¨æ•…éšœæ’æŸ¥](../11-debugging-troubleshooting/) - å®Œæ•´è°ƒè¯•æ–¹æ³•è®º

### æ¨èé˜…è¯»

- *Container Security* by Liz Rice - å…¨é¢çš„å®¹å™¨å®‰å…¨æŒ‡å—
- [Falco](https://falco.org/) - è¿è¡Œæ—¶å®¹å™¨å®‰å…¨ç›‘æ§
- [Docker Bench for Security](https://github.com/docker/docker-bench-security) - è‡ªåŠ¨åŒ–å®‰å…¨æ£€æŸ¥

---

## ç³»åˆ—å¯¼èˆª

[<-- 08 - å®¹å™¨ç½‘ç»œ](../08-container-networking/) | [Home](../) | [10 - OCI è¿è¡Œæ—¶ -->](../10-oci-runtimes/)
