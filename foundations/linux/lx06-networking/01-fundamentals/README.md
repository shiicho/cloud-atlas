# 01 - 网络基础概念（Networking Fundamentals）

> **目标**：10 分钟内检查你的网络状态，理解分层思维如何帮助排障  
> **前置**：基本 Linux 命令行操作（LX02 系统管理基础）  
> **时间**：⚡ 12 分钟（速读）/ 🔬 45 分钟（完整实操）  
> **环境**：任意 Linux 发行版（Ubuntu, AlmaLinux, Amazon Linux 均可）  

---

## 将学到的内容

1. 使用 5 条命令快速检查网络状态
2. 理解 OSI 7 层和 TCP/IP 4 层模型的对应关系
3. 建立分层排障思维：知道问题在哪一层，用什么工具
4. 了解常见端口和协议

---

## Step 1 — 先跑起来：10 分钟网络自检（10 分钟）

> **目标**：先"尝到"网络诊断的味道，再理解原理。  

打开你的终端，依次运行这 5 条命令：

### 1.1 查看网络接口和 IP 地址

```bash
ip addr show
```

```
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536
    inet 127.0.0.1/8 scope host lo
2: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 9001
    inet 10.0.1.52/24 brd 10.0.1.255 scope global dynamic eth0
```

**你看到了**：你的机器有哪些网络接口，每个接口的 IP 地址是什么。

### 1.2 查看路由表

```bash
ip route
```

```
default via 10.0.1.1 dev eth0 proto dhcp metric 100
10.0.1.0/24 dev eth0 proto kernel scope link src 10.0.1.52
```

**你看到了**：数据包要去哪里，通过哪个接口出去，默认网关是谁。

### 1.3 查看监听端口

```bash
ss -tulpn
```

```
Netid  State   Recv-Q  Send-Q   Local Address:Port   Peer Address:Port  Process
tcp    LISTEN  0       128      0.0.0.0:22            0.0.0.0:*          users:(("sshd",pid=1234))
tcp    LISTEN  0       511      127.0.0.1:80          0.0.0.0:*          users:(("nginx",pid=5678))
```

**你看到了**：哪些服务在等待连接，监听在什么地址和端口。

### 1.4 测试互联网连通性（L3 层）

```bash
ping -c 3 8.8.8.8
```

```
PING 8.8.8.8 (8.8.8.8) 56(84) bytes of data.
64 bytes from 8.8.8.8: icmp_seq=1 ttl=117 time=2.45 ms
64 bytes from 8.8.8.8: icmp_seq=2 ttl=117 time=2.38 ms
64 bytes from 8.8.8.8: icmp_seq=3 ttl=117 time=2.41 ms

--- 8.8.8.8 ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 2003ms
```

**你看到了**：网络层（L3）能到达 Google DNS 服务器。

### 1.5 测试 HTTP 连通性（L7 层）

```bash
curl -I https://www.google.com 2>/dev/null | head -5
```

```
HTTP/2 200
content-type: text/html; charset=ISO-8859-1
date: Sat, 04 Jan 2025 10:30:45 GMT
expires: -1
cache-control: private, max-age=0
```

**你看到了**：应用层（L7）能成功建立 HTTPS 连接。

---

**5 条命令，完整的网络状态！**

| 命令 | 检查内容 | 对应层 |
|------|----------|--------|
| `ip addr show` | 接口和 IP | L2/L3 |
| `ip route` | 路由表 | L3 |
| `ss -tulpn` | 监听端口 | L4 |
| `ping` | 网络连通 | L3 |
| `curl -I` | HTTP 连通 | L7 |

接下来，让我们理解每条命令背后的原理。

---

## Step 2 — 发生了什么？OSI 与 TCP/IP 模型（10 分钟）

### 2.1 为什么需要分层？

想象你在日本的公司里，同事说：「ネットワーク障害です」（网络故障了）。

问题可能在：
- **物理层**：网线没插好？
- **链路层**：交换机端口坏了？
- **网络层**：路由表配错了？
- **传输层**：端口被防火墙挡了？
- **应用层**：服务没启动？

**分层思维**让你能快速定位问题范围，而不是漫无目的地乱查。

### 2.2 OSI 7 层 vs TCP/IP 4 层

```
OSI 7 层模型                    TCP/IP 4 层模型              排障工具
─────────────────────────────────────────────────────────────────────
┌───────────────────┐
│ 7. 应用层         │          ┌───────────────────┐
│   Application     │          │                   │       curl, wget
├───────────────────┤          │ 4. 应用层         │       nc (netcat)
│ 6. 表示层         │          │   Application     │       应用日志
│   Presentation    │          │                   │
├───────────────────┤          └───────────────────┘
│ 5. 会话层         │
│   Session         │
├───────────────────┤          ┌───────────────────┐
│ 4. 传输层         │          │ 3. 传输层         │       ss, netstat
│   Transport       │◀────────▶│   Transport       │       tcpdump
│   (TCP/UDP)       │          │   (TCP/UDP)       │       (看端口)
├───────────────────┤          └───────────────────┘
│ 3. 网络层         │          ┌───────────────────┐
│   Network         │◀────────▶│ 2. 网络层         │       ping, traceroute
│   (IP)            │          │   Internet (IP)   │       ip route
├───────────────────┤          └───────────────────┘
│ 2. 数据链路层     │          ┌───────────────────┐
│   Data Link       │◀────────▶│ 1. 网络接口层     │       ip link
│   (Ethernet)      │          │   Network Access  │       ip neigh (ARP)
├───────────────────┤          │   (Ethernet)      │       ethtool
│ 1. 物理层         │          │                   │
│   Physical        │          └───────────────────┘
└───────────────────┘
```

**实际工作中**，我们主要用 TCP/IP 4 层模型思考：

| TCP/IP 层 | 对应 OSI | 常见问题 | 检查工具 |
|-----------|----------|----------|----------|
| 应用层 | 5-7 | 服务配置错误、证书过期 | curl, 日志 |
| 传输层 | 4 | 端口未监听、防火墙阻断 | ss, tcpdump |
| 网络层 | 3 | 路由错误、IP 冲突 | ping, ip route |
| 网络接口层 | 1-2 | 网线、交换机、MAC 地址 | ip link, ethtool |

### 2.3 数据包的旅程：封装与解封装

当你访问 `https://www.google.com` 时，数据是这样"打包"的：

```
发送端（你的电脑）                              接收端（Google 服务器）
────────────────────────────────────────────────────────────────────

┌─────────────────┐
│   HTTP 请求     │  ← 应用层数据
└────────┬────────┘
         ▼ 封装
┌────────┴────────┐
│ TCP头 │  数据   │  ← 添加端口号 (443)
└────────┬────────┘
         ▼ 封装
┌────────┴────────────────┐
│ IP头  │ TCP头 │  数据   │  ← 添加 IP 地址
└────────┬────────────────┘
         ▼ 封装
┌────────┴──────────────────────┐
│以太网头│ IP头 │ TCP头 │ 数据 │以太网尾│  ← 添加 MAC 地址
└────────┬──────────────────────┘
         ▼
    ══════════════════════════════════════▶ 物理传输（光纤/无线）

                                           ▼ 解封装
                                    ┌──────────────────────────┐
                                    │ 收到以太网帧，剥离帧头   │
                                    │ 收到 IP 包，剥离 IP 头   │
                                    │ 收到 TCP 段，剥离 TCP 头 │
                                    │ 交给应用程序处理         │
                                    └──────────────────────────┘
```

**理解这个过程的意义**：

当 `ping` 成功但 `curl` 失败时，你知道问题在传输层或更高层——可能是端口被挡，或服务没启动。

---

## Step 3 — 动手实验：理解每一层（15 分钟）

### Lab 1：查看网络配置

**查看所有网络接口：**

```bash
ip addr
```

**理解输出**：

```
2: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 9001 qdisc fq_codel state UP
    link/ether 0a:1b:2c:3d:4e:5f brd ff:ff:ff:ff:ff:ff
    inet 10.0.1.52/24 brd 10.0.1.255 scope global dynamic eth0
```

| 字段 | 含义 |
|------|------|
| `eth0` | 接口名（第一个以太网卡） |
| `UP` | 接口已启用 |
| `link/ether` | MAC 地址（L2） |
| `inet 10.0.1.52/24` | IPv4 地址和子网掩码（L3） |
| `mtu 9001` | 最大传输单元（AWS 的 jumbo frame） |

**查看路由表：**

```bash
ip route
```

```
default via 10.0.1.1 dev eth0
10.0.1.0/24 dev eth0 proto kernel scope link src 10.0.1.52
```

| 条目 | 含义 |
|------|------|
| `default via 10.0.1.1` | 默认网关，未知目的地都走这里 |
| `10.0.1.0/24 dev eth0` | 同网段直接通信，不需要网关 |

**查看 DNS 配置：**

```bash
cat /etc/resolv.conf
```

```
nameserver 10.0.1.2
search ap-northeast-1.compute.internal
```

**查看主机名：**

```bash
hostnamectl
```

### Lab 2：理解分层 — 检查监听端口

**列出所有监听的 TCP 端口：**

```bash
ss -tulpn
```

参数含义：
- `-t` : TCP
- `-u` : UDP
- `-l` : 仅显示 LISTEN 状态
- `-p` : 显示进程
- `-n` : 数字格式（不解析域名）

**重点看 Local Address 列**：

| Local Address | 含义 |
|---------------|------|
| `0.0.0.0:22` | 监听所有接口的 22 端口（远程可访问） |
| `127.0.0.1:80` | 仅监听本地回环（远程无法访问！） |
| `:::22` | IPv6 所有接口 |

> **这是常见的排障陷阱**！服务在运行，但绑定了 `127.0.0.1`，远程就连不上。  

**用 curl 检查 HTTP 响应头：**

```bash
# 检查本地服务
curl -I http://localhost 2>/dev/null | head -5

# 检查远程服务
curl -I https://www.google.com 2>/dev/null | head -5
```

观察 HTTP 状态码：
- `200` : 成功
- `301/302` : 重定向
- `403` : 禁止访问
- `404` : 资源不存在
- `500` : 服务器内部错误

### Lab 3：协议观察 — ping 与 traceroute

**观察 TTL（Time To Live）：**

```bash
ping -c 3 8.8.8.8
```

```
64 bytes from 8.8.8.8: icmp_seq=1 ttl=117 time=2.45 ms
```

TTL 值告诉你数据包经过了多少路由器：
- 初始 TTL 通常是 64 或 128
- 每经过一个路由器减 1
- TTL=117 说明经过了约 128-117=11 跳

**追踪路由路径：**

```bash
traceroute -n 8.8.8.8
```

```
 1  10.0.1.1  0.5 ms
 2  * * *
 3  203.0.113.1  5.2 ms
 ...
```

每一行是一个路由器，`* * *` 表示该路由器不回复 ICMP。

> **注意**：云环境（AWS、Azure）中间的路由器通常不回复，这是正常的。  

---

## Step 4 — 核心概念：常见协议与端口（5 分钟）

### 4.1 必须记住的端口号

| 端口 | 协议 | 用途 | 日本 IT 场景 |
|------|------|------|--------------|
| 22 | SSH | 远程登录 | サーバー接続 |
| 80 | HTTP | 网页（明文） | Web サーバー |
| 443 | HTTPS | 网页（加密） | 本番 Web |
| 53 | DNS | 域名解析 | 名前解決 |
| 25/587 | SMTP | 邮件发送 | メール送信 |
| 3306 | MySQL | 数据库 | DB 接続 |
| 5432 | PostgreSQL | 数据库 | DB 接続 |
| 6379 | Redis | 缓存 | キャッシュ |

### 4.2 传输层协议：TCP vs UDP

| 特性 | TCP | UDP |
|------|-----|-----|
| 连接 | 需要建立连接（三次握手） | 无连接 |
| 可靠性 | 保证送达、有序 | 不保证 |
| 速度 | 较慢（有确认机制） | 快 |
| 用途 | HTTP、SSH、数据库 | DNS、视频流、游戏 |

### 4.3 IP 地址与子网

**CIDR 表示法**：

| 表示 | 含义 | 可用地址数 |
|------|------|------------|
| `/32` | 单个地址 | 1 |
| `/24` | 256 地址 | 254（去掉网络和广播） |
| `/16` | 65536 地址 | 65534 |
| `/8` | 1600 万+ | ~1600 万 |

**私有地址范围**（RFC 1918）：

| 范围 | CIDR | 常见用途 |
|------|------|----------|
| 10.0.0.0 - 10.255.255.255 | 10.0.0.0/8 | 云 VPC、大型企业 |
| 172.16.0.0 - 172.31.255.255 | 172.16.0.0/12 | Docker 默认 |
| 192.168.0.0 - 192.168.255.255 | 192.168.0.0/16 | 家庭/小型办公 |

---

## Step 5 — 分层排障思维（5 分钟）

当遇到「つながらない」（连不上）时，按这个顺序检查：

### L3 → L4 → L7 工作流

```
问题："サービスにつながらない"（服务连不上）

Step 1: L3 网络层检查
┌──────────────────────────────────────────────────────────────┐
│  ping <目标IP>                                                │
│  ├─ 成功 → 网络层 OK，继续检查 L4                            │
│  └─ 失败 → 检查路由、防火墙、目标是否在线                    │
│             ip route get <目标IP>                             │
│             traceroute <目标IP>                               │
└──────────────────────────────────────────────────────────────┘
                            │ 成功
                            ▼
Step 2: L4 传输层检查
┌──────────────────────────────────────────────────────────────┐
│  ss -tuln | grep <端口>     # 目标端是否在监听？              │
│  nc -zv <目标IP> <端口>     # 能否建立 TCP 连接？             │
│  ├─ 成功 → 传输层 OK，继续检查 L7                            │
│  └─ 失败 → 检查服务是否启动、监听地址、防火墙规则            │
│             systemctl status <服务>                           │
│             firewall-cmd --list-all                           │
└──────────────────────────────────────────────────────────────┘
                            │ 成功
                            ▼
Step 3: L7 应用层检查
┌──────────────────────────────────────────────────────────────┐
│  curl -v http://<目标>:<端口>/                               │
│  查看应用日志：journalctl -u <服务>                           │
│  ├─ 成功 → 问题解决！                                        │
│  └─ 失败 → 检查应用配置、认证、证书                          │
└──────────────────────────────────────────────────────────────┘
```

### 快速诊断命令清单

```bash
# L3: 网络层
ping -c 3 <目标IP>
ip route get <目标IP>
traceroute <目标IP>

# L4: 传输层
ss -tuln | grep <端口>
nc -zv <目标IP> <端口>
tcpdump -i eth0 port <端口> -nn

# L7: 应用层
curl -v http://<目标>:<端口>/
journalctl -u <服务名> --no-pager -n 50
```

---

## 职场小贴士

### 日本 IT 常用术语

| 日本語 | 中文 | 场景 |
|--------|------|------|
| ネットワーク障害 | 网络故障 | 故障报告 |
| 疎通確認 | 连通性确认 | ping 测试 |
| 切り分け | 问题定位/切分 | 分层排障 |
| エビデンス | 证据 | 截图/日志保存 |
| NW チーム連携 | 与网络团队协作 | 需要升级时 |

### 面试常见问题

**Q: OSI モデルと TCP/IP モデルの違いは？**

A: OSI は 7 層の参照モデル（理論的）、TCP/IP は 4 層の実装モデル（実用的）。実務では TCP/IP ベースで考えます。OSI の 5-7 層は TCP/IP の Application 層に統合されています。

**Q: ネットワーク障害時の切り分け手順は？**

A: L3（ping で疎通確認）→ L4（ss でポート確認）→ L7（curl でアプリ確認）と層ごとに確認します。低い層から順番にチェックすることで、問題の範囲を特定できます。

**Q: TCP と UDP の違いは？**

A: TCP は接続確立（3-way handshake）と再送制御があり信頼性が高い。UDP は軽量で高速だが再送なし。HTTP/SSH は TCP、DNS クエリや動画ストリーミングは UDP が多い。

---

## 本课小结

| 你学到的 | 命令/概念 |
|----------|-----------|
| 快速网络自检 | `ip addr`, `ip route`, `ss -tulpn`, `ping`, `curl` |
| 分层模型 | OSI 7 层 vs TCP/IP 4 层 |
| 排障思维 | L3 → L4 → L7 逐层检查 |
| 常见端口 | 22(SSH), 80(HTTP), 443(HTTPS), 53(DNS) |

**核心理念**：

```
网络问题 ─────► 先定位层级 ─────► 再用对应工具
                   │
                   ├─ L3: ping, traceroute
                   ├─ L4: ss, nc, tcpdump
                   └─ L7: curl, 应用日志
```

---

## 检查清单

在继续下一课之前，确认你能：

- [ ] 使用 `ip addr` 查看接口和 IP 地址
- [ ] 使用 `ip route` 查看路由表，识别默认网关
- [ ] 使用 `ss -tulpn` 查看监听端口
- [ ] 解释 OSI 和 TCP/IP 模型的对应关系
- [ ] 说明 L3 → L4 → L7 排障顺序的原因
- [ ] 列出至少 5 个常见端口及其用途

---

## 延伸阅读

- [TCP/IP 协议栈 - 维基百科](https://zh.wikipedia.org/wiki/TCP/IP协议族)
- [Linux ip 命令 - man page](https://man7.org/linux/man-pages/man8/ip.8.html)
- [ss 命令详解 - man page](https://man7.org/linux/man-pages/man8/ss.8.html)

---

## 下一步

你已经理解了网络基础和分层思维。接下来，让我们学习如何配置网络接口——使用现代的 `ip` 命令和 `nmcli` 工具。

→ [02 · 接口配置](../02-interfaces/)

---

## 系列导航

← [课程首页](../) | [Home](/) | [02 · 接口配置 →](../02-interfaces/)
