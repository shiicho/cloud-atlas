# 03 - IP 路由（IP Routing）

> **目标**：理解 Linux 路由表结构，掌握静态路由配置和路由问题排查  
> **前置**：已完成 [02 - 接口配置](../02-interfaces/)，理解 IP 地址和网络接口  
> **时间**：⚡ 12 分钟（速读）/ 🔬 50 分钟（完整实操）  
> **实战场景**：多网段环境配置、网络故障排查、非对称路由诊断  

---

## 将学到的内容

1. 读懂 `ip route show` 输出的每个字段
2. 理解默认网关（0.0.0.0/0）的作用
3. 掌握最长前缀匹配（Longest Prefix Match）原理
4. 配置临时和永久静态路由
5. 使用 `traceroute` / `mtr` 追踪路由路径
6. 排查常见路由问题（非对称路由、黑洞）

---

## Step 1 - 先跑起来：查看路由表（5 分钟）

> 在学习理论之前，先看看你的系统现在的路由配置。  
> 运行这些命令，观察输出 -- 这就是数据包"找路"的地图。  

```bash
# 查看完整路由表
ip route show

# 查询去往特定目的地的路由
ip route get 8.8.8.8

# 查看默认网关
ip route show default

# 追踪到目标的路由路径
traceroute -n 8.8.8.8
```

**你刚刚查看了系统的路由表！**

每个发出的数据包都要查这张"地图"来决定从哪个网卡、经过哪个网关发送出去。理解路由表是网络排障的核心技能。

---

## Step 1 -- 路由表基础（15 分钟）

### 1.1 什么是路由？

路由就是"数据包去哪里，怎么去"的规则。每台 Linux 机器都有一张路由表，决定：

- **目的地是本地网络？** → 直接发送（不需要网关）
- **目的地是远程网络？** → 通过网关转发
- **不知道该发哪里？** → 发给默认网关

### 1.2 查看路由表

```bash
# 现代方式（推荐）
ip route show

# 老式命令（已弃用但常见）
route -n
```

**示例输出解读：**

```
default via 192.168.1.1 dev eth0 proto dhcp src 192.168.1.100 metric 100
10.0.0.0/8 via 192.168.1.254 dev eth0 proto static metric 50
192.168.1.0/24 dev eth0 proto kernel scope link src 192.168.1.100 metric 100
169.254.0.0/16 dev eth0 scope link metric 1000
```

### 1.3 路由条目字段详解

| 字段 | 含义 | 示例 |
|------|------|------|
| 目的网段 | 匹配的目标地址范围 | `10.0.0.0/8`, `default` (=0.0.0.0/0) |
| `via` | 下一跳网关 IP | `via 192.168.1.1` |
| `dev` | 出接口 | `dev eth0` |
| `proto` | 路由来源 | `kernel`(接口配置), `dhcp`, `static` |
| `scope` | 作用域 | `global`, `link`, `host` |
| `src` | 首选源 IP | `src 192.168.1.100` |
| `metric` | 优先级（越小越优先） | `metric 100` |

### 1.4 默认网关的特殊地位

```bash
# 默认网关 = 0.0.0.0/0 的路由
# 当没有其他更精确的路由匹配时，使用默认网关

ip route show default

# 输出：
# default via 192.168.1.1 dev eth0
```

**为什么叫"默认"？**

- 0.0.0.0/0 匹配所有目的地址
- 但因为前缀最短（/0），优先级最低
- 只有当没有更精确的路由时才会使用

---

## Step 2 -- 最长前缀匹配（10 分钟）

### 2.1 路由选择原理

当有多条路由可能匹配目的地址时，Linux 选择**前缀最长**的那条。

```
┌─────────────────────────────────────────────────────────────────────┐
│                     最长前缀匹配（Longest Prefix Match）              │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  路由表：                                                            │
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │  0.0.0.0/0         via 192.168.1.1   (前缀长度: 0)            │  │
│  │  10.0.0.0/8        via 192.168.1.10  (前缀长度: 8)            │  │
│  │  10.1.0.0/16       via 192.168.1.20  (前缀长度: 16)           │  │
│  │  10.1.1.0/24       via 192.168.1.30  (前缀长度: 24)           │  │
│  └───────────────────────────────────────────────────────────────┘  │
│                                                                      │
│  查询: 10.1.1.50 → 选择 10.1.1.0/24（前缀 24 位，最精确）            │
│  查询: 10.1.2.50 → 选择 10.1.0.0/16（前缀 16 位）                    │
│  查询: 10.2.0.50 → 选择 10.0.0.0/8（前缀 8 位）                      │
│  查询: 8.8.8.8   → 选择 0.0.0.0/0（默认路由）                        │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### 2.2 使用 ip route get 验证

```bash
# 查询特定目的地会使用哪条路由
ip route get 10.1.1.50
# 10.1.1.50 via 192.168.1.30 dev eth0 src 192.168.1.100

ip route get 10.2.0.50
# 10.2.0.50 via 192.168.1.10 dev eth0 src 192.168.1.100

ip route get 8.8.8.8
# 8.8.8.8 via 192.168.1.1 dev eth0 src 192.168.1.100
```

### 2.3 Metric：同前缀长度时的选择

当两条路由有**相同的目的网段**时，metric 值决定优先级：

```bash
# 假设有两条默认路由
# default via 192.168.1.1 dev eth0 metric 100
# default via 192.168.2.1 dev eth1 metric 200

# eth0 的路由会被优先使用（metric 100 < 200）
```

**常见场景**：

- 有线网卡 vs 无线网卡
- 主链路 vs 备用链路
- VPN 隧道 vs 直连

---

## Step 3 -- 静态路由配置（15 分钟）

### Lab 1：路由表解读

```bash
# 1. 查看完整路由表
echo "=== 完整路由表 ==="
ip route show

# 2. 分类查看
echo ""
echo "=== 默认路由 ==="
ip route show default

echo ""
echo "=== 直连路由（无 via）==="
ip route show | grep -v via

echo ""
echo "=== 静态路由（proto static）==="
ip route show proto static

# 3. 查询特定目的地
echo ""
echo "=== 到 8.8.8.8 的路由 ==="
ip route get 8.8.8.8
```

### Lab 2：添加临时静态路由

```bash
# 添加路由（临时，重启丢失）
sudo ip route add 10.10.0.0/16 via 192.168.1.254

# 验证
ip route show 10.10.0.0/16

# 删除路由
sudo ip route del 10.10.0.0/16 via 192.168.1.254

# 指定出接口的路由
sudo ip route add 172.16.0.0/12 via 192.168.1.254 dev eth0

# 调整 metric 值
sudo ip route add 10.0.0.0/8 via 192.168.1.254 metric 10
```

### Lab 3：持久化静态路由（nmcli）

```bash
# 查看当前连接
nmcli con show

# 添加静态路由到指定连接
sudo nmcli con mod "Wired connection 1" +ipv4.routes "10.10.0.0/16 192.168.1.254"

# 多条路由
sudo nmcli con mod "Wired connection 1" +ipv4.routes "10.10.0.0/16 192.168.1.254, 172.16.0.0/12 192.168.1.253"

# 重新激活连接使配置生效
sudo nmcli con up "Wired connection 1"

# 查看配置的路由
nmcli -f ipv4.routes con show "Wired connection 1"

# 删除静态路由
sudo nmcli con mod "Wired connection 1" -ipv4.routes "10.10.0.0/16 192.168.1.254"
```

---

## Step 4 -- 路由追踪与诊断（10 分钟）

### Lab 4：使用 traceroute

```bash
# 基本用法
traceroute 8.8.8.8

# 使用数字显示（不解析 DNS）
traceroute -n 8.8.8.8

# 使用 ICMP（默认是 UDP）
sudo traceroute -I 8.8.8.8

# 使用 TCP（特定端口）
sudo traceroute -T -p 443 8.8.8.8
```

**输出解读**：

```
traceroute to 8.8.8.8 (8.8.8.8), 30 hops max, 60 byte packets
 1  192.168.1.1 (192.168.1.1)  1.234 ms  1.111 ms  1.089 ms
 2  10.0.0.1 (10.0.0.1)  5.678 ms  5.432 ms  5.321 ms
 3  * * *
 4  72.14.215.81 (72.14.215.81)  12.345 ms  12.234 ms  12.123 ms
 5  8.8.8.8 (8.8.8.8)  15.678 ms  15.567 ms  15.456 ms

# 每行含义：
# 跳数  IP地址  延迟（3次探测）
# * * * 表示该跳没有响应（可能是防火墙过滤）
```

### Lab 5：使用 mtr（推荐）

```bash
# 安装 mtr
sudo dnf install mtr -y   # RHEL/CentOS
sudo apt install mtr -y   # Debian/Ubuntu

# 交互式模式
mtr 8.8.8.8

# 报告模式（运行 10 次后输出结果）
mtr -r -c 10 8.8.8.8

# 数字显示
mtr -n 8.8.8.8
```

**mtr 输出解读**：

```
                             My traceroute  [v0.95]
Host: server1             Loss%   Snt   Last   Avg  Best  Wrst StDev
 1. 192.168.1.1           0.0%    10    1.2   1.3   1.1   1.5   0.1
 2. 10.0.0.1              0.0%    10    5.4   5.5   5.2   6.0   0.2
 3. ???                  100.0    10    0.0   0.0   0.0   0.0   0.0
 4. 72.14.215.81          0.0%    10   12.3  12.4  12.1  12.8   0.2
 5. 8.8.8.8               0.0%    10   15.6  15.7  15.4  16.0   0.2

# 关键指标：
# Loss%: 丢包率
# Avg:   平均延迟
# StDev: 标准差（越小越稳定）
```

---

## Step 5 -- 常见问题与反模式

### 反模式 1：临时路由当永久用

```bash
# 错误做法
sudo ip route add 10.0.0.0/8 via 192.168.1.254
# "好了，配完了"
# → 服务器重启后路由消失！

# 正确做法 - 使用 nmcli 持久化
sudo nmcli con mod eth0 +ipv4.routes "10.0.0.0/8 192.168.1.254"
sudo nmcli con up eth0
```

### 反模式 2：只验证单向路由

```bash
# 错误做法
sudo ip route add 10.0.0.0/8 via 192.168.1.254
ping 10.1.1.1  # 成功！
# "路由没问题"

# 问题：对方能回来吗？

# 正确做法
# 1. 验证去程
ping 10.1.1.1

# 2. 验证回程（在 10.1.1.1 上执行）
ip route get 192.168.1.100
ping 192.168.1.100
```

### 非对称路由问题

```
┌─────────────────────────────────────────────────────────────────────┐
│                         非对称路由问题                               │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  服务器（双网卡）                                                     │
│  ┌─────────────────┐                                                 │
│  │    Server A     │                                                 │
│  │  ┌───────────┐  │                                                 │
│  │  │ eth0      │──┼──── 192.168.1.0/24 ──── [Router 1]              │
│  │  │ .100      │  │                              │                  │
│  │  └───────────┘  │                              │                  │
│  │  ┌───────────┐  │                              │                  │
│  │  │ eth1      │──┼──── 192.168.2.0/24 ──── [Router 2]              │
│  │  │ .100      │  │                              │                  │
│  │  └───────────┘  │                              │                  │
│  │  default via 192.168.2.1 (eth1)                │                  │
│  └─────────────────┘                              │                  │
│                                                                      │
│  问题场景：                                                          │
│  1. Client → Router 1 → eth0   请求进入                              │
│  2. Server 响应时查默认路由 → eth1 → Router 2   响应从另一口出        │
│  3. Router 2 的防火墙看到"凭空出现"的响应包 → DROP                    │
│  4. Client 收不到响应 → 连接失败                                     │
│                                                                      │
│  解决方案：策略路由（Policy Routing）或确保对称路径                   │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 职场小贴士（Japan IT Context）

### 网络障害対応（ネットワーク障害対応）

在日本 IT 企业，网络故障排查是运维核心技能：

| 日语术语 | 含义 | 场景 |
|----------|------|------|
| 疎通確認 | 连通性确认 | 排障第一步：ping 测试 |
| 経路確認 | 路由确认 | 使用 traceroute 确认路径 |
| 切り分け | 问题切分 | 定位问题在哪个网段/设备 |
| ルーティング | 路由 | 路由配置相关工作 |
| デフォルトゲートウェイ | 默认网关 | 基础网络配置 |

### 常用排障流程

```bash
# 日本企业典型的网络障害対応流程

# 1. 疎通確認（连通性确认）
ping -c 3 <目标IP>

# 2. 経路確認（路由确认）
traceroute -n <目标IP>
mtr -r -c 10 <目标IP>

# 3. ルート確認（本地路由确认）
ip route get <目标IP>

# 4. エビデンス収集（证据收集）
ip route show > /tmp/evidence-route-$(date +%Y%m%d%H%M%S).txt
mtr -r -c 10 <目标IP> > /tmp/evidence-mtr-$(date +%Y%m%d%H%M%S).txt
```

---

## 面试问题（Interview Prep）

### Q1: デフォルトゲートウェイとは何ですか？

**A:** デフォルトゲートウェイは 0.0.0.0/0 へのルートで、より具体的なルートがない場合に使用されます。すべての未知の宛先へのパケットは、このゲートウェイに転送されます。

### Q2: 非対称ルーティングの問題とは？

**A:** リクエストとレスポンスが異なる経路を通る状態です。ステートフルファイアウォールは、セッションを追跡できないため、レスポンスパケットをドロップします。解決策は、ポリシールーティングまたは対称経路の確保です。

### Q3: ip route add と nmcli の違いは？

**A:** `ip route add` は一時的で再起動後に消えます。`nmcli con mod` は永続的で、NetworkManager が設定を保存します。本番環境では必ず永続化設定を使います。

### Q4: traceroute で * * * が表示される原因は？

**A:** 複数の原因があります：ファイアウォールが ICMP/UDP をドロップ、ルータが TTL exceeded を返さない設定、またはネットワーク障害。TCP モード（-T）で再試行すると通る場合もあります。

---

## 检查清单

完成本课后，你应该能够：

- [ ] 读懂 `ip route show` 输出的每个字段
- [ ] 解释 default、via、dev、proto、metric 的含义
- [ ] 理解最长前缀匹配原理
- [ ] 使用 `ip route get` 验证特定目的地的路由
- [ ] 添加和删除临时静态路由
- [ ] 使用 nmcli 配置永久静态路由
- [ ] 使用 traceroute/mtr 追踪路由路径
- [ ] 解读 traceroute/mtr 输出
- [ ] 识别和解释非对称路由问题
- [ ] 在故障排查中正确使用路由诊断工具

---

## 本课小结

| 概念 | 命令 | 记忆点 |
|------|------|--------|
| 查看路由表 | `ip route show` | 默认命令 |
| 查询路由 | `ip route get <IP>` | 验证路由选择 |
| 临时路由 | `ip route add/del` | 重启丢失 |
| 永久路由 | `nmcli con mod` | 配置持久化 |
| 路由追踪 | `traceroute -n` | 查看路径 |
| 实时追踪 | `mtr -r` | 丢包和延迟 |
| 默认网关 | `0.0.0.0/0` | 最后的选择 |
| 最长前缀 | LPM | 最精确优先 |
| Metric | 优先级数值 | 越小越优先 |

---

## 延伸阅读

- [Linux Advanced Routing & Traffic Control HOWTO](https://lartc.org/)
- [iproute2 documentation](https://wiki.linuxfoundation.org/networking/iproute2)
- [mtr manual](https://www.bitwizard.nl/mtr/)
- 上一课：[02 - 接口配置](../02-interfaces/) -- 网络接口和 IP 配置
- 下一课：[04 - DNS 配置](../04-dns/) -- systemd-resolved 和 DNS 排障

---

## 系列导航

[← 02 - 接口配置](../02-interfaces/) | [系列首页](../) | [04 - DNS 配置 →](../04-dns/)
