# 09 - mdadm å®æˆ˜ï¼ˆSoftware RAID with mdadmï¼‰

> **ç›®æ ‡**ï¼šæŒæ¡è½¯ä»¶ RAID çš„åˆ›å»ºã€ç›‘æ§å’Œæ•…éšœæ¢å¤ï¼Œèƒ½å¤Ÿç‹¬ç«‹å¤„ç† RAID é™çº§çŠ¶æ€  
> **å‰ç½®**ï¼šå®Œæˆ [08 - RAID æ¦‚å¿µ](../08-raid-concepts/) è¯¾ç¨‹  
> **æ—¶é—´**ï¼šâš¡ 25 åˆ†é’Ÿï¼ˆé€Ÿè¯»ï¼‰/ ğŸ”¬ 90 åˆ†é’Ÿï¼ˆå®Œæ•´å®æ“ï¼‰  
> **å®æˆ˜åœºæ™¯**ï¼šå‡Œæ™¨ 3 ç‚¹æ”¶åˆ°å‘Šè­¦ï¼Œ/proc/mdstat æ˜¾ç¤º [U_]ï¼Œéœ€è¦ç´§æ€¥å¤„ç† RAID é™çº§  

---

## å°†å­¦åˆ°çš„å†…å®¹

1. ä½¿ç”¨ mdadm åˆ›å»ºè½¯ä»¶ RAID é˜µåˆ—
2. ç›‘æ§ RAID çŠ¶æ€ï¼ˆ/proc/mdstatã€mdadm --detailï¼‰
3. å¤„ç† RAID é™çº§çŠ¶æ€å’Œç£ç›˜æ›´æ¢
4. é…ç½® RAID æŒä¹…åŒ–ï¼ˆmdadm.confï¼‰

---

## å®éªŒç¯å¢ƒå‡†å¤‡

æœ¬è¯¾ä½¿ç”¨ loop è®¾å¤‡æ¨¡æ‹Ÿå¤šç£ç›˜ç¯å¢ƒã€‚åœ¨ä»»ä½• Linux ç³»ç»Ÿä¸Šéƒ½å¯ä»¥å®Œæˆï¼š

```bash
# åˆ›å»º 3 ä¸ªè™šæ‹Ÿç£ç›˜ï¼ˆ1GB æ¯ä¸ªï¼‰
for i in 1 2 3; do
  fallocate -l 1G /tmp/disk$i.img
  sudo losetup /dev/loop$i /tmp/disk$i.img
done

# éªŒè¯
lsblk /dev/loop1 /dev/loop2 /dev/loop3
```

> **è¯´æ˜**ï¼šloop3 å°†ä½œä¸º hot spareï¼ˆçƒ­å¤‡ç›˜ï¼‰ä½¿ç”¨ã€‚  

---

## Step 1 -- åˆ›å»º RAID 1 é˜µåˆ—ï¼ˆ20 åˆ†é’Ÿï¼‰

### 1.1 ä½¿ç”¨ mdadm åˆ›å»º RAID 1

RAID 1ï¼ˆé•œåƒï¼‰æ˜¯æœ€ç®€å•ã€æœ€å¯é çš„å†—ä½™æ–¹æ¡ˆï¼š

```bash
# åˆ›å»º RAID 1 é˜µåˆ—ï¼Œä½¿ç”¨ loop1 å’Œ loop2
sudo mdadm --create /dev/md0 \
  --level=1 \
  --raid-devices=2 \
  /dev/loop1 /dev/loop2

# ç¡®è®¤åˆ›å»º
# ç³»ç»Ÿä¼šæç¤º: Continue creating array? è¾“å…¥ y
```

**å‚æ•°è§£é‡Š**ï¼š

| å‚æ•° | å«ä¹‰ |
|------|------|
| `--create /dev/md0` | åˆ›å»ºåä¸º md0 çš„ RAID è®¾å¤‡ |
| `--level=1` | RAID çº§åˆ« 1ï¼ˆé•œåƒï¼‰ |
| `--raid-devices=2` | ä½¿ç”¨ 2 ä¸ªè®¾å¤‡ |

### 1.2 éªŒè¯ RAID çŠ¶æ€

```bash
# æŸ¥çœ‹ RAID çŠ¶æ€ï¼ˆæœ€å¸¸ç”¨ï¼‰
cat /proc/mdstat
```

è¾“å‡ºç¤ºä¾‹ï¼š

```
Personalities : [raid1]
md0 : active raid1 loop2[1] loop1[0]
      1046528 blocks super 1.2 [2/2] [UU]
      [========>............]  resync = 42.0% (439296/1046528)
```

**å…³é”®æŒ‡æ ‡è§£è¯»**ï¼š

| æŒ‡æ ‡ | å«ä¹‰ |
|------|------|
| `[2/2]` | æœŸæœ› 2 ä¸ªè®¾å¤‡ / å®é™… 2 ä¸ªæ­£å¸¸ |
| `[UU]` | ä¸¤ä¸ªè®¾å¤‡éƒ½ Upï¼ˆæ­£å¸¸ï¼‰ |
| `[U_]` | ç¬¬äºŒä¸ªè®¾å¤‡æ•…éšœï¼ˆé™çº§ï¼‰ |
| `resync` | åˆå§‹åŒæ­¥è¿›åº¦ |

### 1.3 ç­‰å¾…åŒæ­¥å®Œæˆ

```bash
# ç›‘æ§åŒæ­¥è¿›åº¦
watch -n 1 cat /proc/mdstat
```

åŒæ­¥å®Œæˆåæ˜¾ç¤ºï¼š

```
md0 : active raid1 loop2[1] loop1[0]
      1046528 blocks super 1.2 [2/2] [UU]
```

### 1.4 æ ¼å¼åŒ–å’ŒæŒ‚è½½

```bash
# åˆ›å»ºæ–‡ä»¶ç³»ç»Ÿ
sudo mkfs.ext4 /dev/md0

# åˆ›å»ºæŒ‚è½½ç‚¹å¹¶æŒ‚è½½
sudo mkdir -p /mnt/raid
sudo mount /dev/md0 /mnt/raid

# éªŒè¯
df -h /mnt/raid
```

---

## Step 2 -- RAID çŠ¶æ€ç›‘æ§ï¼ˆ15 åˆ†é’Ÿï¼‰

### 2.1 /proc/mdstat è¯¦è§£

`/proc/mdstat` æ˜¯ RAID çŠ¶æ€çš„å®æ—¶å¿«ç…§ï¼š

```bash
cat /proc/mdstat
```

```
Personalities : [raid1]
md0 : active raid1 loop2[1] loop1[0]
      1046528 blocks super 1.2 [2/2] [UU]

unused devices: <none>
```

**çŠ¶æ€æ ‡è®°è¯¦è§£**ï¼š

| æ ‡è®° | çŠ¶æ€ | å«ä¹‰ |
|------|------|------|
| `[UU]` | æ­£å¸¸ | æ‰€æœ‰è®¾å¤‡å¥åº· |
| `[U_]` | é™çº§ | ç¬¬ 2 ä¸ªè®¾å¤‡æ•…éšœ |
| `[_U]` | é™çº§ | ç¬¬ 1 ä¸ªè®¾å¤‡æ•…éšœ |
| `[__]` | å±é™© | æ‰€æœ‰è®¾å¤‡æ•…éšœ |

### 2.2 mdadm --detail è¯¦ç»†ä¿¡æ¯

```bash
sudo mdadm --detail /dev/md0
```

è¾“å‡ºç¤ºä¾‹ï¼š

```
/dev/md0:
           Version : 1.2
     Creation Time : Sat Jan  4 10:30:00 2026
        Raid Level : raid1
        Array Size : 1046528 (1022.00 MiB 1071.64 MB)
     Used Dev Size : 1046528 (1022.00 MiB 1071.64 MB)
      Raid Devices : 2
     Total Devices : 2
       Persistence : Superblock is persistent

             State : clean
    Active Devices : 2
   Working Devices : 2
    Failed Devices : 0
     Spare Devices : 0

    Number   Major   Minor   RaidDevice State
       0       7        1        0      active sync   /dev/loop1
       1       7        2        1      active sync   /dev/loop2
```

**é‡ç‚¹å…³æ³¨**ï¼š

| å­—æ®µ | æ­£å¸¸å€¼ | å‘Šè­¦å€¼ |
|------|--------|--------|
| State | clean | degraded, recovering |
| Active Devices | = Raid Devices | < Raid Devices |
| Failed Devices | 0 | > 0 |

### 2.3 ç›‘æ§è„šæœ¬ç¤ºä¾‹

```bash
#!/bin/bash
# raid-check.sh - RAID çŠ¶æ€æ£€æŸ¥è„šæœ¬

if grep -q '\[U_\]\|\_U\]' /proc/mdstat; then
  echo "è­¦å‘Š: RAID å¤„äºé™çº§çŠ¶æ€!"
  cat /proc/mdstat
  exit 1
fi

echo "RAID çŠ¶æ€æ­£å¸¸"
cat /proc/mdstat
```

---

## Step 3 -- mdadm.conf æŒä¹…åŒ–é…ç½®ï¼ˆ15 åˆ†é’Ÿï¼‰

### 3.1 ä¸ºä»€ä¹ˆéœ€è¦ mdadm.confï¼Ÿ

ç³»ç»Ÿé‡å¯åï¼ŒRAID é˜µåˆ—éœ€è¦é‡æ–°ç»„è£…ã€‚mdadm.conf å‘Šè¯‰ç³»ç»Ÿï¼š
- æœ‰å“ªäº› RAID é˜µåˆ—
- æ¯ä¸ªé˜µåˆ—ç”±å“ªäº›è®¾å¤‡ç»„æˆ
- é˜µåˆ—åº”è¯¥è‡ªåŠ¨ç»„è£…

### 3.2 ç”Ÿæˆé…ç½®

```bash
# æ‰«æç°æœ‰ RAID é˜µåˆ—
sudo mdadm --detail --scan

# è¾“å‡ºç¤ºä¾‹ï¼š
# ARRAY /dev/md0 metadata=1.2 name=hostname:0 UUID=xxxxxxxx:xxxxxxxx:xxxxxxxx:xxxxxxxx

# è¿½åŠ åˆ° mdadm.conf
sudo mdadm --detail --scan >> /etc/mdadm/mdadm.conf
# æˆ–è€…ï¼ˆå–å†³äºå‘è¡Œç‰ˆï¼‰
sudo mdadm --detail --scan >> /etc/mdadm.conf
```

### 3.3 mdadm.conf æ ¼å¼

```bash
# /etc/mdadm/mdadm.conf (Debian/Ubuntu)
# /etc/mdadm.conf (RHEL/CentOS)

# é‚®ä»¶é€šçŸ¥åœ°å€
MAILADDR root@localhost

# RAID é˜µåˆ—å®šä¹‰
ARRAY /dev/md0 metadata=1.2 UUID=xxxxxxxx:xxxxxxxx:xxxxxxxx:xxxxxxxx
```

### 3.4 æ›´æ–° initramfs

é…ç½®æ›´æ”¹åéœ€è¦æ›´æ–°å¯åŠ¨é•œåƒï¼š

```bash
# Debian/Ubuntu
sudo update-initramfs -u

# RHEL/CentOS
sudo dracut -f
```

> **é‡è¦**ï¼šä¸æ›´æ–° initramfsï¼Œé‡å¯å RAID å¯èƒ½æ— æ³•è‡ªåŠ¨ç»„è£…ï¼  

---

## Step 4 -- ç¾éš¾å®éªŒï¼šRAID é™çº§æ¢å¤ï¼ˆ30 åˆ†é’Ÿï¼‰

è¿™æ˜¯æœ¬è¯¾æœ€é‡è¦çš„å®éªŒã€‚æˆ‘ä»¬å°†æ¨¡æ‹ŸçœŸå®çš„ç£ç›˜æ•…éšœåœºæ™¯ã€‚

### 4.1 åœºæ™¯æè¿°

**å‡Œæ™¨ 3 ç‚¹å‘Šè­¦**ï¼š
```
[ALERT] RAID degraded on server-prod-01
/proc/mdstat shows [U_]
```

åœ¨æ—¥æœ¬ IT è¿ç»´ä¸­ï¼Œè¿™å±äº P1ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰éšœå®³ã€‚

### 4.2 æ¨¡æ‹Ÿç£ç›˜æ•…éšœ

```bash
# å…ˆç¡®è®¤å½“å‰çŠ¶æ€æ­£å¸¸
cat /proc/mdstat
# åº”è¯¥æ˜¾ç¤º [UU]

# æ¨¡æ‹Ÿ loop2 æ•…éšœ
sudo mdadm --manage /dev/md0 --fail /dev/loop2

# æ£€æŸ¥çŠ¶æ€
cat /proc/mdstat
```

**ä½ ä¼šçœ‹åˆ°**ï¼š

```
md0 : active raid1 loop2[1](F) loop1[0]
      1046528 blocks super 1.2 [2/1] [U_]
```

å…³é”®å˜åŒ–ï¼š
- `[2/1]` - æœŸæœ› 2 ä¸ªï¼Œåªæœ‰ 1 ä¸ªæ­£å¸¸
- `[U_]` - ç¬¬äºŒä¸ªè®¾å¤‡æ•…éšœ
- `(F)` - Failed æ ‡è®°

### 4.3 ç¡®è®¤æ•…éšœè¯¦æƒ…

```bash
sudo mdadm --detail /dev/md0
```

```
             State : clean, degraded
    Active Devices : 1
   Working Devices : 1
    Failed Devices : 1
     Spare Devices : 0

    Number   Major   Minor   RaidDevice State
       0       7        1        0      active sync   /dev/loop1
       -       0        0        1      removed
       1       7        2        -      faulty   /dev/loop2
```

### 4.4 ç§»é™¤æ•…éšœç£ç›˜

```bash
# ä»é˜µåˆ—ç§»é™¤æ•…éšœç£ç›˜
sudo mdadm --manage /dev/md0 --remove /dev/loop2

# ç¡®è®¤ç§»é™¤
cat /proc/mdstat
sudo mdadm --detail /dev/md0
```

### 4.5 æ·»åŠ æ–°ç£ç›˜

åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œè¿™ä¸€æ­¥æ˜¯æ›´æ¢ç‰©ç†ç£ç›˜åæ‰§è¡Œã€‚æˆ‘ä»¬ç”¨ loop3 æ¨¡æ‹Ÿæ–°ç£ç›˜ï¼š

```bash
# æ·»åŠ æ–°ç£ç›˜åˆ°é˜µåˆ—
sudo mdadm --manage /dev/md0 --add /dev/loop3

# ç«‹å³æ£€æŸ¥çŠ¶æ€
cat /proc/mdstat
```

ä½ ä¼šçœ‹åˆ°é‡å»ºè¿‡ç¨‹ï¼š

```
md0 : active raid1 loop3[2] loop1[0]
      1046528 blocks super 1.2 [2/1] [U_]
      [======>.............]  recovery = 35.2% (368640/1046528) finish=0.2min speed=46080K/sec
```

### 4.6 ç›‘æ§é‡å»ºè¿›åº¦

```bash
# å®æ—¶ç›‘æ§
watch -n 1 cat /proc/mdstat
```

é‡å»ºå®Œæˆåï¼š

```
md0 : active raid1 loop3[2] loop1[0]
      1046528 blocks super 1.2 [2/2] [UU]
```

### 4.7 å®Œæ•´æ¢å¤æµç¨‹æ€»ç»“

```
æ•…éšœå‘ç°
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ cat /proc/mdstat                    â”‚
â”‚ ç¡®è®¤ [U_] é™çº§çŠ¶æ€                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ mdadm --detail /dev/mdX             â”‚
â”‚ è¯†åˆ«æ•…éšœç£ç›˜                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ mdadm --manage --fail --remove      â”‚
â”‚ æ ‡è®°å¹¶ç§»é™¤æ•…éšœç›˜                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ï¼ˆç‰©ç†æ›´æ¢ç£ç›˜ï¼‰                    â”‚
â”‚ åˆ†åŒºä¸æ—§ç›˜ä¸€è‡´                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ mdadm --manage --add /dev/newdisk   â”‚
â”‚ æ·»åŠ æ–°ç›˜ï¼Œè§¦å‘é‡å»º                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ watch cat /proc/mdstat              â”‚
â”‚ ç›‘æ§é‡å»ºè¿›åº¦è‡³ [UU]                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Step 5 -- Hot Spare é…ç½®ï¼ˆ15 åˆ†é’Ÿï¼‰

### 5.1 ä»€ä¹ˆæ˜¯ Hot Spareï¼Ÿ

Hot Spareï¼ˆçƒ­å¤‡ç›˜ï¼‰æ˜¯é˜µåˆ—ä¸­çš„å¤‡ç”¨ç£ç›˜ï¼š
- å¹³æ—¶ä¸å­˜å‚¨æ•°æ®
- å½“æˆå‘˜ç›˜æ•…éšœæ—¶è‡ªåŠ¨æ¥æ›¿
- å¤§å¹…ç¼©çŸ­æ¢å¤æ—¶é—´

### 5.2 æ·»åŠ  Hot Spare

```bash
# å…ˆåˆ›å»ºä¸€ä¸ªæ–°çš„ loop è®¾å¤‡ä½œä¸ºçƒ­å¤‡
fallocate -l 1G /tmp/disk4.img
sudo losetup /dev/loop4 /tmp/disk4.img

# æ·»åŠ ä¸º spare
sudo mdadm --manage /dev/md0 --add-spare /dev/loop4

# æˆ–è€…ç›´æ¥ --addï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨åˆ¤æ–­è§’è‰²
sudo mdadm --manage /dev/md0 --add /dev/loop4
```

### 5.3 éªŒè¯ Hot Spare

```bash
sudo mdadm --detail /dev/md0
```

```
             State : clean
     Spare Devices : 1

    Number   Major   Minor   RaidDevice State
       0       7        1        0      active sync   /dev/loop1
       2       7        3        1      active sync   /dev/loop3
       3       7        4        -      spare   /dev/loop4
```

### 5.4 æµ‹è¯•è‡ªåŠ¨é‡å»º

```bash
# æ¨¡æ‹Ÿ loop1 æ•…éšœ
sudo mdadm --manage /dev/md0 --fail /dev/loop1

# ç«‹å³æ£€æŸ¥
cat /proc/mdstat
```

ä½ ä¼šçœ‹åˆ° Hot Spare è‡ªåŠ¨å¼€å§‹é‡å»ºï¼š

```
md0 : active raid1 loop4[3] loop3[2] loop1[0](F)
      1046528 blocks super 1.2 [2/1] [_U]
      [=>...................]  recovery =  8.0% (83968/1046528) finish=0.4min
```

loop4ï¼ˆçƒ­å¤‡ç›˜ï¼‰è‡ªåŠ¨åŠ å…¥é‡å»ºï¼

---

## åæ¨¡å¼ï¼šæ²¡æœ‰é…ç½®çƒ­å¤‡ç›˜

### é—®é¢˜åœºæ™¯

```
æ—¶é—´çº¿ï¼š
00:00  ç£ç›˜ A æ•…éšœï¼ŒRAID é™çº§ [U_]
00:15  æ”¶åˆ°å‘Šè­¦
02:00  è¿ç»´äººå‘˜åˆ°åœº
02:30  æ–°ç£ç›˜åˆ°è´§
03:00  æ›´æ¢å®Œæˆï¼Œå¼€å§‹é‡å»º
06:00  é‡å»ºå®Œæˆ

é£é™©çª—å£ï¼š6 å°æ—¶å¤„äºé™çº§çŠ¶æ€
å¦‚æœæ­¤æœŸé—´ç¬¬äºŒå—ç›˜æ•…éšœ = æ•°æ®å…¨éƒ¨ä¸¢å¤±
```

### æ­£ç¡®åšæ³•

```
æ—¶é—´çº¿ï¼š
00:00  ç£ç›˜ A æ•…éšœï¼ŒRAID é™çº§ [U_]
00:01  Hot Spare è‡ªåŠ¨æ¥æ›¿ï¼Œå¼€å§‹é‡å»º
03:00  é‡å»ºå®Œæˆï¼Œæ¢å¤ [UU]

æ¬¡æ—¥ï¼šè¡¥å……æ–°çš„çƒ­å¤‡ç›˜
```

> **æ—¥æœ¬ IT è¿ç»´å®è·µ**ï¼šç”Ÿäº§ç¯å¢ƒçš„ RAID 5/6/10 é˜µåˆ—é€šå¸¸é…ç½®è‡³å°‘ 1 ä¸ªçƒ­å¤‡ç›˜ã€‚  
> è¿™æ˜¯ SLAï¼ˆæœåŠ¡ç­‰çº§åè®®ï¼‰çš„è¦æ±‚ã€‚  

---

## èŒåœºå°è´´å£«ï¼ˆJapan IT Contextï¼‰

### éšœå®³å¯¾å¿œè¡“èª

| æ—¥è¯­æœ¯è¯­ | å«ä¹‰ | åœºæ™¯ |
|----------|------|------|
| RAID ç¸®é€€ | RAID degraded | [U_] çŠ¶æ€ |
| ãƒ‡ã‚£ã‚¹ã‚¯éšœå®³ | ç£ç›˜æ•…éšœ | éœ€è¦æ›´æ¢ç¡¬ä»¶ |
| ãƒ›ãƒƒãƒˆã‚¹ãƒšã‚¢ | Hot spare | çƒ­å¤‡ç›˜ |
| ãƒªãƒ“ãƒ«ãƒ‰ | Rebuild | é‡å»ºè¿‡ç¨‹ |
| éšœå®³ä¸€æ¬¡å¯¾å¿œ | åˆæ­¥æ•…éšœå“åº” | ç¡®è®¤çŠ¶æ€ã€ä¸ŠæŠ¥ |

### é¢è¯•å¸¸è§é—®é¢˜

**Q: RAID ãŒç¸®é€€çŠ¶æ…‹ã«ãªã£ãŸå ´åˆã€ã©ã†å¯¾å¿œã—ã¾ã™ã‹ï¼Ÿ**

A: ã¾ãš `/proc/mdstat` ã¨ `mdadm --detail` ã§çŠ¶æ…‹ã‚’ç¢ºèªã—ã¾ã™ã€‚éšœå®³ãƒ‡ã‚£ã‚¹ã‚¯ã‚’ç‰¹å®šã—ã€`mdadm --fail --remove` ã§å®‰å…¨ã«å–ã‚Šå¤–ã—ã¾ã™ã€‚æ–°ã—ã„ãƒ‡ã‚£ã‚¹ã‚¯ã‚’åŒã˜ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³æ§‹æˆã§æº–å‚™ã—ã€`mdadm --add` ã§è¿½åŠ ã—ã¾ã™ã€‚`/proc/mdstat` ã§ãƒªãƒ“ãƒ«ãƒ‰é€²æ—ã‚’ç›£è¦–ã—ã€å®Œäº†å¾Œã« `mdadm.conf` ã‚’æ›´æ–°ã—ã¦ `update-initramfs` ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

**Q: ãƒ›ãƒƒãƒˆã‚¹ãƒšã‚¢ã®é‡è¦æ€§ã‚’èª¬æ˜ã—ã¦ãã ã•ã„ã€‚**

A: ãƒ›ãƒƒãƒˆã‚¹ãƒšã‚¢ã¯ãƒ€ã‚¦ãƒ³ã‚¿ã‚¤ãƒ ã‚’å¤§å¹…ã«å‰Šæ¸›ã—ã¾ã™ã€‚ãƒ‡ã‚£ã‚¹ã‚¯éšœå®³ç™ºç”Ÿæ™‚ã€äººé–“ãŒå¯¾å¿œã™ã‚‹å‰ã«è‡ªå‹•ã§ãƒªãƒ“ãƒ«ãƒ‰ã‚’é–‹å§‹ã™ã‚‹ãŸã‚ã€äºŒæ¬¡éšœå®³ã®ãƒªã‚¹ã‚¯çª“å£ã‚’æœ€å°åŒ–ã§ãã¾ã™ã€‚ç‰¹ã«æ·±å¤œã‚„ä¼‘æ—¥ã®éšœå®³å¯¾å¿œã§ã¯ã€ãƒ›ãƒƒãƒˆã‚¹ãƒšã‚¢ãŒ SLA ç¶­æŒã®éµã¨ãªã‚Šã¾ã™ã€‚

---

## æœ¬è¯¾å°ç»“

| æ“ä½œ | ã‚³ãƒãƒ³ãƒ‰ | ç”¨é€” |
|------|----------|------|
| åˆ›å»º RAID | `mdadm --create` | åˆå§‹åŒ–é˜µåˆ— |
| æŸ¥çœ‹çŠ¶æ€ | `cat /proc/mdstat` | å¿«é€ŸçŠ¶æ€æ£€æŸ¥ |
| è¯¦ç»†ä¿¡æ¯ | `mdadm --detail` | æ•…éšœè¯Šæ–­ |
| æ ‡è®°æ•…éšœ | `mdadm --fail` | æ•…éšœå¤„ç†ç¬¬ä¸€æ­¥ |
| ç§»é™¤ç£ç›˜ | `mdadm --remove` | å®‰å…¨ç§»é™¤æ•…éšœç›˜ |
| æ·»åŠ ç£ç›˜ | `mdadm --add` | æ·»åŠ æ–°ç›˜/çƒ­å¤‡ |
| æŒä¹…åŒ– | `mdadm --detail --scan` | æ›´æ–° mdadm.conf |

**æ ¸å¿ƒè¦ç‚¹**ï¼š

1. `[UU]` = æ­£å¸¸ï¼Œ`[U_]` = é™çº§ï¼Œéœ€è¦ç«‹å³å¤„ç†
2. æ¢å¤æµç¨‹ï¼šfail -> remove -> add -> ç›‘æ§é‡å»º
3. ç”Ÿäº§ç¯å¢ƒåŠ¡å¿…é…ç½® hot spare
4. æ¯æ¬¡å˜æ›´åæ›´æ–° mdadm.conf å’Œ initramfs

---

## æ£€æŸ¥æ¸…å•

å®Œæˆæœ¬è¯¾åï¼Œç¡®è®¤ä½ èƒ½å¤Ÿï¼š

- [ ] ä½¿ç”¨ `mdadm --create` åˆ›å»º RAID 1 é˜µåˆ—
- [ ] è¯»æ‡‚ `/proc/mdstat` çš„çŠ¶æ€æ ‡è®°ï¼ˆ[UU] vs [U_]ï¼‰
- [ ] ä½¿ç”¨ `mdadm --detail` è¯Šæ–­ RAID é—®é¢˜
- [ ] å®Œæˆ RAID é™çº§æ¢å¤å…¨æµç¨‹ï¼ˆfail, remove, addï¼‰
- [ ] é…ç½® mdadm.conf å®ç°æŒä¹…åŒ–
- [ ] è§£é‡Š hot spare çš„ä½œç”¨å’Œé…ç½®æ–¹æ³•
- [ ] ç›‘æ§ RAID é‡å»ºè¿›åº¦

---

## å®éªŒæ¸…ç†

```bash
# å¸è½½æ–‡ä»¶ç³»ç»Ÿ
sudo umount /mnt/raid

# åœæ­¢ RAID é˜µåˆ—
sudo mdadm --stop /dev/md0

# æ¸…é™¤ RAID è¶…çº§å—
sudo mdadm --zero-superblock /dev/loop1 /dev/loop2 /dev/loop3 /dev/loop4 2>/dev/null

# é‡Šæ”¾ loop è®¾å¤‡
for i in 1 2 3 4; do
  sudo losetup -d /dev/loop$i 2>/dev/null
done

# åˆ é™¤æ¨¡æ‹Ÿç£ç›˜æ–‡ä»¶
rm -f /tmp/disk{1,2,3,4}.img
```

---

## å»¶ä¼¸é˜…è¯»

- [mdadm man page](https://man7.org/linux/man-pages/man8/mdadm.8.html)
- [Linux RAID Wiki](https://raid.wiki.kernel.org/)
- [Red Hat: Managing RAID](https://docs.redhat.com/en/documentation/red_hat_enterprise_linux/8/html/managing_storage_devices/managing-raid_managing-storage-devices)
- ä¸Šä¸€è¯¾ï¼š[08 - RAID æ¦‚å¿µ](../08-raid-concepts/) -- RAID çº§åˆ«é€‰æ‹©ä¸åŸç†
- ä¸‹ä¸€è¯¾ï¼š[10 - å¤‡ä»½ç­–ç•¥](../10-backup-strategies/) -- tar, rsync ä¸ 3-2-1 è§„åˆ™

---

## ç³»åˆ—å¯¼èˆª

[<-- 08 - RAID æ¦‚å¿µ](../08-raid-concepts/) | [ç³»åˆ—é¦–é¡µ](../) | [10 - å¤‡ä»½ç­–ç•¥ -->](../10-backup-strategies/)
