# 02 - Password and Account Management / å¯†ç ä¸è´¦æˆ·ç®¡ç†

> **ç›®æ ‡**ï¼šæŒæ¡ Linux å¯†ç ç®¡ç†å’Œè´¦æˆ·å®‰å…¨é…ç½®  
> **å‰ç½®**ï¼šå®Œæˆ Lesson 01ï¼ˆç”¨æˆ·ä¸ç”¨æˆ·ç»„ï¼‰  
> **æ—¶é—´**ï¼šâš¡ 25 åˆ†é’Ÿï¼ˆé€Ÿè¯»ï¼‰/ ğŸ”¬ 90 åˆ†é’Ÿï¼ˆå®Œæ•´å®æ“ï¼‰  
> **å®æˆ˜åœºæ™¯**ï¼šå‘˜å·¥å…¥èŒ/ç¦»èŒæ—¶çš„è´¦æˆ·å®‰å…¨ç®¡ç†  

---

## å°†å­¦åˆ°çš„å†…å®¹

1. ç†è§£ `/etc/shadow` æ–‡ä»¶ç»“æ„å’Œå¯†ç å“ˆå¸Œ
2. ä½¿ç”¨ `chage` é…ç½®å¯†ç è€åŒ–ç­–ç•¥
3. ä½¿ç”¨ `passwd` é”å®š/è§£é”è´¦æˆ·
4. åŒºåˆ† **è´¦æˆ·é”å®š** å’Œ **å¯†ç é”å®š**
5. é…ç½®ç™»å½• shellï¼ˆnologin vs falseï¼‰
6. ä½¿ç”¨ `lastlog` å’Œ `faillog` å®¡è®¡è´¦æˆ·
7. é…ç½® PAM å®ç°å¯†ç å¤æ‚åº¦å’Œè´¦æˆ·é”å®šç­–ç•¥

---

## å…ˆè·‘èµ·æ¥ï¼ï¼ˆ5 åˆ†é’Ÿï¼‰

> åœ¨å­¦ä¹ ç†è®ºä¹‹å‰ï¼Œå…ˆä½“éªŒå¯†ç ç®¡ç†çš„å¨åŠ›ã€‚  
> éœ€è¦ root æƒé™è¿è¡Œä»¥ä¸‹å‘½ä»¤ã€‚  

```bash
# æŸ¥çœ‹å½“å‰ç”¨æˆ·çš„å¯†ç è€åŒ–ä¿¡æ¯
sudo chage -l $(whoami)

# æŸ¥çœ‹ shadow æ–‡ä»¶ä¸­çš„å¯†ç å“ˆå¸Œï¼ˆå‰å‡ è¡Œï¼‰
sudo head -3 /etc/shadow

# æŸ¥çœ‹æœ€è¿‘ç™»å½•è®°å½•
lastlog | head -10

# æŸ¥çœ‹å¤±è´¥çš„ç™»å½•å°è¯•ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
sudo faillog -a 2>/dev/null | head -10
```

**ä½ åˆšåˆšæŸ¥çœ‹äº† Linux å¯†ç ç®¡ç†çš„æ ¸å¿ƒï¼**

- `chage -l` æ˜¾ç¤ºå¯†ç è¿‡æœŸç­–ç•¥
- `/etc/shadow` å­˜å‚¨åŠ å¯†åçš„å¯†ç 
- `lastlog` å’Œ `faillog` ç”¨äºå®‰å…¨å®¡è®¡

ç°åœ¨è®©æˆ‘ä»¬æ·±å…¥ç†è§£æ¯ä¸ªæ¦‚å¿µã€‚

---

## Step 1 - /etc/shadow æ–‡ä»¶ç»“æ„ï¼ˆ15 åˆ†é’Ÿï¼‰

### 1.1 ä¸ºä»€ä¹ˆéœ€è¦ shadow æ–‡ä»¶ï¼Ÿ

æ—©æœŸ Unix ç³»ç»ŸæŠŠå¯†ç å“ˆå¸Œå­˜åœ¨ `/etc/passwd` ä¸­ï¼Œä½†è¯¥æ–‡ä»¶éœ€è¦æ‰€æœ‰ç”¨æˆ·å¯è¯»ï¼ˆå› ä¸ºåŒ…å«ç”¨æˆ·ä¿¡æ¯ï¼‰ã€‚è¿™æ„å‘³ç€ä»»ä½•äººéƒ½èƒ½è·å–å¯†ç å“ˆå¸Œå¹¶å°è¯•ç ´è§£ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼šæŠŠæ•æ„Ÿä¿¡æ¯ç§»åˆ° `/etc/shadow`ï¼Œåªæœ‰ root å¯è¯»ã€‚

```bash
# æŸ¥çœ‹æƒé™å·®å¼‚
ls -l /etc/passwd /etc/shadow
# -rw-r--r-- 1 root root   2834 Jan  1 10:00 /etc/passwd
# -rw-r----- 1 root shadow 1534 Jan  1 10:00 /etc/shadow
```

### 1.2 shadow æ–‡ä»¶çš„ 9 ä¸ªå­—æ®µ

```bash
# æŸ¥çœ‹ä¸€æ¡ shadow è®°å½•
sudo grep "^$(whoami):" /etc/shadow
```

è¾“å‡ºæ ¼å¼ï¼š
```
username:$6$salt$hash:18567:0:99999:7:::
```

![/etc/shadow Field Structure](images/shadow-fields.png)

<details>
<summary>View ASCII source</summary>

```
ç”¨æˆ·å   å¯†ç å“ˆå¸Œï¼ˆåŠ å¯†åï¼‰              æœ€åä¿®æ”¹  æœ€å°  æœ€å¤§  è­¦å‘Š  ä¸æ´»è·ƒ  è¿‡æœŸ    ä¿ç•™
  |           |                           |      |    |    |     |      |       |
  v           v                           v      v    v    v     v      v       v
â”Œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”
â”‚user â”‚ $6$rounds=5000$salt$hash...   â”‚ 18567 â”‚  0 â”‚99999â”‚  7 â”‚     â”‚       â”‚       â”‚
â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”˜
  1              2                        3      4    5     6    7      8       9
```

</details>

| å­—æ®µ | åç§° | è¯´æ˜ | å¸¸è§å€¼ |
|------|------|------|--------|
| 1 | username | ç”¨æˆ·å | ä¸ /etc/passwd å¯¹åº” |
| 2 | password | åŠ å¯†å¯†ç  | `$6$...` (SHA-512) |
| 3 | lastchange | æœ€åä¿®æ”¹æ—¥æœŸ | ä» 1970-01-01 èµ·çš„å¤©æ•° |
| 4 | min | æœ€çŸ­ä½¿ç”¨å¤©æ•° | 0 = æ— é™åˆ¶ |
| 5 | max | æœ€é•¿ä½¿ç”¨å¤©æ•° | 99999 = æ— é™åˆ¶ |
| 6 | warn | è¿‡æœŸå‰è­¦å‘Šå¤©æ•° | 7 å¤©å¸¸è§ |
| 7 | inactive | è¿‡æœŸåå®½é™å¤©æ•° | ç©º = æ— å®½é™æœŸ |
| 8 | expire | è´¦æˆ·è¿‡æœŸæ—¥æœŸ | ç©º = æ°¸ä¸è¿‡æœŸ |
| 9 | reserved | ä¿ç•™å­—æ®µ | æœªä½¿ç”¨ |

### 1.3 å¯†ç å“ˆå¸Œæ ¼å¼

å¯†ç å­—æ®µçš„æ ¼å¼ï¼š`$id$salt$hash`

```bash
# å¸¸è§çš„å“ˆå¸Œç®—æ³•æ ‡è¯†
# $1$ = MD5     ï¼ˆå·²åºŸå¼ƒï¼Œä¸å®‰å…¨ï¼‰
# $5$ = SHA-256 ï¼ˆå¯æ¥å—ï¼‰
# $6$ = SHA-512 ï¼ˆæ¨èï¼Œç°ä»£ Linux é»˜è®¤ï¼‰
# $y$ = yescryptï¼ˆæ–°ä¸€ä»£ï¼Œéƒ¨åˆ†å‘è¡Œç‰ˆæ”¯æŒï¼‰

# æŸ¥çœ‹ç³»ç»Ÿé»˜è®¤ä½¿ç”¨çš„å“ˆå¸Œç®—æ³•
grep "^ENCRYPT_METHOD" /etc/login.defs
```

### 1.4 ç‰¹æ®Šå¯†ç æ ‡è®°

| æ ‡è®° | å«ä¹‰ |
|------|------|
| `!` æˆ– `!!` | å¯†ç è¢«é”å®š |
| `*` | è´¦æˆ·è¢«ç¦ç”¨ï¼ˆç³»ç»Ÿè´¦æˆ·å¸¸è§ï¼‰ |
| ç©º | æ— å¯†ç ï¼ˆå±é™©ï¼ï¼‰ |
| `!$6$...` | é”å®šçš„å¯†ç ï¼ˆ! å‰ç¼€ï¼‰ |

```bash
# æŸ¥çœ‹ç³»ç»Ÿè´¦æˆ·çš„å¯†ç å­—æ®µï¼ˆé€šå¸¸æ˜¯ * æˆ– !!ï¼‰
sudo grep "^daemon:" /etc/shadow
sudo grep "^nobody:" /etc/shadow
```

---

## Step 2 - å¯†ç è€åŒ–ç­–ç•¥ chageï¼ˆ20 åˆ†é’Ÿï¼‰

### 2.1 æŸ¥çœ‹å½“å‰ç­–ç•¥

```bash
# æŸ¥çœ‹æŒ‡å®šç”¨æˆ·çš„å¯†ç ç­–ç•¥
sudo chage -l testuser

# è¾“å‡ºç¤ºä¾‹ï¼š
# Last password change                : Jan 01, 2026
# Password expires                    : never
# Password inactive                   : never
# Account expires                     : never
# Minimum number of days between password change : 0
# Maximum number of days between password change : 99999
# Number of days of warning before password expires : 7
```

### 2.2 é…ç½®å¯†ç è€åŒ–

```bash
# åˆ›å»ºæµ‹è¯•ç”¨æˆ·ï¼ˆå¦‚æœè¿˜æ²¡æœ‰ï¼‰
sudo useradd -m -s /bin/bash testuser
sudo passwd testuser  # è®¾ç½®å¯†ç 

# è®¾ç½®å¯†ç ç­–ç•¥
# -M 90  : å¯†ç æœ€é•¿ä½¿ç”¨ 90 å¤©
# -m 7   : å¯†ç è‡³å°‘ä½¿ç”¨ 7 å¤©æ‰èƒ½å†æ¬¡ä¿®æ”¹
# -W 14  : è¿‡æœŸå‰ 14 å¤©å¼€å§‹è­¦å‘Š
# -I 30  : è¿‡æœŸå 30 å¤©å†…å¯ä»¥ç™»å½•ä¿®æ”¹å¯†ç ï¼Œä¹‹åè´¦æˆ·é”å®š
sudo chage -M 90 -m 7 -W 14 -I 30 testuser

# éªŒè¯è®¾ç½®
sudo chage -l testuser
```

### 2.3 è®¾ç½®è´¦æˆ·è¿‡æœŸæ—¥æœŸ

```bash
# è®¾ç½®è´¦æˆ·åœ¨ç‰¹å®šæ—¥æœŸè¿‡æœŸï¼ˆåˆåŒå·¥ã€å®ä¹ ç”Ÿå¸¸ç”¨ï¼‰
sudo chage -E 2026-03-31 testuser

# å–æ¶ˆè´¦æˆ·è¿‡æœŸé™åˆ¶
sudo chage -E -1 testuser

# æŸ¥çœ‹å˜æ›´
sudo chage -l testuser
```

### 2.4 å¼ºåˆ¶ç”¨æˆ·ä¸‹æ¬¡ç™»å½•ä¿®æ”¹å¯†ç 

```bash
# æ–¹æ³• 1ï¼šä½¿ç”¨ chage
sudo chage -d 0 testuser

# æ–¹æ³• 2ï¼šä½¿ç”¨ passwd -eï¼ˆæ•ˆæœç›¸åŒï¼‰
sudo passwd -e testuser

# éªŒè¯ï¼šlastchange å˜æˆ password must be changed
sudo chage -l testuser
```

### 2.5 ä¿®æ”¹å…¨å±€é»˜è®¤ç­–ç•¥

æ–°ç”¨æˆ·çš„é»˜è®¤å¯†ç ç­–ç•¥åœ¨ `/etc/login.defs` ä¸­å®šä¹‰ï¼š

```bash
# æŸ¥çœ‹é»˜è®¤å€¼
grep -E "^PASS_MAX_DAYS|^PASS_MIN_DAYS|^PASS_WARN_AGE" /etc/login.defs

# å…¸å‹è¾“å‡ºï¼š
# PASS_MAX_DAYS   99999
# PASS_MIN_DAYS   0
# PASS_WARN_AGE   7
```

> **æ³¨æ„**ï¼šä¿®æ”¹ `/etc/login.defs` åªå½±å“æ–°åˆ›å»ºçš„ç”¨æˆ·ï¼Œä¸å½±å“ç°æœ‰ç”¨æˆ·ã€‚  

---

## Step 3 - passwd å‘½ä»¤é«˜çº§ç”¨æ³•ï¼ˆ15 åˆ†é’Ÿï¼‰

### 3.1 é”å®šå’Œè§£é”å¯†ç 

```bash
# é”å®šç”¨æˆ·å¯†ç 
sudo passwd -l testuser

# æŸ¥çœ‹é”å®šçŠ¶æ€
sudo passwd -S testuser
# testuser LK 2026-01-01 7 90 14 30 (Password locked.)
#           ^^ LK = Locked

# å°è¯•ç™»å½•ï¼ˆä½¿ç”¨å¦ä¸€ä¸ªç»ˆç«¯ï¼‰
# su - testuser  # ä¼šå¤±è´¥ï¼šAuthentication failure

# è§£é”å¯†ç 
sudo passwd -u testuser

# å†æ¬¡æŸ¥çœ‹çŠ¶æ€
sudo passwd -S testuser
# testuser PS 2026-01-01 7 90 14 30 (Password set, SHA512 crypt.)
#           ^^ PS = Password Set
```

### 3.2 passwd -S çŠ¶æ€ç è§£è¯»

| çŠ¶æ€ | å«ä¹‰ |
|------|------|
| PS | Password Setï¼ˆå¯†ç å·²è®¾ç½®ï¼‰ |
| LK | Lockedï¼ˆå¯†ç è¢«é”å®šï¼‰ |
| NP | No Passwordï¼ˆæ— å¯†ç ï¼‰ |

### 3.3 å¯†ç é”å®šçš„åŸç†

```bash
# æŸ¥çœ‹é”å®šå‰å shadow æ–‡ä»¶çš„å˜åŒ–
sudo grep "^testuser:" /etc/shadow
# testuser:$6$xxxxx...

sudo passwd -l testuser
sudo grep "^testuser:" /etc/shadow
# testuser:!$6$xxxxx...  <- æ³¨æ„å¯†ç å‰é¢å¤šäº† !

sudo passwd -u testuser
sudo grep "^testuser:" /etc/shadow
# testuser:$6$xxxxx...   <- ! è¢«ç§»é™¤äº†
```

### 3.4 è®¾ç½®ç©ºå¯†ç ï¼ˆå±é™©æ“ä½œï¼‰

```bash
# åˆ é™¤ç”¨æˆ·å¯†ç ï¼ˆä»…ç”¨äºæ¼”ç¤ºï¼Œç”Ÿäº§ç¯å¢ƒç¦æ­¢ï¼ï¼‰
sudo passwd -d testuser

# æŸ¥çœ‹çŠ¶æ€
sudo passwd -S testuser
# testuser NP ...  (Empty password.)

# ç«‹å³æ¢å¤å¯†ç 
sudo passwd testuser
```

---

## Step 4 - è´¦æˆ·é”å®š vs å¯†ç é”å®šï¼ˆ10 åˆ†é’Ÿï¼‰

### 4.1 å…³é”®åŒºåˆ«

è¿™æ˜¯ä¸€ä¸ª**éå¸¸é‡è¦çš„å®‰å…¨æ¦‚å¿µ**ï¼š

![Password Lock vs Account Lock](images/lock-types.png)

<details>
<summary>View ASCII source</summary>

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        è®¿é—®æ§åˆ¶å±‚æ¬¡                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚   å¯†ç é”å®š (passwd -l)              è´¦æˆ·é”å®š (usermod -L æˆ–è¿‡æœŸ)    â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚
â”‚                                                                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚   â”‚  å¯†ç è®¤è¯   â”‚ â† è¢«é˜»æ­¢          â”‚   è´¦æˆ·æœ¬èº«   â”‚ â† è¢«ç¦ç”¨        â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚          â”‚                                 â”‚                        â”‚
â”‚          â–¼                                 â–¼                        â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚   â”‚  SSH å¯†é’¥   â”‚ â† ä»ç„¶æœ‰æ•ˆï¼       â”‚  æ‰€æœ‰ç™»å½•    â”‚ â† å…¨éƒ¨é˜»æ­¢      â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚          â”‚                                 â”‚                        â”‚
â”‚          â–¼                                 â–¼                        â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚   â”‚  sudo æƒé™  â”‚ â† ä»ç„¶æœ‰æ•ˆï¼       â”‚  åŒ…æ‹¬SSHå¯†é’¥ â”‚ â† å…¨éƒ¨é˜»æ­¢      â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

</details>

| æ–¹æ³• | é˜»æ­¢å¯†ç ç™»å½• | é˜»æ­¢ SSH å¯†é’¥ç™»å½• | é˜»æ­¢ sudo |
|------|--------------|-------------------|-----------|
| `passwd -l` | Yes | **No** | No |
| `usermod -L` | Yes | **No** | No |
| `chage -E 0` | Yes | Yes | Yes |
| `usermod -s /sbin/nologin` | Yes | Yes | Yes |

### 4.2 å®‰å…¨çš„è´¦æˆ·ç¦ç”¨æ–¹æ³•

```bash
# å®Œå…¨ç¦ç”¨è´¦æˆ·çš„æ¨èæ­¥éª¤ï¼ˆç¦»èŒå‘˜å·¥å¤„ç†ï¼‰

# 1. é”å®šå¯†ç 
sudo passwd -l testuser

# 2. è®¾ç½®è´¦æˆ·è¿‡æœŸ
sudo chage -E 0 testuser

# 3. å¯é€‰ï¼šæ›´æ”¹ç™»å½• shell
sudo usermod -s /sbin/nologin testuser

# éªŒè¯
sudo chage -l testuser
# Account expires: Jan 01, 1970  (å·²è¿‡æœŸ)

grep "^testuser:" /etc/passwd
# ... :/sbin/nologin  (æ— æ³•è·å¾— shell)
```

### 4.3 nologin vs /bin/false

ä¸¤è€…éƒ½å¯ä»¥é˜»æ­¢ç”¨æˆ·ç™»å½•ï¼Œä½†æœ‰ç»†å¾®å·®åˆ«ï¼š

```bash
# /sbin/nologin - ä¼šæ˜¾ç¤ºæ¶ˆæ¯ç„¶åé€€å‡º
# /bin/false    - ç›´æ¥é€€å‡ºï¼Œæ— æ¶ˆæ¯

# æŸ¥çœ‹ nologin æ¶ˆæ¯
cat /etc/nologin.txt 2>/dev/null || echo "æ–‡ä»¶ä¸å­˜åœ¨æ—¶ä½¿ç”¨é»˜è®¤æ¶ˆæ¯"

# ç³»ç»Ÿè´¦æˆ·é€šå¸¸ä½¿ç”¨ nologin
grep nologin /etc/passwd | head -3
```

| ç±»å‹ | é€‚ç”¨åœºæ™¯ |
|------|----------|
| `/sbin/nologin` | æœåŠ¡è´¦æˆ·ã€ä¸´æ—¶ç¦ç”¨çš„ç”¨æˆ· |
| `/bin/false` | ä»…ç”¨äº FTP/SFTP çš„è´¦æˆ· |

---

## Step 5 - ç™»å½•å®¡è®¡ï¼ˆ10 åˆ†é’Ÿï¼‰

### 5.1 lastlog - æœ€åç™»å½•è®°å½•

```bash
# æ˜¾ç¤ºæ‰€æœ‰ç”¨æˆ·æœ€åç™»å½•æ—¶é—´
lastlog

# åªæ˜¾ç¤ºæœ€è¿‘ 30 å¤©å†…ç™»å½•è¿‡çš„ç”¨æˆ·
lastlog -t 30

# æŸ¥çœ‹ç‰¹å®šç”¨æˆ·
lastlog -u testuser
```

### 5.2 faillog - å¤±è´¥ç™»å½•è®°å½•

```bash
# æ˜¾ç¤ºæ‰€æœ‰å¤±è´¥çš„ç™»å½•å°è¯•
sudo faillog -a

# æŸ¥çœ‹ç‰¹å®šç”¨æˆ·çš„å¤±è´¥è®°å½•
sudo faillog -u testuser

# é‡ç½®å¤±è´¥è®¡æ•°ï¼ˆè§£é”å› å¤šæ¬¡å¤±è´¥è¢«é”å®šçš„è´¦æˆ·ï¼‰
sudo faillog -r -u testuser
```

### 5.3 å…¶ä»–å®¡è®¡å‘½ä»¤

```bash
# last - ç™»å½•å†å²è®°å½•
last | head -20

# lastb - å¤±è´¥çš„ç™»å½•å°è¯•ï¼ˆéœ€è¦ /var/log/btmp å­˜åœ¨ï¼‰
sudo lastb | head -10

# who - å½“å‰ç™»å½•ç”¨æˆ·
who

# w - å½“å‰ç™»å½•ç”¨æˆ·åŠå…¶æ´»åŠ¨
w
```

### 5.4 æ—¥å¿—æ–‡ä»¶ä½ç½®

| å‘è¡Œç‰ˆ | è®¤è¯æ—¥å¿— |
|--------|----------|
| RHEL/CentOS | `/var/log/secure` |
| Debian/Ubuntu | `/var/log/auth.log` |
| systemd ç³»ç»Ÿ | `journalctl -u sshd` |

```bash
# æŸ¥çœ‹æœ€è¿‘çš„è®¤è¯æ—¥å¿—
sudo tail -20 /var/log/auth.log 2>/dev/null || \
sudo tail -20 /var/log/secure 2>/dev/null || \
sudo journalctl -u sshd --since "1 hour ago"
```

---

## Step 6 - PAM åŸºç¡€é…ç½®ï¼ˆ25 åˆ†é’Ÿï¼‰

### 6.1 ä»€ä¹ˆæ˜¯ PAMï¼Ÿ

PAM (Pluggable Authentication Modules) æ˜¯ Linux çš„å¯æ’æ‹”è®¤è¯æ¡†æ¶ã€‚å®ƒè®©ç³»ç»Ÿç®¡ç†å‘˜å¯ä»¥çµæ´»é…ç½®è®¤è¯ç­–ç•¥ï¼Œè€Œä¸éœ€è¦ä¿®æ”¹åº”ç”¨ç¨‹åºä»£ç ã€‚

![PAM Architecture](images/pam-stack.png)

<details>
<summary>View ASCII source</summary>

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        åº”ç”¨ç¨‹åº (sshd, login, su)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           PAM æ¡†æ¶                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚   â”‚  pam_unix   â”‚  â”‚pam_pwqualityâ”‚  â”‚ pam_faillockâ”‚  â”‚  å…¶ä»–æ¨¡å—  â”‚ â”‚
â”‚   â”‚ (å¯†ç è®¤è¯)   â”‚  â”‚ (å¯†ç å¼ºåº¦)   â”‚  â”‚ (å¤±è´¥é”å®š)  â”‚  â”‚    ...    â”‚ â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     /etc/shadow, /etc/passwd                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

</details>

### 6.2 PAM é…ç½®æ–‡ä»¶ç»“æ„

```bash
# PAM é…ç½®æ–‡ä»¶ä½ç½®
ls /etc/pam.d/

# å¸¸è§é…ç½®æ–‡ä»¶
# /etc/pam.d/system-auth   - ç³»ç»Ÿè®¤è¯ï¼ˆRHEL/CentOSï¼‰
# /etc/pam.d/common-auth   - é€šç”¨è®¤è¯ï¼ˆDebian/Ubuntuï¼‰
# /etc/pam.d/sshd          - SSH ç™»å½•
# /etc/pam.d/su            - su å‘½ä»¤
# /etc/pam.d/sudo          - sudo å‘½ä»¤
```

PAM é…ç½®è¡Œæ ¼å¼ï¼š
```
type    control    module-path    [module-arguments]
```

| å­—æ®µ | è¯´æ˜ | å¸¸è§å€¼ |
|------|------|--------|
| type | æ¨¡å—ç±»å‹ | auth, account, password, session |
| control | æ§åˆ¶æ ‡å¿— | required, requisite, sufficient, optional |
| module-path | æ¨¡å—è·¯å¾„ | pam_unix.so, pam_pwquality.so |
| arguments | æ¨¡å—å‚æ•° | å› æ¨¡å—è€Œå¼‚ |

---

> **å®‰å…¨è­¦å‘Š - è¯·åŠ¡å¿…é˜…è¯»ï¼**  
>
> PAM é…ç½®é”™è¯¯å¯èƒ½å¯¼è‡´ä½ å®Œå…¨æ— æ³•ç™»å½•ç³»ç»Ÿï¼  
>
> **åœ¨ä¿®æ”¹ä»»ä½• PAM é…ç½®ä¹‹å‰ï¼Œè¯·æ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š**  
>
> 1. **ä¿æŒä¸€ä¸ª root ç»ˆç«¯ä¼šè¯æ‰“å¼€** - ä¸è¦å…³é—­å®ƒ  
> 2. **åœ¨æ–°ç»ˆç«¯ä¸­æµ‹è¯•ç™»å½•** - éªŒè¯ä¿®æ”¹æ˜¯å¦æ­£ç¡®  
> 3. **å‡†å¤‡å¥½æ¢å¤æ–¹æ¡ˆ** - æ§åˆ¶å°è®¿é—®æˆ– Live CD  
> 4. **å¤‡ä»½é…ç½®æ–‡ä»¶** - ä¿®æ”¹å‰å…ˆå¤åˆ¶  
>
> ```bash  
> # å¤‡ä»½ PAM é…ç½®  
> sudo cp -r /etc/pam.d /etc/pam.d.backup  
>
> # å¦‚æœæ˜¯ RHEL/CentOSï¼Œè¿˜è¦å¤‡ä»½ authconfig ç›¸å…³æ–‡ä»¶  
> sudo cp /etc/security/pwquality.conf /etc/security/pwquality.conf.backup  
> ```  

---

### 6.3 é…ç½®å¯†ç å¤æ‚åº¦ï¼ˆpam_pwqualityï¼‰

pam_pwquality æ¨¡å—ç”¨äºå¼ºåˆ¶å¯†ç å¼ºåº¦è¦æ±‚ã€‚

```bash
# æŸ¥çœ‹å½“å‰å¯†ç ç­–ç•¥é…ç½®
cat /etc/security/pwquality.conf

# ç¼–è¾‘å¯†ç å¤æ‚åº¦é…ç½®
sudo nano /etc/security/pwquality.conf
```

å¸¸ç”¨é…ç½®é€‰é¡¹ï¼š

```bash
# /etc/security/pwquality.conf

# æœ€å°å¯†ç é•¿åº¦
minlen = 12

# æœ€å°‘æ•°å­—å­—ç¬¦
dcredit = -1

# æœ€å°‘å¤§å†™å­—æ¯
ucredit = -1

# æœ€å°‘å°å†™å­—æ¯
lcredit = -1

# æœ€å°‘ç‰¹æ®Šå­—ç¬¦
ocredit = -1

# æœ€å¤§è¿ç»­ç›¸åŒå­—ç¬¦
maxrepeat = 3

# æ–°å¯†ç ä¸æ—§å¯†ç è‡³å°‘ä¸åŒçš„å­—ç¬¦æ•°
difok = 5

# ç¦æ­¢ä½¿ç”¨ç”¨æˆ·å
usercheck = 1

# ç¦æ­¢ä½¿ç”¨å­—å…¸è¯
dictcheck = 1
```

### 6.4 åŠ¨æ‰‹ç»ƒä¹ ï¼šé…ç½®å¯†ç å¤æ‚åº¦

```bash
# æ­¥éª¤ 1ï¼šå¤‡ä»½ç°æœ‰é…ç½®
sudo cp /etc/security/pwquality.conf /etc/security/pwquality.conf.bak

# æ­¥éª¤ 2ï¼šè®¾ç½®å¯†ç å¤æ‚åº¦è¦æ±‚
sudo tee /etc/security/pwquality.conf.d/custom.conf << 'EOF'
# ä¼ä¸šå¯†ç ç­–ç•¥
minlen = 12
dcredit = -1
ucredit = -1
lcredit = -1
ocredit = -1
maxrepeat = 3
usercheck = 1
EOF

# æ­¥éª¤ 3ï¼šæµ‹è¯•å¯†ç å¤æ‚åº¦ï¼ˆä½¿ç”¨æµ‹è¯•ç”¨æˆ·ï¼‰
# å…ˆåœ¨å¦ä¸€ä¸ªç»ˆç«¯ä¿æŒ root ç™»å½•ï¼
sudo passwd testuser
# å°è¯•ç®€å•å¯†ç å¦‚ "password" - åº”è¯¥è¢«æ‹’ç»
# å°è¯•å¤æ‚å¯†ç å¦‚ "MyC0mplex!Pass123" - åº”è¯¥è¢«æ¥å—

# å¦‚æœå‡ºé—®é¢˜ï¼Œæ¢å¤å¤‡ä»½ï¼š
# sudo cp /etc/security/pwquality.conf.bak /etc/security/pwquality.conf
```

### 6.5 é…ç½®è´¦æˆ·é”å®šï¼ˆpam_faillockï¼‰

pam_faillock æ¨¡å—ç”¨äºåœ¨å¤šæ¬¡ç™»å½•å¤±è´¥åé”å®šè´¦æˆ·ã€‚

> **æ³¨æ„**ï¼šåœ¨è¾ƒæ—§çš„ç³»ç»Ÿä¸Šå¯èƒ½ä½¿ç”¨ `pam_tally2`ï¼Œä½†å®ƒå·²è¢«åºŸå¼ƒã€‚ç°ä»£ç³»ç»Ÿä½¿ç”¨ `pam_faillock`ã€‚  

**RHEL/CentOS 8+ é…ç½®ï¼š**

```bash
# æŸ¥çœ‹å½“å‰ faillock é…ç½®
cat /etc/security/faillock.conf

# ç¼–è¾‘é…ç½®
sudo nano /etc/security/faillock.conf
```

```bash
# /etc/security/faillock.conf

# 5 æ¬¡å¤±è´¥åé”å®š
deny = 5

# é”å®šæŒç»­æ—¶é—´ï¼ˆç§’ï¼‰ï¼Œ0 = æ°¸ä¹…é”å®šç›´åˆ°ç®¡ç†å‘˜è§£é”
unlock_time = 900

# å¤±è´¥è®¡æ•°æœ‰æ•ˆæœŸï¼ˆç§’ï¼‰
fail_interval = 900

# æ˜¯å¦ä¹Ÿå¯¹ root ç”¨æˆ·ç”Ÿæ•ˆ
even_deny_root = false

# root ç”¨æˆ·é”å®šæ—¶é—´ï¼ˆå¦‚æœå¯ç”¨ï¼‰
root_unlock_time = 60

# å®¡è®¡ç›®å½•
dir = /var/run/faillock
```

**Debian/Ubuntu é…ç½®ï¼š**

éœ€è¦æ‰‹åŠ¨ç¼–è¾‘ PAM é…ç½®æ–‡ä»¶ï¼š

```bash
# å¤‡ä»½åŸå§‹é…ç½®
sudo cp /etc/pam.d/common-auth /etc/pam.d/common-auth.bak

# ç¼–è¾‘ common-auth
sudo nano /etc/pam.d/common-auth
```

åœ¨æ–‡ä»¶å¼€å¤´æ·»åŠ ï¼š
```
auth    required    pam_faillock.so preauth silent deny=5 unlock_time=900
auth    [default=die] pam_faillock.so authfail deny=5 unlock_time=900
```

### 6.6 åŠ¨æ‰‹ç»ƒä¹ ï¼šæµ‹è¯•è´¦æˆ·é”å®š

```bash
# ç¡®ä¿ faillock é…ç½®æ­£ç¡®å...

# æŸ¥çœ‹ç”¨æˆ·é”å®šçŠ¶æ€
sudo faillock --user testuser

# æ¨¡æ‹Ÿå¤±è´¥ç™»å½•ï¼ˆä½¿ç”¨é”™è¯¯å¯†ç ï¼‰
# åœ¨å¦ä¸€ä¸ªç»ˆç«¯å°è¯•ï¼š
# su - testuser  # è¾“å…¥é”™è¯¯å¯†ç  5 æ¬¡

# æŸ¥çœ‹é”å®šè®°å½•
sudo faillock --user testuser

# è§£é”ç”¨æˆ·
sudo faillock --user testuser --reset

# éªŒè¯å·²è§£é”
sudo faillock --user testuser
```

### 6.7 å¸¸ç”¨ PAM æ¨¡å—ä¸€è§ˆ

| æ¨¡å— | åŠŸèƒ½ | é…ç½®æ–‡ä»¶ |
|------|------|----------|
| pam_unix | æ ‡å‡†å¯†ç è®¤è¯ | /etc/shadow |
| pam_pwquality | å¯†ç å¼ºåº¦æ£€æŸ¥ | /etc/security/pwquality.conf |
| pam_faillock | ç™»å½•å¤±è´¥é”å®š | /etc/security/faillock.conf |
| pam_limits | èµ„æºé™åˆ¶ | /etc/security/limits.conf |
| pam_wheel | é™åˆ¶ su ä½¿ç”¨ | /etc/pam.d/su |
| pam_securetty | root ç™»å½•ç»ˆç«¯é™åˆ¶ | /etc/securetty |

---

## åæ¨¡å¼ï¼šå¸¸è§é”™è¯¯

### é”™è¯¯ 1ï¼šåœ¨è„šæœ¬ä¸­å­˜å‚¨æ˜æ–‡å¯†ç 

```bash
# å±é™©ï¼å¯†ç æ˜æ–‡å­˜å‚¨åœ¨è„šæœ¬ä¸­
#!/bin/bash
mysql -u admin -p'MyPassword123' -e "SELECT * FROM users"

# æ­£ç¡®åšæ³•ï¼šä½¿ç”¨é…ç½®æ–‡ä»¶æˆ–å‡­è¯ç®¡ç†å™¨
# MySQL ç¤ºä¾‹ï¼š~/.my.cnfï¼ˆæƒé™ 600ï¼‰
# [client]
# user=admin
# password=MyPassword123

# æˆ–ä½¿ç”¨ç¯å¢ƒå˜é‡ï¼ˆä»ç„¶ä¸å¤Ÿå®‰å…¨ï¼Œä½†å¥½äºç¡¬ç¼–ç ï¼‰
mysql -u admin -p"${MYSQL_PASSWORD}" -e "SELECT * FROM users"

# æœ€ä½³å®è·µï¼šä½¿ç”¨ vault æˆ–å‡­è¯ç®¡ç†æœåŠ¡
```

### é”™è¯¯ 2ï¼šå¯†ç æ°¸ä¸è¿‡æœŸ

```bash
# å±é™©ï¼å¯†ç æ°¸ä¸è¿‡æœŸ
sudo chage -M 99999 username

# é—®é¢˜ï¼š
# - å¯†ç å¯èƒ½å·²è¢«æ³„éœ²ä½†ä»åœ¨ä½¿ç”¨
# - ä¸ç¬¦åˆå®‰å…¨åˆè§„è¦æ±‚
# - å‘˜å·¥ç¦»èŒåå¯†ç ä»ç„¶æœ‰æ•ˆ

# æ­£ç¡®åšæ³•ï¼šè®¾ç½®åˆç†çš„è¿‡æœŸç­–ç•¥
sudo chage -M 90 -W 14 username  # 90 å¤©è¿‡æœŸï¼Œæå‰ 14 å¤©è­¦å‘Š
```

### é”™è¯¯ 3ï¼šæ··æ·†å¯†ç é”å®šå’Œè´¦æˆ·é”å®š

```bash
# å¸¸è§è¯¯è§£ï¼šè®¤ä¸º passwd -l èƒ½é˜»æ­¢æ‰€æœ‰ç™»å½•

# å±é™©åœºæ™¯ï¼š
sudo passwd -l exemployee
# è¯¥ç”¨æˆ·ä»ç„¶å¯ä»¥ç”¨ SSH å¯†é’¥ç™»å½•ï¼

# æ­£ç¡®åšæ³•ï¼šå®Œå…¨ç¦ç”¨è´¦æˆ·
sudo passwd -l exemployee
sudo chage -E 0 exemployee
sudo usermod -s /sbin/nologin exemployee

# æ›´å½»åº•ï¼šç§»é™¤ SSH å¯†é’¥
sudo rm -f /home/exemployee/.ssh/authorized_keys
```

### é”™è¯¯ 4ï¼šä¸æµ‹è¯• PAM é…ç½®å°±å…³é—­ç»ˆç«¯

```bash
# è‡´å‘½é”™è¯¯ï¼šä¿®æ”¹ PAM é…ç½®åç›´æ¥å…³é—­ç»ˆç«¯

# æ­£ç¡®æµç¨‹ï¼š
# 1. ä¿æŒå½“å‰ root ç»ˆç«¯æ‰“å¼€
# 2. ä¿®æ”¹ PAM é…ç½®
# 3. æ‰“å¼€æ–°ç»ˆç«¯æµ‹è¯•ç™»å½•
# 4. ç¡®è®¤æ­£å¸¸åæ‰å…³é—­æ—§ç»ˆç«¯

# å¦‚æœè¢«é”åœ¨å¤–é¢ï¼š
# - ä½¿ç”¨æ§åˆ¶å° (console) ç™»å½•
# - ä½¿ç”¨ Live CD æŒ‚è½½ç³»ç»Ÿåˆ†åŒºï¼Œæ¢å¤ PAM é…ç½®
# - äº‘æœåŠ¡å™¨å¯ä½¿ç”¨ serial console æˆ– rescue mode
```

---

## èŒåœºå°è´´å£«ï¼ˆJapan IT Contextï¼‰

### å¯†ç ç­–ç•¥åˆè§„è¦æ±‚

åœ¨æ—¥æœ¬ä¼ä¸šç¯å¢ƒä¸­ï¼Œå¯†ç ç®¡ç†æœ‰ä¸¥æ ¼çš„åˆè§„è¦æ±‚ï¼š

| æ—¥è¯­æœ¯è¯­ | å«ä¹‰ | æŠ€æœ¯å®ç° |
|----------|------|----------|
| ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒªã‚·ãƒ¼ | å¯†ç ç­–ç•¥ | `/etc/security/pwquality.conf` |
| å®šæœŸå¤‰æ›´ | å®šæœŸæ›´æ¢ | `chage -M 90` |
| è¤‡é›‘æ€§è¦ä»¶ | å¤æ‚åº¦è¦æ±‚ | `minlen`, `dcredit`, `ucredit` |
| ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒ­ãƒƒã‚¯ | è´¦æˆ·é”å®š | `pam_faillock` |

### å‘˜å·¥ç¦»èŒå¤„ç†ï¼ˆé€€è·æ™‚ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç„¡åŠ¹åŒ–ï¼‰

æ—¥æœ¬å…¬å¸å¯¹ç¦»èŒå‘˜å·¥çš„è´¦æˆ·å¤„ç†éå¸¸ä¸¥æ ¼ï¼š

```bash
# ç¦»èŒå½“å¤©çš„æ ‡å‡†æ“ä½œæµç¨‹
# 1. ç¡®è®¤ç¦»èŒæ—¶é—´ï¼ˆäººäº‹éƒ¨é—¨é€šçŸ¥ï¼‰
# 2. ç«‹å³ç¦ç”¨è´¦æˆ·

# ç¦»èŒå‘˜å·¥å¤„ç†è„šæœ¬ç¤ºä¾‹
EXEMPLOYEE="tanaka"
DATE=$(date +%Y%m%d)

# é”å®šå¯†ç 
sudo passwd -l ${EXEMPLOYEE}

# è®¾ç½®è´¦æˆ·è¿‡æœŸ
sudo chage -E $(date +%Y-%m-%d) ${EXEMPLOYEE}

# æ›´æ”¹ shell
sudo usermod -s /sbin/nologin ${EXEMPLOYEE}

# è®°å½•æ“ä½œæ—¥å¿—ï¼ˆéšœå®³å ±å‘Šç”¨ï¼‰
echo "[${DATE}] Account ${EXEMPLOYEE} disabled by $(whoami)" | \
  sudo tee -a /var/log/account_changes.log
```

### å®¡è®¡æ—¥å¿—è¦æ±‚

SOC2ã€ISMS ç­‰åˆè§„æ¡†æ¶è¦æ±‚ä¿ç•™è®¤è¯æ—¥å¿—ï¼š

```bash
# å®šæœŸå®¡è®¡å‘½ä»¤
# æŸ¥çœ‹ä»æœªç™»å½•çš„è´¦æˆ·
lastlog | grep "Never logged in"

# æŸ¥çœ‹é•¿æœŸæœªç™»å½•çš„è´¦æˆ·ï¼ˆè¶…è¿‡ 90 å¤©ï¼‰
lastlog -b 90

# å¯¼å‡ºè´¦æˆ·çŠ¶æ€æŠ¥å‘Š
for user in $(awk -F: '$3 >= 1000 {print $1}' /etc/passwd); do
  echo -n "${user}: "
  sudo passwd -S ${user}
done > /tmp/account_audit_$(date +%Y%m%d).txt
```

---

## æ£€æŸ¥æ¸…å•

å®Œæˆæœ¬è¯¾åï¼Œä½ åº”è¯¥èƒ½å¤Ÿï¼š

- [ ] è§£é‡Š `/etc/shadow` çš„ 9 ä¸ªå­—æ®µå«ä¹‰
- [ ] è¯†åˆ«å¯†ç å“ˆå¸Œç®—æ³•ï¼ˆ$6$ = SHA-512ï¼‰
- [ ] ä½¿ç”¨ `chage` é…ç½®å¯†ç è€åŒ–ç­–ç•¥
- [ ] ä½¿ç”¨ `passwd -l/-u` é”å®š/è§£é”å¯†ç 
- [ ] åŒºåˆ†å¯†ç é”å®šå’Œè´¦æˆ·é”å®šçš„åŒºåˆ«
- [ ] ç†è§£ `nologin` å’Œ `/bin/false` çš„ç”¨é€”
- [ ] ä½¿ç”¨ `lastlog` å’Œ `faillog` å®¡è®¡è´¦æˆ·
- [ ] é…ç½® `pam_pwquality` å¼ºåˆ¶å¯†ç å¤æ‚åº¦
- [ ] é…ç½® `pam_faillock` å®ç°ç™»å½•å¤±è´¥é”å®š
- [ ] å®‰å…¨åœ°æµ‹è¯• PAM é…ç½®ï¼ˆä¿æŒå¤‡ä»½ä¼šè¯ï¼‰

---

## æœ¬è¯¾å°ç»“

| æ¦‚å¿µ | å‘½ä»¤/æ–‡ä»¶ | è®°å¿†ç‚¹ |
|------|-----------|--------|
| å¯†ç å­˜å‚¨ | `/etc/shadow` | åªæœ‰ root å¯è¯» |
| å“ˆå¸Œç®—æ³• | `$6$` | SHA-512ï¼Œç°ä»£æ ‡å‡† |
| å¯†ç è€åŒ– | `chage -M/-m/-W` | è¿‡æœŸ/æœ€çŸ­/è­¦å‘Šå¤©æ•° |
| å¼ºåˆ¶æ”¹å¯† | `passwd -e` æˆ– `chage -d 0` | ä¸‹æ¬¡ç™»å½•å¿…é¡»æ”¹å¯† |
| å¯†ç é”å®š | `passwd -l/-u` | åªé˜»æ­¢å¯†ç è®¤è¯ |
| è´¦æˆ·é”å®š | `chage -E 0` | å®Œå…¨ç¦æ­¢ç™»å½• |
| ç™»å½• shell | `/sbin/nologin` | æœåŠ¡è´¦æˆ·ã€ä¸´æ—¶ç¦ç”¨ |
| ç™»å½•å®¡è®¡ | `lastlog`, `faillog` | å®‰å…¨åˆè§„å¿…å¤‡ |
| å¯†ç å¼ºåº¦ | `pam_pwquality` | `/etc/security/pwquality.conf` |
| å¤±è´¥é”å®š | `pam_faillock` | é˜²æ­¢æš´åŠ›ç ´è§£ |

---

## å»¶ä¼¸é˜…è¯»

- [Linux Shadow Password HOWTO](https://tldp.org/HOWTO/Shadow-Password-HOWTO.html)
- [PAM System Administrators' Guide](https://www.linux-pam.org/Linux-PAM-html/Linux-PAM_SAG.html)
- [RHEL Security Hardening Guide](https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/8/html/security_hardening/index)
- ç›¸å…³è¯¾ç¨‹ï¼š[Lesson 06 - sudo é…ç½®](../06-sudo-configuration/) - å­¦ä¹ æƒé™æå‡ç®¡ç†

---

## ç³»åˆ—å¯¼èˆª

[ä¸Šä¸€è¯¾ï¼š01 - ç”¨æˆ·ä¸ç”¨æˆ·ç»„](../01-users-and-groups/) | [ç³»åˆ—é¦–é¡µ](../) | [ä¸‹ä¸€è¯¾ï¼š03 - æ–‡ä»¶æƒé™åŸºç¡€ ->](../03-file-permissions-fundamentals/)
