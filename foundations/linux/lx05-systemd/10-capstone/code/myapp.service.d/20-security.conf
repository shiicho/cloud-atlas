# =============================================================================
# 20-security.conf - Security Hardening for MyApp
# =============================================================================
# Drop-in file for security hardening
#
# Goal: systemd-analyze security score < 5.0
#
# IMPORTANT: Test incrementally! Some directives may break your app.
# =============================================================================

[Service]
# -----------------------------------------------------------------------------
# Privilege Restrictions
# -----------------------------------------------------------------------------
# Prevent privilege escalation via setuid/setgid
NoNewPrivileges=yes

# Restrict SUID/SGID file creation
RestrictSUIDSGID=yes

# Drop all capabilities except what's needed
# Remove CAP_NET_BIND_SERVICE if not binding to ports < 1024
CapabilityBoundingSet=CAP_NET_BIND_SERVICE

# Ambient capabilities (if needed for binding to privileged ports)
# AmbientCapabilities=CAP_NET_BIND_SERVICE

# -----------------------------------------------------------------------------
# Filesystem Protection
# -----------------------------------------------------------------------------
# Make /usr, /boot, /etc read-only
ProtectSystem=strict

# Prevent access to /home, /root
ProtectHome=yes

# Private /tmp (isolated from other processes)
PrivateTmp=yes

# Private /dev (limited device access)
PrivateDevices=yes

# Directories this service can write to (exceptions)
ReadWritePaths=/var/lib/myapp /var/log/myapp

# -----------------------------------------------------------------------------
# Kernel Protection
# -----------------------------------------------------------------------------
# Prevent modifying kernel tunables (/proc/sys)
ProtectKernelTunables=yes

# Prevent loading kernel modules
ProtectKernelModules=yes

# Prevent accessing kernel logs
ProtectKernelLogs=yes

# Prevent modifying control groups
ProtectControlGroups=yes

# -----------------------------------------------------------------------------
# Network Restrictions
# -----------------------------------------------------------------------------
# Restrict to IPv4, IPv6, and Unix sockets only
RestrictAddressFamilies=AF_INET AF_INET6 AF_UNIX

# -----------------------------------------------------------------------------
# System Call Filtering
# -----------------------------------------------------------------------------
# Only allow system calls needed for typical services
SystemCallFilter=@system-service

# Only allow native architecture (prevent 32-bit exploits on 64-bit)
SystemCallArchitectures=native

# -----------------------------------------------------------------------------
# Additional Hardening
# -----------------------------------------------------------------------------
# Prevent personality changes
LockPersonality=yes

# Prevent real-time scheduling (not needed for web apps)
RestrictRealtime=yes

# Prevent namespace creation
RestrictNamespaces=yes

# Protect clock (prevent time manipulation)
ProtectClock=yes

# Protect hostname
ProtectHostname=yes

# Deny write+execute memory (prevents some exploits)
# WARNING: May break JIT compilers (Node.js, Java)
# MemoryDenyWriteExecute=yes
