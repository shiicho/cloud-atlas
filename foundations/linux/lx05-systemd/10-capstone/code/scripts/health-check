#!/bin/bash
# =============================================================================
# MyApp Health Check Script
# =============================================================================
# Checks if MyApp is running and healthy

APP_NAME="myapp"
PID_FILE="/var/lib/myapp/myapp.pid"
LOG_FILE="/var/log/myapp/health-check.log"

log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

log "Starting health check..."

# Check if PID file exists
if [ ! -f "$PID_FILE" ]; then
    log "ERROR: PID file not found"
    exit 1
fi

# Check if process is running
PID=$(cat "$PID_FILE")
if ! kill -0 "$PID" 2>/dev/null; then
    log "ERROR: Process $PID is not running"
    exit 1
fi

# Check if main log has recent entries
LAST_LOG_TIME=$(stat -c %Y /var/log/myapp/myapp.log 2>/dev/null || echo 0)
CURRENT_TIME=$(date +%s)
LOG_AGE=$((CURRENT_TIME - LAST_LOG_TIME))

if [ "$LOG_AGE" -gt 120 ]; then
    log "WARNING: No log activity for $LOG_AGE seconds"
    # Not failing, just warning
fi

log "Health check PASSED - PID: $PID"
exit 0
