# 05 - Target ä¸å¯åŠ¨æµç¨‹ï¼ˆTargets and Boot Processï¼‰

> **ç›®æ ‡**ï¼šæŒæ¡ Target ä½œä¸ºåŒæ­¥ç‚¹çš„è§’è‰²ï¼Œç†è§£ Linux å®Œæ•´å¯åŠ¨æµç¨‹ï¼Œå­¦ä¼šåˆ†æå’Œæ’æŸ¥å¯åŠ¨é—®é¢˜  
> **å‰ç½®**ï¼šLesson 04 ä¾èµ–ä¸æ’åºï¼ˆdependency-managementï¼‰  
> **æ—¶é—´**ï¼šâš¡ 18 åˆ†é’Ÿï¼ˆé€Ÿè¯»ï¼‰/ ğŸ”¬ 65 åˆ†é’Ÿï¼ˆå®Œæ•´å®æ“ï¼‰  
> **å®æˆ˜åœºæ™¯**ï¼šãƒ–ãƒ¼ãƒˆå•é¡Œã®ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚° - èµ·å‹•ãŒé…ã„åŸå› èª¿æŸ»  

---

## å°†å­¦åˆ°çš„å†…å®¹

1. ç†è§£ Target ä½œä¸ºåŒæ­¥ç‚¹çš„è§’è‰²
2. å¯¹åº” SysV runlevel åˆ° systemd target
3. æŸ¥çœ‹å’Œæ›´æ”¹é»˜è®¤ target
4. æŒæ¡å®Œæ•´çš„ 5 é˜¶æ®µå¯åŠ¨æµç¨‹
5. ä½¿ç”¨ systemd-analyze åˆ†æå¯åŠ¨æ€§èƒ½
6. é…ç½®æ—¶é—´åŒæ­¥ï¼ˆchrony/timedatectlï¼‰
7. ä½¿ç”¨ç´§æ€¥å’Œæ•‘æ´æ¨¡å¼æ’æŸ¥é—®é¢˜

---

## å…ˆè·‘èµ·æ¥ï¼ï¼ˆ5 åˆ†é’Ÿï¼‰

> åœ¨å­¦ä¹ ç†è®ºä¹‹å‰ï¼Œå…ˆä½“éªŒ Target å’Œå¯åŠ¨åˆ†æã€‚  
> è¿è¡Œè¿™äº›å‘½ä»¤ï¼Œè§‚å¯Ÿç³»ç»Ÿçš„å¯åŠ¨çŠ¶æ€ã€‚  

```bash
# æŸ¥çœ‹å½“å‰è¿è¡Œçš„ target
systemctl get-default

# ç³»ç»Ÿå¯åŠ¨ç”¨äº†å¤šé•¿æ—¶é—´ï¼Ÿ
systemd-analyze

# å“ªäº›æœåŠ¡å¯åŠ¨æœ€æ…¢ï¼Ÿ
systemd-analyze blame | head -10

# æŸ¥çœ‹å¯åŠ¨å…³é”®è·¯å¾„
systemd-analyze critical-chain

# æŸ¥çœ‹æ‰€æœ‰ target
systemctl list-units --type=target
```

**ä½ åˆšåˆšå®Œæˆäº†å¯åŠ¨åˆ†æçš„æ ¸å¿ƒæ“ä½œï¼**

- `get-default` æ˜¾ç¤ºç³»ç»Ÿé»˜è®¤å¯åŠ¨åˆ°å“ªä¸ª target
- `systemd-analyze` æ˜¾ç¤ºæ€»å¯åŠ¨æ—¶é—´
- `blame` æ‰¾å‡ºæœ€æ…¢çš„æœåŠ¡
- `critical-chain` æ˜¾ç¤ºå¯åŠ¨çš„å…³é”®è·¯å¾„

ç°åœ¨è®©æˆ‘ä»¬æ·±å…¥ç†è§£ Target å’Œå¯åŠ¨æµç¨‹ã€‚

---

## Step 1 - ç†è§£ Targetï¼ˆ15 åˆ†é’Ÿï¼‰

### 1.1 ä»€ä¹ˆæ˜¯ Targetï¼Ÿ

Target æ˜¯ systemd çš„åŒæ­¥ç‚¹ï¼ˆSynchronization Pointï¼‰ï¼Œå®ƒï¼š

- **ä¸è¿è¡Œä»»ä½•è¿›ç¨‹**
- **åªæ˜¯ä¸€ç»„ Unit çš„é›†åˆ**
- **å®šä¹‰ç³»ç»ŸçŠ¶æ€çš„é‡Œç¨‹ç¢‘**

```
Target = åŒæ­¥ç‚¹ï¼ˆSynchronization Pointï¼‰

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      multi-user.target                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                                                         â”‚ â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚ â”‚
â”‚  â”‚   â”‚ sshd     â”‚  â”‚ nginx    â”‚  â”‚ cron     â”‚  ...       â”‚ â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚ â”‚
â”‚  â”‚                                                         â”‚ â”‚
â”‚  â”‚   æ‰€æœ‰ WantedBy=multi-user.target çš„æœåŠ¡                â”‚ â”‚
â”‚  â”‚                                                         â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Target æœ¬èº«ä¸è¿è¡Œè¿›ç¨‹ï¼Œåªæ˜¯æŠŠç›¸å…³æœåŠ¡ç»„ç»‡åœ¨ä¸€èµ·çš„"æ ‡ç­¾"
```

### 1.2 SysV Runlevel åˆ° systemd Target æ˜ å°„

å¦‚æœä½ ç†Ÿæ‚‰æ—§çš„ runlevel æ¦‚å¿µï¼Œè¿™æ˜¯å¯¹åº”å…³ç³»ï¼š

| SysV Runlevel | systemd Target | ç”¨é€” |
|---------------|----------------|------|
| 0 | poweroff.target | å…³æœº |
| 1, S | rescue.target | å•ç”¨æˆ·æ¨¡å¼ï¼ˆæ•‘æ´ï¼‰ |
| 2, 3, 4 | multi-user.target | å¤šç”¨æˆ·å‘½ä»¤è¡Œ |
| 5 | graphical.target | å›¾å½¢ç•Œé¢ |
| 6 | reboot.target | é‡å¯ |

```bash
# éªŒè¯æ˜ å°„å…³ç³»
ls -la /usr/lib/systemd/system/runlevel*.target
```

### 1.3 æ ‡å‡† Target å±‚æ¬¡

```
ç³»ç»Ÿå¯åŠ¨çš„ Target å±‚æ¬¡ï¼š

       sysinit.target
             â”‚
             â–¼
       basic.target
             â”‚
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”
     â”‚       â”‚       â”‚
     â–¼       â–¼       â–¼
 sockets  timers   paths
 .target  .target  .target
     â”‚       â”‚       â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”˜
             â–¼
      multi-user.target â† æœåŠ¡å™¨é»˜è®¤åœåœ¨è¿™é‡Œ
             â”‚
             â–¼
      graphical.target  â† æ¡Œé¢ç³»ç»Ÿåœåœ¨è¿™é‡Œ
```

### 1.4 ç‰¹æ®Š Target

| Target | ç”¨é€” |
|--------|------|
| `sysinit.target` | ç³»ç»Ÿåˆå§‹åŒ–ï¼ˆæ–‡ä»¶ç³»ç»Ÿã€swapï¼‰ |
| `basic.target` | åŸºæœ¬ç³»ç»ŸåŠŸèƒ½å°±ç»ª |
| `local-fs.target` | æœ¬åœ°æ–‡ä»¶ç³»ç»ŸæŒ‚è½½å®Œæˆ |
| `network.target` | ç½‘ç»œæ ˆåˆå§‹åŒ– |
| `network-online.target` | ç½‘ç»œå®é™…å¯ç”¨ |
| `timers.target` | Timer ç®¡ç†å°±ç»ª |
| `sockets.target` | Socket ç®¡ç†å°±ç»ª |

**é‡è¦åŒºåˆ†**ï¼š`network.target` vs `network-online.target`

```bash
# network.target - ç½‘ç»œæ ˆåˆå§‹åŒ–ï¼ˆä½†å¯èƒ½è¿˜æ²¡æ‹¿åˆ° IPï¼‰
# network-online.target - ç½‘ç»œå®é™…å¯ç”¨ï¼ˆæœ‰ IPï¼Œèƒ½è¿å¤–ç½‘ï¼‰

# å¯¹äºéœ€è¦ç½‘ç»œè¿æ¥çš„æœåŠ¡ï¼Œåº”è¯¥ç”¨ï¼š
After=network-online.target
Wants=network-online.target
```

---

## Step 2 - Target ç®¡ç†ï¼ˆ10 åˆ†é’Ÿï¼‰

### 2.1 æŸ¥çœ‹å’Œè®¾ç½®é»˜è®¤ Target

```bash
# æŸ¥çœ‹å½“å‰é»˜è®¤ target
systemctl get-default

# è®¾ç½®é»˜è®¤ targetï¼ˆéœ€è¦ rootï¼‰
sudo systemctl set-default multi-user.target    # æœåŠ¡å™¨æ¨è
sudo systemctl set-default graphical.target     # æ¡Œé¢ç³»ç»Ÿ

# æŸ¥çœ‹è®¾ç½®åçš„ç¬¦å·é“¾æ¥
ls -la /etc/systemd/system/default.target
```

### 2.2 åˆ‡æ¢ Targetï¼ˆisolateï¼‰

`isolate` å‘½ä»¤å¯ä»¥ç«‹å³åˆ‡æ¢åˆ°æŒ‡å®š targetï¼Œ**åœæ­¢ä¸å±äºè¯¥ target çš„æœåŠ¡**ï¼š

```bash
# åˆ‡æ¢åˆ°æ•‘æ´æ¨¡å¼ï¼ˆå°å¿ƒï¼ä¼šåœæ­¢å¤§å¤šæ•°æœåŠ¡ï¼‰
sudo systemctl isolate rescue.target

# åˆ‡æ¢å›å¤šç”¨æˆ·æ¨¡å¼
sudo systemctl isolate multi-user.target

# åˆ‡æ¢åˆ°å›¾å½¢ç•Œé¢
sudo systemctl isolate graphical.target
```

**æ³¨æ„**ï¼šä¸æ˜¯æ‰€æœ‰ target éƒ½èƒ½ isolateã€‚åªæœ‰è®¾ç½®äº† `AllowIsolate=yes` çš„ target æ‰è¡Œã€‚

### 2.3 æŸ¥çœ‹ Target ä¾èµ–

```bash
# æŸ¥çœ‹ multi-user.target åŒ…å«å“ªäº›æœåŠ¡
systemctl list-dependencies multi-user.target

# åå‘æŸ¥è¯¢ï¼šå“ªäº›æœåŠ¡å±äºè¿™ä¸ª target
systemctl list-dependencies --reverse multi-user.target | head -20

# é€’å½’æ˜¾ç¤ºå®Œæ•´ä¾èµ–æ ‘
systemctl list-dependencies multi-user.target --all | head -30
```

---

## Step 3 - å®Œæ•´å¯åŠ¨æµç¨‹ï¼ˆ20 åˆ†é’Ÿï¼‰

### 3.1 äº”é˜¶æ®µå¯åŠ¨æµç¨‹

Linux ç³»ç»Ÿä»æŒ‰ä¸‹ç”µæºé”®åˆ°ç™»å½•æç¤ºï¼Œç»å† 5 ä¸ªé˜¶æ®µï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Linux å®Œæ•´å¯åŠ¨æµç¨‹                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  Stage 1: Firmware (UEFI/BIOS)                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ - POST (Power-On Self-Test)                                       â”‚ â”‚
â”‚  â”‚ - ç¡¬ä»¶åˆå§‹åŒ–                                                       â”‚ â”‚
â”‚  â”‚ - æŸ¥æ‰¾å¯åŠ¨è®¾å¤‡                                                     â”‚ â”‚
â”‚  â”‚ - åŠ è½½ Bootloader                                                  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                              â”‚                                         â”‚
â”‚                              â–¼                                         â”‚
â”‚  Stage 2: Bootloader (GRUB2)                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ - æ˜¾ç¤ºå†…æ ¸é€‰æ‹©èœå•                                                 â”‚ â”‚
â”‚  â”‚ - åŠ è½½é€‰å®šçš„å†…æ ¸å’Œ initramfs                                       â”‚ â”‚
â”‚  â”‚ - ä¼ é€’å†…æ ¸å‚æ•°                                                     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                              â”‚                                         â”‚
â”‚                              â–¼                                         â”‚
â”‚  Stage 3: Kernel Initialization                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ - ç¡¬ä»¶æ£€æµ‹å’Œé©±åŠ¨åŠ è½½                                               â”‚ â”‚
â”‚  â”‚ - æŒ‚è½½ initramfs ä½œä¸ºä¸´æ—¶æ ¹æ–‡ä»¶ç³»ç»Ÿ                                â”‚ â”‚
â”‚  â”‚ - å†…æ ¸å‚æ•°ï¼šsystemd.unit=, rd.break, init=                        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                              â”‚                                         â”‚
â”‚                              â–¼                                         â”‚
â”‚  Stage 4: initramfs Stage                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ - è¿è¡Œ initramfs ä¸­çš„è„šæœ¬                                         â”‚ â”‚
â”‚  â”‚ - è®¾ç½® LVM/LUKS/RAID                                              â”‚ â”‚
â”‚  â”‚ - æŒ‚è½½çœŸæ­£çš„æ ¹æ–‡ä»¶ç³»ç»Ÿ                                             â”‚ â”‚
â”‚  â”‚ - åˆ‡æ¢åˆ°çœŸå®æ ¹ï¼ˆpivot_rootï¼‰                                       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                              â”‚                                         â”‚
â”‚                              â–¼                                         â”‚
â”‚  Stage 5: systemd (PID 1)                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ - å†…æ ¸æ‰§è¡Œ /sbin/init -> systemd                                  â”‚ â”‚
â”‚  â”‚ - è§£æ Unit æ–‡ä»¶                                                   â”‚ â”‚
â”‚  â”‚ - sysinit.target -> basic.target -> multi-user.target             â”‚ â”‚
â”‚  â”‚ - åˆ°è¾¾é»˜è®¤ targetï¼Œæ˜¾ç¤ºç™»å½•æç¤º                                    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 Stage 2: Bootloader (GRUB2)

```bash
# æŸ¥çœ‹ GRUB é…ç½®
cat /etc/default/grub

# å¸¸ç”¨å†…æ ¸å‚æ•°
# systemd.unit=emergency.target  - å¯åŠ¨åˆ°ç´§æ€¥æ¨¡å¼
# rd.break                       - åœ¨æŒ‚è½½æ ¹ä¹‹å‰è¿›å…¥ initramfs shell
# init=/bin/bash                 - ç»•è¿‡ systemdï¼ˆæœ€åæ‰‹æ®µï¼‰

# é‡æ–°ç”Ÿæˆ GRUB é…ç½®ï¼ˆä¿®æ”¹åï¼‰
# RHEL/CentOS/Rocky:
sudo grub2-mkconfig -o /boot/grub2/grub.cfg
# Ubuntu/Debian:
sudo update-grub
```

### 3.3 Stage 4: initramfs å’Œ dracut

initramfsï¼ˆInitial RAM Filesystemï¼‰æ˜¯ä¸€ä¸ªä¸´æ—¶çš„æ ¹æ–‡ä»¶ç³»ç»Ÿï¼Œåœ¨å†…æ ¸åŠ è½½åã€æŒ‚è½½çœŸæ­£æ ¹ä¹‹å‰ä½¿ç”¨ã€‚

```bash
# æŸ¥çœ‹ initramfs å†…å®¹
lsinitrd | head -50

# æŸ¥çœ‹ initramfs ä¸­åŒ…å«çš„æ¨¡å—
lsinitrd | grep -E "\.ko$" | head -20

# é‡å»º initramfsï¼ˆæ·»åŠ  LVM/LUKS æ¨¡å—åï¼‰
sudo dracut -f

# æŸ¥çœ‹å¯ç”¨çš„ dracut æ¨¡å—
dracut --list-modules
```

**ä½•æ—¶éœ€è¦é‡å»º initramfsï¼š**

- æ·»åŠ  LVM/LUKS/multipath æ”¯æŒ
- å†…æ ¸æ›´æ–°å¤±è´¥åä¿®å¤
- å¯åŠ¨å¡åœ¨ initramfs é˜¶æ®µ

### 3.4 Stage 5: systemd Target æµç¨‹

```bash
# æŸ¥çœ‹å®Œæ•´çš„å¯åŠ¨ä¾èµ–é“¾
systemctl list-dependencies default.target --all | head -50

# å¯åŠ¨æµç¨‹å¯è§†åŒ–
systemd-analyze plot > /tmp/boot.svg
# ç”¨æµè§ˆå™¨æ‰“å¼€ /tmp/boot.svg æŸ¥çœ‹æ—¶é—´çº¿å›¾
```

---

## Step 4 - å¯åŠ¨æ€§èƒ½åˆ†æï¼ˆ10 åˆ†é’Ÿï¼‰

### 4.1 systemd-analyze å‘½ä»¤é›†

```bash
# åŸºæœ¬å¯åŠ¨æ—¶é—´
systemd-analyze

# è¾“å‡ºç¤ºä¾‹ï¼š
# Startup finished in 2.5s (firmware) + 3.1s (loader) + 1.2s (kernel)
#                    + 4.3s (initrd) + 15.2s (userspace) = 26.3s

# å„æœåŠ¡å¯åŠ¨æ—¶é—´æ’åº
systemd-analyze blame | head -15

# å¯åŠ¨å…³é”®è·¯å¾„ï¼ˆCritical Chainï¼‰
systemd-analyze critical-chain
```

### 4.2 ç†è§£ Critical Chain

```bash
# å…³é”®è·¯å¾„åˆ†æ
systemd-analyze critical-chain

# è¾“å‡ºç¤ºä¾‹ï¼š
# graphical.target @20.130s
# â””â”€multi-user.target @20.130s
#   â””â”€postgresql.service @15.523s +4.607s
#     â””â”€network-online.target @15.521s
#       â””â”€NetworkManager-wait-online.service @5.123s +10.398s
#         â””â”€NetworkManager.service @4.865s +256ms
#           â””â”€basic.target @4.863s
```

**å…³é”®è·¯å¾„è§£è¯»ï¼š**

- `@` åé¢æ˜¯è¯¥ Unit å¯åŠ¨çš„æ—¶é—´ç‚¹
- `+` åé¢æ˜¯è¯¥ Unit å¯åŠ¨è€—æ—¶
- æœ€ä¸‹é¢çš„æ˜¯å…ˆå¯åŠ¨çš„ï¼Œæœ€ä¸Šé¢çš„æ˜¯æœ€åå¯åŠ¨çš„
- ä¼˜åŒ–å…³é”®è·¯å¾„ä¸Šçš„æœåŠ¡å¯ä»¥å‡å°‘æ€»å¯åŠ¨æ—¶é—´

### 4.3 ç”Ÿæˆå¯åŠ¨æ—¶é—´çº¿å›¾

```bash
# ç”Ÿæˆ SVG æ—¶é—´çº¿å›¾
systemd-analyze plot > /tmp/boot-timeline.svg

# å¦‚æœæ˜¯æœåŠ¡å™¨ï¼ˆæ— å›¾å½¢ç•Œé¢ï¼‰ï¼Œå¯ä»¥ scp ä¸‹è½½åˆ°æœ¬åœ°æŸ¥çœ‹
# æˆ–è€…ç”¨ systemd-analyze blame çš„æ–‡æœ¬è¾“å‡º

# æŸ¥çœ‹ç‰¹å®š target çš„ä¾èµ–
systemd-analyze critical-chain multi-user.target
```

### 4.4 å¸¸è§å¯åŠ¨æ…¢çš„åŸå› 

| æœåŠ¡ | å¸¸è§åŸå›  | ä¼˜åŒ–æ–¹æ³• |
|------|----------|----------|
| NetworkManager-wait-online | ç­‰å¾… DHCP | é™æ€ IP æˆ–è°ƒæ•´è¶…æ—¶ |
| plymouth-quit-wait | ç­‰å¾…å¯åŠ¨ç”»é¢ | æœåŠ¡å™¨å¯ç¦ç”¨ plymouth |
| systemd-udev-settle | ç­‰å¾…è®¾å¤‡ç¨³å®š | æ£€æŸ¥æ…¢è®¾å¤‡æˆ–ç¦ç”¨ |
| lvm2-monitor | LVM ç›‘æ§ | æ—  LVM å¯ç¦ç”¨ |

```bash
# æ£€æŸ¥æ˜¯å¦æœ‰è¶…æ—¶ç­‰å¾…çš„æœåŠ¡
journalctl -b | grep -i timeout

# ç¦ç”¨ä¸éœ€è¦çš„æœåŠ¡
sudo systemctl disable plymouth-quit-wait.service  # æœåŠ¡å™¨æ— éœ€
```

---

## Step 5 - æ—¶é—´åŒæ­¥ï¼ˆ10 åˆ†é’Ÿï¼‰

### 5.1 ä¸ºä»€ä¹ˆæ—¶é—´åŒæ­¥è‡³å…³é‡è¦ï¼Ÿ

æ—¶é—´åŒæ­¥å¯¹è¿ç»´è‡³å…³é‡è¦ï¼š

| åœºæ™¯ | æ—¶é—´ä¸å‡†çš„åæœ |
|------|----------------|
| TLS/SSL æ¡æ‰‹ | è¯ä¹¦éªŒè¯å¤±è´¥ï¼ˆNot Yet Valid / Expiredï¼‰ |
| æ—¥å¿—å…³è” | å¤šæœåŠ¡å™¨æ•…éšœæ’æŸ¥æ—¶æ— æ³•å…³è”æ—¥å¿— |
| åˆ†å¸ƒå¼ç³»ç»Ÿ | Kubernetesã€etcd å…±è¯†å¤±è´¥ |
| å®šæ—¶ä»»åŠ¡ | cron/timer æ‰§è¡Œæ—¶é—´é”™è¯¯ |
| å®¡è®¡åˆè§„ | ISMSã€PCI DSS è¦æ±‚æ—¶é—´å‡†ç¡® |

### 5.2 chrony vs ntpd

| ç‰¹æ€§ | chrony | ntpd |
|------|--------|------|
| çŠ¶æ€ | ç°ä»£é»˜è®¤ï¼ˆRHEL 9, Ubuntu 22.04+ï¼‰ | ä¼ ç»Ÿæ–¹æ¡ˆ |
| åŒæ­¥é€Ÿåº¦ | å¿«é€Ÿï¼Œé€‚åˆ VM å’Œç§»åŠ¨è®¾å¤‡ | è¾ƒæ…¢ |
| èµ„æºå ç”¨ | ä½ | è¾ƒé«˜ |
| æ¨èåœºæ™¯ | ç”Ÿäº§ç¯å¢ƒé¦–é€‰ | ç‰¹æ®Šå…¼å®¹éœ€æ±‚ |

### 5.3 timedatectl å‘½ä»¤

```bash
# æŸ¥çœ‹å½“å‰æ—¶é—´çŠ¶æ€
timedatectl

# è¾“å‡ºç¤ºä¾‹ï¼š
#                Local time: Sun 2026-01-04 15:30:45 JST
#            Universal time: Sun 2026-01-04 06:30:45 UTC
#                  RTC time: Sun 2026-01-04 06:30:45
#                 Time zone: Asia/Tokyo (JST, +0900)
# System clock synchronized: yes
#               NTP service: active
#           RTC in local TZ: no

# è®¾ç½®æ—¶åŒºï¼ˆæ—¥æœ¬ï¼‰
sudo timedatectl set-timezone Asia/Tokyo

# å¯ç”¨ NTP åŒæ­¥
sudo timedatectl set-ntp true

# æŸ¥çœ‹åŒæ­¥çŠ¶æ€ï¼ˆä½¿ç”¨ systemd-timesyncd æ—¶ï¼‰
timedatectl timesync-status
```

### 5.4 chrony æ“ä½œ

```bash
# æ£€æŸ¥ chrony æœåŠ¡çŠ¶æ€
systemctl status chronyd

# æŸ¥çœ‹ NTP æº
chronyc sources

# è¾“å‡ºç¤ºä¾‹ï¼š
# MS Name/IP address         Stratum Poll Reach LastRx Last sample
# ===============================================================================
# ^* ntp.nict.jp                   1   6   377    34   -234us[ -312us] +/-   11ms
# ^+ ntp.jst.mfeed.ad.jp           2   6   377    35   +892us[ +814us] +/-   21ms

# æŸ¥çœ‹åŒæ­¥çŠ¶æ€
chronyc tracking

# å¼ºåˆ¶ç«‹å³åŒæ­¥ï¼ˆè°¨æ…ä½¿ç”¨ï¼‰
sudo chronyc makestep
```

### 5.5 åæ¨¡å¼ï¼šå¿½ç•¥æ—¶é—´æ¼‚ç§»

**é”™è¯¯åšæ³•**ï¼šåœ¨éšœå®³å¯¾å¿œæ—¶å¿½ç•¥æ—¶é—´æ£€æŸ¥ã€‚

**æ­£ç¡®åšæ³•**ï¼šæ•…éšœæ’æŸ¥ç¬¬ä¸€æ­¥æ£€æŸ¥æ—¶é—´åŒæ­¥ã€‚

```bash
# æ•…éšœæ’æŸ¥æ—¶çš„æ—¶é—´æ£€æŸ¥æ¸…å•
timedatectl                    # æ—¶é—´å’Œæ—¶åŒºæ˜¯å¦æ­£ç¡®ï¼Ÿ
chronyc sources                # NTP æºæ˜¯å¦å¯è¾¾ï¼Ÿ
chronyc tracking               # æ—¶é—´åå·®æœ‰å¤šå¤§ï¼Ÿ
```

---

## Step 6 - ç´§æ€¥å’Œæ•‘æ´æ¨¡å¼ï¼ˆ10 åˆ†é’Ÿï¼‰

### 6.1 ä¸‰ç§æ¢å¤æ¨¡å¼

| æ¨¡å¼ | è®¿é—®æ–¹å¼ | æä¾›çš„ç¯å¢ƒ | ä½¿ç”¨åœºæ™¯ |
|------|----------|------------|----------|
| `rescue.target` | `systemctl isolate` æˆ–å†…æ ¸å‚æ•° | å•ç”¨æˆ·ï¼ŒåŸºæœ¬æ–‡ä»¶ç³»ç»ŸæŒ‚è½½ | ä¿®å¤é…ç½®ã€å¯†ç é‡ç½® |
| `emergency.target` | å†…æ ¸å‚æ•° `systemd.unit=emergency.target` | æœ€å°ç¯å¢ƒï¼Œä»…æ ¹æ–‡ä»¶ç³»ç»Ÿ | ä¸¥é‡é—®é¢˜ä¿®å¤ |
| `rd.break` | å†…æ ¸å‚æ•° | initramfs shell | å¯†ç é‡ç½®ã€æ–‡ä»¶ç³»ç»Ÿä¿®å¤ |

### 6.2 è¿›å…¥æ•‘æ´æ¨¡å¼

**æ–¹æ³• 1ï¼šä»è¿è¡Œä¸­çš„ç³»ç»Ÿ**

```bash
# åˆ‡æ¢åˆ°æ•‘æ´æ¨¡å¼
sudo systemctl isolate rescue.target

# è¿”å›æ­£å¸¸æ¨¡å¼
sudo systemctl isolate multi-user.target
```

**æ–¹æ³• 2ï¼šä» GRUB å¯åŠ¨èœå•**

1. é‡å¯ç³»ç»Ÿï¼Œåœ¨ GRUB èœå•æŒ‰ `e` ç¼–è¾‘
2. æ‰¾åˆ° `linux` è¡Œï¼Œåœ¨è¡Œæœ«æ·»åŠ ï¼š
   - `systemd.unit=rescue.target` - æ•‘æ´æ¨¡å¼
   - `systemd.unit=emergency.target` - ç´§æ€¥æ¨¡å¼
3. æŒ‰ `Ctrl+X` å¯åŠ¨

### 6.3 ä½¿ç”¨ rd.break é‡ç½® root å¯†ç 

**è¿™æ˜¯ RHCSA è€ƒè¯•é‡ç‚¹ï¼**

1. åœ¨ GRUB èœå•æŒ‰ `e` ç¼–è¾‘
2. åœ¨ `linux` è¡Œæœ«æ·»åŠ  `rd.break`
3. æŒ‰ `Ctrl+X` å¯åŠ¨

```bash
# è¿›å…¥ initramfs shell å
# çœŸå®æ ¹æ–‡ä»¶ç³»ç»ŸæŒ‚è½½åœ¨ /sysroot

# é‡æ–°æŒ‚è½½ä¸ºå¯å†™
mount -o remount,rw /sysroot

# è¿›å…¥çœŸå®æ ¹ç¯å¢ƒ
chroot /sysroot

# é‡ç½®å¯†ç 
passwd root

# è§¦å‘ SELinux é‡æ–°æ ‡è®°ï¼ˆRHEL/CentOS å¿…éœ€ï¼‰
touch /.autorelabel

# é€€å‡ºå¹¶é‡å¯
exit
exit
# æˆ–è€… reboot -f
```

### 6.4 æ•‘æ´æ¨¡å¼å®ç”¨æŠ€å·§

```bash
# åœ¨æ•‘æ´æ¨¡å¼ä¸‹æ£€æŸ¥æ—¥å¿—
journalctl -xb

# æ£€æŸ¥å¯åŠ¨å¤±è´¥çš„æœåŠ¡
systemctl --failed

# æ£€æŸ¥æ–‡ä»¶ç³»ç»Ÿ
fsck /dev/sda1

# é‡æ–°åŠ è½½ systemdï¼ˆä¿®æ”¹ unit æ–‡ä»¶åï¼‰
systemctl daemon-reload
```

---

## Step 7 - Mini-Projectï¼šåˆ›å»ºè‡ªå®šä¹‰ Targetï¼ˆ15 åˆ†é’Ÿï¼‰

### ä»»åŠ¡ç›®æ ‡

ä¸ºåº”ç”¨æ ˆåˆ›å»º `myapp.target`ï¼Œç»Ÿä¸€ç®¡ç†ç›¸å…³æœåŠ¡ï¼ˆWebã€APIã€Workerï¼‰ã€‚

### 7.1 åœºæ™¯è¯´æ˜

```
è‡ªå®šä¹‰ Target æ¶æ„ï¼š

              myapp.target
                   â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚         â”‚         â”‚
         â–¼         â–¼         â–¼
   myapp-web    myapp-api   myapp-worker
    .service     .service    .service

ä¸€ä¸ªå‘½ä»¤å¯åŠ¨/åœæ­¢æ•´ä¸ªåº”ç”¨æ ˆï¼š
  systemctl start myapp.target
  systemctl stop myapp.target
```

### 7.2 åˆ›å»º Target æ–‡ä»¶

```bash
# åˆ›å»ºå·¥ä½œç›®å½•
mkdir -p ~/systemd-lab/myapp-target
cd ~/systemd-lab/myapp-target

# åˆ›å»ºè‡ªå®šä¹‰ Target
sudo tee /etc/systemd/system/myapp.target << 'EOF'
[Unit]
Description=My Application Stack Target
Documentation=https://example.com/myapp
Requires=basic.target
After=basic.target network-online.target
Wants=network-online.target
# å…è®¸ isolate åˆ°è¿™ä¸ª target
AllowIsolate=yes

[Install]
WantedBy=multi-user.target
EOF
```

### 7.3 åˆ›å»ºåº”ç”¨æœåŠ¡

```bash
# Web æœåŠ¡ï¼ˆæ¨¡æ‹Ÿï¼‰
sudo tee /etc/systemd/system/myapp-web.service << 'EOF'
[Unit]
Description=MyApp Web Server
Documentation=https://example.com/myapp/web
After=network-online.target myapp-api.service
Wants=network-online.target
# å±äº myapp.target
PartOf=myapp.target

[Service]
Type=simple
ExecStart=/bin/sleep infinity
Restart=on-failure
RestartSec=5

[Install]
WantedBy=myapp.target
EOF

# API æœåŠ¡ï¼ˆæ¨¡æ‹Ÿï¼‰
sudo tee /etc/systemd/system/myapp-api.service << 'EOF'
[Unit]
Description=MyApp API Server
Documentation=https://example.com/myapp/api
After=network-online.target
Wants=network-online.target
PartOf=myapp.target

[Service]
Type=simple
ExecStart=/bin/sleep infinity
Restart=on-failure
RestartSec=5

[Install]
WantedBy=myapp.target
EOF

# Worker æœåŠ¡ï¼ˆæ¨¡æ‹Ÿï¼‰
sudo tee /etc/systemd/system/myapp-worker.service << 'EOF'
[Unit]
Description=MyApp Background Worker
Documentation=https://example.com/myapp/worker
After=myapp-api.service
PartOf=myapp.target

[Service]
Type=simple
ExecStart=/bin/sleep infinity
Restart=on-failure
RestartSec=5

[Install]
WantedBy=myapp.target
EOF
```

### 7.4 å¯ç”¨å’Œæµ‹è¯•

```bash
# é‡æ–°åŠ è½½ systemd
sudo systemctl daemon-reload

# å¯ç”¨æ‰€æœ‰æœåŠ¡ï¼ˆåˆ›å»ºç¬¦å·é“¾æ¥åˆ° targetï¼‰
sudo systemctl enable myapp-web.service myapp-api.service myapp-worker.service

# å¯åŠ¨æ•´ä¸ªåº”ç”¨æ ˆ
sudo systemctl start myapp.target

# æŸ¥çœ‹çŠ¶æ€
systemctl status myapp.target
systemctl status myapp-*.service

# æŸ¥çœ‹ target åŒ…å«çš„æœåŠ¡
systemctl list-dependencies myapp.target

# åœæ­¢æ•´ä¸ªåº”ç”¨æ ˆï¼ˆPartOf= ä¼šä¼ æ’­åœæ­¢ä¿¡å·ï¼‰
sudo systemctl stop myapp.target

# éªŒè¯æ‰€æœ‰æœåŠ¡éƒ½å·²åœæ­¢
systemctl status myapp-*.service
```

### 7.5 éªŒè¯æ¸…å•

- [ ] åˆ›å»ºäº† myapp.target æ–‡ä»¶
- [ ] åˆ›å»ºäº† 3 ä¸ª myapp-*.service æ–‡ä»¶
- [ ] ä½¿ç”¨ `WantedBy=myapp.target` å…³è”æœåŠ¡
- [ ] ä½¿ç”¨ `PartOf=myapp.target` ä¼ æ’­åœæ­¢ä¿¡å·
- [ ] `systemctl start myapp.target` å¯åŠ¨æ‰€æœ‰æœåŠ¡
- [ ] `systemctl stop myapp.target` åœæ­¢æ‰€æœ‰æœåŠ¡

---

## åæ¨¡å¼ï¼šå¸¸è§é”™è¯¯

### é”™è¯¯ 1ï¼šæ··æ·† network.target å’Œ network-online.target

**é”™è¯¯åšæ³•**ï¼š

```ini
[Unit]
After=network.target
```

**é—®é¢˜**ï¼š`network.target` åªè¡¨ç¤ºç½‘ç»œæ ˆåˆå§‹åŒ–ï¼Œä¸ä¿è¯ç½‘ç»œå¯ç”¨ã€‚

**æ­£ç¡®åšæ³•**ï¼š

```ini
[Unit]
After=network-online.target
Wants=network-online.target
```

### é”™è¯¯ 2ï¼šä¸æ£€æŸ¥æ—¶é—´åŒæ­¥å°±å¼€å§‹æ•…éšœæ’æŸ¥

**é”™è¯¯åšæ³•**ï¼šç›´æ¥æŸ¥çœ‹æ—¥å¿—ï¼Œå¿½ç•¥æ—¶é—´ã€‚

**é—®é¢˜**ï¼šå¦‚æœæ—¶é—´ä¸åŒæ­¥ï¼Œæ—¥å¿—æ—¶é—´æˆ³æ— æ³•ä¸å…¶ä»–æœåŠ¡å™¨å…³è”ã€‚

**æ­£ç¡®åšæ³•**ï¼š

```bash
# æ•…éšœæ’æŸ¥ç¬¬ä¸€æ­¥
timedatectl
chronyc tracking
```

### é”™è¯¯ 3ï¼šåœ¨æ•‘æ´æ¨¡å¼å¿˜è®°é‡æ–°æŒ‚è½½æ–‡ä»¶ç³»ç»Ÿ

**é”™è¯¯åšæ³•**ï¼š

```bash
# è¿›å…¥æ•‘æ´æ¨¡å¼åç›´æ¥ç¼–è¾‘æ–‡ä»¶
vi /etc/fstab  # å¤±è´¥ï¼æ–‡ä»¶ç³»ç»Ÿæ˜¯åªè¯»çš„
```

**æ­£ç¡®åšæ³•**ï¼š

```bash
# å…ˆé‡æ–°æŒ‚è½½ä¸ºå¯å†™
mount -o remount,rw /
# ç„¶åç¼–è¾‘
vi /etc/fstab
```

---

## èŒåœºå°è´´å£«ï¼ˆJapan IT Contextï¼‰

### ãƒ–ãƒ¼ãƒˆå•é¡Œã®ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

åœ¨æ—¥æœ¬ IT ä¼ä¸šï¼Œç³»ç»Ÿå¯åŠ¨é—®é¢˜çš„æ’æŸ¥æµç¨‹ï¼š

```
éšœå®³å¯¾å¿œãƒ•ãƒ­ãƒ¼ï¼ˆå¯åŠ¨é—®é¢˜ï¼‰ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. æƒ…å ±åé›†ï¼ˆä¿¡æ¯æ”¶é›†ï¼‰                           â”‚
â”‚    - ã©ã®æ®µéšã§æ­¢ã¾ã£ã¦ã„ã‚‹ã‹ï¼Ÿ                   â”‚
â”‚    - ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ä½•ã‹ï¼Ÿ                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. èµ·å‹•æ™‚é–“åˆ†æ                                  â”‚
â”‚    systemd-analyze                              â”‚
â”‚    systemd-analyze blame                        â”‚
â”‚    systemd-analyze critical-chain               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. æ™‚åˆ»åŒæœŸç¢ºèª                                  â”‚
â”‚    timedatectl                                  â”‚
â”‚    chronyc sources                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. ãƒ­ã‚°ç¢ºèª                                      â”‚
â”‚    journalctl -xb                               â”‚
â”‚    journalctl -u [failed-service]               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. ä¿®æ­£ã¨æ¤œè¨¼                                    â”‚
â”‚    - è¨­å®šä¿®æ­£                                    â”‚
â”‚    - daemon-reload                              â”‚
â”‚    - ã‚µãƒ¼ãƒ“ã‚¹å†èµ·å‹•                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ—¥æœ¬ IT æœ¯è¯­å¯¹ç…§

| æ—¥è¯­æœ¯è¯­ | è¯»éŸ³ | å«ä¹‰ | ç›¸å…³å‘½ä»¤ |
|----------|------|------|----------|
| ãƒ–ãƒ¼ãƒˆ | ãƒ–ãƒ¼ãƒˆ | Boot | systemd-analyze |
| èµ·å‹•é †åº | ãã©ã†ã˜ã‚…ã‚“ã˜ã‚‡ | å¯åŠ¨é¡ºåº | critical-chain |
| ãƒ¬ã‚¹ã‚­ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ‰ | ãƒ¬ã‚¹ã‚­ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ‰ | Rescue mode | rescue.target |
| æ™‚åˆ»åŒæœŸ | ã˜ã“ãã©ã†ã | æ—¶é—´åŒæ­¥ | timedatectl, chronyc |
| ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ | Default | get-default |

### å®¡è®¡è¦æ±‚

åœ¨æ—¥æœ¬ IT ä¼ä¸šï¼Œæ—¶é—´åŒæ­¥å¯¹å®¡è®¡è‡³å…³é‡è¦ï¼š

```
ISMS/PCI DSS è¦æ±‚ï¼š
- æ‰€æœ‰æœåŠ¡å™¨æ—¶é—´å¿…é¡»åŒæ­¥
- NTP æºå¿…é¡»å¯è¿½æº¯
- æ—¶é—´åå·®å¿…é¡»åœ¨å®¹è®¸èŒƒå›´å†…

æ£€æŸ¥é¡¹ç›®ï¼š
â–¡ timedatectl æ˜¾ç¤º NTP service: active
â–¡ chronyc tracking æ˜¾ç¤º Leap status: Normal
â–¡ æ—¶é—´åå·® < 100ms
```

---

## é¢è¯•å‡†å¤‡ï¼ˆInterview Prepï¼‰

### Q1: multi-user.target ã¨ graphical.target ã®é•ã„ã¯ï¼Ÿ

**å›ç­”è¦ç‚¹**ï¼š

```
multi-user.target:
- CLI ç’°å¢ƒï¼ˆã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ï¼‰
- ã‚µãƒ¼ãƒãƒ¼å‘ã‘ã®æ¨™æº–è¨­å®š
- ãƒªã‚½ãƒ¼ã‚¹æ¶ˆè²»ãŒå°‘ãªã„
- SSH ã§ã‚¢ã‚¯ã‚»ã‚¹

graphical.target:
- GUI ç’°å¢ƒï¼ˆãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ï¼‰
- ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ— PCã€ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³å‘ã‘
- Display Manager ãŒèµ·å‹•
- ã‚ˆã‚Šå¤šãã®ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½¿ç”¨

ã‚µãƒ¼ãƒãƒ¼ã¯ multi-user.target ãŒæ¨å¥¨ã€‚
```

### Q2: ãƒ–ãƒ¼ãƒˆãŒé…ã„æ™‚ã®èª¿æŸ»æ–¹æ³•ã¯ï¼Ÿ

**å›ç­”è¦ç‚¹**ï¼š

```
1. å…¨ä½“æ™‚é–“ã®ç¢ºèª
   systemd-analyze
   â†’ firmware, loader, kernel, initrd, userspace ã®å„æ®µéš

2. é…ã„ã‚µãƒ¼ãƒ“ã‚¹ã®ç‰¹å®š
   systemd-analyze blame | head -10
   â†’ æ™‚é–“ãŒã‹ã‹ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã‚’ãƒªã‚¹ãƒˆã‚¢ãƒƒãƒ—

3. ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ãƒ‘ã‚¹ã®ç¢ºèª
   systemd-analyze critical-chain
   â†’ ãƒœãƒˆãƒ«ãƒãƒƒã‚¯ã«ãªã£ã¦ã„ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã‚’ç‰¹å®š

4. å¯¾ç­–
   - ä¸è¦ãªã‚µãƒ¼ãƒ“ã‚¹ã‚’ç„¡åŠ¹åŒ–
   - ä¾å­˜é–¢ä¿‚ã®æœ€é©åŒ–
   - ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®šã®è¦‹ç›´ã—
```

### Q3: æ™‚åˆ»åŒæœŸãŒé‡è¦ãªç†ç”±ã¯ï¼Ÿ

**å›ç­”è¦ç‚¹**ï¼š

```
1. TLS/SSL
   - è¨¼æ˜æ›¸ã®æœ‰åŠ¹æœŸé™ãƒã‚§ãƒƒã‚¯ã§æ™‚åˆ»ãŒå¿…è¦
   - æ™‚åˆ»ãŒãšã‚Œã‚‹ã¨ã€Œè¨¼æ˜æ›¸ãŒç„¡åŠ¹ã€ã‚¨ãƒ©ãƒ¼

2. ãƒ­ã‚°åˆ†æ
   - è¤‡æ•°ã‚µãƒ¼ãƒãƒ¼ã®ãƒ­ã‚°ã‚’æ™‚ç³»åˆ—ã§é–¢é€£ä»˜ã‘
   - ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆèª¿æŸ»ã§æ™‚åˆ»ä¸€è‡´ãŒå¿…é ˆ

3. åˆ†æ•£ã‚·ã‚¹ãƒ†ãƒ 
   - Kubernetes, etcd ãªã©ã®ã‚³ãƒ³ã‚»ãƒ³ã‚µã‚¹
   - æ™‚åˆ»ãšã‚Œã§ split-brain ã®å¯èƒ½æ€§

4. ç›£æŸ»ãƒ»ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹
   - ISMS, PCI DSS ã§æ­£ç¢ºãªæ™‚åˆ»è¨˜éŒ²ãŒè¦æ±‚
```

---

## æ£€æŸ¥æ¸…å•

å®Œæˆæœ¬è¯¾åï¼Œä½ åº”è¯¥èƒ½å¤Ÿï¼š

- [ ] è§£é‡Š Target æ˜¯åŒæ­¥ç‚¹ï¼Œä¸è¿è¡Œè¿›ç¨‹
- [ ] å¯¹åº” SysV runlevel åˆ° systemd targetï¼ˆ0=poweroff, 1=rescue, 3=multi-user, 5=graphical, 6=rebootï¼‰
- [ ] ä½¿ç”¨ `get-default`/`set-default` ç®¡ç†é»˜è®¤ target
- [ ] ä½¿ç”¨ `isolate` åˆ‡æ¢ target
- [ ] æè¿° 5 é˜¶æ®µå¯åŠ¨æµç¨‹ï¼ˆFirmware > Bootloader > Kernel > initramfs > systemdï¼‰
- [ ] ä½¿ç”¨ `systemd-analyze` åˆ†æå¯åŠ¨æ€§èƒ½
- [ ] ä½¿ç”¨ `timedatectl` å’Œ `chronyc` ç®¡ç†æ—¶é—´åŒæ­¥
- [ ] ä½¿ç”¨ `lsinitrd` å’Œ `dracut` ç®¡ç† initramfs
- [ ] ä½¿ç”¨æ•‘æ´æ¨¡å¼å’Œç´§æ€¥æ¨¡å¼æ’æŸ¥é—®é¢˜
- [ ] ä½¿ç”¨ `rd.break` é‡ç½® root å¯†ç 
- [ ] åˆ›å»ºè‡ªå®šä¹‰ Target ç®¡ç†åº”ç”¨æ ˆ

---

## æœ¬è¯¾å°ç»“

| æ¦‚å¿µ | è¦ç‚¹ |
|------|------|
| Target | åŒæ­¥ç‚¹ï¼Œä¸è¿è¡Œè¿›ç¨‹ï¼Œåªæ˜¯æœåŠ¡åˆ†ç»„ |
| Runlevel æ˜ å°„ | 0=poweroff, 1=rescue, 3=multi-user, 5=graphical, 6=reboot |
| 5 é˜¶æ®µå¯åŠ¨ | Firmware > Bootloader > Kernel > initramfs > systemd |
| å¯åŠ¨åˆ†æ | systemd-analyze, blame, critical-chain |
| æ—¶é—´åŒæ­¥ | timedatectl + chronyï¼ˆç°ä»£é¦–é€‰ï¼‰ |
| æ•‘æ´æ¨¡å¼ | rescue.targetï¼ˆåŸºæœ¬ç¯å¢ƒï¼‰, emergency.targetï¼ˆæœ€å°ç¯å¢ƒï¼‰, rd.breakï¼ˆinitramfs shellï¼‰ |

---

## å»¶ä¼¸é˜…è¯»

- [systemd Targets å®˜æ–¹æ–‡æ¡£](https://www.freedesktop.org/software/systemd/man/systemd.target.html)
- [systemd-analyze æ‰‹å†Œ](https://www.freedesktop.org/software/systemd/man/systemd-analyze.html)
- [chrony å®˜æ–¹æ–‡æ¡£](https://chrony.tuxfamily.org/documentation.html)
- [dracut æ‰‹å†Œ](https://man7.org/linux/man-pages/man8/dracut.8.html)
- ä¸Šä¸€è¯¾ï¼š[04 - ä¾èµ–ä¸æ’åº](../04-dependencies/) - ç†è§£ systemd ä¾èµ–å…³ç³»
- ä¸‹ä¸€è¯¾ï¼š[06 - Timerï¼ˆç°ä»£ cron æ›¿ä»£ï¼‰](../06-timers/) - å­¦ä¹  systemd å®šæ—¶ä»»åŠ¡

---

## ç³»åˆ—å¯¼èˆª

[<-- 04 - ä¾èµ–ä¸æ’åº](../04-dependencies/) | [ç³»åˆ—é¦–é¡µ](../) | [06 - Timer -->](../06-timers/)
