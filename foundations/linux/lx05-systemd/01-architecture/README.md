# 01 - æž¶æž„ä¸Žè®¾è®¡å“²å­¦ï¼ˆArchitecture and Philosophyï¼‰

> **ç›®æ ‡**ï¼šç†è§£ systemd çš„æž¶æž„è®¾è®¡ï¼Œè®¤è¯† PID 1 çš„èŒè´£å’Œ 11 ç§ Unit ç±»åž‹  
> **å‰ç½®**ï¼šåŸºç¡€ Linux å‘½ä»¤è¡Œæ“ä½œï¼ˆLX02-SYSADMIN æŽ¨èï¼‰  
> **æ—¶é—´**ï¼šâš¡ 15 åˆ†é’Ÿï¼ˆé€Ÿè¯»ï¼‰/ ðŸ”¬ 50 åˆ†é’Ÿï¼ˆå®Œæ•´å®žæ“ï¼‰  
> **å®žæˆ˜åœºæ™¯**ï¼šéšœå®³å¯¾å¿œæ—¶å¿«é€Ÿå®šä½é—®é¢˜å±‚çº§  

---

## å°†å­¦åˆ°çš„å†…å®¹

1. ç†è§£ systemd ä¸ºä»€ä¹ˆå–ä»£ SysV init
2. ç†è§£ PID 1 çš„è§’è‰²ä¸ŽèŒè´£
3. äº†è§£ systemd æ¨¡å—åŒ–æž¶æž„ï¼ˆ69+ äºŒè¿›åˆ¶æ–‡ä»¶ï¼‰
4. è®¤è¯† 11 ç§ Unit ç±»åž‹
5. ç†è§£ systemd ä¸Ž cgroups çš„å…³ç³»

---

## å…ˆè·‘èµ·æ¥ï¼ï¼ˆ5 åˆ†é’Ÿï¼‰

> åœ¨å­¦ä¹ ç†è®ºä¹‹å‰ï¼Œå…ˆçœ‹çœ‹ systemd ç®¡ç†ç€ä»€ä¹ˆã€‚  
> è¿è¡Œè¿™äº›å‘½ä»¤ï¼Œè§‚å¯Ÿä½ ç³»ç»Ÿçš„çœŸå®žçŠ¶æ€ã€‚  

```bash
# æŸ¥çœ‹ systemd ç‰ˆæœ¬
systemctl --version

# PID 1 æ˜¯è°ï¼Ÿ
ps -p 1 -o comm=

# ç³»ç»Ÿå½“å‰çŠ¶æ€æ¦‚è§ˆ
systemctl status

# æŸ¥çœ‹æ‰€æœ‰è¿è¡Œä¸­çš„æœåŠ¡
systemctl list-units --type=service --state=running | head -15

# æŸ¥çœ‹æ‰€æœ‰ Unit ç±»åž‹çš„æ•°é‡ç»Ÿè®¡
systemctl list-units --all --no-pager | awk '{print $1}' | grep -oE '\.[a-z]+$' | sort | uniq -c | sort -rn
```

**ä½ åˆšåˆšçœ‹åˆ°äº† systemd ç®¡ç†çš„æ•´ä¸ªç³»ç»Ÿï¼**

- PID 1 å°±æ˜¯ systemd
- ç³»ç»Ÿä¸­è¿è¡Œç€å‡ åä¸ª service
- è¿˜æœ‰ socketã€timerã€mount ç­‰å„ç§ Unit ç±»åž‹

çŽ°åœ¨è®©æˆ‘ä»¬ç†è§£è¿™èƒŒåŽçš„æž¶æž„ã€‚

---

## Step 1 - ä»Ž SysV init åˆ° systemdï¼ˆ10 åˆ†é’Ÿï¼‰

### 1.1 SysV init çš„é—®é¢˜

åœ¨ systemd ä¹‹å‰ï¼ŒLinux ä½¿ç”¨ SysV init å¯åŠ¨ç³»ç»Ÿï¼š

```
SysV init å¯åŠ¨æµç¨‹ï¼ˆé¡ºåºæ‰§è¡Œï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ S01xxx  â”‚â”€â”€â–¶â”‚ S02xxx  â”‚â”€â”€â–¶â”‚ S03xxx  â”‚â”€â”€â–¶â”‚ S04xxx  â”‚â”€â”€â–¶â”‚ S99xxx  â”‚
â”‚ (ç½‘ç»œ)   â”‚   â”‚ (æ—¥å¿—)   â”‚   â”‚ (æ•°æ®åº“) â”‚   â”‚ (Web)   â”‚   â”‚ (å®Œæˆ)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    10s    +      5s     +      8s     +     3s     =    26s æ€»æ—¶é—´
```

**SysV init çš„ç—›ç‚¹**ï¼š

| é—®é¢˜ | å½±å“ |
|------|------|
| é¡ºåºå¯åŠ¨ | å¯åŠ¨æ…¢ï¼Œä¸èƒ½å¹¶è¡Œ |
| Shell è„šæœ¬ | éš¾ä»¥ç»´æŠ¤ï¼Œå®¹æ˜“å‡ºé”™ |
| è¿›ç¨‹è¿½è¸ªå›°éš¾ | æœåŠ¡ fork åŽä¸¢å¤±å…³è” |
| æ— ç»Ÿä¸€ç®¡ç†å·¥å…· | æ¯ä¸ªå‘è¡Œç‰ˆå‘½ä»¤ä¸åŒ |

### 1.2 systemd çš„è§£å†³æ–¹æ¡ˆ

```
systemd å¯åŠ¨æµç¨‹ï¼ˆå¹¶è¡Œä¾èµ–ï¼‰ï¼š
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ æ—¥å¿—    â”‚
              â”‚ (5s)   â”‚
              â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç½‘ç»œ    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”‚ æ•°æ®åº“   â”‚
â”‚ (10s)   â”‚        â”‚        â”‚ (8s)    â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜        â”‚        â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚             â”‚             â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ Web     â”‚
              â”‚ (3s)    â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ€»æ—¶é—´ï¼š~13sï¼ˆæœ€é•¿è·¯å¾„ï¼šç½‘ç»œ 10s + Web 3sï¼‰
```

**systemd çš„ä¼˜åŠ¿**ï¼š

| ç‰¹æ€§ | å¥½å¤„ |
|------|------|
| å¹¶è¡Œå¯åŠ¨ | ä¾èµ–å…³ç³»å†³å®šé¡ºåºï¼Œæ— å…³æœåŠ¡å¹¶è¡Œ |
| å£°æ˜Žå¼é…ç½® | Unit æ–‡ä»¶æ›¿ä»£ Shell è„šæœ¬ |
| cgroup è¿½è¸ª | ç²¾ç¡®è¿½è¸ªæœåŠ¡çš„æ‰€æœ‰è¿›ç¨‹ |
| ç»Ÿä¸€å·¥å…· | `systemctl` ä¸€ä¸ªå‘½ä»¤ç®¡ç†ä¸€åˆ‡ |

### 1.3 åŠ¨æ‰‹éªŒè¯ï¼šå¯åŠ¨æ—¶é—´å¯¹æ¯”

```bash
# æŸ¥çœ‹ç³»ç»Ÿå¯åŠ¨è€—æ—¶
systemd-analyze

# æŸ¥çœ‹å„æœåŠ¡å¯åŠ¨è€—æ—¶ï¼ˆæŒ‰æ—¶é—´æŽ’åºï¼‰
systemd-analyze blame | head -10

# æŸ¥çœ‹å¯åŠ¨å…³é”®è·¯å¾„
systemd-analyze critical-chain
```

---

## Step 2 - PID 1ï¼šç³»ç»Ÿçš„å®ˆæŠ¤è€…ï¼ˆ10 åˆ†é’Ÿï¼‰

### 2.1 ä¸ºä»€ä¹ˆ PID 1 ç‰¹æ®Šï¼Ÿ

PID 1 æ˜¯ Linux å†…æ ¸å¯åŠ¨åŽè¿è¡Œçš„ç¬¬ä¸€ä¸ªç”¨æˆ·ç©ºé—´è¿›ç¨‹ã€‚å®ƒæœ‰ç‰¹æ®ŠèŒè´£ï¼š

```bash
# éªŒè¯ PID 1
ps -p 1 -o pid,comm,args

# æŸ¥çœ‹è¿›ç¨‹æ ‘ï¼ˆPID 1 æ˜¯æ‰€æœ‰è¿›ç¨‹çš„ç¥–å…ˆï¼‰
pstree -p | head -20
```

### 2.2 PID 1 çš„ä¸‰å¤§èŒè´£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    PID 1 (systemd) èŒè´£                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  1. è¿›ç¨‹æ”¶å‰²ï¼ˆReaping Orphansï¼‰                              â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”                                              â”‚
â”‚     â”‚ çˆ¶è¿›ç¨‹  â”‚â”€â”€xâ”€â”€â–¶ é€€å‡º                                   â”‚
â”‚     â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                                              â”‚
â”‚         â”‚                                                   â”‚
â”‚     â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚     â”‚ å­è¿›ç¨‹  â”‚â”€â”€â”€â”€â”€â”€â–¶ â”‚ PID 1   â”‚  â† è‡ªåŠ¨æ”¶å…»å­¤å„¿è¿›ç¨‹        â”‚
â”‚     â”‚ (å­¤å„¿)  â”‚        â”‚ æ”¶å‰²    â”‚                          â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚                                                             â”‚
â”‚  2. æœåŠ¡ç›‘æŽ§ï¼ˆService Supervisionï¼‰                          â”‚
â”‚     - æ£€æµ‹æœåŠ¡å´©æºƒ                                           â”‚
â”‚     - æ ¹æ®ç­–ç•¥è‡ªåŠ¨é‡å¯ï¼ˆRestart=on-failureï¼‰                  â”‚
â”‚     - è®°å½•çŠ¶æ€åˆ° journal                                     â”‚
â”‚                                                             â”‚
â”‚  3. cgroup ç®¡ç†ï¼ˆResource Controlï¼‰                          â”‚
â”‚     - æ¯ä¸ªæœåŠ¡ç‹¬ç«‹ cgroup                                    â”‚
â”‚     - CPUã€å†…å­˜ã€I/O é™åˆ¶                                    â”‚
â”‚     - ç²¾ç¡®è¿½è¸ªæœåŠ¡çš„æ‰€æœ‰å­è¿›ç¨‹                                â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.3 åŠ¨æ‰‹éªŒè¯ï¼šcgroup è¿½è¸ª

```bash
# æŸ¥çœ‹ sshd æœåŠ¡çš„ cgroup
systemctl status sshd | grep -i cgroup

# æˆ–è€…ç›´æŽ¥æŸ¥çœ‹ cgroup å±‚æ¬¡
cat /proc/$(pgrep -o sshd)/cgroup

# æŸ¥çœ‹ç³»ç»Ÿçš„ cgroup å±‚æ¬¡ç»“æž„
systemd-cgls --no-pager | head -30
```

**cgroup çš„å¨åŠ›**ï¼šå³ä½¿æœåŠ¡ fork äº†å¤šä¸ªå­è¿›ç¨‹ï¼Œsystemd ä¹Ÿèƒ½é€šè¿‡ cgroup è¿½è¸ªå®ƒä»¬å…¨éƒ¨ã€‚

---

## Step 3 - systemd å…­å±‚æž¶æž„ï¼ˆ10 åˆ†é’Ÿï¼‰

### 3.1 æž¶æž„å…¨æ™¯å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     L6: Utilities                       â”‚
â”‚     systemctl  journalctl  systemd-analyze  timedatectl â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  L5a: Daemons     â”‚  L5b: Targets    â”‚  L5c: External   â”‚
â”‚  journald         â”‚  multi-user      â”‚  nginx.service   â”‚
â”‚  networkd         â”‚  graphical       â”‚  postgresql      â”‚
â”‚  resolved         â”‚  timers          â”‚  custom apps     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                     L4: PID 1 (systemd)                 â”‚
â”‚              Unit management, cgroup control            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                     L3: Libraries                       â”‚
â”‚                   libsystemd, libudev                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                     L2: Linux Kernel                    â”‚
â”‚               cgroups, namespaces, seccomp              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                     L1: Hardware                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 å„å±‚èŒè´£

| å±‚çº§ | ç»„ä»¶ | èŒè´£ |
|------|------|------|
| L6 | Utilities | ç”¨æˆ·äº¤äº’å·¥å…·ï¼ˆsystemctl, journalctlï¼‰ |
| L5 | Daemons/Targets | ç³»ç»ŸæœåŠ¡å’ŒåŒæ­¥ç‚¹ |
| L4 | PID 1 | Unit ç®¡ç†ã€cgroup æŽ§åˆ¶ |
| L3 | Libraries | libsystemdï¼ˆSD-Bus, sd_notifyï¼‰ |
| L2 | Kernel | cgroups v2, namespaces, seccomp |
| L1 | Hardware | ç‰©ç†æˆ–è™šæ‹Ÿç¡¬ä»¶ |

### 3.3 å¸¸è§è¯¯è§£ï¼šsystemd ä¸æ˜¯å•ä½“ç¨‹åº

```bash
# æŸ¥çœ‹ systemd ç›¸å…³çš„äºŒè¿›åˆ¶æ–‡ä»¶æ•°é‡
ls /usr/lib/systemd/ | wc -l

# æŸ¥çœ‹å…·ä½“æœ‰å“ªäº›ç»„ä»¶
ls /usr/lib/systemd/
```

**systemd æ˜¯ä¸€å¥—å·¥å…·é›†**ï¼ŒåŒ…å« 69+ ä¸ªç‹¬ç«‹äºŒè¿›åˆ¶æ–‡ä»¶ï¼š

| ç»„ä»¶ | ç”¨é€” |
|------|------|
| `systemd` | PID 1ï¼Œæ ¸å¿ƒç®¡ç†å™¨ |
| `systemd-journald` | æ—¥å¿—å®ˆæŠ¤è¿›ç¨‹ |
| `systemd-networkd` | ç½‘ç»œé…ç½® |
| `systemd-resolved` | DNS è§£æž |
| `systemd-logind` | ç™»å½•ç®¡ç† |
| `systemd-udevd` | è®¾å¤‡ç®¡ç† |
| `systemd-timesyncd` | æ—¶é—´åŒæ­¥ |

---

## Step 4 - 11 ç§ Unit ç±»åž‹ï¼ˆ10 åˆ†é’Ÿï¼‰

### 4.1 Unit ç±»åž‹æ¦‚è§ˆ

systemd ç®¡ç†çš„å¯¹è±¡å«åš Unitï¼ˆå•å…ƒï¼‰ï¼Œå…±æœ‰ 11 ç§ç±»åž‹ï¼š

| ç±»åž‹ | åŽç¼€ | ç”¨é€” | ç¤ºä¾‹ |
|------|------|------|------|
| **service** | `.service` | ç³»ç»ŸæœåŠ¡ | nginx.service |
| **socket** | `.socket` | å¥—æŽ¥å­—æ¿€æ´» | sshd.socket |
| **timer** | `.timer` | å®šæ—¶ä»»åŠ¡ï¼ˆæ›¿ä»£ cronï¼‰ | backup.timer |
| **mount** | `.mount` | æ–‡ä»¶ç³»ç»ŸæŒ‚è½½ | home.mount |
| **automount** | `.automount` | è‡ªåŠ¨æŒ‚è½½ | nfs-share.automount |
| **target** | `.target` | åŒæ­¥ç‚¹/åˆ†ç»„ | multi-user.target |
| **device** | `.device` | è®¾å¤‡ | dev-sda.device |
| **swap** | `.swap` | äº¤æ¢åˆ†åŒº | dev-sda2.swap |
| **path** | `.path` | è·¯å¾„ç›‘æŽ§ | myapp.path |
| **slice** | `.slice` | cgroup åˆ‡ç‰‡ | user.slice |
| **scope** | `.scope` | å¤–éƒ¨è¿›ç¨‹ç»„ | session-1.scope |

### 4.2 åŠ¨æ‰‹æŽ¢ç´¢ï¼šä½ ç³»ç»Ÿçš„ Unit

```bash
# æŒ‰ç±»åž‹ç»Ÿè®¡ Unit æ•°é‡
systemctl list-units --all --no-pager | \
    awk '{print $1}' | \
    grep -oE '\.[a-z]+$' | \
    sort | uniq -c | sort -rn

# æŸ¥çœ‹æ‰€æœ‰ service ç±»åž‹
systemctl list-units --type=service --all | head -20

# æŸ¥çœ‹æ‰€æœ‰ timer ç±»åž‹
systemctl list-units --type=timer --all

# æŸ¥çœ‹æ‰€æœ‰ target ç±»åž‹
systemctl list-units --type=target --all
```

### 4.3 æœ€å¸¸ç”¨çš„ Unit ç±»åž‹

æ—¥å¸¸è¿ç»´ä¸­æœ€å¸¸æŽ¥è§¦çš„æ˜¯è¿™ 4 ç§ï¼š

```
         service                    timer
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ é•¿æœŸè¿è¡Œçš„   â”‚           â”‚ å®šæ—¶è§¦å‘çš„   â”‚
     â”‚ åŽå°æœåŠ¡     â”‚           â”‚ è®¡åˆ’ä»»åŠ¡     â”‚
     â”‚             â”‚           â”‚             â”‚
     â”‚ nginx       â”‚           â”‚ backup      â”‚
     â”‚ postgresql  â”‚           â”‚ logrotate   â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

         target                    socket
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ æœåŠ¡åˆ†ç»„/    â”‚           â”‚ æŒ‰éœ€æ¿€æ´»     â”‚
     â”‚ åŒæ­¥ç‚¹       â”‚           â”‚ èŠ‚çœèµ„æº     â”‚
     â”‚             â”‚           â”‚             â”‚
     â”‚ multi-user  â”‚           â”‚ sshd.socket â”‚
     â”‚ graphical   â”‚           â”‚ cups.socket â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Step 5 - Mini-Projectï¼šæŽ¢ç´¢ç³»ç»Ÿ Unitï¼ˆ10 åˆ†é’Ÿï¼‰

### ä»»åŠ¡ç›®æ ‡

ä½¿ç”¨ systemctl åˆ—å‡ºã€åˆ†ç±»ç»Ÿè®¡å½“å‰ç³»ç»Ÿçš„æ‰€æœ‰ Unit ç±»åž‹ã€‚

### 5.1 åˆ›å»ºæŽ¢ç´¢è„šæœ¬

```bash
# åˆ›å»ºå·¥ä½œç›®å½•
mkdir -p ~/systemd-lab
cd ~/systemd-lab

# åˆ›å»ºæŽ¢ç´¢è„šæœ¬
cat > explore-units.sh << 'EOF'
#!/bin/bash
# systemd Unit Explorer - ç³»ç»Ÿ Unit æŽ¢ç´¢å·¥å…·

echo "============================================"
echo "  systemd Unit æŽ¢ç´¢æŠ¥å‘Š"
echo "  ç”Ÿæˆæ—¶é—´: $(date)"
echo "============================================"
echo ""

# systemd ç‰ˆæœ¬
echo "ã€systemd ç‰ˆæœ¬ã€‘"
systemctl --version | head -1
echo ""

# ç³»ç»Ÿå¯åŠ¨æ—¶é—´
echo "ã€ç³»ç»Ÿå¯åŠ¨è€—æ—¶ã€‘"
systemd-analyze
echo ""

# Unit ç±»åž‹ç»Ÿè®¡
echo "ã€Unit ç±»åž‹ç»Ÿè®¡ã€‘"
echo "--------------------------------"
printf "%-15s %s\n" "ç±»åž‹" "æ•°é‡"
echo "--------------------------------"

systemctl list-units --all --no-pager 2>/dev/null | \
    awk '{print $1}' | \
    grep -oE '\.[a-z]+$' | \
    sort | uniq -c | sort -rn | \
    while read count type; do
        printf "%-15s %s\n" "$type" "$count"
    done

echo "--------------------------------"
echo ""

# å¤±è´¥çš„ Unit
echo "ã€å¤±è´¥çš„ Unitã€‘"
failed_count=$(systemctl list-units --failed --no-pager 2>/dev/null | grep -c "loaded units listed")
if [ "$failed_count" = "0" ]; then
    systemctl list-units --failed --no-pager 2>/dev/null | grep -v "^$" | head -10
else
    echo "æ²¡æœ‰å¤±è´¥çš„ Unit"
fi
echo ""

# æ´»è·ƒçš„ timer
echo "ã€æ´»è·ƒçš„ Timerã€‘"
systemctl list-timers --no-pager 2>/dev/null | head -10
echo ""

# èµ„æºä½¿ç”¨æœ€é«˜çš„æœåŠ¡ï¼ˆå¦‚æžœæœ‰ systemd-cgtopï¼‰
echo "ã€èµ„æºä½¿ç”¨æƒ…å†µï¼ˆå‰ 10ï¼‰ã€‘"
if command -v systemd-cgtop &>/dev/null; then
    systemd-cgtop -n 1 --order=memory 2>/dev/null | head -12
else
    echo "systemd-cgtop ä¸å¯ç”¨"
fi

echo ""
echo "============================================"
echo "  æŠ¥å‘Šå®Œæˆ"
echo "============================================"
EOF

chmod +x explore-units.sh
```

### 5.2 è¿è¡ŒæŽ¢ç´¢è„šæœ¬

```bash
# è¿è¡Œè„šæœ¬
./explore-units.sh

# ä¿å­˜æŠ¥å‘Š
./explore-units.sh > unit-report-$(date +%Y%m%d).txt
cat unit-report-$(date +%Y%m%d).txt
```

### 5.3 æ£€æŸ¥æ¸…å•

å®Œæˆä»¥ä¸‹ä»»åŠ¡ï¼š

- [ ] ç¡®è®¤ PID 1 æ˜¯ systemd
- [ ] æŸ¥çœ‹ç³»ç»Ÿå¯åŠ¨è€—æ—¶
- [ ] ç»Ÿè®¡å„ç±»åž‹ Unit çš„æ•°é‡
- [ ] æŸ¥çœ‹æ˜¯å¦æœ‰å¤±è´¥çš„ Unit
- [ ] æŸ¥çœ‹æ´»è·ƒçš„ timer

---

## åæ¨¡å¼ï¼šå¸¸è§è¯¯è§£

### è¯¯è§£ 1ï¼šsystemd æ˜¯ä¸€ä¸ªåºžå¤§çš„å•ä½“ç¨‹åº

**é”™è¯¯ç†è§£**ï¼šsystemd æŠŠæ‰€æœ‰åŠŸèƒ½å¡žè¿›ä¸€ä¸ªç¨‹åºã€‚

**å®žé™…æƒ…å†µ**ï¼šsystemd æ˜¯ 69+ ä¸ªç‹¬ç«‹äºŒè¿›åˆ¶æ–‡ä»¶çš„é›†åˆã€‚ä½ å¯ä»¥é€‰æ‹©æ€§å¯ç”¨/ç¦ç”¨å„ç»„ä»¶ã€‚

```bash
# ç¦ç”¨ä¸éœ€è¦çš„ç»„ä»¶
systemctl disable systemd-networkd  # å¦‚æžœç”¨ NetworkManager
systemctl disable systemd-resolved  # å¦‚æžœç”¨ä¼ ç»Ÿ DNS é…ç½®
```

### è¯¯è§£ 2ï¼šcgroup åªç”¨äºŽå®¹å™¨

**é”™è¯¯ç†è§£**ï¼šcgroup æ˜¯ Docker/Kubernetes çš„æŠ€æœ¯ï¼Œä¸Ž systemd æ— å…³ã€‚

**å®žé™…æƒ…å†µ**ï¼šsystemd ä¾èµ– cgroup è¿½è¸ªæœåŠ¡è¿›ç¨‹ã€‚æ¯ä¸ª service è‡ªåŠ¨åˆ†é…ç‹¬ç«‹çš„ cgroupã€‚

```bash
# æŸ¥çœ‹ cgroup å±‚æ¬¡
systemd-cgls

# æŸ¥çœ‹ç‰¹å®šæœåŠ¡çš„èµ„æºé™åˆ¶
systemctl show nginx --property=MemoryMax,CPUQuota
```

### è¯¯è§£ 3ï¼šsystemd åªç®¡æœåŠ¡

**é”™è¯¯ç†è§£**ï¼šsystemd å°±æ˜¯æœåŠ¡ç®¡ç†å™¨ã€‚

**å®žé™…æƒ…å†µ**ï¼šsystemd ç®¡ç† 11 ç§ Unit ç±»åž‹ï¼ŒåŒ…æ‹¬æŒ‚è½½ç‚¹ã€å®šæ—¶ä»»åŠ¡ã€è®¾å¤‡ç­‰ã€‚

---

## èŒåœºå°è´´å£«ï¼ˆJapan IT Contextï¼‰

### éšœå®³å¯¾å¿œï¼ˆæ•…éšœå¤„ç†ï¼‰ä¸­çš„æž¶æž„æ€ç»´

åœ¨æ—¥æœ¬ IT ä¼ä¸šï¼Œå¤„ç†æ•…éšœæ—¶éœ€è¦å¿«é€Ÿå®šä½é—®é¢˜åœ¨å“ªä¸€å±‚ï¼š

```
é—®é¢˜å®šä½æµç¨‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”¨æˆ·æŠ¥å‘Šï¼šWeb åº”ç”¨æ— æ³•è®¿é—®                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ L6 æ£€æŸ¥ï¼šsystemctl status nginx                  â”‚
â”‚     â†’ æœåŠ¡çŠ¶æ€ï¼Ÿè¿è¡Œä¸­ï¼Ÿå¤±è´¥ï¼Ÿ                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ L5 æ£€æŸ¥ï¼šjournalctl -u nginx                     â”‚
â”‚     â†’ æ—¥å¿—ä¸­æœ‰ä»€ä¹ˆé”™è¯¯ï¼Ÿ                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ L4 æ£€æŸ¥ï¼šsystemctl list-dependencies nginx       â”‚
â”‚     â†’ ä¾èµ–çš„æœåŠ¡éƒ½æ­£å¸¸å—ï¼Ÿ                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ L2 æ£€æŸ¥ï¼šdmesg | tail                           â”‚
â”‚     â†’ å†…æ ¸æœ‰æŠ¥é”™å—ï¼Ÿç£ç›˜/ç½‘ç»œé—®é¢˜ï¼Ÿ              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ—¥æœ¬ IT æœ¯è¯­å¯¹ç…§

| æ—¥è¯­æœ¯è¯­ | è¯»éŸ³ | å«ä¹‰ | systemd ç›¸å…³ |
|----------|------|------|--------------|
| éšœå®³å¯¾å¿œ | ã—ã‚‡ã†ãŒã„ãŸã„ãŠã† | æ•…éšœå¤„ç† | systemctl status, journalctl |
| èµ·å‹•é †åº | ãã©ã†ã˜ã‚…ã‚“ã˜ã‚‡ | å¯åŠ¨é¡ºåº | systemd-analyze critical-chain |
| ãƒ—ãƒ­ã‚»ã‚¹ç®¡ç† | ãƒ—ãƒ­ã‚»ã‚¹ã‹ã‚“ã‚Š | è¿›ç¨‹ç®¡ç† | cgroup è¿½è¸ª |
| ã‚µãƒ¼ãƒ“ã‚¹ç›£è¦– | ã‚µãƒ¼ãƒ“ã‚¹ã‹ã‚“ã— | æœåŠ¡ç›‘æŽ§ | systemctl is-active |

---

## é¢è¯•å‡†å¤‡ï¼ˆInterview Prepï¼‰

### Q1: systemd ã¨ SysV init ã®é•ã„ã¯ï¼Ÿï¼ˆsystemd å’Œ SysV init çš„åŒºåˆ«ï¼Ÿï¼‰

**å›žç­”è¦ç‚¹**ï¼š

```
SysV init:
- é †æ¬¡èµ·å‹•ï¼ˆSequential bootï¼‰
- ã‚·ã‚§ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ™ãƒ¼ã‚¹
- ãƒ—ãƒ­ã‚»ã‚¹è¿½è·¡ãŒå›°é›£

systemd:
- ä¾å­˜é–¢ä¿‚ãƒ™ãƒ¼ã‚¹ã®ä¸¦åˆ—èµ·å‹•ï¼ˆParallel boot based on dependenciesï¼‰
- å®£è¨€çš„ãª Unit ãƒ•ã‚¡ã‚¤ãƒ«
- cgroup ã§ç¢ºå®Ÿã«ãƒ—ãƒ­ã‚»ã‚¹è¿½è·¡
```

### Q2: systemd ãŒ PID 1 ã§ã‚ã‚‹ç†ç”±ã¯ï¼Ÿï¼ˆä¸ºä»€ä¹ˆ systemd æ˜¯ PID 1ï¼Ÿï¼‰

**å›žç­”è¦ç‚¹**ï¼š

```
PID 1 ã®ç‰¹åˆ¥ãªå½¹å‰²ï¼š
1. å­¤å…ãƒ—ãƒ­ã‚»ã‚¹ã®å›žåŽï¼ˆOrphan process reapingï¼‰
2. ã‚µãƒ¼ãƒ“ã‚¹ç›£è¦–ã¨è‡ªå‹•å†èµ·å‹•
3. cgroup ç®¡ç†ã®ä¸€å…ƒåŒ–

å…¨ãƒ—ãƒ­ã‚»ã‚¹ã®è¦ªã¨ã—ã¦ã€ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã‚’ç®¡ç†ã§ãã‚‹å”¯ä¸€ã®ãƒã‚¸ã‚·ãƒ§ãƒ³ã€‚
```

---

## æ£€æŸ¥æ¸…å•

å®Œæˆæœ¬è¯¾åŽï¼Œä½ åº”è¯¥èƒ½å¤Ÿï¼š

- [ ] è§£é‡Š systemd ç›¸æ¯” SysV init çš„ä¼˜åŠ¿ï¼ˆå¹¶è¡Œå¯åŠ¨ã€ä¾èµ–ç®¡ç†ã€cgroup è¿½è¸ªï¼‰
- [ ] è¯´æ˜Ž PID 1 çš„ä¸‰å¤§èŒè´£ï¼ˆè¿›ç¨‹æ”¶å‰²ã€æœåŠ¡ç›‘æŽ§ã€cgroup ç®¡ç†ï¼‰
- [ ] æè¿° systemd å…­å±‚æž¶æž„çš„å„å±‚èŒè´£
- [ ] åˆ—å‡ºå¹¶è§£é‡Š 4 ç§æœ€å¸¸ç”¨çš„ Unit ç±»åž‹ï¼ˆservice, timer, target, socketï¼‰
- [ ] ä½¿ç”¨ systemctl å’Œ systemd-analyze æŽ¢ç´¢ç³»ç»ŸçŠ¶æ€
- [ ] ç†è§£ systemd æ˜¯æ¨¡å—åŒ–å·¥å…·é›†ï¼Œä¸æ˜¯å•ä½“ç¨‹åº

---

## æœ¬è¯¾å°ç»“

| æ¦‚å¿µ | è¦ç‚¹ |
|------|------|
| SysV vs systemd | é¡ºåºå¯åŠ¨ vs å¹¶è¡Œä¾èµ– |
| PID 1 èŒè´£ | è¿›ç¨‹æ”¶å‰²ã€æœåŠ¡ç›‘æŽ§ã€cgroup ç®¡ç† |
| å…­å±‚æž¶æž„ | Hardware â†’ Kernel â†’ Libraries â†’ PID1 â†’ Daemons â†’ Utilities |
| Unit ç±»åž‹ | 11 ç§ï¼Œæœ€å¸¸ç”¨ï¼šservice, timer, target, socket |
| cgroups | èµ„æºéš”ç¦»ä¸Žè¿›ç¨‹è¿½è¸ª |

---

## å»¶ä¼¸é˜…è¯»

- [systemd å®˜æ–¹æ–‡æ¡£](https://www.freedesktop.org/wiki/Software/systemd/)
- [Lennart Poettering çš„ systemd è®¾è®¡æ–‡æ¡£](http://0pointer.de/blog/projects/systemd.html)
- ä¸‹ä¸€è¯¾ï¼š[02 - æœåŠ¡ç®¡ç†ï¼ˆsystemctl å®žæˆ˜ï¼‰](../02-systemctl/) - å­¦ä¹ ä½¿ç”¨ systemctl ç®¡ç†æœåŠ¡
- ç›¸å…³è¯¾ç¨‹ï¼š[LX02 - ç³»ç»Ÿç®¡ç†åŸºç¡€](../lx02-sysadmin/) - ç”¨æˆ·ã€è¿›ç¨‹ã€æƒé™ç®¡ç†

---

## ç³»åˆ—å¯¼èˆª

[ç³»åˆ—é¦–é¡µ](../) | [02 - æœåŠ¡ç®¡ç† -->](../02-systemctl/)
