# 09 - PAM é«˜çº§é…ç½® / PAM Advanced Configuration

> **ç›®æ ‡**ï¼šæŒæ¡ PAM æ¨¡å—å †æ ˆã€è´¦æˆ·é”å®šå’Œå¯†ç ç­–ç•¥é…ç½®  
> **å‰ç½®**ï¼šå®Œæˆ Lesson 02ï¼ˆSSH åŠ å›ºï¼‰ã€Lesson 08ï¼ˆnftablesï¼‰  
> **æ—¶é—´**ï¼šâš¡ 30 åˆ†é’Ÿï¼ˆé€Ÿè¯»ï¼‰/ ğŸ”¬ 120 åˆ†é’Ÿï¼ˆå®Œæ•´å®æ“ï¼‰  
> **è­¦å‘Š**ï¼šPAM é…ç½®é”™è¯¯å¯èƒ½å¯¼è‡´æ— æ³•ç™»å½•ï¼å§‹ç»ˆä¿ç•™å¤‡ç”¨ root ä¼šè¯  

---

## å°†å­¦åˆ°çš„å†…å®¹

1. ç†è§£ PAM æ¨¡å—å †æ ˆå·¥ä½œåŸç†
2. é…ç½®è´¦æˆ·é”å®šç­–ç•¥ï¼ˆpam_faillockï¼Œæ›¿ä»£å·²åºŸå¼ƒçš„ pam_tally2ï¼‰
3. é…ç½®å¯†ç å¤æ‚åº¦è¦æ±‚ï¼ˆpam_pwqualityï¼‰
4. å®‰å…¨æµ‹è¯• PAM å˜æ›´
5. å¸¸è§ PAM æ•…éšœæ’æŸ¥

---

## å…ˆè·‘èµ·æ¥ï¼ï¼ˆ5 åˆ†é’Ÿï¼‰

> åœ¨å­¦ä¹  PAM ç†è®ºä¹‹å‰ï¼Œå…ˆçœ‹çœ‹ç³»ç»Ÿå½“å‰çš„ PAM é…ç½®çŠ¶æ€ã€‚  

```bash
# 1. æŸ¥çœ‹ç³»ç»Ÿç™»å½•ç›¸å…³çš„ PAM é…ç½®
cat /etc/pam.d/system-auth 2>/dev/null || cat /etc/pam.d/common-auth 2>/dev/null | head -20

# 2. æ£€æŸ¥æ˜¯å¦é…ç½®äº†è´¦æˆ·é”å®šï¼ˆpam_faillock æˆ–æ—§ç‰ˆ pam_tally2ï¼‰
grep -r "pam_faillock\|pam_tally2" /etc/pam.d/ 2>/dev/null

# 3. æŸ¥çœ‹å½“å‰å¯†ç ç­–ç•¥
cat /etc/security/pwquality.conf 2>/dev/null | grep -v "^#" | grep -v "^$"

# 4. æ£€æŸ¥è´¦æˆ·é”å®šçŠ¶æ€
faillock --user root 2>/dev/null || echo "faillock æœªé…ç½®æˆ–æœªå®‰è£…"

# 5. åˆ—å‡º /etc/pam.d/ ä¸‹çš„é…ç½®æ–‡ä»¶
ls -la /etc/pam.d/ | head -15
```

**ä½ åˆšåˆšæ£€æŸ¥äº†ï¼š**

- ç³»ç»Ÿå½“å‰ä½¿ç”¨å“ªäº› PAM æ¨¡å—ï¼Ÿ
- æ˜¯å¦é…ç½®äº†ç™»å½•å¤±è´¥é”å®šï¼Ÿï¼ˆé˜²æš´åŠ›ç ´è§£ï¼‰
- å¯†ç å¤æ‚åº¦è¦æ±‚æ˜¯ä»€ä¹ˆï¼Ÿ
- å“ªäº›æœåŠ¡ä½¿ç”¨ PAMï¼Ÿ

**å¦‚æœ `faillock` è¿”å› "æœªé…ç½®"ï¼Œä½ çš„æœåŠ¡å™¨å¯èƒ½å®¹æ˜“å—åˆ°æš´åŠ›ç ´è§£æ”»å‡»ã€‚**

ç°åœ¨è®©æˆ‘ä»¬ç†è§£ PAM çš„å·¥ä½œåŸç†ï¼Œç„¶åæ­£ç¡®é…ç½®å®ƒã€‚

---

## Step 1 - PAM æ¶æ„è¯¦è§£ï¼ˆ20 åˆ†é’Ÿï¼‰

### 1.1 ä»€ä¹ˆæ˜¯ PAMï¼Ÿ

PAMï¼ˆPluggable Authentication Modulesï¼‰æ˜¯ Linux è®¤è¯æ¡†æ¶ï¼Œå…è®¸åº”ç”¨ç¨‹åºä½¿ç”¨å¯æ’æ‹”çš„è®¤è¯æœºåˆ¶ã€‚

```
ä¼ ç»Ÿæ–¹å¼ï¼ˆæ—  PAMï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     ç›´æ¥éªŒè¯      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   sshd    â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ /etc/shadowâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     é—®é¢˜ï¼šæ¯ä¸ªåº”ç”¨éƒ½è¦è‡ªå·±å®ç°è®¤è¯é€»è¾‘

PAM æ–¹å¼ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   sshd    â”‚â”€â”€â”€â”€â–¶â”‚     PAM     â”‚â”€â”€â”€â”€â–¶â”‚ pam_unix.so   â”‚â”€â”€â–¶ /etc/shadow
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚  Framework  â”‚     â”‚ pam_faillock  â”‚â”€â”€â–¶ é”å®šè®¡æ•°
     â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚ pam_pwquality â”‚â”€â”€â–¶ å¯†ç æ£€æŸ¥
     â”‚                  â–²             â”‚ pam_ldap.so   â”‚â”€â”€â–¶ LDAP æœåŠ¡å™¨
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚   login   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     å¥½å¤„ï¼šé›†ä¸­ç®¡ç†è®¤è¯ç­–ç•¥
```

<details>
<summary>View ASCII source</summary>

```
ä¼ ç»Ÿæ–¹å¼ï¼ˆæ—  PAMï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     ç›´æ¥éªŒè¯      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   sshd    â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ /etc/shadowâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     é—®é¢˜ï¼šæ¯ä¸ªåº”ç”¨éƒ½è¦è‡ªå·±å®ç°è®¤è¯é€»è¾‘

PAM æ–¹å¼ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   sshd    â”‚â”€â”€â”€â”€â–¶â”‚     PAM     â”‚â”€â”€â”€â”€â–¶â”‚ pam_unix.so   â”‚â”€â”€â–¶ /etc/shadow
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚  Framework  â”‚     â”‚ pam_faillock  â”‚â”€â”€â–¶ é”å®šè®¡æ•°
     â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚ pam_pwquality â”‚â”€â”€â–¶ å¯†ç æ£€æŸ¥
     â”‚                  â–²             â”‚ pam_ldap.so   â”‚â”€â”€â–¶ LDAP æœåŠ¡å™¨
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚   login   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     å¥½å¤„ï¼šé›†ä¸­ç®¡ç†è®¤è¯ç­–ç•¥
```

</details>

### 1.2 PAM å››ç§æ¨¡å—ç±»å‹

PAM å°†è®¤è¯æµç¨‹åˆ†ä¸ºå››ä¸ªç‹¬ç«‹çš„é˜¶æ®µï¼š

| ç±»å‹ | è‹±æ–‡ | ä½œç”¨ | ç¤ºä¾‹ |
|------|------|------|------|
| **auth** | Authentication | éªŒè¯ç”¨æˆ·èº«ä»½ | æ£€æŸ¥å¯†ç ã€å¯†é’¥ã€æŒ‡çº¹ |
| **account** | Account Management | æ£€æŸ¥è´¦æˆ·çŠ¶æ€ | è´¦æˆ·æ˜¯å¦è¿‡æœŸã€é”å®š |
| **password** | Password Management | ä¿®æ”¹å¯†ç æ—¶è°ƒç”¨ | æ£€æŸ¥å¯†ç å¼ºåº¦ã€æ›´æ–°å¯†ç  |
| **session** | Session Management | ä¼šè¯å¼€å§‹/ç»“æŸæ—¶è°ƒç”¨ | è®¾ç½®ç¯å¢ƒå˜é‡ã€è®°å½•æ—¥å¿— |

```
ç”¨æˆ·ç™»å½•æµç¨‹ï¼š

   ç”¨æˆ·è¾“å…¥å¯†ç 
         â”‚
         â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚    auth     â”‚ â”€â”€â”€ "å¯†ç æ­£ç¡®å—ï¼Ÿ"
   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
         â”‚ é€šè¿‡
         â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚   account   â”‚ â”€â”€â”€ "è´¦æˆ·å¯ä»¥ç™»å½•å—ï¼Ÿï¼ˆæœªè¿‡æœŸã€æœªé”å®šï¼‰"
   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
         â”‚ é€šè¿‡
         â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚   session   â”‚ â”€â”€â”€ "è®¾ç½®ç”¨æˆ·ç¯å¢ƒã€è®°å½•ç™»å½•æ—¥å¿—"
   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
      ç™»å½•æˆåŠŸï¼
```

<details>
<summary>View ASCII source</summary>

```
ç”¨æˆ·ç™»å½•æµç¨‹ï¼š

   ç”¨æˆ·è¾“å…¥å¯†ç 
         â”‚
         â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚    auth     â”‚ â”€â”€â”€ "å¯†ç æ­£ç¡®å—ï¼Ÿ"
   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
         â”‚ é€šè¿‡
         â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚   account   â”‚ â”€â”€â”€ "è´¦æˆ·å¯ä»¥ç™»å½•å—ï¼Ÿï¼ˆæœªè¿‡æœŸã€æœªé”å®šï¼‰"
   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
         â”‚ é€šè¿‡
         â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚   session   â”‚ â”€â”€â”€ "è®¾ç½®ç”¨æˆ·ç¯å¢ƒã€è®°å½•ç™»å½•æ—¥å¿—"
   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
      ç™»å½•æˆåŠŸï¼
```

</details>

### 1.3 æ§åˆ¶æ ‡å¿—ï¼ˆControl Flagsï¼‰

æ§åˆ¶æ ‡å¿—å†³å®šæ¨¡å—å¤±è´¥æ—¶å¦‚ä½•å¤„ç†ï¼š

| æ ‡å¿— | å¤±è´¥æ—¶è¡Œä¸º | è®°å¿†æ³• |
|------|------------|--------|
| **required** | æ ‡è®°å¤±è´¥ï¼Œç»§ç»­æ‰§è¡Œåç»­æ¨¡å— | "å¿…é¡»æˆåŠŸï¼Œä½†ä¸æ€¥ç€å‘Šè¯‰ä½ " |
| **requisite** | ç«‹å³è¿”å›å¤±è´¥ï¼Œä¸æ‰§è¡Œåç»­ | "ç«‹å³å¤±è´¥" |
| **sufficient** | æˆåŠŸåˆ™ç«‹å³è¿”å›ï¼Œè·³è¿‡åç»­ | "è¶³å¤Ÿäº†ï¼Œé€šè¿‡ï¼" |
| **optional** | ç»“æœè¢«å¿½ç•¥ï¼ˆé™¤éæ˜¯å”¯ä¸€æ¨¡å—ï¼‰ | "å¯é€‰çš„" |

```
æ§åˆ¶æµç¨‹ç¤ºä¾‹ï¼š

auth required     pam_env.so          # å¿…é¡»æˆåŠŸï¼Œç»§ç»­
auth required     pam_faillock.so     # å¿…é¡»æˆåŠŸï¼Œç»§ç»­ï¼ˆæ£€æŸ¥é”å®šï¼‰
auth sufficient   pam_unix.so         # å¯†ç æ­£ç¡®ï¼Ÿâ†’ æˆåŠŸï¼Œè·³è¿‡åç»­
auth sufficient   pam_sss.so          # LDAP è®¤è¯ï¼Ÿâ†’ æˆåŠŸï¼Œè·³è¿‡åç»­
auth required     pam_deny.so         # æœ€åä¿é™©ï¼šæ‹’ç»ä¸€åˆ‡

æ‰§è¡Œé¡ºåºï¼šenv â†’ faillock â†’ unixï¼ˆæˆåŠŸåˆ™ç»“æŸï¼‰â†’ sss â†’ deny
```

### 1.4 é…ç½®æ–‡ä»¶ä½ç½®

```bash
# ä¸»é…ç½®ç›®å½•
/etc/pam.d/
â”œâ”€â”€ system-auth      # RHEL: ç³»ç»Ÿè®¤è¯ï¼ˆè¢«å…¶ä»–æ–‡ä»¶ includeï¼‰
â”œâ”€â”€ password-auth    # RHEL: å¯†ç è®¤è¯
â”œâ”€â”€ common-auth      # Debian: é€šç”¨è®¤è¯
â”œâ”€â”€ common-password  # Debian: å¯†ç ç›¸å…³
â”œâ”€â”€ sshd             # SSH æœåŠ¡ä¸“ç”¨
â”œâ”€â”€ login            # æœ¬åœ°ç™»å½•
â”œâ”€â”€ sudo             # sudo å‘½ä»¤
â””â”€â”€ su               # su å‘½ä»¤

# ç­–ç•¥æ–‡ä»¶ç›®å½•
/etc/security/
â”œâ”€â”€ pwquality.conf   # å¯†ç å¤æ‚åº¦ç­–ç•¥
â”œâ”€â”€ faillock.conf    # è´¦æˆ·é”å®šç­–ç•¥ï¼ˆæ–°ç‰ˆï¼‰
â”œâ”€â”€ limits.conf      # èµ„æºé™åˆ¶
â”œâ”€â”€ access.conf      # è®¿é—®æ§åˆ¶
â””â”€â”€ time.conf        # æ—¶é—´é™åˆ¶
```

---

## Step 2 - è´¦æˆ·é”å®šé…ç½®ï¼špam_faillockï¼ˆ30 åˆ†é’Ÿï¼‰

### 2.1 pam_faillock vs pam_tally2

> **é‡è¦**ï¼špam_tally2 åœ¨ RHEL 8 / Fedora 28 åå·²åºŸå¼ƒï¼Œè¯·ä½¿ç”¨ pam_faillockã€‚  

| ç‰¹æ€§ | pam_tally2ï¼ˆæ—§ï¼‰ | pam_faillockï¼ˆæ–°ï¼‰ |
|------|------------------|-------------------|
| çŠ¶æ€ | **å·²åºŸå¼ƒ** | æ¨è |
| å‘½ä»¤ | `pam_tally2` | `faillock` |
| é…ç½® | PAM æ–‡ä»¶ä¸­ | /etc/security/faillock.conf |
| æ—¥å¿— | /var/log/tallylog | /var/run/faillock/* |

### 2.2 æŸ¥çœ‹å½“å‰çŠ¶æ€

```bash
# æ£€æŸ¥ faillock æ˜¯å¦å·²é…ç½®
grep pam_faillock /etc/pam.d/system-auth 2>/dev/null || \
grep pam_faillock /etc/pam.d/common-auth 2>/dev/null

# æŸ¥çœ‹ç”¨æˆ·é”å®šçŠ¶æ€
sudo faillock --user testuser

# æŸ¥çœ‹æ‰€æœ‰ç”¨æˆ·çš„é”å®šçŠ¶æ€
sudo faillock

# è¾“å‡ºç¤ºä¾‹ï¼š
# testuser:
# When                Type  Source                              Valid
# 2025-01-04 10:23:15 RHOST 192.168.1.100                           V
# 2025-01-04 10:23:18 RHOST 192.168.1.100                           V
# 2025-01-04 10:23:21 RHOST 192.168.1.100                           V
```

### 2.3 é…ç½® pam_faillock

#### æ–¹æ³• 1ï¼šä½¿ç”¨ faillock.confï¼ˆæ¨èï¼ŒRHEL 8.2+ï¼‰

```bash
# æŸ¥çœ‹é»˜è®¤é…ç½®
cat /etc/security/faillock.conf

# åˆ›å»ºè‡ªå®šä¹‰é…ç½®
sudo tee /etc/security/faillock.conf << 'EOF'
# =============================================================================
# Faillock Configuration
# 5 æ¬¡å¤±è´¥åé”å®šè´¦æˆ· 10 åˆ†é’Ÿ
# Reference: CIS Benchmark 5.4.2
# =============================================================================

# æœ€å¤§å¤±è´¥æ¬¡æ•°ï¼ˆè¶…è¿‡æ­¤æ•°é”å®šï¼‰
deny = 5

# é”å®šæ—¶é—´ï¼ˆç§’ï¼‰- 10 åˆ†é’Ÿ
unlock_time = 600

# å¤±è´¥è®¡æ•°çª—å£ï¼ˆç§’ï¼‰- 15 åˆ†é’Ÿå†…çš„å¤±è´¥æ‰è®¡æ•°
fail_interval = 900

# æ˜¯å¦é”å®š rootï¼ˆç”Ÿäº§ç¯å¢ƒå»ºè®® yesï¼Œä½†éœ€è¦æœ‰å…¶ä»–æ¢å¤æ–¹å¼ï¼‰
# even_deny_root
# root_unlock_time = 60

# å®¡è®¡å¤±è´¥å°è¯•
audit

# é™é»˜æ¨¡å¼ï¼ˆä¸æç¤ºå‰©ä½™å°è¯•æ¬¡æ•°ï¼Œé˜²æ­¢ä¿¡æ¯æ³„éœ²ï¼‰
silent

# è®°å½•ç›®å½•
dir = /var/run/faillock

EOF
```

#### æ–¹æ³• 2ï¼šç›´æ¥åœ¨ PAM æ–‡ä»¶é…ç½®ï¼ˆæ—§ç‰ˆæœ¬ï¼‰

å¦‚æœç³»ç»Ÿä¸æ”¯æŒ faillock.confï¼Œéœ€è¦ç›´æ¥ä¿®æ”¹ PAM æ–‡ä»¶ï¼š

```bash
# RHEL/CentOS: å¤‡ä»½å¹¶ç¼–è¾‘ system-auth
sudo cp /etc/pam.d/system-auth /etc/pam.d/system-auth.bak.$(date +%Y%m%d)

# åœ¨ auth éƒ¨åˆ†æ·»åŠ ï¼ˆpam_unix ä¹‹å‰ï¼‰:
auth        required      pam_faillock.so preauth silent audit deny=5 unlock_time=600
auth        sufficient    pam_unix.so ...
auth        [default=die] pam_faillock.so authfail audit deny=5 unlock_time=600

# åœ¨ account éƒ¨åˆ†æ·»åŠ :
account     required      pam_faillock.so
```

### 2.4 æµ‹è¯•è´¦æˆ·é”å®š

> **è­¦å‘Š**ï¼šåœ¨æµ‹è¯•ç¯å¢ƒè¿›è¡Œï¼Œå¹¶ç¡®ä¿æœ‰å¤‡ç”¨ root ä¼šè¯ï¼  

```bash
# åˆ›å»ºæµ‹è¯•ç”¨æˆ·
sudo useradd -m testlockuser
sudo passwd testlockuser  # è®¾ç½®å¯†ç 

# æ•…æ„è¾“é”™å¯†ç  5 æ¬¡
ssh testlockuser@localhost  # è¾“å…¥é”™è¯¯å¯†ç  5 æ¬¡

# æ£€æŸ¥é”å®šçŠ¶æ€
sudo faillock --user testlockuser

# è¾“å‡ºç¤ºä¾‹ï¼š
# testlockuser:
# When                Type  Source                              Valid
# 2025-01-04 10:30:01 RHOST 127.0.0.1                               V
# 2025-01-04 10:30:03 RHOST 127.0.0.1                               V
# 2025-01-04 10:30:05 RHOST 127.0.0.1                               V
# 2025-01-04 10:30:07 RHOST 127.0.0.1                               V
# 2025-01-04 10:30:09 RHOST 127.0.0.1                               V

# å†æ¬¡å°è¯•ç™»å½•ï¼ˆå³ä½¿å¯†ç æ­£ç¡®ä¹Ÿä¼šè¢«æ‹’ç»ï¼‰
ssh testlockuser@localhost
# è¾“å‡ºï¼šPermission denied (publickey,gssapi-keyex,gssapi-with-mic,password).
```

### 2.5 è§£é”è´¦æˆ·

```bash
# è§£é”ç‰¹å®šç”¨æˆ·
sudo faillock --user testlockuser --reset

# éªŒè¯è§£é”
sudo faillock --user testlockuser
# è¾“å‡ºåº”ä¸ºç©º

# ç°åœ¨å¯ä»¥æ­£å¸¸ç™»å½•äº†
ssh testlockuser@localhost
```

### 2.6 å®æˆ˜ï¼šé…ç½®è„šæœ¬

ä½¿ç”¨æˆ‘ä»¬æä¾›çš„è„šæœ¬å¿«é€Ÿé…ç½®ï¼š

```bash
# æŸ¥çœ‹è„šæœ¬å†…å®¹
cat code/pam-faillock-demo/setup-faillock.sh

# æ‰§è¡Œé…ç½®ï¼ˆéœ€è¦ rootï¼‰
sudo bash code/pam-faillock-demo/setup-faillock.sh
```

---

## Step 3 - å¯†ç ç­–ç•¥é…ç½®ï¼špam_pwqualityï¼ˆ20 åˆ†é’Ÿï¼‰

### 3.1 pam_pwquality ç®€ä»‹

pam_pwquality ç”¨äºåœ¨ç”¨æˆ·æ›´æ”¹å¯†ç æ—¶æ£€æŸ¥å¯†ç å¼ºåº¦ã€‚

```
å¯†ç æ›´æ”¹æµç¨‹ï¼š

   ç”¨æˆ·æ‰§è¡Œ passwd
         â”‚
         â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  pam_pwquality  â”‚ â”€â”€â”€ "å¯†ç å¤Ÿå¤æ‚å—ï¼Ÿ"
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚ æ£€æŸ¥
            â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ - é•¿åº¦è¶³å¤Ÿï¼Ÿï¼ˆminlenï¼‰                            â”‚
   â”‚ - åŒ…å«æ•°å­—ï¼Ÿï¼ˆdcreditï¼‰                           â”‚
   â”‚ - åŒ…å«å¤§å†™ï¼Ÿï¼ˆucreditï¼‰                           â”‚
   â”‚ - åŒ…å«ç‰¹æ®Šå­—ç¬¦ï¼Ÿï¼ˆocreditï¼‰                       â”‚
   â”‚ - ä¸æ˜¯å­—å…¸è¯ï¼Ÿï¼ˆdictcheckï¼‰                       â”‚
   â”‚ - ä¸åŒ…å«ç”¨æˆ·åï¼Ÿï¼ˆusercheckï¼‰                     â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
      é€šè¿‡ â†’ å…è®¸æ›´æ”¹å¯†ç 
      å¤±è´¥ â†’ æ‹’ç»ï¼Œè¦æ±‚é‡æ–°è¾“å…¥
```

<details>
<summary>View ASCII source</summary>

```
å¯†ç æ›´æ”¹æµç¨‹ï¼š

   ç”¨æˆ·æ‰§è¡Œ passwd
         â”‚
         â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  pam_pwquality  â”‚ â”€â”€â”€ "å¯†ç å¤Ÿå¤æ‚å—ï¼Ÿ"
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚ æ£€æŸ¥
            â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ - é•¿åº¦è¶³å¤Ÿï¼Ÿï¼ˆminlenï¼‰                            â”‚
   â”‚ - åŒ…å«æ•°å­—ï¼Ÿï¼ˆdcreditï¼‰                           â”‚
   â”‚ - åŒ…å«å¤§å†™ï¼Ÿï¼ˆucreditï¼‰                           â”‚
   â”‚ - åŒ…å«ç‰¹æ®Šå­—ç¬¦ï¼Ÿï¼ˆocreditï¼‰                       â”‚
   â”‚ - ä¸æ˜¯å­—å…¸è¯ï¼Ÿï¼ˆdictcheckï¼‰                       â”‚
   â”‚ - ä¸åŒ…å«ç”¨æˆ·åï¼Ÿï¼ˆusercheckï¼‰                     â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
      é€šè¿‡ â†’ å…è®¸æ›´æ”¹å¯†ç 
      å¤±è´¥ â†’ æ‹’ç»ï¼Œè¦æ±‚é‡æ–°è¾“å…¥
```

</details>

### 3.2 é…ç½®å‚æ•°è¯¦è§£

| å‚æ•° | å«ä¹‰ | CIS æ¨è | ç¤ºä¾‹ |
|------|------|----------|------|
| minlen | æœ€å°é•¿åº¦ | 14 | minlen = 14 |
| dcredit | æ•°å­—è¦æ±‚ï¼ˆè´Ÿæ•°=å¿…é¡»åŒ…å«Nä¸ªï¼‰ | -1 | dcredit = -1 |
| ucredit | å¤§å†™å­—æ¯è¦æ±‚ | -1 | ucredit = -1 |
| lcredit | å°å†™å­—æ¯è¦æ±‚ | -1 | lcredit = -1 |
| ocredit | ç‰¹æ®Šå­—ç¬¦è¦æ±‚ | -1 | ocredit = -1 |
| minclass | æœ€å°‘å­—ç¬¦ç±»åˆ«æ•° | 4 | minclass = 4 |
| dictcheck | å­—å…¸æ£€æŸ¥ | 1 | dictcheck = 1 |
| usercheck | ç”¨æˆ·åæ£€æŸ¥ | 1 | usercheck = 1 |
| maxrepeat | æœ€å¤§è¿ç»­é‡å¤å­—ç¬¦ | 3 | maxrepeat = 3 |
| maxclassrepeat | åŒç±»å­—ç¬¦æœ€å¤§è¿ç»­ | 4 | maxclassrepeat = 4 |
| retry | é‡è¯•æ¬¡æ•° | 3 | retry = 3 |

> **æ³¨æ„**ï¼šcredit å‚æ•°ä½¿ç”¨è´Ÿæ•°è¡¨ç¤º"å¿…é¡»åŒ…å«"ï¼Œæ­£æ•°è¡¨ç¤º"åŠ åˆ†é¡¹"ã€‚  

### 3.3 é…ç½®å¯†ç ç­–ç•¥

```bash
# å¤‡ä»½åŸé…ç½®
sudo cp /etc/security/pwquality.conf /etc/security/pwquality.conf.bak.$(date +%Y%m%d)

# åˆ›å»º CIS åˆè§„é…ç½®
sudo tee /etc/security/pwquality.conf << 'EOF'
# =============================================================================
# Password Quality Configuration
# Reference: CIS Benchmark 5.4.1, NIST SP 800-63B
# =============================================================================

# æœ€å°å¯†ç é•¿åº¦ï¼ˆCIS æ¨è 14ï¼‰
minlen = 14

# å­—ç¬¦ç±»åˆ«è¦æ±‚ï¼ˆè´Ÿæ•° = å¿…é¡»åŒ…å«çš„æ•°é‡ï¼‰
# å¿…é¡»åŒ…å«è‡³å°‘ 1 ä¸ªæ•°å­—
dcredit = -1

# å¿…é¡»åŒ…å«è‡³å°‘ 1 ä¸ªå¤§å†™å­—æ¯
ucredit = -1

# å¿…é¡»åŒ…å«è‡³å°‘ 1 ä¸ªå°å†™å­—æ¯
lcredit = -1

# å¿…é¡»åŒ…å«è‡³å°‘ 1 ä¸ªç‰¹æ®Šå­—ç¬¦
ocredit = -1

# æœ€å°‘éœ€è¦çš„å­—ç¬¦ç±»åˆ«æ•°ï¼ˆæ•°å­—ã€å¤§å†™ã€å°å†™ã€ç‰¹æ®Šï¼‰
minclass = 4

# å­—å…¸æ£€æŸ¥ï¼šç¦æ­¢ä½¿ç”¨å¸¸è§å¯†ç 
dictcheck = 1

# ç”¨æˆ·åæ£€æŸ¥ï¼šç¦æ­¢å¯†ç åŒ…å«ç”¨æˆ·å
usercheck = 1

# å‡ ä½•åºåˆ—æ£€æŸ¥ï¼šç¦æ­¢ "1234" ç­‰
gecoscheck = 1

# æœ€å¤§è¿ç»­ç›¸åŒå­—ç¬¦æ•°
maxrepeat = 3

# åŒç±»å­—ç¬¦ï¼ˆå¦‚å…¨æ•°å­—ï¼‰æœ€å¤§è¿ç»­æ•°
maxclassrepeat = 4

# æ–°å¯†ç ä¸æ—§å¯†ç å¿…é¡»ä¸åŒçš„å­—ç¬¦æ•°
difok = 8

# å…è®¸çš„é‡è¯•æ¬¡æ•°
retry = 3

# æ˜¯å¦å¼ºåˆ¶ root ä¹Ÿéµå®ˆè§„åˆ™
enforce_for_root

# æ‹’ç»ç©ºå¯†ç 
# (ç”± pam_unix çš„ nullok é€‰é¡¹æ§åˆ¶)

EOF
```

### 3.4 éªŒè¯å¯†ç ç­–ç•¥

```bash
# æµ‹è¯•å¯†ç å¼ºåº¦æ£€æŸ¥
pwscore "Weak123"
# è¾“å‡ºï¼šPassword quality check failed: ...

pwscore "MyStr0ng!Pass#2025"
# è¾“å‡ºï¼š84

# å°è¯•æ›´æ”¹å¯†ç ï¼ˆä¼šè¢«ç­–ç•¥æ‹¦æˆªå¼±å¯†ç ï¼‰
# åˆ›å»ºæµ‹è¯•ç”¨æˆ·
sudo useradd -m pwtest
sudo passwd pwtest  # å°è¯•è®¾ç½®å¼±å¯†ç å¦‚ "password123"

# è¾“å‡ºç¤ºä¾‹ï¼š
# BAD PASSWORD: The password fails the dictionary check - it is based on a dictionary word
# BAD PASSWORD: The password is shorter than 14 characters
```

### 3.5 ç¤ºä¾‹é…ç½®æ–‡ä»¶

ä½¿ç”¨æˆ‘ä»¬æä¾›çš„é…ç½®ï¼š

```bash
# æŸ¥çœ‹ç¤ºä¾‹é…ç½®
cat code/pwquality.conf

# åº”ç”¨é…ç½®
sudo cp code/pwquality.conf /etc/security/pwquality.conf
```

---

## Step 4 - å¸¸ç”¨ PAM æ¨¡å—æ¦‚è§ˆï¼ˆ15 åˆ†é’Ÿï¼‰

### 4.1 æ ¸å¿ƒæ¨¡å—

| æ¨¡å— | ç”¨é€” | é…ç½®æ–‡ä»¶ |
|------|------|----------|
| pam_unix | æ ‡å‡† Linux è®¤è¯ï¼ˆ/etc/passwd, /etc/shadowï¼‰ | - |
| pam_faillock | ç™»å½•å¤±è´¥é”å®š | /etc/security/faillock.conf |
| pam_pwquality | å¯†ç å¼ºåº¦æ£€æŸ¥ | /etc/security/pwquality.conf |
| pam_limits | èµ„æºé™åˆ¶ï¼ˆulimitï¼‰ | /etc/security/limits.conf |

### 4.2 è®¿é—®æ§åˆ¶æ¨¡å—

| æ¨¡å— | ç”¨é€” | é…ç½®æ–‡ä»¶ |
|------|------|----------|
| pam_access | åŸºäºç”¨æˆ·/ä¸»æœºçš„è®¿é—®æ§åˆ¶ | /etc/security/access.conf |
| pam_time | åŸºäºæ—¶é—´çš„è®¿é—®æ§åˆ¶ | /etc/security/time.conf |
| pam_listfile | åŸºäºæ–‡ä»¶åˆ—è¡¨çš„è®¿é—®æ§åˆ¶ | è‡ªå®šä¹‰ |

#### pam_access ç¤ºä¾‹

```bash
# /etc/security/access.conf ç¤ºä¾‹
# æ‹’ç»éç®¡ç†å‘˜ç»„ä»å¤–éƒ¨ IP ç™»å½•
-:ALL EXCEPT wheel:ALL EXCEPT LOCAL 192.168.0.0/16

# å…è®¸ sysadmin ç»„ä»ä»»ä½•åœ°æ–¹ç™»å½•
+:sysadmin:ALL

# æ‹’ç»å…¶ä»–æ‰€æœ‰ç”¨æˆ·
-:ALL:ALL
```

#### pam_time ç¤ºä¾‹

```bash
# /etc/security/time.conf ç¤ºä¾‹
# åªå…è®¸ developers ç»„åœ¨å·¥ä½œæ—¶é—´ç™»å½•
sshd;*;developers;Wk0900-1800
```

### 4.3 ä¼ä¸šè®¤è¯æ¨¡å—

> **æ³¨æ„**ï¼šä¼ä¸š LDAP/AD é›†æˆæ˜¯é«˜çº§è¯é¢˜ï¼Œè¿™é‡Œä»…åšæ¦‚è§ˆã€‚  

| æ¨¡å— | ç”¨é€” | å¸¸è§åœºæ™¯ |
|------|------|----------|
| pam_ldap | ç›´æ¥ LDAP è®¤è¯ | ä¼ ç»Ÿ LDAP ç¯å¢ƒ |
| pam_sss | SSSD è®¤è¯ï¼ˆæ¨èï¼‰ | AD/LDAP/FreeIPA é›†æˆ |
| pam_krb5 | Kerberos è®¤è¯ | AD ç¯å¢ƒ |

```
ä¼ä¸šç¯å¢ƒå…¸å‹ PAM æ ˆï¼š

auth  required     pam_env.so
auth  required     pam_faillock.so preauth
auth  sufficient   pam_sss.so           â† SSSD å¤„ç† AD/LDAP
auth  sufficient   pam_unix.so          â† æœ¬åœ°ç”¨æˆ·å›é€€
auth  required     pam_faillock.so authfail
auth  required     pam_deny.so
```

<details>
<summary>View ASCII source</summary>

```
ä¼ä¸šç¯å¢ƒå…¸å‹ PAM æ ˆï¼š

auth  required     pam_env.so
auth  required     pam_faillock.so preauth
auth  sufficient   pam_sss.so           â† SSSD å¤„ç† AD/LDAP
auth  sufficient   pam_unix.so          â† æœ¬åœ°ç”¨æˆ·å›é€€
auth  required     pam_faillock.so authfail
auth  required     pam_deny.so
```

</details>

### 4.4 pam_limits å¿«é€Ÿç¤ºä¾‹

```bash
# /etc/security/limits.conf
# é™åˆ¶ webserver ç”¨æˆ·çš„èµ„æº
webserver        soft    nofile          4096
webserver        hard    nofile          65536
webserver        soft    nproc           256
webserver        hard    nproc           512

# é™åˆ¶æ‰€æœ‰ç”¨æˆ·
*                soft    core            0        # ç¦ç”¨ core dump
*                hard    maxlogins       10       # æœ€å¤§ç™»å½•æ•°
```

---

## Step 5 - PAM è°ƒè¯•ä¸æ•…éšœæ’æŸ¥ï¼ˆ20 åˆ†é’Ÿï¼‰

### 5.1 å¸¸è§é”™è¯¯åŠè§£å†³

| ç—‡çŠ¶ | å¯èƒ½åŸå›  | è¯Šæ–­å‘½ä»¤ | è§£å†³æ–¹æ¡ˆ |
|------|----------|----------|----------|
| æ— æ³•ç™»å½•ï¼ˆå¯†ç æ­£ç¡®ï¼‰ | PAM é…ç½®è¯­æ³•é”™è¯¯ | `journalctl -u sshd` | æ¢å¤å¤‡ä»½ |
| å¯†ç æ­£ç¡®ä½†è¢«æ‹’ç» | è´¦æˆ·è¢« faillock é”å®š | `faillock --user xxx` | `faillock --reset` |
| sudo ä¸å·¥ä½œ | /etc/pam.d/sudo é”™è¯¯ | `sudo -l` è¾“å‡º | ä½¿ç”¨ root ä¿®å¤ |
| å¯†ç ä¿®æ”¹è¢«æ‹’ç» | pwquality ç­–ç•¥è¿‡ä¸¥ | æŸ¥çœ‹é”™è¯¯æç¤º | è°ƒæ•´ pwquality.conf |

### 5.2 æŸ¥çœ‹è®¤è¯æ—¥å¿—

```bash
# RHEL/CentOS: è®¤è¯æ—¥å¿—
sudo tail -f /var/log/secure

# Debian/Ubuntu: è®¤è¯æ—¥å¿—
sudo tail -f /var/log/auth.log

# ä½¿ç”¨ journalctl æŸ¥çœ‹ SSH è®¤è¯
sudo journalctl -u sshd -f

# æŸ¥çœ‹ PAM ç›¸å…³æ—¥å¿—
sudo journalctl | grep -i pam

# æŸ¥çœ‹ç™»å½•å¤±è´¥
sudo journalctl -t sshd --since "1 hour ago" | grep -i "failed\|denied"
```

### 5.3 å¯ç”¨ PAM è°ƒè¯•

> **è­¦å‘Š**ï¼šè°ƒè¯•æ¨¡å¼ä¼šè®°å½•æ•æ„Ÿä¿¡æ¯ï¼Œåªåœ¨æ’é”™æ—¶ä¸´æ—¶å¯ç”¨ï¼  

```bash
# åœ¨ PAM é…ç½®ä¸­æ·»åŠ  debug å‚æ•°
# /etc/pam.d/sshd
auth    required    pam_faillock.so preauth silent audit deny=5 debug

# æˆ–åœ¨ /etc/security/faillock.conf æ·»åŠ 
# debug

# æŸ¥çœ‹è°ƒè¯•è¾“å‡º
sudo journalctl -u sshd -f
```

### 5.4 PAM é…ç½®è¯­æ³•éªŒè¯

ä¸å¹¸çš„æ˜¯ï¼ŒPAM æ²¡æœ‰åƒ `sshd -t` é‚£æ ·çš„éªŒè¯å·¥å…·ã€‚ä½†å¯ä»¥ï¼š

```bash
# 1. æ£€æŸ¥æ–‡ä»¶è¯­æ³•ï¼ˆåŸºæœ¬æ£€æŸ¥ï¼‰
for f in /etc/pam.d/*; do
    echo "=== Checking $f ==="
    # æ£€æŸ¥æ˜¯å¦å¼•ç”¨ä¸å­˜åœ¨çš„æ¨¡å—
    grep -E "^(auth|account|password|session)" "$f" | while read line; do
        module=$(echo "$line" | awk '{print $3}' | sed 's/\.so.*/\.so/')
        if ! find /lib64/security /lib/security -name "$module" 2>/dev/null | grep -q .; then
            echo "WARNING: Module $module not found"
        fi
    done
done

# 2. æµ‹è¯•æ¨¡å—æ˜¯å¦å­˜åœ¨
ls /lib64/security/ 2>/dev/null || ls /lib/x86_64-linux-gnu/security/

# 3. ä½¿ç”¨ pamtesterï¼ˆå¦‚æœå¯ç”¨ï¼‰
# sudo dnf install pamtester
pamtester sshd testuser authenticate
```

### 5.5 å¸¸è§ PAM é”™è¯¯æ¶ˆæ¯

| é”™è¯¯æ¶ˆæ¯ | å«ä¹‰ | è§£å†³æ–¹æ¡ˆ |
|----------|------|----------|
| `Module is unknown` | æ¨¡å—æ–‡ä»¶ä¸å­˜åœ¨ | å®‰è£…å¯¹åº”åŒ… |
| `Authentication failure` | è®¤è¯å¤±è´¥ | æ£€æŸ¥å¯†ç /å¯†é’¥/é”å®šçŠ¶æ€ |
| `Permission denied` | è®¿é—®è¢«æ‹’ç» | æ£€æŸ¥ pam_access, faillock |
| `account expired` | è´¦æˆ·è¿‡æœŸ | `chage -l user` æ£€æŸ¥ |
| `password has expired` | å¯†ç è¿‡æœŸ | `chage -d 0 user` æˆ–æ›´æ–°å¯†ç  |

---

## Step 6 - å®‰å…¨æµ‹è¯• PAM å˜æ›´ï¼ˆ15 åˆ†é’Ÿï¼‰

> **è¿™æ˜¯æœ¬è¯¾æœ€é‡è¦çš„æŠ€èƒ½ï¼šå®‰å…¨åœ°æµ‹è¯• PAM é…ç½®å˜æ›´ã€‚**  

### 6.1 é»„é‡‘æ³•åˆ™

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     PAM å˜æ›´å®‰å…¨æ³•åˆ™                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  1. æ°¸è¿œä¿æŒä¸€ä¸ª root ä¼šè¯æ‰“å¼€                                  â”‚
â”‚     - æ–°å¼€ç»ˆç«¯æµ‹è¯•ï¼Œä¸è¦å…³é—­æ—§ç»ˆç«¯                              â”‚
â”‚     - ç¡®ä¿æœ‰æ§åˆ¶å°è®¿é—®æƒé™                                      â”‚
â”‚                                                                 â”‚
â”‚  2. ä¿®æ”¹å‰å¤‡ä»½                                                  â”‚
â”‚     cp /etc/pam.d/system-auth /etc/pam.d/system-auth.bak       â”‚
â”‚                                                                 â”‚
â”‚  3. åœ¨æµ‹è¯•ç¯å¢ƒå…ˆéªŒè¯                                            â”‚
â”‚     - ä½¿ç”¨ VM æˆ–å®¹å™¨æµ‹è¯•                                        â”‚
â”‚     - ä¸è¦ç›´æ¥åœ¨ç”Ÿäº§ç¯å¢ƒæµ‹è¯•                                    â”‚
â”‚                                                                 â”‚
â”‚  4. å‡†å¤‡å›æ»šè®¡åˆ’                                                â”‚
â”‚     - çŸ¥é“å¦‚ä½•æ¢å¤å¤‡ä»½                                          â”‚
â”‚     - çŸ¥é“å¦‚ä½•è¿›å…¥æ•‘æ´æ¨¡å¼                                      â”‚
â”‚                                                                 â”‚
â”‚  5. å°æ­¥ä¿®æ”¹ï¼Œé€ä¸€æµ‹è¯•                                          â”‚
â”‚     - ä¸è¦ä¸€æ¬¡æ”¹å¾ˆå¤šä¸œè¥¿                                        â”‚
â”‚     - æ¯æ”¹ä¸€é¡¹å°±æµ‹è¯•                                            â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

<details>
<summary>View ASCII source</summary>

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     PAM å˜æ›´å®‰å…¨æ³•åˆ™                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  1. æ°¸è¿œä¿æŒä¸€ä¸ª root ä¼šè¯æ‰“å¼€                                  â”‚
â”‚     - æ–°å¼€ç»ˆç«¯æµ‹è¯•ï¼Œä¸è¦å…³é—­æ—§ç»ˆç«¯                              â”‚
â”‚     - ç¡®ä¿æœ‰æ§åˆ¶å°è®¿é—®æƒé™                                      â”‚
â”‚                                                                 â”‚
â”‚  2. ä¿®æ”¹å‰å¤‡ä»½                                                  â”‚
â”‚     cp /etc/pam.d/system-auth /etc/pam.d/system-auth.bak       â”‚
â”‚                                                                 â”‚
â”‚  3. åœ¨æµ‹è¯•ç¯å¢ƒå…ˆéªŒè¯                                            â”‚
â”‚     - ä½¿ç”¨ VM æˆ–å®¹å™¨æµ‹è¯•                                        â”‚
â”‚     - ä¸è¦ç›´æ¥åœ¨ç”Ÿäº§ç¯å¢ƒæµ‹è¯•                                    â”‚
â”‚                                                                 â”‚
â”‚  4. å‡†å¤‡å›æ»šè®¡åˆ’                                                â”‚
â”‚     - çŸ¥é“å¦‚ä½•æ¢å¤å¤‡ä»½                                          â”‚
â”‚     - çŸ¥é“å¦‚ä½•è¿›å…¥æ•‘æ´æ¨¡å¼                                      â”‚
â”‚                                                                 â”‚
â”‚  5. å°æ­¥ä¿®æ”¹ï¼Œé€ä¸€æµ‹è¯•                                          â”‚
â”‚     - ä¸è¦ä¸€æ¬¡æ”¹å¾ˆå¤šä¸œè¥¿                                        â”‚
â”‚     - æ¯æ”¹ä¸€é¡¹å°±æµ‹è¯•                                            â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

</details>

### 6.2 æµ‹è¯•æµç¨‹

```bash
# 1. ä¿æŒå½“å‰ root ç»ˆç«¯æ‰“å¼€ï¼

# 2. å¤‡ä»½æ‰€æœ‰ç›¸å…³é…ç½®
sudo cp -r /etc/pam.d /etc/pam.d.bak.$(date +%Y%m%d)
sudo cp /etc/security/faillock.conf /etc/security/faillock.conf.bak

# 3. è¿›è¡Œä¿®æ”¹
sudo vim /etc/security/faillock.conf

# 4. æ‰“å¼€æ–°ç»ˆç«¯æµ‹è¯•ï¼ˆä¸è¦å…³é—­æ—§ç»ˆç«¯ï¼ï¼‰
# åœ¨æ–°ç»ˆç«¯ï¼š
ssh testuser@localhost

# 5. å¦‚æœæˆåŠŸï¼Œå†æµ‹è¯•å‡ ä¸ªåœºæ™¯ï¼š
#    - æ­£ç¡®å¯†ç ç™»å½•
#    - é”™è¯¯å¯†ç ç™»å½•ï¼ˆéªŒè¯é”å®šï¼‰
#    - sudo å‘½ä»¤
#    - su å‘½ä»¤

# 6. å¦‚æœå¤±è´¥ï¼Œåœ¨æ—§ç»ˆç«¯æ¢å¤ï¼š
sudo cp -r /etc/pam.d.bak.* /etc/pam.d

# 7. ç¡®è®¤ä¸€åˆ‡æ­£å¸¸åï¼Œæ‰å…³é—­æ—§ç»ˆç«¯
```

### 6.3 æ•‘æ´æ¨¡å¼æ¢å¤

å¦‚æœå®Œå…¨é”æ­»ï¼Œä½¿ç”¨æ•‘æ´æ¨¡å¼ï¼š

```bash
# 1. é‡å¯è¿›å…¥ GRUB
# åœ¨å¯åŠ¨æ—¶æŒ‰ e ç¼–è¾‘å¯åŠ¨é¡¹

# 2. åœ¨ linux è¡Œæœ«å°¾æ·»åŠ ï¼š
init=/bin/bash
# æˆ–
rd.break

# 3. æŒ‰ Ctrl+X å¯åŠ¨

# 4. æŒ‚è½½æ ¹æ–‡ä»¶ç³»ç»Ÿå¯å†™
mount -o remount,rw /sysroot
chroot /sysroot

# 5. æ¢å¤å¤‡ä»½
cp /etc/pam.d.bak/* /etc/pam.d/
# æˆ–æ¢å¤é»˜è®¤
authselect select sssd --force  # RHEL 8+

# 6. å¦‚æœæ”¹äº† SELinux æ–‡ä»¶ï¼Œéœ€è¦ relabel
touch /.autorelabel

# 7. é‡å¯
exit
reboot
```

---

## åæ¨¡å¼ï¼šå¸¸è§é”™è¯¯

### é”™è¯¯ 1ï¼šç›´æ¥ä¿®æ”¹ç”Ÿäº§ç¯å¢ƒ PAM

```bash
# å±é™©ï¼æ²¡æœ‰å¤‡ä»½å°±ä¿®æ”¹
sudo vim /etc/pam.d/system-auth

# æ­£ç¡®åšæ³•
sudo cp /etc/pam.d/system-auth /etc/pam.d/system-auth.bak.$(date +%Y%m%d)
sudo vim /etc/pam.d/system-auth
# åœ¨å¦ä¸€ä¸ªç»ˆç«¯æµ‹è¯•ï¼
```

### é”™è¯¯ 2ï¼šåŒæ—¶ä¿®æ”¹å¤šä¸ªé…ç½®

```bash
# å±é™©ï¼åŒæ—¶æ”¹å¾ˆå¤šï¼Œå‡ºé—®é¢˜ä¸çŸ¥é“æ˜¯å“ªä¸ª
sudo vim /etc/pam.d/system-auth
sudo vim /etc/pam.d/sshd
sudo vim /etc/security/faillock.conf
sudo vim /etc/security/pwquality.conf

# æ­£ç¡®åšæ³•ï¼šä¸€æ¬¡åªæ”¹ä¸€ä¸ªï¼Œæµ‹è¯•åå†æ”¹ä¸‹ä¸€ä¸ª
```

### é”™è¯¯ 3ï¼šä½¿ç”¨ even_deny_root ä½†æ²¡æœ‰å…¶ä»–æ¢å¤æ–¹å¼

```bash
# /etc/security/faillock.conf
even_deny_root          # â† root ä¹Ÿä¼šè¢«é”å®šï¼
root_unlock_time = 60   # â† å¿…é¡»è®¾ç½®æ¢å¤æ—¶é—´

# å¦‚æœæ²¡æœ‰è®¾ç½® root_unlock_timeï¼Œä¸”é”å®šäº† rootï¼Œä½ å¯èƒ½éœ€è¦æ•‘æ´æ¨¡å¼æ¢å¤
```

### é”™è¯¯ 4ï¼šå¿˜è®° pam_faillock éœ€è¦ä¸¤è¡Œ

```bash
# é”™è¯¯ï¼šåªåŠ äº†ä¸€è¡Œ
auth required pam_faillock.so preauth

# æ­£ç¡®ï¼šéœ€è¦ä¸¤è¡Œï¼ˆpreauth å’Œ authfailï¼‰
auth required pam_faillock.so preauth silent audit deny=5
auth [default=die] pam_faillock.so authfail audit deny=5
```

---

## èŒåœºå°è´´å£«ï¼ˆJapan IT Contextï¼‰

### PAM å®‰å…¨åœ¨æ—¥æœ¬ä¼ä¸š

| æ—¥è¯­æœ¯è¯­ | å«ä¹‰ | æŠ€æœ¯å®ç° |
|----------|------|----------|
| ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒªã‚·ãƒ¼ | å¯†ç ç­–ç•¥ | pam_pwquality |
| ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒ­ãƒƒã‚¯ | è´¦æˆ·é”å®š | pam_faillock |
| ãƒ­ã‚°ã‚¤ãƒ³èªè¨¼ | ç™»å½•è®¤è¯ | PAM è®¤è¯æµç¨‹ |
| å¤šè¦ç´ èªè¨¼ | å¤šå› ç´ è®¤è¯ | pam_google_authenticator ç­‰ |
| LDAP é€£æº | LDAP é›†æˆ | pam_sss / pam_ldap |

### æ—¥æœ¬ä¼ä¸šåˆè§„è¦æ±‚

å¾ˆå¤šæ—¥æœ¬ä¼ä¸šéœ€è¦æ»¡è¶³ä»¥ä¸‹åˆè§„è¦æ±‚ï¼š

1. **ISMS (ISO 27001)**
   - å¯†ç å¤æ‚åº¦è¦æ±‚
   - è´¦æˆ·é”å®šç­–ç•¥
   - è®¿é—®æ§åˆ¶

2. **PCI DSS**ï¼ˆé‡‘è/æ”¯ä»˜è¡Œä¸šï¼‰
   - 8.1.6: 6 æ¬¡å¤±è´¥åé”å®š
   - 8.1.7: é”å®šè‡³å°‘ 30 åˆ†é’Ÿ
   - 8.2.3: å¯†ç è‡³å°‘ 7 å­—ç¬¦

3. **J-SOX**ï¼ˆä¸Šå¸‚å…¬å¸ï¼‰
   - è®¿é—®æ§åˆ¶å®¡è®¡
   - å¯†ç å˜æ›´è®°å½•

### å®‰å…¨æ£€æŸ¥æŠ¥å‘Šæ¨¡æ¿

```markdown
## PAM ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»çµæœ

### ç¢ºèªæ—¥: 20XXå¹´XXæœˆXXæ—¥
### å¯¾è±¡ã‚µãƒ¼ãƒãƒ¼: production-app-01

| é …ç›® | æ¨å¥¨è¨­å®š | ç¾åœ¨è¨­å®š | åˆ¤å®š |
|------|----------|----------|------|
| ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒ­ãƒƒã‚¯ï¼ˆå¤±æ•—å›æ•°ï¼‰ | 5 å› | æœªè¨­å®š | NG |
| ãƒ­ãƒƒã‚¯æ™‚é–“ | 10 åˆ†ä»¥ä¸Š | - | NG |
| ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æœ€å°é•· | 14 æ–‡å­— | 8 æ–‡å­— | è¦æ”¹å–„ |
| ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¤‡é›‘æ€§ | æœ‰åŠ¹ | ç„¡åŠ¹ | NG |

### æ”¹å–„ææ¡ˆ
1. pam_faillock ã‚’å°å…¥ã—ã€5 å›å¤±æ•—ã§ 10 åˆ†ãƒ­ãƒƒã‚¯è¨­å®š
2. pwquality ã§ 14 æ–‡å­—ä»¥ä¸Šã€è¤‡é›‘æ€§è¦ä»¶ã‚’æœ‰åŠ¹åŒ–
3. å¤‰æ›´å¾Œã®ãƒ†ã‚¹ãƒˆæ‰‹é †ã‚’æ–‡æ›¸åŒ–
```

---

## æ£€æŸ¥æ¸…å•

å®Œæˆæœ¬è¯¾åï¼Œä½ åº”è¯¥èƒ½å¤Ÿï¼š

- [ ] è§£é‡Š PAM å››ç§æ¨¡å—ç±»å‹ï¼ˆauth, account, password, sessionï¼‰
- [ ] è§£é‡Šæ§åˆ¶æ ‡å¿—çš„åŒºåˆ«ï¼ˆrequired, requisite, sufficient, optionalï¼‰
- [ ] é…ç½® pam_faillock å®ç°è´¦æˆ·é”å®š
- [ ] ä½¿ç”¨ `faillock` å‘½ä»¤æŸ¥çœ‹å’Œé‡ç½®é”å®šçŠ¶æ€
- [ ] é…ç½® pam_pwquality å¯†ç ç­–ç•¥
- [ ] ä½¿ç”¨ `pwscore` æµ‹è¯•å¯†ç å¼ºåº¦
- [ ] å®‰å…¨åœ°æµ‹è¯• PAM é…ç½®å˜æ›´ï¼ˆä¿æŒå¤‡ç”¨ä¼šè¯ï¼‰
- [ ] ä» PAM é…ç½®é”™è¯¯ä¸­æ¢å¤

---

## æœ¬è¯¾å°ç»“

| æ¦‚å¿µ | å‘½ä»¤/é…ç½® | è®°å¿†ç‚¹ |
|------|-----------|--------|
| è´¦æˆ·é”å®š | pam_faillock | æ›¿ä»£ pam_tally2 |
| æŸ¥çœ‹é”å®š | `faillock --user xxx` | æŸ¥çœ‹å¤±è´¥è®°å½• |
| è§£é”è´¦æˆ· | `faillock --user xxx --reset` | æ¸…é™¤å¤±è´¥è®°å½• |
| å¯†ç ç­–ç•¥ | /etc/security/pwquality.conf | minlen, dcredit ç­‰ |
| æµ‹è¯•å¯†ç  | `pwscore "password"` | è¿”å›åˆ†æ•° |
| è®¤è¯æ—¥å¿— | /var/log/secure æˆ– auth.log | æŸ¥çœ‹å¤±è´¥åŸå›  |
| å®‰å…¨æ³•åˆ™ | **ä¿æŒå¤‡ç”¨ root ä¼šè¯ï¼** | æœ€é‡è¦çš„è§„åˆ™ |

**é»„é‡‘æ³•åˆ™**ï¼š

```
PAM é…ç½® = é«˜é£é™©æ“ä½œ

å¤‡ä»½ â†’ ä¿æŒå¤‡ç”¨ä¼šè¯ â†’ å°æ­¥ä¿®æ”¹ â†’ é€ä¸€æµ‹è¯• â†’ å‡†å¤‡å›æ»š
```

---

## å»¶ä¼¸é˜…è¯»

- [Linux PAM Documentation](http://www.linux-pam.org/Linux-PAM-html/) - å®˜æ–¹æ–‡æ¡£
- [CIS Benchmark - Password Settings](https://www.cisecurity.org/benchmark) - åˆè§„åŸºçº¿
- [RHEL 9 PAM Configuration](https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/9/html/security_hardening/configuring-and-managing-security_security-hardening) - Red Hat å®˜æ–¹æŒ‡å—
- [pam_faillock man page](https://man7.org/linux/man-pages/man8/pam_faillock.8.html) - è¯¦ç»†å‚æ•°
- ç›¸å…³è¯¾ç¨‹ï¼š[Lesson 02 - SSH åŠ å›º](../02-ssh-hardening/) - SSH è®¤è¯ä¸ PAM çš„å…³ç³»
- ç›¸å…³è¯¾ç¨‹ï¼š[Lesson 10 - CIS Benchmarks](../10-cis-benchmarks/) - åˆè§„æ‰«æä¼šæ£€æŸ¥ PAM é…ç½®

---

## ç³»åˆ—å¯¼èˆª

[ä¸Šä¸€è¯¾ï¼š08 - nftables æ·±å…¥](../08-nftables/) | [ç³»åˆ—é¦–é¡µ](../) | [ä¸‹ä¸€è¯¾ï¼š10 - CIS Benchmarks åˆè§„å®æˆ˜ ->](../10-cis-benchmarks/)
