#!/usr/sbin/nft -f
# =============================================================================
# nftables Production Configuration for Web/Application Server
# =============================================================================
#
# Description: Production-ready firewall configuration with security best practices
# Platform: RHEL 9 / Rocky 9 / AlmaLinux 9 / Debian 11+ / Ubuntu 22.04+
# Author: cloud-atlas security course
# Created: 2025
#
# Features:
#   - IPv4 + IPv6 unified rules (inet family)
#   - Connection tracking (ct state) for stateful filtering
#   - IP whitelist for SSH access
#   - Rate limiting for brute-force protection
#   - Logging with rate limit to prevent log flooding
#   - ICMP/ICMPv6 essential types allowed
#
# Installation:
#   1. Validate: sudo nft -c -f /path/to/nftables.conf
#   2. Apply:    sudo nft -f /path/to/nftables.conf
#   3. Persist:  sudo cp /path/to/nftables.conf /etc/nftables.conf
#   4. Enable:   sudo systemctl enable --now nftables
#
# IMPORTANT:
#   - Always validate with -c before applying!
#   - Keep an existing SSH session open when applying!
#   - Modify trusted_ips set before production use!
#
# =============================================================================

# Clear all existing rules
flush ruleset

# =============================================================================
# Table: inet filter (IPv4 + IPv6 unified)
# =============================================================================
table inet filter {

    # -------------------------------------------------------------------------
    # Set: trusted_ips - IP addresses allowed to access SSH
    # Modify this list for your environment!
    # -------------------------------------------------------------------------
    set trusted_ips {
        type ipv4_addr
        flags interval
        comment "IP addresses allowed to access SSH and management ports"
        elements = {
            10.0.0.0/8,          # Private network (RFC 1918)
            172.16.0.0/12,       # Private network (RFC 1918)
            192.168.0.0/16       # Private network (RFC 1918)
            # Add your specific management IPs here:
            # 203.0.113.50,      # Office IP
            # 198.51.100.0/24    # VPN subnet
        }
    }

    # -------------------------------------------------------------------------
    # Set: blocked_ips - IP addresses to block (optional)
    # -------------------------------------------------------------------------
    set blocked_ips {
        type ipv4_addr
        flags interval, timeout
        timeout 1h
        comment "Dynamically blocked IPs (auto-expire after 1 hour)"
        # Elements can be added dynamically:
        # nft add element inet filter blocked_ips '{ 192.0.2.100 }'
    }

    # -------------------------------------------------------------------------
    # Chain: input - Inbound traffic control
    # Policy: DROP (default deny)
    # -------------------------------------------------------------------------
    chain input {
        type filter hook input priority 0; policy drop;

        # =====================================================================
        # 1. Connection Tracking (CRITICAL - must be first!)
        # =====================================================================

        # Allow established and related connections (high-frequency, fast path)
        ct state established,related accept comment "Allow established/related connections"

        # Drop invalid packets (malformed, out-of-state)
        ct state invalid counter drop comment "Drop invalid packets"

        # =====================================================================
        # 2. Blocked IPs (check before other rules)
        # =====================================================================

        ip saddr @blocked_ips counter drop comment "Drop blocked IPs"

        # =====================================================================
        # 3. Loopback Interface
        # =====================================================================

        iif "lo" accept comment "Allow loopback interface"

        # =====================================================================
        # 4. SSH Access (IP whitelist + rate limiting)
        # =====================================================================

        # Allow SSH only from trusted IPs with rate limiting
        ip saddr @trusted_ips tcp dport 22 ct state new \
            limit rate 5/minute burst 10 packets \
            counter accept \
            comment "SSH from trusted IPs (rate limited)"

        # =====================================================================
        # 5. Web Services (HTTP/HTTPS)
        # =====================================================================

        tcp dport 80 ct state new accept comment "HTTP"
        tcp dport 443 ct state new accept comment "HTTPS"

        # =====================================================================
        # 6. ICMP/ICMPv6 (essential types only, rate limited)
        # =====================================================================

        # IPv4 ICMP
        ip protocol icmp icmp type {
            echo-request,           # ping
            echo-reply,             # pong
            destination-unreachable # path MTU discovery
        } limit rate 10/second burst 20 packets accept comment "ICMPv4 essential"

        # IPv6 ICMPv6
        ip6 nexthdr icmpv6 icmpv6 type {
            echo-request,           # ping6
            echo-reply,             # pong6
            nd-neighbor-solicit,    # NDP (required for IPv6)
            nd-neighbor-advert,     # NDP (required for IPv6)
            nd-router-solicit,      # Router discovery
            nd-router-advert        # Router advertisement
        } accept comment "ICMPv6 essential (NDP required)"

        # =====================================================================
        # 7. Optional: Additional Services (uncomment as needed)
        # =====================================================================

        # DNS (if this is a DNS server)
        # udp dport 53 ct state new accept comment "DNS UDP"
        # tcp dport 53 ct state new accept comment "DNS TCP"

        # Mail (if this is a mail server)
        # tcp dport 25 ct state new accept comment "SMTP"
        # tcp dport 587 ct state new accept comment "SMTP Submission"
        # tcp dport 993 ct state new accept comment "IMAPS"

        # Database (only from specific hosts!)
        # ip saddr @trusted_ips tcp dport 3306 accept comment "MySQL from trusted"
        # ip saddr @trusted_ips tcp dport 5432 accept comment "PostgreSQL from trusted"

        # Application ports
        # tcp dport 8080 ct state new accept comment "HTTP Alt"
        # tcp dport 3000-3100 ct state new accept comment "Node.js apps"

        # =====================================================================
        # 8. Logging and Default Deny
        # =====================================================================

        # Log dropped packets (rate limited to prevent log flooding)
        counter log prefix "[nftables DROP] " limit rate 3/minute comment "Log dropped traffic"

        # Final drop (implicit with policy drop, but explicit for clarity)
        counter drop comment "Drop all other traffic"
    }

    # -------------------------------------------------------------------------
    # Chain: forward - Transit traffic control
    # Policy: DROP (this is not a router by default)
    # -------------------------------------------------------------------------
    chain forward {
        type filter hook forward priority 0; policy drop;

        # =====================================================================
        # Uncomment if this machine acts as a router/gateway
        # =====================================================================

        # ct state established,related accept comment "Allow established forwards"
        # ct state invalid drop comment "Drop invalid forwards"

        # Example: Allow forwarding between interfaces
        # iifname "eth0" oifname "eth1" accept comment "Forward eth0 to eth1"
        # iifname "eth1" oifname "eth0" ct state established,related accept

        counter log prefix "[nftables FORWARD DROP] " limit rate 1/minute
    }

    # -------------------------------------------------------------------------
    # Chain: output - Outbound traffic control
    # Policy: ACCEPT (allow all outbound by default)
    # -------------------------------------------------------------------------
    chain output {
        type filter hook output priority 0; policy accept;

        # =====================================================================
        # For high-security environments, restrict outbound traffic:
        # =====================================================================

        # Uncomment to enable outbound filtering:
        # ct state established,related accept comment "Allow established outbound"
        # ct state invalid drop comment "Drop invalid outbound"
        #
        # # Allow essential outbound
        # tcp dport { 80, 443 } accept comment "HTTP/HTTPS"
        # udp dport 53 accept comment "DNS"
        # tcp dport 53 accept comment "DNS"
        # udp dport 123 accept comment "NTP"
        #
        # # Allow outbound to specific hosts
        # ip daddr { 10.0.0.0/8 } accept comment "Internal network"
        #
        # # Log and drop other outbound
        # counter log prefix "[nftables OUTPUT DROP] " limit rate 1/minute drop
    }
}

# =============================================================================
# Optional: NAT Table (for router/gateway configurations)
# =============================================================================
# table inet nat {
#     chain prerouting {
#         type nat hook prerouting priority -100;
#         # DNAT examples:
#         # iifname "eth0" tcp dport 8080 dnat to 192.168.1.100:80
#     }
#
#     chain postrouting {
#         type nat hook postrouting priority 100;
#         # SNAT/Masquerade for outbound:
#         # oifname "eth0" masquerade
#     }
# }

# =============================================================================
# End of configuration
# =============================================================================
# Validation: nft -c -f /etc/nftables.conf
# Apply:      nft -f /etc/nftables.conf
# Verify:     nft list ruleset
# =============================================================================
