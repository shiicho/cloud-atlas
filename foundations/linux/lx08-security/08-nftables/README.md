# 08 - nftables æ·±å…¥ï¼šç°ä»£é˜²ç«å¢™ / nftables Deep Dive: Modern Firewall

> **ç›®æ ‡**ï¼šæŒæ¡ nftables ç°ä»£é˜²ç«å¢™é…ç½®ï¼Œç†è§£è¿æ¥è·Ÿè¸ªçš„é‡è¦æ€§  
> **å‰ç½®**ï¼šå®Œæˆ Lesson 01-07ï¼ˆå®‰å…¨åŸåˆ™ã€SSHã€SELinuxã€auditdï¼‰  
> **æ—¶é—´**ï¼šâš¡ 40 åˆ†é’Ÿï¼ˆé€Ÿè¯»ï¼‰/ ğŸ”¬ 150 åˆ†é’Ÿï¼ˆå®Œæ•´å®æ“ï¼‰  
> **å®æˆ˜åœºæ™¯**ï¼šç”Ÿäº§æœåŠ¡å™¨é˜²ç«å¢™é…ç½® + iptables è¿ç§»  

---

## å°†å­¦åˆ°çš„å†…å®¹

1. ç†è§£ nftables å–ä»£ iptables çš„åŸå› 
2. æŒæ¡ nftables è¯­æ³•å’Œç»“æ„ï¼ˆtables, chains, rulesï¼‰
3. é…ç½®å¸¸è§é˜²ç«å¢™è§„åˆ™ï¼ˆçŠ¶æ€è·Ÿè¸ªã€ç«¯å£è¿‡æ»¤ã€IP ç™½åå•ï¼‰
4. ä» iptables è¿ç§»åˆ° nftables
5. **æŒæ¡ `nft -c -f` é…ç½®éªŒè¯ï¼ˆå…³é”®å®‰å…¨æŠ€èƒ½ï¼ï¼‰**

---

## å…ˆè·‘èµ·æ¥ï¼ï¼ˆ5 åˆ†é’Ÿï¼‰

> åœ¨å­¦ä¹ ç†è®ºä¹‹å‰ï¼Œå…ˆçœ‹çœ‹ä½ çš„æœåŠ¡å™¨å½“å‰çš„é˜²ç«å¢™çŠ¶æ€ã€‚  

```bash
# æŸ¥çœ‹å½“å‰ nftables è§„åˆ™é›†
sudo nft list ruleset

# å¦‚æœè¾“å‡ºä¸ºç©ºæˆ–æŠ¥é”™ï¼Œæ£€æŸ¥ iptablesï¼ˆæ—§ç³»ç»Ÿï¼‰
sudo iptables -L -n -v 2>/dev/null | head -20

# æ£€æŸ¥é˜²ç«å¢™æœåŠ¡çŠ¶æ€
systemctl status nftables 2>/dev/null || systemctl status firewalld 2>/dev/null

# æŸ¥çœ‹å¼€æ”¾çš„ç«¯å£
sudo ss -tulpn | grep LISTEN

# æ£€æŸ¥ç³»ç»Ÿä½¿ç”¨çš„æ˜¯ nftables è¿˜æ˜¯ iptables åç«¯
# RHEL 9 / Debian 11+ / Ubuntu 22.04+ é»˜è®¤ä½¿ç”¨ nftables
cat /etc/os-release | grep -E 'NAME|VERSION'
```

**ä½ åˆšåˆšæ£€æŸ¥äº†ï¼š**

- ç³»ç»Ÿæœ‰é˜²ç«å¢™è§„åˆ™å—ï¼Ÿï¼ˆå¾ˆå¤šç³»ç»Ÿé»˜è®¤æ— è§„åˆ™ï¼ï¼‰
- ä½¿ç”¨çš„æ˜¯ç°ä»£ nftables è¿˜æ˜¯æ—§çš„ iptablesï¼Ÿ
- å½“å‰å¼€æ”¾äº†å“ªäº›ç«¯å£ï¼Ÿ
- æ˜¯å¦æœ‰çŠ¶æ€è·Ÿè¸ªè§„åˆ™ï¼Ÿï¼ˆ`ct state` ç›¸å…³ï¼‰

**å¦‚æœä½ çš„æœåŠ¡å™¨ `nft list ruleset` è¾“å‡ºä¸ºç©ºï¼Œé‚£å®ƒå¯¹ç½‘ç»œæ”»å‡»å‡ ä¹æ²¡æœ‰é˜²æŠ¤ã€‚**

ç°åœ¨è®©æˆ‘ä»¬ç†è§£å¹¶é…ç½®ç°ä»£é˜²ç«å¢™ã€‚

---

## Step 1 - nftables vs iptablesï¼šä¸ºä»€ä¹ˆè¦è¿ç§»ï¼Ÿï¼ˆ15 åˆ†é’Ÿï¼‰

### 1.1 iptables çš„é—®é¢˜

iptables è¯ç”Ÿäº 2001 å¹´ï¼Œåœ¨ Linux é˜²ç«å¢™é¢†åŸŸæœåŠ¡äº† 20+ å¹´ã€‚ä½†å®ƒæœ‰å‡ ä¸ªè‡´å‘½é—®é¢˜ï¼š

```
iptables çš„è®¾è®¡ç¼ºé™·ï¼š

1. ç¢ç‰‡åŒ–æ¡†æ¶
   â”œâ”€â”€ iptables   â†’ IPv4
   â”œâ”€â”€ ip6tables  â†’ IPv6
   â”œâ”€â”€ arptables  â†’ ARP
   â””â”€â”€ ebtables   â†’ ä»¥å¤ªç½‘æ¡¥

2. éåŸå­æ›´æ–°
   - æ·»åŠ è§„åˆ™æ—¶å¯èƒ½æœ‰çŸ­æš‚çš„è§„åˆ™ç©ºçª—æœŸ
   - å¤§é‡è§„åˆ™æ›´æ–°å¯èƒ½å¯¼è‡´è¿æ¥ä¸­æ–­

3. è¯­æ³•å¤æ‚
   - æ¯ä¸ªåè®®éœ€è¦å•ç‹¬çš„å‘½ä»¤
   - è§„åˆ™éš¾ä»¥é˜…è¯»å’Œç»´æŠ¤
```

### 1.2 nftables çš„ä¼˜åŠ¿

nftables ä» Linux 3.13ï¼ˆ2014å¹´ï¼‰å¼€å§‹å¼•å…¥ï¼Œ2019 å¹´åé€æ¸æˆä¸ºä¸»æµï¼š

| ç‰¹æ€§ | iptables | nftables |
|------|----------|----------|
| æ¡†æ¶ç»Ÿä¸€ | 4 ä¸ªç‹¬ç«‹å·¥å…· | 1 ä¸ªç»Ÿä¸€æ¡†æ¶ |
| è§„åˆ™æ›´æ–° | éåŸå­ | **åŸå­æ›´æ–°** |
| è¯­æ³• | å¤æ‚ã€å¤šå‘½ä»¤ | ç®€æ´ã€ç±»ä¼¼ç¼–ç¨‹è¯­è¨€ |
| æ€§èƒ½ | çº¿æ€§è§„åˆ™åŒ¹é… | å¯ä¼˜åŒ–çš„è§„åˆ™é›† |
| é»˜è®¤çŠ¶æ€ï¼ˆ2025ï¼‰ | **ç»´æŠ¤æ¨¡å¼** | RHEL 9, Debian 11+, Ubuntu 22.04+ é»˜è®¤ |

### 1.3 2025 å¹´ç°çŠ¶

```
ä¸»æµå‘è¡Œç‰ˆé˜²ç«å¢™åç«¯ï¼š

RHEL/Rocky/AlmaLinux 9+   â†’ nftablesï¼ˆé»˜è®¤ï¼‰
Debian 11+ (Bullseye)     â†’ nftablesï¼ˆé»˜è®¤ï¼‰
Ubuntu 22.04+ (Jammy)     â†’ nftablesï¼ˆé»˜è®¤ï¼‰
Fedora 32+                â†’ nftablesï¼ˆé»˜è®¤ï¼‰

RHEL/CentOS 7             â†’ iptablesï¼ˆEOL: 2024-06-30ï¼‰
Ubuntu 18.04/20.04        â†’ iptablesï¼ˆå‘ nftables è¿‡æ¸¡ï¼‰
```

> **å…³é”®ä¿¡æ¯**ï¼šå¦‚æœä½ åœ¨ 2025 å¹´è¿˜åœ¨ç”¨ iptables é…ç½®æ–°æœåŠ¡å™¨ï¼Œä½ éœ€è¦ç«‹å³å‡çº§æŠ€èƒ½ã€‚  

---

## Step 2 - nftables ç»“æ„ï¼ˆ20 åˆ†é’Ÿï¼‰

### 2.1 æ ¸å¿ƒæ¦‚å¿µï¼šTables, Chains, Rules

```
nftables å±‚çº§ç»“æ„ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Ruleset                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                    Table: inet filter                 â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚              Chain: input                       â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ Rule: ct state established accept       â”‚    â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ Rule: tcp dport 22 accept               â”‚    â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ Rule: tcp dport {80, 443} accept        â”‚    â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ Rule: drop                              â”‚    â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚              Chain: output                      â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  ...                                            â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

<details>
<summary>View ASCII source</summary>

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Ruleset                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                    Table: inet filter                 â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚              Chain: input                       â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ Rule: ct state established accept       â”‚    â”‚  â”‚
â”‚  â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ Rule: tcp dport 22 accept               â”‚    â”‚  â”‚
â”‚  â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ Rule: tcp dport {80, 443} accept        â”‚    â”‚  â”‚
â”‚  â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ Rule: drop                              â”‚    â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚              Chain: output                      â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  ...                                            â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

</details>

### 2.2 Table åœ°å€æ—ï¼ˆAddress Familyï¼‰

| æ— | æè¿° | ç­‰ä»·çš„ iptables |
|---|------|-----------------|
| `inet` | IPv4 + IPv6 | iptables + ip6tables |
| `ip` | ä»… IPv4 | iptables |
| `ip6` | ä»… IPv6 | ip6tables |
| `arp` | ARP åŒ… | arptables |
| `bridge` | æ¡¥æ¥åŒ… | ebtables |
| `netdev` | å…¥å£ï¼ˆingressï¼‰ | æ—  |

> **æ¨è**ï¼š2025 å¹´æ–°é…ç½®åº”ä¼˜å…ˆä½¿ç”¨ `inet` æ—ï¼ŒåŒæ—¶å¤„ç† IPv4 å’Œ IPv6ã€‚  

### 2.3 Chain ç±»å‹å’Œ Hooks

```bash
# Chain å®šä¹‰è¯­æ³•
chain <name> {
    type <type> hook <hook> priority <priority>; policy <policy>;
}

# type ç±»å‹
# - filter: è¿‡æ»¤åŒ…ï¼ˆæœ€å¸¸ç”¨ï¼‰
# - route:  æ”¹å˜è·¯ç”±å†³ç­–
# - nat:    NAT è½¬æ¢

# hook é’©å­ç‚¹
# - prerouting:  åŒ…åˆ°è¾¾åï¼Œè·¯ç”±å†³ç­–å‰
# - input:       å‘é€åˆ°æœ¬æœºçš„åŒ…
# - forward:     è½¬å‘çš„åŒ…
# - output:      æœ¬æœºäº§ç”Ÿçš„åŒ…
# - postrouting: åŒ…ç¦»å¼€å‰

# priority ä¼˜å…ˆçº§ï¼ˆæ•°å­—è¶Šå°è¶Šå…ˆæ‰§è¡Œï¼‰
# - filter é»˜è®¤ä½¿ç”¨ 0

# policy é»˜è®¤ç­–ç•¥
# - accept: é»˜è®¤æ”¾è¡Œï¼ˆä¸æ¨èï¼‰
# - drop:   é»˜è®¤ä¸¢å¼ƒï¼ˆæ¨èï¼‰
```

### 2.4 å®Œæ•´æ•°æ®åŒ…æµç¨‹

```
                                    æœ¬åœ°è¿›ç¨‹
                                       â–²
                                       â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                             â”‚                             â”‚
         â”‚                      â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”                      â”‚
         â”‚                      â”‚   INPUT     â”‚                      â”‚
         â”‚                      â”‚   chain     â”‚                      â”‚
         â”‚                      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                      â”‚
         â”‚                             â”‚                             â”‚
         â”‚                      â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”                      â”‚
         â”‚                      â”‚   Routing   â”‚                      â”‚
         â”‚                      â”‚   Decision  â”‚                      â”‚
         â”‚                      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                      â”‚
         â”‚                             â”‚                             â”‚
         â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
         â”‚     â”‚                       â”‚                       â”‚     â”‚
         â”‚     â–¼                       â”‚                       â–¼     â”‚
  â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  PREROUTING  â”‚              â”‚   FORWARD   â”‚         â”‚    OUTPUT      â”‚
  â”‚    chain     â”‚              â”‚    chain    â”‚         â”‚    chain       â”‚
  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                             â”‚                        â”‚
         â”‚                             â”‚                        â”‚
         â”‚                      â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”                 â”‚
         â”‚                      â”‚ POSTROUTING â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                      â”‚   chain     â”‚
         â”‚                      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
         â”‚                             â”‚
         â”‚                             â–¼
  â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                             ç½‘ç»œæ¥å£
```

<details>
<summary>View ASCII source</summary>

```
                                    æœ¬åœ°è¿›ç¨‹
                                       â–²
                                       â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                             â”‚                             â”‚
         â”‚                      â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”                      â”‚
         â”‚                      â”‚   INPUT     â”‚                      â”‚
         â”‚                      â”‚   chain     â”‚                      â”‚
         â”‚                      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                      â”‚
         â”‚                             â”‚                             â”‚
         â”‚                      â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”                      â”‚
         â”‚                      â”‚   Routing   â”‚                      â”‚
         â”‚                      â”‚   Decision  â”‚                      â”‚
         â”‚                      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                      â”‚
         â”‚                             â”‚                             â”‚
         â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
         â”‚     â”‚                       â”‚                       â”‚     â”‚
         â”‚     â–¼                       â”‚                       â–¼     â”‚
  â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  PREROUTING  â”‚              â”‚   FORWARD   â”‚         â”‚    OUTPUT      â”‚
  â”‚    chain     â”‚              â”‚    chain    â”‚         â”‚    chain       â”‚
  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                             â”‚                        â”‚
         â”‚                             â”‚                        â”‚
         â”‚                      â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”                 â”‚
         â”‚                      â”‚ POSTROUTING â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                      â”‚   chain     â”‚
         â”‚                      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
         â”‚                             â”‚
         â”‚                             â–¼
  â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                             ç½‘ç»œæ¥å£
```

</details>

---

## Step 3 - åŸºç¡€å‘½ä»¤ï¼ˆ20 åˆ†é’Ÿï¼‰

### 3.1 æŸ¥çœ‹è§„åˆ™

```bash
# æŸ¥çœ‹å®Œæ•´è§„åˆ™é›†
sudo nft list ruleset

# æŸ¥çœ‹ç‰¹å®šè¡¨
sudo nft list table inet filter

# æŸ¥çœ‹ç‰¹å®šé“¾
sudo nft list chain inet filter input

# å¸¦å¥æŸ„ï¼ˆhandleï¼‰æ˜¾ç¤ºï¼ˆç”¨äºåˆ é™¤è§„åˆ™ï¼‰
sudo nft -a list ruleset
```

### 3.2 æ·»åŠ è¡¨å’Œé“¾

```bash
# æ·»åŠ è¡¨ï¼ˆinet æ”¯æŒ IPv4 + IPv6ï¼‰
sudo nft add table inet filter

# æ·»åŠ é“¾ï¼ˆå¸¦ hook å’Œç­–ç•¥ï¼‰
sudo nft add chain inet filter input \
    '{ type filter hook input priority 0; policy drop; }'

sudo nft add chain inet filter output \
    '{ type filter hook output priority 0; policy accept; }'
```

### 3.3 æ·»åŠ è§„åˆ™

```bash
# æ”¾è¡Œå·²å»ºç«‹çš„è¿æ¥ï¼ˆå…³é”®è§„åˆ™ï¼ï¼‰
sudo nft add rule inet filter input ct state established,related accept

# æ”¾è¡Œæœ¬åœ°å›ç¯
sudo nft add rule inet filter input iif "lo" accept

# æ”¾è¡Œ SSHï¼ˆç«¯å£ 22ï¼‰
sudo nft add rule inet filter input tcp dport 22 accept

# æ”¾è¡Œ HTTP/HTTPS
sudo nft add rule inet filter input tcp dport { 80, 443 } accept

# æ”¾è¡Œ ICMPï¼ˆpingï¼‰
sudo nft add rule inet filter input ip protocol icmp accept
sudo nft add rule inet filter input ip6 nexthdr icmpv6 accept

# è®°å½•å¹¶ä¸¢å¼ƒå…¶ä»–æµé‡
sudo nft add rule inet filter input log prefix \"[nftables DROP] \" counter drop
```

### 3.4 åˆ é™¤è§„åˆ™

```bash
# é¦–å…ˆæŸ¥çœ‹è§„åˆ™å¥æŸ„
sudo nft -a list chain inet filter input
# è¾“å‡ºç¤ºä¾‹ï¼š
# chain input {
#     type filter hook input priority 0; policy drop;
#     ct state established,related accept # handle 4
#     tcp dport 22 accept # handle 5
#     tcp dport 8080 accept # handle 6   â† è¦åˆ é™¤è¿™æ¡
# }

# ä½¿ç”¨å¥æŸ„åˆ é™¤è§„åˆ™
sudo nft delete rule inet filter input handle 6

# æ¸…ç©ºæ•´ä¸ªé“¾
sudo nft flush chain inet filter input

# åˆ é™¤é“¾ï¼ˆå¿…é¡»å…ˆæ¸…ç©ºï¼‰
sudo nft delete chain inet filter input

# åˆ é™¤è¡¨
sudo nft delete table inet filter
```

### 3.5 æŒä¹…åŒ–è§„åˆ™

```bash
# å¯¼å‡ºå½“å‰è§„åˆ™åˆ°æ–‡ä»¶
sudo nft list ruleset > /etc/nftables.conf

# ä»æ–‡ä»¶åŠ è½½è§„åˆ™
sudo nft -f /etc/nftables.conf

# å¯ç”¨ nftables æœåŠ¡ï¼ˆå¼€æœºè‡ªåŠ¨åŠ è½½ï¼‰
sudo systemctl enable nftables

# é‡æ–°åŠ è½½é…ç½®
sudo systemctl reload nftables
```

---

## Step 4 - æ ¸å¿ƒæ¦‚å¿µï¼šè¿æ¥è·Ÿè¸ª ct stateï¼ˆ15 åˆ†é’Ÿï¼‰

### 4.1 ä¸ºä»€ä¹ˆ ct state å¦‚æ­¤é‡è¦ï¼Ÿ

```
æ²¡æœ‰è¿æ¥è·Ÿè¸ªçš„è§„åˆ™ï¼š

å®¢æˆ·ç«¯ â”€â”€â”€â”€ SYN â”€â”€â”€â”€> æœåŠ¡å™¨:22 (å…è®¸)
å®¢æˆ·ç«¯ <â”€â”€â”€ SYN+ACK â”€ æœåŠ¡å™¨:22 (éœ€è¦é¢å¤–è§„åˆ™!)
å®¢æˆ·ç«¯ â”€â”€â”€â”€ ACK â”€â”€â”€â”€> æœåŠ¡å™¨:22 (éœ€è¦é¢å¤–è§„åˆ™!)

é—®é¢˜ï¼šéœ€è¦ä¸ºæ¯ç§åŒ…ç±»å‹å†™è§„åˆ™ï¼Œå¤æ‚ä¸”å®¹æ˜“å‡ºé”™

æœ‰è¿æ¥è·Ÿè¸ªçš„è§„åˆ™ï¼š

å®¢æˆ·ç«¯ â”€â”€â”€â”€ SYN â”€â”€â”€â”€> æœåŠ¡å™¨:22 (å…è®¸ï¼Œåˆ›å»ºè¿æ¥è·Ÿè¸ª)
å®¢æˆ·ç«¯ <â”€â”€â”€ SYN+ACK â”€ æœåŠ¡å™¨:22 (establishedï¼Œè‡ªåŠ¨å…è®¸)
å®¢æˆ·ç«¯ â”€â”€â”€â”€ ACK â”€â”€â”€â”€> æœåŠ¡å™¨:22 (establishedï¼Œè‡ªåŠ¨å…è®¸)

ä¼˜åŠ¿ï¼šä¸€æ¡è§„åˆ™å¤„ç†æ‰€æœ‰ç›¸å…³æµé‡
```

### 4.2 è¿æ¥çŠ¶æ€è¯´æ˜

| çŠ¶æ€ | æè¿° | ç¤ºä¾‹ |
|------|------|------|
| `new` | æ–°è¿æ¥çš„ç¬¬ä¸€ä¸ªåŒ… | TCP SYN åŒ… |
| `established` | å·²å»ºç«‹è¿æ¥çš„åç»­åŒ… | æ•°æ®ä¼ è¾“ |
| `related` | ä¸å·²æœ‰è¿æ¥ç›¸å…³çš„æ–°è¿æ¥ | FTP æ•°æ®è¿æ¥ |
| `invalid` | ä¸å±äºä»»ä½•å·²çŸ¥è¿æ¥ | åº”è¯¥ä¸¢å¼ƒ |
| `untracked` | ä¸è¢«è·Ÿè¸ªçš„åŒ… | ç‰¹æ®Šåœºæ™¯ |

### 4.3 æ­£ç¡®çš„è§„åˆ™é¡ºåº

```bash
# æ ‡å‡†å®‰å…¨è§„åˆ™é¡ºåºï¼ˆå¾ˆé‡è¦ï¼ï¼‰

# 1. é¦–å…ˆå¤„ç†å·²å»ºç«‹çš„è¿æ¥ï¼ˆé«˜é¢‘æµé‡ï¼Œå¿«é€Ÿæ”¾è¡Œï¼‰
ct state established,related accept

# 2. ä¸¢å¼ƒæ— æ•ˆåŒ…
ct state invalid drop

# 3. æ”¾è¡Œæœ¬åœ°å›ç¯
iif "lo" accept

# 4. æ”¾è¡Œç‰¹å®šç«¯å£çš„æ–°è¿æ¥
tcp dport 22 ct state new accept
tcp dport { 80, 443 } ct state new accept

# 5. å¯é€‰ï¼šICMP
ip protocol icmp accept

# 6. æœ€åï¼šé»˜è®¤æ‹’ç»ï¼ˆé€šè¿‡ policy drop å®ç°ï¼‰
```

### 4.4 åæ¨¡å¼ï¼šæ— çŠ¶æ€è§„åˆ™

```bash
# é”™è¯¯ï¼šæ— çŠ¶æ€è§„åˆ™ï¼ˆä¸æ¨èï¼ï¼‰
sudo nft add rule inet filter input tcp dport 22 accept

# é—®é¢˜ï¼š
# 1. æ— æ³•åŒºåˆ†æ–°è¿æ¥å’Œå·²æœ‰è¿æ¥
# 2. å¯èƒ½å…è®¸æ¶æ„æ„é€ çš„åŒ…
# 3. æ— æ³•æ­£ç¡®å¤„ç† FTPã€SIP ç­‰å¤æ‚åè®®

# æ­£ç¡®ï¼šä½¿ç”¨è¿æ¥è·Ÿè¸ª
sudo nft add rule inet filter input ct state established,related accept
sudo nft add rule inet filter input tcp dport 22 ct state new accept
```

---

## Step 5 - ç”Ÿäº§çº§é˜²ç«å¢™é…ç½®ï¼ˆ30 åˆ†é’Ÿï¼‰

### 5.1 åˆ›å»ºé…ç½®æ–‡ä»¶

```bash
# å¤‡ä»½ç°æœ‰é…ç½®
sudo cp /etc/nftables.conf /etc/nftables.conf.bak.$(date +%Y%m%d)

# åˆ›å»ºç”Ÿäº§çº§é…ç½®
sudo tee /etc/nftables.conf << 'EOF'
#!/usr/sbin/nft -f
# =============================================================================
# nftables Production Configuration
# Created: 2025-01-04
# Reference: CIS Benchmark, RHEL Best Practices
# =============================================================================

# æ¸…ç©ºç°æœ‰è§„åˆ™
flush ruleset

# =============================================================================
# Table: inet filter (IPv4 + IPv6)
# =============================================================================
table inet filter {

    # -------------------------------------------------------------------------
    # Chain: input - å…¥ç«™æµé‡æ§åˆ¶
    # -------------------------------------------------------------------------
    chain input {
        type filter hook input priority 0; policy drop;

        # çŠ¶æ€è·Ÿè¸ªï¼ˆæ ¸å¿ƒè§„åˆ™ï¼ï¼‰
        ct state established,related accept comment "Allow established/related"
        ct state invalid drop comment "Drop invalid packets"

        # æœ¬åœ°å›ç¯
        iif "lo" accept comment "Allow loopback"

        # SSHï¼ˆé™åˆ¶ IP ç™½åå•ï¼‰
        # ç”Ÿäº§ç¯å¢ƒåº”ä¿®æ”¹ä¸ºå®é™…çš„ç®¡ç† IP
        ip saddr { 10.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16 } tcp dport 22 accept comment "SSH from private networks"

        # Web æœåŠ¡
        tcp dport { 80, 443 } accept comment "HTTP/HTTPS"

        # ICMPï¼ˆé™åˆ¶ç±»å‹å’Œé€Ÿç‡ï¼‰
        ip protocol icmp icmp type { echo-request, echo-reply, destination-unreachable } limit rate 10/second accept comment "ICMP rate limited"
        ip6 nexthdr icmpv6 icmpv6 type { echo-request, echo-reply, nd-neighbor-solicit, nd-neighbor-advert } accept comment "ICMPv6 essential"

        # æ—¥å¿—å¹¶ä¸¢å¼ƒå…¶ä»–æµé‡
        log prefix "[nftables DROP] " counter drop comment "Log and drop other traffic"
    }

    # -------------------------------------------------------------------------
    # Chain: forward - è½¬å‘æµé‡æ§åˆ¶ï¼ˆé»˜è®¤ç¦ç”¨ï¼‰
    # -------------------------------------------------------------------------
    chain forward {
        type filter hook forward priority 0; policy drop;

        # å¦‚æœæ˜¯è·¯ç”±å™¨/ç½‘å…³ï¼Œåœ¨æ­¤æ·»åŠ è§„åˆ™
        # ct state established,related accept
        # ...
    }

    # -------------------------------------------------------------------------
    # Chain: output - å‡ºç«™æµé‡æ§åˆ¶
    # -------------------------------------------------------------------------
    chain output {
        type filter hook output priority 0; policy accept;

        # å¤§å¤šæ•°åœºæ™¯ä¸é™åˆ¶å‡ºç«™æµé‡
        # é«˜å®‰å…¨ç¯å¢ƒå¯ä»¥é™åˆ¶ï¼š
        # ct state established,related accept
        # tcp dport { 53, 80, 443 } accept
        # udp dport 53 accept
        # drop
    }
}

# =============================================================================
# å¯é€‰ï¼šè‡ªå®šä¹‰ setsï¼ˆIP ç™½åå•ï¼‰
# =============================================================================
# table inet filter {
#     set trusted_ips {
#         type ipv4_addr
#         flags interval
#         elements = { 10.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16 }
#     }
#
#     chain input {
#         ...
#         ip saddr @trusted_ips tcp dport 22 accept
#     }
# }
EOF
```

### 5.2 é…ç½®éªŒè¯ï¼ˆå…³é”®æ­¥éª¤ï¼ï¼‰

> **è¿™æ˜¯æœ¬è¯¾æœ€é‡è¦çš„æŠ€èƒ½ï¼šåœ¨åº”ç”¨é…ç½®ä¹‹å‰éªŒè¯è¯­æ³•ã€‚**  

```bash
# éªŒè¯é…ç½®è¯­æ³•ï¼ˆ-c = checkï¼Œ-f = fileï¼‰
sudo nft -c -f /etc/nftables.conf

# å¦‚æœæœ‰é”™è¯¯ä¼šæ˜¾ç¤ºï¼š
# /etc/nftables.conf:25:9-15: Error: syntax error, unexpected string
#         invalid rule here
#         ^^^^^^^

# å¦‚æœæ²¡æœ‰è¾“å‡º = é…ç½®æ­£ç¡®
echo "Configuration syntax is valid!"

# éªŒè¯ååº”ç”¨é…ç½®
sudo nft -f /etc/nftables.conf

# éªŒè¯åº”ç”¨ç»“æœ
sudo nft list ruleset | head -30
```

### 5.3 å®‰å…¨åº”ç”¨æµç¨‹

> **é»„é‡‘æ³•åˆ™**ï¼šä¿®æ”¹é˜²ç«å¢™é…ç½®æ—¶ï¼Œ**æ°¸è¿œä¿æŒå½“å‰ SSH ä¼šè¯æ‰“å¼€**ï¼  

```bash
# 1. åœ¨å½“å‰ç»ˆç«¯æ‰§è¡Œï¼Œä½†ä¸è¦å…³é—­è¿™ä¸ªç»ˆç«¯ï¼
sudo nft -c -f /etc/nftables.conf
sudo nft -f /etc/nftables.conf

# 2. æ‰“å¼€æ–°ç»ˆç«¯æµ‹è¯•è¿æ¥
# ssh user@server
# å¦‚æœæ–°è¿æ¥æˆåŠŸï¼Œæ‰å…³é—­æ—§ç»ˆç«¯

# 3. å¦‚æœå‡ºé—®é¢˜ï¼Œåœ¨æ—§ç»ˆç«¯æ¢å¤ï¼š
sudo nft flush ruleset
# æˆ–
sudo nft -f /etc/nftables.conf.bak.*

# 4. å¯ç”¨æœåŠ¡æŒä¹…åŒ–
sudo systemctl enable nftables
sudo systemctl reload nftables
```

### 5.4 è®¾ç½®è‡ªåŠ¨æ¢å¤ï¼ˆå¯é€‰ï¼Œæ¿€è¿›åšæ³•ï¼‰

```bash
# æµ‹è¯•ç¯å¢ƒï¼šæ¯ 5 åˆ†é’Ÿè‡ªåŠ¨æ¢å¤é˜²ç«å¢™è§„åˆ™
(crontab -l 2>/dev/null; echo "*/5 * * * * /usr/sbin/nft -f /etc/nftables.conf.safe") | crontab -

# æµ‹è¯•å®Œæˆåç§»é™¤
crontab -l | grep -v nftables.conf.safe | crontab -
```

---

## Step 6 - å¸¸è§è§„åˆ™ç¤ºä¾‹ï¼ˆ20 åˆ†é’Ÿï¼‰

### 6.1 IP ç™½åå•

```bash
# æ–¹æ³• 1ï¼šç›´æ¥åœ¨è§„åˆ™ä¸­
sudo nft add rule inet filter input ip saddr { 10.0.0.1, 10.0.0.2, 10.0.0.3 } accept

# æ–¹æ³• 2ï¼šä½¿ç”¨ setï¼ˆæ¨èï¼Œæ˜“äºç®¡ç†ï¼‰
sudo nft add table inet filter
sudo nft add set inet filter trusted_ips '{ type ipv4_addr; flags interval; }'
sudo nft add element inet filter trusted_ips '{ 10.0.0.0/8, 192.168.1.0/24 }'
sudo nft add rule inet filter input ip saddr @trusted_ips accept

# åŠ¨æ€ç®¡ç† set
sudo nft add element inet filter trusted_ips '{ 203.0.113.50 }'
sudo nft delete element inet filter trusted_ips '{ 203.0.113.50 }'
```

### 6.2 ç«¯å£èŒƒå›´

```bash
# å•ä¸ªç«¯å£
tcp dport 22 accept

# å¤šä¸ªç«¯å£
tcp dport { 22, 80, 443, 8080 } accept

# ç«¯å£èŒƒå›´
tcp dport 3000-3100 accept

# UDP ç«¯å£
udp dport 53 accept
```

### 6.3 é€Ÿç‡é™åˆ¶

```bash
# é™åˆ¶ SSH è¿æ¥é€Ÿç‡ï¼ˆé˜²æš´åŠ›ç ´è§£ï¼‰
tcp dport 22 ct state new limit rate 3/minute accept

# é™åˆ¶ ICMPï¼ˆé˜² ping floodï¼‰
ip protocol icmp limit rate 10/second accept

# æ›´å¤æ‚çš„é€Ÿç‡é™åˆ¶
tcp dport 22 meter ssh-meter { ip saddr limit rate 3/minute burst 5 packets } accept
```

### 6.4 æ—¥å¿—è®°å½•

```bash
# åŸºæœ¬æ—¥å¿—
log prefix "[nftables] " drop

# å¸¦é€Ÿç‡é™åˆ¶çš„æ—¥å¿—ï¼ˆé˜²æ­¢æ—¥å¿—æ´ªæ°´ï¼‰
log prefix "[nftables DROP] " limit rate 3/minute drop

# æ—¥å¿—ç»„ï¼ˆä¾›å…¶ä»–å·¥å…·å¤„ç†ï¼‰
log prefix "[nftables] " group 0 drop

# æŸ¥çœ‹æ—¥å¿—
sudo journalctl -k | grep nftables
# æˆ–
sudo dmesg | grep nftables
```

### 6.5 é«˜çº§åŒ¹é…

```bash
# åŒ¹é…ç½‘ç»œæ¥å£
iif "eth0" tcp dport 80 accept
oif "eth1" accept

# åŒ¹é…æº/ç›®æ ‡åœ°å€
ip saddr 192.168.1.0/24 ip daddr 10.0.0.1 accept

# åŒ¹é… TCP æ ‡å¿—
tcp flags syn tcp dport 80 accept

# åŒ¹é…æ—¶é—´ï¼ˆéœ€è¦ nftables 0.9.4+ï¼‰
# meta hour >= 09:00 meta hour < 18:00 accept
```

---

## Step 7 - iptables è¿ç§»ï¼ˆ20 åˆ†é’Ÿï¼‰

### 7.1 ä½¿ç”¨ iptables-translate

```bash
# å®‰è£…ç¿»è¯‘å·¥å…·ï¼ˆå¦‚æœæ²¡æœ‰ï¼‰
# RHEL/CentOS: dnf install iptables-nft
# Debian/Ubuntu: apt install iptables-nft

# ç¿»è¯‘å•æ¡è§„åˆ™
iptables-translate -A INPUT -p tcp --dport 22 -j ACCEPT
# è¾“å‡º: nft add rule ip filter INPUT tcp dport 22 counter accept

# ç¿»è¯‘æ•´ä¸ªè§„åˆ™é›†
iptables-save > iptables-rules.txt
iptables-restore-translate < iptables-rules.txt > nftables-rules.nft

# éªŒè¯ç¿»è¯‘ç»“æœ
cat nftables-rules.nft
```

### 7.2 ç¿»è¯‘ç¤ºä¾‹

åŸ iptables è§„åˆ™ï¼š

```bash
# iptables-rules.txt
*filter
:INPUT DROP [0:0]
:FORWARD DROP [0:0]
:OUTPUT ACCEPT [0:0]
-A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
-A INPUT -i lo -j ACCEPT
-A INPUT -p tcp --dport 22 -j ACCEPT
-A INPUT -p tcp -m multiport --dports 80,443 -j ACCEPT
-A INPUT -p icmp -j ACCEPT
-A INPUT -j LOG --log-prefix "[iptables DROP] "
COMMIT
```

ç¿»è¯‘åçš„ nftables è§„åˆ™ï¼š

```bash
# nftables-rules.nft
table ip filter {
    chain INPUT {
        type filter hook input priority 0; policy drop;
        ct state established,related counter accept
        iif "lo" counter accept
        tcp dport 22 counter accept
        tcp dport { 80, 443 } counter accept
        ip protocol icmp counter accept
        counter log prefix "[iptables DROP] "
    }

    chain FORWARD {
        type filter hook forward priority 0; policy drop;
    }

    chain OUTPUT {
        type filter hook output priority 0; policy accept;
    }
}
```

### 7.3 è¿ç§»æ£€æŸ¥æ¸…å•

```bash
# 1. å¯¼å‡ºç°æœ‰ iptables è§„åˆ™
iptables-save > /tmp/iptables-backup.txt
ip6tables-save > /tmp/ip6tables-backup.txt

# 2. ç¿»è¯‘è§„åˆ™
iptables-restore-translate < /tmp/iptables-backup.txt > /tmp/nft-rules.nft

# 3. éªŒè¯ç¿»è¯‘ç»“æœ
sudo nft -c -f /tmp/nft-rules.nft

# 4. åº”ç”¨æ–°è§„åˆ™ï¼ˆä¿æŒæ—§ä¼šè¯ï¼ï¼‰
sudo nft -f /tmp/nft-rules.nft

# 5. æµ‹è¯•è¿æ¥

# 6. ç¦ç”¨ iptables æœåŠ¡
sudo systemctl disable iptables
sudo systemctl disable ip6tables

# 7. å¯ç”¨ nftables æœåŠ¡
sudo systemctl enable nftables
```

### 7.4 åŒæ ˆå…±å­˜é—®é¢˜

```bash
# æ£€æŸ¥å½“å‰åç«¯
# RHEL 9 é»˜è®¤ä½¿ç”¨ nftables åç«¯
iptables -V
# è¾“å‡º: iptables v1.8.x (nf_tables)  â† è¯´æ˜ä½¿ç”¨ nftables åç«¯

# å¦‚æœæ˜¾ç¤º "legacy"ï¼Œå»ºè®®åˆ‡æ¢
# update-alternatives --set iptables /usr/sbin/iptables-nft
```

---

## Step 8 - firewalld å¯¹æ¯”ï¼ˆ10 åˆ†é’Ÿï¼‰

### 8.1 firewalld ä¸ nftables çš„å…³ç³»

```
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚  firewalld  â”‚  â† é«˜å±‚ API
           â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚  nftables   â”‚  â† åº•å±‚åç«¯ï¼ˆRHEL 9+ï¼‰
           â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚   Netfilter â”‚  â† å†…æ ¸
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 8.2 ä½•æ—¶ä½¿ç”¨å“ªä¸ªï¼Ÿ

| åœºæ™¯ | æ¨è | åŸå›  |
|------|------|------|
| æ¡Œé¢/ç®€å•æœåŠ¡å™¨ | firewalld | Zone æ¦‚å¿µæ˜“æ‡‚ |
| å¤æ‚è§„åˆ™/é«˜æ€§èƒ½ | nftables | æ›´ç²¾ç»†æ§åˆ¶ |
| å®¹å™¨/Kubernetes | nftables | ç›´æ¥æ§åˆ¶ |
| æ—§ç³»ç»Ÿç»´æŠ¤ | iptables | å…¼å®¹æ€§ |
| æ–°ç³»ç»Ÿéƒ¨ç½² | nftables | ç°ä»£æ ‡å‡† |

### 8.3 firewalld åŸºç¡€å‘½ä»¤

```bash
# æŸ¥çœ‹çŠ¶æ€
sudo firewall-cmd --state
sudo firewall-cmd --list-all

# å¼€æ”¾ç«¯å£
sudo firewall-cmd --add-port=80/tcp --permanent
sudo firewall-cmd --add-service=https --permanent
sudo firewall-cmd --reload

# æŸ¥çœ‹åº•å±‚ nftables è§„åˆ™
sudo nft list ruleset | grep -A10 "firewalld"
```

### 8.4 æ³¨æ„ï¼šä¸è¦æ··ç”¨ï¼

```bash
# è­¦å‘Šï¼šfirewalld å’Œç›´æ¥ nftables è§„åˆ™å¯èƒ½å†²çª

# å¦‚æœä½¿ç”¨ firewalldï¼Œè®©å®ƒç®¡ç†æ‰€æœ‰è§„åˆ™
# ä¸è¦åŒæ—¶æ‰‹åŠ¨æ·»åŠ  nftables è§„åˆ™

# å¦‚æœä½¿ç”¨çº¯ nftablesï¼Œç¦ç”¨ firewalld
sudo systemctl disable --now firewalld
sudo systemctl enable --now nftables
```

---

## åæ¨¡å¼ï¼šå¸¸è§é”™è¯¯

### é”™è¯¯ 1ï¼š0.0.0.0/0 å¼€æ”¾ç®¡ç†ç«¯å£

```bash
# å±é™©ï¼å…è®¸ä»»ä½• IP è®¿é—® SSH
tcp dport 22 accept

# æ­£ç¡®ï¼šé™åˆ¶æ¥æº IP
ip saddr { 10.0.0.0/8, 192.168.0.0/16 } tcp dport 22 accept

# æˆ–ä½¿ç”¨ IP ç™½åå• set
ip saddr @trusted_ips tcp dport 22 accept
```

### é”™è¯¯ 2ï¼šæ— çŠ¶æ€è§„åˆ™

```bash
# é”™è¯¯ï¼šæ²¡æœ‰è¿æ¥è·Ÿè¸ª
tcp dport 80 accept

# æ­£ç¡®ï¼šä½¿ç”¨ ct state
ct state established,related accept
tcp dport 80 ct state new accept
```

### é”™è¯¯ 3ï¼šä¿®æ”¹é…ç½®ä¸éªŒè¯å°±åº”ç”¨

```bash
# å±é™©ï¼å¯èƒ½é”æ­» SSH
sudo vim /etc/nftables.conf
sudo nft -f /etc/nftables.conf    # â† æ²¡æœ‰éªŒè¯

# æ­£ç¡®åšæ³•
sudo vim /etc/nftables.conf
sudo nft -c -f /etc/nftables.conf  # â† å…ˆéªŒè¯è¯­æ³•
sudo nft -f /etc/nftables.conf     # â† å†åº”ç”¨
```

### é”™è¯¯ 4ï¼šå¿˜è®°æŒä¹…åŒ–

```bash
# è§„åˆ™åªåœ¨å†…å­˜ä¸­ï¼Œé‡å¯åä¸¢å¤±
sudo nft add rule inet filter input tcp dport 80 accept

# æ­£ç¡®ï¼šä¿å­˜åˆ°æ–‡ä»¶
sudo nft list ruleset > /etc/nftables.conf
sudo systemctl enable nftables
```

### é”™è¯¯ 5ï¼šæ—¥å¿—æ´ªæ°´

```bash
# å±é™©ï¼šæ¯ä¸ªä¸¢å¼ƒçš„åŒ…éƒ½è®°å½•ï¼Œå¯èƒ½å¡«æ»¡ç£ç›˜
log prefix "[DROP] " drop

# æ­£ç¡®ï¼šé™åˆ¶æ—¥å¿—é€Ÿç‡
log prefix "[DROP] " limit rate 3/minute drop
```

---

## èŒåœºå°è´´å£«ï¼ˆJapan IT Contextï¼‰

### é˜²ç«å¢™ç®¡ç†åœ¨æ—¥æœ¬ä¼ä¸š

| æ—¥è¯­æœ¯è¯­ | å«ä¹‰ | æŠ€æœ¯å®ç° |
|----------|------|----------|
| ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ« | é˜²ç«å¢™ | nftables/firewalld |
| æ¥ç¶šè¨±å¯ | è¿æ¥è®¸å¯ | accept è§„åˆ™ |
| æ¥ç¶šæ‹’å¦ | è¿æ¥æ‹’ç» | drop/reject è§„åˆ™ |
| ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ | è®¿é—®æ§åˆ¶ | IP ç™½åå• |
| ãƒãƒ¼ãƒˆé–‹æ”¾ | ç«¯å£å¼€æ”¾ | dport è§„åˆ™ |
| å¤‰æ›´ç®¡ç† | å˜æ›´ç®¡ç† | é…ç½®å¤‡ä»½ã€å®¡æ‰¹æµç¨‹ |

### æ—¥æœ¬ä¼ä¸šé˜²ç«å¢™ç®¡ç†å¸¸è§é—®é¢˜

1. **å¤‰æ›´ç®¡ç†ä¸è¶³**ï¼šè§„åˆ™å˜æ›´æ²¡æœ‰è®°å½•
   - è§£å†³ï¼šä½¿ç”¨ Git ç®¡ç†é…ç½®æ–‡ä»¶ + å˜æ›´å®¡æ‰¹

2. **ãƒ†ã‚¹ãƒˆç’°å¢ƒãŒãªã„**ï¼šç›´æ¥åœ¨ç”Ÿäº§ç¯å¢ƒæµ‹è¯•
   - è§£å†³ï¼šå…ˆåœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯è§„åˆ™

3. **å…¨é–‹æ”¾çŠ¶æ…‹**ï¼šå®‰å…¨æ„è¯†ä¸è¶³ï¼Œè§„åˆ™è¿‡äºå®½æ¾
   - è§£å†³ï¼šæœ€å°æƒé™åŸåˆ™ï¼Œå®šæœŸå®¡è®¡è§„åˆ™

### é˜²ç«å¢™å˜æ›´ç”³è¯·æ¨¡æ¿

```markdown
## ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«å¤‰æ›´ç”³è«‹æ›¸

### ç”³è«‹æ—¥: 20XXå¹´XXæœˆXXæ—¥
### ç”³è«‹è€…: ç”°ä¸­å¤ªéƒ
### å¯¾è±¡ã‚µãƒ¼ãƒãƒ¼: production-web-01

### å¤‰æ›´å†…å®¹
| é …ç›® | ç¾åœ¨ | å¤‰æ›´å¾Œ |
|------|------|--------|
| ãƒãƒ¼ãƒˆ 8080 | æ‹’å¦ | è¨±å¯ï¼ˆå†…éƒ¨ IP ã®ã¿ï¼‰ |

### å¤‰æ›´ç†ç”±
æ–°è¦ API ã‚µãƒ¼ãƒ“ã‚¹ã®å°å…¥ã«ä¼´ã„ã€å†…éƒ¨ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‹ã‚‰ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚

### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å½±éŸ¿è©•ä¾¡
- å¤–éƒ¨ã‚¢ã‚¯ã‚»ã‚¹: å½±éŸ¿ãªã—ï¼ˆå†…éƒ¨ IP ã®ã¿è¨±å¯ï¼‰
- æ—¢å­˜ã‚µãƒ¼ãƒ“ã‚¹: å½±éŸ¿ãªã—

### ãƒ†ã‚¹ãƒˆè¨ˆç”»
1. ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒã§ãƒ«ãƒ¼ãƒ«ç¢ºèª
2. æœ¬ç•ªç’°å¢ƒé©ç”¨å¾Œã€æ¥ç¶šãƒ†ã‚¹ãƒˆ

### æ‰¿èª
- [ ] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ‹…å½“: _________
- [ ] ã‚¤ãƒ³ãƒ•ãƒ©æ‹…å½“: _________
- [ ] ä¸Šé•·: _________
```

---

## æ£€æŸ¥æ¸…å•

å®Œæˆæœ¬è¯¾åï¼Œä½ åº”è¯¥èƒ½å¤Ÿï¼š

- [ ] è§£é‡Š nftables å–ä»£ iptables çš„åŸå› ï¼ˆç»Ÿä¸€æ¡†æ¶ã€åŸå­æ›´æ–°ã€æ›´æ¸…æ™°è¯­æ³•ï¼‰
- [ ] ä½¿ç”¨ `nft list ruleset` æŸ¥çœ‹å½“å‰è§„åˆ™
- [ ] åˆ›å»ºè¡¨ã€é“¾ã€è§„åˆ™
- [ ] ç†è§£ ct state è¿æ¥è·Ÿè¸ªçš„é‡è¦æ€§
- [ ] é…ç½® SSH IP ç™½åå•è§„åˆ™
- [ ] **ä½¿ç”¨ `nft -c -f` éªŒè¯é…ç½®è¯­æ³•**
- [ ] ä½¿ç”¨ `iptables-translate` è¿ç§»æ—§è§„åˆ™
- [ ] ç†è§£ firewalld å’Œ nftables çš„å…³ç³»
- [ ] å®‰å…¨åœ°åº”ç”¨é˜²ç«å¢™å˜æ›´ï¼ˆä¿æŒæ—§ä¼šè¯ã€éªŒè¯ååº”ç”¨ï¼‰

---

## æœ¬è¯¾å°ç»“

| æ¦‚å¿µ | å‘½ä»¤/é…ç½® | è®°å¿†ç‚¹ |
|------|-----------|--------|
| æŸ¥çœ‹è§„åˆ™ | `nft list ruleset` | åŒ…å«æ‰€æœ‰è¡¨ã€é“¾ã€è§„åˆ™ |
| éªŒè¯é…ç½® | `nft -c -f file.conf` | **å¿…é¡»åœ¨åº”ç”¨å‰æ‰§è¡Œï¼** |
| åº”ç”¨é…ç½® | `nft -f file.conf` | ä¿æŒæ—§ä¼šè¯æ‰“å¼€ |
| è¿æ¥è·Ÿè¸ª | `ct state established,related` | æ ¸å¿ƒå®‰å…¨è§„åˆ™ |
| IP ç™½åå• | `ip saddr @set_name accept` | ä½¿ç”¨ set ä¾¿äºç®¡ç† |
| æŒä¹…åŒ– | `/etc/nftables.conf` + `systemctl enable` | é‡å¯ä¸ä¸¢å¤± |
| è¿ç§» | `iptables-translate` | è‡ªåŠ¨ç¿»è¯‘è§„åˆ™ |

**é»„é‡‘æ³•åˆ™**ï¼š

```
éªŒè¯å‰ä¸åº”ç”¨ â†’ ct state æ˜¯æ ¸å¿ƒ â†’ IP ç™½åå•é™åˆ¶ç®¡ç†ç«¯å£ â†’ ä¿æŒåé—¨ä¼šè¯
```

---

## å»¶ä¼¸é˜…è¯»

- [nftables Wiki](https://wiki.nftables.org/) - å®˜æ–¹æ–‡æ¡£å’Œç¤ºä¾‹
- [Red Hat nftables Guide](https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/9/html/configuring_firewalls_and_packet_filters/) - RHEL 9 å®˜æ–¹æŒ‡å—
- [Netfilter Project](https://netfilter.org/) - å†…æ ¸é˜²ç«å¢™é¡¹ç›®
- [CIS Benchmark for Linux](https://www.cisecurity.org/benchmark/red_hat_linux) - åˆè§„åŸºçº¿
- ç›¸å…³è¯¾ç¨‹ï¼š[Lesson 02 - SSH åŠ å›º](../02-ssh-hardening/) - é˜²ç«å¢™é…åˆ SSH å®‰å…¨
- ç›¸å…³è¯¾ç¨‹ï¼š[Lesson 07 - auditd å®¡è®¡](../07-auditd/) - è®°å½•é˜²ç«å¢™å˜æ›´

---

## ç³»åˆ—å¯¼èˆª

[ä¸Šä¸€è¯¾ï¼š07 - auditd å®¡è®¡ç³»ç»Ÿ](../07-auditd/) | [ç³»åˆ—é¦–é¡µ](../) | [ä¸‹ä¸€è¯¾ï¼š09 - PAM é«˜çº§é…ç½® ->](../09-pam-advanced/)
