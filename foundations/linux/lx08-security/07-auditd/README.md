# 07 - auditd å®¡è®¡ç³»ç»Ÿ / Linux Audit System

> **ç›®æ ‡**ï¼šæŒæ¡ Linux å®¡è®¡ç³»ç»Ÿï¼Œå®ç°å…³é”®æ–‡ä»¶ç›‘æ§ã€ç”¨æˆ·è¡Œä¸ºè¿½è¸ªã€äº‹æ•…è°ƒæŸ¥è¯æ®æ”¶é›†  
> **å‰ç½®**ï¼šå®Œæˆ Lesson 01-06ï¼ˆå®‰å…¨åŸåˆ™ã€SSHã€SELinuxã€Capabilitiesï¼‰  
> **æ—¶é—´**ï¼šâš¡ 45 åˆ†é’Ÿï¼ˆé€Ÿè¯»ï¼‰/ ğŸ”¬ 180 åˆ†é’Ÿï¼ˆå®Œæ•´å®æ“ï¼‰  
> **å®æˆ˜åœºæ™¯**ï¼šå¹½çµé…ç½®å˜æ›´è¿½è¸ªã€é»„é‡‘å‘¨å¼‚å¸¸è°ƒæŸ¥ã€éšè—æŒ–çŸ¿ç¨‹åºæ£€æµ‹  

---

## å°†å­¦åˆ°çš„å†…å®¹

1. ç†è§£ Linux å®¡è®¡ç³»ç»Ÿæ¶æ„ï¼ˆkernel audit, auditd, /var/log/auditï¼‰
2. é…ç½®å®¡è®¡è§„åˆ™ç›‘æ§å…³é”®æ–‡ä»¶å’Œæ“ä½œ
3. ä½¿ç”¨ ausearch å’Œ aureport åˆ†æå®¡è®¡æ—¥å¿—
4. **æ ¸å¿ƒæŠ€èƒ½**ï¼šé€šè¿‡ auid è¿½è¸ªåŸå§‹ç”¨æˆ·ï¼Œå³ä½¿ sudo å
5. æ£€æµ‹ Living off the Land (LOTL) æ”»å‡»
6. ä¸ºå®‰å…¨äº‹æ•…ç”Ÿæˆè°ƒæŸ¥æŠ¥å‘Šï¼ˆå ±å‘Šæ›¸ï¼‰

---

## å…ˆè·‘èµ·æ¥ï¼ï¼ˆ10 åˆ†é’Ÿï¼‰

> åœ¨å­¦ä¹ ç†è®ºä¹‹å‰ï¼Œå…ˆçœ‹çœ‹ä½ çš„ç³»ç»Ÿæ­£åœ¨è®°å½•ä»€ä¹ˆã€‚  

```bash
# æ£€æŸ¥ auditd æ˜¯å¦è¿è¡Œ
systemctl status auditd

# æŸ¥çœ‹å½“å‰å®¡è®¡è§„åˆ™
sudo auditctl -l

# æŸ¥çœ‹æœ€è¿‘çš„å®¡è®¡æ—¥å¿—ï¼ˆæœ€å 10 æ¡ï¼‰
sudo ausearch -m USER_LOGIN,USER_AUTH -ts recent --format text 2>/dev/null | tail -20

# å¿«é€Ÿä½“éªŒï¼šç›‘æ§ä¸€ä¸ªæ–‡ä»¶çš„è®¿é—®
sudo auditctl -w /etc/passwd -p war -k passwd_access
cat /etc/passwd > /dev/null
sudo ausearch -k passwd_access -ts recent --format text

# æ¸…ç†æµ‹è¯•è§„åˆ™
sudo auditctl -d -w /etc/passwd -p war -k passwd_access
```

**ä½ åˆšåˆšï¼š**

- æ£€æŸ¥äº†å®¡è®¡ç³»ç»Ÿæ˜¯å¦è¿è¡Œ
- æŸ¥çœ‹äº†å½“å‰æœ‰å“ªäº›å®¡è®¡è§„åˆ™
- ä¸´æ—¶æ·»åŠ äº†ä¸€ä¸ªæ–‡ä»¶ç›‘æ§è§„åˆ™
- è§¦å‘å¹¶æŸ¥çœ‹äº†å®¡è®¡äº‹ä»¶
- åˆ é™¤äº†ä¸´æ—¶è§„åˆ™

**ä¸ºä»€ä¹ˆè¿™å¾ˆé‡è¦ï¼Ÿ**

æƒ³è±¡è¿™ä¸ªåœºæ™¯ï¼šå‘¨ä¸€æ—©æ™¨ï¼Œä½ å‘ç°ç”Ÿäº§æœåŠ¡å™¨çš„ `/etc/ssh/sshd_config` è¢«ä¿®æ”¹äº†ï¼Œ`PermitRootLogin` ä» `no` å˜æˆäº† `yes`ã€‚å›¢é˜Ÿé‡Œæ²¡äººæ‰¿è®¤æ”¹è¿‡ã€‚**è°æ”¹çš„ï¼Ÿä»€ä¹ˆæ—¶å€™ï¼Ÿç”¨ä»€ä¹ˆå‘½ä»¤ï¼Ÿ**

æ²¡æœ‰ auditdï¼Œä½ åªèƒ½çŒœæµ‹ã€‚æœ‰äº† auditdï¼Œä½ å¯ä»¥ç²¾ç¡®è¿½è¸ªã€‚

---

## Step 1 - å®¡è®¡ç³»ç»Ÿæ¶æ„ï¼ˆ15 åˆ†é’Ÿï¼‰

### 1.1 Linux å®¡è®¡å­ç³»ç»Ÿæ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Linux Audit Architecture                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   ç”¨æˆ·ç©ºé—´                                                       â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                                                         â”‚   â”‚
â”‚   â”‚    auditctl          ausearch         aureport          â”‚   â”‚
â”‚   â”‚   (è§„åˆ™ç®¡ç†)        (æ—¥å¿—æœç´¢)       (æŠ¥å‘Šç”Ÿæˆ)           â”‚   â”‚
â”‚   â”‚        â”‚                â†‘                â†‘               â”‚   â”‚
â”‚   â”‚        â”‚                â”‚                â”‚               â”‚   â”‚
â”‚   â”‚        â†“                â”‚                â”‚               â”‚   â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚   â”‚   â”‚                    auditd                         â”‚  â”‚   â”‚
â”‚   â”‚   â”‚              (å®¡è®¡å®ˆæŠ¤è¿›ç¨‹)                        â”‚  â”‚   â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚   â”‚                         â”‚                                â”‚   â”‚
â”‚   â”‚                         â†“                                â”‚   â”‚
â”‚   â”‚               /var/log/audit/audit.log                   â”‚   â”‚
â”‚   â”‚                   (å®¡è®¡æ—¥å¿—æ–‡ä»¶)                          â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â†‘                                   â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
â”‚                              â”‚                                   â”‚
â”‚   å†…æ ¸ç©ºé—´                    â”‚ netlink socket                   â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚              Kernel Audit Subsystem                      â”‚   â”‚
â”‚   â”‚                                                          â”‚   â”‚
â”‚   â”‚   ç³»ç»Ÿè°ƒç”¨ â”€â†’ è§„åˆ™åŒ¹é… â”€â†’ ç”Ÿæˆå®¡è®¡äº‹ä»¶ â”€â†’ å‘é€åˆ°ç”¨æˆ·ç©ºé—´   â”‚   â”‚
â”‚   â”‚                                                          â”‚   â”‚
â”‚   â”‚   ç›‘æ§ç‚¹ï¼š                                                â”‚   â”‚
â”‚   â”‚   - ç³»ç»Ÿè°ƒç”¨ (execve, open, chmod, ...)                  â”‚   â”‚
â”‚   â”‚   - æ–‡ä»¶è®¿é—®                                              â”‚   â”‚
â”‚   â”‚   - ç”¨æˆ·è®¤è¯                                              â”‚   â”‚
â”‚   â”‚   - ç½‘ç»œè¿æ¥                                              â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

<details>
<summary>View ASCII source</summary>

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Linux Audit Architecture                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   ç”¨æˆ·ç©ºé—´                                                       â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                                                         â”‚   â”‚
â”‚   â”‚    auditctl          ausearch         aureport          â”‚   â”‚
â”‚   â”‚   (è§„åˆ™ç®¡ç†)        (æ—¥å¿—æœç´¢)       (æŠ¥å‘Šç”Ÿæˆ)           â”‚   â”‚
â”‚   â”‚        â”‚                â†‘                â†‘               â”‚   â”‚
â”‚   â”‚        â”‚                â”‚                â”‚               â”‚   â”‚
â”‚   â”‚        â†“                â”‚                â”‚               â”‚   â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚   â”‚   â”‚                    auditd                         â”‚  â”‚   â”‚
â”‚   â”‚   â”‚              (å®¡è®¡å®ˆæŠ¤è¿›ç¨‹)                        â”‚  â”‚   â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚   â”‚                         â”‚                                â”‚   â”‚
â”‚   â”‚                         â†“                                â”‚   â”‚
â”‚   â”‚               /var/log/audit/audit.log                   â”‚   â”‚
â”‚   â”‚                   (å®¡è®¡æ—¥å¿—æ–‡ä»¶)                          â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â†‘                                   â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
â”‚                              â”‚                                   â”‚
â”‚   å†…æ ¸ç©ºé—´                    â”‚ netlink socket                   â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚              Kernel Audit Subsystem                      â”‚   â”‚
â”‚   â”‚                                                          â”‚   â”‚
â”‚   â”‚   ç³»ç»Ÿè°ƒç”¨ â”€â†’ è§„åˆ™åŒ¹é… â”€â†’ ç”Ÿæˆå®¡è®¡äº‹ä»¶ â”€â†’ å‘é€åˆ°ç”¨æˆ·ç©ºé—´   â”‚   â”‚
â”‚   â”‚                                                          â”‚   â”‚
â”‚   â”‚   ç›‘æ§ç‚¹ï¼š                                                â”‚   â”‚
â”‚   â”‚   - ç³»ç»Ÿè°ƒç”¨ (execve, open, chmod, ...)                  â”‚   â”‚
â”‚   â”‚   - æ–‡ä»¶è®¿é—®                                              â”‚   â”‚
â”‚   â”‚   - ç”¨æˆ·è®¤è¯                                              â”‚   â”‚
â”‚   â”‚   - ç½‘ç»œè¿æ¥                                              â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

</details>

### 1.2 æ ¸å¿ƒç»„ä»¶

| ç»„ä»¶ | ä½œç”¨ | æ–‡ä»¶/å‘½ä»¤ |
|------|------|-----------|
| Kernel Audit | å†…æ ¸çº§äº‹ä»¶æ•è· | å†…ç½®äº Linux å†…æ ¸ |
| auditd | å®¡è®¡å®ˆæŠ¤è¿›ç¨‹ | `/usr/sbin/auditd` |
| auditctl | è§„åˆ™ç®¡ç† | `auditctl -l`, `auditctl -w` |
| ausearch | æ—¥å¿—æœç´¢ | `ausearch -k`, `ausearch -ts` |
| aureport | æŠ¥å‘Šç”Ÿæˆ | `aureport --login`, `aureport --file` |
| audit.log | å®¡è®¡æ—¥å¿— | `/var/log/audit/audit.log` |

### 1.3 å®¡è®¡æ—¥å¿—ä½ç½®

```bash
# ä¸»æ—¥å¿—æ–‡ä»¶
ls -la /var/log/audit/

# å…¸å‹è¾“å‡ºï¼š
# -rw------- 1 root root 8388608 Jan 04 10:00 audit.log
# -rw------- 1 root root 8388608 Jan 03 00:00 audit.log.1
# -rw------- 1 root root 8388608 Jan 02 00:00 audit.log.2

# æŸ¥çœ‹æ—¥å¿—è½®è½¬é…ç½®
cat /etc/audit/auditd.conf | grep -E "log_file|max_log_file|num_logs"
```

### 1.4 auditd é…ç½®æ–‡ä»¶

```bash
# ä¸»é…ç½®æ–‡ä»¶
sudo cat /etc/audit/auditd.conf

# å…³é”®é…ç½®é¡¹ï¼š
# log_file = /var/log/audit/audit.log    # æ—¥å¿—ä½ç½®
# max_log_file = 8                        # å•ä¸ªæ—¥å¿—æœ€å¤§ MB
# num_logs = 5                            # ä¿ç•™æ—¥å¿—æ•°é‡
# max_log_file_action = ROTATE            # è¾¾åˆ°ä¸Šé™æ—¶è½®è½¬
# space_left_action = SYSLOG              # ç£ç›˜ç©ºé—´ä¸è¶³æ—¶åŠ¨ä½œ
```

---

## Step 2 - å®¡è®¡è§„åˆ™åŸºç¡€ï¼ˆ30 åˆ†é’Ÿï¼‰

### 2.1 è§„åˆ™ç±»å‹

Linux å®¡è®¡è§„åˆ™åˆ†ä¸ºä¸‰ç±»ï¼š

| ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| **æ–‡ä»¶ç³»ç»Ÿè§„åˆ™ (-w)** | ç›‘æ§æ–‡ä»¶/ç›®å½•è®¿é—® | `-w /etc/passwd -p wa -k passwd_change` |
| **ç³»ç»Ÿè°ƒç”¨è§„åˆ™ (-a)** | ç›‘æ§ç³»ç»Ÿè°ƒç”¨ | `-a always,exit -F arch=b64 -S execve -k commands` |
| **æ§åˆ¶è§„åˆ™ (-D, -b)** | å®¡è®¡ç³»ç»Ÿé…ç½® | `-D` (åˆ é™¤æ‰€æœ‰è§„åˆ™), `-b 8192` (ç¼“å†²åŒº) |

### 2.2 æ–‡ä»¶ç³»ç»Ÿè§„åˆ™ (-w)

**è¯­æ³•**ï¼š`-w <è·¯å¾„> -p <æƒé™> -k <å…³é”®å­—>`

**æƒé™æ ‡å¿—**ï¼š

| æ ‡å¿— | å«ä¹‰ | è§¦å‘æ¡ä»¶ |
|------|------|----------|
| `r` | read | è¯»å–æ–‡ä»¶ |
| `w` | write | å†™å…¥æ–‡ä»¶ |
| `x` | execute | æ‰§è¡Œæ–‡ä»¶ |
| `a` | attribute | ä¿®æ”¹æ–‡ä»¶å±æ€§ï¼ˆæƒé™ã€æ‰€æœ‰è€…ç­‰ï¼‰ |

**ç¤ºä¾‹**ï¼š

```bash
# ç›‘æ§ SSH é…ç½®æ–‡ä»¶çš„å†™å…¥å’Œå±æ€§ä¿®æ”¹
sudo auditctl -w /etc/ssh/sshd_config -p wa -k ssh_config_change

# ç›‘æ§æ•´ä¸ª /etc/sudoers.d/ ç›®å½•
sudo auditctl -w /etc/sudoers.d/ -p wa -k sudo_config_change

# ç›‘æ§æ•æ„Ÿæ–‡ä»¶è¯»å–
sudo auditctl -w /etc/shadow -p r -k shadow_read
```

### 2.3 ç³»ç»Ÿè°ƒç”¨è§„åˆ™ (-a)

**è¯­æ³•**ï¼š`-a <list,action> -F <field=value> -S <syscall> -k <å…³é”®å­—>`

```bash
# ç›‘æ§æ‰€æœ‰å‘½ä»¤æ‰§è¡Œï¼ˆ64ä½ç³»ç»Ÿï¼‰
sudo auditctl -a always,exit -F arch=b64 -S execve -k command_exec

# ç›‘æ§ç‰¹å®šç”¨æˆ·çš„å‘½ä»¤æ‰§è¡Œ
sudo auditctl -a always,exit -F arch=b64 -S execve -F uid=1000 -k user1000_commands

# ç›‘æ§æ–‡ä»¶åˆ é™¤æ“ä½œ
sudo auditctl -a always,exit -F arch=b64 -S unlink,unlinkat,rename,renameat -k file_delete
```

### 2.4 è§„åˆ™å…³é”®å­— (-k)

**å…³é”®å­—ï¼ˆkeyï¼‰** æ˜¯æœç´¢å®¡è®¡æ—¥å¿—çš„æ ‡ç­¾ï¼Œéå¸¸é‡è¦ï¼š

```bash
# æ·»åŠ è§„åˆ™æ—¶æŒ‡å®š key
sudo auditctl -w /etc/ssh/sshd_config -p wa -k ssh_config

# ä½¿ç”¨ key æœç´¢ç›¸å…³äº‹ä»¶
sudo ausearch -k ssh_config

# å¥½çš„ key å‘½åè§„èŒƒï¼š
# - æè¿°æ€§ï¼šssh_config_change, sudo_usage, file_delete
# - ä¸€è‡´æ€§ï¼šåŒç±»è§„åˆ™ä½¿ç”¨ç›¸åŒå‰ç¼€
# - å¯æœç´¢ï¼šé¿å…è¿‡äºé€šç”¨çš„åç§°
```

### 2.5 æŸ¥çœ‹å’Œç®¡ç†è§„åˆ™

```bash
# æŸ¥çœ‹å½“å‰è§„åˆ™
sudo auditctl -l

# æŸ¥çœ‹è§„åˆ™çŠ¶æ€
sudo auditctl -s

# åˆ é™¤å•æ¡è§„åˆ™
sudo auditctl -d -w /etc/passwd -p wa -k passwd_change

# åˆ é™¤æ‰€æœ‰è§„åˆ™
sudo auditctl -D

# ä»æ–‡ä»¶åŠ è½½è§„åˆ™
sudo auditctl -R /etc/audit/rules.d/my-rules.rules
```

---

## Step 3 - æ°¸ä¹…è§„åˆ™é…ç½®ï¼ˆ30 åˆ†é’Ÿï¼‰

### 3.1 è§„åˆ™æ–‡ä»¶ç»“æ„

```bash
# è§„åˆ™ç›®å½•
ls /etc/audit/rules.d/

# è§„åˆ™åŠ è½½é¡ºåºï¼šæŒ‰æ–‡ä»¶åå­—æ¯åº
# 10-base.rules      â† åŸºç¡€é…ç½®ï¼ˆå…ˆåŠ è½½ï¼‰
# 20-ssh-config.rules
# 30-sudo.rules
# 40-lotl.rules
# 99-finalize.rules  â† æœ€ååŠ è½½
```

### 3.2 10-base.rules - åŸºç¡€è§„åˆ™

```bash
# æŸ¥çœ‹æœ¬è¯¾æä¾›çš„åŸºç¡€è§„åˆ™
cat code/audit.rules.d/10-base.rules
```

```bash
# =============================================================================
# 10-base.rules - Audit Base Configuration
# =============================================================================
# Purpose: Basic audit system setup and critical system file monitoring
# Reference: CIS Benchmark, NIST SP 800-53
# =============================================================================

# -----------------------------------------------------------------------------
# Audit System Configuration
# -----------------------------------------------------------------------------

# Delete all existing rules (start fresh)
-D

# Set buffer size (increase for busy systems)
-b 8192

# Set failure mode (1=printk, 2=panic)
# Use 1 for production, 2 for high-security environments
-f 1

# -----------------------------------------------------------------------------
# Identity and Authentication Files
# -----------------------------------------------------------------------------

# User account files
-w /etc/passwd -p wa -k identity
-w /etc/shadow -p wa -k identity
-w /etc/group -p wa -k identity
-w /etc/gshadow -p wa -k identity

# PAM configuration
-w /etc/pam.d/ -p wa -k pam_config

# NSS configuration
-w /etc/nsswitch.conf -p wa -k identity

# -----------------------------------------------------------------------------
# Login and Session Tracking
# -----------------------------------------------------------------------------

# Login records
-w /var/log/lastlog -p wa -k logins
-w /var/run/faillock/ -p wa -k logins

# Session files
-w /var/log/wtmp -p wa -k session
-w /var/log/btmp -p wa -k session

# -----------------------------------------------------------------------------
# Privilege Escalation Monitoring
# -----------------------------------------------------------------------------

# sudo and su usage
-w /usr/bin/sudo -p x -k privilege_escalation
-w /usr/bin/su -p x -k privilege_escalation

# Privilege escalation attempts (setuid/setgid)
-a always,exit -F arch=b64 -S setuid,setgid,setreuid,setregid -k privilege_change
-a always,exit -F arch=b32 -S setuid,setgid,setreuid,setregid -k privilege_change
```

### 3.3 20-ssh-config.rules - SSH ç›‘æ§

```bash
cat code/audit.rules.d/20-ssh-config.rules
```

```bash
# =============================================================================
# 20-ssh-config.rules - SSH Configuration Monitoring
# =============================================================================
# Purpose: Track all changes to SSH configuration
# Scenario: "Ghost Configuration Change" - unauthorized sshd_config modification
# =============================================================================

# SSH daemon configuration
-w /etc/ssh/sshd_config -p wa -k ssh_config
-w /etc/ssh/sshd_config.d/ -p wa -k ssh_config

# SSH client configuration (optional, can generate many events)
# -w /etc/ssh/ssh_config -p wa -k ssh_config

# SSH host keys
-w /etc/ssh/ssh_host_ed25519_key -p wa -k ssh_hostkeys
-w /etc/ssh/ssh_host_rsa_key -p wa -k ssh_hostkeys

# Authorized keys (per-user) - use with caution on systems with many users
-w /root/.ssh/authorized_keys -p wa -k ssh_authorized_keys
```

### 3.4 30-sudo.rules - sudo ç›‘æ§

```bash
cat code/audit.rules.d/30-sudo.rules
```

```bash
# =============================================================================
# 30-sudo.rules - sudo and Administrative Actions Monitoring
# =============================================================================
# Purpose: Track all sudo configuration changes and usage
# =============================================================================

# sudo configuration files
-w /etc/sudoers -p wa -k sudo_config
-w /etc/sudoers.d/ -p wa -k sudo_config

# sudo command execution
-w /usr/bin/sudo -p x -k sudo_usage

# su command execution
-w /usr/bin/su -p x -k su_usage

# Administrative commands
-w /usr/sbin/useradd -p x -k user_admin
-w /usr/sbin/userdel -p x -k user_admin
-w /usr/sbin/usermod -p x -k user_admin
-w /usr/sbin/groupadd -p x -k user_admin
-w /usr/sbin/groupdel -p x -k user_admin
-w /usr/sbin/groupmod -p x -k user_admin
```

### 3.5 40-lotl.rules - Living off the Land æ£€æµ‹

```bash
cat code/audit.rules.d/40-lotl.rules
```

```bash
# =============================================================================
# 40-lotl.rules - Living off the Land (LOTL) Attack Detection
# =============================================================================
# Purpose: Detect abuse of legitimate system tools for malicious purposes
# Reference: MITRE ATT&CK, LOLBins
# =============================================================================

# -----------------------------------------------------------------------------
# Network Reconnaissance Tools
# -----------------------------------------------------------------------------

# Download tools (can be used to fetch malicious payloads)
-w /usr/bin/curl -p x -k lotl_download
-w /usr/bin/wget -p x -k lotl_download

# Network tools (can be used for data exfiltration or lateral movement)
-w /usr/bin/nc -p x -k lotl_network
-w /usr/bin/ncat -p x -k lotl_network
-w /usr/bin/netcat -p x -k lotl_network
-w /usr/bin/nmap -p x -k lotl_recon
-w /usr/bin/tcpdump -p x -k lotl_capture

# SSH/SCP (lateral movement)
-w /usr/bin/ssh -p x -k lotl_ssh
-w /usr/bin/scp -p x -k lotl_ssh
-w /usr/bin/sftp -p x -k lotl_ssh

# -----------------------------------------------------------------------------
# Scripting and Execution Tools
# -----------------------------------------------------------------------------

# Compilers (can compile malicious code)
-w /usr/bin/gcc -p x -k lotl_compile
-w /usr/bin/g++ -p x -k lotl_compile
-w /usr/bin/make -p x -k lotl_compile

# -----------------------------------------------------------------------------
# System Modification Tools
# -----------------------------------------------------------------------------

# Cron manipulation (persistence)
-w /usr/bin/crontab -p x -k lotl_cron
-w /var/spool/cron/ -p wa -k cron_modification
-w /etc/cron.d/ -p wa -k cron_modification
-w /etc/cron.daily/ -p wa -k cron_modification
-w /etc/cron.hourly/ -p wa -k cron_modification

# Systemd manipulation (persistence)
-w /etc/systemd/system/ -p wa -k systemd_modification
-w /usr/lib/systemd/system/ -p wa -k systemd_modification

# -----------------------------------------------------------------------------
# Encoding and Obfuscation Tools
# -----------------------------------------------------------------------------

# Base64 (often used to obfuscate malicious commands)
-w /usr/bin/base64 -p x -k lotl_obfuscation
```

### 3.6 åº”ç”¨è§„åˆ™

```bash
# å¤åˆ¶è§„åˆ™æ–‡ä»¶åˆ°ç³»ç»Ÿç›®å½•
sudo cp code/audit.rules.d/*.rules /etc/audit/rules.d/

# é‡æ–°ç”Ÿæˆå¹¶åŠ è½½è§„åˆ™
sudo augenrules --load

# éªŒè¯è§„åˆ™å·²åŠ è½½
sudo auditctl -l | head -20

# æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯
sudo auditctl -s
```

---

## Step 4 - å®¡è®¡æ—¥å¿—åˆ†æï¼ˆ40 åˆ†é’Ÿï¼‰

### 4.1 ausearch åŸºç¡€ç”¨æ³•

`ausearch` æ˜¯æœç´¢å®¡è®¡æ—¥å¿—çš„ä¸»è¦å·¥å…·ï¼š

```bash
# åŸºç¡€è¯­æ³•
ausearch [é€‰é¡¹]

# å¸¸ç”¨é€‰é¡¹ï¼š
# -k <key>     æŒ‰å…³é”®å­—æœç´¢
# -ts <time>   èµ·å§‹æ—¶é—´
# -te <time>   ç»“æŸæ—¶é—´
# -ua <uid>    æŒ‰ç”¨æˆ· ID
# -ui <uid>    æŒ‰ç™»å½•ç”¨æˆ· ID
# -m <type>    æŒ‰æ¶ˆæ¯ç±»å‹
# --format text/raw/interpret  è¾“å‡ºæ ¼å¼
```

### 4.2 æŒ‰å…³é”®å­—æœç´¢

```bash
# æœç´¢ SSH é…ç½®ç›¸å…³äº‹ä»¶
sudo ausearch -k ssh_config

# æœç´¢ sudo ä½¿ç”¨
sudo ausearch -k sudo_usage

# æœç´¢å¤šä¸ªå…³é”®å­—
sudo ausearch -k ssh_config -k sudo_config
```

### 4.3 æŒ‰æ—¶é—´èŒƒå›´æœç´¢

```bash
# æœ€è¿‘çš„äº‹ä»¶
sudo ausearch -ts recent

# ä»Šå¤©çš„äº‹ä»¶
sudo ausearch -ts today

# è¿‡å» 1 å°æ—¶
sudo ausearch -ts "1 hour ago"

# æŒ‡å®šæ—¶é—´èŒƒå›´
sudo ausearch -ts "01/04/2026 09:00:00" -te "01/04/2026 18:00:00"

# ç‰¹å®šæ—¥æœŸ
sudo ausearch -ts "yesterday" -te "today"
```

### 4.4 auid - å®¡è®¡ç”¨æˆ· IDï¼ˆæ ¸å¿ƒæ¦‚å¿µï¼‰

> **è¿™æ˜¯æœ¬è¯¾æœ€é‡è¦çš„æ¦‚å¿µä¹‹ä¸€ã€‚**  

`auid`ï¼ˆAudit User IDï¼‰æ˜¯ç”¨æˆ·**ç™»å½•æ—¶**çš„åŸå§‹ UIDï¼Œå³ä½¿ `sudo` æˆ– `su` åˆ‡æ¢ç”¨æˆ·åä¹Ÿä¸ä¼šæ”¹å˜ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   auid vs uid/euid å¯¹æ¯”                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   ç”¨æˆ· tanaka (uid=1000) ç™»å½•                                   â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚ auid=1000                                               â”‚   â”‚
â”‚   â”‚ uid=1000                                                â”‚   â”‚
â”‚   â”‚ euid=1000                                               â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                         â”‚                                       â”‚
â”‚                         â”‚ sudo su - root                        â”‚
â”‚                         â–¼                                       â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚ auid=1000  â† ä¸å˜ï¼ä»ç„¶æ˜¯ tanaka                         â”‚   â”‚
â”‚   â”‚ uid=0      â† å˜æˆ root                                  â”‚   â”‚
â”‚   â”‚ euid=0     â† å˜æˆ root                                  â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                         â”‚                                       â”‚
â”‚                         â”‚ ä¿®æ”¹ /etc/ssh/sshd_config            â”‚
â”‚                         â–¼                                       â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚ å®¡è®¡æ—¥å¿—è®°å½•ï¼š                                           â”‚   â”‚
â”‚   â”‚ auid=1000 (tanaka) ä¿®æ”¹äº† sshd_config                   â”‚   â”‚
â”‚   â”‚                                                         â”‚   â”‚
â”‚   â”‚ å³ä½¿ä½¿ç”¨ root æƒé™æ“ä½œï¼Œæˆ‘ä»¬ä»ç„¶çŸ¥é“æ˜¯ tanaka åšçš„ï¼     â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚   å…³é”®ä»·å€¼ï¼šè¿½è¸ªè´£ä»»äººï¼Œä¸è¢« sudo/su æ¬ºéª—                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

<details>
<summary>View ASCII source</summary>

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   auid vs uid/euid å¯¹æ¯”                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   ç”¨æˆ· tanaka (uid=1000) ç™»å½•                                   â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚ auid=1000                                               â”‚   â”‚
â”‚   â”‚ uid=1000                                                â”‚   â”‚
â”‚   â”‚ euid=1000                                               â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                         â”‚                                       â”‚
â”‚                         â”‚ sudo su - root                        â”‚
â”‚                         â–¼                                       â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚ auid=1000  â† ä¸å˜ï¼ä»ç„¶æ˜¯ tanaka                         â”‚   â”‚
â”‚   â”‚ uid=0      â† å˜æˆ root                                  â”‚   â”‚
â”‚   â”‚ euid=0     â† å˜æˆ root                                  â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                         â”‚                                       â”‚
â”‚                         â”‚ ä¿®æ”¹ /etc/ssh/sshd_config            â”‚
â”‚                         â–¼                                       â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚ å®¡è®¡æ—¥å¿—è®°å½•ï¼š                                           â”‚   â”‚
â”‚   â”‚ auid=1000 (tanaka) ä¿®æ”¹äº† sshd_config                   â”‚   â”‚
â”‚   â”‚                                                         â”‚   â”‚
â”‚   â”‚ å³ä½¿ä½¿ç”¨ root æƒé™æ“ä½œï¼Œæˆ‘ä»¬ä»ç„¶çŸ¥é“æ˜¯ tanaka åšçš„ï¼     â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚   å…³é”®ä»·å€¼ï¼šè¿½è¸ªè´£ä»»äººï¼Œä¸è¢« sudo/su æ¬ºéª—                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

</details>

**å®é™…æœç´¢**ï¼š

```bash
# æŒ‰ auid æœç´¢ï¼ˆè°ç™»å½•ï¼‰
sudo ausearch -ua 1000

# æŒ‰ uid æœç´¢ï¼ˆå½“å‰æ˜¯è°ï¼‰
sudo ausearch -ui 0   # root æƒé™æ‰§è¡Œçš„æ“ä½œ

# æŸ¥æ‰¾ç‰¹å®šç”¨æˆ·çš„æ‰€æœ‰æ“ä½œï¼ˆå³ä½¿ sudo åï¼‰
sudo ausearch -ua 1000 --format text | grep -E "auid=|comm="
```

### 4.5 ç†è§£å®¡è®¡æ—¥å¿—æ ¼å¼

```bash
# æŸ¥çœ‹åŸå§‹æ—¥å¿—
sudo ausearch -k ssh_config --raw

# å…¸å‹è¾“å‡ºï¼š
# type=SYSCALL msg=audit(1704369600.123:456): arch=c000003e syscall=257 success=yes exit=3 a0=ffffff9c a1=7ffdc8d5a020 a2=241 a3=1b6 items=2 ppid=12345 pid=12346 auid=1000 uid=0 gid=0 euid=0 suid=0 fsuid=0 egid=0 sgid=0 fsgid=0 tty=pts0 ses=1 comm="vim" exe="/usr/bin/vim" key="ssh_config"
```

**å­—æ®µè§£é‡Š**ï¼š

| å­—æ®µ | å«ä¹‰ | ç¤ºä¾‹å€¼ |
|------|------|--------|
| `type=SYSCALL` | äº‹ä»¶ç±»å‹ | SYSCALL, PATH, CWD |
| `msg=audit(timestamp:serial)` | æ—¶é—´æˆ³å’Œåºåˆ—å· | 1704369600.123:456 |
| `arch=c000003e` | ç³»ç»Ÿæ¶æ„ | c000003e = x86_64 |
| `syscall=257` | ç³»ç»Ÿè°ƒç”¨å· | 257 = openat |
| `auid=1000` | å®¡è®¡ç”¨æˆ· ID | **åŸå§‹ç™»å½•ç”¨æˆ·** |
| `uid=0` | å½“å‰ç”¨æˆ· ID | root (sudo å) |
| `comm="vim"` | å‘½ä»¤å | vim |
| `exe="/usr/bin/vim"` | å¯æ‰§è¡Œæ–‡ä»¶è·¯å¾„ | /usr/bin/vim |
| `key="ssh_config"` | å®¡è®¡è§„åˆ™å…³é”®å­— | ssh_config |

### 4.6 ä½¿ç”¨ --format è¾“å‡º

```bash
# æ–‡æœ¬æ ¼å¼ï¼ˆäººç±»å¯è¯»ï¼‰
sudo ausearch -k ssh_config --format text

# è§£é‡Šæ ¼å¼ï¼ˆæ›´è¯¦ç»†ï¼‰
sudo ausearch -k ssh_config --interpret

# åŸå§‹æ ¼å¼
sudo ausearch -k ssh_config --raw

# CSV æ ¼å¼ï¼ˆé€‚åˆå¯¼å…¥ Excelï¼‰
sudo ausearch -k ssh_config --format csv
```

---

## Step 5 - ä½¿ç”¨ aureport ç”ŸæˆæŠ¥å‘Šï¼ˆ20 åˆ†é’Ÿï¼‰

### 5.1 aureport æ¦‚è§ˆ

`aureport` ç”Ÿæˆå®¡è®¡æ•°æ®çš„æ±‡æ€»æŠ¥å‘Šï¼š

```bash
# æ€»ä½“æ±‡æ€»
sudo aureport --summary

# ç™»å½•æŠ¥å‘Š
sudo aureport --login

# ç”¨æˆ·æŠ¥å‘Š
sudo aureport --user

# æ–‡ä»¶æŠ¥å‘Š
sudo aureport --file

# å¯æ‰§è¡Œæ–‡ä»¶æŠ¥å‘Š
sudo aureport --executable

# è®¤è¯æŠ¥å‘Š
sudo aureport --auth

# å¤±è´¥äº‹ä»¶
sudo aureport --failed
```

### 5.2 æ—¶é—´èŒƒå›´æŠ¥å‘Š

```bash
# ä»Šå¤©çš„ç™»å½•
sudo aureport --login --start today

# ç‰¹å®šæ—¶é—´èŒƒå›´
sudo aureport --login --start "01/01/2026 00:00:00" --end "01/04/2026 23:59:59"

# è¿‡å»ä¸€å‘¨çš„å¤±è´¥ç™»å½•
sudo aureport --failed --start "1 week ago"
```

### 5.3 ç”Ÿæˆè°ƒæŸ¥æŠ¥å‘Š

```bash
# ç»¼åˆæŠ¥å‘Šç¤ºä¾‹
echo "=== å®¡è®¡æŠ¥å‘Š ===" > /tmp/audit-report.txt
echo "ç”Ÿæˆæ—¶é—´: $(date)" >> /tmp/audit-report.txt
echo "" >> /tmp/audit-report.txt

echo "=== ç™»å½•æ±‡æ€» ===" >> /tmp/audit-report.txt
sudo aureport --login --start today >> /tmp/audit-report.txt
echo "" >> /tmp/audit-report.txt

echo "=== å¤±è´¥äº‹ä»¶ ===" >> /tmp/audit-report.txt
sudo aureport --failed --start today >> /tmp/audit-report.txt
echo "" >> /tmp/audit-report.txt

echo "=== æƒé™æå‡ ===" >> /tmp/audit-report.txt
sudo ausearch -k privilege_escalation -ts today --format text >> /tmp/audit-report.txt

cat /tmp/audit-report.txt
```

---

## Step 6 - å®æˆ˜åœºæ™¯æ¼”ç»ƒï¼ˆ45 åˆ†é’Ÿï¼‰

### 6.1 åœºæ™¯ 1ï¼šå¹½çµé…ç½®å˜æ›´ï¼ˆGhost Configuration Changeï¼‰

> **åœºæ™¯æè¿°**ï¼šå‘¨ä¸€æ—©æ™¨ï¼Œä½ å‘ç°ç”Ÿäº§æœåŠ¡å™¨çš„ SSH é…ç½®è¢«ä¿®æ”¹äº†ï¼Œ`PermitRootLogin` ä» `no` å˜æˆäº† `yes`ã€‚å›¢é˜Ÿé‡Œæ²¡äººæ‰¿è®¤æ”¹è¿‡ã€‚è°åšçš„ï¼Ÿ  

**æ¼”ç»ƒæ­¥éª¤**ï¼š

```bash
# ä½¿ç”¨æä¾›çš„æ¼”ç»ƒè„šæœ¬
cd /path/to/cloud-atlas/foundations/linux/security/07-auditd/code/ghost-change-scenario

# 1. è®¾ç½®å®¡è®¡è§„åˆ™
sudo bash setup-audit.sh

# 2. æ¨¡æ‹Ÿé…ç½®å˜æ›´ï¼ˆåœ¨å¦ä¸€ä¸ªç»ˆç«¯ï¼Œç”¨ä¸åŒç”¨æˆ·æ‰§è¡Œï¼‰
sudo bash simulate-change.sh

# 3. è°ƒæŸ¥å˜æ›´
sudo bash investigate.sh
```

**æ‰‹åŠ¨è°ƒæŸ¥æ­¥éª¤**ï¼š

```bash
# 1. ç¡®è®¤æ–‡ä»¶è¢«ä¿®æ”¹
sudo stat /etc/ssh/sshd_config

# 2. æœç´¢ SSH é…ç½®ç›¸å…³çš„å®¡è®¡äº‹ä»¶
sudo ausearch -k ssh_config -ts "1 hour ago" --format text

# 3. æ‰¾åˆ°ä¿®æ”¹æ“ä½œï¼Œè¯†åˆ« auid
# å³ä½¿æ“ä½œè€…ä½¿ç”¨äº† sudoï¼Œauid ä»ç„¶æ˜¾ç¤ºåŸå§‹ç”¨æˆ·

# 4. æŸ¥çœ‹å…·ä½“æ˜¯è°
getent passwd <auid>

# 5. æŸ¥çœ‹è¯¥ç”¨æˆ·çš„æ‰€æœ‰æ“ä½œï¼ˆæ—¶é—´çº¿é‡å»ºï¼‰
sudo ausearch -ua <auid> -ts "1 hour ago" --format text
```

### 6.2 åœºæ™¯ 2ï¼šé»„é‡‘å‘¨å¼‚å¸¸ï¼ˆGolden Week Anomalyï¼‰

> **åœºæ™¯æè¿°**ï¼šå­£åº¦å®¡è®¡å‘ç°ï¼ŒæŸç”¨æˆ·è´¦æˆ·åœ¨å›½å®šå‡æ—¥ï¼ˆé»„é‡‘å‘¨ï¼‰å‡Œæ™¨ 3 ç‚¹è®¿é—®äº†ç”Ÿäº§æ–‡ä»¶æœåŠ¡å™¨ã€‚è¯¥ç”¨æˆ·å£°ç§°å½“æ—¶åœ¨ä¼‘å‡ã€‚æ˜¯è´¦æˆ·è¢«ç›—è¿˜æ˜¯é—å¿˜çš„å®šæ—¶ä»»åŠ¡ï¼Ÿ  

**è°ƒæŸ¥æ­¥éª¤**ï¼š

```bash
# 1. ç¡®å®šæ—¶é—´èŒƒå›´ï¼ˆå‡è®¾æ˜¯ 5 æœˆ 3 æ—¥å‡Œæ™¨ 3 ç‚¹ï¼‰
sudo ausearch -ua 1000 -ts "05/03/2026 02:00:00" -te "05/03/2026 04:00:00" --format text

# 2. æŸ¥çœ‹ç™»å½•æ¥æº
sudo ausearch -m USER_LOGIN -ts "05/03/2026 02:00:00" -te "05/03/2026 04:00:00" --interpret

# 3. æ£€æŸ¥æ˜¯å¦æ˜¯ cron ä»»åŠ¡
sudo ausearch -k cron_modification -ts "05/01/2026" --format text

# 4. æŸ¥çœ‹ wtmp è®°å½•ï¼ˆç™»å½•å†å²ï¼‰
last | grep "May  3"

# 5. æ£€æŸ¥ SSH ç™»å½•æ¥æº IP
sudo journalctl -u sshd --since "2026-05-03 02:00" --until "2026-05-03 04:00" | grep "Accepted"
```

**åˆ†æå…³é”®ç‚¹**ï¼š

| æƒ…å†µ | ç‰¹å¾ | åˆ¤æ–­ |
|------|------|------|
| æ­£å¸¸ cron | æ—  USER_LOGIN äº‹ä»¶ | æ˜¯å®šæ—¶ä»»åŠ¡ |
| SSH ç™»å½•ï¼ˆæœ¬äººï¼‰ | ç™»å½• IP æ˜¯ç”¨æˆ·å¸¸ç”¨ IP | å¯èƒ½é—å¿˜ |
| SSH ç™»å½•ï¼ˆå¼‚å¸¸ï¼‰ | ç™»å½• IP æ˜¯é™Œç”Ÿåœ°å€ | è´¦æˆ·å¯èƒ½è¢«ç›— |
| æ¨ªå‘ç§»åŠ¨ | ä»å…¶ä»–æœåŠ¡å™¨ SSH è¿‡æ¥ | éœ€è¦è°ƒæŸ¥æºå¤´ |

### 6.3 åœºæ™¯ 3ï¼šéšè—æŒ–çŸ¿ç¨‹åºï¼ˆHidden Cryptominerï¼‰

> **åœºæ™¯æè¿°**ï¼šZabbix å‘Šè­¦æ•°æ®åº“å¤‡æœº CPU å ç”¨ 99%ã€‚`top` æ˜¾ç¤ºä¸€ä¸ªå« `kworker` çš„è¿›ç¨‹ï¼Œä½†çœŸæ­£çš„ `kworker` æ˜¯å†…æ ¸çº¿ç¨‹ï¼Œä¸åº”è¯¥å ç”¨è¿™ä¹ˆå¤š CPUã€‚æ€€ç–‘æ˜¯æ¶æ„æŒ–çŸ¿ç¨‹åºã€‚  

**è°ƒæŸ¥æ­¥éª¤**ï¼š

```bash
# 1. è¯†åˆ«å¯ç–‘è¿›ç¨‹
ps aux | grep kworker
# æ³¨æ„ï¼šçœŸæ­£çš„ kworker åº”è¯¥åœ¨ [] ä¸­ï¼Œå¦‚ [kworker/0:0]
# å¦‚æœæ²¡æœ‰ []ï¼Œå¾ˆå¯èƒ½æ˜¯ä¼ªè£…çš„ç”¨æˆ·æ€ç¨‹åº

# 2. æ£€æŸ¥è¿›ç¨‹çš„çœŸå®è·¯å¾„
ls -l /proc/<PID>/exe
# çœŸæ­£çš„å†…æ ¸çº¿ç¨‹ä¼šæ˜¾ç¤º /proc/<PID>/exe -> (kernel)
# ä¼ªè£…çš„ç¨‹åºä¼šæ˜¾ç¤ºå®é™…è·¯å¾„

# 3. æŸ¥æ‰¾å¯æ‰§è¡Œæ–‡ä»¶çš„æ¥æº
sudo ausearch -f /path/to/suspicious/binary --format text

# 4. æ£€æŸ¥æŒä¹…åŒ–æœºåˆ¶ - cron
sudo ausearch -k cron_modification -ts "1 week ago" --format text
crontab -l
ls -la /etc/cron.d/

# 5. æ£€æŸ¥æŒä¹…åŒ–æœºåˆ¶ - systemd
sudo ausearch -k systemd_modification -ts "1 week ago" --format text
ls -la /etc/systemd/system/ | grep -v "^l"

# 6. æ£€æŸ¥æœ€è¿‘ä¿®æ”¹çš„æ–‡ä»¶
sudo find /etc -mtime -7 -type f | head -20

# 7. é‡å»ºæ—¶é—´çº¿ï¼šè°ä¸‹è½½çš„ï¼Ÿ
sudo ausearch -k lotl_download -ts "1 week ago" --format text | grep -E "curl|wget"
```

---

## Step 7 - äº‹æ•…æŠ¥å‘Šæ¨¡æ¿ï¼ˆ15 åˆ†é’Ÿï¼‰

### 7.1 æ—¥æœ¬ä¼ä¸šäº‹æ•…æŠ¥å‘Šæ ¼å¼

åœ¨æ—¥æœ¬ IT ä¼ä¸šï¼Œå®‰å…¨äº‹æ•…éœ€è¦æ­£å¼çš„æ›¸é¢å ±å‘Šï¼š

```bash
cat code/incident-report-template.md
```

### 7.2 æŠ¥å‘Šæ¨¡æ¿

```markdown
# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆå ±å‘Šæ›¸

## åŸºæœ¬æƒ…å ±

| é …ç›® | å†…å®¹ |
|------|------|
| å ±å‘Šæ—¥ | 2026å¹´01æœˆ04æ—¥ |
| å ±å‘Šè€… | __________ |
| ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆç™ºç”Ÿæ—¥æ™‚ | 2026å¹´01æœˆ03æ—¥ 15:30 JST |
| å½±éŸ¿ã‚·ã‚¹ãƒ†ãƒ  | production-bastion-01 |
| æ·±åˆ»åº¦ | ä¸­ (è¨­å®šå¤‰æ›´ã€ãƒ‡ãƒ¼ã‚¿æ¼æ´©ãªã—) |

## ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆæ¦‚è¦

### ä½•ãŒèµ·ããŸã‹
å ¡å’æœº SSH é…ç½®æ–‡ä»¶ `/etc/ssh/sshd_config` è¢«æœªç»æˆæƒä¿®æ”¹ï¼Œ
`PermitRootLogin` è®¾ç½®ä» `no` å˜æ›´ä¸º `yes`ã€‚

### ç™ºè¦‹çµŒç·¯
é€±æ˜ã‘æœˆæ›œæ—¥ã®å®šæœŸã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»ã§è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®å·®åˆ†ãƒã‚§ãƒƒã‚¯æ™‚ã«ç™ºè¦šã€‚

## èª¿æŸ»çµæœ

### è¨¼æ‹ åé›† (auditd)

```bash
# ä½¿ç”¨çš„æœç´¢å‘½ä»¤
sudo ausearch -k ssh_config -ts "01/01/2026 00:00:00" -te "01/03/2026 23:59:59" --format text
```

### æ™‚ç³»åˆ—

| æ™‚åˆ» | äº‹è±¡ | è¨¼æ‹  |
|------|------|------|
| 01/03 15:28 | tanaka (uid=1000) SSH ãƒ­ã‚°ã‚¤ãƒ³ | ausearch -m USER_LOGIN |
| 01/03 15:30 | sudo su - root å®Ÿè¡Œ | ausearch -k sudo_usage |
| 01/03 15:31 | vim /etc/ssh/sshd_config å®Ÿè¡Œ | ausearch -k ssh_config |
| 01/03 15:32 | systemctl restart sshd å®Ÿè¡Œ | journalctl -u sshd |

### è²¬ä»»è€…ç‰¹å®š

- **auid**: 1000
- **ãƒ¦ãƒ¼ã‚¶ãƒ¼å**: tanaka
- **æ‰€å±**: é–‹ç™ºãƒãƒ¼ãƒ 
- **å‚™è€ƒ**: æœ¬äººã¯ã€Œãƒ†ã‚¹ãƒˆç’°å¢ƒã¨é–“é•ãˆãŸã€ã¨è¨¼è¨€

## å½±éŸ¿ç¯„å›²

- [x] è¨­å®šå¤‰æ›´ã‚ã‚Š
- [ ] ãƒ‡ãƒ¼ã‚¿æ¼æ´©ãªã—
- [ ] ä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹ã®å…†å€™ãªã—
- [ ] ã‚µãƒ¼ãƒ“ã‚¹åœæ­¢ãªã—

## å¯¾å¿œçŠ¶æ³

| å¯¾å¿œé …ç›® | çŠ¶æ…‹ | æ‹…å½“ | å®Œäº†æ—¥ |
|----------|------|------|--------|
| è¨­å®šå¾©æ—§ | å®Œäº† | ops-team | 01/04 09:00 |
| è¨¼æ‹ ä¿å…¨ | å®Œäº† | sec-team | 01/04 09:30 |
| æœ¬äººãƒ’ã‚¢ãƒªãƒ³ã‚° | å®Œäº† | manager | 01/04 10:00 |
| å†ç™ºé˜²æ­¢ç­–æ¤œè¨ | é€²è¡Œä¸­ | sec-team | - |

## å†ç™ºé˜²æ­¢ç­–

### æŠ€è¡“çš„å¯¾ç­–
1. sshd_config ã®å¤‰æ›´ã«å¯¾ã™ã‚‹ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®š
2. æœ¬ç•ªç’°å¢ƒå¤‰æ›´ã®æ‰¿èªãƒ•ãƒ­ãƒ¼å°å…¥
3. ç’°å¢ƒåˆ¥ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè‰²åˆ†ã‘ï¼ˆæœ¬ç•ª=èµ¤ï¼‰

### é‹ç”¨çš„å¯¾ç­–
1. å¤‰æ›´ç®¡ç†ãƒ—ãƒ­ã‚»ã‚¹ã®å†æ•™è‚²
2. æœ¬ç•ªã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã®è¦‹ç›´ã—

## æ‰¿èª

| å½¹è· | æ°å | æ—¥ä»˜ | ç½²å |
|------|------|------|------|
| ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ‹…å½“ | | | |
| éƒ¨é–€é•· | | | |
| CISO | | | |
```

---

## åæ¨¡å¼ï¼šå¸¸è§é”™è¯¯

### é”™è¯¯ 1ï¼šç¦ç”¨ auditd

```bash
# å±é™©ï¼ç¦ç”¨å®¡è®¡
sudo systemctl stop auditd
sudo systemctl disable auditd

# åæœï¼š
# - æ— æ³•è¿½è¸ªä»»ä½•æ“ä½œ
# - å®‰å…¨äº‹æ•…æ— æ³•è°ƒæŸ¥
# - è¿ååˆè§„è¦æ±‚

# å¦‚æœè§‰å¾—æ—¥å¿—å¤ªå¤šï¼Œæ­£ç¡®åšæ³•æ˜¯ä¼˜åŒ–è§„åˆ™ï¼Œä¸æ˜¯ç¦ç”¨
```

### é”™è¯¯ 2ï¼šè§„åˆ™è¿‡äºå®½æ³›

```bash
# å±é™©ï¼ç›‘æ§æ‰€æœ‰ execveï¼ˆä¼šäº§ç”Ÿæµ·é‡æ—¥å¿—ï¼‰
-a always,exit -F arch=b64 -S execve -k everything

# åæœï¼š
# - æ—¥å¿—æš´æ¶¨
# - æ€§èƒ½ä¸‹é™
# - é‡è¦äº‹ä»¶è¢«æ·¹æ²¡

# æ­£ç¡®åšæ³•ï¼šé’ˆå¯¹æ€§ç›‘æ§
-w /etc/ssh/sshd_config -p wa -k ssh_config  # åªç›‘æ§å…³é”®æ–‡ä»¶
```

### é”™è¯¯ 3ï¼šæ—¥å¿—ä¿ç•™æ—¶é—´å¤ªçŸ­

```bash
# å±é™©çš„é…ç½®
# /etc/audit/auditd.conf
max_log_file = 5      # åªæœ‰ 5MB
num_logs = 3          # åªä¿ç•™ 3 ä¸ªæ–‡ä»¶
# æ€»å…±åªæœ‰ 15MB æ—¥å¿—

# åæœï¼š
# - è°ƒæŸ¥æ—¶å‘ç°æ—¥å¿—å·²è¢«è½®è½¬è¦†ç›–
# - è¯æ®ä¸¢å¤±

# åˆè§„è¦æ±‚é€šå¸¸éœ€è¦ä¿ç•™ 90+ å¤©æ—¥å¿—
```

### é”™è¯¯ 4ï¼šå¿½ç•¥ auid

```bash
# åªæŒ‰ uid æœç´¢
sudo ausearch -ui 0   # åªæ‰¾ root æ“ä½œ

# é—®é¢˜ï¼šæ— æ³•çŸ¥é“æ˜¯è° sudo æˆ root çš„

# æ­£ç¡®åšæ³•ï¼šä½¿ç”¨ auid è¿½è¸ªåŸå§‹ç”¨æˆ·
sudo ausearch -ua 1000   # æ‰¾ tanaka çš„æ‰€æœ‰æ“ä½œï¼ŒåŒ…æ‹¬ sudo åçš„
```

---

## èŒåœºå°è´´å£«ï¼ˆJapan IT Contextï¼‰

### å®¡è®¡ç›¸å…³æœ¯è¯­

| æ—¥è¯­æœ¯è¯­ | å«ä¹‰ | åº”ç”¨åœºæ™¯ |
|----------|------|----------|
| ç›£æŸ»ãƒ­ã‚°ï¼ˆã‹ã‚“ã•ãƒ­ã‚°ï¼‰ | å®¡è®¡æ—¥å¿— | auditd æ—¥å¿— |
| è¨¼è·¡ï¼ˆã—ã‚‡ã†ã›ãï¼‰ | è¯æ®/å®¡è®¡è½¨è¿¹ | å®‰å…¨è°ƒæŸ¥è¯æ® |
| å ±å‘Šæ›¸ï¼ˆã»ã†ã“ãã—ã‚‡ï¼‰ | æŠ¥å‘Šä¹¦ | äº‹æ•…æŠ¥å‘Šæ–‡æ¡£ |
| ä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹ | éæ³•è®¿é—® | å®‰å…¨äº‹æ•…ç±»å‹ |
| å¤‰æ›´ç®¡ç† | å˜æ›´ç®¡ç† | é…ç½®å˜æ›´æµç¨‹ |
| ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹ | åˆè§„ | ISMS, PCI DSS |
| ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ» | å®‰å…¨å®¡è®¡ | å®šæœŸæ£€æŸ¥ |

### æ—¥æœ¬ä¼ä¸šå®¡è®¡è¦æ±‚

1. **ISMS/ISO 27001**
   - éœ€è¦ä¿ç•™è®¿é—®æ—¥å¿—
   - éœ€è¦å®šæœŸå®¡æŸ¥æ—¥å¿—
   - éœ€è¦äº‹æ•…å“åº”æµç¨‹

2. **PCI DSSï¼ˆé‡‘èï¼‰**
   - æ—¥å¿—ä¿ç•™ 1 å¹´ä»¥ä¸Š
   - å®æ—¶æ—¥å¿—ç›‘æ§
   - å®¡è®¡ç³»ç»Ÿå®Œæ•´æ€§

3. **ä¸Šåœºä¼ä¸š SOX åˆè§„**
   - è®¿é—®æ§åˆ¶å®¡è®¡
   - å˜æ›´ç®¡ç†è¯æ®
   - æƒé™åˆ†ç¦»

### æ—¥æœ¬ä¼ä¸šå¸¸è§åšæ³•

```bash
# 1. é›†ä¸­æ—¥å¿—ç®¡ç†
# auditd â†’ rsyslog â†’ ä¸­å¤®æ—¥å¿—æœåŠ¡å™¨ï¼ˆSplunk, Elasticsearchï¼‰

# 2. æ—¥å¿—ä¿ç•™æœŸé—´
# é€šå¸¸ 1 å¹´ä»¥ä¸Šï¼Œé‡‘èè¡Œä¸šå¯èƒ½è¦æ±‚ 5-7 å¹´

# 3. å®šæœŸå®¡è®¡æŠ¥å‘Š
# æ¯æœˆç”Ÿæˆ aureport æ±‡æ€»ï¼Œç”±å®‰å…¨å›¢é˜Ÿå®¡æŸ¥

# 4. å‘Šè­¦è®¾ç½®
# å…³é”®äº‹ä»¶ï¼ˆsudo åˆ° rootï¼Œé…ç½®å˜æ›´ï¼‰å®æ—¶å‘Šè­¦
```

---

## æ£€æŸ¥æ¸…å•

å®Œæˆæœ¬è¯¾åï¼Œä½ åº”è¯¥èƒ½å¤Ÿï¼š

- [ ] è§£é‡Š Linux å®¡è®¡ç³»ç»Ÿæ¶æ„ï¼ˆå†…æ ¸å®¡è®¡ â†’ auditd â†’ audit.logï¼‰
- [ ] ä½¿ç”¨ `auditctl -w` æ·»åŠ æ–‡ä»¶ç›‘æ§è§„åˆ™
- [ ] ä½¿ç”¨ `auditctl -a` æ·»åŠ ç³»ç»Ÿè°ƒç”¨ç›‘æ§è§„åˆ™
- [ ] å°†è§„åˆ™å†™å…¥ `/etc/audit/rules.d/` å®ç°æŒä¹…åŒ–
- [ ] ä½¿ç”¨ `ausearch -k` æŒ‰å…³é”®å­—æœç´¢æ—¥å¿—
- [ ] ä½¿ç”¨ `ausearch -ts` æŒ‰æ—¶é—´èŒƒå›´æœç´¢
- [ ] **è§£é‡Š auid ä¸ uid çš„åŒºåˆ«ï¼Œè¿½è¸ª sudo åçš„åŸå§‹ç”¨æˆ·**
- [ ] ä½¿ç”¨ `aureport` ç”Ÿæˆç™»å½•ã€æ–‡ä»¶ã€å¤±è´¥äº‹ä»¶æŠ¥å‘Š
- [ ] é…ç½® LOTL æ”»å‡»æ£€æµ‹è§„åˆ™
- [ ] æ ¹æ®å®¡è®¡æ—¥å¿—ç”Ÿæˆæ—¥æœ¬ä¼ä¸šæ ¼å¼çš„äº‹æ•…æŠ¥å‘Š

---

## æœ¬è¯¾å°ç»“

| æ¦‚å¿µ | å‘½ä»¤/é…ç½® | è®°å¿†ç‚¹ |
|------|-----------|--------|
| æŸ¥çœ‹è§„åˆ™ | `auditctl -l` | å½“å‰å®¡è®¡è§„åˆ™åˆ—è¡¨ |
| æ·»åŠ æ–‡ä»¶ç›‘æ§ | `auditctl -w /path -p wa -k key` | -p: r/w/x/a |
| åˆ é™¤è§„åˆ™ | `auditctl -d` æˆ– `-D` | -D åˆ é™¤å…¨éƒ¨ |
| æ°¸ä¹…è§„åˆ™ | `/etc/audit/rules.d/*.rules` | æŒ‰æ–‡ä»¶åæ’åºåŠ è½½ |
| åŠ è½½è§„åˆ™ | `augenrules --load` | é‡æ–°åŠ è½½æ‰€æœ‰è§„åˆ™ |
| æŒ‰ key æœç´¢ | `ausearch -k key` | è§„åˆ™å…³é”®å­—å¾ˆé‡è¦ |
| æŒ‰æ—¶é—´æœç´¢ | `ausearch -ts "1 hour ago"` | æ”¯æŒè‡ªç„¶è¯­è¨€ |
| æŒ‰åŸå§‹ç”¨æˆ·æœç´¢ | `ausearch -ua <auid>` | **auid ä¸å˜** |
| ç”ŸæˆæŠ¥å‘Š | `aureport --login` | æ±‡æ€»ç»Ÿè®¡ |

**æ ¸å¿ƒæ¦‚å¿µ**ï¼š

```
auidï¼ˆå®¡è®¡ç”¨æˆ· IDï¼‰= ç™»å½•æ—¶çš„åŸå§‹ UID
å³ä½¿ sudo/su åï¼Œauid ä»ç„¶ä¸å˜
è¿™æ˜¯è¿½è¸ª"è°åšäº†ä»€ä¹ˆ"çš„å…³é”®
```

**LOTL æ£€æµ‹å…³é”®ç‚¹**ï¼š

```
Living off the Land = æ»¥ç”¨åˆæ³•å·¥å…·
ç›‘æ§ curl, wget, nc, base64 ç­‰å·¥å…·çš„æ‰§è¡Œ
è¿™äº›å·¥å…·æœ¬èº«åˆæ³•ï¼Œä½†è¢«æ¶æ„ä½¿ç”¨æ—¶æ˜¯æ”»å‡»ä¿¡å·
```

---

## å»¶ä¼¸é˜…è¯»

- [Linux Audit Documentation](https://github.com/linux-audit/audit-documentation/wiki) - å®˜æ–¹æ–‡æ¡£
- [CIS Benchmark - Audit Configuration](https://www.cisecurity.org/benchmark) - åˆè§„åŸºçº¿
- [MITRE ATT&CK - Defense Evasion](https://attack.mitre.org/tactics/TA0005/) - LOTL æ”»å‡»æŠ€æœ¯
- [NIST SP 800-53 - Audit and Accountability](https://csrc.nist.gov/publications/detail/sp/800-53/rev-5/final) - å®¡è®¡åˆè§„æ ‡å‡†
- ä¸Šä¸€è¯¾ï¼š[06 - Linux Capabilities](../06-capabilities/) - ç²¾ç»†æƒé™æ§åˆ¶
- ä¸‹ä¸€è¯¾ï¼š[08 - nftables æ·±å…¥](../08-nftables/) - ç°ä»£é˜²ç«å¢™

---

## ç³»åˆ—å¯¼èˆª

[ä¸Šä¸€è¯¾ï¼š06 - Linux Capabilities](../06-capabilities/) | [ç³»åˆ—é¦–é¡µ](../) | [ä¸‹ä¸€è¯¾ï¼š08 - nftables æ·±å…¥ ->](../08-nftables/)
