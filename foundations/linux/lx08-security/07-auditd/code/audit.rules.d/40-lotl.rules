# =============================================================================
# 40-lotl.rules - Living off the Land (LOTL) Attack Detection
# =============================================================================
# Purpose: Detect abuse of legitimate system tools for malicious purposes
# Reference: MITRE ATT&CK, LOLBins/LOLBas, GTFOBins
# Course: LX08-SECURITY Lesson 07 - auditd
# =============================================================================
#
# Living off the Land (LOTL) attacks use legitimate system tools to:
# - Download malicious payloads
# - Establish reverse shells
# - Exfiltrate data
# - Maintain persistence
# - Evade detection
#
# These rules generate alerts when these tools are executed.
# High volume environments may need to tune these carefully.
#
# =============================================================================

# -----------------------------------------------------------------------------
# Network Reconnaissance and Download Tools
# -----------------------------------------------------------------------------

# Download tools - can fetch malicious payloads
# These are legitimate tools that attackers abuse
-w /usr/bin/curl -p x -k lotl_download
-w /usr/bin/wget -p x -k lotl_download

# Network tools - data exfiltration, reverse shells, lateral movement
-w /usr/bin/nc -p x -k lotl_network
-w /usr/bin/ncat -p x -k lotl_network
-w /usr/bin/netcat -p x -k lotl_network
-w /usr/bin/socat -p x -k lotl_network

# Network scanning and reconnaissance
-w /usr/bin/nmap -p x -k lotl_recon
-w /usr/sbin/nmap -p x -k lotl_recon

# Packet capture - network sniffing
-w /usr/bin/tcpdump -p x -k lotl_capture
-w /usr/sbin/tcpdump -p x -k lotl_capture
-w /usr/bin/tshark -p x -k lotl_capture

# DNS tools - can be used for data exfiltration
-w /usr/bin/dig -p x -k lotl_dns
-w /usr/bin/nslookup -p x -k lotl_dns
-w /usr/bin/host -p x -k lotl_dns

# -----------------------------------------------------------------------------
# Remote Access and Lateral Movement
# -----------------------------------------------------------------------------

# SSH/SCP/SFTP - lateral movement within network
-w /usr/bin/ssh -p x -k lotl_ssh
-w /usr/bin/scp -p x -k lotl_ssh
-w /usr/bin/sftp -p x -k lotl_ssh

# rsync - can be used for data theft
-w /usr/bin/rsync -p x -k lotl_transfer

# FTP clients
-w /usr/bin/ftp -p x -k lotl_transfer
-w /usr/bin/lftp -p x -k lotl_transfer

# -----------------------------------------------------------------------------
# Scripting and Execution Tools
# -----------------------------------------------------------------------------

# Compilers - can compile malicious code on target
-w /usr/bin/gcc -p x -k lotl_compile
-w /usr/bin/g++ -p x -k lotl_compile
-w /usr/bin/cc -p x -k lotl_compile
-w /usr/bin/make -p x -k lotl_compile
-w /usr/bin/as -p x -k lotl_compile
-w /usr/bin/ld -p x -k lotl_compile

# Scripting languages (use with caution - high volume)
# Uncomment only if needed and you can handle the log volume
# -w /usr/bin/python -p x -k lotl_script
# -w /usr/bin/python3 -p x -k lotl_script
# -w /usr/bin/perl -p x -k lotl_script
# -w /usr/bin/ruby -p x -k lotl_script

# -----------------------------------------------------------------------------
# Encoding and Obfuscation Tools
# -----------------------------------------------------------------------------

# Base64 - often used to obfuscate malicious commands
-w /usr/bin/base64 -p x -k lotl_obfuscation

# xxd - hex dump, can be used for encoding
-w /usr/bin/xxd -p x -k lotl_obfuscation

# openssl - can encrypt data for exfiltration
-w /usr/bin/openssl -p x -k lotl_crypto

# GPG - encryption
-w /usr/bin/gpg -p x -k lotl_crypto
-w /usr/bin/gpg2 -p x -k lotl_crypto

# -----------------------------------------------------------------------------
# System Modification and Persistence
# -----------------------------------------------------------------------------

# Cron manipulation - persistence mechanism
-w /usr/bin/crontab -p x -k lotl_cron
-w /var/spool/cron/ -p wa -k cron_modification
-w /etc/cron.d/ -p wa -k cron_modification
-w /etc/cron.daily/ -p wa -k cron_modification
-w /etc/cron.hourly/ -p wa -k cron_modification
-w /etc/cron.weekly/ -p wa -k cron_modification
-w /etc/cron.monthly/ -p wa -k cron_modification
-w /etc/crontab -p wa -k cron_modification

# Systemd manipulation - persistence mechanism
-w /etc/systemd/system/ -p wa -k systemd_modification
-w /usr/lib/systemd/system/ -p wa -k systemd_modification
-w /etc/systemd/user/ -p wa -k systemd_modification

# Init scripts (legacy)
-w /etc/init.d/ -p wa -k init_modification
-w /etc/rc.d/ -p wa -k init_modification
-w /etc/rc.local -p wa -k init_modification

# Profile scripts - executed on login
-w /etc/profile -p wa -k profile_modification
-w /etc/profile.d/ -p wa -k profile_modification
-w /etc/bashrc -p wa -k profile_modification
-w /etc/bash.bashrc -p wa -k profile_modification

# -----------------------------------------------------------------------------
# Archive and Compression Tools
# -----------------------------------------------------------------------------

# Can be used to package data for exfiltration
-w /usr/bin/tar -p x -k lotl_archive
-w /usr/bin/zip -p x -k lotl_archive
-w /usr/bin/gzip -p x -k lotl_archive
-w /usr/bin/bzip2 -p x -k lotl_archive
-w /usr/bin/xz -p x -k lotl_archive

# -----------------------------------------------------------------------------
# Process Manipulation
# -----------------------------------------------------------------------------

# strace/ltrace - can capture sensitive data
-w /usr/bin/strace -p x -k lotl_debug
-w /usr/bin/ltrace -p x -k lotl_debug

# gdb - debugger, can modify running processes
-w /usr/bin/gdb -p x -k lotl_debug

# -----------------------------------------------------------------------------
# GTFOBins - Common Privilege Escalation Binaries
# -----------------------------------------------------------------------------

# These binaries have known privilege escalation techniques
# See: https://gtfobins.github.io/

# Editors with shell escape
-w /usr/bin/vim -p x -k lotl_editor
-w /usr/bin/vi -p x -k lotl_editor
-w /usr/bin/nano -p x -k lotl_editor
-w /usr/bin/emacs -p x -k lotl_editor

# Pagers with shell escape
-w /usr/bin/less -p x -k lotl_pager
-w /usr/bin/more -p x -k lotl_pager

# awk/sed - can execute commands
-w /usr/bin/awk -p x -k lotl_text
-w /usr/bin/gawk -p x -k lotl_text
-w /usr/bin/sed -p x -k lotl_text

# find with -exec
-w /usr/bin/find -p x -k lotl_find
