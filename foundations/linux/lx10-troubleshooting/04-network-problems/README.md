# 04 - ç½‘ç»œé—®é¢˜ï¼šåˆ†å±‚è¯Šæ–­

> **ç›®æ ‡**ï¼šæŒæ¡åˆ†å±‚ç½‘ç»œè¯Šæ–­æ–¹æ³•ï¼Œç³»ç»Ÿæ€§æ’æŸ¥è¿é€šæ€§å’Œæ€§èƒ½é—®é¢˜  
> **å‰ç½®**ï¼šLX06-NETWORK ç½‘ç»œåŸºç¡€ï¼ˆssã€nftablesã€DNSï¼‰  
> **æ—¶é—´**ï¼šâš¡ 40 åˆ†é’Ÿï¼ˆé€Ÿè¯»ï¼‰/ ğŸ”¬ 150 åˆ†é’Ÿï¼ˆå®Œæ•´å®æ“ï¼‰  
> **å®æˆ˜åœºæ™¯**ï¼šcurl è¶…æ—¶ä½†æœåŠ¡å™¨åœ¨è¿è¡Œï¼Œé—´æ­‡æ€§ 502 Bad Gateway  

---

## å°†å­¦åˆ°çš„å†…å®¹

1. ä½¿ç”¨åˆ†å±‚æ–¹æ³•è¯Šæ–­ç½‘ç»œé—®é¢˜ï¼ˆL2 -> L3 -> L4 -> L7ï¼‰
2. æŒæ¡ç½‘ç»œè¯Šæ–­å·¥å…·ç»„åˆï¼ˆip, ss, dig, curl, ncï¼‰
3. è¯†åˆ« DNS é—®é¢˜çš„å¸¸è§ç—‡çŠ¶å’Œæ’æŸ¥æ–¹æ³•
4. è¯Šæ–­é˜²ç«å¢™å¯¼è‡´çš„è¿é€šæ€§é—®é¢˜
5. ç†è§£é«˜çº§ç½‘ç»œé—®é¢˜ï¼ˆMTUã€ç«¯å£è€—å°½ã€conntrackï¼‰
6. å®Œæˆ TCP é»‘æ´åœºæ™¯çš„å®Œæ•´æ’æŸ¥

---

## å…ˆè·‘èµ·æ¥ï¼ï¼ˆ10 åˆ†é’Ÿï¼‰

> åœºæ™¯ï¼šä½ æ”¶åˆ°å‘Šè­¦ "API æœåŠ¡ä¸å¯ç”¨"ï¼Œcurl è¯·æ±‚è¶…æ—¶ã€‚  
> æœåŠ¡å™¨è¿˜åœ¨è¿è¡Œï¼Œä½†å°±æ˜¯è¿ä¸ä¸Šã€‚å…ˆåˆ«æ…Œï¼Œç”¨è¿™ä¸ªå¿«é€Ÿè¯Šæ–­æµç¨‹ï¼š  

```bash
# 1. æœåŠ¡åœ¨ç›‘å¬å—ï¼Ÿï¼ˆL4 æ£€æŸ¥ï¼‰
ss -lntup | grep ':80\|:443\|:8080'

# 2. èƒ½ ping é€šå—ï¼Ÿï¼ˆL3 æ£€æŸ¥ï¼‰
ping -c 3 <ç›®æ ‡IP>

# 3. ç«¯å£èƒ½è¿ä¸Šå—ï¼Ÿï¼ˆL4 æ£€æŸ¥ï¼‰
nc -zv <ç›®æ ‡IP> 80
# æˆ–
curl -v --connect-timeout 5 http://<ç›®æ ‡IP>/

# 4. DNS æ­£å¸¸å—ï¼Ÿï¼ˆL7 æ£€æŸ¥ï¼‰
dig <åŸŸå> +short

# 5. é˜²ç«å¢™æ”¾è¡Œäº†å—ï¼Ÿ
# RHEL/CentOS:
firewall-cmd --list-all
# æˆ– nftables:
nft list ruleset | head -50
```

**ä½ åˆšåˆšå®Œæˆäº†ä¸€æ¬¡å¿«é€Ÿåˆ†å±‚è¯Šæ–­ï¼**

è¿™å°±æ˜¯ç½‘ç»œæ’æŸ¥çš„æ ¸å¿ƒæ€è·¯ï¼šä»ä¸Šåˆ°ä¸‹æˆ–ä»ä¸‹åˆ°ä¸Šï¼Œé€å±‚æ’æŸ¥ã€‚
ç°åœ¨è®©æˆ‘ä»¬ç³»ç»Ÿå­¦ä¹ åˆ†å±‚è¯Šæ–­æ–¹æ³•ã€‚

---

## Step 1 -- åˆ†å±‚è¯Šæ–­æ–¹æ³•è®ºï¼ˆ15 åˆ†é’Ÿï¼‰

### 1.1 ç½‘ç»œä¸ƒå±‚æ¨¡å‹ç®€åŒ–ç‰ˆ

å¯¹äºè¿ç»´æ’æŸ¥ï¼Œæˆ‘ä»¬å…³æ³¨å››ä¸ªå…³é”®å±‚æ¬¡ï¼š

<!-- DIAGRAM: network-layers -->
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ç½‘ç»œåˆ†å±‚è¯Šæ–­æ¨¡å‹                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                           â”‚
â”‚  OSI æ¨¡å‹          è¿ç»´è§†è§’              è¯Šæ–­å·¥å…·                          â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€          â”€â”€â”€â”€â”€â”€â”€â”€              â”€â”€â”€â”€â”€â”€â”€â”€                          â”‚
â”‚                                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Layer 7     â”‚   â”‚ åº”ç”¨å±‚      â”‚      â”‚ curl, wget, dig             â”‚  â”‚
â”‚  â”‚ Application â”‚   â”‚ HTTP/DNS    â”‚      â”‚ openssl s_client            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚        â†“                 â†“                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Layer 4     â”‚   â”‚ ä¼ è¾“å±‚      â”‚      â”‚ ss, netstat, nc -zv         â”‚  â”‚
â”‚  â”‚ Transport   â”‚   â”‚ TCP/UDP     â”‚      â”‚ tcpdump (TCP flags)         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚        â†“                 â†“                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Layer 3     â”‚   â”‚ ç½‘ç»œå±‚      â”‚      â”‚ ping, traceroute, ip route  â”‚  â”‚
â”‚  â”‚ Network     â”‚   â”‚ IP è·¯ç”±     â”‚      â”‚ ip addr, mtr                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚        â†“                 â†“                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Layer 1-2   â”‚   â”‚ ç‰©ç†/é“¾è·¯å±‚ â”‚      â”‚ ip link, ethtool            â”‚  â”‚
â”‚  â”‚ Physical/   â”‚   â”‚ ç½‘å¡/çº¿ç¼†   â”‚      â”‚ dmesg (ç½‘å¡é”™è¯¯)            â”‚  â”‚
â”‚  â”‚ Data Link   â”‚   â”‚             â”‚      â”‚                             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                           â”‚
â”‚  è¯Šæ–­æ–¹å‘ï¼š                                                               â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                                â”‚
â”‚  â€¢ è‡ªä¸Šè€Œä¸‹ï¼šä» L7 å¼€å§‹ï¼ˆåº”ç”¨æŠ¥é”™ï¼‰ â†’ é€å±‚å‘ä¸‹æ’æŸ¥                         â”‚
â”‚  â€¢ è‡ªä¸‹è€Œä¸Šï¼šä» L2 å¼€å§‹ï¼ˆç‰©ç†æ£€æŸ¥ï¼‰ â†’ é€å±‚å‘ä¸ŠéªŒè¯                         â”‚
â”‚                                                                           â”‚
â”‚  ç»éªŒæ³•åˆ™ï¼š                                                               â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                                â”‚
â”‚  â€¢ åº”ç”¨æŠ¥ "Connection refused" â†’ L4 é—®é¢˜ï¼ˆæœåŠ¡æ²¡ç›‘å¬ï¼‰                    â”‚
â”‚  â€¢ åº”ç”¨æŠ¥ "Network unreachable" â†’ L3 é—®é¢˜ï¼ˆè·¯ç”±é—®é¢˜ï¼‰                     â”‚
â”‚  â€¢ åº”ç”¨æŠ¥ "Connection timed out" â†’ å¯èƒ½ L3/L4/é˜²ç«å¢™                      â”‚
â”‚  â€¢ åº”ç”¨æŠ¥ "Name resolution failed" â†’ L7 DNS é—®é¢˜                          â”‚
â”‚                                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
<!-- /DIAGRAM -->

### 1.2 å¸¸è§é”™è¯¯ä¿¡æ¯ä¸å±‚æ¬¡æ˜ å°„

| é”™è¯¯ä¿¡æ¯ | å¯èƒ½çš„å±‚æ¬¡ | é¦–å…ˆæ£€æŸ¥ |
|----------|-----------|----------|
| `Connection refused` | L4 | æœåŠ¡æ˜¯å¦ç›‘å¬ç«¯å£ |
| `Connection timed out` | L3/L4/é˜²ç«å¢™ | ping â†’ nc â†’ é˜²ç«å¢™ |
| `Network is unreachable` | L3 | è·¯ç”±è¡¨ã€ç½‘å…³é…ç½® |
| `No route to host` | L3 | è·¯ç”±è¡¨ã€ç›®æ ‡ä¸»æœºé˜²ç«å¢™ |
| `Name or service not known` | L7 DNS | /etc/resolv.conf, dig |
| `SSL/TLS handshake failed` | L7 | è¯ä¹¦ã€æ—¶é—´åŒæ­¥ |

### 1.3 è¯Šæ–­é¡ºåºï¼šè‡ªä¸Šè€Œä¸‹ vs è‡ªä¸‹è€Œä¸Š

**è‡ªä¸Šè€Œä¸‹**ï¼ˆæ¨èï¼Œæ›´é«˜æ•ˆï¼‰ï¼š
```
åº”ç”¨æŠ¥é”™ â†’ åˆ†æé”™è¯¯ä¿¡æ¯ â†’ å®šä½å¯èƒ½å±‚æ¬¡ â†’ éªŒè¯
```

**è‡ªä¸‹è€Œä¸Š**ï¼ˆå½»åº•ï¼Œä½†è€—æ—¶ï¼‰ï¼š
```
L2 ç½‘å¡ â†’ L3 IP/è·¯ç”± â†’ L4 ç«¯å£ â†’ L7 åº”ç”¨
```

**ç»éªŒæ³•åˆ™**ï¼š
- æœ‰æ˜ç¡®é”™è¯¯ä¿¡æ¯ â†’ è‡ªä¸Šè€Œä¸‹
- å®Œå…¨ä¸é€šã€æ— é”™è¯¯ä¿¡æ¯ â†’ è‡ªä¸‹è€Œä¸Š
- é—´æ­‡æ€§é—®é¢˜ â†’ éœ€è¦æŠ“åŒ…åˆ†æ

---

## Step 2 -- Layer 1-2 è¯Šæ–­ï¼šç‰©ç†å’Œé“¾è·¯å±‚ï¼ˆ10 åˆ†é’Ÿï¼‰

### 2.1 ç½‘å¡çŠ¶æ€æ£€æŸ¥

```bash
# æŸ¥çœ‹ç½‘å¡çŠ¶æ€
ip link show

# è¾“å‡ºè§£è¯»ï¼š
# 2: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 ...
#          state UP                        â† çŠ¶æ€æ­£å¸¸
#          state DOWN                      â† ç½‘å¡æœªå¯ç”¨æˆ–çº¿ç¼†é—®é¢˜

# å¯ç”¨ç½‘å¡
ip link set eth0 up

# æŸ¥çœ‹ç½‘å¡è¯¦ç»†ä¿¡æ¯ï¼ˆç‰©ç†å±‚ï¼‰
ethtool eth0
# å…³æ³¨ï¼š
#   Link detected: yes    â† çº¿ç¼†è¿æ¥æ­£å¸¸
#   Speed: 1000Mb/s       â† é€Ÿç‡
#   Duplex: Full          â† åŒå·¥æ¨¡å¼
```

### 2.2 ç½‘å¡é”™è¯¯ç»Ÿè®¡

```bash
# æŸ¥çœ‹ç½‘å¡ç»Ÿè®¡ï¼ˆåŒ…æ‹¬é”™è¯¯ï¼‰
ip -s link show eth0

# è¾“å‡ºç¤ºä¾‹ï¼š
#     RX:  bytes packets errors dropped missed  mcast
#          1234  5678    0      0       0       0      â† æ­£å¸¸
#          1234  5678    123    456     0       0      â† æœ‰é—®é¢˜ï¼

# æ›´è¯¦ç»†çš„ç»Ÿè®¡ï¼ˆéœ€è¦ ethtoolï¼‰
ethtool -S eth0 | grep -E 'error|drop|collision'
```

### 2.3 å†…æ ¸ç½‘ç»œé”™è¯¯

```bash
# æ£€æŸ¥å†…æ ¸æ—¥å¿—ä¸­çš„ç½‘ç»œé”™è¯¯
dmesg | grep -iE 'eth|network|link|carrier' | tail -20

# å¸¸è§é”™è¯¯ï¼š
# "eth0: link down"          â† é“¾è·¯æ–­å¼€
# "eth0: NIC Link is Down"   â† ç½‘å¡è¿æ¥ä¸¢å¤±
# "carrier lost"             â† è½½æ³¢ä¿¡å·ä¸¢å¤±
```

---

## Step 3 -- Layer 3 è¯Šæ–­ï¼šç½‘ç»œå±‚ï¼ˆ20 åˆ†é’Ÿï¼‰

### 3.1 IP åœ°å€æ£€æŸ¥

```bash
# æŸ¥çœ‹ IP åœ°å€
ip addr show

# è¾“å‡ºè§£è¯»ï¼š
# 2: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500
#     inet 192.168.1.100/24 brd 192.168.1.255 scope global eth0
#          â†‘ IP åœ°å€         â†‘ å­ç½‘æ©ç        â†‘ ä½œç”¨åŸŸ

# æ£€æŸ¥ç‰¹å®šæ¥å£
ip addr show eth0

# å¸¸è§é—®é¢˜ï¼š
# - æ²¡æœ‰ IP åœ°å€ â†’ DHCP é—®é¢˜æˆ–é™æ€é…ç½®é”™è¯¯
# - IP å†²çª â†’ åŒç½‘æ®µå…¶ä»–ä¸»æœºä½¿ç”¨ç›¸åŒ IP
```

### 3.2 è·¯ç”±è¡¨æ£€æŸ¥

```bash
# æŸ¥çœ‹è·¯ç”±è¡¨
ip route

# è¾“å‡ºç¤ºä¾‹ï¼š
# default via 192.168.1.1 dev eth0        â† é»˜è®¤ç½‘å…³
# 192.168.1.0/24 dev eth0 proto kernel    â† ç›´è¿ç½‘æ®µ

# æŸ¥çœ‹åˆ°ç‰¹å®šç›®æ ‡çš„è·¯ç”±
ip route get 8.8.8.8
# è¾“å‡ºï¼š8.8.8.8 via 192.168.1.1 dev eth0 src 192.168.1.100

# å¸¸è§é—®é¢˜ï¼š
# - æ²¡æœ‰é»˜è®¤è·¯ç”± â†’ æ— æ³•è®¿é—®å¤–ç½‘
# - ç½‘å…³ä¸å¯è¾¾ â†’ ç½‘å…³é…ç½®é”™è¯¯æˆ–ç½‘å…³å®•æœº
```

### 3.3 ping æµ‹è¯•

```bash
# åŸºæœ¬ ping
ping -c 3 192.168.1.1

# æŒ‡å®šæº IPï¼ˆå¤šç½‘å¡ç¯å¢ƒï¼‰
ping -c 3 -I eth0 192.168.1.1

# ping ç»“æœè§£è¯»ï¼š
# 64 bytes from 192.168.1.1: icmp_seq=1 ttl=64 time=0.5 ms  â† æ­£å¸¸
# Request timeout                                            â† è¶…æ—¶
# Destination Host Unreachable                               â† ä¸»æœºä¸å¯è¾¾
# Network is unreachable                                     â† ç½‘ç»œä¸å¯è¾¾
```

### 3.4 traceroute å®šä½æ–­ç‚¹

```bash
# è·Ÿè¸ªè·¯ç”±ï¼ˆé»˜è®¤ UDPï¼‰
traceroute 8.8.8.8

# ä½¿ç”¨ ICMPï¼ˆéœ€è¦ rootï¼‰
traceroute -I 8.8.8.8

# ä½¿ç”¨ TCPï¼ˆç©¿è¶Šé˜²ç«å¢™ï¼‰
traceroute -T -p 80 google.com

# è¾“å‡ºè§£è¯»ï¼š
# 1  192.168.1.1    0.5 ms    â† ç¬¬ä¸€è·³ï¼ˆç½‘å…³ï¼‰
# 2  10.0.0.1       2.1 ms    â† ç¬¬äºŒè·³
# 3  * * *                    â† è¶…æ—¶ï¼ˆå¯èƒ½ä¸¢åŒ…æˆ–é˜²ç«å¢™ï¼‰
# 4  8.8.8.8        15.2 ms   â† ç›®æ ‡
```

### 3.5 mtrï¼šæ›´å¼ºå¤§çš„è·¯å¾„åˆ†æ

```bash
# mtr = ping + tracerouteï¼ŒæŒç»­ç›‘æ§
mtr -c 100 8.8.8.8

# æŠ¥å‘Šæ¨¡å¼ï¼ˆéäº¤äº’ï¼‰
mtr -r -c 100 8.8.8.8

# è¾“å‡ºå…³æ³¨ç‚¹ï¼š
#                          Loss%  Snt  Last  Avg  Best  Wrst
# 1. 192.168.1.1            0.0%  100   0.5  0.6   0.3   1.2
# 2. 10.0.0.1               5.0%  100   2.1  3.2   1.8  15.3  â† 5% ä¸¢åŒ…
# 3. ???                   100.0%  100   0.0  0.0   0.0   0.0  â† å®Œå…¨ä¸¢åŒ…
```

---

## Step 4 -- Layer 4 è¯Šæ–­ï¼šä¼ è¾“å±‚ï¼ˆ25 åˆ†é’Ÿï¼‰

### 4.1 ss å‘½ä»¤ï¼šç°ä»£ netstat æ›¿ä»£

```bash
# æŸ¥çœ‹æ‰€æœ‰ç›‘å¬ç«¯å£
ss -lntup

# å‚æ•°è§£é‡Šï¼š
# -l: åªæ˜¾ç¤ºç›‘å¬çŠ¶æ€
# -n: ä¸è§£æç«¯å£åï¼ˆæ˜¾ç¤ºæ•°å­—ï¼‰
# -t: TCP
# -u: UDP
# -p: æ˜¾ç¤ºè¿›ç¨‹ä¿¡æ¯ï¼ˆéœ€è¦ rootï¼‰

# è¾“å‡ºç¤ºä¾‹ï¼š
# Netid  State   Recv-Q  Send-Q  Local Address:Port  Peer Address:Port  Process
# tcp    LISTEN  0       128     0.0.0.0:22          0.0.0.0:*          users:(("sshd",pid=1234))
# tcp    LISTEN  0       128     0.0.0.0:80          0.0.0.0:*          users:(("nginx",pid=5678))
```

### 4.2 æ£€æŸ¥æœåŠ¡æ˜¯å¦ç›‘å¬

```bash
# æ£€æŸ¥ç‰¹å®šç«¯å£
ss -lntp | grep ':80'

# å¦‚æœæ²¡æœ‰è¾“å‡º â†’ æœåŠ¡æ²¡æœ‰åœ¨ç›‘å¬ï¼
# å¯èƒ½åŸå› ï¼š
# - æœåŠ¡æœªå¯åŠ¨
# - æœåŠ¡é…ç½®ç›‘å¬åœ¨å…¶ä»–ç«¯å£
# - æœåŠ¡ç»‘å®šåœ¨ 127.0.0.1ï¼ˆåªæ¥å—æœ¬åœ°è¿æ¥ï¼‰

# æ£€æŸ¥æœåŠ¡æ˜¯å¦åªç»‘å®šæœ¬åœ°
ss -lntp | grep nginx
# 0.0.0.0:80    â† æ¥å—æ‰€æœ‰ IP è¿æ¥
# 127.0.0.1:80  â† åªæ¥å—æœ¬åœ°è¿æ¥ï¼
```

### 4.3 nc (netcat) ç«¯å£æµ‹è¯•

```bash
# æµ‹è¯• TCP ç«¯å£è¿é€šæ€§
nc -zv 192.168.1.100 80

# è¾“å‡ºï¼š
# Connection to 192.168.1.100 80 port [tcp/http] succeeded!  â† æˆåŠŸ
# nc: connect to 192.168.1.100 port 80 (tcp) failed: Connection refused  â† æ‹’ç»
# nc: connect to 192.168.1.100 port 80 (tcp) failed: Connection timed out  â† è¶…æ—¶

# æµ‹è¯•ç«¯å£èŒƒå›´
nc -zv 192.168.1.100 80-90

# æµ‹è¯• UDP ç«¯å£
nc -zuv 192.168.1.100 53
```

### 4.4 æŸ¥çœ‹è¿æ¥çŠ¶æ€ç»Ÿè®¡

```bash
# æŸ¥çœ‹ TCP è¿æ¥ç»Ÿè®¡
ss -s

# è¾“å‡ºç¤ºä¾‹ï¼š
# Total: 1234
# TCP:   567 (estab 234, closed 123, orphaned 12, timewait 89)
#                       â†‘ æ´»è·ƒè¿æ¥                  â†‘ TIME_WAIT

# æŸ¥çœ‹ç‰¹å®šçŠ¶æ€çš„è¿æ¥
ss -tn state established          # å·²å»ºç«‹çš„è¿æ¥
ss -tn state time-wait            # TIME_WAIT çŠ¶æ€
ss -tn state close-wait           # CLOSE_WAIT çŠ¶æ€ï¼ˆå¯èƒ½èµ„æºæ³„æ¼ï¼‰

# ç»Ÿè®¡å„çŠ¶æ€æ•°é‡
ss -tan | awk '{print $1}' | sort | uniq -c | sort -rn
```

### 4.5 TCP è¿æ¥çŠ¶æ€è§£è¯»

<!-- DIAGRAM: tcp-states -->
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       TCP è¿æ¥çŠ¶æ€ä¸æ’æŸ¥                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                           â”‚
â”‚  å…³é”®çŠ¶æ€ï¼š                                                               â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                                â”‚
â”‚                                                                           â”‚
â”‚  ESTABLISHED  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ æ­£å¸¸çš„æ´»è·ƒè¿æ¥                                  â”‚
â”‚                                                                           â”‚
â”‚  TIME_WAIT   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ è¿æ¥å…³é—­åç­‰å¾…çŠ¶æ€                               â”‚
â”‚                          æŒç»­ 2*MSL (é€šå¸¸ 60ç§’)                           â”‚
â”‚                          å¤§é‡ TIME_WAIT â†’ å¯èƒ½ç«¯å£è€—å°½                    â”‚
â”‚                                                                           â”‚
â”‚  CLOSE_WAIT  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ å¯¹ç«¯å…³é—­ï¼Œæœ¬ç«¯æœªå…³é—­                             â”‚
â”‚                          å¤§é‡ CLOSE_WAIT â†’ åº”ç”¨ä»£ç é—®é¢˜ï¼ˆæœªå…³é—­è¿æ¥ï¼‰      â”‚
â”‚                                                                           â”‚
â”‚  SYN_SENT    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ å‘é€ SYNï¼Œç­‰å¾…å“åº”                               â”‚
â”‚                          é•¿æ—¶é—´åœç•™ â†’ å¯¹ç«¯æ— å“åº”æˆ–é˜²ç«å¢™ä¸¢åŒ…               â”‚
â”‚                                                                           â”‚
â”‚  FIN_WAIT1/2 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ æ­£åœ¨å…³é—­è¿æ¥                                     â”‚
â”‚                          å¤§é‡å †ç§¯ â†’ å¯¹ç«¯åº”ç”¨å¼‚å¸¸                          â”‚
â”‚                                                                           â”‚
â”‚                                                                           â”‚
â”‚  æ’æŸ¥å‘½ä»¤ï¼š                                                               â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                                â”‚
â”‚                                                                           â”‚
â”‚  # ç»Ÿè®¡å„çŠ¶æ€æ•°é‡                                                         â”‚
â”‚  ss -tan | awk 'NR>1 {print $1}' | sort | uniq -c | sort -rn              â”‚
â”‚                                                                           â”‚
â”‚  # æŸ¥çœ‹ TIME_WAIT æ•°é‡                                                    â”‚
â”‚  ss -tan state time-wait | wc -l                                          â”‚
â”‚                                                                           â”‚
â”‚  # æŸ¥çœ‹å“ªäº› IP æœ‰å¤§é‡è¿æ¥                                                 â”‚
â”‚  ss -tan | awk '{print $5}' | cut -d: -f1 | sort | uniq -c | sort -rn     â”‚
â”‚                                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
<!-- /DIAGRAM -->

---

## Step 5 -- Layer 7 è¯Šæ–­ï¼šåº”ç”¨å±‚ï¼ˆ20 åˆ†é’Ÿï¼‰

### 5.1 curl è¯¦ç»†è¯Šæ–­

```bash
# è¯¦ç»†æ¨¡å¼
curl -v http://example.com/

# è¾“å‡ºå…³é”®ä¿¡æ¯ï¼š
# * Trying 93.184.216.34:80...           â† è¿æ¥ IP
# * Connected to example.com              â† è¿æ¥æˆåŠŸ
# > GET / HTTP/1.1                        â† è¯·æ±‚å‘é€
# < HTTP/1.1 200 OK                       â† å“åº”çŠ¶æ€

# åªæ˜¾ç¤º HTTP å¤´
curl -I http://example.com/

# è®¾ç½®è¶…æ—¶
curl --connect-timeout 5 --max-time 10 http://example.com/

# æŒ‡å®š DNS è§£æï¼ˆç»•è¿‡æœ¬åœ° DNSï¼‰
curl --resolve example.com:80:93.184.216.34 http://example.com/

# ä½¿ç”¨ç‰¹å®šæº IPï¼ˆå¤šç½‘å¡ï¼‰
curl --interface eth0 http://example.com/
```

### 5.2 curl æ—¶é—´åˆ†æ

```bash
# æ˜¾ç¤ºè¯¦ç»†æ—¶é—´ä¿¡æ¯
curl -w @- -o /dev/null -s http://example.com/ <<'EOF'
    time_namelookup:  %{time_namelookup}s
       time_connect:  %{time_connect}s
    time_appconnect:  %{time_appconnect}s
   time_pretransfer:  %{time_pretransfer}s
      time_redirect:  %{time_redirect}s
 time_starttransfer:  %{time_starttransfer}s
                    ----------
         time_total:  %{time_total}s
EOF

# è¾“å‡ºè§£è¯»ï¼š
#     time_namelookup:  0.012s  â† DNS è§£ææ—¶é—´
#        time_connect:  0.025s  â† TCP è¿æ¥æ—¶é—´
#     time_appconnect:  0.100s  â† TLS æ¡æ‰‹æ—¶é—´ï¼ˆHTTPSï¼‰
#    time_pretransfer:  0.100s  â† å‡†å¤‡ä¼ è¾“æ—¶é—´
#       time_redirect:  0.000s  â† é‡å®šå‘æ—¶é—´
#  time_starttransfer:  0.150s  â† é¦–å­—èŠ‚æ—¶é—´ (TTFB)
#          time_total:  0.200s  â† æ€»æ—¶é—´

# é—®é¢˜è¯Šæ–­ï¼š
# - time_namelookup å¾ˆå¤§ â†’ DNS é—®é¢˜
# - time_connect - time_namelookup å¾ˆå¤§ â†’ ç½‘ç»œå»¶è¿Ÿæˆ–è¿æ¥é—®é¢˜
# - time_starttransfer - time_connect å¾ˆå¤§ â†’ æœåŠ¡å™¨å“åº”æ…¢
```

### 5.3 DNS è¯Šæ–­

```bash
# åŸºæœ¬æŸ¥è¯¢
dig example.com

# åªæ˜¾ç¤ºç»“æœ
dig +short example.com

# æŒ‡å®š DNS æœåŠ¡å™¨
dig @8.8.8.8 example.com

# è¿½è¸ªå®Œæ•´è§£æè¿‡ç¨‹
dig +trace example.com

# åå‘ DNS æŸ¥è¯¢
dig -x 93.184.216.34

# æŸ¥çœ‹æœ¬åœ° DNS é…ç½®
cat /etc/resolv.conf

# systemd-resolved çŠ¶æ€
resolvectl status
# æˆ–
systemd-resolve --status
```

### 5.4 DNS é—®é¢˜è¯Šæ–­æµç¨‹

<!-- DIAGRAM: dns-troubleshooting -->
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       DNS é—®é¢˜è¯Šæ–­æµç¨‹                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                           â”‚
â”‚  DNS è§£æå¤±è´¥                                                             â”‚
â”‚       â”‚                                                                   â”‚
â”‚       â–¼                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                      â”‚
â”‚  â”‚ æ£€æŸ¥ /etc/resolv.conf          â”‚                                      â”‚
â”‚  â”‚ nameserver é…ç½®æ­£ç¡®å—ï¼Ÿ         â”‚                                      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                      â”‚
â”‚                 â”‚                                                         â”‚
â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”                                                â”‚
â”‚        â”‚ é…ç½®é”™è¯¯        â”‚ é…ç½®æ­£ç¡®                                       â”‚
â”‚        â–¼                 â–¼                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚  â”‚ ä¿®å¤é…ç½®    â”‚  â”‚ dig @<nameserver> <åŸŸå>        â”‚                   â”‚
â”‚  â”‚             â”‚  â”‚ DNS æœåŠ¡å™¨èƒ½å“åº”å—ï¼Ÿ            â”‚                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚                                   â”‚                                       â”‚
â”‚                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
â”‚                          â”‚ ä¸å“åº”          â”‚ å“åº”æ­£å¸¸                     â”‚
â”‚                          â–¼                 â–¼                              â”‚
â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚                   â”‚ DNS æœåŠ¡å™¨   â”‚  â”‚ dig @8.8.8.8 <åŸŸå>      â”‚         â”‚
â”‚                   â”‚ ä¸å¯è¾¾       â”‚  â”‚ å…¬å…± DNS èƒ½è§£æå—ï¼Ÿ      â”‚         â”‚
â”‚                   â”‚              â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                   â”‚ æ£€æŸ¥ï¼š       â”‚                 â”‚                      â”‚
â”‚                   â”‚ - ping DNS   â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚                   â”‚ - é˜²ç«å¢™     â”‚        â”‚ ä¸èƒ½            â”‚ èƒ½          â”‚
â”‚                   â”‚ - ç½‘ç»œè·¯ç”±   â”‚        â–¼                 â–¼             â”‚
â”‚                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚                                     â”‚ åŸŸåæœ¬èº«é—®é¢˜ â”‚  â”‚ æœ¬åœ° DNS     â”‚   â”‚
â”‚                                     â”‚ æˆ–ä¸Šæ¸¸ DNS   â”‚  â”‚ é…ç½®/ç¼“å­˜    â”‚   â”‚
â”‚                                     â”‚ æ•…éšœ         â”‚  â”‚ é—®é¢˜         â”‚   â”‚
â”‚                                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                           â”‚
â”‚  å¸¸è§ DNS é—®é¢˜ï¼š                                                          â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                          â”‚
â”‚  â€¢ /etc/resolv.conf è¢«è¦†ç›–ï¼ˆNetworkManager, systemd-resolvedï¼‰            â”‚
â”‚  â€¢ é¦–ä¸ª nameserver ä¸å¯è¾¾ï¼ˆå¯¼è‡´ 5 ç§’è¶…æ—¶ï¼‰                                 â”‚
â”‚  â€¢ DNS ç¼“å­˜è¿‡æœŸæˆ–æ±¡æŸ“                                                      â”‚
â”‚  â€¢ systemd-resolved é…ç½®é—®é¢˜                                              â”‚
â”‚                                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
<!-- /DIAGRAM -->

### 5.5 DNS è¶…æ—¶é—®é¢˜

DNS è¶…æ—¶æ˜¯å¸¸è§çš„"ç¥ç§˜å»¶è¿Ÿ"æ¥æºï¼š

```bash
# åœºæ™¯ï¼šå‘½ä»¤å¯åŠ¨æ…¢ 5 ç§’
# åŸå› ï¼š/etc/resolv.conf ä¸­é¦–ä¸ª nameserver ä¸å¯è¾¾

# æ£€æŸ¥ resolv.conf
cat /etc/resolv.conf
# nameserver 10.0.0.1    â† å¦‚æœè¿™ä¸ªä¸å¯è¾¾ï¼Œç­‰å¾… 5 ç§’è¶…æ—¶
# nameserver 8.8.8.8

# æµ‹è¯• DNS æœåŠ¡å™¨è¿é€šæ€§
nc -zvu 10.0.0.1 53
# æˆ–
dig @10.0.0.1 google.com +time=2

# è§£å†³æ–¹æ¡ˆï¼š
# 1. è°ƒæ•´ nameserver é¡ºåº
# 2. è®¾ç½®è¶…æ—¶æ—¶é—´
echo "options timeout:1 attempts:2" >> /etc/resolv.conf
```

---

## Step 6 -- é˜²ç«å¢™è¯Šæ–­ï¼ˆ15 åˆ†é’Ÿï¼‰

### 6.1 nftables æ£€æŸ¥

```bash
# æŸ¥çœ‹æ‰€æœ‰è§„åˆ™
nft list ruleset

# æŸ¥çœ‹ç‰¹å®šè¡¨
nft list table inet filter

# æŸ¥çœ‹è§„åˆ™è®¡æ•°å™¨
nft list ruleset -a

# å¸¸è§é—®é¢˜ï¼š
# - INPUT chain é»˜è®¤ DROPï¼Œä½†æ²¡æœ‰æ”¾è¡Œè§„åˆ™
# - è§„åˆ™é¡ºåºé”™è¯¯ï¼ˆREJECT åœ¨ ACCEPT ä¹‹å‰ï¼‰
```

### 6.2 firewalld æ£€æŸ¥ï¼ˆRHEL/CentOSï¼‰

```bash
# æŸ¥çœ‹çŠ¶æ€
systemctl status firewalld

# æŸ¥çœ‹å½“å‰åŒºåŸŸ
firewall-cmd --get-active-zones

# æŸ¥çœ‹åŒºåŸŸè§„åˆ™
firewall-cmd --zone=public --list-all

# æŸ¥çœ‹æ‰€æœ‰å¼€æ”¾ç«¯å£
firewall-cmd --list-ports

# ä¸´æ—¶æ”¾è¡Œç«¯å£ï¼ˆæµ‹è¯•ç”¨ï¼‰
firewall-cmd --zone=public --add-port=8080/tcp

# æ°¸ä¹…æ”¾è¡Œ
firewall-cmd --zone=public --add-port=8080/tcp --permanent
firewall-cmd --reload
```

### 6.3 æŸ¥æ‰¾é˜²ç«å¢™ä¸¢åŒ…

```bash
# æ–¹æ³• 1ï¼šæŸ¥çœ‹ dmesg
dmesg | grep -iE 'drop|reject|block' | tail -20

# æ–¹æ³• 2ï¼šnftables æ·»åŠ æ—¥å¿—è§„åˆ™
nft add rule inet filter input log prefix "NFT-DROP: " drop

# æ–¹æ³• 3ï¼šæŸ¥çœ‹ /var/log/messages æˆ– /var/log/kern.log
grep -i 'drop\|reject\|block' /var/log/messages | tail -20

# æ–¹æ³• 4ï¼štcpdump æŠ“åŒ…åˆ†æ
tcpdump -i eth0 host 192.168.1.100 and port 80 -nn
```

### 6.4 ä¸´æ—¶ç¦ç”¨é˜²ç«å¢™ï¼ˆæ’æŸ¥ç”¨ï¼‰

```bash
# è­¦å‘Šï¼šä»…ç”¨äºæ’æŸ¥ï¼Œæ’æŸ¥åç«‹å³æ¢å¤ï¼

# ç¦ç”¨ firewalld
systemctl stop firewalld

# ç¦ç”¨ nftables
nft flush ruleset

# ç¦ç”¨ iptables
iptables -F
iptables -P INPUT ACCEPT
iptables -P FORWARD ACCEPT
iptables -P OUTPUT ACCEPT

# å¦‚æœç¦ç”¨é˜²ç«å¢™åé—®é¢˜æ¶ˆå¤± â†’ ç¡®è®¤æ˜¯é˜²ç«å¢™è§„åˆ™é—®é¢˜
# ç«‹å³æ¢å¤é˜²ç«å¢™ï¼
systemctl start firewalld
```

---

## Step 7 -- é«˜çº§ç½‘ç»œé—®é¢˜ï¼ˆ20 åˆ†é’Ÿï¼‰

### 7.1 MTU ä¸åŒ¹é…

MTUï¼ˆMaximum Transmission Unitï¼‰ä¸åŒ¹é…ä¼šå¯¼è‡´å¤§åŒ…ä¸¢å¤±ï¼Œè¡¨ç°ä¸ºï¼š
- å°æ•°æ®é‡æ­£å¸¸ï¼Œå¤§æ–‡ä»¶ä¼ è¾“å¤±è´¥
- HTTPS æ¡æ‰‹å¤±è´¥ï¼ˆè¯ä¹¦å¤ªå¤§ï¼‰
- é—´æ­‡æ€§è¿æ¥é—®é¢˜

```bash
# æŸ¥çœ‹ MTU
ip link show eth0 | grep mtu

# æµ‹è¯•è·¯å¾„ MTU
ping -M do -s 1472 192.168.1.1
# -M do: ä¸åˆ†ç‰‡
# -s 1472: æ•°æ®å¤§å° (1472 + 28 = 1500 = æ ‡å‡† MTU)

# å¦‚æœè¿”å› "Message too long" â†’ è·¯å¾„ä¸Šæœ‰æ›´å°çš„ MTU

# é€æ­¥å‡å°æ‰¾åˆ°æœ€å¤§å¯ç”¨
ping -M do -s 1400 192.168.1.1

# ä¸´æ—¶ä¿®æ”¹ MTU
ip link set eth0 mtu 1400
```

### 7.2 ä¸´æ—¶ç«¯å£è€—å°½ï¼ˆEphemeral Port Exhaustionï¼‰

è¿™æ˜¯"TCP é»‘æ´"åœºæ™¯çš„å¸¸è§åŸå› ï¼š

```bash
# æ£€æŸ¥å¯ç”¨ç«¯å£èŒƒå›´
cat /proc/sys/net/ipv4/ip_local_port_range
# 32768   60999  â† é»˜è®¤èŒƒå›´çº¦ 28000 ä¸ªç«¯å£

# æŸ¥çœ‹ TIME_WAIT è¿æ¥æ•°
ss -tan state time-wait | wc -l

# æŸ¥çœ‹åˆ°ç‰¹å®šç›®æ ‡çš„è¿æ¥æ•°
ss -tan | grep <åç«¯IP> | wc -l

# é—®é¢˜è¯Šæ–­ï¼š
# å¦‚æœ TIME_WAIT æ•°é‡æ¥è¿‘ç«¯å£èŒƒå›´ â†’ ç«¯å£è€—å°½ï¼

# è§£å†³æ–¹æ¡ˆ 1ï¼šå¯ç”¨ tcp_tw_reuse
echo 1 > /proc/sys/net/ipv4/tcp_tw_reuse
# æˆ–æ°¸ä¹…ç”Ÿæ•ˆ
echo "net.ipv4.tcp_tw_reuse = 1" >> /etc/sysctl.conf
sysctl -p

# è§£å†³æ–¹æ¡ˆ 2ï¼šæ‰©å¤§ç«¯å£èŒƒå›´
echo "10240 65535" > /proc/sys/net/ipv4/ip_local_port_range

# è§£å†³æ–¹æ¡ˆ 3ï¼šåº”ç”¨å±‚ä½¿ç”¨è¿æ¥æ± 
# è¿™æ‰æ˜¯æ ¹æœ¬è§£å†³æ–¹æ¡ˆï¼
```

### 7.3 è¿æ¥è·Ÿè¸ªè¡¨æ»¡ï¼ˆconntrack fullï¼‰

```bash
# æ£€æŸ¥ conntrack è¡¨ä½¿ç”¨
cat /proc/sys/net/netfilter/nf_conntrack_count
cat /proc/sys/net/netfilter/nf_conntrack_max

# å¦‚æœ count æ¥è¿‘ max â†’ è¡¨æ»¡äº†ï¼

# æŸ¥çœ‹ conntrack æ¡ç›®
conntrack -L | head -20

# è§£å†³æ–¹æ¡ˆï¼šå¢å¤§è¡¨å¤§å°
echo 262144 > /proc/sys/net/netfilter/nf_conntrack_max
# æˆ–æ°¸ä¹…
echo "net.netfilter.nf_conntrack_max = 262144" >> /etc/sysctl.conf

# å‡å°‘è¶…æ—¶æ—¶é—´
echo 60 > /proc/sys/net/netfilter/nf_conntrack_tcp_timeout_time_wait
```

### 7.4 å†…æ ¸ç½‘ç»œå‚æ•°æ£€æŸ¥

```bash
# æŸ¥çœ‹å…³é”®ç½‘ç»œå‚æ•°
sysctl -a | grep -E 'somaxconn|backlog|tw_reuse|port_range|conntrack'

# å…³é”®å‚æ•°è¯´æ˜ï¼š
# net.core.somaxconn              â† ç›‘å¬é˜Ÿåˆ—æœ€å¤§é•¿åº¦
# net.core.netdev_max_backlog     â† ç½‘å¡æ¥æ”¶é˜Ÿåˆ—é•¿åº¦
# net.ipv4.tcp_tw_reuse           â† é‡ç”¨ TIME_WAIT è¿æ¥
# net.ipv4.ip_local_port_range    â† ä¸´æ—¶ç«¯å£èŒƒå›´
# net.netfilter.nf_conntrack_max  â† è¿æ¥è·Ÿè¸ªè¡¨å¤§å°
```

---

## Step 8 -- ç½‘ç»œè¯Šæ–­å†³ç­–æ ‘ï¼ˆ10 åˆ†é’Ÿï¼‰

### 8.1 å®Œæ•´å†³ç­–æ ‘

<!-- DIAGRAM: network-decision-tree -->
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       ç½‘ç»œé—®é¢˜è¯Šæ–­å†³ç­–æ ‘                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                           â”‚
â”‚  è¿é€šæ€§é—®é¢˜                                                               â”‚
â”‚       â”‚                                                                   â”‚
â”‚       â–¼                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                      â”‚
â”‚  â”‚ ip link show                    â”‚                                      â”‚
â”‚  â”‚ ç½‘å¡çŠ¶æ€ UP å—ï¼Ÿ                â”‚                                      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                      â”‚
â”‚                 â”‚                                                         â”‚
â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”                                                â”‚
â”‚        â”‚ DOWN            â”‚ UP                                             â”‚
â”‚        â–¼                 â–¼                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚  â”‚ L1/L2 é—®é¢˜   â”‚  â”‚ ping <ç›®æ ‡IP>                   â”‚                   â”‚
â”‚  â”‚ æ£€æŸ¥ç½‘çº¿/   â”‚  â”‚ L3 è¿é€šå—ï¼Ÿ                     â”‚                   â”‚
â”‚  â”‚ ç½‘å¡é…ç½®    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚                                        â”‚
â”‚                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”                               â”‚
â”‚                         â”‚ ä¸é€š            â”‚ é€š                            â”‚
â”‚                         â–¼                 â–¼                               â”‚
â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚                   â”‚ L3 é—®é¢˜      â”‚  â”‚ nc -zv <IP> <PORT>              â”‚  â”‚
â”‚                   â”‚              â”‚  â”‚ L4 ç«¯å£å¼€æ”¾å—ï¼Ÿ                 â”‚  â”‚
â”‚                   â”‚ æ£€æŸ¥ï¼š       â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                   â”‚ - ip route   â”‚                 â”‚                      â”‚
â”‚                   â”‚ - ç½‘å…³       â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚                   â”‚ - é˜²ç«å¢™L3   â”‚        â”‚ æ‹’ç»/è¶…æ—¶       â”‚ æˆåŠŸ        â”‚
â”‚                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â–¼                 â–¼             â”‚
â”‚                                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚                                     â”‚ L4 é—®é¢˜      â”‚  â”‚ L7 é—®é¢˜      â”‚   â”‚
â”‚                                     â”‚              â”‚  â”‚              â”‚   â”‚
â”‚                                     â”‚ æ‹’ç»ï¼š       â”‚  â”‚ curl/dig     â”‚   â”‚
â”‚                                     â”‚ ss -lntup    â”‚  â”‚ åº”ç”¨å±‚è¯Šæ–­   â”‚   â”‚
â”‚                                     â”‚ æœåŠ¡ç›‘å¬?    â”‚  â”‚              â”‚   â”‚
â”‚                                     â”‚              â”‚  â”‚ æ£€æŸ¥ï¼š       â”‚   â”‚
â”‚                                     â”‚ è¶…æ—¶ï¼š       â”‚  â”‚ - HTTP å“åº”  â”‚   â”‚
â”‚                                     â”‚ é˜²ç«å¢™L4     â”‚  â”‚ - DNS è§£æ   â”‚   â”‚
â”‚                                     â”‚ nft/firewall â”‚  â”‚ - åº”ç”¨æ—¥å¿—   â”‚   â”‚
â”‚                                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
<!-- /DIAGRAM -->

### 8.2 å¿«é€Ÿè¯Šæ–­è„šæœ¬

```bash
#!/bin/bash
# network-diag.sh - å¿«é€Ÿç½‘ç»œè¯Šæ–­è„šæœ¬

TARGET=${1:-"8.8.8.8"}
PORT=${2:-"80"}

echo "=========================================="
echo "Network Diagnosis for $TARGET:$PORT"
echo "=========================================="

echo ""
echo "[1] Local Network Interface"
ip link show | grep -E '^[0-9]+:|state'

echo ""
echo "[2] IP Address"
ip addr show | grep 'inet '

echo ""
echo "[3] Default Route"
ip route | grep default

echo ""
echo "[4] L3 - Ping Test"
ping -c 3 -W 2 $TARGET 2>&1 | tail -3

echo ""
echo "[5] L4 - Port Test"
nc -zv -w 3 $TARGET $PORT 2>&1

echo ""
echo "[6] Local Listening Ports"
ss -lntup | head -10

echo ""
echo "[7] DNS Resolution"
dig +short $TARGET 2>/dev/null || echo "Not a hostname or dig not available"

echo ""
echo "[8] Connection Statistics"
ss -s | head -5

echo ""
echo "=========================================="
echo "Done"
echo "=========================================="
```

---

## Step 9 -- å®æˆ˜åœºæ™¯ï¼šTCP é»‘æ´ï¼ˆ25 åˆ†é’Ÿï¼‰

### 9.1 åœºæ™¯æè¿°

> **åœºæ™¯**ï¼šNginx åå‘ä»£ç†é—´æ­‡æ€§è¿”å› 502 Bad Gatewayã€‚  
>
> è¡¨ç°ï¼š  
> - å¤§éƒ¨åˆ†è¯·æ±‚æ­£å¸¸  
> - å¶å°”è¿”å› 502ï¼Œå‡ ç§’åæ¢å¤  
> - åç«¯æœåŠ¡å¥åº·æ£€æŸ¥æ­£å¸¸  
> - é—®é¢˜åœ¨é«˜å³°æœŸæ›´é¢‘ç¹  

### 9.2 æ’æŸ¥æ­¥éª¤

**Step 1ï¼šæŸ¥çœ‹ Nginx é”™è¯¯æ—¥å¿—**

```bash
tail -f /var/log/nginx/error.log

# è¾“å‡ºï¼š
# connect() failed (99: Cannot assign requested address) while connecting to upstream
#                     â†‘ å…³é”®ï¼æ— æ³•åˆ†é…åœ°å€ = ç«¯å£è€—å°½
```

**Step 2ï¼šæ£€æŸ¥ TCP è¿æ¥çŠ¶æ€**

```bash
# æŸ¥çœ‹è¿æ¥ç»Ÿè®¡
ss -s

# è¾“å‡ºï¼š
# TCP:   28567 (estab 234, closed 123, orphaned 12, timewait 27890)
#                                                      â†‘ å¤§é‡ TIME_WAIT

# æŸ¥çœ‹ TIME_WAIT æ•°é‡
ss -tan state time-wait | wc -l
# 27890

# æŸ¥çœ‹ç«¯å£èŒƒå›´
cat /proc/sys/net/ipv4/ip_local_port_range
# 32768   60999  â† çº¦ 28000 ä¸ªç«¯å£
# TIME_WAIT å·²å ç”¨ 27890 ä¸ªï¼å‡ ä¹è€—å°½ï¼
```

**Step 3ï¼šç¡®è®¤è¿æ¥ç›®æ ‡**

```bash
# æŸ¥çœ‹ TIME_WAIT è¿æ¥åˆ°å“ªé‡Œ
ss -tan state time-wait | awk '{print $4}' | cut -d: -f1 | sort | uniq -c | sort -rn | head -5

# è¾“å‡ºï¼š
# 25000 10.0.0.100    â† å¤§é‡è¿æ¥åˆ°åç«¯æœåŠ¡å™¨
# 2000  10.0.0.101
```

**Step 4ï¼šåˆ†ææ ¹å› **

```
é—®é¢˜é“¾ï¼š
1. Nginx åˆ°åç«¯ä½¿ç”¨çŸ­è¿æ¥ï¼ˆæ¯ä¸ªè¯·æ±‚æ–°å»º TCP è¿æ¥ï¼‰
2. è¿æ¥å…³é—­åè¿›å…¥ TIME_WAIT çŠ¶æ€ï¼ˆç­‰å¾… 2*MSL = 60ç§’ï¼‰
3. é«˜å³°æœŸæ¯ç§’ 500 è¯·æ±‚ï¼Œ60 ç§’å†…ç´¯ç§¯ 30000 ä¸ª TIME_WAIT
4. ä¸´æ—¶ç«¯å£èŒƒå›´åªæœ‰ 28000 ä¸ª
5. ç«¯å£è€—å°½ â†’ æ— æ³•å»ºç«‹æ–°è¿æ¥ â†’ 502
```

**Step 5ï¼šä¸´æ—¶è§£å†³**

```bash
# å¯ç”¨ TIME_WAIT é‡ç”¨
echo 1 > /proc/sys/net/ipv4/tcp_tw_reuse

# æ‰©å¤§ç«¯å£èŒƒå›´
echo "10240 65535" > /proc/sys/net/ipv4/ip_local_port_range

# æ°¸ä¹…ç”Ÿæ•ˆ
cat >> /etc/sysctl.conf << EOF
net.ipv4.tcp_tw_reuse = 1
net.ipv4.ip_local_port_range = 10240 65535
EOF
sysctl -p
```

**Step 6ï¼šæ ¹æœ¬è§£å†³ï¼ˆåº”ç”¨å±‚ï¼‰**

```nginx
# nginx.conf - å¯ç”¨è¿æ¥æ± ï¼ˆkeepaliveï¼‰
upstream backend {
    server 10.0.0.100:8080;
    server 10.0.0.101:8080;

    keepalive 100;  # ä¿æŒ 100 ä¸ªé•¿è¿æ¥
}

server {
    location / {
        proxy_pass http://backend;
        proxy_http_version 1.1;
        proxy_set_header Connection "";  # ä½¿ç”¨é•¿è¿æ¥
    }
}
```

### 9.3 éªŒè¯ä¿®å¤

```bash
# é‡å¯ Nginx
nginx -t && systemctl reload nginx

# ç›‘æ§ TIME_WAIT æ•°é‡
watch -n 1 'ss -tan state time-wait | wc -l'

# åº”è¯¥çœ‹åˆ° TIME_WAIT æ•°é‡æ˜¾è‘—ä¸‹é™
```

---

## Step 10 -- å®æˆ˜åœºæ™¯ï¼šDNS è¶…æ—¶ï¼ˆ15 åˆ†é’Ÿï¼‰

### 10.1 åœºæ™¯æè¿°

> **åœºæ™¯**ï¼šCLI å·¥å…·ï¼ˆå¦‚ curl æˆ–è‡ªå®šä¹‰è„šæœ¬ï¼‰å¯åŠ¨éœ€è¦ 5 ç§’ï¼Œç„¶åè¿è¡Œæ­£å¸¸ã€‚  
>
> è¡¨ç°ï¼š  
> - ä»»ä½•ç½‘ç»œå‘½ä»¤éƒ½å»¶è¿Ÿ 5 ç§’  
> - å»¶è¿Ÿåå·¥ä½œæ­£å¸¸  
> - é‡å¯åé—®é¢˜ä¾æ—§  

### 10.2 æ’æŸ¥æ­¥éª¤

**Step 1ï¼šä½¿ç”¨ strace å®šä½é˜»å¡**

```bash
strace -tt -T -o /tmp/trace.log curl -s http://example.com/

# æŸ¥çœ‹è€—æ—¶æœ€é•¿çš„ç³»ç»Ÿè°ƒç”¨
grep -E '\<[0-9]+\.[0-9]{3,}\>' /tmp/trace.log | sort -t= -k2 -n | tail -10

# è¾“å‡ºå¯èƒ½æ˜¾ç¤ºï¼š
# 14:30:01.123 poll([{fd=3, events=POLLIN}], 1, 5000) = 0 (Timeout) <5.001234>
#                                                        â†‘ poll è¶…æ—¶ 5 ç§’ï¼
```

**Step 2ï¼šè¯†åˆ« DNS è¶…æ—¶**

```bash
# æŸ¥çœ‹è¶…æ—¶å‰åçš„ç³»ç»Ÿè°ƒç”¨
grep -B 5 -A 5 'Timeout' /tmp/trace.log

# é€šå¸¸ä¼šçœ‹åˆ°ï¼š
# socket(AF_INET, SOCK_DGRAM, IPPROTO_UDP) = 3
# connect(3, {sa_family=AF_INET, sin_port=53, sin_addr=inet_addr("10.0.0.1")}, 16) = 0
# sendto(3, "...", 28, 0, NULL, 0) = 28
# poll([{fd=3, events=POLLIN}], 1, 5000) = 0 (Timeout)
#      â†‘ å‘ 10.0.0.1:53 (DNS) å‘é€è¯·æ±‚åè¶…æ—¶
```

**Step 3ï¼šæ£€æŸ¥ DNS é…ç½®**

```bash
cat /etc/resolv.conf
# nameserver 10.0.0.1    â† é¦–ä¸ª DNS ä¸å¯è¾¾
# nameserver 8.8.8.8

# æµ‹è¯•é¦–ä¸ª DNS
nc -zvu -w 1 10.0.0.1 53
# nc: connect to 10.0.0.1 port 53 (udp) failed: Connection timed out

# æµ‹è¯•ç¬¬äºŒä¸ª DNS
nc -zvu -w 1 8.8.8.8 53
# Connection to 8.8.8.8 53 port [udp/domain] succeeded!
```

**Step 4ï¼šè§£å†³æ–¹æ¡ˆ**

```bash
# æ–¹æ¡ˆ 1ï¼šç§»é™¤ä¸å¯è¾¾çš„ DNS
# ç¼–è¾‘ /etc/resolv.confï¼Œåˆ é™¤æˆ–æ³¨é‡Š 10.0.0.1

# æ–¹æ¡ˆ 2ï¼šè°ƒæ•´è¶…æ—¶è®¾ç½®
cat > /etc/resolv.conf << EOF
nameserver 8.8.8.8
nameserver 10.0.0.1
options timeout:1 attempts:2
EOF

# æ–¹æ¡ˆ 3ï¼šå¦‚æœä½¿ç”¨ NetworkManager
nmcli con mod "System eth0" ipv4.dns "8.8.8.8"
nmcli con up "System eth0"

# æ–¹æ¡ˆ 4ï¼šå¦‚æœä½¿ç”¨ systemd-resolved
# ç¼–è¾‘ /etc/systemd/resolved.conf
# [Resolve]
# DNS=8.8.8.8
# FallbackDNS=1.1.1.1
systemctl restart systemd-resolved
```

---

## åŠ¨æ‰‹å®éªŒï¼ˆ30 åˆ†é’Ÿï¼‰

### å®éªŒ 1ï¼šåˆ†å±‚è¯Šæ–­ç»ƒä¹ 

åœ¨ä½ çš„æµ‹è¯•ç¯å¢ƒä¸­å®Œæˆä»¥ä¸‹è¯Šæ–­ï¼š

```bash
# 1. L2 æ£€æŸ¥
ip link show
# è®°å½•ï¼šç½‘å¡çŠ¶æ€ï¼Œæ˜¯å¦æœ‰ errors

# 2. L3 æ£€æŸ¥
ip addr show
ip route
ping -c 3 <é»˜è®¤ç½‘å…³>
# è®°å½•ï¼šIP é…ç½®ï¼Œè·¯ç”±ï¼Œç½‘å…³è¿é€šæ€§

# 3. L4 æ£€æŸ¥
ss -lntup
nc -zv <æŸä¸ªæœåŠ¡å™¨> 22
# è®°å½•ï¼šç›‘å¬ç«¯å£ï¼Œè¿œç¨‹ç«¯å£è¿é€šæ€§

# 4. L7 æ£€æŸ¥
curl -v http://example.com/
dig example.com
# è®°å½•ï¼šHTTP å“åº”ï¼ŒDNS è§£æ
```

### å®éªŒ 2ï¼šæ¨¡æ‹Ÿç«¯å£è€—å°½

```bash
# è­¦å‘Šï¼šä»…åœ¨æµ‹è¯•ç¯å¢ƒæ‰§è¡Œï¼

# 1. è®¾ç½®ä¸€ä¸ªå°çš„ç«¯å£èŒƒå›´
echo "60000 60100" > /proc/sys/net/ipv4/ip_local_port_range

# 2. åˆ›å»ºå¤§é‡è¿æ¥
for i in $(seq 1 100); do
    nc -z example.com 80 &
done
wait

# 3. è§‚å¯Ÿ TIME_WAIT
ss -tan state time-wait | wc -l

# 4. å°è¯•æ–°è¿æ¥
curl http://example.com/
# å¯èƒ½ä¼šçœ‹åˆ° "Cannot assign requested address"

# 5. æ¢å¤ç«¯å£èŒƒå›´
echo "32768 60999" > /proc/sys/net/ipv4/ip_local_port_range
```

### å®éªŒ 3ï¼šDNS è¯Šæ–­ç»ƒä¹ 

```bash
# 1. æŸ¥çœ‹å½“å‰ DNS é…ç½®
cat /etc/resolv.conf

# 2. æµ‹è¯• DNS è§£ææ—¶é—´
time dig google.com

# 3. è¿½è¸ªå®Œæ•´è§£æè¿‡ç¨‹
dig +trace google.com

# 4. ä½¿ç”¨ä¸åŒ DNS æœåŠ¡å™¨
dig @8.8.8.8 google.com +short
dig @1.1.1.1 google.com +short

# 5. æµ‹è¯• DNS æœåŠ¡å™¨è¿é€šæ€§
for dns in 8.8.8.8 1.1.1.1 9.9.9.9; do
    echo -n "$dns: "
    nc -zvu -w 1 $dns 53 2>&1 | grep -o 'succeeded\|failed'
done
```

---

## åæ¨¡å¼ï¼šå¸¸è§é”™è¯¯

### é”™è¯¯ 1ï¼šåªç›¯ç½‘ç»œ

```bash
# é”™è¯¯ï¼šç›´æ¥å‡è®¾æ˜¯ç½‘ç»œé—®é¢˜
ping <æœåŠ¡å™¨>  # é€šäº†
# "ç½‘ç»œæ²¡é—®é¢˜å•Šï¼Œè‚¯å®šæ˜¯åº”ç”¨çš„é—®é¢˜"

# æ­£ç¡®ï¼šåˆ†å±‚éªŒè¯
ss -lntup | grep ':80'  # å…ˆæ£€æŸ¥æœåŠ¡æ˜¯å¦ç›‘å¬
nc -zv <æœåŠ¡å™¨> 80       # å†æ£€æŸ¥ç«¯å£è¿é€šæ€§
curl -v http://<æœåŠ¡å™¨>/ # æœ€åæ£€æŸ¥åº”ç”¨å±‚
```

### é”™è¯¯ 2ï¼šå¿½ç•¥ DNS

```bash
# é”™è¯¯ï¼šä¸è€ƒè™‘ DNS é—®é¢˜
curl http://api.example.com/  # è¶…æ—¶
# "æœåŠ¡å™¨æŒ‚äº†ï¼"

# æ­£ç¡®ï¼šå…ˆæ£€æŸ¥ DNS
dig api.example.com +short
# å¦‚æœè¿”å›ç©ºæˆ–è¶…æ—¶ â†’ DNS é—®é¢˜ï¼Œä¸æ˜¯æœåŠ¡å™¨é—®é¢˜
```

### é”™è¯¯ 3ï¼šåªçœ‹ ping

```bash
# é”™è¯¯ï¼šping é€šå°±è®¤ä¸ºæ²¡é—®é¢˜
ping <æœåŠ¡å™¨>  # æˆåŠŸ
# "ç½‘ç»œæ­£å¸¸"

# æ­£ç¡®ï¼šping åªæµ‹è¯• L3
# ping é€šä¸ä»£è¡¨ï¼š
# - æœåŠ¡ç«¯å£å¼€æ”¾ï¼ˆL4ï¼‰
# - åº”ç”¨æ­£å¸¸å“åº”ï¼ˆL7ï¼‰
# - é˜²ç«å¢™å…è®¸ä¸šåŠ¡æµé‡

nc -zv <æœåŠ¡å™¨> 80  # æ£€æŸ¥ L4
curl -I http://<æœåŠ¡å™¨>/  # æ£€æŸ¥ L7
```

### é”™è¯¯ 4ï¼šä¸´æ—¶ç«¯å£é—®é¢˜å¿½ç•¥

```bash
# é”™è¯¯ï¼šåªçœ‹æ˜¯å¦æœ‰è¿æ¥
ss -tan | wc -l
# "è¿æ¥æ•°ä¸å¤šå•Š"

# æ­£ç¡®ï¼šæ£€æŸ¥ TIME_WAIT
ss -tan state time-wait | wc -l
# TIME_WAIT ä¹Ÿå ç”¨ç«¯å£ï¼
```

---

## èŒåœºå°è´´å£«ï¼ˆJapan IT Contextï¼‰

### ç½‘ç»œæ’æŸ¥åŸºæœ¬åŠŸï¼ˆãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯éšœå®³ã®åˆ‡ã‚Šåˆ†ã‘ï¼‰

åœ¨æ—¥æœ¬ IT ç°åœºï¼Œç½‘ç»œæ’æŸ¥èƒ½åŠ›æ˜¯åŸºæœ¬æŠ€èƒ½ï¼š

| æ—¥è¯­æœ¯è¯­ | å«ä¹‰ | åœºæ™¯ |
|----------|------|------|
| ç–é€šç¢ºèª | è¿é€šæ€§ç¡®è®¤ | ping/nc æµ‹è¯• |
| åˆ‡ã‚Šåˆ†ã‘ | é—®é¢˜éš”ç¦» | åˆ†å±‚è¯Šæ–­ |
| è¨¼è·¡ | è¯æ®/è®°å½• | æˆªå›¾å‘½ä»¤è¾“å‡º |
| ä¸€æ¬¡åˆ‡ã‚Šåˆ†ã‘ | åˆæ­¥éš”ç¦» | ç¡®å®šé—®é¢˜åœ¨å“ªä¸€å±‚ |
| è©³ç´°èª¿æŸ» | è¯¦ç»†è°ƒæŸ¥ | tcpdump ç­‰æ·±å…¥åˆ†æ |

### ç½‘ç»œæ’æŸ¥æŠ¥å‘Šè¦ç‚¹

æ—¥æœ¬ä¼ä¸šçš„ç½‘ç»œæ•…éšœæŠ¥å‘Šéœ€è¦ï¼š

```markdown
# ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯éšœå®³ åˆ‡ã‚Šåˆ†ã‘çµæœ

## ç¢ºèªæ—¥æ™‚
2026-01-10 14:30 (JST)

## äº‹è±¡
API ã‚µãƒ¼ãƒãƒ¼ã¸ã®æ¥ç¶šãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ

## åˆ‡ã‚Šåˆ†ã‘çµæœ
| ç¢ºèªé …ç›® | ã‚³ãƒãƒ³ãƒ‰ | çµæœ |
|----------|----------|------|
| L3 ç–é€š | ping 192.168.1.100 | OK |
| L4 ãƒãƒ¼ãƒˆ | nc -zv 192.168.1.100 80 | NG (Connection refused) |
| ã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ…‹ | systemctl status nginx | inactive (dead) |

## åŸå› 
nginx ã‚µãƒ¼ãƒ“ã‚¹ãŒåœæ­¢ã—ã¦ã„ãŸ

## å¯¾å¿œ
systemctl start nginx ã§ã‚µãƒ¼ãƒ“ã‚¹èµ·å‹•
```

### ä¿ç•™è¯æ®çš„é‡è¦æ€§

```bash
# åœ¨æ—¥æœ¬ä¼ä¸šï¼Œ"è¯æ®"éå¸¸é‡è¦
# æ’æŸ¥è¿‡ç¨‹ä¸­åŠ¡å¿…ä¿å­˜è¾“å‡º

# ä¿å­˜ç½‘ç»œè¯Šæ–­ç»“æœ
{
    echo "=== $(date) ==="
    echo ""
    echo "--- ip link ---"
    ip link show
    echo ""
    echo "--- ip addr ---"
    ip addr show
    echo ""
    echo "--- ip route ---"
    ip route
    echo ""
    echo "--- ss -lntup ---"
    ss -lntup
    echo ""
    echo "--- ping test ---"
    ping -c 3 <ç›®æ ‡>
} > /tmp/network-diag-$(date +%Y%m%d-%H%M%S).txt
```

### é¢è¯•å¸¸è§é—®é¢˜

**Q1: ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯éšœå®³ãŒç™ºç”Ÿã—ãŸå ´åˆã€ã©ã®ã‚ˆã†ã«åˆ‡ã‚Šåˆ†ã‘ã¾ã™ã‹ï¼Ÿ**
ï¼ˆç½‘ç»œæ•…éšœå‘ç”Ÿæ—¶ï¼Œå¦‚ä½•è¿›è¡Œé—®é¢˜éš”ç¦»ï¼Ÿï¼‰

å‚è€ƒç­”æ¡ˆï¼š
1. åˆ†å±¤ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã§åˆ‡ã‚Šåˆ†ã‘ã¾ã™
2. ã¾ãš L3ï¼ˆpingï¼‰ã§ IP ãƒ¬ãƒ™ãƒ«ã®ç–é€šã‚’ç¢ºèª
3. æ¬¡ã« L4ï¼ˆnc -zvï¼‰ã§ãƒãƒ¼ãƒˆã®ç–é€šã‚’ç¢ºèª
4. æœ€å¾Œã« L7ï¼ˆcurlï¼‰ã§ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å±¤ã‚’ç¢ºèª
5. å„å±¤ã§å•é¡ŒãŒè¦‹ã¤ã‹ã‚Œã°ã€ãã®å±¤ã‚’è©³ç´°èª¿æŸ»ã—ã¾ã™

**Q2: DNS ã®å•é¡Œã‚’ã©ã®ã‚ˆã†ã«è¨ºæ–­ã—ã¾ã™ã‹ï¼Ÿ**
ï¼ˆDNS é—®é¢˜å¦‚ä½•è¯Šæ–­ï¼Ÿï¼‰

å‚è€ƒç­”æ¡ˆï¼š
1. /etc/resolv.conf ã® nameserver è¨­å®šã‚’ç¢ºèª
2. dig ã‚³ãƒãƒ³ãƒ‰ã§åå‰è§£æ±ºã‚’ãƒ†ã‚¹ãƒˆ
3. dig @8.8.8.8 ã§å…¬é–‹ DNS ã¨ã®æ¯”è¼ƒ
4. DNS ã‚µãƒ¼ãƒãƒ¼ã¸ã®ç–é€šï¼ˆnc -zvu <DNS> 53ï¼‰ã‚’ç¢ºèª
5. å¿…è¦ã«å¿œã˜ã¦ dig +trace ã§è§£æ±ºçµŒè·¯ã‚’è¿½è·¡

**Q3: ã€ŒCannot assign requested addressã€ã‚¨ãƒ©ãƒ¼ã®åŸå› ã¯ï¼Ÿ**

å‚è€ƒç­”æ¡ˆï¼š
- ä¸€æ™‚ãƒãƒ¼ãƒˆã®æ¯æ¸‡ãŒåŸå› ã§ã™
- ss -s ã§ TIME_WAIT æ•°ã‚’ç¢ºèªã—ã¾ã™
- è§£æ±ºç­–ï¼š
  - tcp_tw_reuse ã‚’æœ‰åŠ¹åŒ–
  - ip_local_port_range ã‚’æ‹¡å¤§
  - ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å´ã§ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ãƒ—ãƒ¼ãƒ«ã‚’ä½¿ç”¨

---

## æ£€æŸ¥æ¸…å•

å®Œæˆæœ¬è¯¾åï¼Œä½ åº”è¯¥èƒ½å¤Ÿï¼š

- [ ] è§£é‡Šç½‘ç»œå››å±‚è¯Šæ–­æ¨¡å‹ï¼ˆL2/L3/L4/L7ï¼‰
- [ ] ä½¿ç”¨ ip link/addr/route è¯Šæ–­ L2/L3 é—®é¢˜
- [ ] ä½¿ç”¨ ss -lntup æ£€æŸ¥æœåŠ¡ç›‘å¬çŠ¶æ€
- [ ] ä½¿ç”¨ nc -zv æµ‹è¯•ç«¯å£è¿é€šæ€§
- [ ] ä½¿ç”¨ dig è¯Šæ–­ DNS é—®é¢˜
- [ ] æ£€æŸ¥ /etc/resolv.conf é…ç½®
- [ ] ä½¿ç”¨ firewall-cmd æˆ– nft æ£€æŸ¥é˜²ç«å¢™è§„åˆ™
- [ ] è§£é‡Š TIME_WAIT çŠ¶æ€åŠå…¶å½±å“
- [ ] è¯Šæ–­ä¸´æ—¶ç«¯å£è€—å°½é—®é¢˜
- [ ] ä½¿ç”¨ curl æ—¶é—´åˆ†æå®šä½å»¶è¿Ÿæ¥æº
- [ ] ä½¿ç”¨ç½‘ç»œè¯Šæ–­å†³ç­–æ ‘ç³»ç»Ÿæ€§æ’æŸ¥é—®é¢˜

---

## æœ¬è¯¾å°ç»“

| æ¦‚å¿µ | å…³é”®å‘½ä»¤ | è®°å¿†ç‚¹ |
|------|----------|--------|
| L2 è¯Šæ–­ | ip link, ethtool | ç½‘å¡çŠ¶æ€ï¼Œç‰©ç†è¿æ¥ |
| L3 è¯Šæ–­ | ping, traceroute, ip route | IP å±‚è¿é€šæ€§ï¼Œè·¯ç”± |
| L4 è¯Šæ–­ | ss -lntup, nc -zv | ç«¯å£ç›‘å¬ï¼ŒTCP è¿æ¥ |
| L7 è¯Šæ–­ | curl -v, dig | HTTP å“åº”ï¼ŒDNS è§£æ |
| DNS é—®é¢˜ | dig, /etc/resolv.conf | é¦–ä¸ª nameserver ä¸å¯è¾¾ = 5ç§’è¶…æ—¶ |
| é˜²ç«å¢™ | nft list, firewall-cmd | å…ˆæ£€æŸ¥è§„åˆ™å†è´£æ€ªç½‘ç»œ |
| ç«¯å£è€—å°½ | ss -tan state time-wait | TIME_WAIT ç´¯ç§¯å¯¼è‡´ 502 |
| MTU é—®é¢˜ | ping -M do -s 1472 | å¤§åŒ…ä¸é€šã€å°åŒ…æ­£å¸¸ |

**æ ¸å¿ƒç†å¿µ**ï¼š

> åˆ†å±‚è¯Šæ–­ï¼Œé€å±‚éªŒè¯ã€‚  
> ping é€šä¸ä»£è¡¨æœåŠ¡å¯ç”¨ã€‚  
> DNS é—®é¢˜å¸¸è¢«è¯¯è¯Šã€‚  
> TIME_WAIT ä¹Ÿå ç«¯å£ã€‚  

---

## å»¶ä¼¸é˜…è¯»

- [Brendan Gregg - Linux Network Performance](https://www.brendangregg.com/networking.html)
- [Red Hat - Network Troubleshooting](https://docs.redhat.com/en/documentation/red_hat_enterprise_linux/9/html/configuring_and_managing_networking/index)
- [TCP/IP Guide](http://www.tcpipguide.com/)
- ä¸‹ä¸€è¯¾ï¼š[05 - å­˜å‚¨æ•…éšœ](../05-storage-issues/) -- å®¹é‡ã€inodeã€I/O é”™è¯¯
- ç›¸å…³è¯¾ç¨‹ï¼š[LX06-NETWORK](../../lx06-networking/) -- ç½‘ç»œåŸºç¡€çŸ¥è¯†

---

## ç³»åˆ—å¯¼èˆª

[<-- 03 - æœåŠ¡æ•…éšœ](../03-service-failures/) | [ç³»åˆ—é¦–é¡µ](../) | [05 - å­˜å‚¨æ•…éšœ -->](../05-storage-issues/)
