# 02 - å¯åŠ¨æ•…éšœï¼ˆBoot Issuesï¼‰

> **ç›®æ ‡**ï¼šç³»ç»Ÿæ€§è¯Šæ–­å’Œæ¢å¤ Linux å¯åŠ¨æ•…éšœ  
> **å‰ç½®**ï¼šLX05-SYSTEMD æœåŠ¡ç®¡ç†åŸºç¡€ï¼ŒLX07-STORAGE å­˜å‚¨åŸºç¡€  
> **æ—¶é—´**ï¼šâš¡ 35 åˆ†é’Ÿï¼ˆé€Ÿè¯»ï¼‰/ ğŸ”¬ 130 åˆ†é’Ÿï¼ˆå®Œæ•´å®æ“ï¼‰  
> **å®æˆ˜åœºæ™¯**ï¼šæœåŠ¡å™¨ç»´æŠ¤é‡å¯åæ— æ³•å¯åŠ¨  

---

## å°†å­¦åˆ°çš„å†…å®¹

1. ç†è§£ Linux å®Œæ•´å¯åŠ¨æµç¨‹ï¼ˆBIOS/UEFI -> GRUB -> Kernel -> initramfs -> systemdï¼‰
2. åŒºåˆ†ä¸åŒå¯åŠ¨é˜¶æ®µçš„æ•…éšœç—‡çŠ¶
3. ä½¿ç”¨ GRUB å‘½ä»¤è¡Œæ‰‹åŠ¨å¼•å¯¼ç³»ç»Ÿ
4. é‡å»ºæŸåçš„ initramfs
5. ä½¿ç”¨ Emergency Mode å’Œ Rescue Mode ä¿®å¤ç³»ç»Ÿ
6. è§£å†³ /etc/fstab å¯¼è‡´çš„å¯åŠ¨å¤±è´¥

---

## å…ˆè·‘èµ·æ¥ï¼ï¼ˆ10 åˆ†é’Ÿï¼‰

> æœåŠ¡å™¨æ˜¨å¤©è¿˜å¥½å¥½çš„ï¼Œä»Šå¤©é‡å¯åè¿›ä¸å»äº†ã€‚  
> å…ˆä¸ç®¡ç†è®ºï¼Œç”¨è¿™å‡ æ¡å‘½ä»¤å¿«é€Ÿå®šä½å¯åŠ¨é˜¶æ®µï¼š  

```bash
# æŸ¥çœ‹ä¸Šæ¬¡å¯åŠ¨çš„æ—¥å¿—ï¼ˆä»å½“å‰ç³»ç»Ÿï¼‰
journalctl -b -1 -p err

# å¦‚æœå·²ç»è¿›å…¥ç³»ç»Ÿï¼ŒæŸ¥çœ‹å¯åŠ¨è€—æ—¶
systemd-analyze

# æŸ¥çœ‹å¯åŠ¨å…³é”®é“¾
systemd-analyze critical-chain

# æ£€æŸ¥æ˜¯å¦æœ‰å¤±è´¥çš„æœåŠ¡é˜»å¡å¯åŠ¨
systemctl --failed

# æŸ¥çœ‹ fstab æŒ‚è½½çŠ¶æ€
systemctl list-units --type=mount --state=failed
```

**ä½ åˆšåˆšå®šä½äº†å¯åŠ¨å¯èƒ½å¡ä½çš„é˜¶æ®µï¼**

å¯åŠ¨æ•…éšœä¸å¯æ€•ï¼Œå¯æ€•çš„æ˜¯ç›²ç›®ä¹±è¯•ã€‚ç†è§£å¯åŠ¨æµç¨‹åï¼Œä½ èƒ½å‡†ç¡®å®šä½é—®é¢˜å‡ºåœ¨å“ªä¸ªé˜¶æ®µã€‚

ç°åœ¨è®©æˆ‘ä»¬ç³»ç»Ÿå­¦ä¹  Linux å¯åŠ¨æµç¨‹å’Œæ•…éšœæ’æŸ¥æ–¹æ³•ã€‚

---

## Step 1 -- Linux å¯åŠ¨æµç¨‹å…¨æ™¯å›¾ï¼ˆ15 åˆ†é’Ÿï¼‰

### 1.1 å¯åŠ¨äº”é˜¶æ®µ

ç†è§£å¯åŠ¨æµç¨‹æ˜¯è¯Šæ–­çš„å‰æã€‚Linux å¯åŠ¨åˆ†ä¸ºäº”ä¸ªé˜¶æ®µï¼š

<!-- DIAGRAM: boot-process-flow -->
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Linux å¯åŠ¨æµç¨‹ï¼ˆBoot Processï¼‰                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   Stage 1   â”‚â”€â”€â”€â–¶â”‚   Stage 2   â”‚â”€â”€â”€â–¶â”‚   Stage 3   â”‚â”€â”€â”€â–¶â”‚   Stage 4   â”‚  â”‚
â”‚  â”‚ BIOS/UEFI   â”‚    â”‚    GRUB2    â”‚    â”‚   Kernel    â”‚    â”‚  initramfs  â”‚  â”‚
â”‚  â”‚             â”‚    â”‚             â”‚    â”‚             â”‚    â”‚             â”‚  â”‚
â”‚  â”‚ ç¡¬ä»¶åˆå§‹åŒ–  â”‚    â”‚  å¼•å¯¼åŠ è½½å™¨  â”‚    â”‚  å†…æ ¸åŠ è½½   â”‚    â”‚  ä¸´æ—¶æ ¹æ–‡ä»¶ â”‚  â”‚
â”‚  â”‚ æŸ¥æ‰¾å¯åŠ¨ç›˜  â”‚    â”‚  é€‰æ‹©å†…æ ¸   â”‚    â”‚  ç¡¬ä»¶æ¢æµ‹   â”‚    â”‚  ç³»ç»ŸæŒ‚è½½   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                  â”‚         â”‚
â”‚                                                                  â–¼         â”‚
â”‚                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚                           â”‚              Stage 5: systemd               â”‚  â”‚
â”‚                           â”‚                                             â”‚  â”‚
â”‚                           â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚                           â”‚  â”‚ basic   â”‚â”€â–¶â”‚ multi-  â”‚â”€â–¶â”‚ graphical/  â”‚  â”‚  â”‚
â”‚                           â”‚  â”‚ .target â”‚  â”‚ user    â”‚  â”‚ multi-user  â”‚  â”‚  â”‚
â”‚                           â”‚  â”‚         â”‚  â”‚ .target â”‚  â”‚ .target     â”‚  â”‚  â”‚
â”‚                           â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â”‚  æ•…éšœå®šä½ï¼šå“ªä¸ªé˜¶æ®µï¼Ÿ                                                        â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                        â”‚
â”‚  Stage 1 å¤±è´¥ â†’ æ— ä»»ä½•æ˜¾ç¤ºï¼Œæ£€æŸ¥ BIOS/ç¡¬ç›˜                                   â”‚
â”‚  Stage 2 å¤±è´¥ â†’ grub> æˆ– grub rescue> æç¤ºç¬¦                                â”‚
â”‚  Stage 3 å¤±è´¥ â†’ Kernel panic, root device not found                         â”‚
â”‚  Stage 4 å¤±è´¥ â†’ dracut é”™è¯¯ï¼Œè¿›å…¥ dracut shell                              â”‚
â”‚  Stage 5 å¤±è´¥ â†’ Emergency Mode æˆ– Rescue Mode                               â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
<!-- /DIAGRAM -->

### 1.2 å„é˜¶æ®µçš„èŒè´£

| é˜¶æ®µ | ç»„ä»¶ | èŒè´£ | æ•…éšœè¡¨ç° |
|------|------|------|----------|
| 1 | BIOS/UEFI | ç¡¬ä»¶è‡ªæ£€ï¼ŒæŸ¥æ‰¾å¯åŠ¨è®¾å¤‡ | æ— æ˜¾ç¤ºï¼Œèœ‚é¸£ï¼Œç¡¬ä»¶é”™è¯¯ |
| 2 | GRUB2 | åŠ è½½å†…æ ¸å’Œ initramfs | grub>/grub rescue> æç¤ºç¬¦ |
| 3 | Kernel | åˆå§‹åŒ– CPUã€å†…å­˜ã€è®¾å¤‡é©±åŠ¨ | Kernel panic |
| 4 | initramfs | ä¸´æ—¶æ ¹ï¼ŒåŠ è½½çœŸæ­£çš„ root åˆ†åŒº | dracut shellï¼Œæ‰¾ä¸åˆ° root |
| 5 | systemd | å¯åŠ¨æœåŠ¡ï¼ŒæŒ‚è½½æ–‡ä»¶ç³»ç»Ÿ | Emergency/Rescue Mode |

### 1.3 BIOS vs UEFI

ç°ä»£æœåŠ¡å™¨å¤šä½¿ç”¨ UEFIï¼Œä½†ä¼ ç»Ÿ BIOS ä»æœ‰ä½¿ç”¨ï¼š

| å¯¹æ¯”é¡¹ | Legacy BIOS | UEFI |
|--------|-------------|------|
| å¯åŠ¨åˆ†åŒº | MBRï¼ˆä¸»å¼•å¯¼è®°å½•ï¼‰ | ESPï¼ˆEFI ç³»ç»Ÿåˆ†åŒºï¼‰ |
| åˆ†åŒºè¡¨ | MBRï¼ˆæœ€å¤§ 2TBï¼‰ | GPTï¼ˆæ”¯æŒå¤§ç£ç›˜ï¼‰ |
| GRUB ä½ç½® | MBR + /boot/grub2/ | ESP + /boot/efi/ |
| å®‰å…¨å¯åŠ¨ | ä¸æ”¯æŒ | Secure Boot |

```bash
# æ£€æŸ¥å½“å‰å¯åŠ¨æ¨¡å¼
[ -d /sys/firmware/efi ] && echo "UEFI" || echo "BIOS"

# UEFI æ¨¡å¼ä¸‹æŸ¥çœ‹ ESP åˆ†åŒº
ls -la /boot/efi/EFI/
```

---

## Step 2 -- å¯åŠ¨æ•…éšœå†³ç­–æ ‘ï¼ˆ10 åˆ†é’Ÿï¼‰

### 2.1 æ ¸å¿ƒå†³ç­–æ ‘

é‡åˆ°å¯åŠ¨æ•…éšœï¼ŒæŒ‰æ­¤å†³ç­–æ ‘å®šä½é˜¶æ®µï¼š

<!-- DIAGRAM: boot-decision-tree -->
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         å¯åŠ¨æ•…éšœå†³ç­–æ ‘                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  å¯åŠ¨å¤±è´¥                                                                â”‚
â”‚      â”‚                                                                   â”‚
â”‚      â–¼                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                 â”‚
â”‚  â”‚ å±å¹•æœ‰ä»»ä½•æ˜¾ç¤ºå—ï¼Ÿ  â”‚                                                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                 â”‚
â”‚             â”‚                                                            â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”                                                    â”‚
â”‚     â”‚ No            â”‚ Yes                                                â”‚
â”‚     â–¼               â–¼                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”‚
â”‚  â”‚ Stage 1  â”‚  â”‚ æ˜¯ grub> æˆ–         â”‚                                   â”‚
â”‚  â”‚ ç¡¬ä»¶é—®é¢˜ â”‚  â”‚ grub rescue> å—ï¼Ÿ   â”‚                                   â”‚
â”‚  â”‚          â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                   â”‚
â”‚  â”‚ ãƒ»æ£€æŸ¥ç”µæºâ”‚            â”‚                                              â”‚
â”‚  â”‚ ãƒ»æ£€æŸ¥ç¡¬ç›˜â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”                                       â”‚
â”‚  â”‚ ãƒ»BIOSè®¾ç½®â”‚     â”‚ Yes         â”‚ No                                    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â–¼             â–¼                                        â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚              â”‚ Stage 2  â”‚  â”‚ æ˜¾ç¤º Kernel panic   â”‚                       â”‚
â”‚              â”‚ GRUBæ•…éšœ â”‚  â”‚ æˆ– dracut shellï¼Ÿ   â”‚                       â”‚
â”‚              â”‚          â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚              â”‚ è§ Step 3â”‚            â”‚                                   â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”                            â”‚
â”‚                               â”‚ Yes         â”‚ No                         â”‚
â”‚                               â–¼             â–¼                            â”‚
â”‚                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚                          â”‚ Stage 3-4â”‚  â”‚ Emergency Mode æˆ–   â”‚           â”‚
â”‚                          â”‚ å†…æ ¸/    â”‚  â”‚ Rescue Modeï¼Ÿ       â”‚           â”‚
â”‚                          â”‚ initramfsâ”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                          â”‚          â”‚            â”‚                       â”‚
â”‚                          â”‚ è§ Step 4â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚ Yes         â”‚ No             â”‚
â”‚                                           â–¼             â–¼                â”‚
â”‚                                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚                                      â”‚ Stage 5  â”‚  â”‚ æ­£å¸¸å¯åŠ¨ â”‚          â”‚
â”‚                                      â”‚ systemd  â”‚  â”‚ ä½†æœ‰é—®é¢˜ â”‚          â”‚
â”‚                                      â”‚          â”‚  â”‚          â”‚          â”‚
â”‚                                      â”‚ è§ Step 5â”‚  â”‚ è§ Step 6â”‚          â”‚
â”‚                                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
<!-- /DIAGRAM -->

### 2.2 æ”¶é›†å¯åŠ¨ä¿¡æ¯

åœ¨èƒ½è¿›å…¥ç³»ç»Ÿçš„æƒ…å†µä¸‹ï¼Œå…ˆæ”¶é›†ä¿¡æ¯ï¼š

```bash
# å¯åŠ¨æ—¥å¿—
journalctl -b                    # æœ¬æ¬¡å¯åŠ¨
journalctl -b -1                 # ä¸Šæ¬¡å¯åŠ¨
journalctl -b -1 -p err          # ä¸Šæ¬¡å¯åŠ¨çš„é”™è¯¯

# å¯åŠ¨æ—¶é—´åˆ†æ
systemd-analyze                  # æ€»è€—æ—¶
systemd-analyze blame            # å„æœåŠ¡è€—æ—¶
systemd-analyze critical-chain   # å…³é”®è·¯å¾„

# å¤±è´¥çš„å•å…ƒ
systemctl --failed
systemctl list-units --state=failed

# fstab æ£€æŸ¥
cat /etc/fstab
mount | grep -v "^cgroup"        # å½“å‰æŒ‚è½½
```

---

## Step 3 -- GRUB æ•…éšœè¯Šæ–­ä¸æ¢å¤ï¼ˆ25 åˆ†é’Ÿï¼‰

### 3.1 GRUB æ•…éšœçš„ä¸¤ç§æ¨¡å¼

GRUB æ•…éšœæœ‰ä¸¤ç§è¡¨ç°ï¼Œå¤„ç†æ–¹æ³•ä¸åŒï¼š

| æç¤ºç¬¦ | å«ä¹‰ | åŸå›  | æ¢å¤æ–¹æ³• |
|--------|------|------|----------|
| `grub>` | GRUB åŠ è½½æˆåŠŸï¼Œä½†æ‰¾ä¸åˆ°é…ç½® | grub.cfg ç¼ºå¤±æˆ–æŸå | æ‰‹åŠ¨å¼•å¯¼ + é‡å»ºé…ç½® |
| `grub rescue>` | GRUB æ ¸å¿ƒåŠ è½½ï¼Œä½†æ¨¡å—æŸå | /boot/grub2/ æŸå | éœ€è¦æ•‘æ´ä»‹è´¨ |

### 3.2 ä» grub> æç¤ºç¬¦æ‰‹åŠ¨å¼•å¯¼

å¦‚æœçœ‹åˆ° `grub>` æç¤ºç¬¦ï¼Œå¯ä»¥æ‰‹åŠ¨å¼•å¯¼ï¼š

```bash
# 1. åˆ—å‡ºå¯ç”¨ç£ç›˜å’Œåˆ†åŒº
grub> ls
# è¾“å‡ºï¼š(hd0) (hd0,gpt2) (hd0,gpt1)

# 2. æŸ¥æ‰¾åŒ…å« Linux å†…æ ¸çš„åˆ†åŒº
grub> ls (hd0,gpt2)/
# æ‰¾åˆ° vmlinuz-* å’Œ initramfs-* æ–‡ä»¶

# 3. è®¾ç½®æ ¹åˆ†åŒº
grub> set root=(hd0,gpt2)

# 4. åŠ è½½å†…æ ¸ï¼ˆæ ¹æ®å®é™…ç‰ˆæœ¬è°ƒæ•´ï¼‰
grub> linux /vmlinuz-5.14.0-427.el9.x86_64 root=/dev/sda3 ro

# 5. åŠ è½½ initramfs
grub> initrd /initramfs-5.14.0-427.el9.x86_64.img

# 6. å¯åŠ¨
grub> boot
```

**å¸¸è§å†…æ ¸å‚æ•°**ï¼š

| å‚æ•° | ç”¨é€” |
|------|------|
| `root=/dev/sda3` | æŒ‡å®šæ ¹åˆ†åŒº |
| `root=UUID=xxxxx` | ä½¿ç”¨ UUID æŒ‡å®šæ ¹åˆ†åŒº |
| `ro` | åªè¯»æŒ‚è½½ root |
| `rd.break` | åœ¨ initramfs é˜¶æ®µä¸­æ–­ï¼ˆç”¨äºå¯†ç é‡ç½®ï¼‰ |
| `systemd.unit=rescue.target` | è¿›å…¥å•ç”¨æˆ·æ¨¡å¼ |
| `init=/bin/bash` | ç›´æ¥è¿›å…¥ bashï¼ˆç»•è¿‡ systemdï¼‰ |

### 3.3 ä»æ•‘æ´ä»‹è´¨æ¢å¤ GRUB

å¦‚æœ `grub rescue>` æˆ–å®Œå…¨æ— æ³•å¼•å¯¼ï¼Œéœ€è¦æ•‘æ´ä»‹è´¨ï¼š

```bash
# 1. ä»æ•‘æ´ ISO/USB å¯åŠ¨
# é€‰æ‹© "Rescue a system" æˆ– "Troubleshooting"

# 2. æŒ‚è½½ç³»ç»Ÿåˆ†åŒºï¼ˆæ•‘æ´æ¨¡å¼é€šå¸¸ä¼šå¸®ä½ æŒ‚è½½åˆ° /mnt/sysrootï¼‰
mount /dev/sda3 /mnt/sysroot
mount /dev/sda2 /mnt/sysroot/boot    # å¦‚æœ /boot æ˜¯ç‹¬ç«‹åˆ†åŒº
mount /dev/sda1 /mnt/sysroot/boot/efi  # UEFI çš„ ESP åˆ†åŒº

# 3. æŒ‚è½½å¿…è¦çš„è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ
mount --bind /dev /mnt/sysroot/dev
mount --bind /proc /mnt/sysroot/proc
mount --bind /sys /mnt/sysroot/sys

# 4. chroot è¿›å…¥ç³»ç»Ÿ
chroot /mnt/sysroot

# 5. é‡å»º GRUB é…ç½®
# RHEL/CentOS/Rocky:
grub2-mkconfig -o /boot/grub2/grub.cfg

# Debian/Ubuntu:
grub-mkconfig -o /boot/grub/grub.cfg

# 6. é‡æ–°å®‰è£… GRUBï¼ˆBIOS æ¨¡å¼ï¼‰
# RHEL/CentOS:
grub2-install /dev/sda

# Debian/Ubuntu:
grub-install /dev/sda

# 7. é‡æ–°å®‰è£… GRUBï¼ˆUEFI æ¨¡å¼ï¼‰
# RHEL/CentOS:
grub2-install --target=x86_64-efi --efi-directory=/boot/efi

# 8. é€€å‡ºå¹¶é‡å¯
exit
reboot
```

### 3.4 GRUB é…ç½®å¤‡ä»½ï¼ˆé¢„é˜²æªæ–½ï¼‰

æ—¥å¸¸ç»´æŠ¤ä¸­ï¼Œå…»æˆå¤‡ä»½ GRUB é…ç½®çš„ä¹ æƒ¯ï¼š

```bash
# å¤‡ä»½ GRUB é…ç½®
cp /boot/grub2/grub.cfg /boot/grub2/grub.cfg.backup

# å¤‡ä»½ GRUB ç¯å¢ƒ
cp /boot/grub2/grubenv /boot/grub2/grubenv.backup

# æŸ¥çœ‹å½“å‰é»˜è®¤å†…æ ¸
grubby --default-kernel

# æŸ¥çœ‹æ‰€æœ‰å¯ç”¨å†…æ ¸
grubby --info=ALL
```

---

## Step 4 -- initramfs æ•…éšœè¯Šæ–­ä¸ä¿®å¤ï¼ˆ20 åˆ†é’Ÿï¼‰

### 4.1 initramfs çš„ä½œç”¨

initramfsï¼ˆInitial RAM Filesystemï¼‰æ˜¯å¯åŠ¨æ—¶çš„ä¸´æ—¶æ ¹æ–‡ä»¶ç³»ç»Ÿï¼š

<!-- DIAGRAM: initramfs-role -->
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         initramfs çš„ä½œç”¨                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  é—®é¢˜ï¼šå†…æ ¸éœ€è¦æŒ‚è½½æ ¹æ–‡ä»¶ç³»ç»Ÿ (/)                                          â”‚
â”‚        ä½†æ ¹æ–‡ä»¶ç³»ç»Ÿåœ¨ LVM/RAID/åŠ å¯†ç£ç›˜ä¸Šï¼Œéœ€è¦ç‰¹æ®Šé©±åŠ¨                     â”‚
â”‚        è¿™äº›é©±åŠ¨åœ¨æ ¹æ–‡ä»¶ç³»ç»Ÿé‡Œï¼Œå½¢æˆå…ˆæœ‰é¸¡è¿˜æ˜¯å…ˆæœ‰è›‹çš„é—®é¢˜                    â”‚
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚  â”‚   Kernel    â”‚                      â”‚  çœŸæ­£çš„ /   â”‚                    â”‚
â”‚  â”‚             â”‚    ?å¦‚ä½•åˆ°è¾¾?         â”‚             â”‚                    â”‚
â”‚  â”‚  å†…å­˜ä¸­åŠ è½½  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ /dev/sda3   â”‚                    â”‚
â”‚  â”‚  æ²¡æœ‰é©±åŠ¨   â”‚                      â”‚ (LVM/XFS)   â”‚                    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚                                                                          â”‚
â”‚  è§£å†³æ–¹æ¡ˆï¼šinitramfs                                                      â”‚
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚  â”‚   Kernel    â”‚â”€â”€â”€â–¶â”‚  initramfs  â”‚â”€â”€â”€â–¶â”‚  çœŸæ­£çš„ /   â”‚                   â”‚
â”‚  â”‚             â”‚    â”‚             â”‚    â”‚             â”‚                   â”‚
â”‚  â”‚  åŠ è½½åˆ°å†…å­˜  â”‚    â”‚ ãƒ»ä¸´æ—¶æ ¹æ–‡ä»¶ â”‚    â”‚ æŒ‚è½½å¹¶åˆ‡æ¢  â”‚                   â”‚
â”‚  â”‚             â”‚    â”‚ ãƒ»å¿…è¦é©±åŠ¨   â”‚    â”‚ (pivot_root)â”‚                   â”‚
â”‚  â”‚             â”‚    â”‚ ãƒ»LVMå·¥å…·   â”‚    â”‚             â”‚                   â”‚
â”‚  â”‚             â”‚    â”‚ ãƒ»åŠ å¯†å·¥å…·   â”‚    â”‚             â”‚                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚                                                                          â”‚
â”‚  initramfs åŒ…å«ï¼š                                                         â”‚
â”‚  ãƒ»å¿…è¦çš„å†…æ ¸æ¨¡å—ï¼ˆå­˜å‚¨é©±åŠ¨ã€æ–‡ä»¶ç³»ç»Ÿï¼‰                                     â”‚
â”‚  ãƒ»è®¾å¤‡ç®¡ç†å·¥å…·ï¼ˆudev è§„åˆ™ï¼‰                                               â”‚
â”‚  ãƒ»LVM/RAID/åŠ å¯†å·¥å…·                                                      â”‚
â”‚  ãƒ»å¯åŠ¨è„šæœ¬                                                               â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
<!-- /DIAGRAM -->

### 4.2 initramfs æ•…éšœç—‡çŠ¶

å¸¸è§é”™è¯¯ä¿¡æ¯ï¼š

```
dracut: FATAL: No or empty root= argument
dracut: FATAL: Unable to access root device
dracut Warning: Could not boot.
Dropping to debug shell.

dracut:/#
```

### 4.3 dracut shell ç´§æ€¥æ’æŸ¥

å¦‚æœè¿›å…¥äº† `dracut:/#` shellï¼š

```bash
# æŸ¥çœ‹å¯ç”¨çš„å—è®¾å¤‡
lsblk

# æŸ¥çœ‹è®¾å¤‡ UUID
blkid

# æ£€æŸ¥ LVM å·ç»„
vgs
lvs
lvscan

# æ‰‹åŠ¨æ¿€æ´» LVM
vgchange -ay

# æ£€æŸ¥ root è®¾å¤‡æ˜¯å¦å­˜åœ¨
ls /dev/mapper/

# æŸ¥çœ‹å¯åŠ¨å‚æ•°
cat /proc/cmdline
```

### 4.4 é‡å»º initramfs

ä»æ•‘æ´æ¨¡å¼æˆ–æ­£å¸¸ç³»ç»Ÿé‡å»º initramfsï¼š

```bash
# RHEL/CentOS/Fedora/Rocky Linuxï¼ˆä½¿ç”¨ dracutï¼‰
# -------------------------------------------

# é‡å»ºå½“å‰å†…æ ¸çš„ initramfs
dracut -f

# é‡å»ºæŒ‡å®šå†…æ ¸çš„ initramfs
dracut -f /boot/initramfs-5.14.0-427.el9.x86_64.img 5.14.0-427.el9.x86_64

# æ·»åŠ ç‰¹å®šé©±åŠ¨æ¨¡å—
dracut -f --add-drivers "nvme xfs"

# è¯¦ç»†è¾“å‡ºï¼ˆè°ƒè¯•ç”¨ï¼‰
dracut -fv


# Debian/Ubuntuï¼ˆä½¿ç”¨ update-initramfsï¼‰
# --------------------------------------

# æ›´æ–°å½“å‰å†…æ ¸çš„ initramfs
update-initramfs -u

# æ›´æ–°æŒ‡å®šå†…æ ¸
update-initramfs -u -k 5.15.0-91-generic

# é‡å»ºæ‰€æœ‰å†…æ ¸çš„ initramfs
update-initramfs -u -k all

# è¯¦ç»†è¾“å‡º
update-initramfs -u -v
```

### 4.5 rd.break è°ƒè¯•æ¨¡å¼

`rd.break` åœ¨ initramfs é˜¶æ®µä¸­æ–­ï¼Œå¸¸ç”¨äºå¯†ç é‡ç½®ï¼š

```bash
# 1. åœ¨ GRUB èœå•æŒ‰ 'e' ç¼–è¾‘å¯åŠ¨é¡¹
# 2. æ‰¾åˆ° linux è¡Œï¼Œåœ¨æœ«å°¾æ·»åŠ  rd.break
# 3. æŒ‰ Ctrl+X å¯åŠ¨

# è¿›å…¥ initramfs shell åï¼š
# æ ¹æ–‡ä»¶ç³»ç»Ÿåœ¨ /sysroot ä¸”ä¸ºåªè¯»

# é‡æ–°æŒ‚è½½ä¸ºè¯»å†™
mount -o remount,rw /sysroot

# chroot è¿›å…¥
chroot /sysroot

# ä¿®æ”¹ root å¯†ç ï¼ˆå¦‚æœéœ€è¦ï¼‰
passwd root

# å¦‚æœæ˜¯ RHEL/CentOSï¼ˆSELinuxï¼‰ï¼Œæ ‡è®°é‡æ–°æ‰“æ ‡ç­¾
touch /.autorelabel

# é€€å‡ºå¹¶é‡å¯
exit
exit
# æˆ– reboot -f
```

---

## Step 5 -- systemd å¯åŠ¨æ•…éšœï¼šEmergency ä¸ Rescueï¼ˆ20 åˆ†é’Ÿï¼‰

### 5.1 Emergency vs Rescue Mode

å¦‚æœå†…æ ¸å’Œ initramfs éƒ½æ­£å¸¸ï¼Œä½†ç³»ç»Ÿè¿›å…¥äº† Emergency Mode æˆ– Rescue Modeï¼š

| æ¨¡å¼ | target | ç‰¹ç‚¹ | å¸¸è§åŸå›  |
|------|--------|------|----------|
| Emergency Mode | emergency.target | æœ€å°ç¯å¢ƒï¼Œroot åªè¯» | fstab é”™è¯¯ã€fsck å¤±è´¥ |
| Rescue Mode | rescue.target | å•ç”¨æˆ·ï¼Œå¯è¯»å†™ | æ‰‹åŠ¨è¯·æ±‚ã€ä¾èµ–å¤±è´¥ |

### 5.2 Emergency Mode è¯Šæ–­

```bash
# Emergency Mode ä¸‹çš„è¯Šæ–­æ­¥éª¤

# 1. æŸ¥çœ‹å¯åŠ¨æ—¥å¿—
journalctl -xb

# 2. æŸ¥çœ‹å…·ä½“é”™è¯¯
journalctl -xb -p err

# 3. æ£€æŸ¥å¤±è´¥çš„æŒ‚è½½
systemctl --failed
systemctl list-units --type=mount --state=failed

# 4. æ£€æŸ¥ fstab
cat /etc/fstab

# 5. éªŒè¯è®¾å¤‡å­˜åœ¨
lsblk
blkid

# 6. æ£€æŸ¥æ–‡ä»¶ç³»ç»Ÿ
# æ³¨æ„ï¼šåªèƒ½å¯¹æœªæŒ‚è½½çš„åˆ†åŒºè¿è¡Œ fsckï¼
fsck /dev/sda2
```

### 5.3 å¸¸è§ systemd å¯åŠ¨é˜»å¡

**é—®é¢˜ 1ï¼šæœåŠ¡å¯åŠ¨è¶…æ—¶**

```bash
# æŸ¥æ‰¾è¶…æ—¶çš„æœåŠ¡
journalctl -b -p err | grep -i timeout

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
systemctl status <service>

# ä¸´æ—¶ç¦ç”¨é—®é¢˜æœåŠ¡
systemctl mask <service>
reboot

# ä¿®å¤åæ¢å¤
systemctl unmask <service>
```

**é—®é¢˜ 2ï¼šä¾èµ–æœåŠ¡å¤±è´¥**

```bash
# æŸ¥çœ‹æœåŠ¡ä¾èµ–
systemctl list-dependencies <service>

# æŸ¥çœ‹åå‘ä¾èµ–ï¼ˆè°ä¾èµ–è¿™ä¸ªæœåŠ¡ï¼‰
systemctl list-dependencies --reverse <service>

# æŸ¥çœ‹å¯åŠ¨å…³é”®é“¾
systemd-analyze critical-chain <service>
```

### 5.4 æ‰‹åŠ¨è¿›å…¥æ•‘æ´æ¨¡å¼

æœ‰æ—¶éœ€è¦ä¸»åŠ¨è¿›å…¥æ•‘æ´æ¨¡å¼è¿›è¡Œç»´æŠ¤ï¼š

```bash
# æ–¹æ³• 1ï¼šGRUB å¯åŠ¨å‚æ•°
# åœ¨ linux è¡Œæœ«å°¾æ·»åŠ ï¼š
systemd.unit=rescue.target    # Rescue Mode
systemd.unit=emergency.target  # Emergency Mode

# æ–¹æ³• 2ï¼šä»è¿è¡Œä¸­çš„ç³»ç»Ÿ
systemctl isolate rescue.target
systemctl isolate emergency.target

# æ–¹æ³• 3ï¼šè®¾ç½®é»˜è®¤ç›®æ ‡ï¼ˆè°¨æ…ä½¿ç”¨ï¼‰
systemctl set-default rescue.target
# æ¢å¤ï¼š
systemctl set-default multi-user.target
```

---

## Step 6 -- fstab é—®é¢˜æ’æŸ¥ï¼ˆ25 åˆ†é’Ÿï¼‰

### 6.1 åœºæ™¯ï¼š"æ˜¨å¤©è¿˜å¥½å¥½çš„"

> **åœºæ™¯**ï¼šè®¡åˆ’ç»´æŠ¤é‡å¯åï¼ŒæœåŠ¡å™¨è¿›å…¥ Emergency Modeã€‚  
> åŸå› ï¼šä¸€ä¸ªéå…³é”®æ•°æ®ç›˜è¢«åŠ å…¥ /etc/fstabï¼Œä½†æ²¡æœ‰ nofail é€‰é¡¹ï¼Œè€Œè¯¥ç£ç›˜å½“å‰ç¦»çº¿ã€‚  

è¿™æ˜¯æœ€å¸¸è§çš„å¯åŠ¨æ•…éšœä¹‹ä¸€ã€‚

### 6.2 fstab å­—æ®µå¤ä¹ 

```bash
# /etc/fstab æ ¼å¼
# <è®¾å¤‡>       <æŒ‚è½½ç‚¹>   <ç±»å‹>   <é€‰é¡¹>        <dump> <fsck>
UUID=xxx-xxx   /          xfs      defaults      0      1
UUID=yyy-yyy   /boot      ext4     defaults      0      2
UUID=zzz-zzz   /data      xfs      defaults      0      2    # å±é™©ï¼
```

### 6.3 å…³é”®é€‰é¡¹ï¼šnofail å’Œ noauto

| é€‰é¡¹ | ä½œç”¨ | ä½¿ç”¨åœºæ™¯ |
|------|------|----------|
| `nofail` | è®¾å¤‡ä¸å­˜åœ¨æ—¶ä¸é˜»å¡å¯åŠ¨ | å¯é€‰ç£ç›˜ã€å¤–æ¥å­˜å‚¨ |
| `noauto` | å¯åŠ¨æ—¶ä¸è‡ªåŠ¨æŒ‚è½½ | æ‰‹åŠ¨æŒ‚è½½çš„è®¾å¤‡ |
| `x-systemd.device-timeout=10` | è®¾å¤‡ç­‰å¾…è¶…æ—¶ | ç½‘ç»œå­˜å‚¨ã€æ…¢é€Ÿè®¾å¤‡ |

**å®‰å…¨çš„ fstab é…ç½®**ï¼š

```bash
# éå…³é”®æ•°æ®ç›˜ï¼šæ·»åŠ  nofail
UUID=zzz-zzz   /data      xfs      defaults,nofail      0      2

# ç½‘ç»œå­˜å‚¨ï¼šæ·»åŠ è¶…æ—¶å’Œ nofail
UUID=aaa-aaa   /nfs       nfs      defaults,nofail,x-systemd.device-timeout=30   0 0

# å¯ç§»åŠ¨è®¾å¤‡ï¼šnoauto
UUID=bbb-bbb   /usb       ext4     defaults,noauto,nofail   0 0
```

### 6.4 Emergency Mode ä¸‹ä¿®å¤ fstab

```bash
# 1. Emergency Mode ä¸‹ root æ˜¯åªè¯»çš„
# å…ˆé‡æ–°æŒ‚è½½ä¸ºè¯»å†™
mount -o remount,rw /

# 2. ç¼–è¾‘ fstab
vim /etc/fstab

# 3. æ–¹æ³• Aï¼šæ³¨é‡Šæ‰é—®é¢˜è¡Œ
# UUID=zzz-zzz   /data      xfs      defaults      0      2

# 4. æ–¹æ³• Bï¼šæ·»åŠ  nofail é€‰é¡¹
UUID=zzz-zzz   /data      xfs      defaults,nofail      0      2

# 5. æ–¹æ³• Cï¼šç¡®è®¤ UUID æ˜¯å¦æ­£ç¡®
blkid
# å¯¹æ¯” fstab ä¸­çš„ UUID

# 6. éªŒè¯ fstab è¯­æ³•
mount -a
# å¦‚æœæœ‰é”™è¯¯ä¼šæç¤º

# 7. é‡å¯
reboot
```

### 6.5 UUID vs è®¾å¤‡è·¯å¾„

**ä¸ºä»€ä¹ˆæ¨è UUIDï¼Ÿ**

| æ–¹å¼ | ç¤ºä¾‹ | ç¨³å®šæ€§ | é—®é¢˜ |
|------|------|--------|------|
| è®¾å¤‡è·¯å¾„ | `/dev/sda1` | ä¸ç¨³å®š | æ·»åŠ ç£ç›˜åå¯èƒ½å˜åŒ– |
| UUID | `UUID=xxxx-xxxx` | ç¨³å®š | æ ¼å¼åŒ–åä¼šå˜ |
| LABEL | `LABEL=data` | ç¨³å®š | éœ€è¦è®¾ç½®æ ‡ç­¾ |
| LVM | `/dev/mapper/vg-lv` | ç¨³å®š | ä»…é™ LVM |

```bash
# æŸ¥çœ‹è®¾å¤‡ UUID
blkid

# ä½¿ç”¨ UUID æ·»åŠ åˆ° fstab
echo "UUID=$(blkid -s UUID -o value /dev/sdb1)  /data  xfs  defaults,nofail  0  2" >> /etc/fstab

# è®¾ç½®å·æ ‡
xfs_admin -L data /dev/sdb1    # XFS
e2label /dev/sdb1 data         # ext4
```

### 6.6 æµ‹è¯• fstab ä¿®æ”¹

**ä¿®æ”¹ fstab åï¼Œä¸è¦ç›´æ¥é‡å¯ï¼å…ˆæµ‹è¯•ï¼**

```bash
# æ–¹æ³• 1ï¼šmount -aï¼ˆæœ€å¸¸ç”¨ï¼‰
mount -a
# å¦‚æœæ²¡æœ‰é”™è¯¯è¾“å‡ºï¼Œè¯´æ˜è¯­æ³•æ­£ç¡®

# æ–¹æ³• 2ï¼šsystemd é‡æ–°åŠ è½½
systemctl daemon-reload
systemctl list-units --type=mount --state=failed

# æ–¹æ³• 3ï¼šæ¨¡æ‹ŸæŒ‚è½½ï¼ˆä¸å®é™…æŒ‚è½½ï¼‰
mount -fav
# -f: fakeï¼Œä¸å®é™…æŒ‚è½½
# -a: allï¼Œæ‰€æœ‰æ¡ç›®
# -v: verboseï¼Œè¯¦ç»†è¾“å‡º
```

---

## Step 7 -- åŠ¨æ‰‹å®éªŒï¼ˆ30 åˆ†é’Ÿï¼‰

### å®éªŒ 1ï¼šæ¨¡æ‹Ÿ fstab æ•…éšœï¼ˆå»ºè®®åœ¨è™šæ‹Ÿæœºä¸­è¿›è¡Œï¼‰

> **è­¦å‘Š**ï¼šæ­¤å®éªŒä¼šå¯¼è‡´ç³»ç»Ÿæ— æ³•æ­£å¸¸å¯åŠ¨ï¼Œè¯·åœ¨è™šæ‹Ÿæœºä¸­è¿›è¡Œï¼  

```bash
# 1. åˆ›å»ºä¸€ä¸ªæµ‹è¯•åˆ†åŒºæˆ– loop è®¾å¤‡
dd if=/dev/zero of=/tmp/testdisk.img bs=1M count=100
losetup /dev/loop0 /tmp/testdisk.img
mkfs.xfs /dev/loop0

# 2. è·å– UUID
blkid /dev/loop0

# 3. åˆ›å»ºæŒ‚è½½ç‚¹
mkdir /testmount

# 4. æ·»åŠ åˆ° fstabï¼ˆæ•…æ„ä¸åŠ  nofailï¼Œé”™è¯¯ç¤ºèŒƒï¼‰
echo "UUID=<ä¸Šä¸€æ­¥çš„UUID>  /testmount  xfs  defaults  0  2" >> /etc/fstab

# 5. æµ‹è¯•æŒ‚è½½
mount -a
# åº”è¯¥æˆåŠŸ

# 6. ç§»é™¤ loop è®¾å¤‡ï¼ˆæ¨¡æ‹Ÿç£ç›˜æ•…éšœï¼‰
umount /testmount
losetup -d /dev/loop0
rm /tmp/testdisk.img

# 7. å°è¯•é‡å¯ï¼ˆåœ¨è™šæ‹Ÿæœºä¸­ï¼ï¼‰
# ç³»ç»Ÿä¼šè¿›å…¥ Emergency Mode

# 8. ä¿®å¤ï¼šåœ¨ Emergency Mode ä¸­
mount -o remount,rw /
vim /etc/fstab
# æ³¨é‡Šæ‰æˆ–åˆ é™¤é—®é¢˜è¡Œ
reboot
```

### å®éªŒ 2ï¼šGRUB æ‰‹åŠ¨å¼•å¯¼ç»ƒä¹ 

åœ¨ GRUB èœå•ä¸­ç»ƒä¹ æ‰‹åŠ¨å¼•å¯¼ï¼š

```bash
# 1. é‡å¯ç³»ç»Ÿï¼Œåœ¨ GRUB èœå•æŒ‰ 'c' è¿›å…¥å‘½ä»¤è¡Œ

# 2. åˆ—å‡ºè®¾å¤‡
grub> ls

# 3. æŸ¥çœ‹åˆ†åŒºå†…å®¹
grub> ls (hd0,gpt2)/

# 4. è®°å½•å†…æ ¸å’Œ initramfs æ–‡ä»¶å
# vmlinuz-xxx
# initramfs-xxx.img

# 5. æŒ‰ ESC è¿”å›èœå•æ­£å¸¸å¯åŠ¨

# 6. è®°å½•è¿™äº›ä¿¡æ¯ï¼Œä»¥å¤‡çœŸæ­£éœ€è¦æ‰‹åŠ¨å¼•å¯¼æ—¶ä½¿ç”¨
```

### å®éªŒ 3ï¼šinitramfs é‡å»º

```bash
# æŸ¥çœ‹å½“å‰ initramfs å†…å®¹
lsinitrd /boot/initramfs-$(uname -r).img | head -50

# å¤‡ä»½å½“å‰ initramfs
cp /boot/initramfs-$(uname -r).img /boot/initramfs-$(uname -r).img.backup

# é‡å»º initramfsï¼ˆRHEL/CentOSï¼‰
dracut -fv

# æˆ–æŒ‡å®šæ·»åŠ é©±åŠ¨
dracut -fv --add-drivers "nvme virtio_blk"

# éªŒè¯æ–°çš„ initramfs
lsinitrd /boot/initramfs-$(uname -r).img | head -50
```

---

## åæ¨¡å¼ï¼šå¸¸è§é”™è¯¯

### é”™è¯¯ 1ï¼šä¸æµ‹è¯•å°±é‡å¯

```bash
# é”™è¯¯ï¼šä¿®æ”¹ fstab åç›´æ¥é‡å¯
vim /etc/fstab
# æ·»åŠ æ–°æŒ‚è½½ç‚¹
reboot    # å±é™©ï¼

# æ­£ç¡®ï¼šå…ˆæµ‹è¯•
vim /etc/fstab
mount -a    # æµ‹è¯•è¯­æ³•
systemctl daemon-reload
systemctl list-units --type=mount --state=failed
# ç¡®è®¤æ— é”™è¯¯åå†é‡å¯
```

### é”™è¯¯ 2ï¼šéå…³é”®ç£ç›˜ä¸åŠ  nofail

```bash
# é”™è¯¯ï¼šæ•°æ®ç›˜ä½¿ç”¨é»˜è®¤é€‰é¡¹
UUID=xxx  /data  xfs  defaults  0  2

# æ­£ç¡®ï¼šé root åˆ†åŒºæ·»åŠ  nofail
UUID=xxx  /data  xfs  defaults,nofail  0  2
```

### é”™è¯¯ 3ï¼šå¯¹æŒ‚è½½çš„æ–‡ä»¶ç³»ç»Ÿè¿è¡Œ fsck

```bash
# é”™è¯¯ï¼šè¿™ä¼šæŸåæ•°æ®ï¼
fsck /dev/sda3    # å¦‚æœ sda3 å·²æŒ‚è½½

# æ­£ç¡®ï¼šå…ˆå¸è½½æˆ–ä»æ•‘æ´æ¨¡å¼è¿è¡Œ
umount /dev/sda3
fsck /dev/sda3

# æˆ–è€…å¯¹ root åˆ†åŒºï¼Œå¿…é¡»ä»æ•‘æ´æ¨¡å¼è¿è¡Œ
```

### é”™è¯¯ 4ï¼šEmergency Mode ä¸‹ä¸ remount rw

```bash
# é”™è¯¯ï¼šç›´æ¥ç¼–è¾‘
vim /etc/fstab
# E45: 'readonly' option is set

# æ­£ç¡®ï¼šå…ˆ remount
mount -o remount,rw /
vim /etc/fstab
```

---

## èŒåœºå°è´´å£«ï¼ˆJapan IT Contextï¼‰

### å¯åŠ¨æ•…éšœå¤„ç†ï¼ˆèµ·å‹•éšœå®³å¯¾å¿œï¼‰

åœ¨æ—¥æœ¬ IT ç°åœºï¼Œå¯åŠ¨æ•…éšœé€šå¸¸å‘ç”Ÿåœ¨ç»´æŠ¤çª—å£åï¼š

| æ—¥è¯­æœ¯è¯­ | å«ä¹‰ | åœºæ™¯ |
|----------|------|------|
| èµ·å‹•éšœå®³ | å¯åŠ¨æ•…éšœ | æœåŠ¡å™¨æ— æ³•å¯åŠ¨ |
| ç·Šæ€¥å¯¾å¿œ | ç´§æ€¥å¤„ç† | æ·±å¤œ On-call |
| å¤‰æ›´ç®¡ç† | å˜æ›´ç®¡ç† | è¿½æº¯æœ€è¿‘çš„å˜æ›´ |
| åˆ‡ã‚Šæˆ»ã— | å›æ»š | æ¢å¤åˆ°å˜æ›´å‰çŠ¶æ€ |
| éšœå®³å ±å‘Šæ›¸ | æ•…éšœæŠ¥å‘Š | äº‹åæ–‡æ¡£ |

### å…¸å‹åœºæ™¯ï¼šå¤œé—´æ‰¹å¤„ç†åçš„å¯åŠ¨æ•…éšœ

```
æ—¶é—´çº¿ï¼ˆå…¸å‹ï¼‰ï¼š
2:00 AM - å¤œé—´æ‰¹å¤„ç†ç»“æŸï¼Œç³»ç»Ÿé‡å¯
2:05 AM - ç›‘æ§å‘Šè­¦ï¼šã‚µãƒ¼ãƒãƒ¼èµ·å‹•å¤±æ•—
2:10 AM - On-call ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ æ¥åˆ°ç”µè¯
2:15 AM - ç¡®è®¤ç—‡çŠ¶ï¼šEmergency Mode
2:30 AM - å®šä½åŸå› ï¼šfstab ä¸­æ–°å¢æ•°æ®ç›˜ UUID é”™è¯¯
2:35 AM - ä¿®å¤å¹¶é‡å¯
2:40 AM - æœåŠ¡æ¢å¤
3:00 AM - æŠ¥å‘Šä¸Šçº§ï¼ˆä¸€æ¬¡å ±å‘Šï¼‰
ç¿Œæ—¥   - æäº¤ éšœå®³å ±å‘Šæ›¸
```

### å˜æ›´ç®¡ç†çš„é‡è¦æ€§

æ—¥æœ¬ä¼ä¸šéå¸¸é‡è§†å˜æ›´ç®¡ç†ï¼ˆå¤‰æ›´ç®¡ç†ï¼‰ã€‚å¯åŠ¨æ•…éšœçš„æ’æŸ¥ç¬¬ä¸€æ­¥ï¼š

```bash
# æ£€æŸ¥æœ€è¿‘çš„å˜æ›´
# 1. é…ç½®å˜æ›´
ls -lt /etc/ | head -20
stat /etc/fstab

# 2. è½¯ä»¶æ›´æ–°
rpm -qa --last | head -10    # RHEL/CentOS
apt list --installed 2>/dev/null | head -10    # Debian/Ubuntu

# 3. å†…æ ¸æ›´æ–°
ls -lt /boot/

# 4. å‘å›¢é˜Ÿç¡®è®¤
# ã€Œæ˜¨æ—¥ä½•ã‹å¤‰æ›´ã—ã¾ã—ãŸã‹ï¼Ÿã€
# (æ˜¨å¤©æœ‰åšä»€ä¹ˆå˜æ›´å—ï¼Ÿ)
```

### é¢è¯•å¸¸è§é—®é¢˜

**Q1: ã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã—ãªã„å ´åˆã€ã©ã®ã‚ˆã†ã«å¯¾å¿œã—ã¾ã™ã‹ï¼Ÿ**
ï¼ˆæœåŠ¡å™¨æ— æ³•å¯åŠ¨æ—¶ï¼Œä½ ä¼šå¦‚ä½•å¤„ç†ï¼Ÿï¼‰

å‚è€ƒç­”æ¡ˆï¼š
1. é¦–å…ˆç¡®è®¤æ•…éšœé˜¶æ®µï¼ˆGRUBï¼Ÿinitramfsï¼Ÿsystemdï¼Ÿï¼‰
2. æŸ¥çœ‹å±å¹•é”™è¯¯ä¿¡æ¯ï¼Œç¡®å®šæ˜¯ grub æç¤ºç¬¦ã€kernel panic è¿˜æ˜¯ Emergency Mode
3. å¦‚æœæ˜¯ Emergency Modeï¼Œå…ˆæ£€æŸ¥ journalctl -xb å’Œ /etc/fstab
4. è®°å½•æ‰€æœ‰è¯Šæ–­æ­¥éª¤å’Œå‘ç°ï¼Œç”¨äºåç»­çš„éšœå®³å ±å‘Šæ›¸

**Q2: /etc/fstab ã® nofail ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯ä½•ã®ãŸã‚ã§ã™ã‹ï¼Ÿ**
ï¼ˆ/etc/fstab çš„ nofail é€‰é¡¹æœ‰ä»€ä¹ˆç”¨ï¼Ÿï¼‰

å‚è€ƒç­”æ¡ˆï¼š
- nofail é€‰é¡¹è¡¨ç¤ºè®¾å¤‡ä¸å­˜åœ¨æ—¶ä¸é˜»å¡å¯åŠ¨
- éå…³é”®æ•°æ®ç›˜åº”è¯¥æ·»åŠ æ­¤é€‰é¡¹
- é˜²æ­¢å› å¯é€‰ç£ç›˜ç¦»çº¿å¯¼è‡´ç³»ç»Ÿè¿›å…¥ Emergency Mode

---

## æ£€æŸ¥æ¸…å•

å®Œæˆæœ¬è¯¾åï¼Œä½ åº”è¯¥èƒ½å¤Ÿï¼š

- [ ] æè¿° Linux 5 ä¸ªå¯åŠ¨é˜¶æ®µåŠå…¶èŒè´£
- [ ] åŒºåˆ† BIOS å’Œ UEFI å¯åŠ¨æ¨¡å¼
- [ ] ä½¿ç”¨å¯åŠ¨å†³ç­–æ ‘å®šä½æ•…éšœé˜¶æ®µ
- [ ] ä» grub> æç¤ºç¬¦æ‰‹åŠ¨å¼•å¯¼ç³»ç»Ÿ
- [ ] ä½¿ç”¨æ•‘æ´ä»‹è´¨ chroot ä¿®å¤ GRUB
- [ ] ä½¿ç”¨ dracut -f æˆ– update-initramfs -u é‡å»º initramfs
- [ ] ä½¿ç”¨ rd.break è¿›å…¥ initramfs shell
- [ ] åŒºåˆ† Emergency Mode å’Œ Rescue Mode
- [ ] åœ¨ Emergency Mode ä¸‹ remount rw å¹¶ç¼–è¾‘ fstab
- [ ] æ­£ç¡®ä½¿ç”¨ nofail å’Œ noauto é€‰é¡¹
- [ ] ä¿®æ”¹ fstab åä½¿ç”¨ mount -a æµ‹è¯•
- [ ] ç†è§£ UUID vs è®¾å¤‡è·¯å¾„çš„ä¼˜åŠ£

---

## æœ¬è¯¾å°ç»“

| æ¦‚å¿µ | å…³é”®å‘½ä»¤/é…ç½® | è®°å¿†ç‚¹ |
|------|---------------|--------|
| å¯åŠ¨æµç¨‹ | BIOS->GRUB->Kernel->initramfs->systemd | 5 ä¸ªé˜¶æ®µ |
| GRUB æ¢å¤ | grub> æ‰‹åŠ¨å¼•å¯¼ï¼Œchroot é‡å»º | ls, set root, linux, initrd, boot |
| initramfs | dracut -f / update-initramfs -u | åŒ…å«æ ¹æŒ‚è½½å¿…éœ€çš„é©±åŠ¨ |
| rd.break | åœ¨ initramfs é˜¶æ®µä¸­æ–­ | å¯†ç é‡ç½®å¸¸ç”¨ |
| Emergency Mode | fstab é”™è¯¯å¸¸è§åŸå›  | mount -o remount,rw / |
| nofail | è®¾å¤‡ä¸å­˜åœ¨æ—¶ä¸é˜»å¡ | éå…³é”®ç£ç›˜å¿…åŠ  |
| æµ‹è¯• fstab | mount -a | é‡å¯å‰å¿…æµ‹ |

---

## å»¶ä¼¸é˜…è¯»

- [Red Hat: Boot Process and Troubleshooting](https://docs.redhat.com/en/documentation/red_hat_enterprise_linux/9/html/managing_monitoring_and_updating_the_kernel/assembly_boot-process-and-troubleshooting_managing-monitoring-and-updating-the-kernel)
- [Arch Wiki: GRUB](https://wiki.archlinux.org/title/GRUB)
- [dracut man page](https://man7.org/linux/man-pages/man8/dracut.8.html)
- ä¸‹ä¸€è¯¾ï¼š[03 - æœåŠ¡æ•…éšœï¼šsystemd æ·±åº¦è¯Šæ–­](../03-service-failures/) -- å­¦ä¹  systemd ä¾èµ–åˆ†æå’ŒæœåŠ¡æ•…éšœæ’æŸ¥
- ç›¸å…³è¯¾ç¨‹ï¼š[LX05-SYSTEMD](../../lx05-systemd/) -- systemd åŸºç¡€çŸ¥è¯†

---

## ç³»åˆ—å¯¼èˆª

[<-- 01 - æ•…éšœæ’æŸ¥æ–¹æ³•è®º](../01-methodology/) | [ç³»åˆ—é¦–é¡µ](../) | [03 - æœåŠ¡æ•…éšœ -->](../03-service-failures/)
