# 05 - å­˜å‚¨æ•…éšœï¼ˆStorage Issuesï¼‰

> **ç›®æ ‡**ï¼šæŒæ¡å­˜å‚¨é—®é¢˜çš„ç³»ç»Ÿæ€§è¯Šæ–­ï¼ŒåŒºåˆ†ç©ºé—´æ»¡ã€inode è€—å°½ã€I/O é”™è¯¯ä¸‰ç±»é—®é¢˜  
> **å‰ç½®**ï¼šLX07 å­˜å‚¨åŸºç¡€ï¼ˆLVMã€æ–‡ä»¶ç³»ç»Ÿã€æŒ‚è½½ï¼‰  
> **æ—¶é—´**ï¼šâš¡ 30 åˆ†é’Ÿï¼ˆé€Ÿè¯»ï¼‰/ ğŸ”¬ 120 åˆ†é’Ÿï¼ˆå®Œæ•´å®æ“ï¼‰  
> **æ ¸å¿ƒæŒ‘æˆ˜**ï¼šdf æ˜¾ç¤ºç£ç›˜æ»¡ï¼Œä½† du ç»Ÿè®¡å´ä¸ç¬¦  

---

## å°†å­¦åˆ°çš„å†…å®¹

1. åŒºåˆ†ç£ç›˜ç©ºé—´ã€inodeã€I/O é”™è¯¯ä¸‰ç±»å­˜å‚¨é—®é¢˜
2. è¯Šæ–­ "å·²åˆ é™¤ä½†æœªé‡Šæ”¾" çš„å¹½çµç£ç›˜å ç”¨
3. å¤„ç†åªè¯»æ–‡ä»¶ç³»ç»Ÿï¼ˆRead-only remountï¼‰
4. æ£€æŸ¥ç£ç›˜å¥åº·çŠ¶æ€ï¼ˆSMARTã€dmesgï¼‰
5. å®‰å…¨åœ°æ‰§è¡Œæ–‡ä»¶ç³»ç»Ÿä¿®å¤ï¼ˆfsck çš„æ­£ç¡®ä½¿ç”¨ï¼‰

---

## å…ˆè·‘èµ·æ¥ï¼ï¼ˆ5 åˆ†é’Ÿï¼‰

> å­˜å‚¨é—®é¢˜æ˜¯æ·±å¤œå‘Šè­¦çš„å¸¸å®¢ã€‚è¿™ 3 æ¡å‘½ä»¤ç«‹å³å‘Šè¯‰ä½ å­˜å‚¨å‡ºäº†ä»€ä¹ˆé—®é¢˜ã€‚  

```bash
# æŸ¥çœ‹ç£ç›˜ç©ºé—´ä½¿ç”¨ï¼ˆå«æ–‡ä»¶ç³»ç»Ÿç±»å‹ï¼‰
df -hT

# æŸ¥çœ‹ inode ä½¿ç”¨ï¼ˆå°æ–‡ä»¶è¿‡å¤šä¼šè€—å°½ inodeï¼‰
df -i

# æŸ¥çœ‹è¢«åˆ é™¤ä½†ä»è¢«è¿›ç¨‹æŒæœ‰çš„æ–‡ä»¶ï¼ˆå¹½çµå ç”¨ï¼‰
lsof +D /var 2>/dev/null | grep deleted | head -10
```

**è¿è¡Œç»“æœç¤ºä¾‹**ï¼š

```
# df -hT
Filesystem     Type      Size  Used Avail Use% Mounted on
/dev/sda1      ext4       50G   48G  2.0G  96% /
/dev/sdb1      xfs       100G   80G   20G  80% /data

# df -i
Filesystem      Inodes   IUsed   IFree IUse% Mounted on
/dev/sda1      3276800 3276700     100  100% /

# lsof +D /var | grep deleted
java      1234  app   10w  REG  8,1  5368709120  12345 /var/log/app.log (deleted)
```

**å‘ç°äº†ä»€ä¹ˆï¼Ÿ**

- `df -hT`ï¼šæ˜¾ç¤ºå„åˆ†åŒºä½¿ç”¨ç‡å’Œæ–‡ä»¶ç³»ç»Ÿç±»å‹
- `df -i`ï¼šinode 100% = æ— æ³•åˆ›å»ºæ–°æ–‡ä»¶ï¼ˆå³ä½¿æœ‰ç©ºé—´ï¼‰
- `lsof | grep deleted`ï¼š5GB çš„æ—¥å¿—æ–‡ä»¶è¢«åˆ é™¤ï¼Œä½† Java è¿›ç¨‹ä»æŒæœ‰å¥æŸ„ï¼

è¿™å°±æ˜¯å­˜å‚¨æ’æŸ¥çš„ç¬¬ä¸€æ­¥ã€‚ç°åœ¨è®©æˆ‘ä»¬æ·±å…¥å­¦ä¹ æ¯ç±»é—®é¢˜çš„è¯Šæ–­æ–¹æ³•ã€‚

---

## Step 1 -- å­˜å‚¨é—®é¢˜åˆ†ç±»ï¼ˆ10 åˆ†é’Ÿï¼‰

### 1.1 ä¸‰ç±»å­˜å‚¨é—®é¢˜

å­˜å‚¨é—®é¢˜ä¸»è¦åˆ†ä¸ºä¸‰ç±»ï¼Œè¯Šæ–­æ–¹æ³•å„ä¸ç›¸åŒï¼š

<!-- DIAGRAM: storage-problem-types -->
```
+------------------------------------------------------------------------+
|                       å­˜å‚¨é—®é¢˜åˆ†ç±»                                      |
+------------------------------------------------------------------------+
|                                                                        |
|    é—®é¢˜ç±»å‹           ç—‡çŠ¶                      å…³é”®å‘½ä»¤               |
|    +--------------+  +---------------------+  +---------------------+  |
|    | ç©ºé—´æ»¡       |  | "No space left"     |  | df -hT              |  |
|    | (Space Full) |  | å†™å…¥å¤±è´¥            |  | du -sh /path/*      |  |
|    |              |  | æœåŠ¡æ— æ³•å¯åŠ¨        |  | lsof | grep deleted |  |
|    +--------------+  +---------------------+  +---------------------+  |
|                                                                        |
|    +--------------+  +---------------------+  +---------------------+  |
|    | inode è€—å°½   |  | "No space left"     |  | df -i               |  |
|    | (inode      |  | ä½† df -h æœ‰ç©ºé—´     |  | find -type f | wc   |  |
|    |  Exhaustion)|  | å°æ–‡ä»¶æå¤š          |  |                     |  |
|    +--------------+  +---------------------+  +---------------------+  |
|                                                                        |
|    +--------------+  +---------------------+  +---------------------+  |
|    | I/O é”™è¯¯     |  | æ–‡ä»¶ç³»ç»Ÿåªè¯»        |  | dmesg | grep error  |  |
|    | (I/O Errors) |  | è¯»å†™ææ…¢            |  | smartctl -a         |  |
|    |              |  | å†…æ ¸æŠ¥é”™            |  | fsck (unmounted!)   |  |
|    +--------------+  +---------------------+  +---------------------+  |
|                                                                        |
+------------------------------------------------------------------------+
```
<!-- /DIAGRAM -->

### 1.2 å¿«é€Ÿè¯Šæ–­æµç¨‹

å½“æ”¶åˆ° "No space left on device" é”™è¯¯æ—¶ï¼š

```bash
# Step 1: æ£€æŸ¥ç£ç›˜ç©ºé—´
df -hT

# Step 2: å¦‚æœç©ºé—´æœ‰å‰©ä½™ï¼Œæ£€æŸ¥ inode
df -i

# Step 3: å¦‚æœ df æ˜¾ç¤ºæ»¡ä½† du ä¸ç¬¦ï¼Œæ£€æŸ¥å·²åˆ é™¤æ–‡ä»¶
lsof +L1 | head -20
```

---

## Step 2 -- ç£ç›˜ç©ºé—´é—®é¢˜ï¼ˆ25 åˆ†é’Ÿï¼‰

### 2.1 df vs duï¼šä¸ºä»€ä¹ˆä¼šä¸ä¸€è‡´ï¼Ÿ

**df** ç»Ÿè®¡çš„æ˜¯æ–‡ä»¶ç³»ç»Ÿå—çš„ä½¿ç”¨æƒ…å†µï¼ˆæ¥è‡ª superblockï¼‰ã€‚
**du** ç»Ÿè®¡çš„æ˜¯ç›®å½•æ ‘ä¸­æ–‡ä»¶çš„å¤§å°æ€»å’Œã€‚

ä¸¤è€…ä¸ä¸€è‡´çš„åŸå› ï¼š
1. **å·²åˆ é™¤æ–‡ä»¶ä»è¢«è¿›ç¨‹æŒæœ‰**ï¼ˆæœ€å¸¸è§ï¼ï¼‰
2. æŒ‚è½½ç‚¹ä¸‹éšè—äº†æ–‡ä»¶
3. ç¨€ç–æ–‡ä»¶
4. ä¿ç•™ç»™ root çš„ç©ºé—´

### 2.2 æ‰¾åˆ°å¤§æ–‡ä»¶å’Œå¤§ç›®å½•

```bash
# æ‰¾åˆ°æœ€å¤§çš„ 10 ä¸ªç›®å½•
du -sh /* 2>/dev/null | sort -rh | head -10

# è¿›å…¥å¯ç–‘ç›®å½•ç»§ç»­æ·±å…¥
du -sh /var/* 2>/dev/null | sort -rh | head -10

# æ‰¾åˆ°å¤§äº 100MB çš„æ–‡ä»¶
find / -type f -size +100M -exec ls -lh {} \; 2>/dev/null | sort -k5 -rh | head -20

# æ‰¾åˆ°æœ€è¿‘ 24 å°æ—¶ä¿®æ”¹çš„å¤§æ–‡ä»¶ï¼ˆå¯èƒ½æ˜¯æ—¥å¿—ç–¯ç‹‚å¢é•¿ï¼‰
find / -type f -size +50M -mtime -1 2>/dev/null
```

### 2.3 å¹½çµç£ç›˜å ç”¨ï¼šå·²åˆ é™¤ä½†æœªé‡Šæ”¾

**è¿™æ˜¯æœ€å®¹æ˜“è¢«è¯¯è¯Šçš„é—®é¢˜ï¼**

åœºæ™¯ï¼šè¿ç»´åˆ é™¤äº†å¤§æ—¥å¿—æ–‡ä»¶ï¼Œä½†ç£ç›˜ä½¿ç”¨ç‡ä¸ä¸‹é™ã€‚

```bash
# æ£€æŸ¥è¢«åˆ é™¤ä½†ä»è¢«è¿›ç¨‹æŒæœ‰çš„æ–‡ä»¶
lsof +L1
# +L1 = æ˜¾ç¤º link count < 1 çš„æ–‡ä»¶ï¼ˆå·²åˆ é™¤ä½†ä»æ‰“å¼€ï¼‰

# æˆ–è€…æ›´ç›´æ¥
lsof | grep deleted

# ç¤ºä¾‹è¾“å‡º
java    1234  app  10w  REG  8,1  5368709120  12345 /var/log/app.log (deleted)
#                                 ^^^^^^^^^^ 5GB ä»è¢«å ç”¨ï¼
```

**ä¸ºä»€ä¹ˆä¼šè¿™æ ·ï¼Ÿ**

<!-- DIAGRAM: deleted-file-mechanism -->
```
+------------------------------------------------------------------------+
|                    æ–‡ä»¶åˆ é™¤ vs ç©ºé—´é‡Šæ”¾                                  |
+------------------------------------------------------------------------+
|                                                                        |
|   æ­£å¸¸æƒ…å†µï¼ˆæ–‡ä»¶å…³é—­ååˆ é™¤ï¼‰                                            |
|   +------------+      rm file      +------------+                      |
|   |   file     | -----------------> |   ç©ºé—´    |                      |
|   | (inode+æ•°æ®)|                   |   é‡Šæ”¾    |                      |
|   +------------+                   +------------+                      |
|                                                                        |
|   å¼‚å¸¸æƒ…å†µï¼ˆæ–‡ä»¶è¢«è¿›ç¨‹æŒæœ‰æ—¶åˆ é™¤ï¼‰                                      |
|   +------------+      rm file      +------------+                      |
|   |   file     | -----------------> | ç›®å½•æ¡ç›®  |                      |
|   | (inode+æ•°æ®)|                   |   åˆ é™¤    |                      |
|   +------+-----+                   +------------+                      |
|          |                                                             |
|          | è¿›ç¨‹ä»æŒæœ‰ fd                                               |
|          v                                                             |
|   +------------+                                                       |
|   | inode+æ•°æ® | <--- ç©ºé—´ä»è¢«å ç”¨ï¼                                   |
|   | (deleted)  |      ç›´åˆ°è¿›ç¨‹å…³é—­ fd                                  |
|   +------------+                                                       |
|                                                                        |
|   Linux æ–‡ä»¶ç³»ç»Ÿè¡Œä¸ºï¼š                                                  |
|   - rm åˆ é™¤çš„æ˜¯ç›®å½•æ¡ç›®ï¼ˆæ–‡ä»¶ååˆ° inode çš„é“¾æ¥ï¼‰                        |
|   - inode å’Œæ•°æ®å—ç›´åˆ°æ‰€æœ‰ fd å…³é—­æ‰é‡Šæ”¾                               |
|   - è¿›ç¨‹æ‰“å¼€çš„æ–‡ä»¶é€šè¿‡ /proc/<PID>/fd å¯è§                             |
|                                                                        |
+------------------------------------------------------------------------+
```
<!-- /DIAGRAM -->

### 2.4 è§£å†³å¹½çµç£ç›˜å ç”¨

**æ–¹æ³• 1ï¼šé‡å¯æŒæœ‰æ–‡ä»¶çš„è¿›ç¨‹ï¼ˆæ¨èï¼‰**

```bash
# æ‰¾åˆ°æŒæœ‰å·²åˆ é™¤æ–‡ä»¶çš„è¿›ç¨‹
lsof +L1 | grep deleted

# ä¼˜é›…é‡å¯è¯¥æœåŠ¡
sudo systemctl restart tomcat
# æˆ–
sudo systemctl restart java-app
```

**æ–¹æ³• 2ï¼šæˆªæ–­æ–‡ä»¶ï¼ˆä¸é‡å¯è¿›ç¨‹ï¼‰**

å¦‚æœä¸èƒ½é‡å¯è¿›ç¨‹ï¼Œå¯ä»¥é€šè¿‡ `/proc/<PID>/fd` æˆªæ–­æ–‡ä»¶ï¼š

```bash
# æ‰¾åˆ°è¿›ç¨‹ PID å’Œæ–‡ä»¶æè¿°ç¬¦
lsof +L1 | grep deleted
# å‡è®¾è¾“å‡ºæ˜¾ç¤º PID=1234, FD=10

# æˆªæ–­æ–‡ä»¶ï¼ˆæ¸…ç©ºä½†ä¿æŒæ–‡ä»¶æè¿°ç¬¦æœ‰æ•ˆï¼‰
: > /proc/1234/fd/10

# éªŒè¯ç©ºé—´é‡Šæ”¾
df -hT
```

**æ–¹æ³• 3ï¼šä½¿ç”¨æ­£ç¡®çš„æ–¹å¼"æ¸…ç†"æ—¥å¿—**

```bash
# é”™è¯¯æ–¹å¼ï¼ˆä¼šå¯¼è‡´å¹½çµå ç”¨ï¼‰
rm /var/log/app.log

# æ­£ç¡®æ–¹å¼ï¼ˆæ¸…ç©ºæ–‡ä»¶å†…å®¹ï¼Œä¿æŒæ–‡ä»¶å­˜åœ¨ï¼‰
: > /var/log/app.log
# æˆ–
truncate -s 0 /var/log/app.log
# æˆ–
cat /dev/null > /var/log/app.log
```

### 2.5 æŒ‚è½½ç‚¹ä¸‹çš„éšè—æ–‡ä»¶

å¦ä¸€ä¸ª df å’Œ du ä¸ç¬¦çš„åŸå› ï¼š

```bash
# å‡è®¾ /data æ˜¯ä¸€ä¸ªæŒ‚è½½ç‚¹
# å¦‚æœæœ‰äººåœ¨æŒ‚è½½å‰å†™å…¥äº†æ–‡ä»¶...

# ä¸´æ—¶å¸è½½æŒ‚è½½ç‚¹
sudo umount /data

# æ£€æŸ¥éšè—çš„æ–‡ä»¶
ls -la /data

# å¦‚æœæœ‰æ–‡ä»¶ï¼Œè¿™äº›ä¼šå ç”¨æ ¹åˆ†åŒºç©ºé—´ï¼
# æ¸…ç†åé‡æ–°æŒ‚è½½
sudo mount /data
```

---

## Step 3 -- inode è€—å°½ï¼ˆ15 åˆ†é’Ÿï¼‰

### 3.1 ä»€ä¹ˆæ˜¯ inodeï¼Ÿ

**inode**ï¼ˆIndex Nodeï¼‰å­˜å‚¨æ–‡ä»¶çš„å…ƒæ•°æ®ï¼š
- æ–‡ä»¶å¤§å°ã€æƒé™ã€å±ä¸»
- æ—¶é—´æˆ³ï¼ˆatime, mtime, ctimeï¼‰
- æ•°æ®å—ä½ç½®

**æ¯ä¸ªæ–‡ä»¶éœ€è¦ä¸€ä¸ª inode**ï¼Œå³ä½¿æ˜¯ç©ºæ–‡ä»¶ï¼

```bash
# æŸ¥çœ‹ inode ä½¿ç”¨æƒ…å†µ
df -i

# ç¤ºä¾‹è¾“å‡º
Filesystem      Inodes   IUsed   IFree IUse% Mounted on
/dev/sda1      3276800 3276700     100  100% /
#                       ^^^^^^^ å‡ ä¹ç”¨å®Œï¼
```

### 3.2 inode è€—å°½çš„ç—‡çŠ¶

```bash
# å°è¯•åˆ›å»ºæ–‡ä»¶
touch /tmp/test
# é”™è¯¯ï¼šNo space left on device

# ä½†ç£ç›˜ç©ºé—´å……è¶³
df -h
# /dev/sda1       50G   30G   20G   60% /

# æ£€æŸ¥ inode
df -i
# /dev/sda1      3276800 3276800      0  100% /
#                                     ^ inode ç”¨å®Œäº†ï¼
```

### 3.3 æ‰¾åˆ°å°æ–‡ä»¶å¤§æˆ·

```bash
# ç»Ÿè®¡æ¯ä¸ªç›®å½•ä¸‹çš„æ–‡ä»¶æ•°é‡
find / -xdev -type f -print 2>/dev/null | cut -d'/' -f2-3 | sort | uniq -c | sort -rn | head -20

# æ‰¾åˆ°æ–‡ä»¶æ•°é‡æœ€å¤šçš„ç›®å½•
for i in /*; do echo -n "$i: "; find "$i" -xdev -type f 2>/dev/null | wc -l; done | sort -t: -k2 -rn | head -10

# å¸¸è§ç½ªé­ç¥¸é¦–
ls /var/spool/postfix/maildrop/ | wc -l  # é‚®ä»¶é˜Ÿåˆ—
ls /tmp/ | wc -l                          # ä¸´æ—¶æ–‡ä»¶
ls /var/cache/apt/archives/ | wc -l       # APT ç¼“å­˜
```

### 3.4 æ¸…ç†ç­–ç•¥

```bash
# æ¸…ç†æ—§çš„å†…æ ¸å’ŒåŒ…ç¼“å­˜
sudo apt autoremove  # Debian/Ubuntu
sudo yum autoremove  # RHEL/CentOS

# æ¸…ç†é‚®ä»¶é˜Ÿåˆ—
sudo postsuper -d ALL  # åˆ é™¤æ‰€æœ‰é‚®ä»¶

# æ¸…ç†ä¸´æ—¶æ–‡ä»¶
sudo find /tmp -type f -atime +7 -delete

# æ¸…ç†æ—§æ—¥å¿—
sudo journalctl --vacuum-time=7d
sudo find /var/log -name "*.gz" -mtime +30 -delete
```

---

## Step 4 -- I/O é”™è¯¯ä¸åªè¯»æ–‡ä»¶ç³»ç»Ÿï¼ˆ20 åˆ†é’Ÿï¼‰

### 4.1 æ–‡ä»¶ç³»ç»Ÿå˜æˆåªè¯»çš„åŸå› 

å½“ Linux æ£€æµ‹åˆ°å­˜å‚¨æ•…éšœæ—¶ï¼Œä¼šè‡ªåŠ¨å°†æ–‡ä»¶ç³»ç»Ÿé‡æ–°æŒ‚è½½ä¸ºåªè¯»ï¼ˆRead-onlyï¼‰ï¼Œä»¥é˜²æ­¢æ•°æ®æŸåã€‚

å¸¸è§åŸå› ï¼š
1. **ç£ç›˜ç‰©ç†æ•…éšœ**ï¼ˆåæ‰‡åŒºã€æ§åˆ¶å™¨æ•…éšœï¼‰
2. **æ–‡ä»¶ç³»ç»ŸæŸå**ï¼ˆæ–­ç”µã€éæ­£å¸¸å…³æœºï¼‰
3. **å­˜å‚¨åç«¯é—®é¢˜**ï¼ˆSANã€NFSã€äº‘å­˜å‚¨ï¼‰
4. **RAID é™çº§**

### 4.2 æ£€æŸ¥ I/O é”™è¯¯

```bash
# æ£€æŸ¥å†…æ ¸æ—¥å¿—ä¸­çš„å­˜å‚¨é”™è¯¯
dmesg | grep -iE 'error|fail|ata|scsi|sda|sdb|i/o' | tail -30

# å¸¸è§é”™è¯¯æ¶ˆæ¯
# ata1.00: status: { DRDY ERR }
# ata1.00: error: { UNC }        â† ä¸å¯æ¢å¤è¯»å–é”™è¯¯
# EXT4-fs error (device sda1): ext4_lookup:1604: inode #262145: comm bash: deleted inode referenced
# Remounting filesystem read-only  â† è‡ªåŠ¨é‡æŒ‚è½½ä¸ºåªè¯»
```

### 4.3 æ£€æŸ¥ç£ç›˜ SMART çŠ¶æ€

**SMART**ï¼ˆSelf-Monitoring, Analysis and Reporting Technologyï¼‰æ˜¯ç¡¬ç›˜è‡ªæ£€ç³»ç»Ÿã€‚

```bash
# å®‰è£… smartmontools
sudo apt install smartmontools  # Debian/Ubuntu
sudo yum install smartmontools  # RHEL/CentOS

# æ£€æŸ¥ SMART çŠ¶æ€
sudo smartctl -a /dev/sda

# å…³é”®æŒ‡æ ‡
sudo smartctl -a /dev/sda | grep -E 'Reallocated_Sector|Current_Pending|Offline_Uncorrectable'
# Reallocated_Sector_Ct  > 0 = æœ‰åæ‰‡åŒºè¢«é‡æ˜ å°„
# Current_Pending_Sector > 0 = ç­‰å¾…é‡æ˜ å°„çš„æ‰‡åŒº
# Offline_Uncorrectable  > 0 = æ— æ³•ä¿®å¤çš„åæ‰‡åŒº

# è¿è¡ŒçŸ­æµ‹è¯•
sudo smartctl -t short /dev/sda
# ç­‰å¾…å‡ åˆ†é’ŸåæŸ¥çœ‹ç»“æœ
sudo smartctl -l selftest /dev/sda
```

### 4.4 å¤„ç†åªè¯»æ–‡ä»¶ç³»ç»Ÿ

**Step 1ï¼šç¡®è®¤åªè¯»çŠ¶æ€**

```bash
# æ£€æŸ¥æŒ‚è½½çŠ¶æ€
mount | grep ' / '
# /dev/sda1 on / type ext4 (ro,relatime)
#                          ^^ ro = read-only

# å°è¯•å†™å…¥æµ‹è¯•
touch /tmp/test
# touch: cannot touch '/tmp/test': Read-only file system
```

**Step 2ï¼šæŸ¥æ‰¾åŸå› **

```bash
# æ£€æŸ¥å†…æ ¸æ—¥å¿—
dmesg | tail -50

# æ£€æŸ¥ SMART
sudo smartctl -a /dev/sda

# æ£€æŸ¥æ–‡ä»¶ç³»ç»Ÿæ—¥å¿—
journalctl -k | grep -iE 'ext4|xfs|error'
```

**Step 3ï¼šå°è¯•é‡æ–°æŒ‚è½½ä¸ºè¯»å†™**

```bash
# å°è¯• remount ä¸º rw
sudo mount -o remount,rw /

# å¦‚æœå¤±è´¥ï¼Œè¯´æ˜æœ‰æœªä¿®å¤çš„æ–‡ä»¶ç³»ç»Ÿé”™è¯¯
# éœ€è¦è¿›å…¥å•ç”¨æˆ·æ¨¡å¼æˆ–ä½¿ç”¨ Live CD è¿è¡Œ fsck
```

### 4.5 fsckï¼šæ–‡ä»¶ç³»ç»Ÿæ£€æŸ¥ä¸ä¿®å¤

**å±é™©æ“ä½œè­¦å‘Šï¼**

> **fsck åªèƒ½å¯¹æœªæŒ‚è½½çš„æ–‡ä»¶ç³»ç»Ÿè¿è¡Œï¼**  
> å¯¹å·²æŒ‚è½½çš„åˆ†åŒºè¿è¡Œ fsck ä¼šå¯¼è‡´ä¸¥é‡æ•°æ®æŸåï¼  

```bash
# é”™è¯¯ï¼å±é™©ï¼
sudo fsck /dev/sda1  # å¦‚æœ sda1 æ˜¯æ ¹åˆ†åŒºä¸”å·²æŒ‚è½½

# æ­£ç¡®åšæ³•
# 1. é‡å¯è¿›å…¥æ•‘æ´æ¨¡å¼/å•ç”¨æˆ·æ¨¡å¼
# 2. æˆ–ä½¿ç”¨ Live CD
# 3. ç¡®ä¿åˆ†åŒºæœªæŒ‚è½½åå†è¿è¡Œ fsck
```

**å®‰å…¨çš„ fsck æµç¨‹**ï¼š

```bash
# æ–¹æ³• 1ï¼šé‡å¯æ—¶å¼ºåˆ¶ fsckï¼ˆé€‚ç”¨äºæ ¹åˆ†åŒºï¼‰
sudo touch /forcefsck
sudo reboot

# æ–¹æ³• 2ï¼šå¯¹éæ ¹åˆ†åŒº
sudo umount /dev/sdb1
sudo fsck -y /dev/sdb1
sudo mount /dev/sdb1

# æ–¹æ³• 3ï¼šè¿›å…¥ Emergency Mode
# é‡å¯ååœ¨ GRUB ç•Œé¢ç¼–è¾‘å†…æ ¸å‚æ•°
# æ·»åŠ  systemd.unit=emergency.target
# ç„¶åè¿è¡Œ fsck
```

---

## Step 5 -- å­˜å‚¨é—®é¢˜å†³ç­–æ ‘ï¼ˆ10 åˆ†é’Ÿï¼‰

### 5.1 å®Œæ•´å†³ç­–æ ‘

å½“é‡åˆ°å­˜å‚¨ç›¸å…³é—®é¢˜æ—¶ï¼Œä½¿ç”¨æ­¤å†³ç­–æ ‘ï¼š

<!-- DIAGRAM: storage-decision-tree -->
```
+------------------------------------------------------------------------+
|                       å­˜å‚¨é—®é¢˜è¯Šæ–­å†³ç­–æ ‘                                 |
+------------------------------------------------------------------------+
|                                                                        |
|                           å­˜å‚¨é—®é¢˜                                      |
|                              |                                         |
|                              v                                         |
|                  +------------------------+                            |
|                  | df -hT æ˜¾ç¤ºç£ç›˜æ»¡?     |                            |
|                  +------------------------+                            |
|                     |              |                                   |
|                    Yes             No                                  |
|                     |              |                                   |
|                     v              v                                   |
|        +------------------+   +------------------------+               |
|        | du ç»Ÿè®¡ç›¸ç¬¦?     |   | df -i inode æ»¡?        |               |
|        +------------------+   +------------------------+               |
|           |          |           |              |                      |
|          Yes         No         Yes             No                     |
|           |          |           |              |                      |
|           v          v           v              v                      |
|     +---------+ +---------+ +---------+  +------------------+          |
|     | æ¸…ç†    | | æ£€æŸ¥    | | å°æ–‡ä»¶  |  | I/O é”™è¯¯?        |          |
|     | å¤§æ–‡ä»¶  | | å·²åˆ é™¤  | | è¿‡å¤š    |  | (dmesg æ£€æŸ¥)     |          |
|     |         | | æ–‡ä»¶    | | æ¸…ç†    |  +------------------+          |
|     +---------+ +---------+ +---------+     |          |               |
|                     |                      Yes         No              |
|                     v                       |          |               |
|              +-------------+                v          v               |
|              | lsof +L1    |         +----------+ +----------+         |
|              | grep deleted|         | smartctl | | æ£€æŸ¥æŒ‚è½½ |         |
|              | æ‰¾åˆ°è¿›ç¨‹    |         | æ£€æŸ¥ç£ç›˜ | | æ˜¯å¦åªè¯» |         |
|              | é‡å¯æˆ–æˆªæ–­  |         | è€ƒè™‘ fsck| |          |         |
|              +-------------+         | (å¸è½½å!)| +----------+         |
|                                      +----------+                      |
|                                                                        |
|   å…³é”®å‘½ä»¤é€ŸæŸ¥ï¼š                                                        |
|   - df -hT          : æ£€æŸ¥ç©ºé—´ä½¿ç”¨                                     |
|   - df -i           : æ£€æŸ¥ inode ä½¿ç”¨                                  |
|   - du -sh /path/*  : ç»Ÿè®¡ç›®å½•å¤§å°                                     |
|   - lsof +L1        : æ‰¾å·²åˆ é™¤ä½†å ç”¨çš„æ–‡ä»¶                             |
|   - dmesg | grep -i error : æ£€æŸ¥ I/O é”™è¯¯                              |
|   - smartctl -a     : æ£€æŸ¥ç£ç›˜å¥åº·                                     |
|                                                                        |
+------------------------------------------------------------------------+
```
<!-- /DIAGRAM -->

---

## Step 6 -- çœŸå®æ¡ˆä¾‹ï¼šå¹½çµç£ç›˜å ç”¨ï¼ˆ15 åˆ†é’Ÿï¼‰

### 6.1 åœºæ™¯æè¿°

å‡Œæ™¨ 3 ç‚¹ï¼Œç›‘æ§å‘Šè­¦ï¼š

```
CRITICAL: /var ç£ç›˜ä½¿ç”¨ç‡ 98%
ä¸»æœº: app-server-01
```

### 6.2 åˆæ­¥è¯Šæ–­

```bash
# ç™»å½•æœåŠ¡å™¨
ssh admin@app-server-01

# æ£€æŸ¥ç£ç›˜ä½¿ç”¨
df -hT /var
# Filesystem     Type  Size  Used Avail Use% Mounted on
# /dev/sda2      ext4  100G   98G  2.0G  98% /var

# ç»Ÿè®¡ /var ä¸‹å„ç›®å½•å¤§å°
du -sh /var/* | sort -rh | head -10
# 20G    /var/lib
# 10G    /var/cache
# 8G     /var/log
# ...
# æ€»è®¡çº¦ 40Gï¼Œä½† df æ˜¾ç¤º 98Gï¼
```

### 6.3 å‘ç°å¹½çµå ç”¨

```bash
# æ£€æŸ¥å·²åˆ é™¤ä½†ä»è¢«æŒæœ‰çš„æ–‡ä»¶
lsof +L1 | grep deleted

# è¾“å‡º
# java   12345  app  10w  REG  8,1  53687091200  112233 /var/log/app/catalina.out (deleted)
#                                  ^^^^^^^^^^^ 50GBï¼

# ç¡®è®¤è¿›ç¨‹ä¿¡æ¯
ps aux | grep 12345
# app  12345 ... /opt/tomcat/bin/java ...
```

### 6.4 æ ¹å› åˆ†æ

è¿ç»´å›¢é˜Ÿåœ¨ç™½å¤©æ‰§è¡Œäº†æ—¥å¿—æ¸…ç†ï¼š

```bash
# ä»–ä»¬æ‰§è¡Œçš„å‘½ä»¤
rm /var/log/app/catalina.out
```

ä½† Tomcat è¿›ç¨‹ä»æŒæœ‰è¯¥æ–‡ä»¶çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œå¯¼è‡´ï¼š
- ç›®å½•æ¡ç›®è¢«åˆ é™¤ï¼ˆ`ls` çœ‹ä¸åˆ°æ–‡ä»¶ï¼‰
- inode å’Œæ•°æ®å—æœªé‡Šæ”¾ï¼ˆè¿›ç¨‹ä»åœ¨å†™å…¥ï¼‰
- `df` ç»Ÿè®¡çš„æ˜¯ inode å—ä½¿ç”¨ï¼Œæ‰€ä»¥æ˜¾ç¤º 98%
- `du` ç»Ÿè®¡çš„æ˜¯ç›®å½•æ ‘ï¼Œæ‰€ä»¥åªæœ‰ 40G

### 6.5 è§£å†³æ–¹æ¡ˆ

**æ–¹æ¡ˆ Aï¼šé‡å¯ Tomcatï¼ˆæ¨èï¼‰**

```bash
# æ£€æŸ¥æ˜¯å¦å¯ä»¥é‡å¯
# ç¡®è®¤ä¸šåŠ¡å½±å“

# ä¼˜é›…é‡å¯
sudo systemctl restart tomcat

# éªŒè¯ç©ºé—´é‡Šæ”¾
df -hT /var
# ä½¿ç”¨ç‡ä¸‹é™åˆ°çº¦ 42%
```

**æ–¹æ¡ˆ Bï¼šä¸é‡å¯ï¼Œæˆªæ–­æ–‡ä»¶**

```bash
# æ‰¾åˆ° fd è·¯å¾„
ls -l /proc/12345/fd/ | grep deleted
# lrwx------ 1 app app 64 Jan 10 03:15 10 -> /var/log/app/catalina.out (deleted)

# æˆªæ–­æ–‡ä»¶ï¼ˆç«‹å³é‡Šæ”¾ç©ºé—´ï¼Œä¸å½±å“è¿›ç¨‹ï¼‰
: > /proc/12345/fd/10

# éªŒè¯
df -hT /var
```

### 6.6 é¢„é˜²æªæ–½

```bash
# æ­£ç¡®çš„æ—¥å¿—æ¸…ç†æ–¹å¼
: > /var/log/app/catalina.out

# é…ç½® logrotate
cat > /etc/logrotate.d/tomcat << 'EOF'
/var/log/app/catalina.out {
    daily
    rotate 7
    compress
    missingok
    notifempty
    copytruncate  # å…³é”®ï¼æˆªæ–­è€Œéåˆ é™¤
}
EOF
```

---

## Step 7 -- åæ¨¡å¼ï¼šfsck æŒ‚è½½çš„æ–‡ä»¶ç³»ç»Ÿï¼ˆ10 åˆ†é’Ÿï¼‰

### 7.1 ä¸ºä»€ä¹ˆè¿™æ˜¯ç¾éš¾

```bash
# ç»å¯¹ä¸è¦è¿™æ ·åšï¼
sudo fsck /dev/sda1  # å¦‚æœ sda1 å·²æŒ‚è½½

# åæœï¼š
# - æ–‡ä»¶ç³»ç»Ÿå…ƒæ•°æ®æŸå
# - æ•°æ®ä¸¢å¤±
# - å¯èƒ½éœ€è¦ä»å¤‡ä»½æ¢å¤
```

### 7.2 fsck å®‰å…¨æ£€æŸ¥æ¸…å•

åœ¨è¿è¡Œ fsck ä¹‹å‰ï¼š

- [ ] ç¡®è®¤ç›®æ ‡åˆ†åŒº**æœªæŒ‚è½½**
- [ ] å¦‚æœæ˜¯æ ¹åˆ†åŒºï¼Œéœ€è¦è¿›å…¥æ•‘æ´æ¨¡å¼
- [ ] æœ‰æœ€è¿‘çš„å¤‡ä»½
- [ ] ç†è§£ `-y` å‚æ•°ä¼šè‡ªåŠ¨ä¿®å¤ï¼ˆå¯èƒ½åˆ é™¤æŸåæ–‡ä»¶ï¼‰

```bash
# æ£€æŸ¥åˆ†åŒºæ˜¯å¦æŒ‚è½½
mount | grep sda1

# å¦‚æœéœ€è¦ fsck æ ¹åˆ†åŒº
# æ–¹æ³• 1ï¼šè®¾ç½®ä¸‹æ¬¡å¯åŠ¨æ—¶ fsck
sudo touch /forcefsck
sudo reboot

# æ–¹æ³• 2ï¼šLive CD å¯åŠ¨å
# ï¼ˆä» Live CD å¯åŠ¨ï¼‰
sudo fsck -y /dev/sda1
```

---

## åŠ¨æ‰‹å®éªŒï¼ˆ20 åˆ†é’Ÿï¼‰

### å®éªŒ 1ï¼šæ¨¡æ‹Ÿå¹½çµç£ç›˜å ç”¨

```bash
# åˆ›å»ºæµ‹è¯•ç¯å¢ƒ
mkdir -p /tmp/storage-lab
cd /tmp/storage-lab

# åˆ›å»ºä¸€ä¸ªå¤§æ–‡ä»¶
dd if=/dev/zero of=bigfile.log bs=1M count=100

# æ£€æŸ¥ç£ç›˜ä½¿ç”¨
df -h /tmp

# ç”¨ tail -f æŒæœ‰è¿™ä¸ªæ–‡ä»¶
tail -f bigfile.log &
TAIL_PID=$!

# åˆ é™¤æ–‡ä»¶
rm bigfile.log

# æ£€æŸ¥ - æ–‡ä»¶æ¶ˆå¤±äº†
ls -la bigfile.log
# ls: cannot access 'bigfile.log': No such file or directory

# ä½† df æ˜¾ç¤ºç©ºé—´æœªé‡Šæ”¾ï¼
df -h /tmp

# æ‰¾åˆ°å¹½çµæ–‡ä»¶
lsof +L1 | grep bigfile

# è§£å†³æ–¹æ¡ˆ 1ï¼šæ€æ­»è¿›ç¨‹
kill $TAIL_PID

# éªŒè¯ç©ºé—´é‡Šæ”¾
df -h /tmp
```

### å®éªŒ 2ï¼šæ£€æŸ¥ç³»ç»Ÿ SMART çŠ¶æ€

```bash
# å®‰è£… smartmontoolsï¼ˆå¦‚æœæœªå®‰è£…ï¼‰
sudo apt install smartmontools -y 2>/dev/null || sudo yum install smartmontools -y

# åˆ—å‡ºæ‰€æœ‰ç£ç›˜
lsblk

# æ£€æŸ¥ç¬¬ä¸€å—ç£ç›˜çš„ SMART çŠ¶æ€ï¼ˆéœ€è¦çœŸå®ç£ç›˜ï¼‰
sudo smartctl -a /dev/sda 2>/dev/null || echo "SMART not supported or virtual disk"

# æŸ¥çœ‹å…³é”®å¥åº·æŒ‡æ ‡
sudo smartctl -H /dev/sda 2>/dev/null

# å¦‚æœæ˜¯è™šæ‹Ÿæœºï¼ŒSMART å¯èƒ½ä¸å¯ç”¨
# è¿™æ˜¯æ­£å¸¸çš„ï¼Œäº‘æœåŠ¡å™¨é€šå¸¸ä¸æš´éœ² SMART æ•°æ®
```

### å®éªŒ 3ï¼šinode ä½¿ç”¨åˆ†æ

```bash
# æ£€æŸ¥ inode ä½¿ç”¨
df -i

# æ‰¾å‡ºæ–‡ä»¶æ•°é‡æœ€å¤šçš„ç›®å½•
echo "=== Top 10 directories by file count ==="
for dir in /var /tmp /home; do
    if [ -d "$dir" ]; then
        count=$(find "$dir" -xdev -type f 2>/dev/null | wc -l)
        echo "$dir: $count files"
    fi
done

# æ¸…ç†æµ‹è¯•æ–‡ä»¶
rm -rf /tmp/storage-lab
```

---

## æ£€æŸ¥æ¸…å•

å®Œæˆæœ¬è¯¾åï¼Œä½ åº”è¯¥èƒ½å¤Ÿï¼š

- [ ] ä½¿ç”¨ `df -hT` å’Œ `df -i` æ£€æŸ¥ç©ºé—´å’Œ inode ä½¿ç”¨
- [ ] ä½¿ç”¨ `du -sh` å®šä½å¤§ç›®å½•
- [ ] è§£é‡Šä¸ºä»€ä¹ˆ `df` å’Œ `du` ä¼šä¸ä¸€è‡´
- [ ] ä½¿ç”¨ `lsof +L1` æ‰¾åˆ°å·²åˆ é™¤ä½†ä»å ç”¨ç©ºé—´çš„æ–‡ä»¶
- [ ] ä½¿ç”¨æˆªæ–­ï¼ˆtruncateï¼‰è€Œéåˆ é™¤ï¼ˆrmï¼‰æ¥æ¸…ç†æ´»è·ƒæ—¥å¿—
- [ ] æ£€æŸ¥ `dmesg` ä¸­çš„ I/O é”™è¯¯
- [ ] ä½¿ç”¨ `smartctl` æ£€æŸ¥ç£ç›˜å¥åº·çŠ¶æ€
- [ ] è§£é‡Šä¸ºä»€ä¹ˆä¸èƒ½å¯¹æŒ‚è½½çš„æ–‡ä»¶ç³»ç»Ÿè¿è¡Œ `fsck`
- [ ] å¤„ç†åªè¯»æ–‡ä»¶ç³»ç»Ÿï¼ˆremount rw æˆ– fsckï¼‰

---

## æœ¬è¯¾å°ç»“

| é—®é¢˜ç±»å‹ | è¯Šæ–­å‘½ä»¤ | è§£å†³æ–¹æ¡ˆ |
|----------|----------|----------|
| ç©ºé—´æ»¡ï¼ˆdf å’Œ du ä¸€è‡´ï¼‰ | `du -sh /path/*` | åˆ é™¤/æ¸…ç†å¤§æ–‡ä»¶ |
| ç©ºé—´æ»¡ï¼ˆdf å’Œ du ä¸ç¬¦ï¼‰ | `lsof +L1 \| grep deleted` | é‡å¯è¿›ç¨‹æˆ–æˆªæ–­ fd |
| inode è€—å°½ | `df -i` | æ¸…ç†å°æ–‡ä»¶ï¼Œæ¸…ç†ç¼“å­˜ |
| I/O é”™è¯¯ | `dmesg`, `smartctl -a` | æ›´æ¢ç£ç›˜ï¼Œfsck ä¿®å¤ |
| åªè¯»æ–‡ä»¶ç³»ç»Ÿ | `mount`, `dmesg` | æ‰¾åŸå› ï¼Œremount æˆ– fsck |

**æ ¸å¿ƒç»éªŒ**ï¼š

> df æ»¡ä½† du ä¸ç¬¦ â†’ 99% æ˜¯å·²åˆ é™¤æ–‡ä»¶ä»è¢«è¿›ç¨‹æŒæœ‰ã€‚  
> ä½¿ç”¨ `lsof +L1` è€Œéç›²ç›®æ¸…ç†ã€‚  
> æ¸…ç†æ—¥å¿—ç”¨æˆªæ–­ï¼ˆ`: >`ï¼‰è€Œéåˆ é™¤ï¼ˆ`rm`ï¼‰ã€‚  
> fsck åªèƒ½å¯¹**æœªæŒ‚è½½**çš„åˆ†åŒºè¿è¡Œï¼  

---

## é¢è¯•å‡†å¤‡

### å¸¸è§æ—¥è¯­é¢è¯•é—®é¢˜

**Q: ãƒ‡ã‚£ã‚¹ã‚¯éšœå®³ã®åˆ‡ã‚Šåˆ†ã‘ã«ã¤ã„ã¦èª¬æ˜ã—ã¦ãã ã•ã„ã€‚**

A: ãƒ‡ã‚£ã‚¹ã‚¯éšœå®³ã®åˆ‡ã‚Šåˆ†ã‘ã¯3ã¤ã®è¦³ç‚¹ã§è¡Œã„ã¾ã™ï¼š

1. **å®¹é‡å•é¡Œ**ï¼ˆdf -hT ã§ç¢ºèªï¼‰
   - df ã¨ du ã®å·®ç•°ãŒã‚ã‚‹å ´åˆã€å‰Šé™¤æ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«ãŒé–‹ã„ãŸã¾ã¾ã®å¯èƒ½æ€§ï¼ˆlsof +L1 ã§ç¢ºèªï¼‰

2. **inode æ¯æ¸‡**ï¼ˆdf -i ã§ç¢ºèªï¼‰
   - å°ã•ã„ãƒ•ã‚¡ã‚¤ãƒ«ãŒå¤§é‡ã«ã‚ã‚‹å ´åˆã«ç™ºç”Ÿ

3. **I/O ã‚¨ãƒ©ãƒ¼**ï¼ˆdmesg ã§ç¢ºèªï¼‰
   - smartctl ã§ãƒ‡ã‚£ã‚¹ã‚¯å¥åº·çŠ¶æ…‹ã‚’ç¢ºèª
   - èª­ã¿å–ã‚Šå°‚ç”¨ã«ãªã£ãŸå ´åˆã¯ fsck ãŒå¿…è¦ï¼ˆã‚¢ãƒ³ãƒã‚¦ãƒ³ãƒˆå¾Œï¼ï¼‰

**Q: df ã¨ du ã®çµæœãŒä¸€è‡´ã—ãªã„å ´åˆã€ä½•ã‚’ç–‘ã„ã¾ã™ã‹ï¼Ÿ**

A: æœ€ã‚‚å¤šã„ã®ã¯ã€Œå‰Šé™¤ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ãŒãƒ—ãƒ­ã‚»ã‚¹ã«ä¿æŒã•ã‚Œã¦ã„ã‚‹ã€ã‚±ãƒ¼ã‚¹ã§ã™ã€‚

```bash
# ç¢ºèªã‚³ãƒãƒ³ãƒ‰
lsof +L1 | grep deleted
```

è§£æ±ºç­–ã¯ï¼š
- ãƒ—ãƒ­ã‚»ã‚¹ã‚’å†èµ·å‹•ã™ã‚‹
- ã¾ãŸã¯ `/proc/<PID>/fd` çµŒç”±ã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ truncate ã™ã‚‹

**Q: æœ¬ç•ªç’°å¢ƒã§ fsck ã‚’å®Ÿè¡Œã™ã‚‹éš›ã®æ³¨æ„ç‚¹ã¯ï¼Ÿ**

A: æœ€ã‚‚é‡è¦ãªã®ã¯ã€Œ**ãƒã‚¦ãƒ³ãƒˆä¸­ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã«ã¯çµ¶å¯¾ã«å®Ÿè¡Œã—ãªã„**ã€ã“ã¨ã§ã™ã€‚

- ãƒã‚¦ãƒ³ãƒˆä¸­ã® fsck ã¯ãƒ‡ãƒ¼ã‚¿ç ´å£Šã‚’å¼•ãèµ·ã“ã—ã¾ã™
- ãƒ«ãƒ¼ãƒˆãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³ã®å ´åˆã¯ rescue mode ã‚„ Live CD ã‹ã‚‰å®Ÿè¡Œ
- å®Ÿè¡Œå‰ã«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ç¢ºèªãŒå¿…é ˆ

---

## æ—¥æœ¬ IT èŒåœºï¼šãƒ‡ã‚£ã‚¹ã‚¯éšœå®³

### ã‚ˆãä½¿ã†è¡¨ç¾

| æ—¥è¯­ | è¯»éŸ³ | åœºæ™¯ |
|------|------|------|
| ãƒ‡ã‚£ã‚¹ã‚¯ãƒ•ãƒ« | disuku furu | ç£ç›˜æ»¡ |
| å®¹é‡ä¸è¶³ | youryou fusoku | ç©ºé—´ä¸è¶³ |
| å®¹é‡ç›£è¦– | youryou kanshi | å®¹é‡ç›‘æ§ |
| æ·±å¤œã‚¢ãƒ©ãƒ¼ãƒˆ | shinya araato | æ·±å¤œå‘Šè­¦ |
| ä¸€æ¬¡å¯¾å¿œ | ichiji taiou | åˆæ­¥å¤„ç† |

### èŒåœºæç¤º

**ãƒ‡ã‚£ã‚¹ã‚¯éšœå®³ã¯æ·±å¤œã‚¢ãƒ©ãƒ¼ãƒˆã§ã‚ˆãã‚ã‚‹**

å­˜å‚¨é—®é¢˜æ˜¯æ—¥æœ¬ä¼ä¸šå¤œç­å‘Šè­¦çš„å¸¸å®¢ã€‚å‡ ä¸ªè¦ç‚¹ï¼š

1. **å®¹é‡ç›£è¦–ã¯é‹ç”¨ç›£è¦–ã®åŸºæœ¬**
   - 80% è­¦å‘Šã€90% å‘Šè­¦æ˜¯æ ‡å‡†é…ç½®
   - ä¸è¦ç­‰åˆ° 100% æ‰å¤„ç†

2. **æ¸…ç†å‰å…ˆç¡®è®¤**
   - ä¸è¦ç›´æ¥åˆ é™¤ï¼Œå…ˆç¡®è®¤æ–‡ä»¶ç”¨é€”
   - æ—¥å¿—æ–‡ä»¶ç”¨ truncate è€Œé rm

3. **è®°å½•å¤„ç†è¿‡ç¨‹**
   - æ·±å¤œå¤„ç†ä¹Ÿè¦ç•™ä¸‹è®°å½•
   - ç¬¬äºŒå¤©æ—©ä¸Šè¦èƒ½è§£é‡Šåšäº†ä»€ä¹ˆ

---

## ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ï¼ˆæœ¬èª²è‡ªä½“ã®å•é¡Œè§£æ±ºï¼‰

### lsof å‘½ä»¤å¾ˆæ…¢

```bash
# lsof æ‰«ææ‰€æœ‰è¿›ç¨‹çš„ fdï¼Œåœ¨å¤§ç³»ç»Ÿä¸Šå¯èƒ½å¾ˆæ…¢

# é™åˆ¶æœç´¢èŒƒå›´
lsof +D /var/log  # åªæœç´¢ç‰¹å®šç›®å½•

# æˆ–ä½¿ç”¨ find é€šè¿‡ /proc ç›´æ¥æŸ¥æ‰¾
find /proc/*/fd -ls 2>/dev/null | grep deleted
```

### smartctl æ˜¾ç¤º "Not Available"

```bash
# è™šæ‹Ÿæœºæˆ–äº‘æœåŠ¡å™¨é€šå¸¸ä¸æš´éœ² SMART
# è¿™æ˜¯æ­£å¸¸çš„

# åœ¨è¿™äº›ç¯å¢ƒä¸­ï¼Œå…³æ³¨ï¼š
# - äº‘å‚å•†çš„ç£ç›˜å¥åº· API
# - dmesg ä¸­çš„ I/O é”™è¯¯
# - åº”ç”¨å±‚çš„è¶…æ—¶å’Œé”™è¯¯æ—¥å¿—
```

### df å’Œ mount æ˜¾ç¤ºä¸åŒ

```bash
# å¯èƒ½æœ‰ bind mount æˆ– overlay
findmnt --list

# æŸ¥çœ‹æ‰€æœ‰æŒ‚è½½ï¼ˆåŒ…æ‹¬éšè—çš„ï¼‰
cat /proc/mounts
```

---

## å»¶ä¼¸é˜…è¯»

- [Red Hat - Managing Disk Space](https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/9/html/managing_storage_devices/)
- [smartmontools Documentation](https://www.smartmontools.org/wiki/TocDoc)
- [Linux Filesystem Hierarchy](https://refspecs.linuxfoundation.org/FHS_3.0/fhs/index.html)
- ä¸Šä¸€è¯¾ï¼š[04 - ç½‘ç»œé—®é¢˜](../04-network-problems/) -- åˆ†å±‚è¯Šæ–­
- ä¸‹ä¸€è¯¾ï¼š[06 - æ€§èƒ½é—®é¢˜](../06-performance/) -- USE æ–¹æ³•è®ºå®æˆ˜

---

## ç³»åˆ—å¯¼èˆª

[<-- 04 - ç½‘ç»œé—®é¢˜](../04-network-problems/) | [ç³»åˆ—é¦–é¡µ](../) | [06 - æ€§èƒ½é—®é¢˜ -->](../06-performance/)
