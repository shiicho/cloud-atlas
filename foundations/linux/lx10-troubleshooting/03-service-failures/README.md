# 03 - æœåŠ¡æ•…éšœï¼šsystemd æ·±åº¦è¯Šæ–­ï¼ˆService Failures: systemd Deep Diagnosisï¼‰

> **ç›®æ ‡**ï¼šæŒæ¡ systemd æœåŠ¡æ•…éšœçš„ç³»ç»Ÿæ€§è¯Šæ–­æ–¹æ³•ï¼Œä»çŠ¶æ€æ£€æŸ¥åˆ°ä¾èµ–åˆ†æ  
> **å‰ç½®**ï¼šLX05 systemd åŸºç¡€ã€Lesson 01 æ•…éšœæ’æŸ¥æ–¹æ³•è®º  
> **æ—¶é—´**ï¼šâš¡ 30 åˆ†é’Ÿï¼ˆé€Ÿè¯»ï¼‰/ ğŸ”¬ 120 åˆ†é’Ÿï¼ˆå®Œæ•´å®æ“ï¼‰  
> **æ ¸å¿ƒç†å¿µ**ï¼šActive ä¸ç­‰äºå¯ç”¨ï¼Œä¾èµ–åˆ†ææ˜¯å…³é”®  

---

## å°†å­¦åˆ°çš„å†…å®¹

1. ä½¿ç”¨ systemctl å’Œ journalctl è¯Šæ–­æœåŠ¡æ•…éšœ
2. ç†è§£å’Œåˆ†æ systemd ä¾èµ–å…³ç³»
3. è¯†åˆ«å¸¸è§æœåŠ¡å¤±è´¥æ¨¡å¼ï¼ˆé…ç½®é”™è¯¯ã€æƒé™ã€ä¾èµ–ï¼‰
4. ä½¿ç”¨ systemd-analyze åˆ†æå¯åŠ¨é“¾
5. è¯Šæ–­ Socket Activation é—®é¢˜

---

## å…ˆè·‘èµ·æ¥ï¼ï¼ˆ10 åˆ†é’Ÿï¼‰

> æœåŠ¡å‡ºé—®é¢˜äº†ï¼Ÿå…ˆè¿è¡Œè¿™ 4 æ¡å‘½ä»¤ï¼Œç«‹å³çœ‹åˆ°é—®é¢˜æ‰€åœ¨ã€‚  

å‡è®¾ nginx æœåŠ¡ä¸å·¥ä½œï¼Œè¿™æ ·å¿«é€Ÿè¯Šæ–­ï¼š

```bash
# 1. æŸ¥çœ‹æœåŠ¡çŠ¶æ€ï¼ˆæœ€é‡è¦çš„ç¬¬ä¸€æ­¥ï¼‰
systemctl status nginx

# 2. æŸ¥çœ‹æœ€è¿‘é”™è¯¯æ—¥å¿—
journalctl -u nginx -p err --since '1 hour ago'

# 3. æ£€æŸ¥æ‰€æœ‰å¤±è´¥çš„æœåŠ¡
systemctl --failed

# 4. æ£€æŸ¥ç«¯å£æ˜¯å¦çœŸçš„åœ¨ç›‘å¬
ss -lntup | grep ':80\|:443'
```

**å…¸å‹è¾“å‡ºè§£è¯»**ï¼š

```
# systemctl status nginx å¯èƒ½æ˜¾ç¤ºï¼š
â— nginx.service - A high performance web server
     Loaded: loaded (/usr/lib/systemd/system/nginx.service; enabled)
     Active: failed (Result: exit-code) since Fri 2026-01-10 14:30:00 JST; 5min ago
    Process: 12345 ExecStart=/usr/sbin/nginx (code=exited, status=1/FAILURE)

# å…³é”®ä¿¡æ¯ï¼š
# - Active: failed    â†’ æœåŠ¡å¯åŠ¨å¤±è´¥
# - exit-code         â†’ ç¨‹åºè¿”å›äº†éé›¶é€€å‡ºç 
# - status=1/FAILURE  â†’ é€€å‡ºç æ˜¯ 1
```

**ä½ åˆšåˆšç”¨ 4 æ¡å‘½ä»¤å®šä½äº†æœåŠ¡é—®é¢˜çš„æ–¹å‘ï¼**

ç°åœ¨è®©æˆ‘ä»¬æ·±å…¥å­¦ä¹  systemd æœåŠ¡è¯Šæ–­çš„å®Œæ•´æ–¹æ³•ã€‚

---

## Step 1 -- æœåŠ¡è¯Šæ–­å‘½ä»¤è¯¦è§£ï¼ˆ25 åˆ†é’Ÿï¼‰

### 1.1 systemctl statusï¼šæœåŠ¡çŠ¶æ€å…¨æ™¯

`systemctl status` æ˜¯è¯Šæ–­æœåŠ¡é—®é¢˜çš„ç¬¬ä¸€æ­¥ï¼Œå®ƒæä¾›æœåŠ¡çš„å®Œæ•´çŠ¶æ€å¿«ç…§ã€‚

```bash
# åŸºæœ¬ç”¨æ³•
systemctl status nginx

# æ˜¾ç¤ºæ›´å¤šæ—¥å¿—è¡Œï¼ˆé»˜è®¤ 10 è¡Œï¼‰
systemctl status nginx -l -n 50
```

**è¾“å‡ºè§£è¯»**ï¼š

<!-- DIAGRAM: systemctl-status-anatomy -->
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    systemctl status è¾“å‡ºè§£å‰–                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â— nginx.service - A high performance web server                            â”‚
â”‚  â”‚                 â””â”€â”€â”€â”€â”€â”€â”€â”€ æœåŠ¡æè¿°ï¼ˆæ¥è‡ª unit fileï¼‰                      â”‚
â”‚  â”‚                                                                          â”‚
â”‚  â”‚  Loaded: loaded (/usr/lib/systemd/system/nginx.service; enabled)        â”‚
â”‚  â”‚          â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ unit file è·¯å¾„ â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚             â”‚
â”‚  â”‚          â”‚                                               â”‚              â”‚
â”‚  â”‚          â””â”€â”€ åŠ è½½çŠ¶æ€                          å¼€æœºå¯åŠ¨çŠ¶æ€              â”‚
â”‚  â”‚                                                                          â”‚
â”‚  â”‚  Active: active (running) since Fri 2026-01-10 10:00:00 JST; 4h ago    â”‚
â”‚  â”‚          â”‚      â””â”€â”€â”€â”€â”€â”€â”˜                                                 â”‚
â”‚  â”‚          â”‚      å­çŠ¶æ€                                                   â”‚
â”‚  â”‚          â””â”€â”€ ä¸»çŠ¶æ€                                                      â”‚
â”‚  â”‚                                                                          â”‚
â”‚  â”‚  Main PID: 1234 (nginx)                                                  â”‚
â”‚  â”‚            â””â”€â”€â”€â”€ ä¸»è¿›ç¨‹ PID                                              â”‚
â”‚  â”‚                                                                          â”‚
â”‚  â”‚  Tasks: 5 (limit: 4096)                                                  â”‚
â”‚  â”‚  Memory: 12.0M                                                           â”‚
â”‚  â”‚  CGroup: /system.slice/nginx.service                                     â”‚
â”‚  â”‚          â”œâ”€1234 nginx: master process                                    â”‚
â”‚  â”‚          â””â”€1235 nginx: worker process                                    â”‚
â”‚  â”‚                                                                          â”‚
â”‚  â””â”€â”€ æœ€è¿‘æ—¥å¿—ï¼ˆjournalctl æ‘˜å½•ï¼‰                                             â”‚
â”‚                                                                             â”‚
â”‚  ä¸»çŠ¶æ€å¯èƒ½å€¼ï¼š                                                              â”‚
â”‚  â€¢ active     - æœåŠ¡æ­£åœ¨è¿è¡Œ                                                â”‚
â”‚  â€¢ inactive   - æœåŠ¡å·²åœæ­¢                                                  â”‚
â”‚  â€¢ failed     - æœåŠ¡å¯åŠ¨å¤±è´¥                                                â”‚
â”‚  â€¢ activating - æ­£åœ¨å¯åŠ¨ä¸­                                                  â”‚
â”‚  â€¢ deactivating - æ­£åœ¨åœæ­¢ä¸­                                                â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
<!-- /DIAGRAM -->

### 1.2 å¸¸è§çŠ¶æ€å’Œé€€å‡ºç 

| çŠ¶æ€ | å«ä¹‰ | ä¸‹ä¸€æ­¥ |
|------|------|--------|
| `active (running)` | æœåŠ¡æ­£å¸¸è¿è¡Œ | ä½†è¦éªŒè¯ç«¯å£ï¼ |
| `active (exited)` | ä¸€æ¬¡æ€§æœåŠ¡ï¼Œå·²æ‰§è¡Œå®Œæˆ | æ­£å¸¸ï¼ˆå¦‚ oneshot ç±»å‹ï¼‰ |
| `inactive (dead)` | æœåŠ¡æœªè¿è¡Œ | æ£€æŸ¥æ˜¯å¦åº”è¯¥è¿è¡Œ |
| `failed` | å¯åŠ¨å¤±è´¥ | æŸ¥çœ‹ journalctl æ—¥å¿— |
| `activating (auto-restart)` | æ­£åœ¨é‡å¯ | å¯èƒ½åœ¨å¾ªç¯å´©æºƒ |

**å¸¸è§é€€å‡ºç **ï¼š

| é€€å‡ºç  | å«ä¹‰ | å¸¸è§åŸå›  |
|--------|------|----------|
| 0 | æˆåŠŸ | æ­£å¸¸é€€å‡º |
| 1 | é€šç”¨é”™è¯¯ | é…ç½®é”™è¯¯ã€æƒé™é—®é¢˜ |
| 2 | å‘½ä»¤è¡Œå‚æ•°é”™è¯¯ | ExecStart å‚æ•°æœ‰è¯¯ |
| 126 | æƒé™ä¸è¶³ | æ— æ‰§è¡Œæƒé™ |
| 127 | å‘½ä»¤æœªæ‰¾åˆ° | è·¯å¾„é”™è¯¯æˆ–ç¨‹åºä¸å­˜åœ¨ |
| 137 | SIGKILL (128+9) | OOM Killer æˆ–æ‰‹åŠ¨ kill -9 |
| 143 | SIGTERM (128+15) | æ­£å¸¸ç»ˆæ­¢ä¿¡å· |

### 1.3 journalctlï¼šæ·±å…¥æ—¥å¿—åˆ†æ

`journalctl` æ˜¯æŸ¥çœ‹ systemd æœåŠ¡æ—¥å¿—çš„æ ¸å¿ƒå·¥å…·ã€‚

```bash
# æŸ¥çœ‹ç‰¹å®šæœåŠ¡æ—¥å¿—
journalctl -u nginx

# åªçœ‹é”™è¯¯åŠä»¥ä¸Šçº§åˆ«
journalctl -u nginx -p err

# æ—¶é—´èŒƒå›´è¿‡æ»¤
journalctl -u nginx --since '1 hour ago'
journalctl -u nginx --since '2026-01-10 14:00' --until '2026-01-10 15:00'

# å®æ—¶è·Ÿè¸ªæ—¥å¿—
journalctl -u nginx -f

# æœ¬æ¬¡å¯åŠ¨ä»¥æ¥çš„æ—¥å¿—
journalctl -u nginx -b

# è¾“å‡ºä¸º JSONï¼ˆè„šæœ¬å¤„ç†ï¼‰
journalctl -u nginx -o json-pretty
```

**ä¼˜å…ˆçº§çº§åˆ«**ï¼ˆ-p å‚æ•°ï¼‰ï¼š

| çº§åˆ« | å€¼ | å«ä¹‰ |
|------|-----|------|
| emerg | 0 | ç³»ç»Ÿä¸å¯ç”¨ |
| alert | 1 | å¿…é¡»ç«‹å³å¤„ç† |
| crit | 2 | ä¸¥é‡é”™è¯¯ |
| err | 3 | é”™è¯¯ |
| warning | 4 | è­¦å‘Š |
| notice | 5 | æ­£å¸¸ä½†é‡è¦ |
| info | 6 | ä¿¡æ¯ |
| debug | 7 | è°ƒè¯• |

```bash
# åªçœ‹ error åŠä»¥ä¸Šï¼ˆerr, crit, alert, emergï¼‰
journalctl -u nginx -p err

# åªçœ‹ warning åŠä»¥ä¸Š
journalctl -u nginx -p warning
```

### 1.4 systemctl showï¼šæœåŠ¡è¯¦ç»†å±æ€§

`systemctl show` æ˜¾ç¤ºæœåŠ¡çš„æ‰€æœ‰å†…éƒ¨å±æ€§ï¼Œç”¨äºæ·±åº¦è¯Šæ–­ã€‚

```bash
# æ˜¾ç¤ºæ‰€æœ‰å±æ€§
systemctl show nginx

# æŸ¥çœ‹ç‰¹å®šå±æ€§
systemctl show nginx -p MainPID,ExecMainStatus,ActiveState

# å¸¸ç”¨å±æ€§
systemctl show nginx -p \
  MainPID,\
  ExecMainStatus,\
  ExecMainStartTimestamp,\
  ActiveState,\
  SubState,\
  Result,\
  NRestarts,\
  EnvironmentFiles
```

**å…³é”®å±æ€§è¯´æ˜**ï¼š

| å±æ€§ | å«ä¹‰ | ç”¨é€” |
|------|------|------|
| `MainPID` | ä¸»è¿›ç¨‹ PID | è¿½è¸ªè¿›ç¨‹çŠ¶æ€ |
| `ExecMainStatus` | ä¸»è¿›ç¨‹é€€å‡ºç  | åˆ¤æ–­å¤±è´¥åŸå›  |
| `Result` | æœ€è¿‘ä¸€æ¬¡å¯åŠ¨ç»“æœ | success/exit-code/signal ç­‰ |
| `NRestarts` | é‡å¯æ¬¡æ•° | åˆ¤æ–­æ˜¯å¦åœ¨å¾ªç¯å´©æºƒ |
| `EnvironmentFiles` | ç¯å¢ƒå˜é‡æ–‡ä»¶ | æ£€æŸ¥é…ç½®æ–‡ä»¶æ˜¯å¦åŠ è½½ |

---

## Step 2 -- ä¾èµ–åˆ†æï¼šç†è§£å¯åŠ¨é“¾ï¼ˆ25 åˆ†é’Ÿï¼‰

### 2.1 ä¸ºä»€ä¹ˆéœ€è¦ä¾èµ–åˆ†æï¼Ÿ

æœåŠ¡ä¸æ˜¯å­¤ç«‹è¿è¡Œçš„ã€‚ä¸€ä¸ªæœåŠ¡å¯èƒ½ä¾èµ–ï¼š
- ç½‘ç»œï¼ˆnetwork.targetï¼‰
- å…¶ä»–æœåŠ¡ï¼ˆå¦‚æ•°æ®åº“ï¼‰
- ç‰¹å®šè·¯å¾„ï¼ˆå¦‚ /var/lib/mysqlï¼‰
- æ—¶é—´åŒæ­¥ï¼ˆtime-sync.targetï¼‰

å¦‚æœä¾èµ–æ²¡æœ‰æ»¡è¶³ï¼ŒæœåŠ¡å¯èƒ½ï¼š
- å¯åŠ¨å¤±è´¥
- å¯åŠ¨äº†ä½†åŠŸèƒ½å¼‚å¸¸
- å¯åŠ¨é¡ºåºé”™è¯¯

### 2.2 systemctl list-dependencies

```bash
# æŸ¥çœ‹æœåŠ¡çš„ä¾èµ–æ ‘
systemctl list-dependencies nginx

# æŸ¥çœ‹å®Œæ•´æ ‘ï¼ˆåŒ…æ‹¬ targetï¼‰
systemctl list-dependencies nginx --all

# æŸ¥çœ‹è°ä¾èµ–è¿™ä¸ªæœåŠ¡ï¼ˆåå‘ä¾èµ–ï¼‰
systemctl list-dependencies nginx --reverse

# æŸ¥çœ‹å¯åŠ¨å‰éœ€è¦ä»€ä¹ˆ
systemctl list-dependencies nginx --before

# æŸ¥çœ‹å¯åŠ¨åéœ€è¦ä»€ä¹ˆ
systemctl list-dependencies nginx --after
```

**è¾“å‡ºç¤ºä¾‹**ï¼š

```
nginx.service
â— â”œâ”€system.slice
â— â”œâ”€sysinit.target
â— â”‚ â”œâ”€dev-hugepages.mount
â— â”‚ â”œâ”€dev-mqueue.mount
â— â”‚ â””â”€...
â— â””â”€network-online.target
â—   â””â”€NetworkManager-wait-online.service
```

### 2.3 ä¾èµ–å…³ç³»ç±»å‹

systemd æœ‰å¤šç§ä¾èµ–å…³ç³»ï¼Œç†è§£å®ƒä»¬å¯¹è¯Šæ–­è‡³å…³é‡è¦ï¼š

<!-- DIAGRAM: dependency-types -->
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    systemd ä¾èµ–å…³ç³»ç±»å‹                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Requires= (å¼ºä¾èµ–)                                                  â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚   â”‚
â”‚  â”‚  â”‚   ServiceA    â”‚ â”€â”€â”€â”€â”€â”€â–¶ â”‚   ServiceB    â”‚                        â”‚   â”‚
â”‚  â”‚  â”‚  (Requires)   â”‚         â”‚               â”‚                        â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚   â”‚
â”‚  â”‚  å¦‚æœ B å¯åŠ¨å¤±è´¥æˆ–åœæ­¢ï¼ŒA ä¹Ÿä¼šåœæ­¢                                   â”‚   â”‚
â”‚  â”‚  æœ€ä¸¥æ ¼çš„ä¾èµ–å…³ç³»                                                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Wants= (å¼±ä¾èµ–)                                                     â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚   â”‚
â”‚  â”‚  â”‚   ServiceA    â”‚ â”€ â”€ â”€ â–¶ â”‚   ServiceB    â”‚                        â”‚   â”‚
â”‚  â”‚  â”‚   (Wants)     â”‚         â”‚               â”‚                        â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚   â”‚
â”‚  â”‚  A æƒ³è¦ B ä¸€èµ·å¯åŠ¨ï¼Œä½† B å¤±è´¥ä¸å½±å“ A                                â”‚   â”‚
â”‚  â”‚  æ¨èçš„é»˜è®¤ä¾èµ–æ–¹å¼                                                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  After= (é¡ºåºä¾èµ–)                                                   â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚   â”‚
â”‚  â”‚  â”‚   ServiceA    â”‚         â”‚   ServiceB    â”‚                        â”‚   â”‚
â”‚  â”‚  â”‚   (After=B)   â”‚  â—€â”€â”€â”€â”€  â”‚               â”‚                        â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚   â”‚
â”‚  â”‚  åªå®šä¹‰å¯åŠ¨é¡ºåºï¼ˆA åœ¨ B ä¹‹åå¯åŠ¨ï¼‰                                   â”‚   â”‚
â”‚  â”‚  ä¸ä¼šå¯åŠ¨ Bï¼Œåªæ˜¯"å¦‚æœ B è¦å¯åŠ¨ï¼Œå…ˆå¯åŠ¨ B"                           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â”‚  å¸¸è§ç»„åˆï¼š                                                                 â”‚
â”‚  â€¢ Requires=B + After=B  â†’  å¿…é¡»ç­‰ B å¯åŠ¨æˆåŠŸåæ‰å¯åŠ¨ A                    â”‚
â”‚  â€¢ Wants=B + After=B     â†’  å¸Œæœ› B å…ˆå¯åŠ¨ï¼Œä½† B å¤±è´¥ä¸å½±å“ A               â”‚
â”‚  â€¢ After=B (æ—  Requires/Wants) â†’ åªæ˜¯é¡ºåºï¼Œä¸ä¼šè§¦å‘ B å¯åŠ¨                â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
<!-- /DIAGRAM -->

### 2.4 systemd-analyzeï¼šå¯åŠ¨é“¾åˆ†æ

```bash
# æŸ¥çœ‹ç³»ç»Ÿå¯åŠ¨æ—¶é—´
systemd-analyze

# æŸ¥çœ‹å¯åŠ¨è´£å¤‡é“¾ï¼ˆå“ªä¸ªæœåŠ¡æœ€æ…¢ï¼‰
systemd-analyze blame

# æŸ¥çœ‹ç‰¹å®šæœåŠ¡çš„å¯åŠ¨é“¾
systemd-analyze critical-chain nginx.service

# ç»˜åˆ¶å¯åŠ¨æ—¶åºå›¾ï¼ˆç”Ÿæˆ SVGï¼‰
systemd-analyze plot > boot.svg
```

**critical-chain è¾“å‡ºè§£è¯»**ï¼š

```bash
$ systemd-analyze critical-chain nginx.service
The time when unit became active or started is printed after the "@" character.
The time the unit took to start is printed after the "+" character.

nginx.service @12.456s +0.123s
â””â”€network-online.target @12.345s
  â””â”€NetworkManager-wait-online.service @2.123s +10.222s
    â””â”€NetworkManager.service @1.890s +0.233s
      â””â”€dbus.service @1.567s +0.323s
        â””â”€basic.target @1.456s
          â””â”€sockets.target @1.456s
```

**è§£è¯»**ï¼š
- `@12.456s` = æœåŠ¡åœ¨ç³»ç»Ÿå¯åŠ¨ 12.456 ç§’åå˜ä¸º active
- `+0.123s` = æœåŠ¡æœ¬èº«å¯åŠ¨è€—æ—¶ 0.123 ç§’
- ä»ä¸‹å¾€ä¸Šè¯»ï¼šdbus â†’ NetworkManager â†’ wait-online â†’ network-online â†’ nginx

### 2.5 ä¾èµ–é—®é¢˜è¯Šæ–­å®ä¾‹

**åœºæ™¯**ï¼šè‡ªå®šä¹‰åº”ç”¨æœåŠ¡å¯åŠ¨å¤±è´¥

```bash
# 1. æŸ¥çœ‹æœåŠ¡çŠ¶æ€
systemctl status myapp.service
# æ˜¾ç¤º "Job for myapp.service failed because a dependency failed"

# 2. æŸ¥çœ‹ä¾èµ–
systemctl list-dependencies myapp.service
# å‘ç°ä¾èµ– postgresql.service

# 3. æ£€æŸ¥ postgresql çŠ¶æ€
systemctl status postgresql.service
# å‘ç° postgresql ä¹Ÿæ˜¯ failed

# 4. æŸ¥çœ‹ postgresql æ—¥å¿—
journalctl -u postgresql -p err
# å‘ç° "could not access directory: Permission denied"

# 5. æ ¹å› ï¼špostgresql æ•°æ®ç›®å½•æƒé™é”™è¯¯
# ä¿®å¤åä¸¤ä¸ªæœåŠ¡éƒ½èƒ½æ­£å¸¸å¯åŠ¨
```

---

## Step 3 -- å¸¸è§å¤±è´¥æ¨¡å¼ï¼ˆ25 åˆ†é’Ÿï¼‰

### 3.1 é…ç½®è¯­æ³•é”™è¯¯

æœ€å¸¸è§çš„å¤±è´¥åŸå› ã€‚æœåŠ¡ç¨‹åºåœ¨å¯åŠ¨æ—¶æ£€æµ‹åˆ°é…ç½®æ–‡ä»¶æœ‰è¯­æ³•é”™è¯¯ã€‚

**è¯Šæ–­æ–¹æ³•**ï¼š

```bash
# æŸ¥çœ‹æ—¥å¿—ä¸­çš„é…ç½®é”™è¯¯
journalctl -u nginx -p err | grep -i 'config\|syntax\|parse'

# ä½¿ç”¨æœåŠ¡è‡ªå¸¦çš„é…ç½®æ£€æŸ¥
nginx -t
httpd -t
named-checkconf
postfix check

# å¦‚æœæ²¡æœ‰æ£€æŸ¥å·¥å…·ï¼ŒæŸ¥çœ‹æ—¥å¿—
journalctl -u myapp --since '5 min ago' | head -50
```

**å¸¸è§é”™è¯¯æ¶ˆæ¯**ï¼š
- `syntax error in /etc/nginx/nginx.conf`
- `configuration file test failed`
- `parse error near line XX`

### 3.2 EnvironmentFile ç¼ºå¤±

æœåŠ¡ä¾èµ–çš„ç¯å¢ƒå˜é‡æ–‡ä»¶ä¸å­˜åœ¨æˆ–æƒé™é”™è¯¯ã€‚

**è¯Šæ–­æ–¹æ³•**ï¼š

```bash
# æŸ¥çœ‹æœåŠ¡çš„ EnvironmentFile è®¾ç½®
systemctl cat myapp.service | grep -i environment

# è¾“å‡ºå¯èƒ½æ˜¾ç¤ºï¼š
# EnvironmentFile=/etc/myapp/config
# EnvironmentFile=-/etc/myapp/optional.conf  # å‰ç¼€ - è¡¨ç¤ºå¯é€‰

# æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
ls -la /etc/myapp/config

# æ£€æŸ¥æ–‡ä»¶æƒé™
stat /etc/myapp/config
```

**é”™è¯¯æ¶ˆæ¯ç¤ºä¾‹**ï¼š
- `Failed to load environment files: No such file or directory`
- `myapp.service: Failed to read environment file`

**ä¿®å¤æ–¹æ³•**ï¼š

```bash
# åˆ›å»ºç¼ºå¤±çš„é…ç½®æ–‡ä»¶
sudo touch /etc/myapp/config

# æˆ–è€…ä¿®æ”¹ unit file ä½¿å…¶å¯é€‰ï¼ˆæ·»åŠ  - å‰ç¼€ï¼‰
sudo systemctl edit myapp.service
# æ·»åŠ ï¼š
# [Service]
# EnvironmentFile=-/etc/myapp/config
```

### 3.3 æƒé™é—®é¢˜ï¼ˆEACCESï¼‰

æœåŠ¡è¿›ç¨‹æ— æ³•è®¿é—®æ‰€éœ€çš„æ–‡ä»¶æˆ–ç›®å½•ã€‚

**è¯Šæ–­æ–¹æ³•**ï¼š

```bash
# æ—¥å¿—ä¸­æŸ¥æ‰¾æƒé™é”™è¯¯
journalctl -u nginx -p err | grep -i 'permission\|denied\|eacces'

# æ£€æŸ¥å…³é”®ç›®å½•æƒé™
ls -la /var/log/nginx/
ls -la /var/lib/nginx/
ls -la /run/nginx/

# æ£€æŸ¥æœåŠ¡è¿è¡Œçš„ç”¨æˆ·
systemctl show nginx -p User,Group
```

**å¸¸è§åœºæ™¯**ï¼š
- æ—¥å¿—ç›®å½•æƒé™ä¸æ­£ç¡®
- PID æ–‡ä»¶ç›®å½•ä¸å­˜åœ¨
- é…ç½®æ–‡ä»¶æƒé™è¿‡ä¸¥
- Socket æ–‡ä»¶æƒé™é—®é¢˜

**ä¿®å¤æ–¹æ³•**ï¼š

```bash
# ä¿®å¤ç›®å½•æƒé™
sudo chown -R nginx:nginx /var/log/nginx
sudo chmod 755 /var/log/nginx

# åˆ›å»ºç¼ºå¤±çš„è¿è¡Œæ—¶ç›®å½•
sudo mkdir -p /run/nginx
sudo chown nginx:nginx /run/nginx
```

### 3.4 SELinux é˜»æ­¢

åœ¨ RHEL/CentOS ç³»ç»Ÿä¸Šï¼ŒSELinux å¯èƒ½é˜»æ­¢æœåŠ¡è®¿é—®èµ„æºï¼Œå³ä½¿ DACï¼ˆä¼ ç»Ÿæƒé™ï¼‰å…è®¸ã€‚

**è¯Šæ–­æ–¹æ³•**ï¼š

```bash
# æ£€æŸ¥ SELinux çŠ¶æ€
getenforce

# æŸ¥çœ‹æœ€è¿‘çš„ SELinux æ‹’ç»
ausearch -m AVC -ts recent

# æˆ–ä½¿ç”¨ audit2why åˆ†æ
ausearch -m AVC -ts recent | audit2why

# æŸ¥çœ‹æ–‡ä»¶çš„ SELinux ä¸Šä¸‹æ–‡
ls -Z /var/www/html/
```

**å¸¸è§åœºæ™¯**ï¼š
- æ–‡ä»¶ä»å…¶ä»–ä½ç½®ç§»åŠ¨ï¼ˆä¿ç•™äº†åŸä¸Šä¸‹æ–‡ï¼‰
- éæ ‡å‡†ç«¯å£
- è‡ªå®šä¹‰ç›®å½•è·¯å¾„

**ä¿®å¤æ–¹æ³•**ï¼š

```bash
# æ¢å¤é»˜è®¤ä¸Šä¸‹æ–‡
sudo restorecon -Rv /var/www/html/

# å¦‚æœæ˜¯è‡ªå®šä¹‰è·¯å¾„ï¼Œè®¾ç½®æ­£ç¡®ä¸Šä¸‹æ–‡
sudo semanage fcontext -a -t httpd_sys_content_t "/custom/path(/.*)?"
sudo restorecon -Rv /custom/path/

# å…è®¸éæ ‡å‡†ç«¯å£
sudo semanage port -a -t http_port_t -p tcp 8080

# ä¸´æ—¶å…³é—­ SELinuxï¼ˆä»…ç”¨äºç¡®è®¤é—®é¢˜ï¼Œä¸æ¨èç”Ÿäº§ä½¿ç”¨ï¼‰
sudo setenforce 0
# æµ‹è¯•æœåŠ¡
sudo setenforce 1
```

### 3.5 èµ„æºé™åˆ¶ï¼ˆOOMã€Timeoutï¼‰

æœåŠ¡å› ç³»ç»Ÿèµ„æºé™åˆ¶è€Œå¤±è´¥ã€‚

**OOM Killer è¯Šæ–­**ï¼š

```bash
# æ£€æŸ¥å†…æ ¸æ—¥å¿—
dmesg | grep -i 'oom\|killed'

# æˆ–é€šè¿‡ journalctl
journalctl -k | grep -i 'oom\|killed'

# æŸ¥çœ‹æœåŠ¡çš„å†…å­˜é™åˆ¶
systemctl show nginx -p MemoryLimit,MemoryHigh,MemoryMax
```

**Timeout è¯Šæ–­**ï¼š

```bash
# æŸ¥çœ‹æœåŠ¡çš„è¶…æ—¶è®¾ç½®
systemctl show nginx -p TimeoutStartSec,TimeoutStopSec

# æ—¥å¿—ä¸­æŸ¥æ‰¾è¶…æ—¶
journalctl -u nginx | grep -i 'timeout'

# å¸¸è§æ¶ˆæ¯ï¼š
# "nginx.service: Start operation timed out. Terminating."
```

**ä¿®å¤æ–¹æ³•**ï¼š

```bash
# å¢åŠ å¯åŠ¨è¶…æ—¶ï¼ˆé€šè¿‡ drop-in æ–‡ä»¶ï¼‰
sudo systemctl edit nginx.service

# æ·»åŠ ï¼š
[Service]
TimeoutStartSec=120

# è°ƒæ•´å†…å­˜é™åˆ¶
[Service]
MemoryMax=2G
```

### 3.6 å¤±è´¥æ¨¡å¼é€ŸæŸ¥è¡¨

<!-- DIAGRAM: failure-modes-table -->
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æœåŠ¡å¤±è´¥æ¨¡å¼é€ŸæŸ¥è¡¨                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å¤±è´¥æ¨¡å¼       â”‚ è¯Šæ–­å‘½ä»¤                â”‚ å¸¸è§ä¿®å¤                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ é…ç½®è¯­æ³•é”™è¯¯   â”‚ journalctl -u <svc>     â”‚ æ£€æŸ¥é…ç½®æ–‡ä»¶è¯­æ³•                 â”‚
â”‚                â”‚ <service> -t (configtest)â”‚ nginx -t, httpd -t ç­‰           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ EnvironmentFileâ”‚ systemctl cat <svc>     â”‚ åˆ›å»ºæ–‡ä»¶æˆ–æ·»åŠ  - å‰ç¼€           â”‚
â”‚ ç¼ºå¤±           â”‚ ls -la <envfile>        â”‚                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æƒé™é—®é¢˜       â”‚ journalctl | grep deny  â”‚ chown/chmod ä¿®å¤æƒé™            â”‚
â”‚ (EACCES)       â”‚ ls -la <path>           â”‚ æ£€æŸ¥ User=/Group= è®¾ç½®          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ SELinux é˜»æ­¢   â”‚ ausearch -m AVC         â”‚ restorecon -Rv <path>           â”‚
â”‚                â”‚ audit2why               â”‚ semanage fcontext               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ OOM Killer     â”‚ dmesg | grep oom        â”‚ å¢åŠ å†…å­˜æˆ–è®¾ç½® MemoryMax=       â”‚
â”‚                â”‚ journalctl -k | grep oomâ”‚                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å¯åŠ¨è¶…æ—¶       â”‚ journalctl | grep time  â”‚ å¢åŠ  TimeoutStartSec=           â”‚
â”‚                â”‚ systemctl show -p Time  â”‚                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ä¾èµ–å¤±è´¥       â”‚ systemctl list-dependen â”‚ æ£€æŸ¥ä¾èµ–æœåŠ¡çŠ¶æ€                â”‚
â”‚                â”‚ systemctl status <dep>  â”‚                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç«¯å£å ç”¨       â”‚ ss -lntup | grep <port> â”‚ åœæ­¢å ç”¨è¿›ç¨‹æˆ–æ›´æ¢ç«¯å£          â”‚
â”‚                â”‚                         â”‚                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
<!-- /DIAGRAM -->

---

## Step 4 -- Socket Activation é—®é¢˜ï¼ˆ15 åˆ†é’Ÿï¼‰

### 4.1 ä»€ä¹ˆæ˜¯ Socket Activationï¼Ÿ

Socket Activation æ˜¯ systemd çš„ä¸€ä¸ªç‰¹æ€§ï¼šç”± systemd å…ˆç›‘å¬ç«¯å£ï¼Œå½“æœ‰è¿æ¥è¯·æ±‚æ—¶å†å¯åŠ¨å®é™…æœåŠ¡ã€‚

**ä¼˜ç‚¹**ï¼š
- å‡å°‘å¯åŠ¨æ—¶çš„èµ„æºæ¶ˆè€—
- æœåŠ¡æŒ‰éœ€å¯åŠ¨
- æ”¯æŒæœåŠ¡çƒ­é‡å¯

**å¸¸è§ä½¿ç”¨åœºæ™¯**ï¼š
- sshd.socket (SSH æœåŠ¡)
- cups.socket (æ‰“å°æœåŠ¡)
- cockpit.socket (Web ç®¡ç†ç•Œé¢)

### 4.2 Socket Activation ç»“æ„

<!-- DIAGRAM: socket-activation -->
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Socket Activation å·¥ä½œåŸç†                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚   ä¼ ç»Ÿæ¨¡å¼ï¼š                                                                â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                     â”‚
â”‚   â”‚   systemd   â”‚ â”€â”€â”€â–¶ â”‚   sshd      â”‚ â”€â”€â”€â–¶ ç›‘å¬ 22 ç«¯å£                   â”‚
â”‚   â”‚             â”‚      â”‚   (æœåŠ¡)    â”‚                                     â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                     â”‚
â”‚                                                                             â”‚
â”‚   Socket Activationï¼š                                                       â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                     â”‚
â”‚   â”‚   systemd   â”‚ â”€â”€â”€â–¶ â”‚ sshd.socket â”‚ â”€â”€â”€â–¶ ç›‘å¬ 22 ç«¯å£                   â”‚
â”‚   â”‚             â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                     â”‚
â”‚   â”‚             â”‚             â”‚                                             â”‚
â”‚   â”‚             â”‚             â”‚ è¿æ¥è¯·æ±‚åˆ°è¾¾                                â”‚
â”‚   â”‚             â”‚             â–¼                                             â”‚
â”‚   â”‚             â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                     â”‚
â”‚   â”‚             â”‚ â”€â”€â”€â–¶ â”‚ sshd.serviceâ”‚ â”€â”€â”€â–¶ å¤„ç†è¿æ¥                       â”‚
â”‚   â”‚             â”‚      â”‚ (æŒ‰éœ€å¯åŠ¨)  â”‚                                     â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                     â”‚
â”‚                                                                             â”‚
â”‚   æ–‡ä»¶å¯¹åº”ï¼š                                                                â”‚
â”‚   â€¢ sshd.socket    - å®šä¹‰ç›‘å¬çš„ç«¯å£/socket                                 â”‚
â”‚   â€¢ sshd.service   - å®šä¹‰å®é™…æœåŠ¡                                          â”‚
â”‚   â€¢ sshd@.service  - æ¨¡æ¿æœåŠ¡ï¼ˆç”¨äºå¤šå®ä¾‹ï¼‰                                â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
<!-- /DIAGRAM -->

### 4.3 è¯Šæ–­ Socket Activation é—®é¢˜

**é—®é¢˜åœºæ™¯**ï¼šæœåŠ¡æ˜¾ç¤º activeï¼Œä½†ç«¯å£ä¸ç›‘å¬

```bash
# 1. æ£€æŸ¥æœåŠ¡çŠ¶æ€
systemctl status sshd.service
# æ˜¾ç¤º inactive (dead) - æ­£å¸¸ï¼å› ä¸ºæ˜¯ socket activation

# 2. æ£€æŸ¥ socket çŠ¶æ€
systemctl status sshd.socket
# åº”è¯¥æ˜¾ç¤º active (listening)

# 3. éªŒè¯ç«¯å£ç›‘å¬
ss -lntup | grep ':22'
# åº”è¯¥çœ‹åˆ° systemd åœ¨ç›‘å¬

# 4. å¦‚æœç«¯å£æ²¡æœ‰ç›‘å¬
systemctl is-enabled sshd.socket
systemctl start sshd.socket
```

**å¸¸è§é—®é¢˜**ï¼š

| ç—‡çŠ¶ | åŸå›  | ä¿®å¤ |
|------|------|------|
| ç«¯å£ä¸ç›‘å¬ | socket æœªå¯åŠ¨ | `systemctl start <name>.socket` |
| æœåŠ¡å¯åŠ¨åç«‹å³åœæ­¢ | socket å’Œ service å†²çª | åœæ­¢ serviceï¼Œåªå¯ç”¨ socket |
| è¿æ¥è¢«æ‹’ç» | socket é…ç½®é”™è¯¯ | æ£€æŸ¥ .socket æ–‡ä»¶ä¸­çš„ ListenStream= |

### 4.4 æ£€æŸ¥ Socket é…ç½®

```bash
# æŸ¥çœ‹ socket unit å†…å®¹
systemctl cat sshd.socket

# è¾“å‡ºç¤ºä¾‹ï¼š
# [Socket]
# ListenStream=22
# Accept=no
#
# [Install]
# WantedBy=sockets.target

# æŸ¥çœ‹æ‰€æœ‰ socket
systemctl list-sockets

# æŸ¥çœ‹ socket å’Œå¯¹åº”æœåŠ¡çš„å…³ç³»
systemctl list-sockets --show-types
```

---

## Step 5 -- æœåŠ¡è¯Šæ–­å†³ç­–æ ‘ï¼ˆ10 åˆ†é’Ÿï¼‰

### 5.1 å®Œæ•´å†³ç­–æ ‘

<!-- DIAGRAM: service-decision-tree -->
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æœåŠ¡æ•…éšœè¯Šæ–­å†³ç­–æ ‘                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚                         æœåŠ¡ä¸å¯ç”¨                                          â”‚
â”‚                            â”‚                                                â”‚
â”‚                            â–¼                                                â”‚
â”‚               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”‚
â”‚               â”‚   systemctl status     â”‚                                   â”‚
â”‚               â”‚   æŸ¥çœ‹ä¸»çŠ¶æ€           â”‚                                   â”‚
â”‚               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                   â”‚
â”‚                           â”‚                                                 â”‚
â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                             â”‚
â”‚        â”‚                  â”‚                  â”‚                              â”‚
â”‚        â–¼                  â–¼                  â–¼                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚   â”‚ failed  â”‚       â”‚inactive â”‚        â”‚ active  â”‚                         â”‚
â”‚   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                         â”‚
â”‚        â”‚                 â”‚                  â”‚                               â”‚
â”‚        â–¼                 â–¼                  â–¼                               â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚   â”‚journalctl -u â”‚ â”‚æ˜¯ socket     â”‚  â”‚ss -lntup     â”‚                      â”‚
â”‚   â”‚<svc> -p err  â”‚ â”‚activation?   â”‚  â”‚æ£€æŸ¥ç«¯å£ç›‘å¬  â”‚                      â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚          â”‚                â”‚                  â”‚                              â”‚
â”‚          â–¼                â–¼                  â–¼                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚ æ ¹æ®é”™è¯¯ç±»å‹åˆ†æ”¯ï¼š                                                    â”‚  â”‚
â”‚   â”‚                                                                      â”‚  â”‚
â”‚   â”‚ "config error"     â†’  æ£€æŸ¥é…ç½®è¯­æ³• (nginx -t ç­‰)                    â”‚  â”‚
â”‚   â”‚ "permission denied" â†’  æ£€æŸ¥æ–‡ä»¶æƒé™ + SELinux (ls -Z, ausearch)     â”‚  â”‚
â”‚   â”‚ "No such file"      â†’  æ£€æŸ¥ EnvironmentFile å’Œè·¯å¾„                  â”‚  â”‚
â”‚   â”‚ "dependency failed" â†’  systemctl list-dependencies                  â”‚  â”‚
â”‚   â”‚ "timeout"           â†’  å¢åŠ  TimeoutStartSec                         â”‚  â”‚
â”‚   â”‚ "oom"              â†’  æ£€æŸ¥å†…å­˜ï¼Œè°ƒæ•´ MemoryMax                       â”‚  â”‚
â”‚   â”‚ "ç«¯å£å·²å ç”¨"        â†’  ss -lntup | grep <port>                      â”‚  â”‚
â”‚   â”‚                                                                      â”‚  â”‚
â”‚   â”‚ ç«¯å£ä¸ç›‘å¬ä½† active â†’  æ£€æŸ¥ socket activation                       â”‚  â”‚
â”‚   â”‚                       systemctl status <name>.socket                â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â”‚   å…³é”®æé†’ï¼š                                                                â”‚
â”‚   â€¢ Active ä¸ç­‰äºå¯ç”¨ - ä¸€å®šè¦éªŒè¯ç«¯å£ï¼                                   â”‚
â”‚   â€¢ æ£€æŸ¥ä¾èµ–æœåŠ¡çŠ¶æ€ - é—®é¢˜å¯èƒ½åœ¨ä¸Šæ¸¸                                      â”‚
â”‚   â€¢ æŸ¥çœ‹å®Œæ•´æ—¥å¿— - journalctl -u <svc> -n 100                             â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
<!-- /DIAGRAM -->

### 5.2 å¿«é€Ÿè¯Šæ–­å‘½ä»¤ç»„åˆ

```bash
# å®Œæ•´è¯Šæ–­è„šæœ¬ï¼ˆä¿å­˜ä¸º diagnose-service.shï¼‰
#!/bin/bash
SERVICE=${1:-nginx}

echo "=== Diagnosing $SERVICE ==="
echo ""

echo "[1] Service Status:"
systemctl status "$SERVICE" --no-pager -l

echo ""
echo "[2] Recent Errors:"
journalctl -u "$SERVICE" -p err --since '1 hour ago' --no-pager | tail -20

echo ""
echo "[3] Dependencies:"
systemctl list-dependencies "$SERVICE" --no-pager | head -15

echo ""
echo "[4] Properties:"
systemctl show "$SERVICE" -p MainPID,ExecMainStatus,ActiveState,SubState,Result,NRestarts

echo ""
echo "[5] Listening Ports (if applicable):"
ss -lntup 2>/dev/null | grep -E "$(systemctl show -p MainPID "$SERVICE" --value)" || echo "No ports found for this service"

echo ""
echo "[6] Related Socket (if any):"
SOCKET="${SERVICE%.service}.socket"
systemctl status "$SOCKET" --no-pager 2>/dev/null || echo "No associated socket unit"
```

---

## åŠ¨æ‰‹å®éªŒï¼ˆ30 åˆ†é’Ÿï¼‰

### å®éªŒ 1ï¼šä¾èµ–åœ°ç‹±åœºæ™¯ï¼ˆThe Dependency Nightmareï¼‰

**åœºæ™¯æè¿°**ï¼š
ä½ æœ‰ä¸€ä¸ª Web åº”ç”¨æœåŠ¡ `webapp.service`ï¼Œå®ƒä¾èµ– `redis.service`ã€‚
ç”¨æˆ·æŠ¥å‘Š Web åº”ç”¨æ— æ³•è®¿é—®ï¼Œä½† `systemctl status webapp` æ˜¾ç¤º `active (running)`ã€‚

**æ¨¡æ‹Ÿæ­¥éª¤**ï¼š

```bash
# 1. åˆ›å»ºä¸€ä¸ªæ¨¡æ‹Ÿçš„ä¾èµ–æœåŠ¡ï¼ˆæ•…æ„è®©å®ƒå¤±è´¥ï¼‰
sudo tee /etc/systemd/system/fake-redis.service << 'EOF'
[Unit]
Description=Fake Redis Service (for testing)

[Service]
Type=oneshot
ExecStart=/bin/false
RemainAfterExit=yes

[Install]
WantedBy=multi-user.target
EOF

# 2. åˆ›å»ºä¾èµ– fake-redis çš„åº”ç”¨æœåŠ¡
sudo tee /etc/systemd/system/test-webapp.service << 'EOF'
[Unit]
Description=Test Web Application
Requires=fake-redis.service
After=fake-redis.service

[Service]
Type=simple
ExecStart=/usr/bin/python3 -m http.server 8080
Restart=on-failure

[Install]
WantedBy=multi-user.target
EOF

# 3. é‡è½½ systemd
sudo systemctl daemon-reload

# 4. å°è¯•å¯åŠ¨ webapp
sudo systemctl start test-webapp.service

# 5. è¯Šæ–­é—®é¢˜
```

**è¯Šæ–­ç»ƒä¹ **ï¼š

```bash
# æ£€æŸ¥æœåŠ¡çŠ¶æ€
systemctl status test-webapp.service

# æŸ¥çœ‹ä¾èµ–
systemctl list-dependencies test-webapp.service

# æ£€æŸ¥ä¾èµ–æœåŠ¡
systemctl status fake-redis.service

# æŸ¥çœ‹æ—¥å¿—
journalctl -u test-webapp.service -p err --since '5 min ago'
journalctl -u fake-redis.service -p err --since '5 min ago'
```

**é—®é¢˜**ï¼š
1. ä¸ºä»€ä¹ˆ webapp å¯åŠ¨å¤±è´¥ï¼Ÿ
2. å¦‚ä½•ä¿®å¤ fake-redis æœåŠ¡ï¼Ÿ
3. å¦‚æœ webapp å¿…é¡»è¿è¡Œï¼Œå³ä½¿ redis ä¸å¯ç”¨ï¼Œåº”è¯¥å¦‚ä½•ä¿®æ”¹é…ç½®ï¼Ÿ

<details>
<summary>ç‚¹å‡»æŸ¥çœ‹ç­”æ¡ˆ</summary>

1. **åŸå› **ï¼šwebapp ä½¿ç”¨ `Requires=fake-redis.service`ï¼Œè€Œ fake-redis å¯åŠ¨å¤±è´¥ï¼ˆExecStart=/bin/false è¿”å›éé›¶ï¼‰ã€‚å¼ºä¾èµ–å¤±è´¥å¯¼è‡´ webapp ä¹Ÿæ— æ³•å¯åŠ¨ã€‚

2. **ä¿®å¤ fake-redis**ï¼š
```bash
# ä¿®æ”¹ä¸ºæˆåŠŸçš„å‘½ä»¤
sudo sed -i 's|ExecStart=/bin/false|ExecStart=/bin/true|' /etc/systemd/system/fake-redis.service
sudo systemctl daemon-reload
sudo systemctl start fake-redis.service
sudo systemctl start test-webapp.service
```

3. **å…è®¸ webapp ç‹¬ç«‹è¿è¡Œ**ï¼š
```bash
# å°† Requires æ”¹ä¸º Wants
sudo sed -i 's|Requires=fake-redis|Wants=fake-redis|' /etc/systemd/system/test-webapp.service
sudo systemctl daemon-reload
# ç°åœ¨å³ä½¿ fake-redis å¤±è´¥ï¼Œwebapp ä¹Ÿèƒ½å¯åŠ¨
```

</details>

**æ¸…ç†**ï¼š

```bash
sudo systemctl stop test-webapp.service fake-redis.service
sudo systemctl disable test-webapp.service fake-redis.service
sudo rm /etc/systemd/system/test-webapp.service /etc/systemd/system/fake-redis.service
sudo systemctl daemon-reload
```

### å®éªŒ 2ï¼šEnvironmentFile ç¼ºå¤±åœºæ™¯

**åœºæ™¯æè¿°**ï¼š
ä¸€ä¸ªæœåŠ¡ `myapp.service` ä¾èµ–ç¯å¢ƒå˜é‡æ–‡ä»¶ `/etc/myapp/config`ï¼Œä½†æ–‡ä»¶ä¸å­˜åœ¨ã€‚

**æ¨¡æ‹Ÿæ­¥éª¤**ï¼š

```bash
# 1. åˆ›å»ºæµ‹è¯•æœåŠ¡
sudo tee /etc/systemd/system/envtest.service << 'EOF'
[Unit]
Description=Environment File Test Service

[Service]
Type=simple
EnvironmentFile=/etc/envtest/config
ExecStart=/bin/bash -c 'echo "APP_NAME=$APP_NAME, APP_PORT=$APP_PORT"; sleep infinity'

[Install]
WantedBy=multi-user.target
EOF

# 2. é‡è½½å¹¶å°è¯•å¯åŠ¨
sudo systemctl daemon-reload
sudo systemctl start envtest.service

# 3. æ£€æŸ¥çŠ¶æ€
systemctl status envtest.service
```

**è¯Šæ–­ç»ƒä¹ **ï¼š

```bash
# æŸ¥çœ‹é”™è¯¯
journalctl -u envtest.service -p err

# æŸ¥çœ‹æœåŠ¡é…ç½®
systemctl cat envtest.service

# æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
ls -la /etc/envtest/config
```

**ä¿®å¤æ­¥éª¤**ï¼š

```bash
# åˆ›å»ºé…ç½®ç›®å½•å’Œæ–‡ä»¶
sudo mkdir -p /etc/envtest
sudo tee /etc/envtest/config << 'EOF'
APP_NAME=MyTestApp
APP_PORT=8080
EOF

# é‡æ–°å¯åŠ¨
sudo systemctl start envtest.service
systemctl status envtest.service

# éªŒè¯ç¯å¢ƒå˜é‡è¢«è¯»å–
journalctl -u envtest.service | tail -5
```

**æ¸…ç†**ï¼š

```bash
sudo systemctl stop envtest.service
sudo systemctl disable envtest.service
sudo rm /etc/systemd/system/envtest.service
sudo rm -rf /etc/envtest
sudo systemctl daemon-reload
```

---

## æ—¥æœ¬ IT èŒåœºï¼šã‚µãƒ¼ãƒ“ã‚¹éšœå®³å¯¾å¿œï¼ˆ15 åˆ†é’Ÿï¼‰

### èŒåœºåœºæ™¯

åœ¨æ—¥æœ¬ IT ä¼ä¸šï¼ŒæœåŠ¡æ•…éšœé€šå¸¸é€šè¿‡ç›‘æ§ç³»ç»Ÿï¼ˆé‹ç”¨ç›£è¦–ï¼‰é¦–å…ˆå‘ç°ã€‚

**å…¸å‹æµç¨‹**ï¼š

```
ç›£è¦–ã‚¢ãƒ©ãƒ¼ãƒˆç™ºå ± â†’ ä¸€æ¬¡å¯¾å¿œ â†’ åŸå› èª¿æŸ» â†’ æ’ä¹…å¯¾ç­– â†’ å ±å‘Šæ›¸ä½œæˆ
   (Alert)       (First Response) (Investigation) (Permanent Fix) (Report)
```

### æ ¸å¿ƒæ—¥è¯­æœ¯è¯­

| æ—¥è¯­ | è¯»éŸ³ | å«ä¹‰ | ä¾‹å¥ |
|------|------|------|------|
| **ã‚µãƒ¼ãƒ“ã‚¹èµ·å‹•å¤±æ•—** | saabisu kidou shippai | æœåŠ¡å¯åŠ¨å¤±è´¥ | ã€Œã‚µãƒ¼ãƒ“ã‚¹èµ·å‹•å¤±æ•—ã®ã‚¢ãƒ©ãƒ¼ãƒˆã§ã™ã€ |
| **ä¾å­˜é–¢ä¿‚** | izon kankei | ä¾èµ–å…³ç³» | ã€Œä¾å­˜é–¢ä¿‚ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€ |
| **è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«** | settei fairu | é…ç½®æ–‡ä»¶ | ã€Œè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®æ§‹æ–‡ã‚¨ãƒ©ãƒ¼ã§ã™ã€ |
| **æ¨©é™ã‚¨ãƒ©ãƒ¼** | kengen eraa | æƒé™é”™è¯¯ | ã€Œæ¨©é™ã‚¨ãƒ©ãƒ¼ã§èµ·å‹•ã§ãã¾ã›ã‚“ã€ |
| **å†èµ·å‹•** | saikidou | é‡å¯ | ã€Œã‚µãƒ¼ãƒ“ã‚¹ã‚’å†èµ·å‹•ã—ã¾ã™ã€ |
| **åˆ‡ã‚Šæˆ»ã—** | kirimodoshi | å›æ»š | ã€Œå¤‰æ›´ã‚’åˆ‡ã‚Šæˆ»ã—ã¾ã—ãŸã€ |

### æŠ¥å‘Šæ¨¡æ¿ï¼šã‚µãƒ¼ãƒ“ã‚¹éšœå®³

```markdown
## ã‚µãƒ¼ãƒ“ã‚¹éšœå®³å ±å‘Š

### æ¦‚è¦
- ç™ºç”Ÿæ—¥æ™‚: 2026-01-10 14:30 (JST)
- å¯¾è±¡ã‚µãƒ¼ãƒ“ã‚¹: nginx.service
- å½±éŸ¿: Web ã‚µã‚¤ãƒˆã‚¢ã‚¯ã‚»ã‚¹ä¸å¯

### éšœå®³å†…å®¹
nginx ã‚µãƒ¼ãƒ“ã‚¹ãŒèµ·å‹•å¤±æ•—ã€‚
ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: failed (Result: exit-code)

### åŸå› 
è¨­å®šãƒ•ã‚¡ã‚¤ãƒ« /etc/nginx/nginx.conf ã®æ§‹æ–‡ã‚¨ãƒ©ãƒ¼ã€‚
Line 45: é–‰ã˜ãƒ–ãƒ©ã‚±ãƒƒãƒˆä¸è¶³ã€‚

### å¯¾å¿œå†…å®¹
1. nginx -t ã§æ§‹æ–‡ãƒã‚§ãƒƒã‚¯å®Ÿæ–½
2. æ§‹æ–‡ã‚¨ãƒ©ãƒ¼ã‚’ä¿®æ­£
3. systemctl restart nginx ã§å†èµ·å‹•
4. ss -lntup ã§ Port 80/443 ã® Listen ç¢ºèª

### å†ç™ºé˜²æ­¢
- è¨­å®šå¤‰æ›´æ™‚ã¯å¿…ãš nginx -t ã‚’å®Ÿè¡Œ
- å¤‰æ›´æ‰‹é †æ›¸ã«ãƒã‚§ãƒƒã‚¯é …ç›®ã‚’è¿½åŠ 
```

---

## æ£€æŸ¥æ¸…å•

å®Œæˆæœ¬è¯¾åï¼Œä½ åº”è¯¥èƒ½å¤Ÿï¼š

- [ ] ä½¿ç”¨ `systemctl status` è§£è¯»æœåŠ¡çŠ¶æ€çš„æ‰€æœ‰å­—æ®µ
- [ ] ä½¿ç”¨ `journalctl -u <service> -p err` è¿‡æ»¤æœåŠ¡é”™è¯¯æ—¥å¿—
- [ ] è§£é‡Š `Requires` vs `Wants` vs `After` çš„åŒºåˆ«
- [ ] ä½¿ç”¨ `systemctl list-dependencies` åˆ†ææœåŠ¡ä¾èµ–
- [ ] ä½¿ç”¨ `systemd-analyze critical-chain` åˆ†æå¯åŠ¨é“¾
- [ ] è¯Šæ–­å¸¸è§å¤±è´¥æ¨¡å¼ï¼šé…ç½®é”™è¯¯ã€æƒé™é—®é¢˜ã€SELinuxã€EnvironmentFile
- [ ] ç†è§£ Socket Activation å¹¶è¯Šæ–­ç›¸å…³é—®é¢˜
- [ ] éªŒè¯æœåŠ¡çœŸæ­£å¯ç”¨ï¼ˆç«¯å£ç›‘å¬æ£€æŸ¥ï¼‰
- [ ] ä½¿ç”¨å†³ç­–æ ‘ç³»ç»Ÿæ€§è¯Šæ–­æœåŠ¡é—®é¢˜

---

## æœ¬è¯¾å°ç»“

| æ¦‚å¿µ | è¦ç‚¹ |
|------|------|
| æœåŠ¡çŠ¶æ€æ£€æŸ¥ | `systemctl status` + `journalctl -u` æ˜¯ç¬¬ä¸€æ­¥ |
| Active != å¯ç”¨ | ä¸€å®šè¦ç”¨ `ss -lntup` éªŒè¯ç«¯å£ç›‘å¬ |
| ä¾èµ–åˆ†æ | `list-dependencies` + `critical-chain` |
| ä¾èµ–ç±»å‹ | Requires(å¼º) > Wants(å¼±) > After(ä»…é¡ºåº) |
| å¸¸è§å¤±è´¥ | é…ç½®è¯­æ³•ã€æƒé™ã€SELinuxã€EnvironmentFileã€ä¾èµ– |
| Socket Activation | æœåŠ¡ inactive å¯èƒ½æ˜¯æ­£å¸¸çš„ï¼Œæ£€æŸ¥ .socket |
| é€€å‡ºç  | 0=æˆåŠŸ, 1=é€šç”¨é”™è¯¯, 137=OOM, 143=æ­£å¸¸ç»ˆæ­¢ |

**æ ¸å¿ƒç†å¿µ**ï¼š

> Active ä¸ç­‰äºå¯ç”¨ï¼Œä¾èµ–åˆ†ææ˜¯å…³é”®ã€‚  
> å…ˆçœ‹æ—¥å¿—ï¼Œå†æŸ¥ä¾èµ–ï¼Œæœ€åéªŒè¯ç«¯å£ã€‚  

---

## é¢è¯•å‡†å¤‡

### ã‚ˆãã‚ã‚‹è³ªå•ï¼ˆå¸¸è§é—®é¢˜ï¼‰

**Q: ã‚µãƒ¼ãƒ“ã‚¹ãŒèµ·å‹•ã—ãªã„å ´åˆã€ã©ã®ã‚ˆã†ã«è¨ºæ–­ã—ã¾ã™ã‹ï¼Ÿ**

A: ä»¥ä¸‹ã®ã‚¹ãƒ†ãƒƒãƒ—ã§è¨ºæ–­ã—ã¾ã™ï¼š
1. `systemctl status <service>` ã§ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª
2. `journalctl -u <service> -p err` ã§ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ç¢ºèª
3. ã‚¨ãƒ©ãƒ¼å†…å®¹ã«å¿œã˜ã¦å¯¾å¿œï¼š
   - è¨­å®šã‚¨ãƒ©ãƒ¼ â†’ è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®æ§‹æ–‡ãƒã‚§ãƒƒã‚¯
   - æ¨©é™ã‚¨ãƒ©ãƒ¼ â†’ ãƒ•ã‚¡ã‚¤ãƒ«æ¨©é™ã¨ SELinux ç¢ºèª
   - ä¾å­˜ã‚¨ãƒ©ãƒ¼ â†’ `systemctl list-dependencies` ã§ä¾å­˜ç¢ºèª
4. `ss -lntup` ã§ãƒãƒ¼ãƒˆ Listen ç¢ºèª

**Q: systemd ã®ä¾å­˜é–¢ä¿‚ã«ã¤ã„ã¦èª¬æ˜ã—ã¦ãã ã•ã„ã€‚**

A: ä¸»ãªä¾å­˜é–¢ä¿‚ã¯ 3 ç¨®é¡ã‚ã‚Šã¾ã™ï¼š
- **Requires**: å¼·ã„ä¾å­˜ã€‚ä¾å­˜å…ˆãŒå¤±æ•—ã™ã‚‹ã¨è‡ªåˆ†ã‚‚åœæ­¢
- **Wants**: å¼±ã„ä¾å­˜ã€‚ä¾å­˜å…ˆãŒå¤±æ•—ã—ã¦ã‚‚è‡ªåˆ†ã¯èµ·å‹•
- **After**: é †åºã®ã¿ã€‚ä¾å­˜å…ˆã®èµ·å‹•ã‚’å¾…ã¤ãŒã€èµ·å‹•ã¯ãƒˆãƒªã‚¬ãƒ¼ã—ãªã„

ä¸€èˆ¬çš„ã«ã¯ `Wants=B After=B` ã®çµ„ã¿åˆã‚ã›ã‚’æ¨å¥¨ã—ã¾ã™ã€‚

**Q: ã‚µãƒ¼ãƒ“ã‚¹ãŒ active ãªã®ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„å ´åˆã¯ï¼Ÿ**

A: ä»¥ä¸‹ã‚’ç¢ºèªã—ã¾ã™ï¼š
1. `ss -lntup` ã§ãƒãƒ¼ãƒˆãŒ Listen ã—ã¦ã„ã‚‹ã‹
2. Socket Activation ã®å ´åˆã€`.socket` ãƒ¦ãƒ‹ãƒƒãƒˆã®çŠ¶æ…‹
3. ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«ï¼ˆ`firewall-cmd --list-all`ï¼‰
4. SELinuxï¼ˆ`ausearch -m AVC -ts recent`ï¼‰

Active ã§ã‚‚å®Ÿéš›ã«ãƒãƒ¼ãƒˆã‚’é–‹ã„ã¦ã„ãªã„å ´åˆãŒã‚ã‚Šã¾ã™ã€‚å¿…ãš `ss` ã§ç¢ºèªã—ã¾ã™ã€‚

---

## ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ï¼ˆæœ¬èª²è‡ªä½“ã®å•é¡Œè§£æ±ºï¼‰

### systemctl cat ãŒå‹•ã‹ãªã„

```bash
# å¤ã„ systemd ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§ã¯ cat ãŒãªã„å ´åˆ
cat /usr/lib/systemd/system/<service>.service
# ã¾ãŸã¯
cat /etc/systemd/system/<service>.service
```

### audit2why ã‚³ãƒãƒ³ãƒ‰ãŒè¦‹ã¤ã‹ã‚‰ãªã„

```bash
# RHEL/CentOS
sudo yum install policycoreutils-python-utils

# Fedora
sudo dnf install policycoreutils-python-utils
```

### systemd-analyze ãŒä½¿ãˆãªã„

```bash
# ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ç¢ºèª
rpm -q systemd
# ã¾ãŸã¯
dpkg -l systemd

# ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç¢ºèªï¼ˆå¤ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§ã¯æ©Ÿèƒ½ãŒé™ã‚‰ã‚Œã‚‹ï¼‰
systemd --version
```

---

## å»¶ä¼¸é˜…è¯»

- [systemd Service Unit Documentation](https://www.freedesktop.org/software/systemd/man/systemd.service.html)
- [systemd Directives Index](https://www.freedesktop.org/software/systemd/man/systemd.directives.html)
- [Red Hat - Working with systemd Unit Files](https://docs.redhat.com/en/documentation/red_hat_enterprise_linux/9/html/configuring_basic_system_settings/working-with-systemd-unit-files_configuring-basic-system-settings)
- ä¸Šä¸€è¯¾ï¼š[02 - å¯åŠ¨æ•…éšœ](../02-boot-issues/) -- GRUBã€initramfsã€ç´§æ€¥æ¨¡å¼
- ä¸‹ä¸€è¯¾ï¼š[04 - ç½‘ç»œé—®é¢˜](../04-network-problems/) -- åˆ†å±‚è¯Šæ–­

---

## ç³»åˆ—å¯¼èˆª

[<-- 02 - å¯åŠ¨æ•…éšœ](../02-boot-issues/) | [ç³»åˆ—é¦–é¡µ](../) | [04 - ç½‘ç»œé—®é¢˜ -->](../04-network-problems/)
