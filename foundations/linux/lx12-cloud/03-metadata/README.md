# 03 - å…ƒæ•°æ®æœåŠ¡ä¸ IMDSv2ï¼ˆMetadata Services & IMDSv2ï¼‰

> **ç›®æ ‡**ï¼šç†è§£å®ä¾‹å…ƒæ•°æ®æœåŠ¡ï¼ŒæŒæ¡ IMDSv2 å®‰å…¨æœºåˆ¶ï¼Œé˜²èŒƒ SSRF å‡­è¯çªƒå–  
> **å‰ç½®**ï¼š[01 - äº‘ä¸­ Linux æœ‰ä½•ä¸åŒ](../01-cloud-context/)ã€[02 - cloud-init å¯åŠ¨æµç¨‹](../02-cloud-init/)  
> **æ—¶é—´**ï¼šâš¡ 30 åˆ†é’Ÿï¼ˆé€Ÿè¯»ï¼‰/ ğŸ”¬ 120 åˆ†é’Ÿï¼ˆå®Œæ•´å®æ“ï¼‰  
> **å®æˆ˜åœºæ™¯**ï¼šè¯Šæ–­ IMDSv1 è„šæœ¬åœ¨ IMDSv2 å®ä¾‹ä¸Šçš„å¤±è´¥ï¼ˆThe Credential Gapï¼‰  

---

## å°†å­¦åˆ°çš„å†…å®¹

1. ç†è§£å®ä¾‹å…ƒæ•°æ®æœåŠ¡ï¼ˆIMDSï¼‰çš„ä½œç”¨å’Œå¯ç”¨æ•°æ®
2. æŒæ¡ IMDSv2 token æœºåˆ¶åŠå…¶å·¥ä½œåŸç†
3. äº†è§£ SSRF å‡­è¯çªƒå–é£é™©ï¼ˆCapital One 2019 æ¡ˆä¾‹ï¼‰
4. é…ç½®å®ä¾‹å¼ºåˆ¶ä½¿ç”¨ IMDSv2ï¼Œè®¾ç½® hop limit

---

## å…ˆè·‘èµ·æ¥ï¼ï¼ˆ10 åˆ†é’Ÿï¼‰

> åœ¨å­¦ä¹ ç†è®ºä¹‹å‰ï¼Œå…ˆä½“éªŒ IMDSv2 çš„ token æœºåˆ¶ã€‚  

åœ¨ä»»æ„ EC2 å®ä¾‹ä¸Šè¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

### 1. å°è¯•ç›´æ¥è®¿é—®å…ƒæ•°æ®ï¼ˆIMDSv1 æ–¹å¼ï¼‰

```bash
curl -s http://169.254.169.254/latest/meta-data/instance-id
```

**å¯èƒ½çš„ç»“æœ**ï¼š
- å¦‚æœå®ä¾‹å…è®¸ IMDSv1ï¼šè¿”å›å®ä¾‹ IDï¼ˆå¦‚ `i-0abc123def456789`ï¼‰
- å¦‚æœå®ä¾‹å¼ºåˆ¶ IMDSv2ï¼šè¿”å› `401 - Unauthorized`

### 2. ä½¿ç”¨ IMDSv2 token è®¿é—®ï¼ˆå®‰å…¨æ–¹å¼ï¼‰

```bash
# Step 1: è·å– tokenï¼ˆPUT è¯·æ±‚ï¼ŒæŒ‡å®š TTLï¼‰
TOKEN=$(curl -s -X PUT "http://169.254.169.254/latest/api/token" \
  -H "X-aws-ec2-metadata-token-ttl-seconds: 21600")

# Step 2: ä½¿ç”¨ token è®¿é—®å…ƒæ•°æ®
curl -s -H "X-aws-ec2-metadata-token: $TOKEN" \
  http://169.254.169.254/latest/meta-data/instance-id
```

```
i-0abc123def456789
```

### 3. è·å– IAM è§’è‰²å‡­è¯ï¼ˆæ•æ„Ÿæ•°æ®ï¼ï¼‰

```bash
# è·å–è§’è‰²å
ROLE=$(curl -s -H "X-aws-ec2-metadata-token: $TOKEN" \
  http://169.254.169.254/latest/meta-data/iam/security-credentials/)

echo "IAM Role: $ROLE"

# è·å–ä¸´æ—¶å‡­è¯ï¼ˆæ³¨æ„ï¼šè¿™ä¼šæ˜¾ç¤ºçœŸå®å‡­è¯ï¼‰
curl -s -H "X-aws-ec2-metadata-token: $TOKEN" \
  http://169.254.169.254/latest/meta-data/iam/security-credentials/$ROLE | head -10
```

```json
{
  "Code" : "Success",
  "LastUpdated" : "2025-01-10T10:30:00Z",
  "Type" : "AWS-HMAC",
  "AccessKeyId" : "ASIA...",
  "SecretAccessKey" : "xxxxx...",
  "Token" : "FwoGZXIvYXdzE...",
  "Expiration" : "2025-01-10T16:30:00Z"
}
```

---

**ä½ åˆšåˆšä½“éªŒäº† IMDSv2 çš„æ ¸å¿ƒå·¥ä½œæµï¼šå…ˆè·å– tokenï¼Œå†ç”¨ token è®¿é—®æ•°æ®ã€‚**

| IMDSv1 | IMDSv2 |
|--------|--------|
| ç›´æ¥ GET è¯·æ±‚ | å…ˆ PUT è·å– token |
| æ— éœ€è®¤è¯ | Token æœ‰æ•ˆæœŸé™åˆ¶ |
| æ˜“å— SSRF æ”»å‡» | SSRF æ— æ³•è·å– token |
| é€æ­¥æ·˜æ±° | 2025 å¼ºåˆ¶è¦æ±‚ |

---

## Step 1 - å…ƒæ•°æ®æœåŠ¡åŸºç¡€ï¼ˆ15 åˆ†é’Ÿï¼‰

### 1.1 ä»€ä¹ˆæ˜¯ 169.254.169.254ï¼Ÿ

`169.254.169.254` æ˜¯ä¸€ä¸ª**é“¾è·¯æœ¬åœ°åœ°å€**ï¼ˆLink-Local Addressï¼‰ï¼Œæ‰€æœ‰äº‘å¹³å°éƒ½ä½¿ç”¨è¿™ä¸ªåœ°å€æä¾›å…ƒæ•°æ®æœåŠ¡ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å…ƒæ•°æ®æœåŠ¡æ¶æ„                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚   â”‚                      EC2 å®ä¾‹                                     â”‚ â”‚
â”‚   â”‚                                                                   â”‚ â”‚
â”‚   â”‚   åº”ç”¨ç¨‹åº â”€â”€â”€â”€â”€â”€â”                                                â”‚ â”‚
â”‚   â”‚                  â”‚ curl http://169.254.169.254/...               â”‚ â”‚
â”‚   â”‚   cloud-init â”€â”€â”€â”€â”¤                                                â”‚ â”‚
â”‚   â”‚                  â”‚                                                â”‚ â”‚
â”‚   â”‚   AWS SDK/CLI â”€â”€â”€â”˜                                                â”‚ â”‚
â”‚   â”‚                                                                   â”‚ â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                   â”‚                                     â”‚
â”‚                                   â”‚ é“¾è·¯æœ¬åœ°è¯·æ±‚                        â”‚
â”‚                                   â”‚ (ä¸ç»è¿‡ç½‘ç»œè·¯ç”±)                    â”‚
â”‚                                   â–¼                                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚   â”‚              Instance Metadata Service (IMDS)                    â”‚ â”‚
â”‚   â”‚                                                                   â”‚ â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚ â”‚
â”‚   â”‚   â”‚ meta-data  â”‚  â”‚ user-data  â”‚  â”‚  dynamic   â”‚                â”‚ â”‚
â”‚   â”‚   â”‚ - ami-id   â”‚  â”‚ - scripts  â”‚  â”‚ - identity â”‚                â”‚ â”‚
â”‚   â”‚   â”‚ - hostname â”‚  â”‚ - config   â”‚  â”‚ - spot     â”‚                â”‚ â”‚
â”‚   â”‚   â”‚ - iam/     â”‚  â”‚            â”‚  â”‚            â”‚                â”‚ â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚ â”‚
â”‚   â”‚                                                                   â”‚ â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 å¯ç”¨çš„å…ƒæ•°æ®ç±»åˆ«

```bash
# åˆ—å‡ºæ‰€æœ‰å¯ç”¨çš„å…ƒæ•°æ®ç±»åˆ«
TOKEN=$(curl -s -X PUT "http://169.254.169.254/latest/api/token" \
  -H "X-aws-ec2-metadata-token-ttl-seconds: 21600")

curl -s -H "X-aws-ec2-metadata-token: $TOKEN" \
  http://169.254.169.254/latest/meta-data/
```

```
ami-id
ami-launch-index
ami-manifest-path
block-device-mapping/
events/
hostname
iam/
identity-credentials/
instance-action
instance-id
instance-life-cycle
instance-type
local-hostname
local-ipv4
mac
metrics/
network/
placement/
profile
public-hostname
public-ipv4
public-keys/
reservation-id
security-groups
services/
tags/
```

### 1.3 å¸¸ç”¨å…ƒæ•°æ®æŸ¥è¯¢

| è·¯å¾„ | ç”¨é€” | ç¤ºä¾‹å€¼ |
|------|------|--------|
| `/meta-data/instance-id` | å®ä¾‹å”¯ä¸€æ ‡è¯† | `i-0abc123def456789` |
| `/meta-data/instance-type` | å®ä¾‹ç±»å‹ | `t3.micro` |
| `/meta-data/local-ipv4` | ç§æœ‰ IP | `10.0.1.52` |
| `/meta-data/public-ipv4` | å…¬æœ‰ IP | `54.123.45.67` |
| `/meta-data/placement/availability-zone` | å¯ç”¨åŒº | `ap-northeast-1a` |
| `/meta-data/iam/security-credentials/` | IAM è§’è‰²å‡­è¯ | ä¸´æ—¶å¯†é’¥ |
| `/user-data` | å¯åŠ¨è„šæœ¬ | cloud-init é…ç½® |
| `/dynamic/instance-identity/document` | èº«ä»½æ–‡æ¡£ | JSONï¼ˆå«ç­¾åï¼‰ |

### 1.4 å®ä¾‹èº«ä»½æ–‡æ¡£ï¼ˆInstance Identity Documentï¼‰

```bash
curl -s -H "X-aws-ec2-metadata-token: $TOKEN" \
  http://169.254.169.254/latest/dynamic/instance-identity/document | python3 -m json.tool
```

```json
{
    "accountId": "123456789012",
    "architecture": "x86_64",
    "availabilityZone": "ap-northeast-1a",
    "billingProducts": null,
    "devpayProductCodes": null,
    "marketplaceProductCodes": null,
    "imageId": "ami-0abc123def456789",
    "instanceId": "i-0abc123def456789",
    "instanceType": "t3.micro",
    "kernelId": null,
    "pendingTime": "2025-01-10T10:30:00Z",
    "privateIp": "10.0.1.52",
    "ramdiskId": null,
    "region": "ap-northeast-1",
    "version": "2017-09-30"
}
```

**ç”¨é€”**ï¼š
- å®ä¾‹å‘å¤–éƒ¨æœåŠ¡è¯æ˜è‡ªå·±çš„èº«ä»½
- ç»“åˆ PKCS7 ç­¾åéªŒè¯çœŸå®æ€§
- å¸¸ç”¨äºæœåŠ¡æ³¨å†Œã€é…ç½®ç®¡ç†

---

## Step 2 - IAM å‡­è¯è·å–æœºåˆ¶ï¼ˆ20 åˆ†é’Ÿï¼‰

### 2.1 å‡­è¯é“¾å›é¡¾

å½“åº”ç”¨ç¨‹åºè°ƒç”¨ AWS API æ—¶ï¼ŒSDK/CLI æŒ‰ä»¥ä¸‹é¡ºåºæŸ¥æ‰¾å‡­è¯ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    AWS å‡­è¯é“¾ (Credential Chain)                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  ä¼˜å…ˆçº§ 1ï¼šç¯å¢ƒå˜é‡                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ AWS_ACCESS_KEY_ID / AWS_SECRET_ACCESS_KEY / AWS_SESSION_TOKEN   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚            â”‚ ä¸å­˜åœ¨                                                      â”‚
â”‚            â–¼                                                             â”‚
â”‚  ä¼˜å…ˆçº§ 2ï¼šé…ç½®æ–‡ä»¶                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ~/.aws/credentials                                              â”‚   â”‚
â”‚  â”‚ [default]                                                       â”‚   â”‚
â”‚  â”‚ aws_access_key_id = AKIA...                                     â”‚   â”‚
â”‚  â”‚ aws_secret_access_key = xxxxx                                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚            â”‚ ä¸å­˜åœ¨                                                      â”‚
â”‚            â–¼                                                             â”‚
â”‚  ä¼˜å…ˆçº§ 3ï¼šå®ä¾‹é…ç½®æ–‡ä»¶ (Instance Profile) â† æ¨èï¼                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ http://169.254.169.254/latest/meta-data/iam/security-credentialsâ”‚   â”‚
â”‚  â”‚                                                                 â”‚   â”‚
â”‚  â”‚ â— ä¸´æ—¶å‡­è¯                                                      â”‚   â”‚
â”‚  â”‚ â— è‡ªåŠ¨è½®æ¢ï¼ˆ6 å°æ—¶ï¼‰                                            â”‚   â”‚
â”‚  â”‚ â— æ— éœ€ç®¡ç†å¯†é’¥                                                  â”‚   â”‚
â”‚  â”‚ â— æœ€å°æƒé™åŸåˆ™                                                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 ä¸´æ—¶å‡­è¯çš„ç»“æ„

```bash
# è·å–å®Œæ•´å‡­è¯
curl -s -H "X-aws-ec2-metadata-token: $TOKEN" \
  http://169.254.169.254/latest/meta-data/iam/security-credentials/$ROLE
```

```json
{
  "Code": "Success",
  "LastUpdated": "2025-01-10T10:30:00Z",
  "Type": "AWS-HMAC",
  "AccessKeyId": "ASIAXXXXXXXXXXX",
  "SecretAccessKey": "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx",
  "Token": "FwoGZXIvYXdzEBYaDK...<very-long-token>...",
  "Expiration": "2025-01-10T16:30:00Z"
}
```

**å…³é”®å­—æ®µ**ï¼š

| å­—æ®µ | è¯´æ˜ |
|------|------|
| `AccessKeyId` | ä¸´æ—¶è®¿é—®å¯†é’¥ï¼ˆä»¥ `ASIA` å¼€å¤´ï¼‰ |
| `SecretAccessKey` | ä¸´æ—¶å¯†é’¥ |
| `Token` | ä¼šè¯ä»¤ç‰Œï¼ˆ**å¿…é¡»**ä¸å¯†é’¥ä¸€èµ·ä½¿ç”¨ï¼‰ |
| `Expiration` | è¿‡æœŸæ—¶é—´ï¼ˆé€šå¸¸ 6 å°æ—¶ï¼‰ |

### 2.3 å‡­è¯è‡ªåŠ¨è½®æ¢

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å‡­è¯è½®æ¢æ—¶é—´çº¿                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  10:00       12:00       14:00       16:00       18:00                  â”‚
â”‚    â”‚           â”‚           â”‚           â”‚           â”‚                    â”‚
â”‚    â–¼           â–¼           â–¼           â–¼           â–¼                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚  â”‚         å‡­è¯ A (æœ‰æ•ˆæœŸ 6 å°æ—¶)                   â”‚                   â”‚
â”‚  â”‚         Expiration: 16:00                       â”‚                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚                                                                         â”‚
â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚                   â”‚    æ–°å‡­è¯ Bï¼ˆæå‰åˆ·æ–°ï¼Œæœ‰é‡å æœŸï¼‰                â”‚  â”‚
â”‚                   â”‚    Expiration: 18:00                            â”‚  â”‚
â”‚                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                         â”‚
â”‚  AWS SDK ä¼šåœ¨è¿‡æœŸå‰è‡ªåŠ¨åˆ·æ–°å‡­è¯ï¼Œåº”ç”¨æ— éœ€å¤„ç†                            â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æœ€ä½³å®è·µ**ï¼šä½¿ç”¨ AWS SDK è€Œéæ‰‹åŠ¨è§£æå‡­è¯ - SDK ä¼šè‡ªåŠ¨å¤„ç†åˆ·æ–°ã€‚

---

## Step 3 - IMDSv2 å®‰å…¨æœºåˆ¶ï¼ˆ25 åˆ†é’Ÿï¼‰

### 3.1 ä¸ºä»€ä¹ˆéœ€è¦ IMDSv2ï¼Ÿ

IMDSv1 çš„å®‰å…¨é—®é¢˜ï¼šä»»ä½•èƒ½å‘é€ HTTP è¯·æ±‚çš„ä»£ç éƒ½èƒ½è·å–å‡­è¯ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    IMDSv1 çš„ SSRF æ¼æ´                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚   æ”»å‡»è€…                    Web åº”ç”¨                    å…ƒæ•°æ®æœåŠ¡        â”‚
â”‚     â”‚                          â”‚                           â”‚            â”‚
â”‚     â”‚  1. æ„é€ æ¶æ„ URL         â”‚                           â”‚            â”‚
â”‚     â”‚  url=http://169.254...  â”‚                           â”‚            â”‚
â”‚     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                           â”‚            â”‚
â”‚     â”‚                          â”‚                           â”‚            â”‚
â”‚     â”‚                          â”‚  2. åº”ç”¨å‘èµ·è¯·æ±‚          â”‚            â”‚
â”‚     â”‚                          â”‚  GET /meta-data/iam/...   â”‚            â”‚
â”‚     â”‚                          â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚            â”‚
â”‚     â”‚                          â”‚                           â”‚            â”‚
â”‚     â”‚                          â”‚  3. è¿”å› IAM å‡­è¯         â”‚            â”‚
â”‚     â”‚                          â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚            â”‚
â”‚     â”‚                          â”‚                           â”‚            â”‚
â”‚     â”‚  4. è¿”å›å‡­è¯ç»™æ”»å‡»è€…     â”‚                           â”‚            â”‚
â”‚     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                           â”‚            â”‚
â”‚     â”‚                          â”‚                           â”‚            â”‚
â”‚     â”‚  5. æ”»å‡»è€…ä½¿ç”¨å‡­è¯       â”‚                           â”‚            â”‚
â”‚     â”‚  è®¿é—® AWS èµ„æºï¼         â”‚                           â”‚            â”‚
â”‚     â”‚                          â”‚                           â”‚            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 IMDSv2 Token æœºåˆ¶

IMDSv2 å¼•å…¥äº†**åŸºäº Token çš„è®¿é—®æ§åˆ¶**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    IMDSv2 å·¥ä½œæµç¨‹                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚   Step 1: è·å– Token (PUT è¯·æ±‚)                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚  PUT /latest/api/token                                          â”‚  â”‚
â”‚   â”‚  X-aws-ec2-metadata-token-ttl-seconds: 21600                    â”‚  â”‚
â”‚   â”‚                                                                 â”‚  â”‚
â”‚   â”‚  è¿”å›: token-string-xxxxx...                                    â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                         â”‚
â”‚   Step 2: ä½¿ç”¨ Token è®¿é—®å…ƒæ•°æ® (GET è¯·æ±‚)                               â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚  GET /latest/meta-data/iam/security-credentials/MyRole          â”‚  â”‚
â”‚   â”‚  X-aws-ec2-metadata-token: token-string-xxxxx...                â”‚  â”‚
â”‚   â”‚                                                                 â”‚  â”‚
â”‚   â”‚  è¿”å›: { "AccessKeyId": "...", "SecretAccessKey": "..." }       â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                         â”‚
â”‚   ä¸ºä»€ä¹ˆ SSRF æ”»å‡»æ— æ³•åˆ©ç”¨ IMDSv2ï¼Ÿ                                      â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                     â”‚
â”‚   â— SSRF é€šå¸¸åªèƒ½å‘é€ GET è¯·æ±‚ï¼Œæ— æ³•å‘é€ PUT è¯·æ±‚è·å– token             â”‚
â”‚   â— å³ä½¿èƒ½å‘é€ PUTï¼Œè¿”å›çš„ token åœ¨ HTTP å“åº” body ä¸­                   â”‚
â”‚   â— SSRF é€šå¸¸æ— æ³•è¯»å–å“åº” body å¹¶åœ¨åç»­è¯·æ±‚ä¸­ä½¿ç”¨                       â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.3 Token TTL å’Œåˆ·æ–°

```bash
# Token æœ‰æ•ˆæœŸå¯è®¾ç½® 1-21600 ç§’ï¼ˆ6 å°æ—¶ï¼‰
# çŸ­æœŸä»»åŠ¡ä½¿ç”¨çŸ­ TTL
TOKEN=$(curl -s -X PUT "http://169.254.169.254/latest/api/token" \
  -H "X-aws-ec2-metadata-token-ttl-seconds: 300")  # 5 åˆ†é’Ÿ

# é•¿æœŸè¿è¡ŒæœåŠ¡ä½¿ç”¨é•¿ TTL
TOKEN=$(curl -s -X PUT "http://169.254.169.254/latest/api/token" \
  -H "X-aws-ec2-metadata-token-ttl-seconds: 21600")  # 6 å°æ—¶
```

**å»ºè®®**ï¼š
- ä¸€æ¬¡æ€§è„šæœ¬ï¼š300 ç§’ï¼ˆ5 åˆ†é’Ÿï¼‰
- åå°æœåŠ¡ï¼š21600 ç§’ï¼ˆ6 å°æ—¶ï¼‰å¹¶å®šæœŸåˆ·æ–°

### 3.4 Hop Limitï¼šç½‘ç»œå±‚é˜²æŠ¤

**Hop Limit** é™åˆ¶å…ƒæ•°æ®è¯·æ±‚çš„ç½‘ç»œè·³æ•°ï¼Œé˜²æ­¢è¯·æ±‚è¢«è½¬å‘åˆ°å®¹å™¨æˆ–å…¶ä»–ç½‘ç»œå±‚ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Hop Limit å·¥ä½œåŸç†                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚   Hop Limit = 1 (é»˜è®¤æ¨è)                                              â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                              â”‚
â”‚                                                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                â”‚
â”‚   â”‚  EC2 å®ä¾‹         â”‚                                                â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚      âœ“ å¯ä»¥è®¿é—®                                â”‚
â”‚   â”‚  â”‚ åº”ç”¨ç¨‹åº    â”‚â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> IMDS                       â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚      (hop = 1)                                 â”‚
â”‚   â”‚                   â”‚                                                â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚      âœ— è¢«é˜»æ­¢                                  â”‚
â”‚   â”‚  â”‚  Docker     â”‚â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> IMDS                       â”‚
â”‚   â”‚  â”‚  å®¹å™¨       â”‚  â”‚      (hop = 2)                                 â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                                                â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                â”‚
â”‚                                                                         â”‚
â”‚   Hop Limit = 2 (å®¹å™¨ç¯å¢ƒ)                                              â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                              â”‚
â”‚                                                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                â”‚
â”‚   â”‚  EC2 å®ä¾‹         â”‚                                                â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚      âœ“ å¯ä»¥è®¿é—®                                â”‚
â”‚   â”‚  â”‚  Docker     â”‚â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> IMDS                       â”‚
â”‚   â”‚  â”‚  å®¹å™¨       â”‚  â”‚      (hop = 2)                                 â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                                                â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                â”‚
â”‚                                                                         â”‚
â”‚   âš ï¸  hop=2 æ—¶å®¹å™¨ä¹Ÿèƒ½è®¿é—® IMDSï¼Œéœ€è¦ç»“åˆå…¶ä»–å®‰å…¨æªæ–½                     â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æŸ¥çœ‹å½“å‰ hop limit**ï¼š

```bash
# é€šè¿‡ AWS CLI æŸ¥çœ‹
aws ec2 describe-instances --instance-ids i-xxxxxxxxx \
  --query 'Reservations[].Instances[].MetadataOptions'
```

```json
{
    "State": "applied",
    "HttpTokens": "required",
    "HttpPutResponseHopLimit": 1,
    "HttpEndpoint": "enabled",
    "HttpProtocolIpv6": "disabled",
    "InstanceMetadataTags": "disabled"
}
```

---

## SSRF å‡­è¯çªƒå–ï¼šCapital One 2019 æ¡ˆä¾‹

> **èƒŒæ™¯**ï¼š2019 å¹´ 7 æœˆï¼ŒCapital One é­å—æ•°æ®æ³„éœ²ï¼Œè¶…è¿‡ 1 äº¿ç”¨æˆ·æ•°æ®è¢«ç›—ã€‚  
> **æ ¹å› **ï¼šWAF é…ç½®é”™è¯¯å¯¼è‡´ SSRF æ¼æ´ï¼Œæ”»å‡»è€…é€šè¿‡å…ƒæ•°æ®æœåŠ¡è·å– IAM å‡­è¯ã€‚  

### æ”»å‡»é“¾åˆ†æ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                Capital One SSRF æ”»å‡»é“¾                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  Step 1: å‘ç°æ¼æ´                                                       â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                       â”‚
â”‚  æ”»å‡»è€…å‘ç° Capital One WAF å­˜åœ¨ SSRF æ¼æ´                               â”‚
â”‚  å¯ä»¥è¯±å¯¼æœåŠ¡å™¨å‘é€ä»»æ„ HTTP è¯·æ±‚                                        â”‚
â”‚                                                                         â”‚
â”‚  Step 2: è·å– IAM å‡­è¯                                                   â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                       â”‚
â”‚  æ”»å‡»è€…æ„é€ æ¶æ„è¯·æ±‚ï¼Œè®© WAF è®¿é—®ï¼š                                       â”‚
â”‚  http://169.254.169.254/latest/meta-data/iam/security-credentials/      â”‚
â”‚                                                                         â”‚
â”‚  IMDSv1 æ— éœ€è®¤è¯ï¼Œç›´æ¥è¿”å›ä¸´æ—¶å‡­è¯ï¼                                     â”‚
â”‚                                                                         â”‚
â”‚  Step 3: æšä¸¾ S3 æ¡¶                                                      â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                       â”‚
â”‚  ä½¿ç”¨è·å–çš„å‡­è¯è°ƒç”¨ AWS APIï¼š                                            â”‚
â”‚  aws s3 ls  # åˆ—å‡ºå¯è®¿é—®çš„ S3 æ¡¶                                         â”‚
â”‚                                                                         â”‚
â”‚  Step 4: ä¸‹è½½æ•æ„Ÿæ•°æ®                                                    â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                       â”‚
â”‚  aws s3 sync s3://capital-one-data /local/  # æ‰¹é‡ä¸‹è½½                  â”‚
â”‚                                                                         â”‚
â”‚  ç»“æœï¼š                                                                  â”‚
â”‚  â— 1 äº¿+ ç”¨æˆ·æ•°æ®æ³„éœ²                                                   â”‚
â”‚  â— ç¤¾ä¿å·ã€é“¶è¡Œè´¦å·ã€ä¿¡ç”¨è¯„åˆ†                                            â”‚
â”‚  â— Capital One è¢«ç½šæ¬¾ 8000 ä¸‡ç¾å…ƒ                                        â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å¦‚æœä½¿ç”¨äº† IMDSv2

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              IMDSv2 å¦‚ä½•é˜»æ­¢ Capital One æ”»å‡»                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  æ”»å‡»è€…å°è¯•ï¼š                                                           â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                          â”‚
â”‚  curl http://169.254.169.254/latest/meta-data/iam/security-credentials/ â”‚
â”‚                                                                         â”‚
â”‚  è¿”å›ï¼š401 Unauthorized                                                 â”‚
â”‚                                                                         â”‚
â”‚  æ”»å‡»è€…éœ€è¦å…ˆè·å– tokenï¼š                                                â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                              â”‚
â”‚  curl -X PUT http://169.254.169.254/latest/api/token \                  â”‚
â”‚    -H "X-aws-ec2-metadata-token-ttl-seconds: 21600"                     â”‚
â”‚                                                                         â”‚
â”‚  ä½†æ˜¯ï¼                                                                 â”‚
â”‚  â”€â”€â”€â”€â”€                                                                  â”‚
â”‚  â— SSRF é€šå¸¸åªèƒ½å‘é€ GET è¯·æ±‚                                           â”‚
â”‚  â— WAF/ä»£ç†å¾ˆå°‘å…è®¸è½¬å‘ PUT è¯·æ±‚                                        â”‚
â”‚  â— å³ä½¿èƒ½å‘é€ PUTï¼Œtoken åœ¨å“åº” body ä¸­                                 â”‚
â”‚  â— æ”»å‡»è€…æ— æ³•è·å–å“åº” body å¹¶åœ¨åç»­è¯·æ±‚ä¸­ä½¿ç”¨                           â”‚
â”‚                                                                         â”‚
â”‚  Hop Limit = 1 çš„é¢å¤–ä¿æŠ¤ï¼š                                             â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                               â”‚
â”‚  å¦‚æœ SSRF æ˜¯é€šè¿‡å®¹å™¨/å‡½æ•°è§¦å‘çš„ï¼š                                       â”‚
â”‚  â— è¯·æ±‚ç»è¿‡ç½‘ç»œæ¡¥æ¥ï¼Œhop > 1                                            â”‚
â”‚  â— IMDS æ‹’ç»è¯·æ±‚                                                        â”‚
â”‚                                                                         â”‚
â”‚  ç»“è®ºï¼šIMDSv2 + Hop Limit = 1 å¯ä»¥æœ‰æ•ˆé˜²å¾¡å¤§å¤šæ•° SSRF æ”»å‡»              â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ•™è®­æ€»ç»“

| é—®é¢˜ | Capital One çš„æƒ…å†µ | æœ€ä½³å®è·µ |
|------|-------------------|----------|
| IMDS ç‰ˆæœ¬ | ä½¿ç”¨ IMDSv1 | å¼ºåˆ¶ IMDSv2 |
| Hop Limit | æœªé™åˆ¶ | è®¾ç½®ä¸º 1 |
| IAM æƒé™ | è¿‡äºå®½æ¾ | æœ€å°æƒé™åŸåˆ™ |
| S3 æ¡¶ç­–ç•¥ | å…è®¸å¹¿æ³›è®¿é—® | ä¸¥æ ¼é™åˆ¶è®¿é—®æ¥æº |
| ç›‘æ§å‘Šè­¦ | æœªåŠæ—¶å‘ç° | å¼‚å¸¸ API è°ƒç”¨å‘Šè­¦ |

---

## Step 4 - è·¨äº‘å…ƒæ•°æ®å¯¹æ¯”ï¼ˆ10 åˆ†é’Ÿï¼‰

æ‰€æœ‰ä¸»æµäº‘å¹³å°éƒ½æä¾›ç±»ä¼¼çš„å…ƒæ•°æ®æœåŠ¡ï¼š

| äº‘å¹³å° | å…ƒæ•°æ®åœ°å€ | å®‰å…¨æœºåˆ¶ | å‡­è¯æœåŠ¡ |
|--------|-----------|----------|----------|
| **AWS** | `169.254.169.254` | IMDSv2 + Hop Limit | Instance Profile |
| **GCP** | `169.254.169.254` | `Metadata-Flavor: Google` header | Service Account |
| **Azure** | `169.254.169.254` | `Metadata: true` header | Managed Identity |

### GCP å…ƒæ•°æ®è®¿é—®

```bash
# GCP è¦æ±‚ç‰¹å®š header
curl -H "Metadata-Flavor: Google" \
  http://169.254.169.254/computeMetadata/v1/instance/service-accounts/default/token
```

### Azure å…ƒæ•°æ®è®¿é—®

```bash
# Azure è¦æ±‚ç‰¹å®š header
curl -H "Metadata: true" \
  "http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=https://management.azure.com/"
```

**å…±åŒæ¨¡å¼**ï¼š
- éƒ½ä½¿ç”¨ `169.254.169.254`
- éƒ½æä¾›ä¸´æ—¶å‡­è¯
- éƒ½è¦æ±‚æŸç§å½¢å¼çš„è®¤è¯ï¼ˆheader æˆ– tokenï¼‰
- å‡­è¯éƒ½ä¼šè‡ªåŠ¨è½®æ¢

---

## Step 5 - å¼ºåˆ¶ IMDSv2ï¼ˆ15 åˆ†é’Ÿï¼‰

### 5.1 å®ä¾‹çº§é…ç½®

**å¯åŠ¨æ—¶å¼ºåˆ¶ IMDSv2**ï¼š

```bash
aws ec2 run-instances \
  --image-id ami-xxxxxxxxx \
  --instance-type t3.micro \
  --metadata-options "HttpTokens=required,HttpPutResponseHopLimit=1,HttpEndpoint=enabled" \
  ...
```

**ä¿®æ”¹ç°æœ‰å®ä¾‹**ï¼š

```bash
aws ec2 modify-instance-metadata-options \
  --instance-id i-xxxxxxxxx \
  --http-tokens required \
  --http-put-response-hop-limit 1 \
  --http-endpoint enabled
```

### 5.2 Launch Template é…ç½®

```json
{
  "MetadataOptions": {
    "HttpTokens": "required",
    "HttpPutResponseHopLimit": 1,
    "HttpEndpoint": "enabled",
    "InstanceMetadataTags": "enabled"
  }
}
```

### 5.3 ç»„ç»‡çº§ SCP ç­–ç•¥

ä½¿ç”¨ Service Control Policy (SCP) åœ¨ç»„ç»‡çº§åˆ«å¼ºåˆ¶ IMDSv2ï¼š

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "RequireIMDSv2",
      "Effect": "Deny",
      "Action": "ec2:RunInstances",
      "Resource": "arn:aws:ec2:*:*:instance/*",
      "Condition": {
        "StringNotEquals": {
          "ec2:MetadataHttpTokens": "required"
        }
      }
    },
    {
      "Sid": "PreventIMDSv2Disable",
      "Effect": "Deny",
      "Action": "ec2:ModifyInstanceMetadataOptions",
      "Resource": "arn:aws:ec2:*:*:instance/*",
      "Condition": {
        "StringEquals": {
          "ec2:MetadataHttpTokens": "optional"
        }
      }
    }
  ]
}
```

### 5.4 æ£€æµ‹æœªé…ç½® IMDSv2 çš„å®ä¾‹

```bash
# åˆ—å‡ºæ‰€æœ‰æœªå¼ºåˆ¶ IMDSv2 çš„å®ä¾‹
aws ec2 describe-instances \
  --query 'Reservations[].Instances[?MetadataOptions.HttpTokens!=`required`].[InstanceId,Tags[?Key==`Name`].Value|[0],MetadataOptions.HttpTokens]' \
  --output table
```

---

## Lab 1 - IMDSv2 Token å®éªŒï¼ˆ25 åˆ†é’Ÿï¼‰

### å®éªŒç›®æ ‡

æ·±å…¥ç†è§£ IMDSv2 token æœºåˆ¶ï¼ŒéªŒè¯å®‰å…¨æ€§ã€‚

### Step 1 - å‡†å¤‡ç¯å¢ƒ

ç¡®ä¿ä½ æœ‰ä¸€å° EC2 å®ä¾‹ï¼Œæœ€å¥½å¼ºåˆ¶ IMDSv2ï¼š

```bash
# æ£€æŸ¥å½“å‰é…ç½®
INSTANCE_ID=$(curl -s -X PUT "http://169.254.169.254/latest/api/token" \
  -H "X-aws-ec2-metadata-token-ttl-seconds: 60" | xargs -I {} \
  curl -s -H "X-aws-ec2-metadata-token: {}" http://169.254.169.254/latest/meta-data/instance-id)

aws ec2 describe-instances --instance-ids $INSTANCE_ID \
  --query 'Reservations[].Instances[].MetadataOptions'
```

### Step 2 - Token å®éªŒ

```bash
# å®éªŒ 1: æ—  token è®¿é—®
echo "=== Test 1: Access without token ==="
curl -s -w "\nHTTP Status: %{http_code}\n" \
  http://169.254.169.254/latest/meta-data/instance-id

# å®éªŒ 2: è·å–çŸ­æœŸ token (60 ç§’)
echo -e "\n=== Test 2: Get short-lived token ==="
SHORT_TOKEN=$(curl -s -X PUT "http://169.254.169.254/latest/api/token" \
  -H "X-aws-ec2-metadata-token-ttl-seconds: 60")
echo "Token obtained (first 20 chars): ${SHORT_TOKEN:0:20}..."

# å®éªŒ 3: ä½¿ç”¨ token è®¿é—®
echo -e "\n=== Test 3: Access with token ==="
curl -s -H "X-aws-ec2-metadata-token: $SHORT_TOKEN" \
  http://169.254.169.254/latest/meta-data/instance-id

# å®éªŒ 4: ç­‰å¾… token è¿‡æœŸ (éœ€è¦ç­‰å¾… 60 ç§’)
echo -e "\n=== Test 4: Wait for token expiration ==="
echo "Waiting 65 seconds for token to expire..."
sleep 65

# å®éªŒ 5: ä½¿ç”¨è¿‡æœŸ token
echo -e "\n=== Test 5: Access with expired token ==="
curl -s -w "\nHTTP Status: %{http_code}\n" \
  -H "X-aws-ec2-metadata-token: $SHORT_TOKEN" \
  http://169.254.169.254/latest/meta-data/instance-id
```

### Step 3 - å°è£…ä¸ºå‡½æ•°

åˆ›å»ºä¸€ä¸ªå¯å¤ç”¨çš„å…ƒæ•°æ®æŸ¥è¯¢å‡½æ•°ï¼š

```bash
#!/bin/bash
# imds_query.sh - IMDSv2 å…¼å®¹çš„å…ƒæ•°æ®æŸ¥è¯¢å‡½æ•°

# è·å–æˆ–åˆ·æ–° token
get_imds_token() {
    local ttl=${1:-21600}  # é»˜è®¤ 6 å°æ—¶
    curl -s -X PUT "http://169.254.169.254/latest/api/token" \
        -H "X-aws-ec2-metadata-token-ttl-seconds: $ttl" \
        --connect-timeout 2
}

# æŸ¥è¯¢å…ƒæ•°æ®
query_metadata() {
    local path=$1
    local token=${2:-$(get_imds_token)}

    if [ -z "$token" ]; then
        echo "Error: Failed to get IMDS token" >&2
        return 1
    fi

    curl -s -H "X-aws-ec2-metadata-token: $token" \
        "http://169.254.169.254/latest/meta-data/$path" \
        --connect-timeout 2
}

# ä½¿ç”¨ç¤ºä¾‹
TOKEN=$(get_imds_token)
echo "Instance ID: $(query_metadata instance-id $TOKEN)"
echo "Instance Type: $(query_metadata instance-type $TOKEN)"
echo "AZ: $(query_metadata placement/availability-zone $TOKEN)"
echo "Private IP: $(query_metadata local-ipv4 $TOKEN)"
```

### æ£€æŸ¥æ¸…å•

- [ ] ç†è§£æ—  token è®¿é—®ä¼šè¢«æ‹’ç»ï¼ˆå¼ºåˆ¶ IMDSv2 æ—¶ï¼‰
- [ ] èƒ½è·å–æŒ‡å®š TTL çš„ token
- [ ] ç†è§£ token è¿‡æœŸåéœ€è¦é‡æ–°è·å–
- [ ] åˆ›å»ºäº†å¯å¤ç”¨çš„å…ƒæ•°æ®æŸ¥è¯¢å‡½æ•°

---

## Lab 2 - Credential Gap åœºæ™¯ï¼ˆ30 åˆ†é’Ÿï¼‰

### åœºæ™¯æè¿°

> ä¸€ä¸ªå¤‡ä»½ Python è„šæœ¬åœ¨æ—§å®ä¾‹ä¸Šæ­£å¸¸å·¥ä½œï¼Œä½†åœ¨æ–°çš„ã€Œå®‰å…¨åŠ å›ºã€å®ä¾‹ç¾¤ä¸Šå¤±è´¥ï¼Œè¿”å› "401 Unauthorized"ã€‚  

è¿™æ˜¯æ—¥æœ¬ IT ç°åœºå¸¸è§çš„**éšœå®³å¯¾å¿œ**åœºæ™¯ï¼šå®‰å…¨å›¢é˜Ÿå¯ç”¨äº† IMDSv2ï¼Œä½†æ—§è„šæœ¬è¿˜åœ¨ä½¿ç”¨ IMDSv1ã€‚

### å®éªŒç›®æ ‡

è¯Šæ–­å¹¶ä¿®å¤ IMDSv1 è„šæœ¬åœ¨ IMDSv2 å®ä¾‹ä¸Šçš„å¤±è´¥ã€‚

### Step 1 - æ¨¡æ‹Ÿæ—§è„šæœ¬ï¼ˆIMDSv1 æ–¹å¼ï¼‰

åˆ›å»ºä¸€ä¸ªä½¿ç”¨ IMDSv1 çš„å¤‡ä»½è„šæœ¬ï¼š

```bash
cat > /tmp/backup_v1.sh << 'EOF'
#!/bin/bash
# backup_v1.sh - ä½¿ç”¨ IMDSv1 çš„æ—§ç‰ˆå¤‡ä»½è„šæœ¬
# é—®é¢˜ï¼šåœ¨ IMDSv2 å®ä¾‹ä¸Šä¼šå¤±è´¥

echo "=== Old Backup Script (IMDSv1) ==="

# è·å–å®ä¾‹ IDï¼ˆIMDSv1 æ–¹å¼ - ç›´æ¥ GETï¼‰
INSTANCE_ID=$(curl -s http://169.254.169.254/latest/meta-data/instance-id)

if [ -z "$INSTANCE_ID" ]; then
    echo "ERROR: Failed to get instance ID"
    exit 1
fi

echo "Instance ID: $INSTANCE_ID"

# è·å– IAM è§’è‰²å
ROLE=$(curl -s http://169.254.169.254/latest/meta-data/iam/security-credentials/)

if [ -z "$ROLE" ]; then
    echo "ERROR: Failed to get IAM role"
    exit 1
fi

echo "IAM Role: $ROLE"

# è·å–å‡­è¯
CREDS=$(curl -s http://169.254.169.254/latest/meta-data/iam/security-credentials/$ROLE)

if echo "$CREDS" | grep -q "AccessKeyId"; then
    echo "SUCCESS: Got credentials"
    # æ¨¡æ‹Ÿå¤‡ä»½æ“ä½œ
    echo "Performing backup..."
else
    echo "ERROR: Failed to get credentials"
    echo "Response: $CREDS"
    exit 1
fi
EOF

chmod +x /tmp/backup_v1.sh
```

### Step 2 - è¿è¡Œå¹¶è§‚å¯Ÿå¤±è´¥

```bash
# è¿è¡Œæ—§è„šæœ¬
/tmp/backup_v1.sh
```

**åœ¨å¼ºåˆ¶ IMDSv2 çš„å®ä¾‹ä¸Šï¼Œè¾“å‡º**ï¼š

```
=== Old Backup Script (IMDSv1) ===
ERROR: Failed to get instance ID
```

æˆ–è€…ï¼š

```
=== Old Backup Script (IMDSv1) ===
Instance ID:
ERROR: Failed to get instance ID
```

### Step 3 - è¯Šæ–­é—®é¢˜

```bash
# æ£€æŸ¥ IMDS é…ç½®
echo "=== IMDS Configuration ==="
curl -s -X PUT "http://169.254.169.254/latest/api/token" \
  -H "X-aws-ec2-metadata-token-ttl-seconds: 60" > /dev/null && \
  echo "IMDSv2 is available"

# å°è¯• IMDSv1 æ–¹å¼
echo -e "\n=== IMDSv1 Test ==="
curl -s -w "\nHTTP Status: %{http_code}\n" \
  http://169.254.169.254/latest/meta-data/instance-id

# éªŒè¯å½“å‰èº«ä»½
echo -e "\n=== Current Identity ==="
aws sts get-caller-identity 2>&1 || echo "AWS CLI also failing?"
```

### Step 4 - ä¿®å¤è„šæœ¬ï¼ˆIMDSv2 å…¼å®¹ï¼‰

åˆ›å»ºä¿®å¤åçš„è„šæœ¬ï¼š

```bash
cat > /tmp/backup_v2.sh << 'EOF'
#!/bin/bash
# backup_v2.sh - IMDSv2 å…¼å®¹çš„å¤‡ä»½è„šæœ¬
# æœ€ä½³å®è·µï¼šæ”¯æŒ IMDSv1 å’Œ IMDSv2

echo "=== Updated Backup Script (IMDSv2 Compatible) ==="

# å‡½æ•°ï¼šè·å–å…ƒæ•°æ®ï¼ˆIMDSv2 ä¼˜å…ˆï¼Œfallback åˆ° IMDSv1ï¼‰
get_metadata() {
    local path=$1
    local token=$2

    if [ -n "$token" ]; then
        # IMDSv2
        curl -s -H "X-aws-ec2-metadata-token: $token" \
            "http://169.254.169.254/latest/meta-data/$path" \
            --connect-timeout 2
    else
        # Fallback to IMDSv1 (for older instances)
        curl -s "http://169.254.169.254/latest/meta-data/$path" \
            --connect-timeout 2
    fi
}

# å°è¯•è·å– IMDSv2 token
echo "Attempting to get IMDSv2 token..."
TOKEN=$(curl -s -X PUT "http://169.254.169.254/latest/api/token" \
    -H "X-aws-ec2-metadata-token-ttl-seconds: 21600" \
    --connect-timeout 2)

if [ -n "$TOKEN" ]; then
    echo "IMDSv2 token obtained"
else
    echo "IMDSv2 token not available, falling back to IMDSv1"
fi

# è·å–å®ä¾‹ ID
INSTANCE_ID=$(get_metadata "instance-id" "$TOKEN")

if [ -z "$INSTANCE_ID" ]; then
    echo "ERROR: Failed to get instance ID"
    echo "Check: Is IMDS endpoint enabled?"
    exit 1
fi

echo "Instance ID: $INSTANCE_ID"

# è·å– IAM è§’è‰²å
ROLE=$(get_metadata "iam/security-credentials/" "$TOKEN")

if [ -z "$ROLE" ]; then
    echo "ERROR: Failed to get IAM role"
    echo "Check: Is an IAM role attached to this instance?"
    exit 1
fi

echo "IAM Role: $ROLE"

# è·å–å‡­è¯
CREDS=$(get_metadata "iam/security-credentials/$ROLE" "$TOKEN")

if echo "$CREDS" | grep -q "AccessKeyId"; then
    echo "SUCCESS: Got credentials"

    # è§£æå‡­è¯ï¼ˆç”¨äºæ¼”ç¤ºï¼‰
    ACCESS_KEY=$(echo "$CREDS" | python3 -c "import sys,json; print(json.load(sys.stdin)['AccessKeyId'])")
    EXPIRATION=$(echo "$CREDS" | python3 -c "import sys,json; print(json.load(sys.stdin)['Expiration'])")

    echo "Access Key ID: ${ACCESS_KEY:0:10}..."
    echo "Expiration: $EXPIRATION"

    # æ¨¡æ‹Ÿå¤‡ä»½æ“ä½œ
    echo "Performing backup..."
    # aws s3 sync /data s3://backup-bucket/...

    echo "Backup completed successfully!"
else
    echo "ERROR: Failed to get credentials"
    echo "Response: $CREDS"
    exit 1
fi
EOF

chmod +x /tmp/backup_v2.sh
```

### Step 5 - éªŒè¯ä¿®å¤

```bash
# è¿è¡Œä¿®å¤åçš„è„šæœ¬
/tmp/backup_v2.sh
```

**é¢„æœŸè¾“å‡º**ï¼š

```
=== Updated Backup Script (IMDSv2 Compatible) ===
Attempting to get IMDSv2 token...
IMDSv2 token obtained
Instance ID: i-0abc123def456789
IAM Role: MyBackupRole
SUCCESS: Got credentials
Access Key ID: ASIAXXX...
Expiration: 2025-01-10T16:30:00Z
Performing backup...
Backup completed successfully!
```

### æ£€æŸ¥æ¸…å•

- [ ] ç†è§£ IMDSv1 è„šæœ¬åœ¨ IMDSv2 å®ä¾‹ä¸Šå¤±è´¥çš„åŸå› 
- [ ] èƒ½è¯Šæ–­ 401 Unauthorized é”™è¯¯
- [ ] èƒ½å°†è„šæœ¬ä¿®æ”¹ä¸º IMDSv2 å…¼å®¹
- [ ] ç†è§£ fallback æœºåˆ¶çš„è®¾è®¡æ¨¡å¼

---

## åæ¨¡å¼æ¼”ç¤º

### åæ¨¡å¼ 1ï¼šä½¿ç”¨ IMDSv1

```bash
# é”™è¯¯ï¼šç›´æ¥ GET è¯·æ±‚ï¼Œåœ¨ IMDSv2 å®ä¾‹ä¸Šä¼šå¤±è´¥
INSTANCE_ID=$(curl -s http://169.254.169.254/latest/meta-data/instance-id)
```

**åæœ**ï¼š
- åœ¨å¼ºåˆ¶ IMDSv2 çš„å®ä¾‹ä¸Šè¿”å›ç©ºæˆ– 401
- è„šæœ¬é™é»˜å¤±è´¥ï¼Œéš¾ä»¥æ’æŸ¥
- å­˜åœ¨ SSRF å®‰å…¨é£é™©

**ä¿®å¤**ï¼š

```bash
# æ­£ç¡®ï¼šå…ˆè·å– tokenï¼Œå†ä½¿ç”¨ token è®¿é—®
TOKEN=$(curl -s -X PUT "http://169.254.169.254/latest/api/token" \
  -H "X-aws-ec2-metadata-token-ttl-seconds: 21600")
INSTANCE_ID=$(curl -s -H "X-aws-ec2-metadata-token: $TOKEN" \
  http://169.254.169.254/latest/meta-data/instance-id)
```

### åæ¨¡å¼ 2ï¼šå‡è®¾å…ƒæ•°æ®æ°¸è¿œå¯è¾¾

```bash
# é”™è¯¯ï¼šæ²¡æœ‰è¶…æ—¶å’Œé”™è¯¯å¤„ç†
REGION=$(curl http://169.254.169.254/latest/meta-data/placement/region)
aws s3 ls s3://my-bucket --region $REGION
```

**åæœ**ï¼š
- å…ƒæ•°æ®æœåŠ¡æš‚æ—¶ä¸å¯ç”¨æ—¶è„šæœ¬æŒ‚èµ·
- ç½‘ç»œé—®é¢˜å¯¼è‡´æ— é™ç­‰å¾…
- å˜é‡ä¸ºç©ºå¯¼è‡´åç»­å‘½ä»¤å¤±è´¥

**ä¿®å¤**ï¼š

```bash
# æ­£ç¡®ï¼šæ·»åŠ è¶…æ—¶å’Œé”™è¯¯å¤„ç†
TOKEN=$(curl -s -X PUT "http://169.254.169.254/latest/api/token" \
  -H "X-aws-ec2-metadata-token-ttl-seconds: 300" \
  --connect-timeout 2 --max-time 5)

if [ -z "$TOKEN" ]; then
    echo "ERROR: Cannot get IMDS token, using fallback region"
    REGION="ap-northeast-1"  # é»˜è®¤å€¼
else
    REGION=$(curl -s -H "X-aws-ec2-metadata-token: $TOKEN" \
      http://169.254.169.254/latest/meta-data/placement/region \
      --connect-timeout 2 --max-time 5)

    if [ -z "$REGION" ]; then
        echo "WARNING: Cannot get region from metadata, using fallback"
        REGION="ap-northeast-1"
    fi
fi

aws s3 ls s3://my-bucket --region $REGION
```

### åæ¨¡å¼ 3ï¼šHop Limit è®¾ç½®è¿‡é«˜

```bash
# é”™è¯¯ï¼šä¸ºäº†è®©å®¹å™¨è®¿é—® IMDSï¼Œå°† hop limit è®¾ä¸º 2 æˆ–æ›´é«˜
aws ec2 modify-instance-metadata-options \
  --instance-id i-xxxxxxxxx \
  --http-put-response-hop-limit 2
```

**åæœ**ï¼š
- å®¹å™¨å¯ä»¥ç›´æ¥è®¿é—®å®¿ä¸»æœºçš„ IMDS
- å®¹å™¨é€ƒé€¸æ”»å‡»å¯èƒ½è·å–å®¿ä¸»æœºå‡­è¯
- è¿åæœ€å°æƒé™åŸåˆ™

**ä¿®å¤**ï¼š

```bash
# æ­£ç¡®ï¼šä¿æŒ hop limit = 1ï¼Œå®¹å™¨ä½¿ç”¨ä¸“ç”¨å‡­è¯æœºåˆ¶
aws ec2 modify-instance-metadata-options \
  --instance-id i-xxxxxxxxx \
  --http-put-response-hop-limit 1

# å®¹å™¨åº”ä½¿ç”¨ï¼š
# - ECS: Task Role
# - EKS: IRSA (IAM Roles for Service Accounts)
# - æ‰‹åŠ¨: é€šè¿‡ iptables è½¬å‘åˆ°ä»£ç†
```

---

## èŒåœºå°è´´å£«ï¼ˆJapan IT Contextï¼‰

### FISC é‡‘èç›‘ç®¡è¦æ±‚

**FISC**ï¼ˆé‡‘èæƒ…æŠ¥ã‚·ã‚¹ãƒ†ãƒ ã‚»ãƒ³ã‚¿ãƒ¼ï¼‰æ˜¯æ—¥æœ¬é‡‘èå…ä¸‹å±æœºæ„ï¼Œå‘å¸ƒé‡‘èç³»ç»Ÿå®‰å…¨æŒ‡å—ã€‚

å¯¹äºäº‘ç¯å¢ƒï¼ŒFISC æŒ‡å—è¦æ±‚ï¼š

| è¦æ±‚ | IMDS ç›¸å…³æªæ–½ |
|------|--------------|
| å‡­è¨¼ç®¡ç† | ä½¿ç”¨ä¸´æ—¶å‡­è¯ï¼ˆInstance Profileï¼‰ï¼Œç¦æ­¢ç¡¬ç¼–ç  |
| ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ | å¼ºåˆ¶ IMDSv2ï¼Œè®¾ç½® hop limit |
| ç›£æŸ»è¨¼è·¡ | è®°å½•å‡­è¯è®¿é—®æ—¥å¿— |
| æš—å·åŒ– | å‡­è¯ä¼ è¾“åŠ å¯†ï¼ˆIMDS æ˜¯æœ¬åœ°è®¿é—®ï¼Œå·²éš”ç¦»ï¼‰ |

### ISMAP æ”¿åºœäº‘è®¤è¯

**ISMAP**ï¼ˆæ”¿åºœæƒ…å ±ã‚·ã‚¹ãƒ†ãƒ ã®ãŸã‚ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è©•ä¾¡åˆ¶åº¦ï¼‰æ˜¯æ—¥æœ¬æ”¿åºœçš„äº‘å®‰å…¨è®¤è¯ã€‚

AWS ç­‰äº‘æœåŠ¡å•†å·²é€šè¿‡ ISMAP è®¤è¯ï¼Œä½†ç”¨æˆ·ä¾§é…ç½®ä»éœ€æ»¡è¶³ï¼š

- å¼ºåˆ¶ IMDSv2
- æœ€å°æƒé™ IAM ç­–ç•¥
- å‡­è¯ä½¿ç”¨å®¡è®¡

### æ—¥æœ¬ IT æœ¯è¯­å¯¹ç…§

| æ—¥è¯­æœ¯è¯­ | è¯»éŸ³ | å«ä¹‰ | åœºæ™¯ |
|----------|------|------|------|
| ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­– | ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãŸã„ã•ã | å®‰å…¨æªæ–½ | "IMDSv2 ã¯ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–ã®åŸºæœ¬ã§ã™" |
| èªè¨¼ãƒ»èªå¯ | ã«ã‚“ã—ã‚‡ã†ãƒ»ã«ã‚“ã‹ | è®¤è¯ãƒ»æˆæƒ | "IMDS ã§èªè¨¼æƒ…å ±ã‚’å–å¾—" |
| ä¸€æ™‚èªè¨¼æƒ…å ± | ã„ã¡ã˜ã«ã‚“ã—ã‚‡ã†ã˜ã‚‡ã†ã»ã† | ä¸´æ—¶å‡­è¯ | Instance Profile æä¾›çš„å‡­è¯ |
| æ¨©é™åˆ†é›¢ | ã‘ã‚“ã’ã‚“ã¶ã‚“ã‚Š | æƒé™åˆ†ç¦» | æœ€å°æƒé™åŸåˆ™ |
| è„†å¼±æ€§ | ãœã„ã˜ã‚ƒãã›ã„ | æ¼æ´ | "SSRF è„†å¼±æ€§ã«ã‚ˆã‚‹èªè¨¼æƒ…å ±æ¼æ´©" |

### å®‰å…¨åŠ å›ºæ£€æŸ¥æ¸…å•ï¼ˆæ—¥æœ¬ä¼ä¸šæ ¼å¼ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            IMDS ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ                                 â”‚
â”‚            (IMDS Security Checklist)                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  1. IMDS ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç¢ºèª                                                  â”‚
â”‚     â–¡ HttpTokens = required (IMDSv2 å¼·åˆ¶)                               â”‚
â”‚     â–¡ IMDSv1 ã‚’ä½¿ç”¨ã™ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒãªã„ã‹ç¢ºèª                            â”‚
â”‚                                                                         â”‚
â”‚  2. Hop Limit ç¢ºèª                                                      â”‚
â”‚     â–¡ HttpPutResponseHopLimit = 1                                       â”‚
â”‚     â–¡ ã‚³ãƒ³ãƒ†ãƒŠç’°å¢ƒã®å ´åˆã¯åˆ¥é€”å¯¾ç­–                                       â”‚
â”‚                                                                         â”‚
â”‚  3. IAM ãƒ­ãƒ¼ãƒ«ç¢ºèª                                                       â”‚
â”‚     â–¡ æœ€å°æ¨©é™ã®åŸå‰‡ã«å¾“ã£ã¦ã„ã‚‹                                         â”‚
â”‚     â–¡ ä¸è¦ãªæ¨©é™ãŒä»˜ä¸ã•ã‚Œã¦ã„ãªã„                                       â”‚
â”‚                                                                         â”‚
â”‚  4. ç›£è¦–è¨­å®š                                                             â”‚
â”‚     â–¡ CloudTrail ã§ API ã‚³ãƒ¼ãƒ«ç›£è¦–                                       â”‚
â”‚     â–¡ ç•°å¸¸ãªãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹ã®ã‚¢ãƒ©ãƒ¼ãƒˆ                                 â”‚
â”‚                                                                         â”‚
â”‚  5. çµ„ç¹”ãƒãƒªã‚·ãƒ¼                                                         â”‚
â”‚     â–¡ SCP ã§ IMDSv2 ã‚’çµ„ç¹”å…¨ä½“ã§å¼·åˆ¶                                     â”‚
â”‚     â–¡ æ–°è¦ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š                                   â”‚
â”‚                                                                         â”‚
â”‚  ç¢ºèªæ—¥: ____________  ç¢ºèªè€…: ____________                             â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ£€æŸ¥æ¸…å•

å®Œæˆæœ¬è¯¾åï¼Œä½ åº”è¯¥èƒ½å¤Ÿï¼š

- [ ] è§£é‡Šå…ƒæ•°æ®æœåŠ¡ï¼ˆIMDSï¼‰çš„ä½œç”¨å’Œè®¿é—®æ–¹æ³•
- [ ] åˆ—å‡ºå¸¸ç”¨çš„å…ƒæ•°æ®è·¯å¾„åŠå…¶ç”¨é€”
- [ ] æ¼”ç¤º IMDSv2 token è·å–å’Œä½¿ç”¨æµç¨‹
- [ ] è§£é‡Š SSRF æ”»å‡»å¦‚ä½•åˆ©ç”¨ IMDSv1 çªƒå–å‡­è¯
- [ ] è¯´æ˜ hop limit çš„ä½œç”¨å’Œæ¨èå€¼
- [ ] é…ç½®å®ä¾‹å¼ºåˆ¶ä½¿ç”¨ IMDSv2
- [ ] å°† IMDSv1 è„šæœ¬ä¿®æ”¹ä¸º IMDSv2 å…¼å®¹
- [ ] è§£é‡Š Capital One äº‹ä»¶çš„æ”»å‡»é“¾å’Œé˜²æŠ¤æªæ–½

---

## æœ¬è¯¾å°ç»“

| æ¦‚å¿µ | è¦ç‚¹ |
|------|------|
| IMDS åœ°å€ | `169.254.169.254`ï¼ˆé“¾è·¯æœ¬åœ°åœ°å€ï¼‰ |
| å¯ç”¨æ•°æ® | instance-id, IAM å‡­è¯, user-data, èº«ä»½æ–‡æ¡£ |
| IMDSv2 æœºåˆ¶ | PUT è·å– token â†’ ç”¨ token è®¿é—®æ•°æ® |
| Token TTL | 1-21600 ç§’ï¼ˆæ¨èçŸ­æœŸä»»åŠ¡ç”¨çŸ­ TTLï¼‰ |
| Hop Limit | é™åˆ¶ç½‘ç»œè·³æ•°ï¼Œæ¨èè®¾ä¸º 1 |
| SSRF é˜²æŠ¤ | IMDSv2 + Hop Limit = 1 |
| å‡­è¯æœ€ä½³å®è·µ | ä½¿ç”¨ Instance Profileï¼Œç¦æ­¢ç¡¬ç¼–ç  |

---

## å»¶ä¼¸é˜…è¯»

- [AWS IMDSv2 æ–‡æ¡£](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/configuring-instance-metadata-service.html) - å®˜æ–¹é…ç½®æŒ‡å—
- [Add defense in depth against open firewalls, reverse proxies, and SSRF vulnerabilities](https://aws.amazon.com/blogs/security/defense-in-depth-open-firewalls-reverse-proxies-ssrf-vulnerabilities-ec2-instance-metadata-service/) - AWS å®‰å…¨åšå®¢
- [Capital One Data Breach Analysis](https://krebsonsecurity.com/2019/07/capital-one-data-theft-impacts-106m-people/) - æ¡ˆä¾‹åˆ†æ
- ä¸‹ä¸€è¯¾ï¼š[04 - äº‘ç½‘ç»œï¼šLinux è§†è§’](../04-cloud-networking/) - ç†è§£å®‰å…¨ç»„ä¸ nftables çš„å…³ç³»
- ç›¸å…³è¯¾ç¨‹ï¼š[06 - IAM ä¸å®ä¾‹é…ç½®æ–‡ä»¶](../06-iam-instance-profiles/) - æ·±å…¥ IAM å‡­è¯ç®¡ç†

---

## æ¸…ç†èµ„æº

æœ¬è¯¾å®éªŒä¸»è¦æ˜¯æŸ¥è¯¢æ“ä½œï¼Œæ— éœ€ç‰¹åˆ«æ¸…ç†ã€‚

å¦‚æœä½ ä¿®æ”¹äº†å®ä¾‹çš„ IMDS é…ç½®ç”¨äºæµ‹è¯•ï¼Œè®°å¾—æ¢å¤ï¼š

```bash
# å¦‚æœéœ€è¦æ¢å¤å…è®¸ IMDSv1ï¼ˆä¸æ¨èç”¨äºç”Ÿäº§ï¼‰
aws ec2 modify-instance-metadata-options \
  --instance-id i-xxxxxxxxx \
  --http-tokens optional \
  --http-put-response-hop-limit 1
```

> **å®‰å…¨æé†’**ï¼šç”Ÿäº§ç¯å¢ƒåº”å§‹ç»ˆä¿æŒ `HttpTokens=required`ã€‚  

---

## ç³»åˆ—å¯¼èˆª

[<- 02 - cloud-init å¯åŠ¨æµç¨‹](../02-cloud-init/) | [ç³»åˆ—é¦–é¡µ](../) | [04 - äº‘ç½‘ç»œï¼šLinux è§†è§’ ->](../04-cloud-networking/)
