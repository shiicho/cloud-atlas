# 02 - cloud-init å¯åŠ¨æµç¨‹ï¼ˆcloud-init Fundamentalsï¼‰

> **ç›®æ ‡**ï¼šç†è§£ cloud-init å››é˜¶æ®µå¯åŠ¨ï¼Œå­¦ä¼šè°ƒè¯•"æ²‰é»˜å¯åŠ¨"æ•…éšœ  
> **å‰ç½®**ï¼š[01 - äº‘ä¸­ Linux æœ‰ä½•ä¸åŒ](../01-cloud-context/)ã€åŸºç¡€ systemd æ¦‚å¿µ  
> **æ—¶é—´**ï¼šâš¡ 40 åˆ†é’Ÿï¼ˆé€Ÿè¯»ï¼‰/ ğŸ”¬ 150 åˆ†é’Ÿï¼ˆå®Œæ•´å®æ“ï¼‰  
> **å®æˆ˜åœºæ™¯**ï¼šè¯Šæ–­ user-data æ‰§è¡Œå¤±è´¥çš„éšœå®³å¯¾å¿œ  

---

## å°†å­¦åˆ°çš„å†…å®¹

1. ç†è§£ cloud-init å››ä¸ªå¯åŠ¨é˜¶æ®µåŠå…¶æ‰§è¡Œé¡ºåº
2. ç¼–å†™ shell è„šæœ¬å’Œ cloud-config YAML ä¸¤ç§ user-data
3. è°ƒè¯• cloud-init å¤±è´¥çš„å¯åŠ¨ï¼ˆThe Silent Boot åœºæ™¯ï¼‰
4. ç¼–å†™å¹‚ç­‰çš„åˆå§‹åŒ–è„šæœ¬ï¼Œé¿å… ASG æ‰©å®¹å¤±è´¥

---

## å…ˆè·‘èµ·æ¥ï¼ï¼ˆ10 åˆ†é’Ÿï¼‰

> åœ¨å­¦ä¹  cloud-init ç†è®ºä¹‹å‰ï¼Œå…ˆè§‚å¯Ÿå®ƒåœ¨ä½ çš„å®ä¾‹ä¸Šåšäº†ä»€ä¹ˆã€‚  

åœ¨ä»»æ„ EC2 å®ä¾‹ä¸Šè¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```bash
# cloud-init æ‰§è¡Œå®Œäº†å—ï¼Ÿ
cloud-init status

# æŸ¥çœ‹å®ä¾‹çš„ user-dataï¼ˆä½ å¯åŠ¨æ—¶ä¼ å…¥çš„è„šæœ¬ï¼‰
sudo cat /var/lib/cloud/instance/user-data.txt

# æŸ¥çœ‹ cloud-init æ‰§è¡Œäº†ä»€ä¹ˆ
sudo cat /var/log/cloud-init-output.log | tail -30

# æŸ¥çœ‹å››ä¸ªé˜¶æ®µçš„æ‰§è¡ŒçŠ¶æ€
cloud-init analyze show
```

**ä½ åˆšåˆšçœ‹åˆ°äº†ä»€ä¹ˆï¼Ÿ**

```
status: done
```

è¿™è¡¨ç¤º cloud-init å·²å®Œæˆæ‰€æœ‰å››ä¸ªé˜¶æ®µçš„æ‰§è¡Œã€‚å¦‚æœä½ çœ‹åˆ° `status: running`ï¼Œè¯´æ˜è¿˜åœ¨æ‰§è¡Œä¸­ã€‚

**é‡è¦å‘ç°**ï¼š
- `/var/lib/cloud/instance/user-data.txt` ä¿å­˜äº†ä½ ä¼ å…¥çš„ user-data
- `/var/log/cloud-init-output.log` è®°å½•äº†è„šæœ¬çš„æ ‡å‡†è¾“å‡º
- `cloud-init analyze show` å±•ç¤ºäº†å„é˜¶æ®µçš„è€—æ—¶

ç°åœ¨è®©æˆ‘ä»¬ç†è§£ cloud-init æ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚

---

## Step 1 - cloud-init æ˜¯ä»€ä¹ˆï¼Ÿï¼ˆ10 åˆ†é’Ÿï¼‰

### 1.1 è·¨äº‘åˆå§‹åŒ–æ¡†æ¶

cloud-init æ˜¯ä¸€ä¸ª**è·¨äº‘å¹³å°**çš„å®ä¾‹åˆå§‹åŒ–å·¥å…·ï¼Œç”± Canonicalï¼ˆUbuntu çš„æ¯å…¬å¸ï¼‰å¼€å‘ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    cloud-init æ¶æ„                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚   â”‚    AWS    â”‚    â”‚    GCP    â”‚    â”‚   Azure   â”‚         â”‚
â”‚   â”‚  EC2 IMDS â”‚    â”‚  Metadata â”‚    â”‚  Wireserverâ”‚        â”‚
â”‚   â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜         â”‚
â”‚         â”‚                â”‚                â”‚                â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                          â–¼                                  â”‚
â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚                  â”‚   Datasource  â”‚  â† æ•°æ®æºæŠ½è±¡å±‚          â”‚
â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚                          â–¼                                  â”‚
â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚                  â”‚  cloud-init   â”‚  â† æ ¸å¿ƒå¼•æ“              â”‚
â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚                          â”‚                                  â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚         â–¼                â–¼                â–¼                â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚   â”‚ é…ç½®ç½‘ç»œ  â”‚    â”‚ åˆ›å»ºç”¨æˆ·  â”‚    â”‚ æ‰§è¡Œè„šæœ¬  â”‚            â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 Datasourceï¼šæ•°æ®ä»å“ªæ¥ï¼Ÿ

cloud-init é€šè¿‡ **Datasource** è·å–é…ç½®æ•°æ®ï¼š

| äº‘å¹³å° | Datasource | å…ƒæ•°æ®åœ°å€ |
|--------|------------|------------|
| AWS EC2 | `Ec2` | `169.254.169.254` |
| GCP | `GCE` | `169.254.169.254` |
| Azure | `Azure` | `169.254.169.254` |
| OpenStack | `OpenStack` | `169.254.169.254` |
| æœ¬åœ°æµ‹è¯• | `NoCloud` | ISO/seed ç›®å½• |

```bash
# æŸ¥çœ‹å½“å‰ datasource
cloud-init query ds
```

### 1.3 é¦–æ¬¡å¯åŠ¨æ£€æµ‹ï¼šInstance-ID

cloud-init é€šè¿‡æ¯”å¯¹ **Instance-ID** åˆ¤æ–­æ˜¯å¦é¦–æ¬¡å¯åŠ¨ï¼š

```bash
# å½“å‰å®ä¾‹ ID
cloud-init query instance_id

# ä¿å­˜çš„å®ä¾‹ ID
cat /var/lib/cloud/data/instance-id
```

**é‡è¦**ï¼šå¦‚æœä¸¤è€…ä¸åŒï¼Œcloud-init ä¼šé‡æ–°æ‰§è¡Œé…ç½®ï¼ˆè¿™å°±æ˜¯ä¸ºä»€ä¹ˆ AMI éœ€è¦æ¸…ç† `/var/lib/cloud/`ï¼‰ã€‚

---

## Step 2 - å››ä¸ªå¯åŠ¨é˜¶æ®µï¼ˆ20 åˆ†é’Ÿï¼‰

### 2.1 é˜¶æ®µå…¨æ™¯å›¾

cloud-init åœ¨ systemd å¯åŠ¨æµç¨‹ä¸­è¢«è°ƒç”¨å››æ¬¡ï¼Œæ¯æ¬¡æ‰§è¡Œä¸åŒçš„ä»»åŠ¡ï¼š

<!-- DIAGRAM: cloud-init-four-stages -->
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    cloud-init å››é˜¶æ®µå¯åŠ¨æµç¨‹                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  Linux Kernel Boot                                                      â”‚
â”‚       â”‚                                                                 â”‚
â”‚       â–¼                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Stage 1: init-local (cloud-init-local.service)                  â”‚   â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚  â”‚ â”‚ â— æ— ç½‘ç»œé˜¶æ®µ                                                 â”‚ â”‚   â”‚
â”‚  â”‚ â”‚ â— ä»æœ¬åœ°æ•°æ®æºè¯»å–é…ç½®                                       â”‚ â”‚   â”‚
â”‚  â”‚ â”‚ â— æ‰§è¡Œ bootcmdï¼ˆç½‘ç»œé…ç½®å‰ï¼‰                                 â”‚ â”‚   â”‚
â”‚  â”‚ â”‚ â— å†™å…¥ç½‘ç»œé…ç½®æ–‡ä»¶                                           â”‚ â”‚   â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚       â”‚                                                                 â”‚
â”‚       â–¼                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Stage 2: init (cloud-init.service)                              â”‚   â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚  â”‚ â”‚ â— ç½‘ç»œå·²å°±ç»ª                                                 â”‚ â”‚   â”‚
â”‚  â”‚ â”‚ â— ä»å…ƒæ•°æ®æœåŠ¡è·å– user-data                                 â”‚ â”‚   â”‚
â”‚  â”‚ â”‚ â— è®¾ç½®ä¸»æœºåã€SSH å¯†é’¥                                       â”‚ â”‚   â”‚
â”‚  â”‚ â”‚ â— æ‰©å±•æ ¹æ–‡ä»¶ç³»ç»Ÿ                                             â”‚ â”‚   â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚       â”‚                                                                 â”‚
â”‚       â–¼                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Stage 3: config (cloud-config.service)                          â”‚   â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚  â”‚ â”‚ â— æ‰§è¡Œé…ç½®æ¨¡å—                                               â”‚ â”‚   â”‚
â”‚  â”‚ â”‚ â— write_filesã€packagesã€users                              â”‚ â”‚   â”‚
â”‚  â”‚ â”‚ â— æŒ‚è½½ç£ç›˜ã€é…ç½® NTP                                         â”‚ â”‚   â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚       â”‚                                                                 â”‚
â”‚       â–¼                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Stage 4: final (cloud-final.service)                            â”‚   â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚  â”‚ â”‚ â— æ‰€æœ‰ç³»ç»ŸæœåŠ¡å·²å¯åŠ¨                                         â”‚ â”‚   â”‚
â”‚  â”‚ â”‚ â— æ‰§è¡Œ runcmd                                                â”‚ â”‚   â”‚
â”‚  â”‚ â”‚ â— æ‰§è¡Œç”¨æˆ·è„šæœ¬ï¼ˆ#!/bin/bashï¼‰                                â”‚ â”‚   â”‚
â”‚  â”‚ â”‚ â— æ‰§è¡Œ final_message                                         â”‚ â”‚   â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚       â”‚                                                                 â”‚
â”‚       â–¼                                                                 â”‚
â”‚  System Ready (login prompt)                                            â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
<!-- /DIAGRAM -->

### 2.2 å„é˜¶æ®µè¯¦è§£

| é˜¶æ®µ | systemd æœåŠ¡ | ç½‘ç»œçŠ¶æ€ | ä¸»è¦ä»»åŠ¡ |
|------|--------------|----------|----------|
| **init-local** | `cloud-init-local.service` | æ— ç½‘ç»œ | bootcmdã€ç½‘ç»œé…ç½® |
| **init** | `cloud-init.service` | ç½‘ç»œå°±ç»ª | è·å– user-dataã€SSH å¯†é’¥ |
| **config** | `cloud-config.service` | ç½‘ç»œå°±ç»ª | write_filesã€packagesã€users |
| **final** | `cloud-final.service` | ç³»ç»Ÿå°±ç»ª | runcmdã€ç”¨æˆ·è„šæœ¬ |

### 2.3 åŠ¨æ‰‹éªŒè¯ï¼šè§‚å¯Ÿå››é˜¶æ®µ

```bash
# æŸ¥çœ‹å››ä¸ª systemd æœåŠ¡çš„çŠ¶æ€
systemctl status cloud-init-local cloud-init cloud-config cloud-final

# æŸ¥çœ‹å¯åŠ¨é¡ºåºå’Œè€—æ—¶
cloud-init analyze show

# æŸ¥çœ‹å„é˜¶æ®µæ—¥å¿—
journalctl -u cloud-init-local --no-pager | tail -20
journalctl -u cloud-init --no-pager | tail -20
journalctl -u cloud-config --no-pager | tail -20
journalctl -u cloud-final --no-pager | tail -20
```

### 2.4 bootcmd vs runcmdï¼šæ‰§è¡Œæ—¶æœºä¸åŒ

```yaml
#cloud-config
bootcmd:
  - echo "bootcmd: $(date)" >> /var/log/cloud-init-stages.log
  # åœ¨ init-local é˜¶æ®µæ‰§è¡Œï¼ˆæ— ç½‘ç»œï¼‰
  # æ¯æ¬¡å¯åŠ¨éƒ½æ‰§è¡Œ

runcmd:
  - echo "runcmd: $(date)" >> /var/log/cloud-init-stages.log
  # åœ¨ final é˜¶æ®µæ‰§è¡Œï¼ˆç³»ç»Ÿå°±ç»ªï¼‰
  # ä»…é¦–æ¬¡å¯åŠ¨æ‰§è¡Œ
```

**å…³é”®åŒºåˆ«**ï¼š
- `bootcmd`ï¼šæ¯æ¬¡å¯åŠ¨éƒ½æ‰§è¡Œï¼Œé€‚åˆç½‘ç»œé…ç½®å‰çš„æ“ä½œ
- `runcmd`ï¼šä»…é¦–æ¬¡å¯åŠ¨æ‰§è¡Œï¼Œé€‚åˆä¸€æ¬¡æ€§åˆå§‹åŒ–

---

## Step 3 - User-data ç±»å‹ï¼ˆ15 åˆ†é’Ÿï¼‰

### 3.1 ä¸‰ç§ User-data æ ¼å¼

cloud-init æ”¯æŒä¸‰ç§ user-data æ ¼å¼ï¼š

<!-- DIAGRAM: user-data-types -->
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      User-data ç±»å‹å¯¹æ¯”                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Type 1: Shell Script                                              â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚ è¯†åˆ«æ ‡å¿—: #!/bin/bash (æˆ–å…¶ä»– shebang)                            â”‚ â”‚
â”‚  â”‚ æ‰§è¡Œé˜¶æ®µ: final                                                   â”‚ â”‚
â”‚  â”‚ é€‚ç”¨åœºæ™¯: ç®€å•çš„ä¸€æ¬¡æ€§é…ç½®                                         â”‚ â”‚
â”‚  â”‚                                                                   â”‚ â”‚
â”‚  â”‚ #!/bin/bash                                                       â”‚ â”‚
â”‚  â”‚ yum install -y nginx                                              â”‚ â”‚
â”‚  â”‚ systemctl start nginx                                             â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Type 2: cloud-config YAML                                         â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚ è¯†åˆ«æ ‡å¿—: #cloud-config (å¿…é¡»åœ¨ç¬¬ä¸€è¡Œ)                            â”‚ â”‚
â”‚  â”‚ æ‰§è¡Œé˜¶æ®µ: å¤šé˜¶æ®µï¼ˆå–å†³äºæ¨¡å—ï¼‰                                    â”‚ â”‚
â”‚  â”‚ é€‚ç”¨åœºæ™¯: å£°æ˜å¼é…ç½®ã€å¤æ‚åœºæ™¯                                     â”‚ â”‚
â”‚  â”‚                                                                   â”‚ â”‚
â”‚  â”‚ #cloud-config                                                     â”‚ â”‚
â”‚  â”‚ packages:                                                         â”‚ â”‚
â”‚  â”‚   - nginx                                                         â”‚ â”‚
â”‚  â”‚ runcmd:                                                           â”‚ â”‚
â”‚  â”‚   - systemctl start nginx                                         â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Type 3: Multi-part MIME                                           â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚ è¯†åˆ«æ ‡å¿—: Content-Type: multipart/mixed                           â”‚ â”‚
â”‚  â”‚ æ‰§è¡Œé˜¶æ®µ: å–å†³äºå„éƒ¨åˆ†ç±»å‹                                        â”‚ â”‚
â”‚  â”‚ é€‚ç”¨åœºæ™¯: ç»„åˆå¤šç§é…ç½®ç±»å‹                                         â”‚ â”‚
â”‚  â”‚                                                                   â”‚ â”‚
â”‚  â”‚ MIME-Version: 1.0                                                 â”‚ â”‚
â”‚  â”‚ Content-Type: multipart/mixed; boundary="==BOUNDARY=="            â”‚ â”‚
â”‚  â”‚                                                                   â”‚ â”‚
â”‚  â”‚ --==BOUNDARY==                                                    â”‚ â”‚
â”‚  â”‚ Content-Type: text/cloud-config                                   â”‚ â”‚
â”‚  â”‚ packages: [nginx]                                                 â”‚ â”‚
â”‚  â”‚                                                                   â”‚ â”‚
â”‚  â”‚ --==BOUNDARY==                                                    â”‚ â”‚
â”‚  â”‚ Content-Type: text/x-shellscript                                  â”‚ â”‚
â”‚  â”‚ #!/bin/bash                                                       â”‚ â”‚
â”‚  â”‚ echo "Hello from script"                                          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
<!-- /DIAGRAM -->

### 3.2 ä»€ä¹ˆæ—¶å€™ç”¨å“ªç§ï¼Ÿ

| åœºæ™¯ | æ¨èæ ¼å¼ | åŸå›  |
|------|----------|------|
| ç®€å•è„šæœ¬ï¼ˆ< 20 è¡Œï¼‰ | Shell Script | ç›´æ¥ã€æ˜“è¯» |
| å®‰è£…åŒ…ã€åˆ›å»ºç”¨æˆ· | cloud-config | å£°æ˜å¼ã€å¹‚ç­‰ |
| å¤æ‚é…ç½® + è„šæœ¬ | Multi-part MIME | ç»„åˆä¸¤è€…ä¼˜ç‚¹ |
| ç”Ÿäº§ç¯å¢ƒ | cloud-config | æ›´æ˜“ç»´æŠ¤ã€æœ‰éªŒè¯ |

### 3.3 cloud-config ç¤ºä¾‹

```yaml
#cloud-config
# æ³¨æ„ï¼š#cloud-config å¿…é¡»åœ¨ç¬¬ä¸€è¡Œï¼

# å®‰è£…è½¯ä»¶åŒ…
packages:
  - nginx
  - htop
  - vim

# å†™å…¥æ–‡ä»¶
write_files:
  - path: /etc/motd
    content: |
      Welcome to Web Server
      Managed by cloud-init
    permissions: '0644'
    owner: root:root

# åˆ›å»ºç”¨æˆ·
users:
  - name: webadmin
    groups: wheel
    sudo: ALL=(ALL) NOPASSWD:ALL
    ssh_authorized_keys:
      - ssh-rsa AAAAB3... your-key-here

# æ‰§è¡Œå‘½ä»¤ï¼ˆfinal é˜¶æ®µï¼‰
runcmd:
  - systemctl enable nginx
  - systemctl start nginx
  - echo "cloud-init completed at $(date)" >> /var/log/cloud-init-done.log
```

---

## Step 4 - å¸¸ç”¨æ¨¡å—è¯¦è§£ï¼ˆ15 åˆ†é’Ÿï¼‰

### 4.1 æ ¸å¿ƒæ¨¡å—ä¸€è§ˆ

| æ¨¡å— | ç”¨é€” | æ‰§è¡Œé˜¶æ®µ |
|------|------|----------|
| `bootcmd` | ç½‘ç»œé…ç½®å‰æ‰§è¡Œå‘½ä»¤ | init-local |
| `write_files` | å†™å…¥æ–‡ä»¶ | config |
| `packages` | å®‰è£…è½¯ä»¶åŒ… | config |
| `users` | åˆ›å»ºç”¨æˆ·å’Œ SSH å¯†é’¥ | config |
| `runcmd` | æ‰§è¡Œå‘½ä»¤ | final |
| `final_message` | å¯åŠ¨å®Œæˆæ¶ˆæ¯ | final |

### 4.2 write_files è¯¦è§£

```yaml
#cloud-config
write_files:
  # åŸºæœ¬ç”¨æ³•
  - path: /etc/myapp/config.yml
    content: |
      server:
        port: 8080
        host: 0.0.0.0
    permissions: '0644'
    owner: root:root

  # è¿½åŠ æ¨¡å¼ï¼ˆä¸è¦†ç›–åŸæ–‡ä»¶ï¼‰
  - path: /etc/profile.d/custom.sh
    content: |
      export JAVA_HOME=/usr/lib/jvm/java-11
    append: true

  # Base64 ç¼–ç ï¼ˆç”¨äºäºŒè¿›åˆ¶æ–‡ä»¶ï¼‰
  - path: /usr/local/bin/tool
    encoding: base64
    content: <base64-encoded-content>
    permissions: '0755'
```

### 4.3 packages æ¨¡å—

```yaml
#cloud-config
# æ›´æ–°åŒ…ç´¢å¼•
package_update: true

# å‡çº§å·²å®‰è£…çš„åŒ…
package_upgrade: true

# å®‰è£…è½¯ä»¶åŒ…
packages:
  - nginx
  - postgresql
  - python3-pip
  # æŒ‡å®šç‰ˆæœ¬
  - docker-ce=5:24.0.0-1~ubuntu

# å®‰è£…åé‡å¯ï¼ˆå¦‚æœéœ€è¦ï¼‰
package_reboot_if_required: true
```

### 4.4 users æ¨¡å—

```yaml
#cloud-config
users:
  # ä¿ç•™é»˜è®¤ç”¨æˆ·ï¼ˆé‡è¦ï¼ï¼‰
  - default

  # åˆ›å»ºæ–°ç”¨æˆ·
  - name: deployer
    gecos: Deployment User
    groups: docker, wheel
    sudo: ALL=(ALL) NOPASSWD:ALL
    shell: /bin/bash
    ssh_authorized_keys:
      - ssh-rsa AAAAB3...
    lock_passwd: true  # ç¦æ­¢å¯†ç ç™»å½•
```

> **è­¦å‘Š**ï¼šå¦‚æœå¿˜è®° `- default`ï¼Œå¯èƒ½ä¼šè¦†ç›–é»˜è®¤ç”¨æˆ·ï¼ˆå¦‚ ec2-userï¼‰ï¼Œå¯¼è‡´æ— æ³• SSH ç™»å½•ï¼  

---

## Step 5 - è°ƒè¯• cloud-initï¼ˆ20 åˆ†é’Ÿï¼‰

### 5.1 æ—¥å¿—æ–‡ä»¶ä½ç½®

| æ—¥å¿—æ–‡ä»¶ | å†…å®¹ |
|----------|------|
| `/var/log/cloud-init.log` | è¯¦ç»†æ‰§è¡Œæ—¥å¿—ï¼ˆDEBUG çº§åˆ«ï¼‰ |
| `/var/log/cloud-init-output.log` | è„šæœ¬çš„æ ‡å‡†è¾“å‡º/é”™è¯¯ |
| `/run/cloud-init/result.json` | æ‰§è¡Œç»“æœ JSON |
| `/var/lib/cloud/instance/` | å®ä¾‹æ•°æ®ç¼“å­˜ |

### 5.2 å¸¸ç”¨è°ƒè¯•å‘½ä»¤

```bash
# æŸ¥çœ‹å½“å‰çŠ¶æ€
cloud-init status
cloud-init status --long  # è¯¦ç»†çŠ¶æ€

# æŸ¥çœ‹æ‰§è¡Œåˆ†æ
cloud-init analyze show
cloud-init analyze blame  # ç±»ä¼¼ systemd-analyze blame

# æŸ¥è¯¢å®ä¾‹æ•°æ®
cloud-init query --all
cloud-init query instance_id
cloud-init query userdata  # æŸ¥çœ‹ user-data

# éªŒè¯ cloud-config è¯­æ³•
cloud-init schema --config-file /path/to/config.yaml

# æŸ¥çœ‹æœ€è¿‘çš„é”™è¯¯
grep -i error /var/log/cloud-init.log | tail -20
grep -i error /var/log/cloud-init-output.log | tail -20
```

### 5.3 result.json è§£è¯»

```bash
cat /run/cloud-init/result.json
```

```json
{
  "v1": {
    "datasource": "DataSourceEc2Local",
    "errors": [],
    "recoverable_errors": {},
    "boot_id": "abc123...",
    "status": "done",
    "exception": null
  }
}
```

- `status: done` = æˆåŠŸå®Œæˆ
- `status: error` = æœ‰é”™è¯¯å‘ç”Ÿ
- `errors: [...]` = å…·ä½“é”™è¯¯ä¿¡æ¯

---

## Lab 1 - cloud-init é˜¶æ®µè§‚å¯Ÿå®éªŒï¼ˆ25 åˆ†é’Ÿï¼‰

### å®éªŒç›®æ ‡

åœ¨å››ä¸ªé˜¶æ®µåˆ†åˆ«å†™å…¥æ–‡ä»¶ï¼Œè§‚å¯Ÿæ‰§è¡Œé¡ºåºã€‚

### Step 1 - å‡†å¤‡ user-data

åˆ›å»ºä»¥ä¸‹ cloud-configï¼š

```yaml
#cloud-config

# Stage 1: bootcmd (init-local é˜¶æ®µ)
bootcmd:
  - echo "Stage 1 - bootcmd executed at $(date '+%H:%M:%S.%N')" >> /var/log/cloud-init-stages.log

# Stage 3: write_files (config é˜¶æ®µ)
write_files:
  - path: /var/log/cloud-init-stages.log
    content: |
      === cloud-init Stage Observation ===
    append: true
    permissions: '0644'

# Stage 3: packages (config é˜¶æ®µ)
packages:
  - htop

# Stage 4: runcmd (final é˜¶æ®µ)
runcmd:
  - echo "Stage 4 - runcmd executed at $(date '+%H:%M:%S.%N')" >> /var/log/cloud-init-stages.log
  - echo "--- Packages installed ---" >> /var/log/cloud-init-stages.log
  - rpm -q htop >> /var/log/cloud-init-stages.log || dpkg -l htop >> /var/log/cloud-init-stages.log

final_message: |
  cloud-init completed!
  Version: $version
  Datasource: $datasource
  Uptime: $uptime seconds
```

### Step 2 - å¯åŠ¨å®ä¾‹

ä½¿ç”¨ AWS CLI å¯åŠ¨ï¼š

```bash
# å°† user-data ä¿å­˜ä¸ºæ–‡ä»¶
cat > stage-test-userdata.yaml << 'EOF'
#cloud-config
bootcmd:
  - echo "Stage 1 - bootcmd executed at $(date '+%H:%M:%S.%N')" >> /var/log/cloud-init-stages.log
write_files:
  - path: /var/log/cloud-init-stages.log
    content: |
      === cloud-init Stage Observation ===
    append: true
    permissions: '0644'
packages:
  - htop
runcmd:
  - echo "Stage 4 - runcmd executed at $(date '+%H:%M:%S.%N')" >> /var/log/cloud-init-stages.log
  - echo "--- Packages installed ---" >> /var/log/cloud-init-stages.log
  - rpm -q htop >> /var/log/cloud-init-stages.log 2>/dev/null || dpkg -l htop >> /var/log/cloud-init-stages.log 2>/dev/null
final_message: |
  cloud-init completed!
  Uptime: $uptime seconds
EOF

# å¯åŠ¨å®ä¾‹ï¼ˆæ›¿æ¢ subnet-idã€security-group-idã€key-nameï¼‰
aws ec2 run-instances \
  --image-id resolve:ssm:/aws/service/ami-amazon-linux-latest/al2023-ami-kernel-default-x86_64 \
  --instance-type t3.micro \
  --key-name YOUR_KEY_NAME \
  --subnet-id subnet-xxxxxxxx \
  --security-group-ids sg-xxxxxxxx \
  --user-data file://stage-test-userdata.yaml \
  --tag-specifications 'ResourceType=instance,Tags=[{Key=Name,Value=cloud-init-stage-test}]'
```

### Step 3 - éªŒè¯ç»“æœ

SSH è¿›å…¥å®ä¾‹åï¼š

```bash
# æŸ¥çœ‹é˜¶æ®µæ‰§è¡Œæ—¥å¿—
cat /var/log/cloud-init-stages.log

# æŸ¥çœ‹æ‰§è¡Œæ—¶é—´åˆ†æ
cloud-init analyze show

# éªŒè¯ htop å·²å®‰è£…
which htop
```

**é¢„æœŸè¾“å‡º**ï¼š

```
=== cloud-init Stage Observation ===
Stage 1 - bootcmd executed at 10:15:23.456789
Stage 4 - runcmd executed at 10:15:45.123456
--- Packages installed ---
htop-3.2.1-1.amzn2023.x86_64
```

### æ£€æŸ¥æ¸…å•

- [ ] è§‚å¯Ÿåˆ° bootcmd å…ˆäº runcmd æ‰§è¡Œ
- [ ] ç†è§£ write_files åœ¨ config é˜¶æ®µæ‰§è¡Œ
- [ ] htop å·²æˆåŠŸå®‰è£…
- [ ] èƒ½è§£é‡Šå››ä¸ªé˜¶æ®µçš„é¡ºåº

---

## Lab 2 - The Silent Bootï¼ˆæ²‰é»˜å¯åŠ¨ï¼‰åœºæ™¯ï¼ˆ30 åˆ†é’Ÿï¼‰

### åœºæ™¯æè¿°

> å®ä¾‹çŠ¶æ€æ˜¾ç¤º "Running"ï¼Œä½† Web æœåŠ¡å™¨æ²¡æœ‰å¯åŠ¨ï¼ŒSSH æ— æ³•è¿æ¥ã€‚  
> æ§åˆ¶å°ç³»ç»Ÿæ—¥å¿—è¢«æˆªæ–­ã€‚å·¥ç¨‹å¸ˆéœ€è¦è¯Šæ–­ user-data å¤±è´¥åŸå› ã€‚  

è¿™æ˜¯æ—¥æœ¬ IT ç°åœºæœ€å¸¸è§çš„**éšœå®³å¯¾å¿œ**åœºæ™¯ä¹‹ä¸€ã€‚

### å®éªŒç›®æ ‡

æ•…æ„åˆ¶é€  user-data å¤±è´¥ï¼Œå­¦ä¹ è¯Šæ–­æ–¹æ³•ã€‚

### Step 1 - åˆ¶é€ é—®é¢˜

åˆ›å»ºä¸€ä¸ªæœ‰é—®é¢˜çš„ user-dataï¼š

```yaml
#cloud-config
packages:
  - nginx

runcmd:
  # é—®é¢˜ 1: apt-get æ²¡æœ‰ -y å‚æ•°ï¼Œä¼šç­‰å¾…ç”¨æˆ·è¾“å…¥
  - apt-get install vim

  # é—®é¢˜ 2: YAML ç¼©è¿›é”™è¯¯ï¼ˆä¸‹é¢çš„è¡Œç¼©è¿›ä¸ä¸€è‡´ï¼‰
  -  echo "This has wrong indentation"

  # é—®é¢˜ 3: å‡è®¾çš„ç½‘ç»œæœåŠ¡ä¸å­˜åœ¨
  - systemctl start nonexistent-service
```

### Step 2 - å¯åŠ¨å®ä¾‹å¹¶è§‚å¯Ÿ

```bash
# ä½¿ç”¨æœ‰é—®é¢˜çš„ user-data å¯åŠ¨å®ä¾‹
aws ec2 run-instances \
  --image-id resolve:ssm:/aws/service/ami-amazon-linux-latest/al2023-ami-kernel-default-x86_64 \
  --instance-type t3.micro \
  --key-name YOUR_KEY_NAME \
  --subnet-id subnet-xxxxxxxx \
  --security-group-ids sg-xxxxxxxx \
  --user-data file://broken-userdata.yaml \
  --tag-specifications 'ResourceType=instance,Tags=[{Key=Name,Value=silent-boot-test}]'
```

ç­‰å¾…å®ä¾‹çŠ¶æ€å˜ä¸º "Running"ï¼Œç„¶åï¼š

```bash
# è·å–ç³»ç»Ÿæ—¥å¿—ï¼ˆæ§åˆ¶å°è¾“å‡ºï¼‰
aws ec2 get-console-output --instance-id i-xxxxxxxxx --output text
```

### Step 3 - è¯Šæ–­æµç¨‹

SSH è¿›å…¥å®ä¾‹åï¼ˆå¦‚æœèƒ½è¿æ¥ï¼‰ï¼š

```bash
# 1. æ£€æŸ¥ cloud-init çŠ¶æ€
cloud-init status --long

# 2. æŸ¥çœ‹æ‰§è¡Œç»“æœ
cat /run/cloud-init/result.json | python3 -m json.tool

# 3. æŸ¥æ‰¾é”™è¯¯
grep -i -E "(error|failed|warning)" /var/log/cloud-init.log | tail -30

# 4. æŸ¥çœ‹è„šæœ¬è¾“å‡º
cat /var/log/cloud-init-output.log | tail -50

# 5. éªŒè¯ user-data æ˜¯å¦æ­£ç¡®è§£æ
cloud-init query userdata
```

### Step 4 - å¸¸è§é”™è¯¯åŠè§£å†³æ–¹æ¡ˆ

| é”™è¯¯ç±»å‹ | ç—‡çŠ¶ | è§£å†³æ–¹æ¡ˆ |
|----------|------|----------|
| YAML è¯­æ³•é”™è¯¯ | cloud-init å®Œå…¨ä¸æ‰§è¡Œ | ç”¨ `cloud-init schema --config-file` éªŒè¯ |
| äº¤äº’å¼å‘½ä»¤ | è„šæœ¬æŒ‚èµ·ï¼Œå®ä¾‹å¡ä½ | ä½¿ç”¨ `-y` å‚æ•°ï¼Œè®¾ç½® `DEBIAN_FRONTEND=noninteractive` |
| æœåŠ¡ä¸å­˜åœ¨ | è„šæœ¬éƒ¨åˆ†æ‰§è¡Œ | æ·»åŠ é”™è¯¯å¤„ç†ï¼Œä½¿ç”¨ `|| true` |
| ç½‘ç»œä¾èµ– | åœ¨ç½‘ç»œå°±ç»ªå‰æ‰§è¡Œå¤±è´¥ | ä½¿ç”¨ runcmd è€Œé bootcmd |

### Step 5 - ä¿®å¤åçš„ user-data

```yaml
#cloud-config

# é˜²æ­¢äº¤äº’å¼æç¤º
package_update: true

packages:
  - nginx
  - vim

runcmd:
  # æ­£ç¡®ï¼šä½¿ç”¨ -y å‚æ•°
  - DEBIAN_FRONTEND=noninteractive apt-get install -y htop || yum install -y htop

  # æ­£ç¡®ï¼šä¸€è‡´çš„ç¼©è¿›
  - echo "This has correct indentation"

  # æ­£ç¡®ï¼šæ·»åŠ é”™è¯¯å¤„ç†
  - systemctl start nginx || echo "nginx start failed but continuing"

  # è®°å½•å®ŒæˆçŠ¶æ€
  - echo "cloud-init user-data completed successfully at $(date)" >> /var/log/cloud-init-done.log
```

### æ£€æŸ¥æ¸…å•

- [ ] èƒ½å¤Ÿä»æ§åˆ¶å°æ—¥å¿—è¯†åˆ« cloud-init å¤±è´¥
- [ ] çŸ¥é“å¦‚ä½•ä½¿ç”¨ `cloud-init status --long` æ£€æŸ¥çŠ¶æ€
- [ ] ç†è§£ `/var/log/cloud-init.log` å’Œ `/var/log/cloud-init-output.log` çš„åŒºåˆ«
- [ ] èƒ½ä¿®å¤äº¤äº’å¼å‘½ä»¤å’Œ YAML è¯­æ³•é”™è¯¯

---

## Lab 3 - å¹‚ç­‰è„šæœ¬ç»ƒä¹ ï¼ˆ20 åˆ†é’Ÿï¼‰

### ä¸ºä»€ä¹ˆå¹‚ç­‰æ€§é‡è¦ï¼Ÿ

åœ¨ Auto Scaling Group (ASG) ç¯å¢ƒä¸­ï¼Œå®ä¾‹å¯èƒ½éšæ—¶è¢«æ›¿æ¢ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ASG æ‰©å®¹åœºæ™¯                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  æµé‡å¢åŠ  â†’ ASG å¯åŠ¨æ–°å®ä¾‹ â†’ cloud-init æ‰§è¡Œ user-data      â”‚
â”‚                                                             â”‚
â”‚  é—®é¢˜ï¼šå¦‚æœ user-data ä¸å¹‚ç­‰                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚ å®ä¾‹ 1   â”‚     â”‚ å®ä¾‹ 2   â”‚     â”‚ å®ä¾‹ 3   â”‚              â”‚
â”‚  â”‚ é…ç½® OK  â”‚     â”‚ é…ç½®å¤±è´¥  â”‚     â”‚ é…ç½® OK  â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚       âœ“              âœ—              âœ“                      â”‚
â”‚                      â”‚                                      â”‚
â”‚                      â–¼                                      â”‚
â”‚                 å¥åº·æ£€æŸ¥å¤±è´¥                                 â”‚
â”‚                 å®ä¾‹è¢«æ›¿æ¢                                   â”‚
â”‚                 æ— é™å¾ªç¯...                                  â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å¹‚ç­‰è„šæœ¬è®¾è®¡åŸåˆ™

```bash
#!/bin/bash
# å¹‚ç­‰è„šæœ¬æ¨¡æ¿

# åŸåˆ™ 1: æ£€æŸ¥åå†æ‰§è¡Œ
if [ ! -f /etc/myapp/config.yml ]; then
    echo "Creating config file..."
    mkdir -p /etc/myapp
    cat > /etc/myapp/config.yml << 'CONFIG'
server:
  port: 8080
CONFIG
else
    echo "Config file already exists, skipping..."
fi

# åŸåˆ™ 2: ä½¿ç”¨å¹‚ç­‰å‘½ä»¤
# ä¸å¥½ï¼šappend æ¯æ¬¡éƒ½è¿½åŠ 
# echo "export PATH=..." >> /etc/profile

# å¥½ï¼šä½¿ç”¨ grep æ£€æŸ¥
if ! grep -q 'JAVA_HOME' /etc/profile; then
    echo 'export JAVA_HOME=/usr/lib/jvm/java-11' >> /etc/profile
fi

# åŸåˆ™ 3: ä½¿ç”¨å®ˆå«æ–‡ä»¶ï¼ˆguard fileï¼‰
GUARD_FILE=/var/lib/cloud/scripts/init-done

if [ -f "$GUARD_FILE" ]; then
    echo "Initialization already completed, skipping..."
    exit 0
fi

# ... æ‰§è¡Œåˆå§‹åŒ–ä»»åŠ¡ ...

# æ ‡è®°å®Œæˆ
touch "$GUARD_FILE"
echo "Initialization completed successfully"
```

### å®éªŒï¼šå¯¹æ¯”å¹‚ç­‰ä¸éå¹‚ç­‰è„šæœ¬

åˆ›å»ºä¸¤ä¸ªæµ‹è¯•è„šæœ¬ï¼š

**éå¹‚ç­‰è„šæœ¬ï¼ˆé—®é¢˜ç‰ˆæœ¬ï¼‰**:

```bash
#!/bin/bash
# BAD: éå¹‚ç­‰è„šæœ¬

# æ¯æ¬¡æ‰§è¡Œéƒ½ä¼šè¿½åŠ 
echo "127.0.0.1 myapp.local" >> /etc/hosts

# æ¯æ¬¡æ‰§è¡Œéƒ½ä¼šåˆ›å»ºç”¨æˆ·ï¼ˆç¬¬äºŒæ¬¡ä¼šæŠ¥é”™ï¼‰
useradd appuser

# æ²¡æœ‰æ£€æŸ¥å°±å¯åŠ¨ï¼ˆå¯èƒ½å·²ç»è¿è¡Œï¼‰
systemctl start nginx
```

**å¹‚ç­‰è„šæœ¬ï¼ˆæ­£ç¡®ç‰ˆæœ¬ï¼‰**:

```bash
#!/bin/bash
# GOOD: å¹‚ç­‰è„šæœ¬

# æ£€æŸ¥åå†è¿½åŠ 
if ! grep -q 'myapp.local' /etc/hosts; then
    echo "127.0.0.1 myapp.local" >> /etc/hosts
fi

# æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨
if ! id appuser &>/dev/null; then
    useradd appuser
fi

# ä½¿ç”¨å¹‚ç­‰å‘½ä»¤
systemctl enable nginx  # enable æ˜¯å¹‚ç­‰çš„
systemctl start nginx   # start å¯¹å·²è¿è¡Œçš„æœåŠ¡æ˜¯å®‰å…¨çš„
```

### æ£€æŸ¥æ¸…å•

- [ ] ç†è§£ä¸ºä»€ä¹ˆ ASG åœºæ™¯éœ€è¦å¹‚ç­‰è„šæœ¬
- [ ] æŒæ¡ä¸‰ç§å¹‚ç­‰æŠ€æœ¯ï¼šæ¡ä»¶æ£€æŸ¥ã€grep å®ˆå«ã€å®ˆå«æ–‡ä»¶
- [ ] èƒ½å°†éå¹‚ç­‰è„šæœ¬æ”¹å†™ä¸ºå¹‚ç­‰ç‰ˆæœ¬

---

## åæ¨¡å¼æ¼”ç¤º

### åæ¨¡å¼ 1ï¼šéå¹‚ç­‰è„šæœ¬

```bash
# é”™è¯¯ï¼šæ¯æ¬¡å¯åŠ¨éƒ½è¿½åŠ ï¼Œ/etc/hosts ä¼šè¶Šæ¥è¶Šé•¿
echo "10.0.0.1 db.internal" >> /etc/hosts
echo "10.0.0.2 cache.internal" >> /etc/hosts
```

**åæœ**ï¼šé‡å¯å¤šæ¬¡åï¼Œ/etc/hosts å……æ»¡é‡å¤æ¡ç›®ã€‚

**ä¿®å¤**ï¼š

```bash
# ä½¿ç”¨ grep æ£€æŸ¥
grep -q 'db.internal' /etc/hosts || echo "10.0.0.1 db.internal" >> /etc/hosts
```

### åæ¨¡å¼ 2ï¼šäº¤äº’å¼å‘½ä»¤é˜»å¡å¯åŠ¨

```bash
# é”™è¯¯ï¼šapt-get å¯èƒ½æç¤ºç¡®è®¤
apt-get install nginx

# é”™è¯¯ï¼šyum åœ¨æŸäº›æƒ…å†µä¸‹ä¹Ÿä¼šæç¤º
yum install httpd
```

**åæœ**ï¼šå®ä¾‹å¯åŠ¨åå¡åœ¨ cloud-initï¼Œçœ‹èµ·æ¥"æ²‰é»˜"ï¼ŒSSH å¯èƒ½æ— æ³•è¿æ¥ã€‚

**ä¿®å¤**ï¼š

```bash
# Debian/Ubuntu
export DEBIAN_FRONTEND=noninteractive
apt-get install -y nginx

# RHEL/Amazon Linux
yum install -y nginx

# æˆ–è€…ä½¿ç”¨ cloud-config çš„ packages æ¨¡å—ï¼ˆè‡ªåŠ¨éäº¤äº’ï¼‰
```

### åæ¨¡å¼ 3ï¼šè¿‡é•¿å¯åŠ¨è„šæœ¬å¯¼è‡´è¶…æ—¶

```bash
# é”™è¯¯ï¼šåœ¨ user-data ä¸­ç¼–è¯‘è½¯ä»¶
#!/bin/bash
yum install -y gcc make
wget https://example.com/large-source.tar.gz
tar xzf large-source.tar.gz
cd large-source
./configure && make && make install  # å¯èƒ½éœ€è¦ 30+ åˆ†é’Ÿ
```

**åæœ**ï¼š
- ASG å¥åº·æ£€æŸ¥è¶…æ—¶
- å®ä¾‹è¢«æ ‡è®°ä¸ºä¸å¥åº·å¹¶æ›¿æ¢
- æ— é™å¾ªç¯

**ä¿®å¤**ï¼šå°†è€—æ—¶æ“ä½œç§»åˆ° AMI æ„å»ºé˜¶æ®µï¼ˆBake vs Bootstrapï¼‰ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Bake vs Bootstrap ç­–ç•¥                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  Bake (çƒ˜ç„™åˆ° AMI)          Bootstrap (å¯åŠ¨æ—¶å®‰è£…)           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚ â— æ“ä½œç³»ç»Ÿ        â”‚        â”‚ â— é…ç½®æ–‡ä»¶        â”‚            â”‚
â”‚  â”‚ â— ä¾èµ–åŒ…          â”‚        â”‚ â— ç¯å¢ƒå˜é‡        â”‚            â”‚
â”‚  â”‚ â— ç¼–è¯‘å¥½çš„è½¯ä»¶    â”‚        â”‚ â— å¯†é’¥/è¯ä¹¦       â”‚            â”‚
â”‚  â”‚ â— åŸºç¡€é…ç½®        â”‚        â”‚ â— åŠ¨æ€å‚æ•°        â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚         â”‚                          â”‚                        â”‚
â”‚         â–¼                          â–¼                        â”‚
â”‚    å¯åŠ¨æ—¶é—´ï¼š30 ç§’             å¯åŠ¨æ—¶é—´ï¼š5 åˆ†é’Ÿ              â”‚
â”‚    ASG å‹å¥½ âœ“                  å¯èƒ½è¶…æ—¶ âœ—                   â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## èŒåœºå°è´´å£«ï¼ˆJapan IT Contextï¼‰

### éšœå®³å¯¾å¿œï¼šå¯åŠ¨å¤±è´¥çš„æ ¹å› åˆ†æ

åœ¨æ—¥æœ¬ IT ä¼ä¸šï¼Œå½“å®ä¾‹å¯åŠ¨å¤±è´¥æ—¶ï¼Œå·¥ç¨‹å¸ˆéœ€è¦æä¾›**åŸå› ç©¶æ˜**ï¼ˆæ ¹å› åˆ†æï¼‰æŠ¥å‘Šï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              cloud-init éšœå®³å¯¾å¿œãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  1. åˆæœŸç¢ºèª (Initial Check)                                â”‚
â”‚     â–¡ EC2 ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹çŠ¶æ…‹: Running?                         â”‚
â”‚     â–¡ cloud-init status: done / error / running?           â”‚
â”‚     â–¡ /run/cloud-init/result.json ã«ã‚¨ãƒ©ãƒ¼ã‚ã‚Š?            â”‚
â”‚                                                             â”‚
â”‚  2. ãƒ­ã‚°åˆ†æ (Log Analysis)                                  â”‚
â”‚     â–¡ /var/log/cloud-init.log ã§ã‚¨ãƒ©ãƒ¼æ¤œç´¢                  â”‚
â”‚     â–¡ /var/log/cloud-init-output.log ã§å‡ºåŠ›ç¢ºèª             â”‚
â”‚     â–¡ dmesg ã§ã‚«ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼ç¢ºèª                            â”‚
â”‚                                                             â”‚
â”‚  3. user-data ç¢ºèª                                          â”‚
â”‚     â–¡ cloud-init query userdata ã§å†…å®¹ç¢ºèª                  â”‚
â”‚     â–¡ YAML æ§‹æ–‡ã‚¨ãƒ©ãƒ¼?                                       â”‚
â”‚     â–¡ å¯¾è©±å¼ã‚³ãƒãƒ³ãƒ‰ (-y ã‚ªãƒ—ã‚·ãƒ§ãƒ³å¿˜ã‚Œ)?                   â”‚
â”‚                                                             â”‚
â”‚  4. å ±å‘Šæ›¸ä½œæˆ                                               â”‚
â”‚     â–¡ ç™ºç”Ÿæ™‚åˆ»                                               â”‚
â”‚     â–¡ å½±éŸ¿ç¯„å›²                                               â”‚
â”‚     â–¡ åŸå›                                                    â”‚
â”‚     â–¡ å¯¾ç­–                                                   â”‚
â”‚     â–¡ å†ç™ºé˜²æ­¢ç­–                                             â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ—¥æœ¬ IT æœ¯è¯­å¯¹ç…§

| æ—¥è¯­æœ¯è¯­ | è¯»éŸ³ | å«ä¹‰ | cloud-init ç›¸å…³ |
|----------|------|------|-----------------|
| éšœå®³å¯¾å¿œ | ã—ã‚‡ã†ãŒã„ãŸã„ãŠã† | æ•…éšœå¤„ç† | è¯Šæ–­ cloud-init å¤±è´¥ |
| åŸå› ç©¶æ˜ | ã’ã‚“ã„ã‚“ãã‚…ã†ã‚ã„ | æ ¹å› åˆ†æ | åˆ†ææ—¥å¿—ã€user-data |
| åˆæœŸæ§‹ç¯‰ | ã—ã‚‡ãã“ã†ã¡ã | åˆå§‹é…ç½® | user-data è®¾è®¡ |
| è‡ªå‹•åŒ– | ã˜ã©ã†ã‹ | è‡ªåŠ¨åŒ– | å¹‚ç­‰è„šæœ¬ |
| å†ªç­‰æ€§ | ã¹ãã¨ã†ã›ã„ | å¹‚ç­‰æ€§ | å¯é‡å¤æ‰§è¡Œçš„è„šæœ¬ |

### å˜æ›´ç®¡ç†ï¼šuser-data ç‰ˆæœ¬æ§åˆ¶

æ—¥æœ¬ä¼ä¸šé€šå¸¸è¦æ±‚**å¤‰æ›´ç®¡ç†**ï¼ˆå˜æ›´ç®¡ç†ï¼‰ï¼š

```bash
# åœ¨ user-data ä¸­è®°å½•ç‰ˆæœ¬
#cloud-config

# ç‰ˆæœ¬æ ‡è¯†ï¼ˆä¾¿äºå®¡è®¡ï¼‰
# Version: 1.2.3
# Author: yamada@example.com
# Date: 2025-01-10
# Change: Added nginx configuration

write_files:
  - path: /etc/cloud-init-version
    content: |
      version: 1.2.3
      deployed: $(date -Iseconds)
```

---

## æ£€æŸ¥æ¸…å•

å®Œæˆæœ¬è¯¾åï¼Œä½ åº”è¯¥èƒ½å¤Ÿï¼š

- [ ] è§£é‡Š cloud-init å››ä¸ªå¯åŠ¨é˜¶æ®µçš„é¡ºåºå’ŒèŒè´£
- [ ] åŒºåˆ† bootcmd å’Œ runcmd çš„æ‰§è¡Œæ—¶æœº
- [ ] ç¼–å†™ shell è„šæœ¬å’Œ cloud-config YAML ä¸¤ç§ user-data
- [ ] ä½¿ç”¨ `cloud-init status`ã€`cloud-init analyze show` è¯Šæ–­é—®é¢˜
- [ ] è§£è¯» `/var/log/cloud-init.log` å’Œ `/var/log/cloud-init-output.log`
- [ ] ç¼–å†™å¹‚ç­‰çš„åˆå§‹åŒ–è„šæœ¬
- [ ] è¯†åˆ«å¹¶ä¿®å¤å¸¸è§çš„ cloud-init åæ¨¡å¼
- [ ] è§£é‡Š Bake vs Bootstrap ç­–ç•¥çš„æƒè¡¡

---

## æœ¬è¯¾å°ç»“

| æ¦‚å¿µ | è¦ç‚¹ |
|------|------|
| å››é˜¶æ®µ | init-local â†’ init â†’ config â†’ final |
| User-data ç±»å‹ | Shell è„šæœ¬ã€cloud-config YAMLã€Multi-part MIME |
| å…³é”®æ¨¡å— | bootcmdï¼ˆæ¯æ¬¡ï¼‰ã€runcmdï¼ˆé¦–æ¬¡ï¼‰ã€write_filesã€packages |
| è°ƒè¯•å·¥å…· | `cloud-init status`ã€`cloud-init analyze`ã€æ—¥å¿—æ–‡ä»¶ |
| å¹‚ç­‰æ€§ | æ¡ä»¶æ£€æŸ¥ã€grep å®ˆå«ã€å®ˆå«æ–‡ä»¶ |
| Bake vs Bootstrap | è€—æ—¶æ“ä½œæ”¾ AMIï¼Œé…ç½®æ”¾ user-data |

---

## å»¶ä¼¸é˜…è¯»

- [cloud-init å®˜æ–¹æ–‡æ¡£](https://cloudinit.readthedocs.io/)
- [AWS EC2 User Data æœ€ä½³å®è·µ](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/user-data.html)
- ä¸‹ä¸€è¯¾ï¼š[03 - å…ƒæ•°æ®æœåŠ¡ä¸ IMDSv2](../03-metadata/) - å­¦ä¹ å®‰å…¨è®¿é—®å®ä¾‹å…ƒæ•°æ®
- ç›¸å…³è¯¾ç¨‹ï¼š[LX05 - systemd æœåŠ¡ç®¡ç†](../../lx05-systemd/) - ç†è§£ cloud-init å¦‚ä½•ä¸ systemd é›†æˆ

---

## æ¸…ç†èµ„æº

å®éªŒå®Œæˆåï¼Œè®°å¾—æ¸…ç†åˆ›å»ºçš„èµ„æºï¼š

```bash
# ç»ˆæ­¢æµ‹è¯•å®ä¾‹
aws ec2 terminate-instances --instance-ids i-xxxxxxxxx

# ç¡®è®¤å®ä¾‹å·²ç»ˆæ­¢
aws ec2 describe-instances --instance-ids i-xxxxxxxxx \
  --query 'Reservations[].Instances[].State.Name'
```

> **è´¹ç”¨æé†’**ï¼št3.micro å®ä¾‹æ¯å°æ—¶çº¦ $0.0104ï¼ˆus-east-1ï¼‰ã€‚åŠæ—¶æ¸…ç†é¿å…ä¸å¿…è¦çš„è´¹ç”¨ã€‚  

---

## ç³»åˆ—å¯¼èˆª

[â† 01 - äº‘ä¸­ Linux æœ‰ä½•ä¸åŒ](../01-cloud-context/) | [ç³»åˆ—é¦–é¡µ](../) | [03 - å…ƒæ•°æ®æœåŠ¡ä¸ IMDSv2 â†’](../03-metadata/)
