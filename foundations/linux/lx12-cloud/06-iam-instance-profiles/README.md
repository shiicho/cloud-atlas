# 06 - IAM ä¸Žå®žä¾‹é…ç½®æ–‡ä»¶ï¼ˆIAM & Instance Profilesï¼‰

> **ç›®æ ‡**ï¼šç†è§£å®žä¾‹é…ç½®æ–‡ä»¶å¦‚ä½•æä¾›å‡­è¯ï¼ŒæŽŒæ¡ AWS å‡­è¯é“¾å’Œæœ€å°æƒé™åŽŸåˆ™  
> **å‰ç½®**ï¼š[03 - å…ƒæ•°æ®æœåŠ¡ä¸Ž IMDSv2](../03-metadata/)ã€[05 - äº‘å­˜å‚¨](../05-cloud-storage/)  
> **æ—¶é—´**ï¼šâš¡ 30 åˆ†é’Ÿï¼ˆé€Ÿè¯»ï¼‰/ ðŸ”¬ 120 åˆ†é’Ÿï¼ˆå®Œæ•´å®žæ“ï¼‰  
> **å®žæˆ˜åœºæ™¯**ï¼šè°ƒè¯•å‡­è¯é“¾é—®é¢˜ã€å®žçŽ°æœ€å°æƒé™ S3 è®¿é—®  

---

## å°†å­¦åˆ°çš„å†…å®¹

1. ç†è§£å®žä¾‹é…ç½®æ–‡ä»¶ï¼ˆInstance Profileï¼‰å¦‚ä½•ä¸º EC2 æä¾›å‡­è¯
2. æŽŒæ¡ AWS å‡­è¯é“¾ï¼ˆCredential Chainï¼‰çš„æŸ¥æ‰¾é¡ºåº
3. è°ƒè¯•å‡­è¯ç›¸å…³é—®é¢˜ï¼ˆ`aws sts get-caller-identity` æ˜¯ä½ çš„å¥½æœ‹å‹ï¼‰
4. åº”ç”¨æœ€å°æƒé™åŽŸåˆ™è®¾è®¡ IAM ç­–ç•¥
5. ç†è§£ AssumeRole è·¨è´¦æˆ·è®¿é—®æ¨¡å¼

---

## å…ˆè·‘èµ·æ¥ï¼ï¼ˆ10 åˆ†é’Ÿï¼‰

> åœ¨å­¦ä¹  IAM ç†è®ºä¹‹å‰ï¼Œå…ˆç”¨ä¸€ä¸ªå‘½ä»¤æŽ¢ç´¢ä½ çš„äº‘å®žä¾‹èº«ä»½ã€‚  

åœ¨ä»»æ„ EC2 å®žä¾‹ä¸Šè¿è¡Œï¼š

### æŽ¢ç´¢å®žä¾‹èº«ä»½

```bash
# æœ€é‡è¦çš„ AWS è°ƒè¯•å‘½ä»¤ï¼šæˆ‘æ˜¯è°ï¼Ÿ
aws sts get-caller-identity
```

```json
{
    "UserId": "AROAXXXXXXXXXXXXXXXXX:i-0abc123def456789",
    "Account": "123456789012",
    "Arn": "arn:aws:sts::123456789012:assumed-role/MyEC2Role/i-0abc123def456789"
}
```

**ä½ åˆšåˆšçœ‹åˆ°äº†ä¸‰ä¸ªå…³é”®ä¿¡æ¯**ï¼š

| å­—æ®µ | å«ä¹‰ | ç¤ºä¾‹ |
|------|------|------|
| `UserId` | è§’è‰² ID + å®žä¾‹ ID | `AROA...` è¡¨ç¤ºæ˜¯ AssumedRole |
| `Account` | AWS è´¦æˆ· ID | ç”¨äºŽç¡®è®¤è´¦æˆ· |
| `Arn` | å®Œæ•´çš„èº«ä»½ ARN | `assumed-role/MyEC2Role/...` è¯´æ˜Žä½¿ç”¨äº† EC2 è§’è‰² |

### æŽ¢ç´¢å‡­è¯æ¥æº

```bash
# å‡­è¯ä»Žå“ªé‡Œæ¥ï¼Ÿ
curl -s -X PUT "http://169.254.169.254/latest/api/token" \
  -H "X-aws-ec2-metadata-token-ttl-seconds: 21600" > /tmp/imds-token

TOKEN=$(cat /tmp/imds-token)

# èŽ·å–è§’è‰²å
ROLE=$(curl -s -H "X-aws-ec2-metadata-token: $TOKEN" \
  http://169.254.169.254/latest/meta-data/iam/security-credentials/)

echo "IAM Role: $ROLE"

# æŸ¥çœ‹å‡­è¯ç»“æž„ï¼ˆä¸æ˜¾ç¤ºå®Œæ•´å¯†é’¥ï¼‰
curl -s -H "X-aws-ec2-metadata-token: $TOKEN" \
  http://169.254.169.254/latest/meta-data/iam/security-credentials/$ROLE | \
  python3 -c "import sys,json; d=json.load(sys.stdin); print(f'AccessKeyId: {d[\"AccessKeyId\"][:10]}...\nExpiration: {d[\"Expiration\"]}')"
```

```
IAM Role: MyEC2Role
AccessKeyId: ASIAXXX...
Expiration: 2025-01-10T16:30:00Z
```

**å…³é”®å‘çŽ°**ï¼š
- å‡­è¯ä»¥ `ASIA` å¼€å¤´ï¼ˆä¸´æ—¶å‡­è¯ï¼Œä¸æ˜¯æ°¸ä¹…å¯†é’¥ `AKIA`ï¼‰
- å‡­è¯æœ‰è¿‡æœŸæ—¶é—´ï¼ˆé€šå¸¸ 6 å°æ—¶ï¼‰
- å‡­è¯é€šè¿‡å…ƒæ•°æ®æœåŠ¡è‡ªåŠ¨æä¾›

---

**ä½ åˆšåˆšä½“éªŒäº† EC2 å®žä¾‹èŽ·å– AWS å‡­è¯çš„æ ¸å¿ƒæœºåˆ¶ã€‚** æ²¡æœ‰ç¡¬ç¼–ç çš„ Access Keyï¼Œæ²¡æœ‰é…ç½®æ–‡ä»¶ï¼Œå‡­è¯è‡ªåŠ¨è½®æ¢ã€‚è¿™å°±æ˜¯äº‘åŽŸç”Ÿçš„å‡­è¯ç®¡ç†æ–¹å¼ã€‚

---

## Step 1 - å®žä¾‹é…ç½®æ–‡ä»¶æ¦‚å¿µï¼ˆ20 åˆ†é’Ÿï¼‰

### 1.1 ä»€ä¹ˆæ˜¯å®žä¾‹é…ç½®æ–‡ä»¶ï¼Ÿ

**Instance Profile** æ˜¯ IAM Role å’Œ EC2 å®žä¾‹ä¹‹é—´çš„æ¡¥æ¢ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å®žä¾‹é…ç½®æ–‡ä»¶æž¶æž„                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                       â”‚
â”‚   â”‚    IAM Role     â”‚  å®šä¹‰æƒé™ç­–ç•¥                                         â”‚
â”‚   â”‚  (MyEC2Role)    â”‚  - å¯ä»¥è®¿é—®å“ªäº› AWS èµ„æº                              â”‚
â”‚   â”‚                 â”‚  - å…è®¸å“ªäº›æ“ä½œ                                       â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                       â”‚
â”‚            â”‚                                                                â”‚
â”‚            â”‚ å…³è”                                                            â”‚
â”‚            â–¼                                                                â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                       â”‚
â”‚   â”‚Instance Profile â”‚  IAM Role çš„"å®¹å™¨"                                    â”‚
â”‚   â”‚ (MyEC2Profile)  â”‚  - 1:1 å…³ç³»ï¼ˆä¸€ä¸ª Profile ä¸€ä¸ª Roleï¼‰                 â”‚
â”‚   â”‚                 â”‚  - é™„åŠ åˆ° EC2 å®žä¾‹                                    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                       â”‚
â”‚            â”‚                                                                â”‚
â”‚            â”‚ é™„åŠ                                                             â”‚
â”‚            â–¼                                                                â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚                          EC2 å®žä¾‹                                    â”‚  â”‚
â”‚   â”‚                                                                      â”‚  â”‚
â”‚   â”‚   åº”ç”¨ç¨‹åº â”€â”€â–º AWS SDK â”€â”€â–º IMDS â”€â”€â–º èŽ·å–ä¸´æ—¶å‡­è¯ â”€â”€â–º è°ƒç”¨ AWS API    â”‚  â”‚
â”‚   â”‚                                                                      â”‚  â”‚
â”‚   â”‚   å‡­è¯ç‰¹ç‚¹ï¼š                                                         â”‚  â”‚
â”‚   â”‚   â— ä¸´æ—¶å‡­è¯ï¼ˆASIA å¼€å¤´ï¼‰                                            â”‚  â”‚
â”‚   â”‚   â— è‡ªåŠ¨è½®æ¢ï¼ˆçº¦ 6 å°æ—¶ï¼‰                                            â”‚  â”‚
â”‚   â”‚   â— é€šè¿‡ IMDS æä¾›                                                   â”‚  â”‚
â”‚   â”‚   â— æ— éœ€å­˜å‚¨åœ¨å®žä¾‹ä¸Š                                                 â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 IAM Role vs Instance Profile

å¾ˆå¤šäººæ··æ·†è¿™ä¸¤ä¸ªæ¦‚å¿µï¼š

| æ¦‚å¿µ | è¯´æ˜Ž | ç±»æ¯” |
|------|------|------|
| **IAM Role** | å®šä¹‰æƒé™ç­–ç•¥ï¼ˆå¯ä»¥åšä»€ä¹ˆï¼‰ | å·¥ä½œèŒè´£æè¿° |
| **Instance Profile** | Role çš„"è½½ä½“"ï¼Œé™„åŠ åˆ° EC2 | å·¥ä½œè¯/é€šè¡Œè¯ |
| **Trust Policy** | å®šä¹‰è°å¯ä»¥ä½¿ç”¨è¿™ä¸ª Role | å…¥èŒæ¡ä»¶ |

```bash
# æŸ¥çœ‹å®žä¾‹çš„ Instance Profile
TOKEN=$(curl -s -X PUT "http://169.254.169.254/latest/api/token" \
  -H "X-aws-ec2-metadata-token-ttl-seconds: 21600")

curl -s -H "X-aws-ec2-metadata-token: $TOKEN" \
  http://169.254.169.254/latest/meta-data/iam/info
```

```json
{
  "Code" : "Success",
  "LastUpdated" : "2025-01-10T10:30:00Z",
  "InstanceProfileArn" : "arn:aws:iam::123456789012:instance-profile/MyEC2Profile",
  "InstanceProfileId" : "AIPAXXXXXXXXXXXXXXXXX"
}
```

### 1.3 Trust Policyï¼šè°å¯ä»¥ä½¿ç”¨è¿™ä¸ª Roleï¼Ÿ

æ¯ä¸ª IAM Role éƒ½æœ‰ä¸€ä¸ª **Trust Policy**ï¼Œå®šä¹‰è°å¯ä»¥"æ‰®æ¼”"è¿™ä¸ªè§’è‰²ï¼š

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": {
        "Service": "ec2.amazonaws.com"
      },
      "Action": "sts:AssumeRole"
    }
  ]
}
```

è¿™ä¸ªç­–ç•¥è¯´æ˜Žï¼š**åªæœ‰ EC2 æœåŠ¡å¯ä»¥ä½¿ç”¨è¿™ä¸ªè§’è‰²**ã€‚

### 1.4 ä¸´æ—¶å‡­è¯çš„ç”Ÿå‘½å‘¨æœŸ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ä¸´æ—¶å‡­è¯ç”Ÿå‘½å‘¨æœŸ                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  æ—¶é—´è½´                                                                      â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º   â”‚
â”‚                                                                             â”‚
â”‚  T0           T+5h           T+6h          T+11h         T+12h              â”‚
â”‚   â”‚            â”‚              â”‚             â”‚              â”‚                â”‚
â”‚   â–¼            â–¼              â–¼             â–¼              â–¼                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚
â”‚  â”‚      å‡­è¯ A (æœ‰æ•ˆæœŸ 6 å°æ—¶)                  â”‚                            â”‚
â”‚  â”‚      AccessKeyId: ASIAXXX...               â”‚                            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚
â”‚                                                                             â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚              â”‚  å‡­è¯ B (è‡ªåŠ¨åˆ·æ–°ï¼Œæœ‰æ•ˆæœŸ 6 å°æ—¶)            â”‚                â”‚
â”‚              â”‚  æå‰åˆ·æ–°ï¼Œä¿è¯è¿žç»­æ€§                       â”‚                â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                                                                             â”‚
â”‚  AWS SDK è‡ªåŠ¨å¤„ç†ï¼š                                                         â”‚
â”‚  â— åœ¨å‡­è¯è¿‡æœŸå‰è‡ªåŠ¨åˆ·æ–°                                                     â”‚
â”‚  â— åº”ç”¨æ— æ„ŸçŸ¥ï¼Œæ— éœ€é‡å¯                                                     â”‚
â”‚  â— åˆ·æ–°å¤±è´¥ä¼šæœ‰é”™è¯¯æ—¥å¿—                                                     â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Step 2 - AWS å‡­è¯é“¾ï¼ˆCredential Chainï¼‰ï¼ˆ25 åˆ†é’Ÿï¼‰

### 2.1 å‡­è¯é“¾æŸ¥æ‰¾é¡ºåº

å½“ä½ çš„åº”ç”¨è°ƒç”¨ AWS API æ—¶ï¼ŒSDK/CLI æŒ‰ä»¥ä¸‹é¡ºåºæŸ¥æ‰¾å‡­è¯ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              AWS å‡­è¯é“¾ (Credential Chain) - ä¼˜å…ˆçº§ä»Žé«˜åˆ°ä½Ž                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  ä¼˜å…ˆçº§ 1ï¼šçŽ¯å¢ƒå˜é‡                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ AWS_ACCESS_KEY_ID                                                     â”‚ â”‚
â”‚  â”‚ AWS_SECRET_ACCESS_KEY                                                 â”‚ â”‚
â”‚  â”‚ AWS_SESSION_TOKEN (å¯é€‰ï¼Œç”¨äºŽä¸´æ—¶å‡­è¯)                                 â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚ åœºæ™¯ï¼šCI/CD ç®¡é“ã€ä¸´æ—¶è¦†ç›–ã€æµ‹è¯•                                       â”‚ â”‚
â”‚  â”‚ é£Žé™©ï¼šå¯èƒ½æš´éœ²åœ¨è¿›ç¨‹åˆ—è¡¨æˆ–æ—¥å¿—ä¸­                                       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚           â”‚ å¦‚æžœä¸å­˜åœ¨                                                      â”‚
â”‚           â–¼                                                                 â”‚
â”‚  ä¼˜å…ˆçº§ 2ï¼šé…ç½®æ–‡ä»¶ (~/.aws/credentials)                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ [default]                                                             â”‚ â”‚
â”‚  â”‚ aws_access_key_id = AKIAXXXXXXXXXXXXXXXX                              â”‚ â”‚
â”‚  â”‚ aws_secret_access_key = xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx      â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚ åœºæ™¯ï¼šæœ¬åœ°å¼€å‘ã€ä¸ªäººç”µè„‘                                               â”‚ â”‚
â”‚  â”‚ é£Žé™©ï¼šæ°¸ä¹…å‡­è¯ï¼Œæ³„éœ²é£Žé™©é«˜                                             â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚           â”‚ å¦‚æžœä¸å­˜åœ¨                                                      â”‚
â”‚           â–¼                                                                 â”‚
â”‚  ä¼˜å…ˆçº§ 3ï¼šWeb Identity Token (EKS IRSA)                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ AWS_WEB_IDENTITY_TOKEN_FILE                                           â”‚ â”‚
â”‚  â”‚ AWS_ROLE_ARN                                                          â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚ åœºæ™¯ï¼šKubernetes Pod (EKS IRSA)                                       â”‚ â”‚
â”‚  â”‚ ä¼˜åŠ¿ï¼šPod çº§åˆ«ç»†ç²’åº¦æƒé™                                               â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚           â”‚ å¦‚æžœä¸å­˜åœ¨                                                      â”‚
â”‚           â–¼                                                                 â”‚
â”‚  ä¼˜å…ˆçº§ 4ï¼šECS å®¹å™¨å‡­è¯                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ AWS_CONTAINER_CREDENTIALS_RELATIVE_URI                                â”‚ â”‚
â”‚  â”‚ (ç”± ECS Agent è®¾ç½®)                                                   â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚ åœºæ™¯ï¼šECS Task Role                                                   â”‚ â”‚
â”‚  â”‚ ä¼˜åŠ¿ï¼šä»»åŠ¡çº§åˆ«éš”ç¦»                                                     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚           â”‚ å¦‚æžœä¸å­˜åœ¨                                                      â”‚
â”‚           â–¼                                                                 â”‚
â”‚  ä¼˜å…ˆçº§ 5ï¼šå®žä¾‹é…ç½®æ–‡ä»¶ (Instance Profile) â˜… EC2 æŽ¨è                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ http://169.254.169.254/latest/meta-data/iam/security-credentials/     â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚ åœºæ™¯ï¼šEC2 å®žä¾‹                                                        â”‚ â”‚
â”‚  â”‚ ä¼˜åŠ¿ï¼š                                                                â”‚ â”‚
â”‚  â”‚   â— ä¸´æ—¶å‡­è¯ï¼Œè‡ªåŠ¨è½®æ¢                                                â”‚ â”‚
â”‚  â”‚   â— æ— éœ€ç®¡ç†å¯†é’¥                                                      â”‚ â”‚
â”‚  â”‚   â— æœ€å°æƒé™åŽŸåˆ™                                                      â”‚ â”‚
â”‚  â”‚   â— å®¡è®¡å¯è¿½æº¯                                                        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 éªŒè¯å½“å‰å‡­è¯æ¥æº

```bash
# æœ€é‡è¦çš„è°ƒè¯•å‘½ä»¤ï¼šæˆ‘æ˜¯è°ï¼Ÿ
aws sts get-caller-identity

# æŸ¥çœ‹ SDK ä½¿ç”¨äº†å“ªä¸ªå‡­è¯ï¼ˆè¯¦ç»†æ—¥å¿—ï¼‰
AWS_DEBUG=1 aws sts get-caller-identity 2>&1 | head -30

# æ£€æŸ¥çŽ¯å¢ƒå˜é‡
env | grep -E '^AWS_'

# æ£€æŸ¥é…ç½®æ–‡ä»¶
cat ~/.aws/credentials 2>/dev/null || echo "No credentials file"

# æ£€æŸ¥å®žä¾‹é…ç½®æ–‡ä»¶
TOKEN=$(curl -s -X PUT "http://169.254.169.254/latest/api/token" \
  -H "X-aws-ec2-metadata-token-ttl-seconds: 60" --connect-timeout 2)
if [ -n "$TOKEN" ]; then
  curl -s -H "X-aws-ec2-metadata-token: $TOKEN" \
    http://169.254.169.254/latest/meta-data/iam/security-credentials/
else
  echo "Not running on EC2 or IMDS not available"
fi
```

### 2.3 å‡­è¯é“¾çš„"é™·é˜±"

**é—®é¢˜åœºæ™¯**ï¼šçŽ¯å¢ƒå˜é‡è¦†ç›–äº†å®žä¾‹é…ç½®æ–‡ä»¶

```bash
# å‡è®¾æŸè„šæœ¬è®¾ç½®äº†çŽ¯å¢ƒå˜é‡
export AWS_ACCESS_KEY_ID="AKIAXXXXXXXXXXXXXXXX"
export AWS_SECRET_ACCESS_KEY="xxxxxxxx"

# æ­¤æ—¶ aws å‘½ä»¤ä½¿ç”¨çŽ¯å¢ƒå˜é‡ï¼Œè€Œéžå®žä¾‹é…ç½®æ–‡ä»¶
aws sts get-caller-identity
# è¾“å‡ºæ˜¾ç¤ºçš„æ˜¯çŽ¯å¢ƒå˜é‡å¯¹åº”çš„ç”¨æˆ·ï¼Œä¸æ˜¯ EC2 è§’è‰²ï¼
```

**è¯Šæ–­æ–¹æ³•**ï¼š

```bash
# æ¸…é™¤çŽ¯å¢ƒå˜é‡ï¼ŒéªŒè¯å®žä¾‹é…ç½®æ–‡ä»¶
unset AWS_ACCESS_KEY_ID AWS_SECRET_ACCESS_KEY AWS_SESSION_TOKEN

# å†æ¬¡æ£€æŸ¥èº«ä»½
aws sts get-caller-identity
# çŽ°åœ¨åº”è¯¥æ˜¾ç¤º EC2 è§’è‰²
```

### 2.4 ä¸ºä»€ä¹ˆå®žä¾‹é…ç½®æ–‡ä»¶æ˜¯é¦–é€‰ï¼Ÿ

| å‡­è¯æ–¹å¼ | å®‰å…¨æ€§ | ç®¡ç†æˆæœ¬ | å®¡è®¡èƒ½åŠ› | æŽ¨èåº¦ |
|----------|--------|----------|----------|--------|
| ç¡¬ç¼–ç åœ¨ä»£ç ä¸­ | æžå·® | é«˜ | å·® | ç¦æ­¢ |
| çŽ¯å¢ƒå˜é‡ | å·® | ä¸­ | ä¸­ | ä»…ä¸´æ—¶ä½¿ç”¨ |
| é…ç½®æ–‡ä»¶ | ä¸­ | ä¸­ | ä¸­ | ä»…æœ¬åœ°å¼€å‘ |
| å®žä¾‹é…ç½®æ–‡ä»¶ | é«˜ | ä½Ž | é«˜ | EC2 é¦–é€‰ |
| ECS Task Role | é«˜ | ä½Ž | é«˜ | ECS é¦–é€‰ |
| EKS IRSA | é«˜ | ä½Ž | é«˜ | EKS é¦–é€‰ |

---

## Step 3 - å‡­è¯è°ƒè¯•ï¼ˆ20 åˆ†é’Ÿï¼‰

### 3.1 è°ƒè¯•å·¥å…·ç®±

```bash
# === èº«ä»½ç¡®è®¤ ===

# æŸ¥çœ‹å½“å‰èº«ä»½
aws sts get-caller-identity

# æŸ¥çœ‹å½“å‰èº«ä»½çš„ JSON æ ¼å¼ï¼ˆä¾¿äºŽè„šæœ¬å¤„ç†ï¼‰
aws sts get-caller-identity --output json

# === æƒé™æµ‹è¯• ===

# æµ‹è¯• S3 åˆ—è¡¨æƒé™
aws s3 ls

# æµ‹è¯•ç‰¹å®šæ¡¶è®¿é—®
aws s3 ls s3://my-bucket/ 2>&1

# æµ‹è¯• EC2 æƒé™
aws ec2 describe-instances --max-results 1

# === è¯¦ç»†æ—¥å¿— ===

# å¯ç”¨è°ƒè¯•æ—¥å¿—
AWS_DEBUG=1 aws s3 ls 2>&1 | head -50

# æ›´è¯¦ç»†çš„æ—¥å¿—ï¼ˆæ˜¾ç¤ºç­¾åè¿‡ç¨‹ï¼‰
aws s3 ls --debug 2>&1 | head -100

# === å‡­è¯æ¥æºè¯Šæ–­ ===

# æ£€æŸ¥æ‰€æœ‰å¯èƒ½çš„å‡­è¯æ¥æº
echo "=== Environment Variables ==="
env | grep -E '^AWS_' || echo "None"

echo -e "\n=== Credentials File ==="
cat ~/.aws/credentials 2>/dev/null || echo "None"

echo -e "\n=== Config File ==="
cat ~/.aws/config 2>/dev/null || echo "None"

echo -e "\n=== Instance Profile ==="
TOKEN=$(curl -s -X PUT "http://169.254.169.254/latest/api/token" \
  -H "X-aws-ec2-metadata-token-ttl-seconds: 60" --connect-timeout 2)
if [ -n "$TOKEN" ]; then
  curl -s -H "X-aws-ec2-metadata-token: $TOKEN" \
    http://169.254.169.254/latest/meta-data/iam/security-credentials/
else
  echo "None (not on EC2)"
fi
```

### 3.2 å¸¸è§é”™è¯¯æ¶ˆæ¯è§£è¯»

| é”™è¯¯æ¶ˆæ¯ | åŽŸå›  | è§£å†³æ–¹æ³• |
|----------|------|----------|
| `Unable to locate credentials` | æ²¡æœ‰æ‰¾åˆ°ä»»ä½•å‡­è¯ | æ£€æŸ¥å‡­è¯é“¾æ‰€æœ‰æ¥æº |
| `ExpiredTokenException` | ä¸´æ—¶å‡­è¯è¿‡æœŸ | SDK é€šå¸¸è‡ªåŠ¨åˆ·æ–°ï¼›æ‰‹åŠ¨å‡­è¯éœ€é‡æ–°èŽ·å– |
| `AccessDenied` | æœ‰å‡­è¯ä½†æ²¡æœ‰æƒé™ | æ£€æŸ¥ IAM ç­–ç•¥ |
| `InvalidClientTokenId` | å‡­è¯æ— æ•ˆï¼ˆå¯èƒ½å·²åˆ é™¤ï¼‰ | é‡æ–°åˆ›å»ºæˆ–ä½¿ç”¨å…¶ä»–å‡­è¯ |
| `SignatureDoesNotMatch` | å¯†é’¥é”™è¯¯æˆ–æ—¶é—´ä¸åŒæ­¥ | æ£€æŸ¥å¯†é’¥ã€åŒæ­¥æ—¶é—´ |

### 3.3 æƒé™é—®é¢˜è¯Šæ–­

```bash
# ä½¿ç”¨ IAM Policy Simulatorï¼ˆéœ€è¦ iam æƒé™ï¼‰
aws iam simulate-principal-policy \
  --policy-source-arn arn:aws:iam::123456789012:role/MyEC2Role \
  --action-names s3:GetObject \
  --resource-arns arn:aws:s3:::my-bucket/*

# æŸ¥çœ‹è§’è‰²ç­–ç•¥ï¼ˆéœ€è¦ iam æƒé™ï¼‰
ROLE_NAME="MyEC2Role"
aws iam list-attached-role-policies --role-name $ROLE_NAME
aws iam list-role-policies --role-name $ROLE_NAME
```

---

## Step 4 - æœ€å°æƒé™åŽŸåˆ™ï¼ˆ25 åˆ†é’Ÿï¼‰

### 4.1 ä»€ä¹ˆæ˜¯æœ€å°æƒé™ï¼Ÿ

**æœ€å°æƒé™åŽŸåˆ™ï¼ˆPrinciple of Least Privilegeï¼‰**ï¼šåªæŽˆäºˆå®Œæˆä»»åŠ¡æ‰€éœ€çš„æœ€å°‘æƒé™ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æœ€å°æƒé™ vs è¿‡åº¦æŽˆæƒ                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚   è¿‡åº¦æŽˆæƒï¼ˆå±é™©ï¼ï¼‰                                                          â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                         â”‚
â”‚   {                                                                         â”‚
â”‚     "Effect": "Allow",                                                      â”‚
â”‚     "Action": "*",              â† æ‰€æœ‰æ“ä½œ                                  â”‚
â”‚     "Resource": "*"             â† æ‰€æœ‰èµ„æº                                  â”‚
â”‚   }                                                                         â”‚
â”‚                                                                             â”‚
â”‚   é£Žé™©ï¼š                                                                     â”‚
â”‚   â— å‡­è¯æ³„éœ² = è´¦æˆ·å®Œå…¨æ²¦é™·                                                 â”‚
â”‚   â— åº”ç”¨ Bug å¯èƒ½åˆ é™¤ä»»æ„èµ„æº                                               â”‚
â”‚   â— æ— æ³•è¿½æº¯é—®é¢˜æ¥æº                                                        â”‚
â”‚                                                                             â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚
â”‚                                                                             â”‚
â”‚   æœ€å°æƒé™ï¼ˆæŽ¨èï¼‰                                                           â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                           â”‚
â”‚   {                                                                         â”‚
â”‚     "Effect": "Allow",                                                      â”‚
â”‚     "Action": [                                                             â”‚
â”‚       "s3:GetObject",           â† åªèƒ½è¯»å–                                  â”‚
â”‚       "s3:ListBucket"           â† åªèƒ½åˆ—è¡¨                                  â”‚
â”‚     ],                                                                      â”‚
â”‚     "Resource": [                                                           â”‚
â”‚       "arn:aws:s3:::my-app-data",           â† åªèƒ½è®¿é—®ç‰¹å®šæ¡¶               â”‚
â”‚       "arn:aws:s3:::my-app-data/*"          â† æ¡¶å†…å¯¹è±¡                     â”‚
â”‚     ]                                                                       â”‚
â”‚   }                                                                         â”‚
â”‚                                                                             â”‚
â”‚   ä¼˜åŠ¿ï¼š                                                                     â”‚
â”‚   â— å‡­è¯æ³„éœ²å½±å“æœ‰é™                                                        â”‚
â”‚   â— åº”ç”¨åªèƒ½åšè¯¥åšçš„äº‹                                                      â”‚
â”‚   â— å®¡è®¡æ¸…æ™°                                                                â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 IAM ç­–ç•¥ç»“æž„

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "AllowS3ReadOnly",
      "Effect": "Allow",
      "Action": [
        "s3:GetObject",
        "s3:GetObjectVersion",
        "s3:ListBucket"
      ],
      "Resource": [
        "arn:aws:s3:::my-app-data",
        "arn:aws:s3:::my-app-data/*"
      ],
      "Condition": {
        "StringEquals": {
          "aws:SourceVpc": "vpc-12345678"
        }
      }
    }
  ]
}
```

**ç­–ç•¥å…ƒç´ è¯´æ˜Ž**ï¼š

| å…ƒç´  | è¯´æ˜Ž | ç¤ºä¾‹ |
|------|------|------|
| `Version` | ç­–ç•¥è¯­è¨€ç‰ˆæœ¬ | å§‹ç»ˆä½¿ç”¨ `2012-10-17` |
| `Statement` | æƒé™å£°æ˜Žæ•°ç»„ | å¯åŒ…å«å¤šä¸ªå£°æ˜Ž |
| `Sid` | å£°æ˜Ž IDï¼ˆå¯é€‰ï¼‰ | ä¾¿äºŽè¯†åˆ« |
| `Effect` | å…è®¸æˆ–æ‹’ç» | `Allow` æˆ– `Deny` |
| `Action` | å…è®¸çš„æ“ä½œ | `s3:GetObject`, `ec2:*` |
| `Resource` | ä½œç”¨çš„èµ„æº | ARN æ ¼å¼ |
| `Condition` | æ¡ä»¶é™åˆ¶ï¼ˆå¯é€‰ï¼‰ | VPCã€IPã€æ—¶é—´ç­‰ |

### 4.3 å¸¸ç”¨æ¡ä»¶é™åˆ¶

```json
{
  "Condition": {
    "StringEquals": {
      "aws:SourceVpc": "vpc-12345678"
    },
    "IpAddress": {
      "aws:SourceIp": "10.0.0.0/8"
    },
    "DateGreaterThan": {
      "aws:CurrentTime": "2025-01-01T00:00:00Z"
    },
    "Bool": {
      "aws:SecureTransport": "true"
    }
  }
}
```

### 4.4 æœ€å°æƒé™è®¾è®¡æµç¨‹

```
1. ç¡®å®šåº”ç”¨éœ€è¦è®¿é—®å“ªäº› AWS æœåŠ¡
   â””â”€â–º ä¾‹ï¼šS3ã€DynamoDBã€SQS

2. ç¡®å®šéœ€è¦å“ªäº›æ“ä½œ
   â””â”€â–º ä¾‹ï¼šS3 åªéœ€è¯»å–ï¼Œä¸éœ€å†™å…¥

3. ç¡®å®šéœ€è¦è®¿é—®å“ªäº›èµ„æº
   â””â”€â–º ä¾‹ï¼šåªéœ€è¦è®¿é—® my-app-data æ¡¶

4. è€ƒè™‘æ˜¯å¦éœ€è¦æ¡ä»¶é™åˆ¶
   â””â”€â–º ä¾‹ï¼šåªå…è®¸ä»Ž VPC å†…è®¿é—®

5. ç¼–å†™ç­–ç•¥å¹¶æµ‹è¯•
   â””â”€â–º ä½¿ç”¨ IAM Policy Simulator éªŒè¯

6. å®šæœŸå®¡æŸ¥å’Œæ”¶ç´§
   â””â”€â–º ä½¿ç”¨ IAM Access Analyzer
```

---

## Step 5 - AssumeRole è·¨è´¦æˆ·è®¿é—®ï¼ˆ15 åˆ†é’Ÿï¼‰

### 5.1 ä»€ä¹ˆæ˜¯ AssumeRoleï¼Ÿ

**AssumeRole** å…è®¸ä¸€ä¸ªèº«ä»½"æ‰®æ¼”"å¦ä¸€ä¸ªè§’è‰²ï¼ŒèŽ·å–è¯¥è§’è‰²çš„ä¸´æ—¶å‡­è¯ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    AssumeRole å·¥ä½œæµç¨‹                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚   è´¦æˆ· A (111111111111)               è´¦æˆ· B (222222222222)                  â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€               â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                  â”‚
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚   â”‚   EC2 å®žä¾‹      â”‚                 â”‚  TargetRole     â”‚                   â”‚
â”‚   â”‚   (SourceRole)  â”‚                 â”‚  å¯è®¿é—® S3 æ¡¶   â”‚                   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚            â”‚                                   â”‚                            â”‚
â”‚            â”‚ 1. AssumeRole è¯·æ±‚               â”‚                            â”‚
â”‚            â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                            â”‚
â”‚            â”‚                                   â”‚                            â”‚
â”‚            â”‚    (Trust Policy éªŒè¯             â”‚                            â”‚
â”‚            â”‚     SourceRole æ˜¯å¦è¢«ä¿¡ä»»)        â”‚                            â”‚
â”‚            â”‚                                   â”‚                            â”‚
â”‚            â”‚ 2. è¿”å›žä¸´æ—¶å‡­è¯                   â”‚                            â”‚
â”‚            â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                            â”‚
â”‚            â”‚                                   â”‚                            â”‚
â”‚            â”‚ 3. ä½¿ç”¨ä¸´æ—¶å‡­è¯è®¿é—®è´¦æˆ· B èµ„æº    â”‚                            â”‚
â”‚            â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                            â”‚
â”‚            â”‚                                   â”‚                            â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 é…ç½®è·¨è´¦æˆ·è®¿é—®

**Step 1ï¼šåœ¨ç›®æ ‡è´¦æˆ· (B) åˆ›å»ºè§’è‰²çš„ Trust Policy**ï¼š

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": {
        "AWS": "arn:aws:iam::111111111111:role/SourceRole"
      },
      "Action": "sts:AssumeRole",
      "Condition": {
        "StringEquals": {
          "sts:ExternalId": "my-external-id-12345"
        }
      }
    }
  ]
}
```

**Step 2ï¼šåœ¨æºè´¦æˆ· (A) çš„è§’è‰²æ·»åŠ  AssumeRole æƒé™**ï¼š

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": "sts:AssumeRole",
      "Resource": "arn:aws:iam::222222222222:role/TargetRole"
    }
  ]
}
```

**Step 3ï¼šä½¿ç”¨ AssumeRole èŽ·å–ä¸´æ—¶å‡­è¯**ï¼š

```bash
# AssumeRole
CREDS=$(aws sts assume-role \
  --role-arn arn:aws:iam::222222222222:role/TargetRole \
  --role-session-name MySession \
  --external-id my-external-id-12345 \
  --output json)

# æå–å‡­è¯
export AWS_ACCESS_KEY_ID=$(echo $CREDS | jq -r '.Credentials.AccessKeyId')
export AWS_SECRET_ACCESS_KEY=$(echo $CREDS | jq -r '.Credentials.SecretAccessKey')
export AWS_SESSION_TOKEN=$(echo $CREDS | jq -r '.Credentials.SessionToken')

# éªŒè¯æ–°èº«ä»½
aws sts get-caller-identity
# çŽ°åœ¨æ˜¾ç¤ºçš„æ˜¯ TargetRole
```

### 5.3 External ID çš„ä½œç”¨

**External ID** é˜²æ­¢"æ··æ·†ä»£ç†"æ”»å‡»ï¼š

```
åœºæ™¯ï¼šSaaS æœåŠ¡éœ€è¦è®¿é—®å®¢æˆ·çš„ AWS è´¦æˆ·

æ²¡æœ‰ External IDï¼š
- æ”»å‡»è€…çŸ¥é“ SaaS çš„è´¦æˆ· ID
- æ”»å‡»è€…åˆ›å»ºä¸€ä¸ªä¿¡ä»» SaaS è´¦æˆ·çš„è§’è‰²
- æ”»å‡»è€…è¯±å¯¼ SaaS æœåŠ¡ AssumeRole åˆ°æ”»å‡»è€…çš„è§’è‰²
- SaaS æœåŠ¡æ— æ„ä¸­æ“ä½œäº†æ”»å‡»è€…çš„èµ„æº

æœ‰ External IDï¼š
- æ¯ä¸ªå®¢æˆ·æœ‰å”¯ä¸€çš„ External ID
- AssumeRole éœ€è¦æä¾›æ­£ç¡®çš„ External ID
- æ”»å‡»è€…ä¸çŸ¥é“å…¶ä»–å®¢æˆ·çš„ External ID
- æ”»å‡»å¤±è´¥
```

---

## Lab 1 - æœ€å°æƒé™å®žéªŒï¼ˆ30 åˆ†é’Ÿï¼‰

### å®žéªŒç›®æ ‡

åˆ›å»ºä¸€ä¸ªåªè¯» S3 ç­–ç•¥ï¼ŒéªŒè¯æœ€å°æƒé™çš„æ•ˆæžœã€‚

### Step 1 - å‡†å¤‡æµ‹è¯•çŽ¯å¢ƒ

```bash
# ç¡®è®¤å½“å‰èº«ä»½
aws sts get-caller-identity

# åˆ›å»ºæµ‹è¯•æ¡¶ï¼ˆå¦‚æžœæ²¡æœ‰ï¼‰
BUCKET_NAME="test-least-privilege-$(date +%s)"
aws s3 mb s3://$BUCKET_NAME

# ä¸Šä¼ æµ‹è¯•æ–‡ä»¶
echo "test content" > /tmp/test.txt
aws s3 cp /tmp/test.txt s3://$BUCKET_NAME/

# éªŒè¯ä¸Šä¼ æˆåŠŸ
aws s3 ls s3://$BUCKET_NAME/
```

### Step 2 - åˆ›å»ºåªè¯»ç­–ç•¥

```bash
# åˆ›å»ºç­–ç•¥æ–‡ä»¶
cat > /tmp/s3-readonly-policy.json << EOF
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "AllowS3ReadOnly",
      "Effect": "Allow",
      "Action": [
        "s3:GetObject",
        "s3:GetObjectVersion",
        "s3:ListBucket"
      ],
      "Resource": [
        "arn:aws:s3:::$BUCKET_NAME",
        "arn:aws:s3:::$BUCKET_NAME/*"
      ]
    }
  ]
}
EOF

echo "Policy created:"
cat /tmp/s3-readonly-policy.json
```

### Step 3 - é™„åŠ ç­–ç•¥åˆ°æµ‹è¯•è§’è‰²

```bash
# åˆ›å»º IAM ç­–ç•¥ï¼ˆéœ€è¦ IAM æƒé™ï¼‰
aws iam create-policy \
  --policy-name S3ReadOnlyTest \
  --policy-document file:///tmp/s3-readonly-policy.json

# è®°å½•ç­–ç•¥ ARN
POLICY_ARN="arn:aws:iam::$(aws sts get-caller-identity --query Account --output text):policy/S3ReadOnlyTest"
echo "Policy ARN: $POLICY_ARN"

# å¦‚æžœè¦æµ‹è¯•ï¼Œåˆ›å»ºä¸€ä¸ªæµ‹è¯•è§’è‰²æˆ–é™„åŠ åˆ°çŽ°æœ‰è§’è‰²
# aws iam attach-role-policy --role-name TestRole --policy-arn $POLICY_ARN
```

### Step 4 - éªŒè¯æƒé™

```bash
# æµ‹è¯•è¯»å–ï¼ˆåº”è¯¥æˆåŠŸï¼‰
aws s3 cp s3://$BUCKET_NAME/test.txt /tmp/downloaded.txt
cat /tmp/downloaded.txt

# æµ‹è¯•åˆ—è¡¨ï¼ˆåº”è¯¥æˆåŠŸï¼‰
aws s3 ls s3://$BUCKET_NAME/

# æµ‹è¯•å†™å…¥ï¼ˆåº”è¯¥å¤±è´¥ - AccessDeniedï¼‰
echo "new content" > /tmp/new.txt
aws s3 cp /tmp/new.txt s3://$BUCKET_NAME/ 2>&1

# æµ‹è¯•åˆ é™¤ï¼ˆåº”è¯¥å¤±è´¥ - AccessDeniedï¼‰
aws s3 rm s3://$BUCKET_NAME/test.txt 2>&1
```

### Step 5 - æ¸…ç†

```bash
# åˆ é™¤æµ‹è¯•æ–‡ä»¶å’Œæ¡¶
aws s3 rm s3://$BUCKET_NAME/test.txt
aws s3 rb s3://$BUCKET_NAME

# åˆ é™¤æµ‹è¯•ç­–ç•¥ï¼ˆå¦‚æžœåˆ›å»ºäº†ï¼‰
aws iam delete-policy --policy-arn $POLICY_ARN

rm /tmp/test.txt /tmp/new.txt /tmp/downloaded.txt /tmp/s3-readonly-policy.json
```

### æ£€æŸ¥æ¸…å•

- [ ] ç†è§£ IAM ç­–ç•¥çš„åŸºæœ¬ç»“æž„
- [ ] èƒ½åˆ›å»ºé™åˆ¶ç‰¹å®šèµ„æºçš„ç­–ç•¥
- [ ] èƒ½éªŒè¯ç­–ç•¥çš„å®žé™…æ•ˆæžœ
- [ ] ç†è§£ Allow vs Deny çš„åŒºåˆ«

---

## Lab 2 - å‡­è¯é“¾è°ƒè¯•ï¼ˆ25 åˆ†é’Ÿï¼‰

### å®žéªŒç›®æ ‡

ç†è§£å‡­è¯é“¾çš„ä¼˜å…ˆçº§ï¼Œè¯Šæ–­å‡­è¯æ¥æºé—®é¢˜ã€‚

### Step 1 - æŸ¥çœ‹å½“å‰å‡­è¯

```bash
# åˆ›å»ºè¯Šæ–­è„šæœ¬
cat > /tmp/credential-check.sh << 'EOF'
#!/bin/bash

echo "=========================================="
echo "AWS å‡­è¯è¯Šæ–­æŠ¥å‘Š"
echo "=========================================="
echo ""

echo "1. çŽ¯å¢ƒå˜é‡æ£€æŸ¥"
echo "-------------------------------------------"
if [ -n "$AWS_ACCESS_KEY_ID" ]; then
    echo "AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID:0:10}..."
else
    echo "AWS_ACCESS_KEY_ID: (æœªè®¾ç½®)"
fi

if [ -n "$AWS_SECRET_ACCESS_KEY" ]; then
    echo "AWS_SECRET_ACCESS_KEY: ***hidden***"
else
    echo "AWS_SECRET_ACCESS_KEY: (æœªè®¾ç½®)"
fi

if [ -n "$AWS_SESSION_TOKEN" ]; then
    echo "AWS_SESSION_TOKEN: ${AWS_SESSION_TOKEN:0:20}..."
else
    echo "AWS_SESSION_TOKEN: (æœªè®¾ç½®)"
fi

if [ -n "$AWS_PROFILE" ]; then
    echo "AWS_PROFILE: $AWS_PROFILE"
else
    echo "AWS_PROFILE: (æœªè®¾ç½®ï¼Œå°†ä½¿ç”¨ default)"
fi

echo ""
echo "2. é…ç½®æ–‡ä»¶æ£€æŸ¥"
echo "-------------------------------------------"
if [ -f ~/.aws/credentials ]; then
    echo "~/.aws/credentials: å­˜åœ¨"
    echo "é…ç½®çš„ profiles:"
    grep '^\[' ~/.aws/credentials
else
    echo "~/.aws/credentials: ä¸å­˜åœ¨"
fi

echo ""
echo "3. å®žä¾‹é…ç½®æ–‡ä»¶æ£€æŸ¥"
echo "-------------------------------------------"
TOKEN=$(curl -s -X PUT "http://169.254.169.254/latest/api/token" \
    -H "X-aws-ec2-metadata-token-ttl-seconds: 60" \
    --connect-timeout 2 --max-time 5 2>/dev/null)

if [ -n "$TOKEN" ]; then
    ROLE=$(curl -s -H "X-aws-ec2-metadata-token: $TOKEN" \
        http://169.254.169.254/latest/meta-data/iam/security-credentials/ \
        --connect-timeout 2 --max-time 5 2>/dev/null)
    if [ -n "$ROLE" ]; then
        echo "Instance Profile Role: $ROLE"

        CREDS=$(curl -s -H "X-aws-ec2-metadata-token: $TOKEN" \
            http://169.254.169.254/latest/meta-data/iam/security-credentials/$ROLE \
            --connect-timeout 2 --max-time 5 2>/dev/null)

        if [ -n "$CREDS" ]; then
            EXPIRATION=$(echo "$CREDS" | python3 -c "import sys,json; print(json.load(sys.stdin).get('Expiration','N/A'))" 2>/dev/null)
            echo "å‡­è¯è¿‡æœŸæ—¶é—´: $EXPIRATION"
        fi
    else
        echo "æ²¡æœ‰é™„åŠ  IAM è§’è‰²"
    fi
else
    echo "ä¸åœ¨ EC2 ä¸Šæˆ– IMDS ä¸å¯ç”¨"
fi

echo ""
echo "4. å½“å‰èº«ä»½"
echo "-------------------------------------------"
aws sts get-caller-identity 2>&1

echo ""
echo "=========================================="
EOF

chmod +x /tmp/credential-check.sh
/tmp/credential-check.sh
```

### Step 2 - æ¨¡æ‹Ÿå‡­è¯å†²çª

```bash
# ä¿å­˜å½“å‰çŽ¯å¢ƒ
OLD_ACCESS_KEY=$AWS_ACCESS_KEY_ID
OLD_SECRET_KEY=$AWS_SECRET_ACCESS_KEY

# è®¾ç½®ä¸€ä¸ªå‡çš„çŽ¯å¢ƒå˜é‡ï¼ˆä¼šå¯¼è‡´è®¤è¯å¤±è´¥ï¼‰
export AWS_ACCESS_KEY_ID="AKIAIOSFODNN7EXAMPLE"
export AWS_SECRET_ACCESS_KEY="wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY"

# å°è¯•è°ƒç”¨ AWS API
echo "=== ä½¿ç”¨å‡å‡­è¯æµ‹è¯• ==="
aws sts get-caller-identity 2>&1

# é”™è¯¯åº”è¯¥æ˜¾ç¤ºï¼šInvalidClientTokenId æˆ–ç±»ä¼¼é”™è¯¯
```

### Step 3 - æ¢å¤æ­£ç¡®å‡­è¯

```bash
# æ¸…é™¤çŽ¯å¢ƒå˜é‡
unset AWS_ACCESS_KEY_ID AWS_SECRET_ACCESS_KEY AWS_SESSION_TOKEN

# éªŒè¯æ¢å¤
echo "=== æ¸…é™¤çŽ¯å¢ƒå˜é‡åŽ ==="
aws sts get-caller-identity

# çŽ°åœ¨åº”è¯¥ä½¿ç”¨å®žä¾‹é…ç½®æ–‡ä»¶
```

### Step 4 - éªŒè¯å‡­è¯é“¾ä¼˜å…ˆçº§

```bash
# å¦‚æžœåœ¨ EC2 ä¸Šï¼ŒéªŒè¯å®žä¾‹é…ç½®æ–‡ä»¶ç”Ÿæ•ˆ
echo "=== å‡­è¯æ¥æºéªŒè¯ ==="
/tmp/credential-check.sh

# åº”è¯¥æ˜¾ç¤ºçŽ¯å¢ƒå˜é‡ä¸ºç©ºï¼Œä½¿ç”¨å®žä¾‹é…ç½®æ–‡ä»¶
```

### æ£€æŸ¥æ¸…å•

- [ ] ç†è§£å‡­è¯é“¾çš„ä¼˜å…ˆçº§é¡ºåº
- [ ] èƒ½è¯Šæ–­å‡­è¯æ¥æº
- [ ] ç†è§£çŽ¯å¢ƒå˜é‡å¦‚ä½•è¦†ç›–å®žä¾‹é…ç½®æ–‡ä»¶
- [ ] èƒ½æ¢å¤åˆ°æ­£ç¡®çš„å‡­è¯é…ç½®

---

## å®¹å™¨å‡­è¯æ¦‚è§ˆï¼ˆContainer Credentials Sidebarï¼‰

è™½ç„¶æœ¬è¯¾èšç„¦ EC2 å®žä¾‹é…ç½®æ–‡ä»¶ï¼Œä½†å®¹å™¨çŽ¯å¢ƒæœ‰å…¶ä¸“ç”¨çš„å‡­è¯æœºåˆ¶ï¼š

### ECS Task Role

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ECS Task Role                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚                        ECS Cluster                                  â”‚  â”‚
â”‚   â”‚                                                                     â”‚  â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚  â”‚
â”‚   â”‚   â”‚   Task A        â”‚    â”‚   Task B        â”‚                       â”‚  â”‚
â”‚   â”‚   â”‚   Role: S3Admin â”‚    â”‚   Role: DBRead  â”‚                       â”‚  â”‚
â”‚   â”‚   â”‚   å¯å†™ S3       â”‚    â”‚   åªè¯» RDS      â”‚                       â”‚  â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚  â”‚
â”‚   â”‚                                                                     â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â”‚   ç‰¹ç‚¹ï¼š                                                                    â”‚
â”‚   â— ä»»åŠ¡çº§éš”ç¦»ï¼ˆä¸åŒä»»åŠ¡ä¸åŒæƒé™ï¼‰                                          â”‚
â”‚   â— å‡­è¯é€šè¿‡ AWS_CONTAINER_CREDENTIALS_RELATIVE_URI æä¾›                   â”‚
â”‚   â— SDK è‡ªåŠ¨èŽ·å–å’Œåˆ·æ–°                                                     â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### EKS IRSA (IAM Roles for Service Accounts)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    EKS IRSA                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚                        EKS Cluster                                  â”‚  â”‚
â”‚   â”‚                                                                     â”‚  â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚  â”‚
â”‚   â”‚   â”‚   Pod A         â”‚    â”‚   Pod B         â”‚                       â”‚  â”‚
â”‚   â”‚   â”‚   SA: s3-writer â”‚    â”‚   SA: db-reader â”‚                       â”‚  â”‚
â”‚   â”‚   â”‚   å¯å†™ S3       â”‚    â”‚   åªè¯» RDS      â”‚                       â”‚  â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚  â”‚
â”‚   â”‚                                                                     â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â”‚   ç‰¹ç‚¹ï¼š                                                                    â”‚
â”‚   â— Pod çº§éš”ç¦»ï¼ˆé€šè¿‡ Service Account å…³è” IAM Roleï¼‰                       â”‚
â”‚   â— ä½¿ç”¨ OIDC ä»¤ç‰Œäº¤æ¢ AWS å‡­è¯                                            â”‚
â”‚   â— æ¯” EC2 å®žä¾‹é…ç½®æ–‡ä»¶æ›´ç»†ç²’åº¦                                             â”‚
â”‚                                                                             â”‚
â”‚   é…ç½®ï¼š                                                                    â”‚
â”‚   apiVersion: v1                                                           â”‚
â”‚   kind: ServiceAccount                                                     â”‚
â”‚   metadata:                                                                â”‚
â”‚     annotations:                                                           â”‚
â”‚       eks.amazonaws.com/role-arn: arn:aws:iam::xxx:role/MyPodRole          â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**è¯¦ç»†å†…å®¹å‚è§ LX11-CONTAINERS è¯¾ç¨‹ã€‚**

---

## åæ¨¡å¼æ¼”ç¤ºï¼ˆAnti-Patterns Demoï¼‰

### åæ¨¡å¼ 1ï¼šç¡¬ç¼–ç å‡­è¯

```bash
# å±é™©ï¼å‡­è¯ç¡¬ç¼–ç åœ¨è„šæœ¬ä¸­
cat > /tmp/bad-script.sh << 'EOF'
#!/bin/bash
# åæ¨¡å¼ï¼šç¡¬ç¼–ç å‡­è¯
AWS_ACCESS_KEY_ID="AKIAIOSFODNN7EXAMPLE"
AWS_SECRET_ACCESS_KEY="wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY"

aws s3 ls
EOF
```

**åŽæžœ**ï¼š
- å‡­è¯å¯èƒ½è¢«æäº¤åˆ° Git ä»“åº“
- å‡­è¯åœ¨ `ps aux` æˆ–æ—¥å¿—ä¸­å¯è§
- æ— æ³•è½®æ¢ï¼Œæ³„éœ²åŽå¿…é¡»é‡æ–°ç”Ÿæˆ
- è¿åæ‰€æœ‰å®‰å…¨åˆè§„æ ‡å‡†

**ä¿®å¤**ï¼š

```bash
# æ­£ç¡®ï¼šä½¿ç”¨å®žä¾‹é…ç½®æ–‡ä»¶ï¼Œæ— éœ€ä»»ä½•å‡­è¯ä»£ç 
aws s3 ls
# SDK è‡ªåŠ¨ä»Ž IMDS èŽ·å–ä¸´æ—¶å‡­è¯
```

### åæ¨¡å¼ 2ï¼šè¿‡äºŽå®½æ¾çš„ IAM ç­–ç•¥

```json
{
  "Effect": "Allow",
  "Action": "*",
  "Resource": "*"
}
```

**åŽæžœ**ï¼š
- åº”ç”¨å¯ä»¥åšä»»ä½•äº‹æƒ…ï¼ŒåŒ…æ‹¬åˆ é™¤èµ„æº
- å‡­è¯æ³„éœ² = è´¦æˆ·å®Œå…¨æ²¦é™·
- æ— æ³•è¿½è¸ªé—®é¢˜æ¥æº
- å®¡è®¡æ—¶æ— æ³•è§£é‡Šä¸ºä»€ä¹ˆéœ€è¦å¦‚æ­¤å¤šæƒé™

**ä¿®å¤**ï¼š

```json
{
  "Effect": "Allow",
  "Action": [
    "s3:GetObject",
    "s3:ListBucket"
  ],
  "Resource": [
    "arn:aws:s3:::my-app-bucket",
    "arn:aws:s3:::my-app-bucket/*"
  ]
}
```

### åæ¨¡å¼ 3ï¼šå¿½ç•¥å‡­è¯æ¥æº

```bash
# é”™è¯¯ï¼šä¸æ£€æŸ¥å½“å‰èº«ä»½å°±æ‰§è¡Œæ“ä½œ
aws s3 rm s3://important-bucket/ --recursive
# å¯èƒ½ä½¿ç”¨äº†é”™è¯¯çš„å‡­è¯ï¼
```

**åŽæžœ**ï¼š
- ä½¿ç”¨äº†é”™è¯¯è´¦æˆ·çš„å‡­è¯
- åˆ é™¤äº†é”™è¯¯çš„èµ„æº
- ç”Ÿäº§äº‹æ•…

**ä¿®å¤**ï¼š

```bash
# æ­£ç¡®ï¼šå…ˆç¡®è®¤èº«ä»½
aws sts get-caller-identity
# ç¡®è®¤æ˜¯æ­£ç¡®çš„è´¦æˆ·å’Œè§’è‰²åŽå†æ‰§è¡Œæ“ä½œ
```

---

## èŒåœºå°è´´å£«ï¼ˆJapan IT Contextï¼‰

### æ¨©é™åˆ†é›¢ã¯ç›£æŸ»è¦ä»¶

åœ¨æ—¥æœ¬ä¼ä¸šï¼Œ**æƒé™åˆ†ç¦»ï¼ˆæ¨©é™åˆ†é›¢ï¼‰** æ˜¯å®¡è®¡ï¼ˆç›£æŸ»ï¼‰çš„åŸºæœ¬è¦æ±‚ï¼š

| æ—¥è¯­æœ¯è¯­ | è¯»éŸ³ | å«ä¹‰ | IAM å®žè·µ |
|----------|------|------|----------|
| æœ€å°æ¨©é™ã®åŽŸå‰‡ | ã•ã„ã—ã‚‡ã†ã‘ã‚“ã’ã‚“ã®ã’ã‚“ãã | æœ€å°æƒé™åŽŸåˆ™ | åªæŽˆäºˆå¿…éœ€çš„æƒé™ |
| è·å‹™åˆ†æŽŒ | ã—ã‚‡ãã‚€ã¶ã‚“ã—ã‚‡ã† | èŒè´£åˆ†ç¦» | å¼€å‘/è¿ç»´ä¸åŒè§’è‰² |
| ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ | ã‚¢ã‚¯ã‚»ã‚¹ã›ã„ãŽã‚‡ | è®¿é—®æŽ§åˆ¶ | IAM ç­–ç•¥è®¾è®¡ |
| ç›£æŸ»è¨¼è·¡ | ã‹ã‚“ã•ã—ã‚‡ã†ã›ã | å®¡è®¡è¿½è¸ª | CloudTrail æ—¥å¿— |
| æ¨©é™ãƒ¬ãƒ“ãƒ¥ãƒ¼ | ã‘ã‚“ã’ã‚“ãƒ¬ãƒ“ãƒ¥ãƒ¼ | æƒé™å®¡æŸ¥ | å®šæœŸæƒé™ç›˜ç‚¹ |

### æ—¥æœ¬ä¼ä¸šçš„ IAM æ²»ç†å®žè·µ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            IAM æ¨©é™ç®¡ç†ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆï¼ˆIAM æƒé™ç®¡ç†æ£€æŸ¥è¡¨ï¼‰                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  1. æ¨©é™è¨­è¨ˆï¼ˆæƒé™è®¾è®¡ï¼‰                                                     â”‚
â”‚     â–¡ æœ€å°æ¨©é™ã®åŽŸå‰‡ã«å¾“ã£ã¦ã„ã‚‹ã‹                                          â”‚
â”‚     â–¡ Resource ã« * ã‚’ä½¿ç”¨ã—ã¦ã„ãªã„ã‹                                      â”‚
â”‚     â–¡ Condition ã‚’é©åˆ‡ã«è¨­å®šã—ã¦ã„ã‚‹ã‹                                      â”‚
â”‚                                                                             â”‚
â”‚  2. èªè¨¼æƒ…å ±ç®¡ç†ï¼ˆå‡­è¯ç®¡ç†ï¼‰                                                 â”‚
â”‚     â–¡ EC2 ã«ã¯ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨                                 â”‚
â”‚     â–¡ ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸèªè¨¼æƒ…å ±ãŒãªã„ã‹                                    â”‚
â”‚     â–¡ ä¸€æ™‚èªè¨¼æƒ…å ±ã‚’å„ªå…ˆã—ã¦ã„ã‚‹ã‹                                          â”‚
â”‚                                                                             â”‚
â”‚  3. ç›£æŸ»å¯¾å¿œï¼ˆå®¡è®¡å¯¹åº”ï¼‰                                                     â”‚
â”‚     â–¡ CloudTrail ãŒæœ‰åŠ¹ã‹                                                   â”‚
â”‚     â–¡ IAM Access Analyzer ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ã‹                                  â”‚
â”‚     â–¡ æ¨©é™å¤‰æ›´ã®æ‰¿èªãƒ•ãƒ­ãƒ¼ãŒã‚ã‚‹ã‹                                          â”‚
â”‚                                                                             â”‚
â”‚  4. å®šæœŸãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆå®šæœŸå®¡æŸ¥ï¼‰                                                 â”‚
â”‚     â–¡ æœªä½¿ç”¨ã®æ¨©é™ã‚’å‰Šé™¤ã—ã¦ã„ã‚‹ã‹                                          â”‚
â”‚     â–¡ é€€è·è€…ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’ç„¡åŠ¹åŒ–ã—ã¦ã„ã‚‹ã‹                                    â”‚
â”‚     â–¡ å¤–éƒ¨ã‚¢ã‚¯ã‚»ã‚¹ã‚’å®šæœŸçš„ã«ç¢ºèªã—ã¦ã„ã‚‹ã‹                                  â”‚
â”‚                                                                             â”‚
â”‚  ç¢ºèªæ—¥: ____________  ç¢ºèªè€…: ____________                                  â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### FISC / ISMAP åˆè§„è¦æ±‚

æ—¥æœ¬é‡‘èžè¡Œä¸šï¼ˆFISCï¼‰å’Œæ”¿åºœäº‘ï¼ˆISMAPï¼‰å¯¹ IAM æœ‰ä¸¥æ ¼è¦æ±‚ï¼š

| è¦æ±‚ | è¯´æ˜Ž | å®žè·µ |
|------|------|------|
| æœ€å°æ¨©é™ | åªæŽˆäºˆå¿…éœ€æƒé™ | é¿å… `*` æƒé™ |
| ä¸€æ™‚èªè¨¼æƒ…å ± | ä½¿ç”¨ä¸´æ—¶å‡­è¯ | ä½¿ç”¨ Instance Profile |
| ç›£æŸ»è¨¼è·¡ | è®°å½•æ‰€æœ‰è®¿é—® | CloudTrail å¿…é¡»å¯ç”¨ |
| å®šæœŸãƒ¬ãƒ“ãƒ¥ãƒ¼ | å®šæœŸæƒé™å®¡æŸ¥ | å­£åº¦ IAM ç›˜ç‚¹ |
| MFA | ç®¡ç†å‘˜ MFA å¿…é¡» | æŽ§åˆ¶å°è®¿é—®å¼ºåˆ¶ MFA |

---

## æ£€æŸ¥æ¸…å•

å®Œæˆæœ¬è¯¾åŽï¼Œä½ åº”è¯¥èƒ½å¤Ÿï¼š

- [ ] è§£é‡Šå®žä¾‹é…ç½®æ–‡ä»¶ä¸Ž IAM è§’è‰²çš„å…³ç³»
- [ ] è¯´æ˜Ž AWS å‡­è¯é“¾çš„ä¼˜å…ˆçº§é¡ºåº
- [ ] ä½¿ç”¨ `aws sts get-caller-identity` è¯Šæ–­å½“å‰èº«ä»½
- [ ] è¯Šæ–­å¸¸è§çš„å‡­è¯é”™è¯¯ï¼ˆAccessDenied, ExpiredToken ç­‰ï¼‰
- [ ] è®¾è®¡æœ€å°æƒé™çš„ IAM ç­–ç•¥
- [ ] è§£é‡Š AssumeRole çš„å·¥ä½œåŽŸç†å’Œä½¿ç”¨åœºæ™¯
- [ ] ç†è§£ External ID åœ¨è·¨è´¦æˆ·è®¿é—®ä¸­çš„ä½œç”¨
- [ ] é¿å…ç¡¬ç¼–ç å‡­è¯ç­‰åæ¨¡å¼
- [ ] æŽŒæ¡æ—¥æœ¬ä¼ä¸šçš„ IAM æ²»ç†å®žè·µ

---

## æœ¬è¯¾å°ç»“

| æ¦‚å¿µ | è¦ç‚¹ |
|------|------|
| Instance Profile | IAM Role çš„è½½ä½“ï¼Œé™„åŠ åˆ° EC2 æä¾›ä¸´æ—¶å‡­è¯ |
| å‡­è¯é“¾ | çŽ¯å¢ƒå˜é‡ > é…ç½®æ–‡ä»¶ > Web Identity > Container > Instance Profile |
| è°ƒè¯•å‘½ä»¤ | `aws sts get-caller-identity` æ˜¯æœ€é‡è¦çš„è°ƒè¯•å·¥å…· |
| æœ€å°æƒé™ | åªæŽˆäºˆå¿…éœ€çš„æƒé™ï¼Œé™åˆ¶èµ„æºå’Œæ“ä½œèŒƒå›´ |
| AssumeRole | è·¨è´¦æˆ·è®¿é—®çš„æ ‡å‡†æ¨¡å¼ï¼ŒExternal ID é˜²æ­¢æ··æ·†ä»£ç† |
| åæ¨¡å¼ | ç¦æ­¢ç¡¬ç¼–ç å‡­è¯ï¼Œç¦æ­¢ `Action: *` |

---

## å»¶ä¼¸é˜…è¯»

- [IAM Roles for Amazon EC2](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/iam-roles-for-amazon-ec2.html) - å®˜æ–¹æ–‡æ¡£
- [IAM Best Practices](https://docs.aws.amazon.com/IAM/latest/UserGuide/best-practices.html) - AWS IAM æœ€ä½³å®žè·µ
- [IAM Policy Simulator](https://policysim.aws.amazon.com/) - åœ¨çº¿ç­–ç•¥æµ‹è¯•å·¥å…·
- [Confused Deputy Problem](https://docs.aws.amazon.com/IAM/latest/UserGuide/confused-deputy.html) - External ID èƒŒæ™¯
- å‰ä¸€è¯¾ï¼š[05 - äº‘å­˜å‚¨ï¼šEBS ä¸ŽæŒä¹…åŒ–](../05-cloud-storage/) - EBS æ‰©å®¹å’Œæ•‘æ´å®žä¾‹
- ä¸‹ä¸€è¯¾ï¼š[07 - é‡‘è‰²é•œåƒç­–ç•¥](../07-golden-image/) - Bake vs Bootstrap å†³ç­–

---

## æ¸…ç†èµ„æº

æœ¬è¯¾å®žéªŒä¸»è¦æ˜¯æŸ¥è¯¢æ“ä½œï¼Œæ¸…ç†ä»¥ä¸‹ä¸´æ—¶æ–‡ä»¶ï¼š

```bash
# åˆ é™¤ä¸´æ—¶æ–‡ä»¶
rm -f /tmp/imds-token
rm -f /tmp/credential-check.sh
rm -f /tmp/s3-readonly-policy.json
rm -f /tmp/test.txt /tmp/new.txt /tmp/downloaded.txt

# å¦‚æžœåˆ›å»ºäº†æµ‹è¯• IAM ç­–ç•¥ï¼Œè®°å¾—åˆ é™¤
# aws iam delete-policy --policy-arn arn:aws:iam::xxx:policy/S3ReadOnlyTest

# æ¸…é™¤å¯èƒ½è®¾ç½®çš„çŽ¯å¢ƒå˜é‡
unset AWS_ACCESS_KEY_ID AWS_SECRET_ACCESS_KEY AWS_SESSION_TOKEN
```

---

## ç³»åˆ—å¯¼èˆª

[<- 05 - äº‘å­˜å‚¨ï¼šEBS ä¸ŽæŒä¹…åŒ–](../05-cloud-storage/) | [ç³»åˆ—é¦–é¡µ](../) | [07 - é‡‘è‰²é•œåƒç­–ç•¥ ->](../07-golden-image/)
