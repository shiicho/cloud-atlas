# 04 - äº‘ç½‘ç»œï¼šLinux è§†è§’ï¼ˆCloud Networking: Linux Perspectiveï¼‰

> **ç›®æ ‡**ï¼šä» Linux å†…éƒ¨ç†è§£äº‘ç½‘ç»œï¼ŒæŒæ¡"ss æ­£å¸¸ä½†è¿ä¸ä¸Š"çš„æ’æŸ¥æ–¹æ³•  
> **å‰ç½®**ï¼š[01 - äº‘ä¸­ Linux æœ‰ä½•ä¸åŒ](../01-cloud-context/)ã€[LX06 ç½‘ç»œç®¡ç†](../lx06-networking/)ï¼ˆipã€ssã€nftables åŸºç¡€ï¼‰  
> **æ—¶é—´**ï¼šâš¡ 40 åˆ†é’Ÿï¼ˆé€Ÿè¯»ï¼‰/ ğŸ”¬ 150 åˆ†é’Ÿï¼ˆå®Œæ•´å®æ“ï¼‰  
> **å®æˆ˜åœºæ™¯**ï¼šè¯Šæ–­ MTU å¯¼è‡´çš„"è¿æ¥å»ºç«‹ä½†æ— æ•°æ®"æ•…éšœ  

---

## å°†å­¦åˆ°çš„å†…å®¹

1. ä» Linux è§†è§’ç†è§£ VPC ç½‘ç»œæ¦‚å¿µï¼ˆå­ç½‘ã€ENIã€ç§æœ‰/å…¬æœ‰ IPï¼‰
2. ç†è§£å®‰å…¨ç»„ä¸ nftables çš„å…³ç³»â€”â€”ä¸ºä»€ä¹ˆ ss æ˜¾ç¤º LISTEN ä½†è¿ä¸ä¸Š
3. è°ƒè¯•"Unreachable Endpoint"åœºæ™¯ï¼ˆMTU/PMTUD é—®é¢˜ï¼‰
4. å¤„ç†å¤š ENI åœºæ™¯çš„è·¯ç”±é—®é¢˜
5. ç†è§£äº‘ç¯å¢ƒçš„ DNS é…ç½®

---

## å…ˆè·‘èµ·æ¥ï¼ï¼ˆ10 åˆ†é’Ÿï¼‰

> åœ¨å­¦ä¹ äº‘ç½‘ç»œç†è®ºä¹‹å‰ï¼Œå…ˆç”¨ Linux å‘½ä»¤æ¢ç´¢ä½ çš„äº‘å®ä¾‹ç½‘ç»œç¯å¢ƒã€‚  

åœ¨ä»»æ„ EC2 å®ä¾‹ä¸Šè¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

### æ¢ç´¢ç½‘ç»œæ¥å£

```bash
# æŸ¥çœ‹ç½‘ç»œæ¥å£ï¼ˆä½ ä¼šå‘ç°å®ƒå’Œç‰©ç†æœåŠ¡å™¨ä¸ä¸€æ ·ï¼‰
ip addr show

# æ³¨æ„ MTU å€¼ï¼
ip link show eth0 | grep mtu
```

```
2: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 9001 qdisc mq state UP
    link/ether 0a:1b:2c:3d:4e:5f brd ff:ff:ff:ff:ff:ff
    inet 10.0.1.52/24 brd 10.0.1.255 scope global dynamic eth0
```

**å‘ç° 1**ï¼šMTU æ˜¯ 9001ï¼Œè€Œéæ ‡å‡†ä»¥å¤ªç½‘çš„ 1500â€”â€”è¿™æ˜¯ AWS çš„ **Jumbo Frames**ã€‚

### æ¢ç´¢è·¯ç”±è¡¨

```bash
# æŸ¥çœ‹è·¯ç”±
ip route

# æŸ¥çœ‹é»˜è®¤ç½‘å…³
ip route | grep default
```

```
default via 10.0.1.1 dev eth0
10.0.1.0/24 dev eth0 proto kernel scope link src 10.0.1.52
169.254.169.254 dev eth0  # å…ƒæ•°æ®æœåŠ¡è·¯ç”±
```

**å‘ç° 2**ï¼šæœ‰ä¸€æ¡ä¸“é—¨åˆ° `169.254.169.254`ï¼ˆå…ƒæ•°æ®æœåŠ¡ï¼‰çš„è·¯ç”±ã€‚

### æ¢ç´¢ DNS é…ç½®

```bash
# æŸ¥çœ‹ DNS é…ç½®
cat /etc/resolv.conf

# æµ‹è¯• DNS è§£æ
dig +short ec2.amazonaws.com
```

```
; generated by /usr/sbin/dhclient-script
search ap-northeast-1.compute.internal
nameserver 10.0.0.2
```

**å‘ç° 3**ï¼šDNS æœåŠ¡å™¨æ˜¯ VPC çš„ `.2` åœ°å€â€”â€”è¿™æ˜¯ **AmazonProvidedDNS**ã€‚

### æ¢ç´¢ç›‘å¬ç«¯å£å’Œè¿æ¥

```bash
# æŸ¥çœ‹ç›‘å¬ç«¯å£
ss -tulpn

# æŸ¥çœ‹å·²å»ºç«‹çš„è¿æ¥
ss -tn state established
```

**ä½ åˆšåˆšç”¨æ ‡å‡† Linux å‘½ä»¤æ¢ç´¢äº†äº‘ç½‘ç»œã€‚** æ¥ä¸‹æ¥è®©æˆ‘ä»¬ç†è§£è¿™äº›ç»„ä»¶çš„æ¥é¾™å»è„‰ã€‚

---

## Step 1 - VPC æ¦‚å¿µæ˜ å°„ï¼šLinux è§†è§’ï¼ˆ20 åˆ†é’Ÿï¼‰

### 1.1 VPC ç½‘ç»œä¸ä¼ ç»Ÿç½‘ç»œçš„å¯¹æ¯”

å½“ä½ åœ¨ Linux ä¸Šä½¿ç”¨ `ip`ã€`ss` å‘½ä»¤æ—¶ï¼Œçœ‹åˆ°çš„æ˜¯è™šæ‹ŸåŒ–çš„ç½‘ç»œæ¥å£ã€‚ç†è§£ VPC æ¦‚å¿µæœ‰åŠ©äºæ’æŸ¥äº‘ç½‘ç»œé—®é¢˜ï¼š

<!-- DIAGRAM: vpc-linux-mapping -->
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        VPC ç½‘ç»œ â†’ Linux è§†è§’æ˜ å°„                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚   VPC æ¦‚å¿µ                        Linux çœ‹åˆ°çš„                               â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€                       â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                               â”‚
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚    VPC      â”‚                 â”‚  ip routeï¼ˆè·¯ç”±è¡¨ï¼‰                   â”‚  â”‚
â”‚   â”‚ 10.0.0.0/16 â”‚    â”€â”€â”€â”€â”€â”€â”€â”€â–º   â”‚  10.0.0.0/16 dev eth0               â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚   Subnet    â”‚                 â”‚  ip addrï¼ˆæ¥å£åœ°å€ï¼‰                  â”‚  â”‚
â”‚   â”‚ 10.0.1.0/24 â”‚    â”€â”€â”€â”€â”€â”€â”€â”€â–º   â”‚  inet 10.0.1.52/24 dev eth0         â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚    ENI      â”‚                 â”‚  eth0ï¼ˆè™šæ‹Ÿç½‘å¡ï¼‰                     â”‚  â”‚
â”‚   â”‚ (å¼¹æ€§ç½‘ç»œ   â”‚    â”€â”€â”€â”€â”€â”€â”€â”€â–º   â”‚  MAC: 0a:1b:2c:3d:4e:5f             â”‚  â”‚
â”‚   â”‚   æ¥å£)     â”‚                 â”‚  ç§æœ‰ IP: 10.0.1.52                  â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚ Security    â”‚                 â”‚  çœ‹ä¸åˆ°ï¼                            â”‚  â”‚
â”‚   â”‚   Group     â”‚    â”€â”€â”€â”€â”€â”€â”€â”€â–º   â”‚  åœ¨ Hypervisor å±‚å®æ–½                â”‚  â”‚
â”‚   â”‚ (å®‰å…¨ç»„)    â”‚                 â”‚  ss æ˜¾ç¤º LISTEN ä½†å¯èƒ½è¢« SG é˜»æ­¢    â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚ Route Table â”‚                 â”‚  ip routeï¼ˆé»˜è®¤ç½‘å…³ï¼‰                â”‚  â”‚
â”‚   â”‚ (VPCè·¯ç”±è¡¨) â”‚    â”€â”€â”€â”€â”€â”€â”€â”€â–º   â”‚  default via 10.0.1.1 dev eth0      â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
<!-- /DIAGRAM -->

### 1.2 ENIï¼šLinux çœ‹åˆ°çš„ eth0

**Elastic Network Interface (ENI)** æ˜¯ VPC ä¸­çš„è™šæ‹Ÿç½‘ç»œæ¥å£ï¼š

```bash
# æŸ¥çœ‹ ENI ä¿¡æ¯
ip link show eth0

# ä»å…ƒæ•°æ®æœåŠ¡è·å– ENI ID
TOKEN=$(curl -s -X PUT "http://169.254.169.254/latest/api/token" -H "X-aws-ec2-metadata-token-ttl-seconds: 21600")
curl -s -H "X-aws-ec2-metadata-token: $TOKEN" http://169.254.169.254/latest/meta-data/network/interfaces/macs/
```

ENI çš„å…³é”®å±æ€§ï¼š

| å±æ€§ | è¯´æ˜ | Linux æŸ¥çœ‹å‘½ä»¤ |
|------|------|----------------|
| MAC åœ°å€ | åœ¨ VPC å†…å”¯ä¸€ | `ip link show eth0` |
| ç§æœ‰ IP | ä»å­ç½‘ CIDR åˆ†é… | `ip addr show eth0` |
| å®‰å…¨ç»„ | ç»‘å®šåˆ° ENIï¼ˆä¸æ˜¯å®ä¾‹ï¼‰ | æ— æ³•ä» Linux æŸ¥çœ‹ |
| æº/ç›®æ ‡æ£€æŸ¥ | é»˜è®¤å¼€å¯ï¼ŒNAT å®ä¾‹éœ€å…³é—­ | æ— æ³•ä» Linux é…ç½® |

### 1.3 ç§æœ‰ IP vs å…¬æœ‰ IP

```bash
# æŸ¥çœ‹ç§æœ‰ IPï¼ˆLinux ç›´æ¥çœ‹åˆ°ï¼‰
ip addr show eth0 | grep inet

# æŸ¥çœ‹å…¬æœ‰ IPï¼ˆé€šè¿‡å…ƒæ•°æ®æœåŠ¡ï¼‰
TOKEN=$(curl -s -X PUT "http://169.254.169.254/latest/api/token" -H "X-aws-ec2-metadata-token-ttl-seconds: 21600")
curl -s -H "X-aws-ec2-metadata-token: $TOKEN" http://169.254.169.254/latest/meta-data/public-ipv4
```

**å…³é”®ç†è§£**ï¼šå…¬æœ‰ IP æ˜¯é€šè¿‡ **NAT** å®ç°çš„ï¼ŒLinux å†…æ ¸çœ‹ä¸åˆ°å®ƒã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å…¬æœ‰ IP çš„å·¥ä½œåŸç†                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚   äº’è”ç½‘                  Internet Gateway              EC2 å®ä¾‹     â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€               â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€             â”€â”€â”€â”€â”€â”€â”€â”€â”€     â”‚
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ å®¢æˆ·ç«¯   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚   IGW NAT    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚  eth0    â”‚    â”‚
â”‚  â”‚          â”‚           â”‚              â”‚           â”‚          â”‚    â”‚
â”‚  â”‚ ç›®æ ‡ï¼š   â”‚           â”‚ å…¬æœ‰ IP â†’    â”‚           â”‚ ç§æœ‰ IP  â”‚    â”‚
â”‚  â”‚ 54.1.2.3 â”‚           â”‚ ç§æœ‰ IP      â”‚           â”‚ 10.0.1.52â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                      â”‚
â”‚  Linux çœ‹ä¸åˆ° 54.1.2.3ï¼ŒåªçŸ¥é“è‡ªå·±çš„ 10.0.1.52                        â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.4 å¼¹æ€§ IPï¼ˆElastic IPï¼‰

å¼¹æ€§ IP æ˜¯é™æ€å…¬æœ‰ IPï¼Œå®ä¾‹ Stop/Start åä¿æŒä¸å˜ï¼š

```bash
# é€šè¿‡å…ƒæ•°æ®æŸ¥çœ‹æ˜¯å¦æœ‰ Elastic IP
TOKEN=$(curl -s -X PUT "http://169.254.169.254/latest/api/token" -H "X-aws-ec2-metadata-token-ttl-seconds: 21600")
curl -s -H "X-aws-ec2-metadata-token: $TOKEN" http://169.254.169.254/latest/meta-data/public-ipv4

# å¯¹æ¯”å®ä¾‹ç§æœ‰ IP
curl -s -H "X-aws-ec2-metadata-token: $TOKEN" http://169.254.169.254/latest/meta-data/local-ipv4
```

---

## Step 2 - å®‰å…¨ç»„ vs OS é˜²ç«å¢™ï¼ˆ25 åˆ†é’Ÿï¼‰

### 2.1 åŒå±‚é˜²æŠ¤æ¨¡å‹

äº‘ç½‘ç»œå®‰å…¨é‡‡ç”¨**åŒå±‚é˜²æŠ¤**ï¼šå®‰å…¨ç»„ï¼ˆå¤–éƒ¨ï¼‰+ OS é˜²ç«å¢™ï¼ˆå†…éƒ¨ï¼‰ã€‚

<!-- DIAGRAM: security-layers -->
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          åŒå±‚ç½‘ç»œå®‰å…¨æ¨¡å‹                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚   å…¥ç«™æµé‡                                                                   â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                                 â”‚
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                             â”‚
â”‚   â”‚  äº’è”ç½‘   â”‚                                                             â”‚
â”‚   â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                                                             â”‚
â”‚         â”‚                                                                   â”‚
â”‚         â–¼                                                                   â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚   â”‚  Layer 1: Security Groupï¼ˆå®‰å…¨ç»„ï¼‰                                 â”‚    â”‚
â”‚   â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                â”‚    â”‚
â”‚   â”‚  â— åœ¨ Hypervisor å±‚å®æ–½ï¼ˆEC2 å¤–éƒ¨ï¼‰                                â”‚    â”‚
â”‚   â”‚  â— æœ‰çŠ¶æ€é˜²ç«å¢™ï¼ˆå…è®¸å‡ºç«™è‡ªåŠ¨å…è®¸å“åº”å…¥ç«™ï¼‰                        â”‚    â”‚
â”‚   â”‚  â— åªèƒ½é…ç½® ALLOW è§„åˆ™ï¼Œé»˜è®¤ DENY                                 â”‚    â”‚
â”‚   â”‚  â— Linux çœ‹ä¸åˆ°ï¼Œss æ— æ³•æ£€æµ‹                                      â”‚    â”‚
â”‚   â”‚                                                                   â”‚    â”‚
â”‚   â”‚  ç¤ºä¾‹ï¼šå…è®¸ TCP 80, 443 å…¥ç«™                                       â”‚    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚         â”‚                                                                   â”‚
â”‚         â–¼                                                                   â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚   â”‚  Layer 2: OS Firewallï¼ˆnftables/firewalldï¼‰                       â”‚    â”‚
â”‚   â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                            â”‚    â”‚
â”‚   â”‚  â— åœ¨ Linux å†…æ ¸å®æ–½ï¼ˆEC2 å†…éƒ¨ï¼‰                                  â”‚    â”‚
â”‚   â”‚  â— æœ‰çŠ¶æ€é˜²ç«å¢™ï¼ˆconntrackï¼‰                                      â”‚    â”‚
â”‚   â”‚  â— å¯é…ç½® ALLOW å’Œ DROP/REJECT                                   â”‚    â”‚
â”‚   â”‚  â— ssã€iptables -L å¯ä»¥çœ‹åˆ°                                       â”‚    â”‚
â”‚   â”‚                                                                   â”‚    â”‚
â”‚   â”‚  ç¤ºä¾‹ï¼šnft list ruleset                                           â”‚    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚         â”‚                                                                   â”‚
â”‚         â–¼                                                                   â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                             â”‚
â”‚   â”‚  åº”ç”¨ç¨‹åº  â”‚                                                             â”‚
â”‚   â”‚  (nginx)  â”‚                                                             â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                             â”‚
â”‚                                                                             â”‚
â”‚   è¦ç‚¹ï¼šä¸¤å±‚éƒ½è¦å…è®¸ï¼Œæµé‡æ‰èƒ½åˆ°è¾¾åº”ç”¨ï¼                                     â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
<!-- /DIAGRAM -->

### 2.2 å®‰å…¨ç»„ç‰¹æ€§

å®‰å…¨ç»„æ˜¯**æœ‰çŠ¶æ€é˜²ç«å¢™**ï¼Œå·¥ä½œåœ¨ Hypervisor å±‚ï¼š

| ç‰¹æ€§ | è¯´æ˜ |
|------|------|
| **æœ‰çŠ¶æ€** | å…è®¸å…¥ç«™æµé‡åï¼Œå“åº”è‡ªåŠ¨å…è®¸å‡ºç«™ |
| **åªæœ‰ ALLOW** | ä¸èƒ½é…ç½® DENY è§„åˆ™ï¼Œé»˜è®¤å…¨éƒ¨ DENY |
| **ç»‘å®šåˆ° ENI** | ä¸æ˜¯å®ä¾‹çº§ï¼Œå¤š ENI å¯æœ‰ä¸åŒå®‰å…¨ç»„ |
| **å®æ—¶ç”Ÿæ•ˆ** | ä¿®æ”¹åç«‹å³ç”Ÿæ•ˆï¼Œæ— éœ€é‡å¯ |
| **å¯å¼•ç”¨å…¶ä»–å®‰å…¨ç»„** | å¦‚"å…è®¸æ¥è‡ª sg-webserver çš„æµé‡" |

### 2.3 ä¸ºä»€ä¹ˆ ss æ˜¾ç¤º LISTEN ä½†è¿ä¸ä¸Šï¼Ÿ

è¿™æ˜¯äº‘ç½‘ç»œæœ€å¸¸è§çš„å›°æƒ‘åœºæ™¯ï¼š

```bash
# Linux ä¸ŠæŸ¥çœ‹ç›‘å¬ç«¯å£
ss -tulpn | grep 80

# è¾“å‡ºï¼š
LISTEN  0  511  0.0.0.0:80  0.0.0.0:*  users:(("nginx",pid=1234,fd=6))

# ä½†ä»å¤–éƒ¨ curl å¤±è´¥ï¼
# curl http://[EC2å…¬æœ‰IP] --connect-timeout 5
# curl: (28) Connection timed out
```

**åŸå› åˆ†æ**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    "ss æ­£å¸¸ä½†è¿ä¸ä¸Š" æ’æŸ¥æµç¨‹                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚   ç—‡çŠ¶ï¼šss -tulpn æ˜¾ç¤º nginx ç›‘å¬ 80 ç«¯å£ï¼Œä½†å¤–éƒ¨æ— æ³•è®¿é—®                 â”‚
â”‚                                                                         â”‚
â”‚   å¯èƒ½åŸå› ï¼š                                                             â”‚
â”‚                                                                         â”‚
â”‚   1. å®‰å…¨ç»„æœªå¼€æ”¾ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
â”‚      â”‚                                                                  â”‚
â”‚      â””â”€â–º aws ec2 describe-security-groups --group-ids sg-xxx           â”‚
â”‚          æ£€æŸ¥æ˜¯å¦æœ‰ TCP 80 å…¥ç«™è§„åˆ™                                      â”‚
â”‚                                                                         â”‚
â”‚   2. NACLï¼ˆç½‘ç»œ ACLï¼‰é˜»æ­¢ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
â”‚      â”‚                                                                  â”‚
â”‚      â””â”€â–º aws ec2 describe-network-acls --filter Name=vpc-id,Values=xxx â”‚
â”‚          æ£€æŸ¥å­ç½‘çº§åˆ«çš„ ACL è§„åˆ™                                         â”‚
â”‚                                                                         â”‚
â”‚   3. OS é˜²ç«å¢™é˜»æ­¢ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚
â”‚      â”‚                                                                  â”‚
â”‚      â””â”€â–º nft list ruleset | grep 80                                    â”‚
â”‚          æˆ– firewall-cmd --list-all                                    â”‚
â”‚                                                                         â”‚
â”‚   4. æœåŠ¡åªç›‘å¬ localhost â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚
â”‚      â”‚                                                                  â”‚
â”‚      â””â”€â–º ss -tulpn | grep 80                                           â”‚
â”‚          æ£€æŸ¥æ˜¯ 127.0.0.1:80 è¿˜æ˜¯ 0.0.0.0:80                           â”‚
â”‚                                                                         â”‚
â”‚   5. æ²¡æœ‰å…¬æœ‰ IP æˆ–è·¯ç”± â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚
â”‚      â”‚                                                                  â”‚
â”‚      â””â”€â–º æ£€æŸ¥å®ä¾‹æ˜¯å¦åœ¨å…¬æœ‰å­ç½‘ï¼Œæ˜¯å¦æœ‰å…¬æœ‰ IP                          â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.4 nftables åŸºç¡€é…ç½®

Amazon Linux 2023 ä½¿ç”¨ nftablesï¼ˆä¸æ˜¯ iptablesï¼‰ï¼š

```bash
# æŸ¥çœ‹å½“å‰è§„åˆ™
sudo nft list ruleset

# æ·»åŠ è§„åˆ™å…è®¸ HTTPï¼ˆä¸´æ—¶ï¼‰
sudo nft add rule inet filter input tcp dport 80 accept

# ä½¿ç”¨ firewalldï¼ˆæ›´å‹å¥½çš„å‰ç«¯ï¼‰
sudo systemctl status firewalld

# firewalld å¸¸ç”¨å‘½ä»¤
sudo firewall-cmd --list-all
sudo firewall-cmd --add-service=http --permanent
sudo firewall-cmd --reload
```

### 2.5 åŒå±‚é…ç½®ç¤ºä¾‹

**åœºæ™¯**ï¼šéƒ¨ç½²ä¸€ä¸ª Web æœåŠ¡å™¨ï¼Œéœ€è¦å¼€æ”¾ 80 å’Œ 443 ç«¯å£ã€‚

**Step 1 - å®‰å…¨ç»„é…ç½®**ï¼ˆAWS å±‚é¢ï¼‰ï¼š

```bash
# æŸ¥çœ‹å½“å‰å®‰å…¨ç»„è§„åˆ™
aws ec2 describe-security-groups --group-ids sg-xxxxxxxxx \
  --query 'SecurityGroups[0].IpPermissions'

# æ·»åŠ  HTTP å…¥ç«™è§„åˆ™
aws ec2 authorize-security-group-ingress \
  --group-id sg-xxxxxxxxx \
  --protocol tcp \
  --port 80 \
  --cidr 0.0.0.0/0

# æ·»åŠ  HTTPS å…¥ç«™è§„åˆ™
aws ec2 authorize-security-group-ingress \
  --group-id sg-xxxxxxxxx \
  --protocol tcp \
  --port 443 \
  --cidr 0.0.0.0/0
```

**Step 2 - OS é˜²ç«å¢™é…ç½®**ï¼ˆLinux å±‚é¢ï¼‰ï¼š

```bash
# ä½¿ç”¨ firewalld
sudo firewall-cmd --add-service=http --permanent
sudo firewall-cmd --add-service=https --permanent
sudo firewall-cmd --reload

# æˆ–ä½¿ç”¨ nftables ç›´æ¥é…ç½®
sudo nft add rule inet filter input tcp dport { 80, 443 } accept
```

---

## Step 3 - DNS é…ç½®ï¼ˆ15 åˆ†é’Ÿï¼‰

### 3.1 VPC DNS è§£æå™¨

VPC æä¾›å†…ç½®çš„ DNS è§£æå™¨ï¼ˆ**AmazonProvidedDNS**ï¼‰ï¼Œåœ°å€æ˜¯ VPC CIDR çš„ `.2` åœ°å€ï¼š

```bash
# æŸ¥çœ‹ DNS é…ç½®
cat /etc/resolv.conf

# å…¸å‹è¾“å‡ºï¼š
search ap-northeast-1.compute.internal
nameserver 10.0.0.2  # VPC CIDR 10.0.0.0/16 â†’ DNS æ˜¯ 10.0.0.2
```

### 3.2 DNS è§£æç‰¹æ€§

| åŠŸèƒ½ | è¯´æ˜ |
|------|------|
| **å…¬æœ‰ DNS è§£æ** | è§£æäº’è”ç½‘åŸŸå |
| **ç§æœ‰ä¸»æœºåè§£æ** | è§£æ VPC å†…å®ä¾‹çš„ç§æœ‰ DNS |
| **ç§æœ‰æ‰˜ç®¡åŒºåŸŸ** | Route 53 ç§æœ‰æ‰˜ç®¡åŒºï¼Œä»… VPC å†…å¯è§ |
| **DNS64** | åœ¨ IPv6-only å­ç½‘è§£æ IPv4-only ç«¯ç‚¹ |

### 3.3 å®ä¾‹ç§æœ‰ DNS å

```bash
# æŸ¥çœ‹å®ä¾‹çš„ç§æœ‰ DNS å
TOKEN=$(curl -s -X PUT "http://169.254.169.254/latest/api/token" -H "X-aws-ec2-metadata-token-ttl-seconds: 21600")
curl -s -H "X-aws-ec2-metadata-token: $TOKEN" http://169.254.169.254/latest/meta-data/local-hostname

# å…¸å‹è¾“å‡ºï¼š
ip-10-0-1-52.ap-northeast-1.compute.internal

# ä»å¦ä¸€å°å®ä¾‹è§£æ
dig ip-10-0-1-52.ap-northeast-1.compute.internal +short
```

### 3.4 systemd-resolved é›†æˆ

æ–°ç‰ˆ Linuxï¼ˆå¦‚ Ubuntu 22.04+ï¼‰ä½¿ç”¨ systemd-resolvedï¼š

```bash
# æŸ¥çœ‹ resolved çŠ¶æ€
resolvectl status

# æŸ¥çœ‹å½“å‰ DNS æœåŠ¡å™¨
resolvectl dns

# å¦‚æœ /etc/resolv.conf æŒ‡å‘ 127.0.0.53
# è¯´æ˜ä½¿ç”¨äº† systemd-resolved çš„ stub resolver
```

**æ³¨æ„**ï¼šåœ¨æŸäº›åœºæ™¯ä¸‹ï¼ˆå¦‚ VPNã€å¤š DNSï¼‰ï¼Œsystemd-resolved çš„è¡Œä¸ºå¯èƒ½ä¸é¢„æœŸä¸åŒã€‚

---

## Step 4 - å¤š ENI åœºæ™¯ï¼ˆ15 åˆ†é’Ÿï¼‰

### 4.1 ä¸ºä»€ä¹ˆéœ€è¦å¤š ENIï¼Ÿ

| åœºæ™¯ | è¯´æ˜ |
|------|------|
| **ç½‘ç»œéš”ç¦»** | ç®¡ç†ç½‘ç»œ + ä¸šåŠ¡ç½‘ç»œåˆ†ç¦» |
| **é«˜å¯ç”¨** | å¤š AZ çš„ ENI å®ç°å¿«é€Ÿæ•…éšœåˆ‡æ¢ |
| **å®‰å…¨éœ€æ±‚** | ä¸åŒ ENI ç»‘å®šä¸åŒå®‰å…¨ç»„ |
| **å¤š IP** | ä¸€ä¸ªå®ä¾‹æ‰¿è½½å¤šä¸ªæœåŠ¡ï¼ˆä¸åŒ IPï¼‰ |

### 4.2 é™„åŠ è¾…åŠ© ENI

```bash
# åˆ›å»º ENI
aws ec2 create-network-interface \
  --subnet-id subnet-xxxxxxxx \
  --description "Secondary ENI" \
  --groups sg-xxxxxxxx

# é™„åŠ åˆ°å®ä¾‹
aws ec2 attach-network-interface \
  --network-interface-id eni-xxxxxxxx \
  --instance-id i-xxxxxxxx \
  --device-index 1

# Linux ä¸Šä¼šçœ‹åˆ°æ–°æ¥å£
ip link show
# è¾“å‡ºï¼šeth0, eth1ï¼ˆæˆ– ens5, ens6ï¼‰
```

### 4.3 Linux è·¯ç”±é—®é¢˜

**é—®é¢˜**ï¼šé™„åŠ ç¬¬äºŒä¸ª ENI åï¼Œå¯èƒ½å‡ºç°è·¯ç”±é—®é¢˜ã€‚

<!-- DIAGRAM: multi-eni-routing -->
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       å¤š ENI è·¯ç”±é—®é¢˜                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚   EC2 å®ä¾‹                                                                   â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚                                                                     â”‚  â”‚
â”‚   â”‚   eth0: 10.0.1.10/24                  eth1: 10.0.2.10/24           â”‚  â”‚
â”‚   â”‚   GW: 10.0.1.1                        GW: 10.0.2.1                 â”‚  â”‚
â”‚   â”‚                                                                     â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â”‚   é—®é¢˜åœºæ™¯ï¼š                                                                 â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                                 â”‚
â”‚   1. å®¢æˆ·ç«¯è¯·æ±‚åˆ°è¾¾ eth1 (10.0.2.10)                                        â”‚
â”‚   2. å“åº”ä»é»˜è®¤è·¯ç”± (eth0) å‘å‡º                                              â”‚
â”‚   3. æº IP ä¸åŒ¹é…ï¼Œè¿æ¥å¤±è´¥ï¼                                                â”‚
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      è¯·æ±‚åˆ° 10.0.2.10      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚   â”‚  å®¢æˆ·ç«¯   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚   eth1   â”‚                     â”‚
â”‚   â”‚          â”‚                             â”‚          â”‚                     â”‚
â”‚   â”‚          â”‚ â—„â”€â”€â”€â”€â”€â”€â”€ âœ— å¤±è´¥ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚   eth0   â”‚  å“åº”èµ°é”™è·¯äº†ï¼      â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     å“åº”ä» 10.0.1.10        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚                                                                             â”‚
â”‚   è§£å†³æ–¹æ¡ˆï¼šç­–ç•¥è·¯ç”±ï¼ˆPolicy Routingï¼‰                                        â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
<!-- /DIAGRAM -->

### 4.4 é…ç½®ç­–ç•¥è·¯ç”±

```bash
# åˆ›å»ºè·¯ç”±è¡¨
echo "100 eth1_table" | sudo tee -a /etc/iproute2/rt_tables

# æ·»åŠ è·¯ç”±è§„åˆ™
sudo ip route add default via 10.0.2.1 dev eth1 table eth1_table
sudo ip rule add from 10.0.2.10/32 table eth1_table

# éªŒè¯
ip rule show
ip route show table eth1_table
```

**æŒä¹…åŒ–é…ç½®**ï¼ˆAmazon Linux 2023 / RHELï¼‰ï¼š

```bash
# åˆ›å»º /etc/sysconfig/network-scripts/route-eth1
default via 10.0.2.1 dev eth1 table eth1_table

# åˆ›å»º /etc/sysconfig/network-scripts/rule-eth1
from 10.0.2.10/32 table eth1_table
```

---

## Step 5 - MTU é—®é¢˜æ·±å…¥ï¼ˆ20 åˆ†é’Ÿï¼‰

### 5.1 ä»€ä¹ˆæ˜¯ MTUï¼Ÿ

**MTU (Maximum Transmission Unit)** æ˜¯ç½‘ç»œæ¥å£èƒ½ä¼ è¾“çš„æœ€å¤§æ•°æ®åŒ…å¤§å°ã€‚

| ç½‘ç»œç±»å‹ | å…¸å‹ MTU |
|----------|----------|
| ä¼ ç»Ÿä»¥å¤ªç½‘ | 1500 bytes |
| AWS VPC å†… | 9001 bytesï¼ˆJumbo Framesï¼‰ |
| è·¨ VPN/DirectConnect | å–å†³äºè·¯å¾„ |
| äº’è”ç½‘ | 1500 bytesï¼ˆæœ€å¸¸è§ï¼‰ |

### 5.2 PMTUD å·¥ä½œåŸç†

**Path MTU Discovery (PMTUD)** è®©å‘é€æ–¹å‘ç°è·¯å¾„ä¸Šçš„æœ€å° MTUï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        PMTUD å·¥ä½œåŸç†                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚   å‘é€æ–¹          è·¯ç”±å™¨ï¼ˆMTU è¾ƒå°ï¼‰           æ¥æ”¶æ–¹                    â”‚
â”‚   MTU=9001        MTU=1500                   MTU=9001                  â”‚
â”‚                                                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚   â”‚ EC2 A  â”‚ â”€â”€â”€â”€â”€ å‘é€ 8000 å­—èŠ‚åŒ… â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚ EC2 B  â”‚              â”‚
â”‚   â”‚        â”‚          (DF=1)                   â”‚        â”‚              â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚       â”‚                   â”‚                                            â”‚
â”‚       â”‚                   â–¼                                            â”‚
â”‚       â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                    â”‚
â”‚       â”‚           â”‚ åŒ…å¤ªå¤§ï¼      â”‚                                    â”‚
â”‚       â”‚           â”‚ å‘é€ ICMP     â”‚                                    â”‚
â”‚       â”‚           â”‚ Type 3 Code 4 â”‚                                    â”‚
â”‚       â”‚           â”‚ "éœ€è¦åˆ†ç‰‡"    â”‚                                    â”‚
â”‚       â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                    â”‚
â”‚       â”‚                   â”‚                                            â”‚
â”‚       â—„â”€â”€â”€â”€â”€ ICMP é€šçŸ¥ â”€â”€â”€â”˜                                            â”‚
â”‚       â”‚                                                                 â”‚
â”‚       â–¼                                                                 â”‚
â”‚   è°ƒæ•´å‘é€å¤§å°ä¸º 1500                                                    â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.3 å½“ PMTUD å¤±è´¥æ—¶

**é—®é¢˜åœºæ™¯**ï¼šæŸäº›é˜²ç«å¢™é˜»æ­¢ ICMPï¼Œå¯¼è‡´ PMTUD å¤±è´¥ã€‚

```
ç—‡çŠ¶ï¼š
- TCP ä¸‰æ¬¡æ¡æ‰‹æˆåŠŸï¼ˆSYN/SYN-ACK/ACKï¼‰
- å°åŒ…èƒ½ä¼ è¾“ï¼ˆå¦‚ HTTP è¯·æ±‚å¤´ï¼‰
- å¤§æ•°æ®ä¼ è¾“å¡ä½ï¼ˆå¦‚ä¸‹è½½æ–‡ä»¶ï¼‰
- curl æ˜¾ç¤º "stalled" æˆ–æ— é™ç­‰å¾…
```

è¿™å°±æ˜¯ **"Unreachable Endpoint"** åœºæ™¯çš„æ ¹æœ¬åŸå› ã€‚

### 5.4 è¯Šæ–­ MTU é—®é¢˜

```bash
# æµ‹è¯•è·¯å¾„ MTUï¼ˆä½¿ç”¨ pingï¼‰
# -M doï¼šè®¾ç½® DF (Don't Fragment) æ ‡å¿—
# -sï¼šæŒ‡å®šæ•°æ®å¤§å°ï¼ˆä¸å« IP å’Œ ICMP å¤´ï¼‰

# æµ‹è¯• 1500 å­—èŠ‚ï¼ˆæ ‡å‡†ä»¥å¤ªç½‘ï¼‰
ping -M do -s 1472 <ç›®æ ‡IP> -c 3
# 1472 + 28 (IPå¤´+ICMPå¤´) = 1500

# æµ‹è¯• 9001 å­—èŠ‚ï¼ˆAWS Jumbo Framesï¼‰
ping -M do -s 8973 <ç›®æ ‡IP> -c 3
# 8973 + 28 = 9001

# å¦‚æœæ”¶åˆ° "Frag needed" é”™è¯¯ï¼Œè¯´æ˜ MTU ä¸å¤Ÿ
```

```bash
# ä½¿ç”¨ tracepath å‘ç°è·¯å¾„ MTU
tracepath <ç›®æ ‡IP>

# è¾“å‡ºç¤ºä¾‹ï¼š
 1:  10.0.1.1                     0.654ms pmtu 9001
 2:  10.0.2.1                     1.234ms pmtu 1500
 3:  192.168.1.1                  15.678ms reached
     Resume: pmtu 1500
```

### 5.5 è§£å†³ MTU é—®é¢˜

**æ–¹æ³• 1ï¼šè°ƒæ•´æ¥å£ MTU**

```bash
# ä¸´æ—¶è°ƒæ•´
sudo ip link set dev eth0 mtu 1500

# æ°¸ä¹…é…ç½®ï¼ˆAmazon Linux 2023 / RHELï¼‰
# ç¼–è¾‘ /etc/sysconfig/network-scripts/ifcfg-eth0
MTU=1500

# æˆ–ä½¿ç”¨ nmcli
nmcli connection modify "System eth0" ethernet.mtu 1500
nmcli connection up "System eth0"
```

**æ–¹æ³• 2ï¼šè°ƒæ•´ TCP MSS**

```bash
# MSS = MTU - IPå¤´(20) - TCPå¤´(20) = MTU - 40
# ä½¿ç”¨ iptables/nftables ä¿®æ”¹ MSS

# nftables æ–¹å¼
sudo nft add rule ip filter FORWARD tcp flags syn tcp option maxseg size set 1460

# iptables æ–¹å¼ï¼ˆå…¼å®¹ï¼‰
sudo iptables -t mangle -A FORWARD -p tcp --tcp-flags SYN,RST SYN -j TCPMSS --set-mss 1460
```

---

## Lab 1 - å®‰å…¨ç»„ vs nftables å®éªŒï¼ˆ25 åˆ†é’Ÿï¼‰

### å®éªŒç›®æ ‡

ç†è§£åŒå±‚é˜²æŠ¤ï¼šå®‰å…¨ç»„å…è®¸ä½† nftables é˜»æ­¢ = æ— æ³•è®¿é—®ã€‚

### Step 1 - å‡†å¤‡ç¯å¢ƒ

```bash
# å¯åŠ¨ nginx
sudo yum install -y nginx
sudo systemctl start nginx
sudo systemctl enable nginx

# ç¡®è®¤ nginx ç›‘å¬
ss -tulpn | grep 80
```

### Step 2 - éªŒè¯å®‰å…¨ç»„é…ç½®

```bash
# ç¡®ä¿å®‰å…¨ç»„å…è®¸ HTTPï¼ˆ80ï¼‰å…¥ç«™
aws ec2 describe-security-groups --group-ids sg-xxxxxxxx \
  --query 'SecurityGroups[0].IpPermissions[?FromPort==`80`]'

# å¦‚æœæ²¡æœ‰ï¼Œæ·»åŠ è§„åˆ™
aws ec2 authorize-security-group-ingress \
  --group-id sg-xxxxxxxx \
  --protocol tcp \
  --port 80 \
  --cidr 0.0.0.0/0
```

### Step 3 - æµ‹è¯•è®¿é—®ï¼ˆå®‰å…¨ç»„å…è®¸ï¼‰

ä»å¤–éƒ¨æµ‹è¯•ï¼š

```bash
# ä»æœ¬åœ°æœºå™¨æµ‹è¯•
curl -I http://<EC2å…¬æœ‰IP>

# åº”è¯¥æˆåŠŸï¼Œè¿”å› HTTP 200
```

### Step 4 - æ·»åŠ  nftables DROP è§„åˆ™

```bash
# åœ¨ EC2 å®ä¾‹ä¸Šé˜»æ­¢ HTTP
sudo nft add rule inet filter input tcp dport 80 drop

# éªŒè¯è§„åˆ™
sudo nft list ruleset | grep 80
```

### Step 5 - å†æ¬¡æµ‹è¯•ï¼ˆå®‰å…¨ç»„å…è®¸ï¼Œnftables é˜»æ­¢ï¼‰

```bash
# ä»æœ¬åœ°æœºå™¨æµ‹è¯•
curl -I http://<EC2å…¬æœ‰IP> --connect-timeout 10

# åº”è¯¥è¶…æ—¶ï¼å› ä¸º nftables é˜»æ­¢äº†
# curl: (28) Connection timed out
```

### Step 6 - ç†è§£ç»“æœ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      å®éªŒç»“æœåˆ†æ                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                    â”‚
â”‚   åœºæ™¯ 1ï¼šå®‰å…¨ç»„ âœ“ + nftables âœ“                                    â”‚
â”‚   ç»“æœï¼šè®¿é—®æˆåŠŸ âœ“                                                  â”‚
â”‚                                                                    â”‚
â”‚   åœºæ™¯ 2ï¼šå®‰å…¨ç»„ âœ“ + nftables âœ—                                    â”‚
â”‚   ç»“æœï¼šè®¿é—®å¤±è´¥ âœ—ï¼ˆæœ¬å®éªŒï¼‰                                        â”‚
â”‚                                                                    â”‚
â”‚   åœºæ™¯ 3ï¼šå®‰å…¨ç»„ âœ— + nftables âœ“                                    â”‚
â”‚   ç»“æœï¼šè®¿é—®å¤±è´¥ âœ—                                                  â”‚
â”‚                                                                    â”‚
â”‚   åœºæ™¯ 4ï¼šå®‰å…¨ç»„ âœ— + nftables âœ—                                    â”‚
â”‚   ç»“æœï¼šè®¿é—®å¤±è´¥ âœ—                                                  â”‚
â”‚                                                                    â”‚
â”‚   ç»“è®ºï¼šä¸¤å±‚éƒ½å¿…é¡»å…è®¸ï¼Œæµé‡æ‰èƒ½åˆ°è¾¾åº”ç”¨                            â”‚
â”‚                                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Step 7 - æ¸…ç†

```bash
# åˆ é™¤ nftables è§„åˆ™
sudo nft flush ruleset

# æˆ–é‡æ–°åŠ è½½é»˜è®¤è§„åˆ™
sudo systemctl restart nftables
```

### æ£€æŸ¥æ¸…å•

- [ ] ç†è§£å®‰å…¨ç»„åœ¨ Hypervisor å±‚å®æ–½
- [ ] ç†è§£ nftables åœ¨ Linux å†…æ ¸å®æ–½
- [ ] èƒ½é…ç½®å®‰å…¨ç»„å…¥ç«™è§„åˆ™
- [ ] èƒ½ä½¿ç”¨ nft å‘½ä»¤ç®¡ç†é˜²ç«å¢™è§„åˆ™
- [ ] ç†è§£ä¸ºä»€ä¹ˆ"ss æ­£å¸¸ä½†è¿ä¸ä¸Š"

---

## Lab 2 - Unreachable Endpoint åœºæ™¯ï¼ˆ30 åˆ†é’Ÿï¼‰

### åœºæ™¯æè¿°

> SSH æ­£å¸¸ï¼Œping æ­£å¸¸ï¼Œä½† curl åˆ°ç‰¹å®š API ç«¯ç‚¹æ— é™æŒ‚èµ·ã€‚  
> ss æ˜¾ç¤ºè¿æ¥ ESTABLISHEDï¼Œä½†æ²¡æœ‰æ•°æ®ä¼ è¾“ã€‚  

è¿™æ˜¯ç”Ÿäº§ç¯å¢ƒä¸­æœ€éšè”½çš„ç½‘ç»œé—®é¢˜ä¹‹ä¸€ã€‚

### å®éªŒç›®æ ‡

å­¦ä¹ è¯Šæ–­ MTU å¯¼è‡´çš„å¤§åŒ…ä¼ è¾“å¤±è´¥ã€‚

### Step 1 - æ¨¡æ‹Ÿé—®é¢˜åœºæ™¯

```bash
# åœ¨å®ä¾‹ä¸Šäººä¸ºé™ä½ MTUï¼ˆæ¨¡æ‹Ÿ VPN åœºæ™¯ï¼‰
sudo ip link set dev eth0 mtu 1400

# æŸ¥çœ‹å½“å‰ MTU
ip link show eth0 | grep mtu
```

### Step 2 - æµ‹è¯•å°åŒ…ä¼ è¾“ï¼ˆæˆåŠŸï¼‰

```bash
# å°åŒ…èƒ½æ­£å¸¸ä¼ è¾“
curl -I https://www.google.com

# åº”è¯¥æˆåŠŸ
```

### Step 3 - æµ‹è¯•å¤§åŒ…ä¼ è¾“ï¼ˆå¯èƒ½å¤±è´¥æˆ–å˜æ…¢ï¼‰

```bash
# ä¸‹è½½è¾ƒå¤§æ–‡ä»¶
curl -o /dev/null https://speed.cloudflare.com/__down?bytes=10000000 --connect-timeout 10 -w "Speed: %{speed_download}\n"

# å¦‚æœ PMTUD è¢«é˜»æ­¢ï¼Œå¯èƒ½ä¼šéå¸¸æ…¢æˆ–å¡ä½
```

### Step 4 - è¯Šæ–­ MTU é—®é¢˜

```bash
# æ–¹æ³• 1ï¼šä½¿ç”¨ ping æµ‹è¯•
ping -M do -s 1372 8.8.8.8 -c 3  # 1372 + 28 = 1400 (å½“å‰ MTU)
ping -M do -s 1472 8.8.8.8 -c 3  # 1472 + 28 = 1500 (ä¼šå¤±è´¥)

# æ–¹æ³• 2ï¼šä½¿ç”¨ tracepath
tracepath 8.8.8.8

# æ–¹æ³• 3ï¼šæŸ¥çœ‹æ¥å£ MTU
ip link show eth0
```

### Step 5 - è§£å†³é—®é¢˜

```bash
# æ¢å¤æ­£å¸¸ MTU
sudo ip link set dev eth0 mtu 9001  # AWS VPC å†…æ ‡å‡†å€¼

# æˆ–è®¾ç½®ä¸ºä¿å®ˆå€¼
sudo ip link set dev eth0 mtu 1500  # äº’è”ç½‘æ ‡å‡†å€¼

# éªŒè¯
ip link show eth0 | grep mtu
```

### Step 6 - éªŒè¯ä¿®å¤

```bash
# é‡æ–°æµ‹è¯•å¤§æ–‡ä»¶ä¸‹è½½
curl -o /dev/null https://speed.cloudflare.com/__down?bytes=10000000 -w "Speed: %{speed_download}\n"

# åº”è¯¥æ­£å¸¸é€Ÿåº¦ä¸‹è½½
```

### æ£€æŸ¥æ¸…å•

- [ ] ç†è§£ MTU å’Œ PMTUD çš„æ¦‚å¿µ
- [ ] èƒ½ä½¿ç”¨ `ping -M do -s` æµ‹è¯• MTU
- [ ] èƒ½ä½¿ç”¨ `tracepath` å‘ç°è·¯å¾„ MTU
- [ ] èƒ½è°ƒæ•´ç½‘ç»œæ¥å£ MTU
- [ ] ç†è§£ä¸ºä»€ä¹ˆ"è¿æ¥å»ºç«‹ä½†æ— æ•°æ®"

---

## Lab 3 - ç½‘ç»œæ•…éšœæ’æŸ¥æµç¨‹ï¼ˆ20 åˆ†é’Ÿï¼‰

### ç³»ç»ŸåŒ–æ’æŸ¥æ–¹æ³•è®º

ç½‘ç»œé—®é¢˜æ’æŸ¥éµå¾ª **L3 â†’ L4 â†’ L7** çš„é¡ºåºï¼š

<!-- DIAGRAM: network-troubleshooting-flow -->
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ç½‘ç»œæ•…éšœæ’æŸ¥æµç¨‹ (L3 â†’ L4 â†’ L7)                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚  Step 1: L3 ç½‘ç»œå±‚ - IP è¿é€šæ€§                                       â”‚  â”‚
â”‚   â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                      â”‚  â”‚
â”‚   â”‚  ping <ç›®æ ‡IP>                                                       â”‚  â”‚
â”‚   â”‚  traceroute <ç›®æ ‡IP>                                                 â”‚  â”‚
â”‚   â”‚  ip route get <ç›®æ ‡IP>                                               â”‚  â”‚
â”‚   â”‚                                                                      â”‚  â”‚
â”‚   â”‚  æ£€æŸ¥ï¼š                                                              â”‚  â”‚
â”‚   â”‚  âœ“ è·¯ç”±æ˜¯å¦æ­£ç¡®                                                      â”‚  â”‚
â”‚   â”‚  âœ“ ICMP æ˜¯å¦å¯è¾¾                                                     â”‚  â”‚
â”‚   â”‚  âœ“ å®‰å…¨ç»„/NACL æ˜¯å¦å…è®¸ ICMP                                         â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                       â”‚                     â”‚
â”‚                                                       â–¼                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚  Step 2: L4 ä¼ è¾“å±‚ - TCP/UDP ç«¯å£                                    â”‚  â”‚
â”‚   â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                  â”‚  â”‚
â”‚   â”‚  ss -tulpn                          # æœ¬åœ°ç›‘å¬ç«¯å£                   â”‚  â”‚
â”‚   â”‚  nc -zv <ç›®æ ‡IP> <ç«¯å£>              # ç«¯å£å¯è¾¾æ€§                    â”‚  â”‚
â”‚   â”‚  telnet <ç›®æ ‡IP> <ç«¯å£>              # ç«¯å£å¯è¾¾æ€§ï¼ˆå¤‡é€‰ï¼‰            â”‚  â”‚
â”‚   â”‚                                                                      â”‚  â”‚
â”‚   â”‚  æ£€æŸ¥ï¼š                                                              â”‚  â”‚
â”‚   â”‚  âœ“ æœåŠ¡æ˜¯å¦ç›‘å¬æ­£ç¡®åœ°å€ï¼ˆ0.0.0.0 vs 127.0.0.1ï¼‰                     â”‚  â”‚
â”‚   â”‚  âœ“ å®‰å…¨ç»„æ˜¯å¦å…è®¸è¯¥ç«¯å£                                             â”‚  â”‚
â”‚   â”‚  âœ“ nftables æ˜¯å¦å…è®¸                                                â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                       â”‚                     â”‚
â”‚                                                       â–¼                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚  Step 3: L7 åº”ç”¨å±‚ - åè®®éªŒè¯                                        â”‚  â”‚
â”‚   â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                      â”‚  â”‚
â”‚   â”‚  curl -v http://<ç›®æ ‡>               # HTTP è¯¦ç»†è¾“å‡º                 â”‚  â”‚
â”‚   â”‚  curl -v https://<ç›®æ ‡>              # HTTPS (å« TLS æ¡æ‰‹)          â”‚  â”‚
â”‚   â”‚  openssl s_client -connect <ç›®æ ‡>:443  # TLS è¯ä¹¦æ£€æŸ¥               â”‚  â”‚
â”‚   â”‚                                                                      â”‚  â”‚
â”‚   â”‚  æ£€æŸ¥ï¼š                                                              â”‚  â”‚
â”‚   â”‚  âœ“ HTTP å“åº”ç                                                        â”‚  â”‚
â”‚   â”‚  âœ“ TLS è¯ä¹¦æœ‰æ•ˆæ€§                                                    â”‚  â”‚
â”‚   â”‚  âœ“ DNS è§£ææ˜¯å¦æ­£ç¡®                                                  â”‚  â”‚
â”‚   â”‚  âœ“ å“åº”å†…å®¹æ˜¯å¦æ­£ç¡®                                                  â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
<!-- /DIAGRAM -->

### æ’æŸ¥å‘½ä»¤é€ŸæŸ¥è¡¨

```bash
# === L3 ç½‘ç»œå±‚ ===

# æµ‹è¯• IP è¿é€šæ€§
ping -c 3 <ç›®æ ‡IP>

# è¿½è¸ªè·¯ç”±
traceroute <ç›®æ ‡IP>
# æˆ–
mtr <ç›®æ ‡IP>

# æŸ¥çœ‹è·¯ç”±å†³ç­–
ip route get <ç›®æ ‡IP>

# æŸ¥çœ‹æœ¬åœ°è·¯ç”±è¡¨
ip route

# æŸ¥çœ‹ ARP ç¼“å­˜
ip neigh

# === L4 ä¼ è¾“å±‚ ===

# æŸ¥çœ‹ç›‘å¬ç«¯å£
ss -tulpn

# æŸ¥çœ‹å·²å»ºç«‹è¿æ¥
ss -tn state established

# æµ‹è¯•ç«¯å£å¯è¾¾
nc -zv <ç›®æ ‡IP> <ç«¯å£>

# æŸ¥çœ‹è¿æ¥çŠ¶æ€
ss -tn state all dst <ç›®æ ‡IP>

# === L7 åº”ç”¨å±‚ ===

# HTTP è¯¦ç»†è¯·æ±‚
curl -v http://<ç›®æ ‡>

# åªè·å–å“åº”å¤´
curl -I http://<ç›®æ ‡>

# å¸¦è¶…æ—¶çš„è¯·æ±‚
curl --connect-timeout 5 --max-time 10 http://<ç›®æ ‡>

# æµ‹è¯• HTTPS/TLS
openssl s_client -connect <ç›®æ ‡>:443 -servername <åŸŸå>

# DNS è§£ææµ‹è¯•
dig <åŸŸå>
dig +short <åŸŸå>
nslookup <åŸŸå>

# === ç»¼åˆå·¥å…· ===

# æŠ“åŒ…åˆ†æ
sudo tcpdump -i eth0 host <ç›®æ ‡IP> -n

# æŒç»­ç›‘æ§è¿æ¥
watch -n 1 'ss -tn | grep <ç›®æ ‡IP>'
```

### å¸¸è§é—®é¢˜é€ŸæŸ¥

| ç—‡çŠ¶ | å¯èƒ½åŸå›  | æ’æŸ¥å‘½ä»¤ |
|------|----------|----------|
| ping ä¸é€š | SG/NACL é˜»æ­¢ ICMP | æ£€æŸ¥å®‰å…¨ç»„å…¥ç«™è§„åˆ™ |
| ç«¯å£è¿ä¸ä¸Š | SG æœªå¼€æ”¾ | `aws ec2 describe-security-groups` |
| æœåŠ¡è¿ä¸ä¸Š | ç›‘å¬ 127.0.0.1 | `ss -tulpn` æ£€æŸ¥ç»‘å®šåœ°å€ |
| è¿ä¸Šä½†å¡ä½ | MTU é—®é¢˜ | `ping -M do -s 1472` |
| é—´æ­‡æ€§è¶…æ—¶ | DNS é—®é¢˜ | `dig +trace <åŸŸå>` |
| TLS å¤±è´¥ | è¯ä¹¦é—®é¢˜ | `openssl s_client` |

---

## è·¨äº‘è§†è§’ï¼ˆCross-Cloud Sidebarï¼‰

è™½ç„¶æœ¬è¯¾ä»¥ AWS ä¸ºä¾‹ï¼Œä½†ç½‘ç»œå®‰å…¨åŒå±‚é˜²æŠ¤æ˜¯æ‰€æœ‰äº‘å¹³å°çš„é€šç”¨æ¨¡å¼ï¼š

| æ¦‚å¿µ | AWS | GCP | Azure |
|------|-----|-----|-------|
| è™šæ‹Ÿç½‘ç»œ | VPC | VPC | VNet |
| å¤–éƒ¨é˜²ç«å¢™ | Security Groups | Firewall Rules | NSG |
| çŠ¶æ€æ€§ | æœ‰çŠ¶æ€ | æœ‰çŠ¶æ€ï¼ˆæ ‡ç­¾/ç½‘ç»œçº§ï¼‰ | æœ‰çŠ¶æ€ |
| ç»‘å®šçº§åˆ« | ENIï¼ˆæ¥å£çº§ï¼‰ | Network/Tag | Subnet æˆ– NIC |
| å­ç½‘çº§è§„åˆ™ | Network ACL | VPC Firewall | NSG (subnet) |
| OS é˜²ç«å¢™ | nftables/iptables | nftables/iptables | Windows Firewall/nftables |

**æ ¸å¿ƒåŸåˆ™ç›¸åŒ**ï¼š

```
å¤–éƒ¨è§„åˆ™ï¼ˆäº‘å¹³å°å±‚ï¼‰+ ä¸»æœºè§„åˆ™ï¼ˆOS å±‚ï¼‰= åŒå±‚é˜²æŠ¤
```

**GCP ç‰¹ç‚¹**ï¼š
- Firewall Rules åº”ç”¨äºæ•´ä¸ªç½‘ç»œæˆ–ç‰¹å®šæ ‡ç­¾
- æ”¯æŒæ›´çµæ´»çš„ç›®æ ‡åŒ¹é…ï¼ˆæ ‡ç­¾ã€æœåŠ¡è´¦æˆ·ï¼‰

**Azure ç‰¹ç‚¹**ï¼š
- NSG å¯ä»¥åº”ç”¨äºå­ç½‘æˆ–å•ä¸ª NIC
- æ”¯æŒåº”ç”¨å®‰å…¨ç»„ï¼ˆASGï¼‰è¿›è¡Œåˆ†ç»„

---

## åæ¨¡å¼æ¼”ç¤ºï¼ˆAnti-Patterns Demoï¼‰

### åæ¨¡å¼ 1ï¼šåªé…å®‰å…¨ç»„ï¼Œå¿½ç•¥ OS é˜²ç«å¢™

```bash
# é”™è¯¯æ€ç»´ï¼š
# "å®‰å…¨ç»„å¼€äº† 80ï¼Œåº”è¯¥èƒ½è®¿é—®äº†"

# å®é™…ï¼šæŸäº› AMI é»˜è®¤å¯ç”¨ firewalldï¼Œä¼šé˜»æ­¢æµé‡
sudo firewall-cmd --list-all
# å¯èƒ½æ˜¾ç¤ºï¼šservices: ssh dhcpv6-client
# æ²¡æœ‰ httpï¼
```

**åæœ**ï¼š
- ç”Ÿäº§éƒ¨ç½²åæœåŠ¡ä¸å¯è®¿é—®
- æ’æŸ¥æ—¶"ss æ˜¾ç¤º LISTEN"ä½†è¿ä¸ä¸Š
- æµªè´¹å¤§é‡æ—¶é—´æ’æŸ¥å®‰å…¨ç»„

**ä¿®å¤**ï¼š

```bash
# æ£€æŸ¥å¹¶é…ç½® OS é˜²ç«å¢™
sudo firewall-cmd --add-service=http --permanent
sudo firewall-cmd --add-service=https --permanent
sudo firewall-cmd --reload
```

### åæ¨¡å¼ 2ï¼šå¿½è§†åˆè§„è¦æ±‚åªç”¨å®‰å…¨ç»„

```bash
# é”™è¯¯æ€ç»´ï¼š
# "å®‰å…¨ç»„å·²ç»æ˜¯é˜²ç«å¢™äº†ï¼Œä¸éœ€è¦ nftables"

# å®é™…ï¼šå¾ˆå¤šåˆè§„æ ‡å‡†ï¼ˆCISã€PCI-DSSï¼‰è¦æ±‚ä¸»æœºçº§é˜²ç«å¢™
```

**åæœ**ï¼š
- å®‰å…¨å®¡è®¡ä¸é€šè¿‡
- ç¼ºä¹ Defense in Depth
- å¦‚æœå®‰å…¨ç»„é…ç½®é”™è¯¯ï¼Œæ— ç¬¬äºŒé“é˜²çº¿

**ä¿®å¤**ï¼šå§‹ç»ˆé…ç½®åŒå±‚é˜²æŠ¤ã€‚

### åæ¨¡å¼ 3ï¼šå¿½è§† MTU é—®é¢˜

```bash
# é”™è¯¯æ€ç»´ï¼š
# "èƒ½ ping é€šå°±æ˜¯ç½‘ç»œæ­£å¸¸"

# å®é™…ï¼šå°åŒ…ï¼ˆpingï¼‰èƒ½è¿‡ï¼Œå¤§åŒ…ï¼ˆHTTP bodyï¼‰å¯èƒ½å¤±è´¥
```

**åæœ**ï¼š
- åº”ç”¨é—´æ­‡æ€§è¶…æ—¶
- æ–‡ä»¶ä¼ è¾“å¤±è´¥
- æ•°æ®åº“è¿æ¥æ± è€—å°½

**ä¿®å¤**ï¼š

```bash
# æµ‹è¯•å¤§åŒ…
ping -M do -s 1472 <ç›®æ ‡IP>

# å¦‚æœå¤±è´¥ï¼Œè°ƒæ•´ MTU æˆ–æ£€æŸ¥è·¯å¾„ä¸Šçš„è®¾å¤‡
```

---

## èŒåœºå°è´´å£«ï¼ˆJapan IT Contextï¼‰

### ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯éšœå®³ã¯é‹ç”¨ã®æ—¥å¸¸

åœ¨æ—¥æœ¬ IT ç°åœºï¼Œç½‘ç»œæ•…éšœæ’æŸ¥ï¼ˆãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯éšœå®³å¯¾å¿œï¼‰æ˜¯è¿ç»´å·¥ç¨‹å¸ˆçš„æ—¥å¸¸å·¥ä½œã€‚ä»¥ä¸‹æ˜¯å¸¸ç”¨æœ¯è¯­ï¼š

| æ—¥è¯­æœ¯è¯­ | è¯»éŸ³ | å«ä¹‰ | ä½¿ç”¨åœºæ™¯ |
|----------|------|------|----------|
| ç–é€šç¢ºèª | ãã¤ã†ã‹ãã«ã‚“ | è¿é€šæ€§ç¡®è®¤ | "ç–é€šç¢ºèªã‚’ãŠé¡˜ã„ã—ã¾ã™" |
| ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ« | - | é˜²ç«å¢™ | ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ã€nftables |
| ãƒãƒ¼ãƒˆé–‹æ”¾ | ãƒãƒ¼ãƒˆã‹ã„ã»ã† | ç«¯å£å¼€æ”¾ | "80ç•ªãƒãƒ¼ãƒˆã‚’é–‹æ”¾ã—ã¦ãã ã•ã„" |
| ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚° | - | è·¯ç”± | "ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„" |
| åå‰è§£æ±º | ãªã¾ãˆã‹ã„ã‘ã¤ | DNS è§£æ | "åå‰è§£æ±ºãŒã§ãã¾ã›ã‚“" |
| MTU | - | MTU | "MTUå•é¡Œã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™" |

### ç–é€šç¢ºèªã®ç³»ç»Ÿæ–¹æ³•

æ—¥æœ¬ä¼ä¸šé€šå¸¸æœ‰æ ‡å‡†çš„**ç–é€šç¢ºèª**ï¼ˆè¿é€šæ€§ç¡®è®¤ï¼‰æµç¨‹ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 ç–é€šç¢ºèªãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆï¼ˆè¿é€šæ€§ç¡®è®¤æ£€æŸ¥è¡¨ï¼‰                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  1. L3 ç¢ºèªï¼ˆãƒ¬ã‚¤ãƒ¤ãƒ¼3ç¢ºèªï¼‰                                              â”‚
â”‚     â–¡ ping ã«ã‚ˆã‚‹ ICMP ç–é€šç¢ºèª                                          â”‚
â”‚     â–¡ traceroute ã«ã‚ˆã‚‹çµŒè·¯ç¢ºèª                                          â”‚
â”‚     â–¡ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ã® ICMP è¨±å¯ç¢ºèª                               â”‚
â”‚                                                                         â”‚
â”‚  2. L4 ç¢ºèªï¼ˆãƒ¬ã‚¤ãƒ¤ãƒ¼4ç¢ºèªï¼‰                                              â”‚
â”‚     â–¡ ss -tulpn ã§ãƒªãƒƒã‚¹ãƒ³ãƒãƒ¼ãƒˆç¢ºèª                                     â”‚
â”‚     â–¡ nc -zv ã§ãƒãƒ¼ãƒˆç–é€šç¢ºèª                                            â”‚
â”‚     â–¡ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ã®ãƒãƒ¼ãƒˆè¨±å¯ç¢ºèª                               â”‚
â”‚     â–¡ OS ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«ï¼ˆnftablesï¼‰ç¢ºèª                                â”‚
â”‚                                                                         â”‚
â”‚  3. L7 ç¢ºèªï¼ˆãƒ¬ã‚¤ãƒ¤ãƒ¼7ç¢ºèªï¼‰                                              â”‚
â”‚     â–¡ curl -v ã§HTTPå¿œç­”ç¢ºèª                                             â”‚
â”‚     â–¡ DNS åå‰è§£æ±ºç¢ºèª                                                   â”‚
â”‚     â–¡ SSL/TLS è¨¼æ˜æ›¸ç¢ºèª                                                 â”‚
â”‚                                                                         â”‚
â”‚  4. çµæœè¨˜éŒ²                                                             â”‚
â”‚     â–¡ ç¢ºèªæ—¥æ™‚                                                           â”‚
â”‚     â–¡ ç¢ºèªè€…                                                             â”‚
â”‚     â–¡ ç¢ºèªçµæœï¼ˆOK/NGï¼‰                                                  â”‚
â”‚     â–¡ NG ã®å ´åˆã®è©³ç´°                                                    â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### éšœå®³å ±å‘Šã®æ›¸ãæ–¹

ç½‘ç»œæ•…éšœæŠ¥å‘Šéœ€è¦åŒ…å«ä»¥ä¸‹è¦ç´ ï¼š

```
ã€éšœå®³å ±å‘Šã€‘
â–  ç™ºç”Ÿæ—¥æ™‚ï¼š2025-01-10 14:30 JST
â–  å½±éŸ¿ç¯„å›²ï¼šWeb ã‚µãƒ¼ãƒãƒ¼å¤–éƒ¨ã‚¢ã‚¯ã‚»ã‚¹ä¸å¯
â–  åŸå› ï¼šã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ã« HTTP(80) è¨±å¯ãƒ«ãƒ¼ãƒ«ãªã—
â–  å¯¾å¿œå†…å®¹ï¼šã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ã« TCP/80 ã‚¤ãƒ³ãƒã‚¦ãƒ³ãƒ‰ãƒ«ãƒ¼ãƒ«è¿½åŠ 
â–  å¾©æ—§æ—¥æ™‚ï¼š2025-01-10 14:45 JST
â–  å†ç™ºé˜²æ­¢ç­–ï¼š
  - ã‚¤ãƒ³ãƒ•ãƒ©æ§‹æˆå¤‰æ›´æ™‚ã®ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆè¿½åŠ 
  - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—å¤‰æ›´ã®è‡ªå‹•ãƒ†ã‚¹ãƒˆå°å…¥
```

---

## æ£€æŸ¥æ¸…å•

å®Œæˆæœ¬è¯¾åï¼Œä½ åº”è¯¥èƒ½å¤Ÿï¼š

- [ ] è§£é‡Š VPC ç½‘ç»œæ¦‚å¿µä¸ Linux å‘½ä»¤çš„å¯¹åº”å…³ç³»ï¼ˆENIâ†”eth0, SGâ†”çœ‹ä¸è§ï¼‰
- [ ] ç†è§£å®‰å…¨ç»„ä¸ nftables çš„åŒå±‚é˜²æŠ¤æ¨¡å‹
- [ ] è¯Šæ–­"ss æ˜¾ç¤º LISTEN ä½†è¿ä¸ä¸Š"çš„é—®é¢˜
- [ ] é…ç½®å®‰å…¨ç»„å…¥ç«™è§„åˆ™
- [ ] ä½¿ç”¨ nftables/firewalld ç®¡ç† OS é˜²ç«å¢™
- [ ] ç†è§£ VPC DNSï¼ˆAmazonProvidedDNSï¼‰çš„å·¥ä½œåŸç†
- [ ] å¤„ç†å¤š ENI åœºæ™¯çš„ç­–ç•¥è·¯ç”±
- [ ] è¯Šæ–­ MTU/PMTUD ç›¸å…³çš„ç½‘ç»œé—®é¢˜
- [ ] ä½¿ç”¨ L3â†’L4â†’L7 ç³»ç»ŸåŒ–æ–¹æ³•æ’æŸ¥ç½‘ç»œæ•…éšœ
- [ ] æŒæ¡ç–é€šç¢ºèªï¼ˆè¿é€šæ€§ç¡®è®¤ï¼‰çš„æ ‡å‡†æµç¨‹

---

## æœ¬è¯¾å°ç»“

| æ¦‚å¿µ | è¦ç‚¹ |
|------|------|
| VPC æ˜ å°„ | ENI=eth0, å­ç½‘=ip addr, è·¯ç”±è¡¨=ip route |
| å®‰å…¨ç»„ | å¤–éƒ¨ã€æœ‰çŠ¶æ€ã€åªæœ‰ ALLOWã€ç»‘å®šåˆ° ENI |
| nftables | å†…éƒ¨ã€ä¸»æœºçº§ã€å¯ ALLOW/DROP |
| åŒå±‚é˜²æŠ¤ | ä¸¤å±‚éƒ½è¦å…è®¸ï¼Œæµé‡æ‰èƒ½åˆ°è¾¾ |
| DNS | AmazonProvidedDNS (.2 åœ°å€)ã€ç§æœ‰ä¸»æœºå |
| å¤š ENI | éœ€è¦ç­–ç•¥è·¯ç”±è§£å†³éå¯¹ç§°è·¯ç”± |
| MTU | VPC å†… 9001ã€è·¨ VPN å¯èƒ½æ›´å°ã€PMTUD å¤±è´¥ä¼šå¡ä½ |

---

## å»¶ä¼¸é˜…è¯»

- [AWS VPC ç”¨æˆ·æŒ‡å—](https://docs.aws.amazon.com/vpc/latest/userguide/) - å®˜æ–¹ VPC æ–‡æ¡£
- [Security Groups for Your VPC](https://docs.aws.amazon.com/vpc/latest/userguide/VPC_SecurityGroups.html) - å®‰å…¨ç»„è¯¦è§£
- [nftables Wiki](https://wiki.nftables.org/) - nftables å®˜æ–¹æ–‡æ¡£
- [Path MTU Discovery](https://en.wikipedia.org/wiki/Path_MTU_Discovery) - PMTUD åŸç†
- ä¸‹ä¸€è¯¾ï¼š[05 - äº‘å­˜å‚¨ï¼šEBS ä¸æŒä¹…åŒ–](../05-cloud-storage/) - å­¦ä¹  EBS æ‰©å®¹ã€æ•‘æ´å®ä¾‹
- å‰ç½®è¯¾ç¨‹ï¼š[LX06 - ç½‘ç»œç®¡ç†](../lx06-networking/) - Linux ç½‘ç»œåŸºç¡€

---

## æ¸…ç†èµ„æº

æœ¬è¯¾å®éªŒä¿®æ”¹äº†ç³»ç»Ÿé…ç½®ï¼Œè®°å¾—æ¢å¤ï¼š

```bash
# æ¢å¤ MTUï¼ˆå¦‚æœä¿®æ”¹è¿‡ï¼‰
sudo ip link set dev eth0 mtu 9001

# æ¸…ç† nftables è§„åˆ™
sudo nft flush ruleset
# æˆ–é‡å¯æœåŠ¡æ¢å¤é»˜è®¤
sudo systemctl restart nftables

# æ¸…ç†å®‰å…¨ç»„æµ‹è¯•è§„åˆ™ï¼ˆå¦‚éœ€è¦ï¼‰
aws ec2 revoke-security-group-ingress \
  --group-id sg-xxxxxxxx \
  --protocol tcp \
  --port 80 \
  --cidr 0.0.0.0/0
```

---

## ç³»åˆ—å¯¼èˆª

[â† 03 - å…ƒæ•°æ®æœåŠ¡ä¸ IMDSv2](../03-metadata/) | [ç³»åˆ—é¦–é¡µ](../) | [05 - äº‘å­˜å‚¨ï¼šEBS ä¸æŒä¹…åŒ– â†’](../05-cloud-storage/)
