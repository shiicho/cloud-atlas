# 01 · 云中 Linux：有何不同？

> **目标**：10 分钟内探索云实例的元数据服务，理解云 Linux 与物理服务器的核心区别 
> **前置**：LX06 网络管理 + LX08 安全加固（或同等 Linux 管理经验） 
> **时间**：⚡ 30 分钟（速读）/ 🔬 120 分钟（完整实操） 
> **环境**：AWS EC2 实例（t3.micro 或 t4g.micro 即可）  

---

## 将学到的内容

1. 理解物理服务器 vs 云实例的根本区别
2. 掌握云实例生命周期概念
3. 理解为什么「重启试试」在云中不总是有效
4. 建立云端 Linux 管理员的思维模式
5. 预览本课程将涵盖的核心主题

---

## Step 1 — 先跑起来：云实例的自我发现（10 分钟）

> **目标**：先"尝到"云的味道，再理解原理。  

**你需要**：一台运行中的 AWS EC2 实例。

打开 SSH 终端，依次运行这 4 条命令：

### 1.1 列出所有可用的元数据类别

```bash
curl -s http://169.254.169.254/latest/meta-data/
```

```
ami-id
ami-launch-index
ami-manifest-path
block-device-mapping/
events/
hostname
iam/
identity-credentials/
instance-action
instance-id
instance-life-cycle
instance-type
...
```

**你看到了**：一个隐藏的 API，列出了实例可以"询问自己"的所有信息。

### 1.2 获取实例 ID — 云平台如何识别你

```bash
curl -s http://169.254.169.254/latest/meta-data/instance-id
```

```
i-0abc123def456789
```

**你看到了**：这是你在 AWS 宇宙中的唯一身份证号。

### 1.3 查看 IAM 角色名 — 凭证从何而来

```bash
curl -s http://169.254.169.254/latest/meta-data/iam/security-credentials/
```

```
MyEC2Role
```

**你看到了**：实例可以获取的 IAM 角色名。这意味着**凭证不需要硬编码在机器上**。

### 1.4 实例身份文档 — 区域、账户、架构信息

```bash
curl -s http://169.254.169.254/latest/dynamic/instance-identity/document | head -10
```

```json
{
  "accountId" : "123456789012",
  "architecture" : "x86_64",
  "availabilityZone" : "ap-northeast-1a",
  "imageId" : "ami-0abc123def456789",
  "instanceId" : "i-0abc123def456789",
  "instanceType" : "t3.micro",
  "pendingTime" : "2025-01-04T10:30:45Z",
  "privateIp" : "10.0.1.52",
  "region" : "ap-northeast-1",
```

**你看到了**：实例的完整身份信息 — 它知道自己在哪个区域、什么架构、属于哪个账户。

---

**你刚刚访问了云元数据服务 — 这就是云端 Linux 与物理服务器的核心区别。**

| 物理服务器 | 云实例 |
|------------|--------|
| 不知道自己在哪个数据中心 | 知道自己的区域、可用区 |
| 凭证必须手动配置 | 凭证通过元数据服务自动提供 |
| 身份是静态的 | 身份是动态分配的 |
| 重启后还是同一台机器 | Stop/Start 后可能换了宿主机 |

> **注意**：本实验在 AWS EC2 上运行。GCP/Azure 有类似服务，地址不同（后面会讲）。  

**10 分钟内，你已经理解了云实例最核心的概念：元数据服务。**

---

## Step 2 — 发生了什么？云实例 vs 物理服务器（20 分钟）

### 2.1 虚拟化层：看不见的 Hypervisor

当你 SSH 进入一台 EC2 实例时，你以为自己在操作一台"服务器"。但实际上：

```
┌─────────────────────────────────────────────────────────────────────────┐
│                     AWS 物理主机 (Bare Metal)                            │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                 Nitro Hypervisor (看不见)                        │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │   │
│  │  │  EC2 实例 A  │  │  EC2 实例 B  │  │  EC2 实例 C  │          │   │
│  │  │  (你的机器)  │  │  (其他客户)  │  │  (其他客户)  │          │   │
│  │  │             │  │             │  │             │          │   │
│  │  │  ┌───────┐  │  │  ┌───────┐  │  │  ┌───────┐  │          │   │
│  │  │  │ Linux │  │  │  │ Linux │  │  │  │Windows│  │          │   │
│  │  │  └───────┘  │  │  └───────┘  │  │  └───────┘  │          │   │
│  │  └──────────────┘  └──────────────┘  └──────────────┘          │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                        │
│  ┌──────────────────────────────────────────────────────────────────┐ │
│  │ 物理硬件：CPU、内存、网卡、存储控制器...                          │ │
│  └──────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────┘
```

**这意味着什么？**

- 你的 Linux 内核以为它在直接管理硬件，实际上它管理的是**虚拟设备**
- 磁盘不是物理磁盘，而是 EBS 卷（通过网络连接的块存储）
- 网卡不是物理网卡，而是 ENI（虚拟网络接口）
- 重启时，实例可能被迁移到不同的物理主机

**验证你在虚拟化环境中：**

```bash
dmidecode -s system-product-name 2>/dev/null || cat /sys/class/dmi/id/product_name
```

```
Amazon EC2
```

### 2.2 存储分离：根卷 vs 数据卷

物理服务器的磁盘是固定在机箱里的。云实例的存储是**分离的**：

```
传统物理服务器                     云实例 (EC2)
─────────────────                 ─────────────────
┌─────────────────┐               ┌─────────────────┐
│    服务器机箱    │               │   EC2 实例      │
│  ┌───────────┐  │               │                 │
│  │   CPU     │  │               │   vCPU (共享)   │
│  │   内存    │  │               │   Memory        │
│  │   ┌─────┐ │  │               │                 │
│  │   │ HDD │ │  │               └────────┬────────┘
│  │   │ SSD │ │  │                        │ 网络连接
│  │   └─────┘ │  │                        ▼
│  └───────────┘  │               ┌─────────────────┐
│                 │               │   EBS 卷        │
│  磁盘物理连接   │               │  (网络块存储)   │
└─────────────────┘               │  ┌───────────┐  │
                                  │  │ 根卷 8GB  │  │
                                  │  │ 数据卷    │  │
                                  │  └───────────┘  │
                                  └─────────────────┘
```

**关键区别**：

| 传统服务器 | 云实例 |
|------------|--------|
| 磁盘 I/O 延迟 ~0.1ms | EBS I/O 延迟 ~0.5-1ms |
| 磁盘故障 = 服务器故障 | EBS 卷独立于实例 |
| 扩容需要物理操作 | 在线扩容（但需要文件系统操作） |
| 备份需要停机 | 快照随时可做 |

**查看你的块设备：**

```bash
lsblk
```

```
NAME          MAJ:MIN RM  SIZE RO TYPE MOUNTPOINTS
nvme0n1       259:0    0    8G  0 disk
├─nvme0n1p1   259:1    0    8G  0 part /
├─nvme0n1p127 259:2    0    1M  0 part
└─nvme0n1p128 259:3    0   10M  0 part /boot/efi
```

> **注意**：`nvme0n1` 不是物理 NVMe 设备，而是 EBS 卷通过 Nitro 虚拟化呈现的设备。  

### 2.3 网络虚拟化：ENI、安全组

物理服务器插网线到交换机。云实例的网络完全是虚拟的：

```
物理网络                          云网络 (VPC)
─────────                         ────────────
                                  ┌─────────────────────────────────┐
                                  │            VPC                  │
┌─────────┐                       │  ┌──────────────────────────┐  │
│ 交换机  │                       │  │ 安全组 (虚拟防火墙)      │  │
│ ┌─────┐ │                       │  │ - 入站规则               │  │
│ │端口1│─┼─ 网线 ─► 服务器A      │  │ - 出站规则               │  │
│ │端口2│─┼─ 网线 ─► 服务器B      │  └───────────┬──────────────┘  │
│ └─────┘ │                       │              │                  │
└─────────┘                       │  ┌───────────▼──────────────┐  │
                                  │  │         ENI              │  │
                                  │  │ (Elastic Network Interface)│ │
                                  │  │ - 私有 IP: 10.0.1.52     │  │
                                  │  │ - MAC 地址               │  │
                                  │  │ - 安全组绑定             │  │
                                  │  └───────────┬──────────────┘  │
                                  │              │                  │
                                  │  ┌───────────▼──────────────┐  │
                                  │  │       EC2 实例           │  │
                                  │  │   eth0 ← 这就是 ENI      │  │
                                  │  └──────────────────────────┘  │
                                  └─────────────────────────────────┘
```

**查看你的网络接口：**

```bash
ip addr show eth0
```

```
2: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 9001 qdisc mq state UP
    link/ether 0a:1b:2c:3d:4e:5f brd ff:ff:ff:ff:ff:ff
    inet 10.0.1.52/24 brd 10.0.1.255 scope global dynamic eth0
```

> **注意 MTU 9001**：这是 AWS 的 Jumbo Frames，物理以太网通常是 1500。这个区别会在网络课程中详细讨论。  

### 2.4 身份与凭证：不再是本地账户

物理服务器上，你创建用户、设置密码、管理 SSH 密钥。

云实例上，身份来自多个来源：

```
┌─────────────────────────────────────────────────────────────────────┐
│                      身份与凭证来源                                   │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  1. SSH 密钥对 (实例启动时注入)                                      │
│     - EC2 Key Pair                                                  │
│     - 存储在 ~/.ssh/authorized_keys                                 │
│                                                                     │
│  2. IAM 实例配置文件 (Instance Profile)                             │
│     - 附加 IAM 角色到实例                                           │
│     - 通过元数据服务提供临时凭证                                     │
│     - 自动轮换，无需管理                                            │
│                                                                     │
│  3. SSM Session Manager (无需 SSH)                                  │
│     - IAM 权限控制                                                  │
│     - 有审计日志                                                    │
│     - 不需要开放 22 端口                                            │
│                                                                     │
│  4. EC2 Instance Connect (临时 SSH)                                 │
│     - 一次性 SSH 公钥                                               │
│     - 通过 AWS API 注入                                             │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

**这是云安全的核心转变**：

| 传统方式 | 云方式 |
|----------|--------|
| 在服务器上创建用户 | 使用 IAM 管理身份 |
| 密码/密钥存储在服务器 | 凭证动态获取 |
| 权限在 OS 层配置 | 权限在 IAM 层配置 |
| 审计靠日志采集 | 审计内置 (CloudTrail) |

---

## Step 3 — 云实例生命周期（15 分钟）

### 3.1 生命周期状态

物理服务器：开机 → 运行 → 关机。

云实例的生命周期更复杂：

```
                      ┌─────────────┐
           ┌─────────►│   pending   │
           │          └──────┬──────┘
           │                 │ 启动完成
    Launch │                 ▼
           │          ┌─────────────┐
           │      ┌───│   running   │◄──────────────┐
           │      │   └──────┬──────┘               │
           │      │          │                      │
           │      │    Stop  │                Start │
           │      │          ▼                      │
           │      │   ┌─────────────┐               │
           │      │   │  stopping   │               │
           │      │   └──────┬──────┘               │
           │      │          │                      │
           │      │          ▼                      │
           │      │   ┌─────────────┐               │
           │      │   │   stopped   │───────────────┘
           │      │   └──────┬──────┘
           │      │          │
           │      │ Terminate│ Terminate
           │      │          ▼
           │      │   ┌─────────────┐
           │      └──►│ terminated  │
           │          └─────────────┘
           │                 │
           │                 ▼
           │          ┌─────────────┐
           └──────────│  (已销毁)    │
                      └─────────────┘
```

### 3.2 Stop/Start 的真相：你可能换了宿主机

**这是最重要的概念之一**：

当你 Stop 再 Start 一个 EC2 实例时：

```
Stop 之前                          Start 之后
─────────                          ──────────
物理主机 A                         物理主机 B (可能不同!)
┌─────────────────┐               ┌─────────────────┐
│  你的实例       │               │  你的实例       │
│  ┌───────────┐  │               │  ┌───────────┐  │
│  │  根卷     │  │               │  │  根卷     │◄─┼─── 同一个 EBS
│  │  /dev/xvda│  │               │  │  /dev/xvda│  │
│  └─────┬─────┘  │               │  └─────┬─────┘  │
└────────┼────────┘               └────────┼────────┘
         │                                 │
         ▼                                 ▼
    EBS 存储层 ════════════════════ EBS 存储层
```

**影响**：

| 保持不变 | 可能改变 |
|----------|----------|
| EBS 卷数据 | 公有 IP（除非用 Elastic IP） |
| ENI 和私有 IP | Instance Store 数据（如果有） |
| 安全组配置 | 底层物理主机 |
| 实例 ID | 某些硬件特性 |

**验证命令**（记录 Stop 前后对比）：

```bash
# 查看底层主机 ID（如果可见）
cat /sys/devices/virtual/dmi/id/product_serial 2>/dev/null || echo "Not visible"

# 查看启动时间
uptime -s
```

### 3.3 Instance Store vs EBS：重启后的数据

```
Instance Store (临时存储)              EBS (持久存储)
───────────────────────               ──────────────────
┌─────────────────────┐               ┌─────────────────┐
│ 物理主机本地 SSD    │               │ 网络块存储      │
│                     │               │                 │
│ - 极低延迟          │               │ - 略高延迟      │
│ - 极高 IOPS         │               │ - 可靠持久      │
│ - Stop 后数据丢失！ │               │ - Stop 后保留   │
│ - 实例终止后丢失    │               │ - 可独立存在    │
│                     │               │ - 可做快照      │
│ 用途：缓存、临时文件│               │ 用途：系统盘、  │
│                     │               │       数据库    │
└─────────────────────┘               └─────────────────┘
```

**检查你是否有 Instance Store**：

```bash
# 列出实例存储设备（如果有）
lsblk | grep -v nvme0  # 排除根卷
```

> **规则**：永远不要把重要数据放在 Instance Store 上，除非你已经设计了备份机制。  

### 3.4 Spot 实例中断：随时可能消失

Spot 实例是利用 AWS 闲置容量的低价实例（最高节省 90%），但有代价：

```
┌───────────────────────────────────────────────────────────────────────┐
│                     Spot 实例生命周期                                  │
├───────────────────────────────────────────────────────────────────────┤
│                                                                       │
│  正常运行                         AWS 需要容量回收                     │
│  ─────────                        ─────────────────                   │
│  ┌─────────────┐                  ┌─────────────┐                     │
│  │  Spot 实例  │  ══ 2 分钟警告 ══►│  terminated │                     │
│  │   running   │                  │  (被中断)   │                     │
│  └─────────────┘                  └─────────────┘                     │
│                                                                       │
│  检测中断警告：                                                        │
│  curl -s http://169.254.169.254/latest/meta-data/spot/termination-time│
│                                                                       │
│  返回空 = 安全                                                        │
│  返回时间 = 即将被终止                                                 │
│                                                                       │
└───────────────────────────────────────────────────────────────────────┘
```

**应用设计启示**：

- Spot 实例适合无状态、可中断的工作负载
- 应用需要能够处理突然终止
- 使用 Spot Fleet 或混合实例策略提高可用性

---

## Step 4 — 云端调试心态（15 分钟）

### 4.1 没有物理访问：告别 Serial Console（大部分情况）

物理服务器出问题时：

```
┌─────────────────────────────────────────────────────────────────────┐
│ 物理服务器排障                                                       │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  1. SSH 不通？                                                      │
│     → 走到机房，接显示器键盘                                        │
│                                                                     │
│  2. 系统不启动？                                                    │
│     → 看 POST 信息，进 GRUB 单用户模式                              │
│                                                                     │
│  3. 网络配置错了？                                                  │
│     → 本地 console 修复                                             │
│                                                                     │
│  4. fstab 写错了？                                                  │
│     → 单用户模式修复                                                │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

云实例出问题时：

```
┌─────────────────────────────────────────────────────────────────────┐
│ 云实例排障                                                           │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  1. SSH 不通？                                                      │
│     → 检查安全组、NACL                                              │
│     → SSM Session Manager（如果配置了）                             │
│     → EC2 Serial Console（需要预先配置）                            │
│                                                                     │
│  2. 系统不启动？                                                    │
│     → 查看系统日志（Console Output）                                │
│     → 救援实例模式                                                  │
│                                                                     │
│  3. 网络配置错了？                                                  │
│     → 无法直接修复（没有本地 console）                              │
│     → 救援实例挂载根卷修复                                          │
│                                                                     │
│  4. fstab 写错了？                                                  │
│     → 实例无法启动                                                  │
│     → 救援实例挂载修复                                              │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 4.2 系统日志 vs 实例日志

```
查看系统启动日志（从 AWS 控制台或 CLI）
──────────────────────────────────────────
aws ec2 get-console-output --instance-id i-xxxxx --query 'Output' --output text
```

这会显示类似物理服务器串口输出的内容 — 包括内核启动、cloud-init 执行等。

### 4.3 元数据作为信息源

当你在排障时，元数据服务是你的好帮手：

```bash
# 我是什么类型的实例？
curl -s http://169.254.169.254/latest/meta-data/instance-type

# 我有什么 IAM 权限？
curl -s http://169.254.169.254/latest/meta-data/iam/info

# 我的用户数据是什么？（启动时执行的脚本）
curl -s http://169.254.169.254/latest/user-data

# 我是 Spot 实例吗？是否即将被终止？
curl -s http://169.254.169.254/latest/meta-data/instance-life-cycle
curl -s http://169.254.169.254/latest/meta-data/spot/termination-time
```

### 4.4 不可变基础设施思维

**传统思维**：服务器坏了 → 修复它

**云原生思维**：服务器坏了 → 销毁它，启动新的

```
传统运维                             云原生运维
────────                             ──────────
┌─────────────┐                     ┌─────────────┐
│ 服务器出问题 │                     │ 实例出问题  │
└──────┬──────┘                     └──────┬──────┘
       │                                   │
       ▼                                   ▼
┌─────────────┐                     ┌─────────────┐
│ SSH 进去修  │                     │ 终止实例    │
└──────┬──────┘                     └──────┬──────┘
       │                                   │
       ▼                                   ▼
┌─────────────┐                     ┌─────────────┐
│ 祈祷能修好  │                     │ 从 AMI 启动 │
└──────┬──────┘                     │ 新实例      │
       │                            └──────┬──────┘
       ▼                                   │
┌─────────────┐                            ▼
│ 配置漂移... │                     ┌─────────────┐
└─────────────┘                     │ 状态一致    │
                                    └─────────────┘
```

**这就是为什么本课程会教你**：

- 如何创建可靠的金色镜像（AMI）
- 如何使用 cloud-init 自动化配置
- 如何确保实例是可替换的

---

## Step 5 — 动手实验：探索云实例环境（20 分钟）

### Lab 1：对比云实例与传统服务器

**检查虚拟化类型：**

```bash
dmidecode -s system-product-name 2>/dev/null || cat /sys/class/dmi/id/product_name
```

**预期输出**：`Amazon EC2` 或类似的虚拟化标识。

**检查块设备拓扑：**

```bash
lsblk -f
```

**观察**：
- 设备名可能是 `nvme0n1`（NVMe）或 `xvda`（旧式）
- 文件系统类型（xfs 或 ext4）
- 挂载点

**检查网络路由：**

```bash
ip route
```

**观察**：
- 默认网关指向 VPC 路由器
- 子网路由

**测试元数据服务可达性：**

```bash
# 测试连通性
curl -s --connect-timeout 2 http://169.254.169.254/ && echo "Metadata service reachable"

# 这个地址只在云实例内部可达
# 在物理服务器或本地虚拟机上会超时
```

### Lab 2：元数据深度探索

**列出所有可用的元数据：**

```bash
# 递归列出（简化版）
for category in ami-id instance-id instance-type local-ipv4 placement/availability-zone; do
    echo "=== $category ==="
    curl -s http://169.254.169.254/latest/meta-data/$category
    echo
done
```

**获取实例身份文档并解析：**

```bash
curl -s http://169.254.169.254/latest/dynamic/instance-identity/document | python3 -m json.tool
```

**查看用户数据（如果有）：**

```bash
curl -s http://169.254.169.254/latest/user-data 2>/dev/null || echo "No user-data"
```

### Lab 3：凭证探索（IAM 角色）

如果实例附加了 IAM 角色：

```bash
# 列出角色名
ROLE=$(curl -s http://169.254.169.254/latest/meta-data/iam/security-credentials/)
echo "Role: $ROLE"

# 获取临时凭证（注意：这会显示真实凭证，谨慎使用）
curl -s http://169.254.169.254/latest/meta-data/iam/security-credentials/$ROLE | head -10
```

**观察**：
- `AccessKeyId`：临时访问密钥
- `SecretAccessKey`：临时密钥
- `Token`：会话令牌
- `Expiration`：过期时间（通常 6 小时）

> **安全提示**：这些凭证是临时的，会自动轮换。这就是为什么实例配置文件比硬编码凭证更安全。  

---

## Step 6 — 课程预览（10 分钟）

本课程将涵盖云端 Linux 的核心主题：

### 课程路线图

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        LX12-CLOUD 课程结构                               │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  01. 云中 Linux：有何不同？ ◄──── 你现在在这里                          │
│      └─ 物理 vs 云、生命周期、调试心态                                  │
│                                                                         │
│  02. cloud-init 启动流程                                                │
│      └─ 四个阶段、user-data、调试启动失败                               │
│                                                                         │
│  03. 元数据服务与 IMDSv2                                                │
│      └─ 169.254.169.254、token 机制、SSRF 防护                          │
│                                                                         │
│  04. 云网络：Linux 视角                                                 │
│      └─ 安全组 vs nftables、MTU、多 ENI 路由                            │
│                                                                         │
│  05. 云存储：EBS 与持久化                                               │
│      └─ 扩容流程、by-uuid 挂载、救援实例                                │
│                                                                         │
│  06. IAM 与实例配置文件                                                 │
│      └─ 凭证链、最小权限、AssumeRole                                    │
│                                                                         │
│  07. 金色镜像策略                                                       │
│      └─ Bake vs Bootstrap、Packer、machine-id 清理                      │
│                                                                         │
│  08. 镜像加固与供应链安全                                               │
│      └─ CIS Benchmark、OpenSCAP、补丁管理                               │
│                                                                         │
│  09. 可观测性集成                                                       │
│      └─ CloudWatch Agent、日志导出、事故响应                            │
│                                                                         │
│  10. Capstone：不可变金色镜像管道                                       │
│      └─ 综合项目：构建生产级镜像管道                                    │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 每课学习什么

| 课程 | 核心问题 | 你会学到 |
|------|----------|----------|
| 02 | "为什么实例启动后服务没起来？" | cloud-init 日志分析、幂等脚本 |
| 03 | "为什么脚本在新实例上报 401？" | IMDSv2 token、SSRF 防护 |
| 04 | "为什么 ss 显示监听但连不上？" | 安全组 + nftables 双层、MTU |
| 05 | "为什么扩容了 EBS 还是磁盘满？" | growpart + xfs_growfs |
| 06 | "为什么不应该硬编码 AWS 凭证？" | 实例配置文件、凭证链 |
| 07 | "为什么从运行实例创建的镜像有问题？" | machine-id 清理、sysprep |
| 08 | "如何证明镜像符合安全基线？" | CIS 扫描、合规报告 |
| 09 | "服务器挂了怎么收集证据？" | CloudWatch Agent、证据保全 |
| 10 | "如何构建生产级镜像管道？" | 综合应用所有知识 |

---

## 多云视角

虽然本课程以 AWS 为主，但核心概念在所有云平台通用：

| 概念 | AWS | GCP | Azure |
|------|-----|-----|-------|
| 虚拟机 | EC2 | Compute Engine | Virtual Machines |
| 块存储 | EBS | Persistent Disk | Managed Disks |
| 虚拟网络 | VPC | VPC | VNet |
| 元数据服务 | 169.254.169.254 | 169.254.169.254 | 169.254.169.254 |
| 实例身份 | Instance Profile | Service Account | Managed Identity |
| 初始化工具 | cloud-init | cloud-init | cloud-init |

**核心原则相同**：

- 计算与存储分离
- 网络虚拟化
- 元数据驱动的身份
- 不可变基础设施思维

---

## 职场小贴士

### 日本 IT 常用术语

| 日本語 | 中文 | 使用场景 |
|--------|------|----------|
| クラウド移行 | 云迁移 | "クラウド移行プロジェクトのLinux担当です" |
| オンプレミス | 本地部署 | "オンプレとクラウドの違いを説明してください" |
| 障害対応 | 故障处理 | 理解云与物理的区别对故障处理至关重要 |
| インスタンス | 实例 | EC2 实例的日语说法 |
| ゴールデンイメージ | 金色镜像 | 预先配置好的标准镜像 |

### 日本企业的云迁移现状

日本企业的クラウド移行（云迁移）有几个特点：

1. **谨慎渐进**：不会一次性全部迁移，通常是逐步迁移
2. **混合架构常见**：オンプレミス + クラウド 的混合架构很普遍
3. **合规要求高**：特别是金融（FISC）、政府（ISMAP）有严格要求
4. **重视文档**：设计书（設計書）、运维手册（運用手順書）必须完整

**为什么理解云与物理的区别对障害対応很重要？**

当发生故障时，你的第一反应不能是"去机房看看"或"接显示器调试"。你需要：

- 检查 CloudWatch 日志和指标
- 使用 SSM 或 Serial Console
- 准备使用救援实例
- 在重启前保存证据（快照、日志）

---

## 本课小结

| 你学到的 | 核心概念 |
|----------|----------|
| 云实例与物理服务器的区别 | 虚拟化层、存储分离、网络虚拟化 |
| 元数据服务 | 169.254.169.254、实例身份、动态凭证 |
| 实例生命周期 | pending → running → stopped → terminated |
| Stop/Start 真相 | 可能换宿主机，EBS 保留，Instance Store 丢失 |
| 云端调试心态 | 没有物理访问，需要新方法 |

**核心转变**：

```
物理服务器思维                      云实例思维
──────────────                      ────────────
服务器是宠物                        实例是牲畜
手动修复                            自动替换
配置漂移                            不可变基础设施
硬编码凭证                          动态凭证
依赖物理访问                        依赖自动化
```

---

## 检查清单

在继续下一课之前，确认你能：

- [ ] 访问元数据服务获取实例 ID、类型、区域信息
- [ ] 解释云实例与物理服务器在存储、网络、身份方面的区别
- [ ] 说明 Stop/Start 与 Reboot 的区别以及对数据的影响
- [ ] 列出 Instance Store 和 EBS 的区别及使用场景
- [ ] 解释为什么云端需要不同的调试方法
- [ ] 理解元数据服务在实例自我发现中的作用

---

## 延伸阅读

- [Amazon EC2 Instance Metadata](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-metadata.html) - AWS 官方文档
- [EC2 Instance Lifecycle](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-lifecycle.html) - 实例生命周期详解
- [Instance Store vs EBS](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/Storage.html) - 存储类型对比

---

## 下一步

你已经理解了云端 Linux 的独特之处。接下来，让我们深入 cloud-init — 了解实例启动时发生了什么，以及如何调试那些"沉默的启动失败"。

--> [02 · cloud-init 启动流程](../02-cloud-init/)

---

## 系列导航

<- [课程首页](../) | [Home](/) | [02 · cloud-init 启动流程 ->](../02-cloud-init/)
