# 07 - é‡‘è‰²é•œåƒç­–ç•¥ï¼ˆGolden Image Strategyï¼‰

> **ç›®æ ‡**ï¼šç†è§£ Bake vs Bootstrap å†³ç­–æ¡†æ¶ï¼ŒæŒæ¡ Packer åŸºç¡€å’Œé•œåƒæ¸…ç†è§„èŒƒ  
> **å‰ç½®**ï¼š[06 - IAM ä¸å®ä¾‹é…ç½®æ–‡ä»¶](../06-iam-instance-profiles/)ã€[02 - cloud-init å¯åŠ¨æµç¨‹](../02-cloud-init/)  
> **æ—¶é—´**ï¼šâš¡ 40 åˆ†é’Ÿï¼ˆé€Ÿè¯»ï¼‰/ ğŸ”¬ 150 åˆ†é’Ÿï¼ˆå®Œæ•´å®æ“ï¼‰  
> **å®æˆ˜åœºæ™¯**ï¼šGhost Identity èº«ä»½å†²çªã€Configuration Audit é…ç½®å®¡è®¡  

---

## å°†å­¦åˆ°çš„å†…å®¹

1. ç†è§£ Bake vs Bootstrap å†³ç­–æ¡†æ¶ï¼ˆä½•æ—¶é¢„è£…ï¼Œä½•æ—¶åŠ¨æ€é…ç½®ï¼‰
2. æŒæ¡ Packer åŸºç¡€æ„å»ºé‡‘è‰²é•œåƒ
3. æ­£ç¡®æ¸…ç†é•œåƒå‰çš„çŠ¶æ€ï¼ˆmachine-idã€SSH keys ç­‰ï¼‰
4. å»ºç«‹é•œåƒç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼ˆç‰ˆæœ¬ã€æµ‹è¯•ã€å‘å¸ƒã€å¼ƒç”¨ï¼‰
5. äº†è§£ 2025 å¹´é•œåƒæ„å»ºè¶‹åŠ¿ï¼ˆEC2 Image Builderã€ARM64/Gravitonï¼‰

---

## å…ˆè·‘èµ·æ¥ï¼ï¼ˆ10 åˆ†é’Ÿï¼‰

> åœ¨å­¦ä¹ é‡‘è‰²é•œåƒç†è®ºä¹‹å‰ï¼Œå…ˆæ£€æŸ¥ä½ å½“å‰å®ä¾‹çš„"é•œåƒå‡†å¤‡åº¦"ã€‚  

åœ¨ä»»æ„ EC2 å®ä¾‹ä¸Šè¿è¡Œï¼š

### æ£€æŸ¥å®ä¾‹çš„å”¯ä¸€æ ‡è¯†ç¬¦

```bash
# machine-idï¼šç³»ç»Ÿå”¯ä¸€æ ‡è¯†ç¬¦
cat /etc/machine-id

# è¿™ä¸ª ID å¯¹ä½ çš„å®ä¾‹å”¯ä¸€å—ï¼Ÿ
# å¦‚æœä»è¿™ä¸ªå®ä¾‹åˆ›å»º AMIï¼Œæ‰€æœ‰æ–°å®ä¾‹éƒ½ä¼šç»§æ‰¿è¿™ä¸ª IDï¼
```

```
a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6
```

### æ£€æŸ¥ SSH Host Keys

```bash
# SSH æœåŠ¡å™¨çš„"æŒ‡çº¹"
ls -la /etc/ssh/ssh_host_*

# è¿™äº›å¯†é’¥ç”¨äºéªŒè¯æœåŠ¡å™¨èº«ä»½
# å¦‚æœå¤šä¸ªå®ä¾‹æœ‰ç›¸åŒçš„å¯†é’¥ = å®‰å…¨é£é™©ï¼
```

```
-rw-r----- 1 root ssh_keys  480 Jan  1 12:00 /etc/ssh/ssh_host_ecdsa_key
-rw-r--r-- 1 root root      162 Jan  1 12:00 /etc/ssh/ssh_host_ecdsa_key.pub
-rw-r----- 1 root ssh_keys  387 Jan  1 12:00 /etc/ssh/ssh_host_ed25519_key
-rw-r--r-- 1 root root       82 Jan  1 12:00 /etc/ssh/ssh_host_ed25519_key.pub
-rw-r----- 1 root ssh_keys 2590 Jan  1 12:00 /etc/ssh/ssh_host_rsa_key
-rw-r--r-- 1 root root      554 Jan  1 12:00 /etc/ssh/ssh_host_rsa_key.pub
```

### æ£€æŸ¥å‘½ä»¤å†å²

```bash
# ä½ çš„æ“ä½œè®°å½•
wc -l ~/.bash_history 2>/dev/null || echo "No history file"

# å†å²è®°å½•å¯èƒ½åŒ…å«æ•æ„Ÿä¿¡æ¯ï¼ˆå¯†ç ã€token ç­‰ï¼‰
# é•œåƒå‰å¿…é¡»æ¸…é™¤ï¼
```

### å¿«é€Ÿé•œåƒå‡†å¤‡åº¦æ£€æŸ¥

```bash
# ä¸€é”®æ£€æŸ¥é•œåƒå‡†å¤‡çŠ¶æ€
echo "=== é•œåƒå‡†å¤‡åº¦æ£€æŸ¥ ==="

echo -n "machine-id: "
if [ -s /etc/machine-id ]; then
    echo "è­¦å‘Š - éœ€è¦æ¸…é™¤ ($(cat /etc/machine-id | head -c 8)...)"
else
    echo "OK - å·²æ¸…é™¤æˆ–ä¸ºç©º"
fi

echo -n "SSH host keys: "
if ls /etc/ssh/ssh_host_* 2>/dev/null | head -1 > /dev/null; then
    echo "è­¦å‘Š - $(ls /etc/ssh/ssh_host_* 2>/dev/null | wc -l) ä¸ªå¯†é’¥æ–‡ä»¶å­˜åœ¨"
else
    echo "OK - å·²æ¸…é™¤"
fi

echo -n "bash_history: "
if [ -s ~/.bash_history ]; then
    echo "è­¦å‘Š - $(wc -l < ~/.bash_history) è¡Œå†å²è®°å½•"
else
    echo "OK - æ— å†å²è®°å½•"
fi

echo -n "cloud-init: "
if [ -f /var/lib/cloud/instance/boot-finished ]; then
    echo "è­¦å‘Š - cloud-init çŠ¶æ€å­˜åœ¨ï¼Œæ–°å®ä¾‹å¯èƒ½è·³è¿‡åˆå§‹åŒ–"
else
    echo "OK - æ—  cloud-init çŠ¶æ€"
fi
```

---

**ä½ åˆšåˆšçœ‹åˆ°äº†åˆ›å»ºé‡‘è‰²é•œåƒå‰éœ€è¦æ³¨æ„çš„å…³é”®çŠ¶æ€ã€‚** å¦‚æœä¸æ¸…ç†è¿™äº›çŠ¶æ€ï¼Œä»è¿™ä¸ªå®ä¾‹åˆ›å»ºçš„æ‰€æœ‰æ–°å®ä¾‹éƒ½ä¼šæœ‰ç›¸åŒçš„ machine-idã€ç›¸åŒçš„ SSH å¯†é’¥ã€ç›¸åŒçš„å†å²è®°å½•ã€‚è¿™å°±æ˜¯"Ghost Identity"é—®é¢˜çš„æ ¹æºã€‚

---

## Step 1 - Bake vs Bootstrap å†³ç­–æ¡†æ¶ï¼ˆ25 åˆ†é’Ÿï¼‰

### 1.1 ä¸¤ç§æç«¯æ¨¡å¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Bake vs Bootstrap å¯¹æ¯”                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚                    Pure Bakeï¼ˆçº¯é¢„è£…æ¨¡å¼ï¼‰                            â”‚  â”‚
â”‚   â”‚                                                                     â”‚  â”‚
â”‚   â”‚   AMI åŒ…å«ä¸€åˆ‡ï¼šOS + è½¯ä»¶ + é…ç½® + åº”ç”¨ä»£ç                           â”‚  â”‚
â”‚   â”‚                                                                     â”‚  â”‚
â”‚   â”‚   å¯åŠ¨æ—¶é—´ï¼šç§’çº§ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º         â”‚  â”‚
â”‚   â”‚   çµæ´»æ€§ï¼š  ä½ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º         â”‚  â”‚
â”‚   â”‚   é•œåƒå¤§å°ï¼šå¤§ï¼ˆåŒ…å«æ‰€æœ‰ä¾èµ–ï¼‰                                       â”‚  â”‚
â”‚   â”‚   æ›´æ–°é¢‘ç‡ï¼šé«˜ï¼ˆæ¯æ¬¡ä»£ç å˜æ›´éƒ½è¦é‡å»ºé•œåƒï¼‰                            â”‚  â”‚
â”‚   â”‚                                                                     â”‚  â”‚
â”‚   â”‚   é€‚ç”¨åœºæ™¯ï¼š                                                        â”‚  â”‚
â”‚   â”‚   â— å¯åŠ¨é€Ÿåº¦å…³é”®ï¼ˆASG å¿«é€Ÿæ‰©å®¹ï¼‰                                     â”‚  â”‚
â”‚   â”‚   â— ç¯å¢ƒä¸€è‡´æ€§è¦æ±‚é«˜                                                â”‚  â”‚
â”‚   â”‚   â— åº”ç”¨æ›´æ–°é¢‘ç‡ä½                                                  â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚                    Pure Bootstrapï¼ˆçº¯åŠ¨æ€æ¨¡å¼ï¼‰                       â”‚  â”‚
â”‚   â”‚                                                                     â”‚  â”‚
â”‚   â”‚   AMI åªæœ‰åŸºç¡€ OSï¼Œå¯åŠ¨æ—¶é€šè¿‡ user-data å®‰è£…ä¸€åˆ‡                     â”‚  â”‚
â”‚   â”‚                                                                     â”‚  â”‚
â”‚   â”‚   å¯åŠ¨æ—¶é—´ï¼šåˆ†é’Ÿçº§ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º          â”‚  â”‚
â”‚   â”‚   çµæ´»æ€§ï¼š  é«˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º          â”‚  â”‚
â”‚   â”‚   é•œåƒå¤§å°ï¼šå°ï¼ˆåªæœ‰ OSï¼‰                                            â”‚  â”‚
â”‚   â”‚   æ›´æ–°é¢‘ç‡ï¼šä½ï¼ˆä¿®æ”¹ user-data å³å¯ï¼‰                                â”‚  â”‚
â”‚   â”‚                                                                     â”‚  â”‚
â”‚   â”‚   é€‚ç”¨åœºæ™¯ï¼š                                                        â”‚  â”‚
â”‚   â”‚   â— å¼€å‘/æµ‹è¯•ç¯å¢ƒ                                                   â”‚  â”‚
â”‚   â”‚   â— å¿«é€Ÿè¿­ä»£é˜¶æ®µ                                                    â”‚  â”‚
â”‚   â”‚   â— å¯åŠ¨æ—¶é—´ä¸æ•æ„Ÿ                                                  â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 æ¨èï¼šæ··åˆæ¨¡å¼ï¼ˆHybridï¼‰

å®è·µä¸­ï¼Œæœ€ä½³æ–¹æ¡ˆæ˜¯ **Bake åŸºç¡€ + Bootstrap é…ç½®**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ··åˆæ¨¡å¼ï¼šBake åŸºç¡€ + Bootstrap é…ç½®                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚   AMIï¼ˆBake éƒ¨åˆ†ï¼‰                                                          â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚  æ“ä½œç³»ç»Ÿ                                                            â”‚  â”‚
â”‚   â”‚  å®‰å…¨è¡¥ä¸                                                            â”‚  â”‚
â”‚   â”‚  åŸºç¡€è½¯ä»¶åŒ…ï¼ˆnginx, java, python...ï¼‰                                â”‚  â”‚
â”‚   â”‚  ç›‘æ§ Agentï¼ˆCloudWatch Agentï¼‰                                      â”‚  â”‚
â”‚   â”‚  å®‰å…¨åŠ å›ºï¼ˆCIS Baselineï¼‰                                            â”‚  â”‚
â”‚   â”‚  æ—¥å¿—é…ç½®                                                            â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                           â”‚                                                â”‚
â”‚                           â”‚ å¯åŠ¨ï¼ˆç§’çº§ï¼‰                                   â”‚
â”‚                           â–¼                                                â”‚
â”‚   cloud-init / user-dataï¼ˆBootstrap éƒ¨åˆ†ï¼‰                                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚  ç¯å¢ƒå˜é‡é…ç½®                                                        â”‚  â”‚
â”‚   â”‚  ä» Secrets Manager è·å–å¯†é’¥                                         â”‚  â”‚
â”‚   â”‚  ä» S3 ä¸‹è½½é…ç½®æ–‡ä»¶                                                  â”‚  â”‚
â”‚   â”‚  æ³¨å†Œåˆ°æœåŠ¡å‘ç°                                                      â”‚  â”‚
â”‚   â”‚  å¯åŠ¨åº”ç”¨æœåŠ¡                                                        â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â”‚   ä¼˜åŠ¿ï¼š                                                                    â”‚
â”‚   âœ“ å¯åŠ¨é€Ÿåº¦å¿«ï¼ˆå¤§éƒ¨åˆ†å·²é¢„è£…ï¼‰                                             â”‚
â”‚   âœ“ é…ç½®çµæ´»ï¼ˆç¯å¢ƒå˜é‡/å¯†é’¥åŠ¨æ€è·å–ï¼‰                                      â”‚
â”‚   âœ“ é•œåƒæ›´æ–°é¢‘ç‡å¯æ§ï¼ˆåŸºç¡€è½¯ä»¶æ›´æ–°æ‰é‡å»ºï¼‰                                 â”‚
â”‚   âœ“ å®‰å…¨æ€§å¥½ï¼ˆå¯†é’¥ä¸åœ¨é•œåƒä¸­ï¼‰                                             â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.3 å†³ç­–æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Bake vs Bootstrap å†³ç­–æµç¨‹                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚                          éœ€è¦åœ¨é•œåƒä¸­åŒ…å«å—ï¼Ÿ                                 â”‚
â”‚                                 â”‚                                           â”‚
â”‚                                 â–¼                                           â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                             â”‚
â”‚                    â”‚  å¯åŠ¨åéœ€è¦æ›´æ–°å—ï¼Ÿ        â”‚                             â”‚
â”‚                    â”‚  ï¼ˆé…ç½®ã€å¯†é’¥ã€ä»£ç ï¼‰      â”‚                             â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                             â”‚
â”‚                         â”‚              â”‚                                   â”‚
â”‚                        YES            NO                                   â”‚
â”‚                         â”‚              â”‚                                   â”‚
â”‚                         â–¼              â–¼                                   â”‚
â”‚               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚               â”‚  Bootstrap   â”‚  â”‚    Bake      â”‚                          â”‚
â”‚               â”‚  (user-data) â”‚  â”‚   (AMI)      â”‚                          â”‚
â”‚               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚                                                                             â”‚
â”‚   Bakeï¼ˆé¢„è£…åˆ° AMIï¼‰:                Bootstrapï¼ˆå¯åŠ¨æ—¶é…ç½®ï¼‰:               â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                   â”‚
â”‚   â— æ“ä½œç³»ç»Ÿ                          â— ç¯å¢ƒå˜é‡                            â”‚
â”‚   â— å®‰å…¨è¡¥ä¸                          â— å¯†é’¥/å‡­è¯                           â”‚
â”‚   â— è¿è¡Œæ—¶ï¼ˆJava, Python...ï¼‰         â— é…ç½®æ–‡ä»¶                            â”‚
â”‚   â— åŸºç¡€è½¯ä»¶åŒ…                        â— åº”ç”¨ä»£ç ï¼ˆé¢‘ç¹æ›´æ–°æ—¶ï¼‰              â”‚
â”‚   â— ç›‘æ§ Agent                        â— æœåŠ¡å‘ç°æ³¨å†Œ                        â”‚
â”‚   â— å®‰å…¨åŠ å›ºé…ç½®                      â— åŠ¨æ€ä¸»æœºå                          â”‚
â”‚   â— æ—¥å¿—è½®è½¬é…ç½®                                                           â”‚
â”‚                                                                             â”‚
â”‚   ç»éªŒæ³•åˆ™ï¼š                                                                â”‚
â”‚   "å¦‚æœæ›´æ–°é¢‘ç‡ < é•œåƒæ„å»ºé¢‘ç‡ï¼Œå°± Bakeï¼›å¦åˆ™ Bootstrap"                   â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.4 å®é™…ä¾‹å­

**åœºæ™¯ï¼šWeb æœåŠ¡å™¨**

| ç»„ä»¶ | æ›´æ–°é¢‘ç‡ | å†³ç­– | åŸå›  |
|------|----------|------|------|
| Nginx | æœˆçº§ | Bake | å®‰å…¨è¡¥ä¸éšé•œåƒæ›´æ–° |
| SSL è¯ä¹¦ | 90 å¤© | Bootstrap | è¯ä¹¦è½®æ¢ä¸éœ€è¦é‡å»ºé•œåƒ |
| åº”ç”¨é…ç½® | å‘¨çº§ | Bootstrap | é…ç½®ä» S3/SSM åŠ¨æ€è·å– |
| åº”ç”¨ä»£ç  | æ—¥çº§ | Bootstrap* | ä» S3/CodeDeploy éƒ¨ç½² |
| CloudWatch Agent | æœˆçº§ | Bake | ç›‘æ§åŸºç¡€è®¾æ–½ |
| æ•°æ®åº“å¯†ç  | åŠ¨æ€ | Bootstrap | ä» Secrets Manager è·å– |

*æ³¨ï¼šå¦‚æœåº”ç”¨ä»£ç æ›´æ–°é¢‘ç‡é™ä½ï¼ˆæœˆçº§ï¼‰ï¼Œå¯ä»¥è€ƒè™‘ Bakeã€‚

---

## Step 2 - Packer åŸºç¡€ï¼ˆ30 åˆ†é’Ÿï¼‰

### 2.1 ä»€ä¹ˆæ˜¯ Packerï¼Ÿ

**Packer** æ˜¯ HashiCorp çš„å¼€æºé•œåƒæ„å»ºå·¥å…·ï¼Œæ”¯æŒå¤šäº‘å¹³å°ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Packer å·¥ä½œæµç¨‹                                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                         â”‚
â”‚   â”‚  Packer æ¨¡æ¿  â”‚  å®šä¹‰æ„å»ºé…ç½®ï¼ˆHCL2 æ ¼å¼ï¼‰                              â”‚
â”‚   â”‚  (.pkr.hcl)   â”‚                                                         â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                                         â”‚
â”‚           â”‚                                                                 â”‚
â”‚           â–¼                                                                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                         â”‚
â”‚   â”‚    Source     â”‚  é€‰æ‹©åŸºç¡€ AMIï¼ˆAmazon Linux, Ubuntu...ï¼‰                â”‚
â”‚   â”‚   (åŸºç¡€é•œåƒ)  â”‚                                                         â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                                         â”‚
â”‚           â”‚                                                                 â”‚
â”‚           â–¼                                                                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚   â”‚ Provisioner 1 â”‚â”€â”€â”€â”€â–¶â”‚ Provisioner 2 â”‚â”€â”€â”€â”€â–¶â”‚ Provisioner N â”‚            â”‚
â”‚   â”‚ (ç³»ç»Ÿæ›´æ–°)    â”‚     â”‚ (å®‰è£…è½¯ä»¶)    â”‚     â”‚ (æ¸…ç†çŠ¶æ€)    â”‚            â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚           â”‚                                                                 â”‚
â”‚           â–¼                                                                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                         â”‚
â”‚   â”‚Post-Processor â”‚  ç”Ÿæˆ manifestã€æ‰“æ ‡ç­¾ã€å¤åˆ¶åˆ°å…¶ä»–åŒºåŸŸ                  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                                         â”‚
â”‚           â”‚                                                                 â”‚
â”‚           â–¼                                                                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                         â”‚
â”‚   â”‚   è¾“å‡º AMI    â”‚  ami-0abc123def456789                                   â”‚
â”‚   â”‚               â”‚  web-server-2025-01-10-1234                              â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                         â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 Packer æ¨¡æ¿ç»“æ„ï¼ˆHCL2ï¼‰

```hcl
# web-server.pkr.hcl

# ===== Packer è®¾ç½® =====
packer {
  required_plugins {
    amazon = {
      version = ">= 1.2.0"
      source  = "github.com/hashicorp/amazon"
    }
  }
}

# ===== å˜é‡å®šä¹‰ =====
variable "aws_region" {
  type    = string
  default = "ap-northeast-1"
}

variable "instance_type" {
  type    = string
  default = "t3.micro"
}

variable "ami_name_prefix" {
  type    = string
  default = "web-server"
}

# ===== æ•°æ®æºï¼šæŸ¥æ‰¾æœ€æ–°çš„åŸºç¡€ AMI =====
data "amazon-ami" "amazon-linux-2023" {
  filters = {
    name                = "al2023-ami-*-x86_64"
    root-device-type    = "ebs"
    virtualization-type = "hvm"
  }
  most_recent = true
  owners      = ["amazon"]
  region      = var.aws_region
}

# ===== Sourceï¼šå®šä¹‰æ„å»ºæº =====
source "amazon-ebs" "web" {
  ami_name        = "${var.ami_name_prefix}-{{timestamp}}"
  ami_description = "Web server golden image"
  instance_type   = var.instance_type
  region          = var.aws_region
  source_ami      = data.amazon-ami.amazon-linux-2023.id
  ssh_username    = "ec2-user"

  # æ ‡ç­¾
  tags = {
    Name        = "${var.ami_name_prefix}-{{timestamp}}"
    Environment = "production"
    Builder     = "packer"
    BuildTime   = "{{timestamp}}"
  }

  # å¿«ç…§æ ‡ç­¾
  snapshot_tags = {
    Name = "${var.ami_name_prefix}-{{timestamp}}-snapshot"
  }
}

# ===== Buildï¼šæ„å»ºæ­¥éª¤ =====
build {
  sources = ["source.amazon-ebs.web"]

  # Step 1: ç³»ç»Ÿæ›´æ–°
  provisioner "shell" {
    inline = [
      "sudo dnf update -y",
      "sudo dnf install -y nginx"
    ]
  }

  # Step 2: å®‰è£… CloudWatch Agent
  provisioner "shell" {
    script = "scripts/install-cloudwatch-agent.sh"
  }

  # Step 3: ä¸Šä¼ é…ç½®æ–‡ä»¶
  provisioner "file" {
    source      = "configs/nginx.conf"
    destination = "/tmp/nginx.conf"
  }

  provisioner "shell" {
    inline = [
      "sudo mv /tmp/nginx.conf /etc/nginx/nginx.conf",
      "sudo systemctl enable nginx"
    ]
  }

  # Step 4: æ¸…ç†ï¼ˆSealï¼‰- å…³é”®ï¼
  provisioner "shell" {
    script = "scripts/seal.sh"
  }

  # Post-processor: ç”Ÿæˆ manifest
  post-processor "manifest" {
    output     = "manifest.json"
    strip_path = true
  }
}
```

### 2.3 Provisioner ç±»å‹

| Provisioner | ç”¨é€” | ç¤ºä¾‹ |
|-------------|------|------|
| `shell` | æ‰§è¡Œ shell å‘½ä»¤/è„šæœ¬ | å®‰è£…è½¯ä»¶ã€é…ç½®ç³»ç»Ÿ |
| `file` | ä¸Šä¼ æ–‡ä»¶ | é…ç½®æ–‡ä»¶ã€è„šæœ¬ |
| `ansible` | è¿è¡Œ Ansible playbook | å¤æ‚é…ç½®ç®¡ç† |
| `powershell` | Windows PowerShell | Windows é•œåƒ |

### 2.4 åŸºæœ¬ Packer å‘½ä»¤

```bash
# åˆå§‹åŒ–ï¼ˆä¸‹è½½æ’ä»¶ï¼‰
packer init web-server.pkr.hcl

# éªŒè¯æ¨¡æ¿
packer validate web-server.pkr.hcl

# æ ¼å¼åŒ–æ¨¡æ¿
packer fmt web-server.pkr.hcl

# æ„å»ºé•œåƒ
packer build web-server.pkr.hcl

# æ„å»ºå¹¶æŒ‡å®šå˜é‡
packer build -var "aws_region=us-east-1" web-server.pkr.hcl

# è°ƒè¯•æ¨¡å¼ï¼ˆæš‚åœåœ¨æ¯ä¸€æ­¥ï¼‰
packer build -debug web-server.pkr.hcl
```

---

## Step 3 - é•œåƒæ¸…ç†ï¼ˆSealï¼‰ï¼ˆ25 åˆ†é’Ÿï¼‰

### 3.1 ä¸ºä»€ä¹ˆéœ€è¦æ¸…ç†ï¼Ÿ

ä»è¿è¡Œä¸­çš„å®ä¾‹åˆ›å»º AMI æ—¶ï¼Œå®ä¾‹çš„**å”¯ä¸€çŠ¶æ€**ä¼šè¢«"çƒ˜çƒ¤"è¿›é•œåƒã€‚å¦‚æœä¸æ¸…ç†ï¼Œæ‰€æœ‰æ–°å®ä¾‹éƒ½ä¼šç»§æ‰¿è¿™äº›çŠ¶æ€ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    é•œåƒçŠ¶æ€æ±¡æŸ“é—®é¢˜                                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚   åŸå§‹å®ä¾‹                                                                   â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚  machine-id: a1b2c3d4...                                            â”‚  â”‚
â”‚   â”‚  SSH keys: /etc/ssh/ssh_host_*                                      â”‚  â”‚
â”‚   â”‚  history: 500 è¡Œå‘½ä»¤å†å²                                             â”‚  â”‚
â”‚   â”‚  logs: /var/log/* å……æ»¡æ—¥å¿—                                          â”‚  â”‚
â”‚   â”‚  cloud-init: å·²å®Œæˆé¦–æ¬¡å¯åŠ¨                                          â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                           â”‚                                                â”‚
â”‚                           â”‚ ç›´æ¥åˆ›å»º AMIï¼ˆä¸æ¸…ç†ï¼‰                          â”‚
â”‚                           â–¼                                                â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚   â”‚   å®ä¾‹ A        â”‚  â”‚   å®ä¾‹ B        â”‚  â”‚   å®ä¾‹ C        â”‚           â”‚
â”‚   â”‚ machine-id:     â”‚  â”‚ machine-id:     â”‚  â”‚ machine-id:     â”‚           â”‚
â”‚   â”‚ a1b2c3d4...     â”‚  â”‚ a1b2c3d4...     â”‚  â”‚ a1b2c3d4...     â”‚           â”‚
â”‚   â”‚ (ç›¸åŒ!)         â”‚  â”‚ (ç›¸åŒ!)         â”‚  â”‚ (ç›¸åŒ!)         â”‚           â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                                             â”‚
â”‚   é—®é¢˜ï¼š                                                                    â”‚
â”‚   â— DHCP å®¢æˆ·ç«¯ ID å†²çª                                                    â”‚
â”‚   â— ç›‘æ§å·¥å…·æ— æ³•åŒºåˆ†å®ä¾‹                                                   â”‚
â”‚   â— æ—¥å¿—èšåˆæ··ä¹±                                                           â”‚
â”‚   â— SSH ä¸»æœºå¯†é’¥ç›¸åŒ = å®‰å…¨é£é™©                                            â”‚
â”‚   â— cloud-init å¯èƒ½è·³è¿‡åˆå§‹åŒ–                                              â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 å¿…é¡»æ¸…ç†çš„é¡¹ç›®

| é¡¹ç›® | ä½ç½® | åŸå›  | æ¸…ç†å‘½ä»¤ |
|------|------|------|----------|
| **machine-id** | `/etc/machine-id` | ç³»ç»Ÿå”¯ä¸€æ ‡è¯†ç¬¦ï¼Œç”¨äº DHCPã€journald | `truncate -s 0 /etc/machine-id` |
| **SSH host keys** | `/etc/ssh/ssh_host_*` | æœåŠ¡å™¨èº«ä»½éªŒè¯ï¼Œåº”æ¯å®ä¾‹å”¯ä¸€ | `rm /etc/ssh/ssh_host_*` |
| **cloud-init çŠ¶æ€** | `/var/lib/cloud/` | é˜²æ­¢ cloud-init è·³è¿‡é¦–æ¬¡å¯åŠ¨ | `cloud-init clean` |
| **å‘½ä»¤å†å²** | `~/.bash_history` | å¯èƒ½åŒ…å«æ•æ„Ÿä¿¡æ¯ | `rm ~/.bash_history` |
| **æ—¥å¿—æ–‡ä»¶** | `/var/log/*` | å‡å°é•œåƒä½“ç§¯ï¼Œé¿å…æ—§æ—¥å¿—æ··æ·† | `find /var/log -type f -delete` |
| **ä¸´æ—¶æ–‡ä»¶** | `/tmp/*`, `/var/tmp/*` | æ¸…é™¤æ„å»ºæ®‹ç•™ | `rm -rf /tmp/* /var/tmp/*` |
| **DNF/APT ç¼“å­˜** | `/var/cache/dnf/` | å‡å°é•œåƒä½“ç§¯ | `dnf clean all` |

### 3.3 æ ‡å‡† Seal è„šæœ¬

```bash
#!/bin/bash
# seal.sh - é•œåƒæ•è·å‰çš„æ¸…ç†è„šæœ¬
# ç”¨æ³•: åœ¨ Packer provisioner æœ€åé˜¶æ®µæ‰§è¡Œ

set -e

echo "=== å¼€å§‹é•œåƒæ¸…ç† (Seal) ==="

# 1. æ¸…é™¤ machine-idï¼ˆå…³é”®ï¼ï¼‰
echo "æ¸…é™¤ machine-id..."
sudo truncate -s 0 /etc/machine-id
# æŸäº›å‘è¡Œç‰ˆè¿˜æœ‰ /var/lib/dbus/machine-id
if [ -f /var/lib/dbus/machine-id ]; then
    sudo rm /var/lib/dbus/machine-id
    sudo ln -s /etc/machine-id /var/lib/dbus/machine-id
fi

# 2. æ¸…é™¤ SSH host keysï¼ˆå¯åŠ¨æ—¶ä¼šè‡ªåŠ¨é‡æ–°ç”Ÿæˆï¼‰
echo "æ¸…é™¤ SSH host keys..."
sudo rm -f /etc/ssh/ssh_host_*

# 3. æ¸…é™¤ cloud-init çŠ¶æ€
echo "æ¸…é™¤ cloud-init çŠ¶æ€..."
if command -v cloud-init &> /dev/null; then
    sudo cloud-init clean --logs
fi

# 4. æ¸…é™¤å‘½ä»¤å†å²
echo "æ¸…é™¤å‘½ä»¤å†å²..."
cat /dev/null > ~/.bash_history
history -c

# 5. æ¸…é™¤æ—¥å¿—æ–‡ä»¶
echo "æ¸…é™¤æ—¥å¿—æ–‡ä»¶..."
sudo find /var/log -type f -name "*.log" -delete
sudo find /var/log -type f -name "*.gz" -delete
sudo find /var/log -type f -name "*.[0-9]" -delete
# æ¸…é™¤ journal æ—¥å¿—
sudo journalctl --vacuum-time=1s 2>/dev/null || true

# 6. æ¸…é™¤ä¸´æ—¶æ–‡ä»¶
echo "æ¸…é™¤ä¸´æ—¶æ–‡ä»¶..."
sudo rm -rf /tmp/*
sudo rm -rf /var/tmp/*

# 7. æ¸…é™¤åŒ…ç®¡ç†ç¼“å­˜
echo "æ¸…é™¤åŒ…ç®¡ç†ç¼“å­˜..."
if command -v dnf &> /dev/null; then
    sudo dnf clean all
elif command -v apt-get &> /dev/null; then
    sudo apt-get clean
    sudo rm -rf /var/lib/apt/lists/*
fi

# 8. æ¸…é™¤ root ç”¨æˆ·å†å²
echo "æ¸…é™¤ root ç”¨æˆ·å†å²..."
sudo cat /dev/null > /root/.bash_history

# 9. ç¡®ä¿ SSH ç›®å½•æƒé™æ­£ç¡®
echo "éªŒè¯ SSH é…ç½®..."
sudo chmod 700 /root/.ssh 2>/dev/null || true
sudo chmod 600 /root/.ssh/authorized_keys 2>/dev/null || true

echo "=== é•œåƒæ¸…ç†å®Œæˆ ==="
echo "machine-id: $(cat /etc/machine-id || echo '(å·²æ¸…é™¤)')"
echo "SSH keys: $(ls /etc/ssh/ssh_host_* 2>/dev/null | wc -l) ä¸ªæ–‡ä»¶"
```

### 3.4 æ¸…ç†éªŒè¯è„šæœ¬

```bash
#!/bin/bash
# verify-seal.sh - éªŒè¯é•œåƒæ¸…ç†æ˜¯å¦å®Œæˆ

echo "=== é•œåƒæ¸…ç†éªŒè¯ ==="

ISSUES=0

# æ£€æŸ¥ machine-id
if [ -s /etc/machine-id ]; then
    echo "[FAIL] machine-id ä¸ä¸ºç©º: $(cat /etc/machine-id)"
    ISSUES=$((ISSUES + 1))
else
    echo "[PASS] machine-id å·²æ¸…é™¤"
fi

# æ£€æŸ¥ SSH host keys
SSH_KEYS=$(ls /etc/ssh/ssh_host_* 2>/dev/null | wc -l)
if [ "$SSH_KEYS" -gt 0 ]; then
    echo "[FAIL] SSH host keys å­˜åœ¨: $SSH_KEYS ä¸ªæ–‡ä»¶"
    ISSUES=$((ISSUES + 1))
else
    echo "[PASS] SSH host keys å·²æ¸…é™¤"
fi

# æ£€æŸ¥ cloud-init çŠ¶æ€
if [ -f /var/lib/cloud/instance/boot-finished ]; then
    echo "[FAIL] cloud-init çŠ¶æ€å­˜åœ¨"
    ISSUES=$((ISSUES + 1))
else
    echo "[PASS] cloud-init çŠ¶æ€å·²æ¸…é™¤"
fi

# æ£€æŸ¥å‘½ä»¤å†å²
if [ -s ~/.bash_history ]; then
    echo "[WARN] bash_history å­˜åœ¨: $(wc -l < ~/.bash_history) è¡Œ"
else
    echo "[PASS] bash_history å·²æ¸…é™¤"
fi

# æ€»ç»“
echo ""
if [ "$ISSUES" -eq 0 ]; then
    echo "=== éªŒè¯é€šè¿‡ï¼šé•œåƒå¯ä»¥å®‰å…¨æ•è· ==="
else
    echo "=== éªŒè¯å¤±è´¥ï¼šå‘ç° $ISSUES ä¸ªé—®é¢˜ ==="
    exit 1
fi
```

### 3.5 virt-sysprep å·¥å…·ï¼ˆå¯é€‰ï¼‰

å¯¹äº Linux é•œåƒï¼Œ`virt-sysprep` æ˜¯ä¸€ä¸ªè‡ªåŠ¨åŒ–æ¸…ç†å·¥å…·ï¼š

```bash
# å®‰è£…ï¼ˆåœ¨æ„å»ºæœºå™¨ä¸Šï¼‰
sudo dnf install -y libguestfs-tools

# ä½¿ç”¨ virt-sysprep æ¸…ç†é•œåƒï¼ˆç¦»çº¿æ¨¡å¼ï¼‰
# æ³¨æ„ï¼šè¿™éœ€è¦é•œåƒæ–‡ä»¶ï¼Œä¸æ˜¯è¿è¡Œä¸­çš„å®ä¾‹
sudo virt-sysprep -a disk-image.raw \
    --operations defaults,-lvm-uuids \
    --hostname '' \
    --root-password disabled

# æŸ¥çœ‹ä¼šæ‰§è¡Œçš„æ“ä½œ
virt-sysprep --list-operations
```

**virt-sysprep å¸¸ç”¨æ“ä½œ**ï¼š

| æ“ä½œ | è¯´æ˜ |
|------|------|
| `machine-id` | æ¸…é™¤ /etc/machine-id |
| `ssh-hostkeys` | åˆ é™¤ SSH host keys |
| `logfiles` | æ¸…é™¤æ—¥å¿—æ–‡ä»¶ |
| `bash-history` | æ¸…é™¤ bash å†å² |
| `tmp-files` | æ¸…é™¤ä¸´æ—¶æ–‡ä»¶ |

---

## Step 4 - é•œåƒç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼ˆ20 åˆ†é’Ÿï¼‰

### 4.1 é•œåƒç”Ÿå‘½å‘¨æœŸ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    é•œåƒç”Ÿå‘½å‘¨æœŸç®¡ç†                                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚   æ„å»º (Build)                                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚  â— Packer/Image Builder æ„å»º                                        â”‚  â”‚
â”‚   â”‚  â— è‡ªåŠ¨å‘½åï¼šweb-server-2025-01-10-143022                           â”‚  â”‚
â”‚   â”‚  â— æ‰“æ ‡ç­¾ï¼šEnvironment=dev, Version=1.0.0                           â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                           â”‚                                                â”‚
â”‚                           â–¼                                                â”‚
â”‚   æµ‹è¯• (Test)                                                               â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚  â— ä»é•œåƒå¯åŠ¨æµ‹è¯•å®ä¾‹                                                â”‚  â”‚
â”‚   â”‚  â— è¿è¡ŒéªŒè¯è„šæœ¬ï¼ˆæœåŠ¡å¯åŠ¨ã€ç«¯å£ç›‘å¬ã€å¥åº·æ£€æŸ¥ï¼‰                       â”‚  â”‚
â”‚   â”‚  â— å®‰å…¨æ‰«æï¼ˆInspector, Trivyï¼‰                                      â”‚  â”‚
â”‚   â”‚  â— CIS åˆè§„æ£€æŸ¥                                                      â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                           â”‚                                                â”‚
â”‚                           â–¼                                                â”‚
â”‚   å‘å¸ƒ (Release)                                                            â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚  â— æ›´æ–°æ ‡ç­¾ï¼šStatus=approved                                        â”‚  â”‚
â”‚   â”‚  â— å¤åˆ¶åˆ°ç”Ÿäº§è´¦æˆ·/åŒºåŸŸ                                               â”‚  â”‚
â”‚   â”‚  â— æ›´æ–° Launch Template                                              â”‚  â”‚
â”‚   â”‚  â— é€šçŸ¥ç›¸å…³å›¢é˜Ÿ                                                      â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                           â”‚                                                â”‚
â”‚                           â–¼                                                â”‚
â”‚   è¿è¡Œ (Active)                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚  â— ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ä¸­                                                    â”‚  â”‚
â”‚   â”‚  â— ç›‘æ§é•œåƒä½¿ç”¨é‡                                                    â”‚  â”‚
â”‚   â”‚  â— å®šæœŸæ£€æŸ¥æ˜¯å¦æœ‰æ–°ç‰ˆæœ¬                                              â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                           â”‚                                                â”‚
â”‚                           â–¼                                                â”‚
â”‚   å¼ƒç”¨ (Deprecate)                                                          â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚  â— æ›´æ–°æ ‡ç­¾ï¼šStatus=deprecated                                      â”‚  â”‚
â”‚   â”‚  â— é€šçŸ¥ç”¨æˆ·è¿ç§»åˆ°æ–°ç‰ˆæœ¬                                              â”‚  â”‚
â”‚   â”‚  â— è®¾ç½®å¼ƒç”¨æ—¶é—´                                                      â”‚  â”‚
â”‚   â”‚  â— ä¿ç•™ä¸€å®šæ—¶é—´ï¼ˆå›æ»šéœ€è¦ï¼‰                                          â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                           â”‚                                                â”‚
â”‚                           â–¼                                                â”‚
â”‚   åˆ é™¤ (Delete)                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚  â— ç¡®è®¤æ— æ´»è·ƒä½¿ç”¨                                                    â”‚  â”‚
â”‚   â”‚  â— åˆ é™¤ AMI å’Œå…³è”å¿«ç…§                                               â”‚  â”‚
â”‚   â”‚  â— ä¿ç•™å®¡è®¡è®°å½•                                                      â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 ç‰ˆæœ¬å‘½åçº¦å®š

æ¨èçš„é•œåƒå‘½åæ ¼å¼ï¼š

```
{app}-{version}-{date}-{build-number}

ç¤ºä¾‹ï¼š
web-server-1.0.0-20250110-001
nginx-2.3.1-20250110-002
base-cis-al2023-20250110-001
```

**æ ‡ç­¾è§„èŒƒ**ï¼š

| æ ‡ç­¾ | å€¼ | ç”¨é€” |
|------|-----|------|
| `Name` | `web-server-1.0.0-20250110-001` | AMI æ˜¾ç¤ºåç§° |
| `Application` | `web-server` | åº”ç”¨æ ‡è¯† |
| `Version` | `1.0.0` | åº”ç”¨ç‰ˆæœ¬ |
| `BaseAMI` | `ami-0abc123...` | åŸºç¡€é•œåƒ ID |
| `BuildDate` | `2025-01-10` | æ„å»ºæ—¥æœŸ |
| `BuildNumber` | `001` | æ„å»ºåºå· |
| `Builder` | `packer` | æ„å»ºå·¥å…· |
| `Status` | `testing/approved/deprecated` | ç”Ÿå‘½å‘¨æœŸçŠ¶æ€ |
| `Environment` | `dev/staging/prod` | ç›®æ ‡ç¯å¢ƒ |

### 4.3 é•œåƒç®¡ç†è„šæœ¬

```bash
#!/bin/bash
# manage-ami.sh - AMI ç”Ÿå‘½å‘¨æœŸç®¡ç†

# åˆ—å‡ºæ‰€æœ‰è‡ªå»ºé•œåƒ
list_amis() {
    aws ec2 describe-images \
        --owners self \
        --query 'Images[*].[ImageId,Name,CreationDate,Tags[?Key==`Status`].Value|[0]]' \
        --output table
}

# æ ‡è®°é•œåƒä¸º approved
approve_ami() {
    local ami_id=$1
    aws ec2 create-tags \
        --resources "$ami_id" \
        --tags Key=Status,Value=approved
    echo "AMI $ami_id å·²æ ‡è®°ä¸º approved"
}

# æ ‡è®°é•œåƒä¸º deprecated
deprecate_ami() {
    local ami_id=$1
    aws ec2 create-tags \
        --resources "$ami_id" \
        --tags Key=Status,Value=deprecated Key=DeprecationDate,Value="$(date +%Y-%m-%d)"
    echo "AMI $ami_id å·²æ ‡è®°ä¸º deprecated"
}

# æŸ¥æ‰¾ä½¿ç”¨ç‰¹å®š AMI çš„å®ä¾‹
find_instances_using_ami() {
    local ami_id=$1
    aws ec2 describe-instances \
        --filters "Name=image-id,Values=$ami_id" \
        --query 'Reservations[*].Instances[*].[InstanceId,State.Name]' \
        --output table
}

# åˆ é™¤æ—§çš„ deprecated AMIï¼ˆä¿ç•™æœ€è¿‘ N ä¸ªï¼‰
cleanup_old_amis() {
    local keep_count=${1:-3}
    local app_name=${2:-"web-server"}

    # è·å– deprecated çš„ AMIï¼ŒæŒ‰æ—¥æœŸæ’åº
    aws ec2 describe-images \
        --owners self \
        --filters "Name=tag:Application,Values=$app_name" "Name=tag:Status,Values=deprecated" \
        --query 'sort_by(Images, &CreationDate)[*].[ImageId,Name,CreationDate]' \
        --output text | head -n -$keep_count | while read ami_id name date; do

        echo "å‡†å¤‡åˆ é™¤: $ami_id ($name, $date)"
        # å®é™…åˆ é™¤éœ€è¦å–æ¶ˆæ³¨é‡Š
        # aws ec2 deregister-image --image-id "$ami_id"
    done
}

# ä½¿ç”¨ç¤ºä¾‹
case "$1" in
    list) list_amis ;;
    approve) approve_ami "$2" ;;
    deprecate) deprecate_ami "$2" ;;
    find-usage) find_instances_using_ami "$2" ;;
    cleanup) cleanup_old_amis "$2" "$3" ;;
    *) echo "Usage: $0 {list|approve|deprecate|find-usage|cleanup} [args]" ;;
esac
```

---

## Step 5 - 2025 æ›´æ–°ï¼ˆ15 åˆ†é’Ÿï¼‰

### 5.1 EC2 Image Builder vs Packer

| ç‰¹æ€§ | Packer | EC2 Image Builder |
|------|--------|-------------------|
| **å­¦ä¹ æ›²çº¿** | ä¸­ç­‰ | ä½ï¼ˆAWS Consoleï¼‰ |
| **å¤šäº‘æ”¯æŒ** | æ˜¯ï¼ˆAWS, GCP, Azure...ï¼‰ | ä»… AWS |
| **Pipeline é›†æˆ** | éœ€è¦é¢å¤–é…ç½® | å†…ç½® Pipeline |
| **STIG åˆè§„** | æ‰‹åŠ¨é…ç½® | å†…ç½® STIG ç»„ä»¶ |
| **æˆæœ¬** | åªæ”¶å®ä¾‹è´¹ç”¨ | åªæ”¶å®ä¾‹è´¹ç”¨ |
| **çµæ´»æ€§** | é«˜ | ä¸­ |
| **ç¤¾åŒºæ”¯æŒ** | å¹¿æ³› | AWS å®˜æ–¹ |

**é€‰æ‹©å»ºè®®**ï¼š
- **çº¯ AWS ç¯å¢ƒ** + åˆè§„è¦æ±‚é«˜ â†’ EC2 Image Builder
- **å¤šäº‘ç¯å¢ƒ** + éœ€è¦æœ€å¤§çµæ´»æ€§ â†’ Packer
- **å›¢é˜Ÿç†Ÿæ‚‰ HashiCorp å·¥å…·** â†’ Packer

### 5.2 ARM64 / Graviton é•œåƒ

2025 å¹´è¶‹åŠ¿ï¼š**Graviton å®ä¾‹æ€§ä»·æ¯”æ˜¾è‘—**ï¼ˆæ¯” x86 ä¾¿å®œçº¦ 20%ï¼Œæ€§èƒ½ç›¸å½“æˆ–æ›´å¥½ï¼‰

```hcl
# Packer æ„å»º ARM64 é•œåƒ

data "amazon-ami" "amazon-linux-2023-arm" {
  filters = {
    name                = "al2023-ami-*-arm64"  # æ³¨æ„ï¼šarm64
    root-device-type    = "ebs"
    virtualization-type = "hvm"
  }
  most_recent = true
  owners      = ["amazon"]
}

source "amazon-ebs" "web-arm64" {
  ami_name      = "web-server-arm64-{{timestamp}}"
  instance_type = "t4g.micro"  # Graviton å®ä¾‹ç±»å‹
  source_ami    = data.amazon-ami.amazon-linux-2023-arm.id
  ssh_username  = "ec2-user"
  # ...
}
```

**æ¶æ„å…¼å®¹æ€§æ£€æŸ¥**ï¼š

```bash
# æ£€æŸ¥å½“å‰å®ä¾‹æ¶æ„
uname -m
# aarch64 = ARM64
# x86_64 = x86

# æ£€æŸ¥è½¯ä»¶åŒ…æ˜¯å¦æ”¯æŒ ARM64
dnf repoquery --arch=aarch64 nginx
```

### 5.3 ä¾›åº”é“¾å®‰å…¨è¶‹åŠ¿

| è¶‹åŠ¿ | è¯´æ˜ | å®è·µ |
|------|------|------|
| **SBOM** | Software Bill of Materials | ç”Ÿæˆè½¯ä»¶æ¸…å• |
| **é•œåƒç­¾å** | éªŒè¯é•œåƒæ¥æº | AWS Signer |
| **æŒç»­æ‰«æ** | Inspector v2 | è¿è¡Œä¸­å®ä¾‹ä¹Ÿæ‰«æ |
| **åŸºç¡€é•œåƒä¿¡ä»»** | åªä½¿ç”¨å®˜æ–¹é•œåƒ | éªŒè¯ AMI owner |

```bash
# ç”Ÿæˆ SBOMï¼ˆè½¯ä»¶ç‰©æ–™æ¸…å•ï¼‰
# Amazon Linux 2023
sudo dnf repoquery --installed --qf '%{name}-%{version}-%{release}.%{arch}' > sbom.txt

# ä½¿ç”¨ syftï¼ˆå¼€æº SBOM å·¥å…·ï¼‰
syft dir:/ -o cyclonedx-json > sbom.json
```

---

## Lab 1 - Packer é‡‘è‰²é•œåƒï¼ˆ40 åˆ†é’Ÿï¼‰

### å®éªŒç›®æ ‡

ä½¿ç”¨ Packer æ„å»ºä¸€ä¸ªåŒ…å« Nginx çš„é‡‘è‰²é•œåƒã€‚

### Step 1 - å‡†å¤‡ Packer ç¯å¢ƒ

```bash
# æ£€æŸ¥ Packer æ˜¯å¦å®‰è£…
packer version

# å¦‚æœæœªå®‰è£…ï¼ˆAmazon Linux 2023ï¼‰
sudo dnf install -y dnf-plugins-core
sudo dnf config-manager --add-repo https://rpm.releases.hashicorp.com/AmazonLinux/hashicorp.repo
sudo dnf -y install packer

# åˆ›å»ºå·¥ä½œç›®å½•
mkdir -p ~/packer-lab && cd ~/packer-lab
```

### Step 2 - åˆ›å»º Packer æ¨¡æ¿

```bash
# åˆ›å»ºä¸»æ¨¡æ¿æ–‡ä»¶
cat > web-server.pkr.hcl << 'EOF'
packer {
  required_plugins {
    amazon = {
      version = ">= 1.2.0"
      source  = "github.com/hashicorp/amazon"
    }
  }
}

variable "aws_region" {
  type    = string
  default = "ap-northeast-1"
}

data "amazon-ami" "al2023" {
  filters = {
    name                = "al2023-ami-*-x86_64"
    root-device-type    = "ebs"
    virtualization-type = "hvm"
  }
  most_recent = true
  owners      = ["amazon"]
  region      = var.aws_region
}

source "amazon-ebs" "web" {
  ami_name        = "web-server-lab-{{timestamp}}"
  ami_description = "Packer Lab - Web server golden image"
  instance_type   = "t3.micro"
  region          = var.aws_region
  source_ami      = data.amazon-ami.al2023.id
  ssh_username    = "ec2-user"

  tags = {
    Name        = "web-server-lab-{{timestamp}}"
    Builder     = "packer"
    Environment = "lab"
  }
}

build {
  sources = ["source.amazon-ebs.web"]

  # ç³»ç»Ÿæ›´æ–°å’Œè½¯ä»¶å®‰è£…
  provisioner "shell" {
    inline = [
      "sudo dnf update -y",
      "sudo dnf install -y nginx",
      "sudo systemctl enable nginx"
    ]
  }

  # æ¸…ç†è„šæœ¬
  provisioner "shell" {
    inline = [
      "# æ¸…é™¤ machine-id",
      "sudo truncate -s 0 /etc/machine-id",
      "",
      "# æ¸…é™¤ SSH host keys",
      "sudo rm -f /etc/ssh/ssh_host_*",
      "",
      "# æ¸…é™¤ cloud-init çŠ¶æ€",
      "sudo cloud-init clean --logs || true",
      "",
      "# æ¸…é™¤å†å²å’Œç¼“å­˜",
      "sudo dnf clean all",
      "cat /dev/null > ~/.bash_history",
      "history -c"
    ]
  }

  post-processor "manifest" {
    output     = "manifest.json"
    strip_path = true
  }
}
EOF
```

### Step 3 - æ„å»ºé•œåƒ

```bash
# åˆå§‹åŒ– Packer
packer init web-server.pkr.hcl

# éªŒè¯æ¨¡æ¿
packer validate web-server.pkr.hcl

# æ„å»ºé•œåƒï¼ˆéœ€è¦ AWS å‡­è¯ï¼‰
packer build web-server.pkr.hcl
```

æ„å»ºè¿‡ç¨‹ä¼šï¼š
1. å¯åŠ¨ä¸€ä¸ªä¸´æ—¶ EC2 å®ä¾‹
2. SSH è¿æ¥å¹¶æ‰§è¡Œ provisioner
3. åœæ­¢å®ä¾‹å¹¶åˆ›å»º AMI
4. æ¸…ç†ä¸´æ—¶èµ„æº

### Step 4 - éªŒè¯é•œåƒ

```bash
# æŸ¥çœ‹ manifest
cat manifest.json | jq '.'

# è·å–æ–°å»ºçš„ AMI ID
AMI_ID=$(cat manifest.json | jq -r '.builds[0].artifact_id' | cut -d: -f2)
echo "New AMI: $AMI_ID"

# æŸ¥çœ‹ AMI è¯¦æƒ…
aws ec2 describe-images --image-ids $AMI_ID

# ä»é•œåƒå¯åŠ¨æµ‹è¯•å®ä¾‹ï¼ˆå¯é€‰ï¼‰
# aws ec2 run-instances \
#   --image-id $AMI_ID \
#   --instance-type t3.micro \
#   --key-name your-key \
#   --tag-specifications 'ResourceType=instance,Tags=[{Key=Name,Value=test-golden-image}]'
```

### Step 5 - æ¸…ç†

```bash
# å¦‚æœæ˜¯å®éªŒï¼Œæ¸…ç†åˆ›å»ºçš„ AMI
# aws ec2 deregister-image --image-id $AMI_ID

# æ‰¾åˆ°å…³è”çš„å¿«ç…§
# SNAPSHOT_ID=$(aws ec2 describe-images --image-ids $AMI_ID --query 'Images[0].BlockDeviceMappings[0].Ebs.SnapshotId' --output text)
# aws ec2 delete-snapshot --snapshot-id $SNAPSHOT_ID

# æ¸…ç†æœ¬åœ°æ–‡ä»¶
rm -rf ~/packer-lab
```

### æ£€æŸ¥æ¸…å•

- [ ] æˆåŠŸå®‰è£…å’Œé…ç½® Packer
- [ ] ç†è§£ Packer æ¨¡æ¿ç»“æ„ï¼ˆsource, build, provisionerï¼‰
- [ ] èƒ½å¤Ÿæ„å»ºåŸºæœ¬çš„ AMI
- [ ] ç†è§£ seal è„šæœ¬çš„ä½œç”¨

---

## Lab 2 - Ghost Identity åœºæ™¯ï¼ˆ30 åˆ†é’Ÿï¼‰

### åœºæ™¯æè¿°

> ä½ ä»è¿è¡Œä¸­çš„æœåŠ¡å™¨åˆ›å»ºäº†é‡‘è‰²é•œåƒ (AMI)ã€‚ä»è¯¥é•œåƒå¯åŠ¨ 3 ä¸ªå®ä¾‹åï¼Œå®ƒä»¬åœ¨ç›‘æ§å·¥å…·ä¸­äº‰ç”¨åŒä¸€ IPï¼Œæ—¥å¿—èšåˆæ··ä¹±ã€‚  

**æ ¹å› **ï¼š`/etc/machine-id` åœ¨é•œåƒæ•è·å‰æœªæ¸…é™¤

### Step 1 - æ¨¡æ‹Ÿé—®é¢˜

```bash
# æŸ¥çœ‹å½“å‰å®ä¾‹çš„ machine-id
MACHINE_ID=$(cat /etc/machine-id)
echo "å½“å‰ machine-id: $MACHINE_ID"

# æ¨¡æ‹Ÿï¼šå¦‚æœä»è¿™ä¸ªå®ä¾‹åˆ›å»º AMIï¼ˆä¸æ¸…ç†ï¼‰ï¼Œæ‰€æœ‰æ–°å®ä¾‹éƒ½ä¼šæœ‰è¿™ä¸ª ID
echo "é—®é¢˜ï¼šæ‰€æœ‰æ–°å®ä¾‹éƒ½ä¼šæœ‰ç›¸åŒçš„ machine-id: $MACHINE_ID"
```

### Step 2 - ç†è§£ machine-id çš„å½±å“

```bash
# machine-id ç”¨äºä»€ä¹ˆï¼Ÿ
echo "=== machine-id çš„ç”¨é€” ==="

# 1. systemd-journald ä½¿ç”¨ machine-id æ ‡è¯†æ—¥å¿—
echo "1. Journal æ—¥å¿—æ ‡è¯†:"
journalctl --header 2>/dev/null | grep "Machine ID" || echo "   (éœ€è¦æŸ¥çœ‹ journal å¤´éƒ¨)"

# 2. DHCP å®¢æˆ·ç«¯ ID
echo -e "\n2. DHCP å®¢æˆ·ç«¯æ ‡è¯†:"
echo "   æŸäº› DHCP æœåŠ¡å™¨ä½¿ç”¨ machine-id åˆ†é…ç§Ÿçº¦"

# 3. D-Bus ç³»ç»Ÿæ ‡è¯†
echo -e "\n3. D-Bus ç³»ç»Ÿæ ‡è¯†:"
ls -la /var/lib/dbus/machine-id 2>/dev/null || echo "   /var/lib/dbus/machine-id"

# 4. ç›‘æ§å·¥å…·
echo -e "\n4. ç›‘æ§å·¥å…·æ ‡è¯†:"
echo "   CloudWatch Agentã€Datadog ç­‰å¯èƒ½ä½¿ç”¨ machine-id åŒºåˆ†ä¸»æœº"
```

### Step 3 - æ¼”ç¤ºæ­£ç¡®çš„æ¸…ç†æµç¨‹

```bash
# æ­£ç¡®çš„æ¸…ç†æ–¹å¼ï¼ˆåœ¨åˆ›å»º AMI å‰æ‰§è¡Œï¼‰

echo "=== æ­£ç¡®çš„ machine-id æ¸…ç†æµç¨‹ ==="

# æ–¹æ³• 1ï¼šæ¸…ç©ºæ–‡ä»¶ï¼ˆsystemd ä¼šåœ¨ä¸‹æ¬¡å¯åŠ¨æ—¶é‡æ–°ç”Ÿæˆï¼‰
echo "æ–¹æ³• 1: truncate -s 0 /etc/machine-id"

# æ–¹æ³• 2ï¼šåˆ é™¤æ–‡ä»¶ï¼ˆæŸäº›å‘è¡Œç‰ˆï¼‰
echo "æ–¹æ³• 2: rm /etc/machine-id"

# cloud-init ä¼šåœ¨é¦–æ¬¡å¯åŠ¨æ—¶ç”Ÿæˆæ–°çš„ machine-id
echo -e "\ncloud-init ä¼šåœ¨é¦–æ¬¡å¯åŠ¨æ—¶ç”Ÿæˆæ–°çš„å”¯ä¸€ machine-id"

# éªŒè¯å‘½ä»¤
echo -e "\n=== éªŒè¯ machine-id å·²æ¸…é™¤ ==="
cat > /tmp/check-machine-id.sh << 'SCRIPT'
if [ -s /etc/machine-id ]; then
    echo "[FAIL] machine-id ä¸ä¸ºç©º"
    cat /etc/machine-id
else
    echo "[PASS] machine-id å·²æ¸…é™¤æˆ–ä¸ºç©º"
fi
SCRIPT

bash /tmp/check-machine-id.sh
```

### Step 4 - å®Œæ•´çš„æ¸…ç†æ£€æŸ¥

```bash
# åˆ›å»ºå®Œæ•´çš„é•œåƒå‡†å¤‡æ£€æŸ¥è„šæœ¬
cat > /tmp/ami-readiness-check.sh << 'EOF'
#!/bin/bash
echo "=========================================="
echo "AMI å‡†å¤‡åº¦æ£€æŸ¥æŠ¥å‘Š"
echo "=========================================="
echo ""

ISSUES=0

# 1. machine-id
echo "1. machine-id æ£€æŸ¥"
if [ -s /etc/machine-id ]; then
    echo "   [FAIL] machine-id å­˜åœ¨: $(cat /etc/machine-id | head -c 16)..."
    ISSUES=$((ISSUES + 1))
else
    echo "   [PASS] machine-id å·²æ¸…é™¤"
fi

# 2. SSH host keys
echo -e "\n2. SSH Host Keys æ£€æŸ¥"
SSH_KEYS=$(ls /etc/ssh/ssh_host_* 2>/dev/null | wc -l)
if [ "$SSH_KEYS" -gt 0 ]; then
    echo "   [FAIL] å­˜åœ¨ $SSH_KEYS ä¸ª SSH host key æ–‡ä»¶"
    ISSUES=$((ISSUES + 1))
else
    echo "   [PASS] SSH host keys å·²æ¸…é™¤"
fi

# 3. cloud-init çŠ¶æ€
echo -e "\n3. cloud-init çŠ¶æ€æ£€æŸ¥"
if [ -f /var/lib/cloud/instance/boot-finished ]; then
    echo "   [FAIL] cloud-init å·²å®Œæˆæ ‡è®°å­˜åœ¨"
    ISSUES=$((ISSUES + 1))
else
    echo "   [PASS] cloud-init çŠ¶æ€å·²æ¸…é™¤"
fi

# 4. å‘½ä»¤å†å²
echo -e "\n4. å‘½ä»¤å†å²æ£€æŸ¥"
HISTORY_LINES=$(wc -l < ~/.bash_history 2>/dev/null || echo "0")
if [ "$HISTORY_LINES" -gt 0 ]; then
    echo "   [WARN] bash_history åŒ…å« $HISTORY_LINES è¡Œ"
else
    echo "   [PASS] bash_history å·²æ¸…é™¤"
fi

# 5. ä¸´æ—¶æ–‡ä»¶
echo -e "\n5. ä¸´æ—¶æ–‡ä»¶æ£€æŸ¥"
TMP_FILES=$(find /tmp -type f 2>/dev/null | wc -l)
if [ "$TMP_FILES" -gt 10 ]; then
    echo "   [WARN] /tmp åŒ…å« $TMP_FILES ä¸ªæ–‡ä»¶"
else
    echo "   [PASS] ä¸´æ—¶æ–‡ä»¶æ•°é‡åˆç†"
fi

# æ€»ç»“
echo ""
echo "=========================================="
if [ "$ISSUES" -eq 0 ]; then
    echo "ç»“æœ: é€šè¿‡ - é•œåƒå¯ä»¥å®‰å…¨æ•è·"
else
    echo "ç»“æœ: å¤±è´¥ - å‘ç° $ISSUES ä¸ªå¿…é¡»ä¿®å¤çš„é—®é¢˜"
fi
echo "=========================================="
EOF

chmod +x /tmp/ami-readiness-check.sh
bash /tmp/ami-readiness-check.sh
```

### æ£€æŸ¥æ¸…å•

- [ ] ç†è§£ machine-id çš„ä½œç”¨å’Œå½±å“
- [ ] ç†è§£æœªæ¸…ç† machine-id å¯¼è‡´çš„é—®é¢˜
- [ ] èƒ½å¤Ÿæ­£ç¡®æ¸…é™¤ machine-id
- [ ] èƒ½å¤ŸéªŒè¯é•œåƒæ¸…ç†çŠ¶æ€

---

## Lab 3 - Configuration Audit åœºæ™¯ï¼ˆ25 åˆ†é’Ÿï¼‰

### åœºæ™¯æè¿°

> å°†é‡‘è‰²é•œåƒäº¤æ¥ç»™è¿ç»´å›¢é˜Ÿã€‚éœ€è¦è¯æ˜é•œåƒä¸è®¾è®¡æ–‡æ¡£ï¼ˆè¨­è¨ˆæ›¸ï¼‰å®Œå…¨åŒ¹é…ã€‚  

**ç›®æ ‡**ï¼šç”Ÿæˆå¯å®¡è®¡çš„é…ç½®æŠ¥å‘Š

### Step 1 - ç”Ÿæˆè½¯ä»¶æ¸…å•

```bash
# ç”Ÿæˆå·²å®‰è£…åŒ…æ¸…å•
echo "=== ç”Ÿæˆè½¯ä»¶æ¸…å• ==="

# Amazon Linux / RHEL / CentOS
rpm -qa --qf '%{NAME}-%{VERSION}-%{RELEASE}.%{ARCH}\n' | sort > /tmp/installed-packages.txt

# æˆ–è€…ä½¿ç”¨ dnf
# dnf list installed --quiet | tail -n +2 | awk '{print $1}' | sort > /tmp/installed-packages.txt

echo "å·²å®‰è£…åŒ…æ•°é‡: $(wc -l < /tmp/installed-packages.txt)"
echo "å‰ 10 ä¸ªåŒ…:"
head -10 /tmp/installed-packages.txt
```

### Step 2 - åˆ›å»ºæ‰¹å‡†åˆ—è¡¨å¹¶æ¯”è¾ƒ

```bash
# åˆ›å»ºä¸€ä¸ªæ¨¡æ‹Ÿçš„"æ‰¹å‡†åŒ…åˆ—è¡¨"ï¼ˆå®é™…åœºæ™¯ä»è®¾è®¡æ–‡æ¡£è·å–ï¼‰
cat > /tmp/approved-packages.txt << 'EOF'
nginx-1.24.0-1.amzn2023.0.2.x86_64
amazon-cloudwatch-agent-1.300033.0-1.amzn2023.x86_64
amazon-ssm-agent-3.2.2222.0-1.amzn2023.x86_64
EOF

echo "=== æ‰¹å‡†åˆ—è¡¨ ==="
cat /tmp/approved-packages.txt

echo -e "\n=== å·®å¼‚åˆ†æ ==="

# æ£€æŸ¥æ‰¹å‡†åˆ—è¡¨ä¸­çš„åŒ…æ˜¯å¦éƒ½å·²å®‰è£…
echo "æ£€æŸ¥å¿…éœ€åŒ…æ˜¯å¦å·²å®‰è£…:"
while read pkg; do
    if grep -q "^${pkg%%\-[0-9]*}" /tmp/installed-packages.txt; then
        echo "  [OK] $pkg"
    else
        echo "  [MISSING] $pkg"
    fi
done < /tmp/approved-packages.txt
```

### Step 3 - ç”Ÿæˆé…ç½®å®¡è®¡æŠ¥å‘Š

```bash
cat > /tmp/generate-audit-report.sh << 'EOF'
#!/bin/bash
# ç”Ÿæˆé…ç½®å®¡è®¡æŠ¥å‘Š

REPORT_FILE="/tmp/audit-report-$(date +%Y%m%d-%H%M%S).txt"

echo "=========================================="  > $REPORT_FILE
echo "      é•œåƒé…ç½®å®¡è®¡æŠ¥å‘Š"                     >> $REPORT_FILE
echo "      Image Configuration Audit Report"   >> $REPORT_FILE
echo "=========================================="  >> $REPORT_FILE
echo ""                                          >> $REPORT_FILE
echo "ç”Ÿæˆæ—¶é—´: $(date)"                         >> $REPORT_FILE
echo "ä¸»æœºå: $(hostname)"                       >> $REPORT_FILE
echo "AMI ID: $(curl -s http://169.254.169.254/latest/meta-data/ami-id 2>/dev/null || echo 'N/A')" >> $REPORT_FILE
echo ""                                          >> $REPORT_FILE

# 1. ç³»ç»Ÿä¿¡æ¯
echo "=== 1. ç³»ç»Ÿä¿¡æ¯ ===" >> $REPORT_FILE
echo "OS: $(cat /etc/os-release | grep PRETTY_NAME | cut -d= -f2 | tr -d '"')" >> $REPORT_FILE
echo "Kernel: $(uname -r)" >> $REPORT_FILE
echo "Architecture: $(uname -m)" >> $REPORT_FILE
echo "" >> $REPORT_FILE

# 2. å®‰è£…çš„åŒ…
echo "=== 2. å®‰è£…çš„åŒ… (å‰50ä¸ª) ===" >> $REPORT_FILE
rpm -qa --qf '%{NAME}-%{VERSION}\n' 2>/dev/null | sort | head -50 >> $REPORT_FILE
echo "... (å…± $(rpm -qa | wc -l) ä¸ªåŒ…)" >> $REPORT_FILE
echo "" >> $REPORT_FILE

# 3. å¯ç”¨çš„æœåŠ¡
echo "=== 3. å¯ç”¨çš„æœåŠ¡ ===" >> $REPORT_FILE
systemctl list-unit-files --state=enabled --type=service --no-pager 2>/dev/null | head -20 >> $REPORT_FILE
echo "" >> $REPORT_FILE

# 4. ç›‘å¬ç«¯å£
echo "=== 4. ç›‘å¬ç«¯å£ ===" >> $REPORT_FILE
ss -tulpn 2>/dev/null | grep LISTEN >> $REPORT_FILE
echo "" >> $REPORT_FILE

# 5. ç”¨æˆ·è´¦æˆ·
echo "=== 5. ç³»ç»Ÿç”¨æˆ· (UID < 1000) ===" >> $REPORT_FILE
awk -F: '$3 < 1000 {print $1":"$3}' /etc/passwd | head -20 >> $REPORT_FILE
echo "" >> $REPORT_FILE

# 6. é•œåƒæ¸…ç†çŠ¶æ€
echo "=== 6. é•œåƒæ¸…ç†çŠ¶æ€ ===" >> $REPORT_FILE
if [ -s /etc/machine-id ]; then
    echo "machine-id: å­˜åœ¨ (è­¦å‘Š)" >> $REPORT_FILE
else
    echo "machine-id: å·²æ¸…é™¤ (æ­£å¸¸)" >> $REPORT_FILE
fi

SSH_KEYS=$(ls /etc/ssh/ssh_host_* 2>/dev/null | wc -l)
if [ "$SSH_KEYS" -gt 0 ]; then
    echo "SSH host keys: $SSH_KEYS ä¸ªæ–‡ä»¶å­˜åœ¨ (è­¦å‘Š)" >> $REPORT_FILE
else
    echo "SSH host keys: å·²æ¸…é™¤ (æ­£å¸¸)" >> $REPORT_FILE
fi

# 7. å®‰å…¨é…ç½®
echo "" >> $REPORT_FILE
echo "=== 7. å®‰å…¨é…ç½®æ£€æŸ¥ ===" >> $REPORT_FILE
echo "SELinux: $(getenforce 2>/dev/null || echo 'Not installed')" >> $REPORT_FILE
echo "Firewalld: $(systemctl is-active firewalld 2>/dev/null || echo 'Not running')" >> $REPORT_FILE
echo "SSHd PermitRootLogin: $(grep -E '^PermitRootLogin' /etc/ssh/sshd_config 2>/dev/null || echo 'Not set')" >> $REPORT_FILE

echo "" >> $REPORT_FILE
echo "===========================================" >> $REPORT_FILE
echo "æŠ¥å‘Šç”Ÿæˆå®Œæˆ" >> $REPORT_FILE
echo "===========================================" >> $REPORT_FILE

echo "å®¡è®¡æŠ¥å‘Šå·²ç”Ÿæˆ: $REPORT_FILE"
cat $REPORT_FILE
EOF

chmod +x /tmp/generate-audit-report.sh
bash /tmp/generate-audit-report.sh
```

### Step 4 - å¯¼å‡ºæŠ¥å‘Š

```bash
# æŸ¥çœ‹ç”Ÿæˆçš„æŠ¥å‘Š
ls -la /tmp/audit-report-*.txt

# åœ¨å®é™…åœºæ™¯ä¸­ï¼Œå¯ä»¥ä¸Šä¼ åˆ° S3
# REPORT_FILE=$(ls /tmp/audit-report-*.txt | tail -1)
# aws s3 cp $REPORT_FILE s3://your-audit-bucket/golden-images/
```

### æ£€æŸ¥æ¸…å•

- [ ] èƒ½å¤Ÿç”Ÿæˆè½¯ä»¶åŒ…æ¸…å•
- [ ] èƒ½å¤Ÿä¸æ‰¹å‡†åˆ—è¡¨æ¯”è¾ƒå·®å¼‚
- [ ] èƒ½å¤Ÿç”Ÿæˆç»¼åˆå®¡è®¡æŠ¥å‘Š
- [ ] ç†è§£æ—¥æœ¬ä¼ä¸šå¯¹é…ç½®å®¡è®¡çš„è¦æ±‚

---

## ä¸å¯å˜åŸºç¡€è®¾æ–½ï¼ˆImmutable Infrastructure Sidebarï¼‰

### ä¼ ç»Ÿæ¨¡å¼ vs ä¸å¯å˜æ¨¡å¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ä¼ ç»Ÿæ¨¡å¼ vs ä¸å¯å˜åŸºç¡€è®¾æ–½                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚   ä¼ ç»Ÿæ¨¡å¼ï¼ˆMutableï¼‰                                                        â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                    â”‚
â”‚                                                                             â”‚
â”‚   æœåŠ¡å™¨ â”€â–º è¡¥ä¸ â”€â–º é…ç½®æ›´æ–° â”€â–º ä»£ç éƒ¨ç½² â”€â–º æ›´å¤šè¡¥ä¸ â”€â–º ...                â”‚
â”‚                                                                             â”‚
â”‚   é—®é¢˜ï¼š                                                                    â”‚
â”‚   â— é…ç½®æ¼‚ç§»ï¼ˆdriftï¼‰ï¼šæœåŠ¡å™¨ä¹‹é—´ä¸ä¸€è‡´                                     â”‚
â”‚   â— "åœ¨æˆ‘æœºå™¨ä¸Šèƒ½è·‘"ï¼šç¯å¢ƒå·®å¼‚                                              â”‚
â”‚   â— éš¾ä»¥å›æ»šï¼šæ›´æ–°å†å²å¤æ‚                                                  â”‚
â”‚   â— å®¡è®¡å›°éš¾ï¼šè°æ”¹äº†ä»€ä¹ˆï¼Ÿ                                                  â”‚
â”‚                                                                             â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚
â”‚                                                                             â”‚
â”‚   ä¸å¯å˜æ¨¡å¼ï¼ˆImmutableï¼‰                                                    â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                    â”‚
â”‚                                                                             â”‚
â”‚   AMI v1 â”€â–º å®ä¾‹ç¾¤ A                                                        â”‚
â”‚                     â†“ æ›´æ–° = æ›¿æ¢                                          â”‚
â”‚   AMI v2 â”€â–º å®ä¾‹ç¾¤ B â”€â–º åˆ é™¤å®ä¾‹ç¾¤ A                                        â”‚
â”‚                     â†“ å›æ»š = å†æ¬¡æ›¿æ¢                                       â”‚
â”‚   AMI v1 â”€â–º å®ä¾‹ç¾¤ C â”€â–º åˆ é™¤å®ä¾‹ç¾¤ B                                        â”‚
â”‚                                                                             â”‚
â”‚   ä¼˜åŠ¿ï¼š                                                                    â”‚
â”‚   âœ“ ä¸€è‡´æ€§ï¼šæ‰€æœ‰å®ä¾‹æ¥è‡ªåŒä¸€é•œåƒ                                            â”‚
â”‚   âœ“ å¯é¢„æµ‹ï¼šçŸ¥é“æ¯ä¸ªå®ä¾‹çš„ç¡®åˆ‡çŠ¶æ€                                          â”‚
â”‚   âœ“ å¿«é€Ÿå›æ»šï¼šåˆ‡æ¢åˆ°æ—§é•œåƒå³å¯                                              â”‚
â”‚   âœ“ æ˜“å®¡è®¡ï¼šé•œåƒç‰ˆæœ¬ = é…ç½®ç‰ˆæœ¬                                             â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å®ç°ä¸å¯å˜åŸºç¡€è®¾æ–½

```
æ›´æ–°æµç¨‹ï¼š

1. ä»£ç /é…ç½®å˜æ›´
       â”‚
       â–¼
2. CI/CD Pipeline è§¦å‘ Packer æ„å»º
       â”‚
       â–¼
3. æ–° AMI åˆ›å»ºï¼ˆami-new-123ï¼‰
       â”‚
       â–¼
4. æ›´æ–° Launch Template ç‰ˆæœ¬
       â”‚
       â–¼
5. ASG Instance Refresh
       â”‚
       â–¼
6. æ–°å®ä¾‹å¯åŠ¨ï¼Œæ—§å®ä¾‹ç»ˆæ­¢
       â”‚
       â–¼
7. éªŒè¯æˆåŠŸ â†’ æ ‡è®°æ—§ AMI ä¸º deprecated
   éªŒè¯å¤±è´¥ â†’ å›æ»šåˆ°æ—§ Launch Template ç‰ˆæœ¬
```

### ä¸ cloud-init çš„é…åˆ

```bash
# ä¸å¯å˜åŸºç¡€è®¾æ–½ä¸­ cloud-init çš„è§’è‰²

# AMI åŒ…å«ï¼š
# - æ“ä½œç³»ç»Ÿ + æ‰€æœ‰è½¯ä»¶
# - æ‰€æœ‰é…ç½®ï¼ˆé™æ€éƒ¨åˆ†ï¼‰
# - ç›‘æ§ Agent

# cloud-init åªè´Ÿè´£ï¼š
# - è®¾ç½®ä¸»æœºå
# - æ³¨å†Œåˆ°æœåŠ¡å‘ç°
# - ä» Secrets Manager è·å–å¯†é’¥
# - å¯åŠ¨åº”ç”¨æœåŠ¡

# ç¤ºä¾‹ user-dataï¼ˆæœ€å°åŒ–ï¼‰
cat << 'EOF'
#cloud-config
hostname: web-${INSTANCE_ID}

runcmd:
  # ä» Secrets Manager è·å–é…ç½®
  - aws secretsmanager get-secret-value --secret-id app/config | jq -r '.SecretString' > /etc/app/config.json

  # æ³¨å†Œåˆ°æœåŠ¡å‘ç°
  - /opt/scripts/register-service.sh

  # å¯åŠ¨åº”ç”¨
  - systemctl start myapp
EOF
```

---

## åæ¨¡å¼æ¼”ç¤ºï¼ˆAnti-Patterns Demoï¼‰

### åæ¨¡å¼ 1ï¼šä¸æ¸…ç† machine-id

```bash
# å±é™©ï¼åˆ›å»º AMI å‰ä¸æ¸…ç† machine-id
# æ‰€æœ‰æ–°å®ä¾‹éƒ½ä¼šæœ‰ç›¸åŒçš„ ID

# åæœï¼š
# - DHCP å®¢æˆ·ç«¯ ID å†²çª
# - ç›‘æ§å·¥å…·æ— æ³•åŒºåˆ†å®ä¾‹
# - æ—¥å¿—èšåˆæ··ä¹±
# - systemd-journald å¯èƒ½è¦†ç›–æ—¥å¿—

# ä¿®å¤ï¼š
sudo truncate -s 0 /etc/machine-id
```

### åæ¨¡å¼ 2ï¼šé…ç½®æ¼‚ç§»

```bash
# å±é™©ï¼åœ¨è¿è¡Œä¸­çš„å®ä¾‹ä¸Šæ‰‹åŠ¨ä¿®æ”¹é…ç½®ï¼Œç„¶ååˆ›å»º AMI

# åœºæ™¯ï¼š
ssh ec2-user@instance
sudo vim /etc/nginx/nginx.conf  # æ‰‹åŠ¨ä¿®æ”¹
sudo systemctl restart nginx
# ...å‡ å‘¨å...
sudo create-ami  # å¿˜è®°äº†ä¿®æ”¹äº†ä»€ä¹ˆ

# åæœï¼š
# - AMI åŒ…å«æœªè®°å½•çš„é…ç½®
# - æ— æ³•å¤ç°ç¯å¢ƒ
# - å®¡è®¡å¤±è´¥ï¼š"è¿™ä¸ªé…ç½®æ˜¯è°åŠ çš„ï¼Ÿ"

# ä¿®å¤ï¼š
# æ‰€æœ‰é…ç½®å˜æ›´éƒ½é€šè¿‡ Packer provisioner æˆ– Ansible
# é…ç½® = ä»£ç ï¼Œæäº¤åˆ° Git
```

### åæ¨¡å¼ 3ï¼šæœªç»æµ‹è¯•çš„é•œåƒ

```bash
# å±é™©ï¼æ„å»ºå®Œç›´æ¥å‘å¸ƒåˆ°ç”Ÿäº§ç¯å¢ƒ

# åæœï¼š
# - æœåŠ¡å¯åŠ¨å¤±è´¥
# - ä¾èµ–ç¼ºå¤±
# - é…ç½®é”™è¯¯
# - ç”Ÿäº§äº‹æ•…

# ä¿®å¤ï¼š
# å»ºç«‹æµ‹è¯•æµç¨‹
packer build ...
# è‡ªåŠ¨æµ‹è¯•ï¼š
# 1. ä»æ–° AMI å¯åŠ¨æµ‹è¯•å®ä¾‹
# 2. è¿è¡Œå¥åº·æ£€æŸ¥
# 3. è¿è¡Œé›†æˆæµ‹è¯•
# 4. CIS æ‰«æ
# 5. é€šè¿‡åæ‰æ ‡è®°ä¸º approved
```

### åæ¨¡å¼ 4ï¼šå‡­è¯çƒ˜çƒ¤è¿› AMI

```bash
# å±é™©ï¼æŠŠå‡­è¯å†™å…¥ AMI

# é”™è¯¯ç¤ºä¾‹ï¼ˆPacker provisionerï¼‰ï¼š
provisioner "shell" {
  inline = [
    "echo 'AWS_ACCESS_KEY_ID=AKIAXXXXXX' >> /etc/profile.d/aws.sh",
    "echo 'DB_PASSWORD=secret123' >> /etc/app/config"
  ]
}

# åæœï¼š
# - æ‰€æœ‰å®ä¾‹å…±äº«ç›¸åŒå‡­è¯
# - å‡­è¯æ— æ³•è½®æ¢
# - å®‰å…¨å®¡è®¡å¤±è´¥
# - æ³„éœ²é£é™©æé«˜

# ä¿®å¤ï¼š
# å‡­è¯é€šè¿‡ Secrets Manager / Parameter Store è·å–
# åœ¨ cloud-init ä¸­åŠ¨æ€è·å–
runcmd:
  - aws secretsmanager get-secret-value --secret-id db/password | jq -r '.SecretString' > /etc/app/db-password
```

---

## èŒåœºå°è´´å£«ï¼ˆJapan IT Contextï¼‰

### ã‚´ãƒ¼ãƒ«ãƒ‡ãƒ³ã‚¤ãƒ¡ãƒ¼ã‚¸ã¯å¤‰æ›´ç®¡ç†ã®åŸºæœ¬

åœ¨æ—¥æœ¬ä¼ä¸šï¼Œ**é‡‘è‰²é•œåƒï¼ˆã‚´ãƒ¼ãƒ«ãƒ‡ãƒ³ã‚¤ãƒ¡ãƒ¼ã‚¸ï¼‰** æ˜¯å˜æ›´ç®¡ç†ï¼ˆå¤‰æ›´ç®¡ç†ï¼‰çš„æ ¸å¿ƒï¼š

| æ—¥è¯­æœ¯è¯­ | è¯»éŸ³ | å«ä¹‰ | é•œåƒå®è·µ |
|----------|------|------|----------|
| ã‚´ãƒ¼ãƒ«ãƒ‡ãƒ³ã‚¤ãƒ¡ãƒ¼ã‚¸ | ã‚´ãƒ¼ãƒ«ãƒ‡ãƒ³ã‚¤ãƒ¡ãƒ¼ã‚¸ | Golden Image | æ ‡å‡†åŒ–åŸºç¡€é•œåƒ |
| å¤‰æ›´ç®¡ç† | ã¸ã‚“ã“ã†ã‹ã‚“ã‚Š | Change Management | AMI ç‰ˆæœ¬æ§åˆ¶ |
| è¨­è¨ˆæ›¸ | ã›ã£ã‘ã„ã—ã‚‡ | Design Document | é•œåƒè§„æ ¼æ–‡æ¡£ |
| æ‰‹é †æ›¸ | ã¦ã˜ã‚…ã‚“ã—ã‚‡ | Procedure Document | é•œåƒæ„å»ºæ­¥éª¤ |
| æ§‹æˆç®¡ç† | ã“ã†ã›ã„ã‹ã‚“ã‚Š | Configuration Management | é•œåƒé…ç½®è¿½è¸ª |

### æ—¥æœ¬ä¼ä¸šçš„é•œåƒç®¡ç†è¦æ±‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            ã‚´ãƒ¼ãƒ«ãƒ‡ãƒ³ã‚¤ãƒ¡ãƒ¼ã‚¸ç®¡ç†ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ                               â”‚
â”‚            (Golden Image Management Checklist)                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  1. æ§‹æˆç®¡ç† (Configuration Management)                                     â”‚
â”‚     â–¡ å…¨ã¦ã®ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ãŒè¨­è¨ˆæ›¸ã¨ä¸€è‡´ã—ã¦ã„ã‚‹ã‹                             â”‚
â”‚     â–¡ ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·ãŒæ­£ã—ãä»˜ä¸ã•ã‚Œã¦ã„ã‚‹ã‹                                 â”‚
â”‚     â–¡ å¤‰æ›´å±¥æ­´ãŒè¨˜éŒ²ã•ã‚Œã¦ã„ã‚‹ã‹                                            â”‚
â”‚                                                                             â”‚
â”‚  2. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ (Security)                                                 â”‚
â”‚     â–¡ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ‘ãƒƒãƒãŒé©ç”¨ã•ã‚Œã¦ã„ã‚‹ã‹                                   â”‚
â”‚     â–¡ CIS ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ã«æº–æ‹ ã—ã¦ã„ã‚‹ã‹                                      â”‚
â”‚     â–¡ è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³ã‚’ãƒ‘ã‚¹ã—ã¦ã„ã‚‹ã‹                                        â”‚
â”‚                                                                             â”‚
â”‚  3. ãƒ†ã‚¹ãƒˆ (Testing)                                                        â”‚
â”‚     â–¡ æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆã‚’ãƒ‘ã‚¹ã—ã¦ã„ã‚‹ã‹                                            â”‚
â”‚     â–¡ æ€§èƒ½ãƒ†ã‚¹ãƒˆã‚’ãƒ‘ã‚¹ã—ã¦ã„ã‚‹ã‹                                            â”‚
â”‚     â–¡ æœ¬ç•ªç’°å¢ƒã¨ã®äº’æ›æ€§ãŒç¢ºèªã•ã‚Œã¦ã„ã‚‹ã‹                                   â”‚
â”‚                                                                             â”‚
â”‚  4. æ‰¿èª (Approval)                                                         â”‚
â”‚     â–¡ å¤‰æ›´ç®¡ç†å§”å“¡ä¼šã®æ‰¿èªã‚’å¾—ã¦ã„ã‚‹ã‹                                      â”‚
â”‚     â–¡ ãƒªãƒªãƒ¼ã‚¹è²¬ä»»è€…ã®æ‰¿èªã‚’å¾—ã¦ã„ã‚‹ã‹                                      â”‚
â”‚     â–¡ ç›£æŸ»è¨¼è·¡ãŒä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã‹                                            â”‚
â”‚                                                                             â”‚
â”‚  ç¢ºèªæ—¥: ____________  ç¢ºèªè€…: ____________                                  â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### è¨­è¨ˆæ›¸ã¨ã®ä¸€è‡´ã‚’è¨¼æ˜

æ—¥æœ¬ä¼ä¸šé€šå¸¸è¦æ±‚"è®¾è®¡æ–‡æ¡£ä¸å®é™…é…ç½®çš„ä¸€è‡´æ€§è¯æ˜"ï¼š

```bash
# ç”Ÿæˆä¸è®¾è®¡æ–‡æ¡£æ¯”è¾ƒçš„æŠ¥å‘Š

# 1. ä»è®¾è®¡æ–‡æ¡£è·å–æœŸæœ›çš„è½¯ä»¶åˆ—è¡¨
# ï¼ˆå®é™…ä¸­ä»å†…éƒ¨ç³»ç»Ÿæˆ–æ–‡æ¡£è·å–ï¼‰
cat > /tmp/design-spec.txt << 'EOF'
# è¨­è¨ˆæ›¸: SYS-2025-001
# å¯¾è±¡: Web Server Golden Image
# å¿…é ˆã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢:
nginx >= 1.24.0
amazon-cloudwatch-agent >= 1.300000
amazon-ssm-agent >= 3.2.0
EOF

# 2. ç”Ÿæˆå®é™…å®‰è£…æ¸…å•
rpm -qa --qf '%{NAME} %{VERSION}\n' | sort > /tmp/actual-packages.txt

# 3. ç”Ÿæˆæ¯”è¾ƒæŠ¥å‘Š
echo "=== è¨­è¨ˆæ›¸ã¨ã®å·®åˆ†ãƒ¬ãƒãƒ¼ãƒˆ ==="
echo "Date: $(date)"
echo ""
echo "æœŸå¾…: $(grep -c '>=' /tmp/design-spec.txt) å€‹ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸"
echo "å®Ÿéš›: $(wc -l < /tmp/actual-packages.txt) å€‹ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿"
echo ""
echo "å¿…é ˆãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ç¢ºèª:"
grep '>=' /tmp/design-spec.txt | while read pkg ver; do
    if grep -q "^$pkg " /tmp/actual-packages.txt; then
        actual_ver=$(grep "^$pkg " /tmp/actual-packages.txt | awk '{print $2}')
        echo "  [OK] $pkg: $actual_ver"
    else
        echo "  [NG] $pkg: æœªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«"
    fi
done
```

---

## æ£€æŸ¥æ¸…å•

å®Œæˆæœ¬è¯¾åï¼Œä½ åº”è¯¥èƒ½å¤Ÿï¼š

- [ ] è§£é‡Š Bake vs Bootstrap çš„å†³ç­–æ¡†æ¶
- [ ] æè¿°æ··åˆæ¨¡å¼ï¼ˆBake åŸºç¡€ + Bootstrap é…ç½®ï¼‰çš„ä¼˜åŠ¿
- [ ] ä½¿ç”¨ Packer åˆ›å»ºåŸºæœ¬çš„é‡‘è‰²é•œåƒ
- [ ] ç¼–å†™é•œåƒæ¸…ç†ï¼ˆsealï¼‰è„šæœ¬
- [ ] æ­£ç¡®å¤„ç† machine-idã€SSH keysã€cloud-init çŠ¶æ€
- [ ] ç†è§£é•œåƒç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼ˆæ„å»ºã€æµ‹è¯•ã€å‘å¸ƒã€å¼ƒç”¨ï¼‰
- [ ] ç”Ÿæˆé…ç½®å®¡è®¡æŠ¥å‘Š
- [ ] é¿å…å¸¸è§çš„é•œåƒåæ¨¡å¼ï¼ˆæœªæ¸…ç†ã€é…ç½®æ¼‚ç§»ã€å‡­è¯çƒ˜çƒ¤ï¼‰
- [ ] ç†è§£æ—¥æœ¬ä¼ä¸šå¯¹é‡‘è‰²é•œåƒçš„ç®¡ç†è¦æ±‚

---

## æœ¬è¯¾å°ç»“

| æ¦‚å¿µ | è¦ç‚¹ |
|------|------|
| Bake vs Bootstrap | æ··åˆæ¨¡å¼æœ€ä½³ï¼šBake åŸºç¡€è½¯ä»¶ + Bootstrap åŠ¨æ€é…ç½® |
| Packer | HashiCorp é•œåƒæ„å»ºå·¥å…·ï¼Œæ”¯æŒå¤šäº‘ |
| é•œåƒæ¸…ç† | å¿…é¡»æ¸…é™¤ machine-idã€SSH keysã€cloud-init çŠ¶æ€ |
| ç”Ÿå‘½å‘¨æœŸ | æ„å»º â†’ æµ‹è¯• â†’ å‘å¸ƒ â†’ è¿è¡Œ â†’ å¼ƒç”¨ â†’ åˆ é™¤ |
| ä¸å¯å˜åŸºç¡€è®¾æ–½ | æ›´æ–° = æ›¿æ¢ï¼Œæ— é…ç½®æ¼‚ç§» |
| åæ¨¡å¼ | ä¸æ¸…ç†ã€é…ç½®æ¼‚ç§»ã€æœªæµ‹è¯•ã€å‡­è¯çƒ˜çƒ¤ |

---

## å»¶ä¼¸é˜…è¯»

- [Packer Documentation](https://developer.hashicorp.com/packer/docs) - å®˜æ–¹æ–‡æ¡£
- [EC2 Image Builder](https://docs.aws.amazon.com/imagebuilder/) - AWS åŸç”Ÿé•œåƒæ„å»º
- [AMI Lifecycle](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ami-lifecycle.html) - AMI ç”Ÿå‘½å‘¨æœŸç®¡ç†
- [Immutable Infrastructure](https://www.hashicorp.com/resources/what-is-mutable-vs-immutable-infrastructure) - ä¸å¯å˜åŸºç¡€è®¾æ–½æ¦‚å¿µ
- å‰ä¸€è¯¾ï¼š[06 - IAM ä¸å®ä¾‹é…ç½®æ–‡ä»¶](../06-iam-instance-profiles/) - IAM å‡­è¯ç®¡ç†
- ä¸‹ä¸€è¯¾ï¼š[08 - é•œåƒåŠ å›ºä¸ä¾›åº”é“¾å®‰å…¨](../08-image-hardening/) - CIS åŸºçº¿ä¸å®‰å…¨åŠ å›º

---

## æ¸…ç†èµ„æº

```bash
# åˆ é™¤å®éªŒä¸­åˆ›å»ºçš„ AMIï¼ˆå¦‚æœæœ‰ï¼‰
# aws ec2 deregister-image --image-id ami-xxxx
# aws ec2 delete-snapshot --snapshot-id snap-xxxx

# æ¸…ç†æœ¬åœ°ä¸´æ—¶æ–‡ä»¶
rm -f /tmp/installed-packages.txt
rm -f /tmp/approved-packages.txt
rm -f /tmp/audit-report-*.txt
rm -f /tmp/check-machine-id.sh
rm -f /tmp/ami-readiness-check.sh
rm -f /tmp/generate-audit-report.sh
rm -rf ~/packer-lab

echo "æ¸…ç†å®Œæˆ"
```

---

## ç³»åˆ—å¯¼èˆª

[<- 06 - IAM ä¸å®ä¾‹é…ç½®æ–‡ä»¶](../06-iam-instance-profiles/) | [ç³»åˆ—é¦–é¡µ](../) | [08 - é•œåƒåŠ å›ºä¸ä¾›åº”é“¾å®‰å…¨ ->](../08-image-hardening/)
