# 05 · 故障时间线重建 + 障害報告書撰写

> **目标**：跨系统、跨时区重建故障时间线，撰写规范的日语障害報告書  
> **前置**：[04 · AWS 日志实战](../04-aws-logs/)、[03 · Web 服务器日志](../03-web-server-logs/)  
> **区域**：任意  
> **费用**：无额外费用

## 将完成的内容

1. 跨系统收集日志
2. 统一时区（UTC ↔ JST）
3. 重建故障时间线
4. 撰写日本企业标准障害報告書
5. 实战：分析批处理误删导致的服务 500

---

## 时区处理基础

### UTC 与 JST 换算

日本标准时间 (JST) = UTC + 9 小时

| UTC | JST |
|-----|-----|
| 00:00 | 09:00 |
| 01:00 | 10:00 |
| 12:00 | 21:00 |
| 15:00 | 00:00 (次日) |

### 常见日志时区

| 日志来源 | 默认时区 | 格式示例 |
|---------|---------|---------|
| AWS CloudTrail | UTC | `2024-06-25T00:02:10Z` |
| AWS VPC Flow | UTC (epoch) | `1719273600` |
| Nginx (+0900) | 可配置 | `[25/Jun/2024:09:02:12 +0900]` |
| journalctl | 系统时区 | `Jun 25 09:02:12` |
| 应用日志 | 看框架 | 需确认 |

### 时区转换命令

```bash
# UTC → JST
TZ='Asia/Tokyo' date -d "2024-06-25T00:02:10Z"
# 输出: Wed Jun 25 09:02:10 JST 2024

# epoch → JST
TZ='Asia/Tokyo' date -d @1719273600

# JST → UTC（减 9 小时）
# 09:02 JST = 00:02 UTC
```

### 识别无时区标记的日志

**危险**：有些日志没有时区标记！

```
# 无时区标记 - 需要确认是什么时区
2024-06-25 09:01:55 rm -rf /tmp/session.*

# 有时区标记 - 明确
[25/Jun/2024:09:02:12 +0900]
2024-06-25T00:02:10Z
```

**最佳实践**：发现无时区日志时，先确认系统时区：

```bash
timedatectl
# 或
cat /etc/timezone
```

---

## 时间线重建方法

### Step 1: 收集多源日志

从所有相关系统收集日志片段：
- 应用日志
- Web 服务器日志
- 系统日志 (journalctl)
- 监控告警
- 变更记录

### Step 2: 统一时区

选择一个标准时区（推荐 JST，因为报告给日本客户）：

```bash
# 创建时间线文件
echo "# Incident Timeline (JST)" > timeline.md

# 转换各日志时间并追加
# App log (UTC)
echo "| 09:02:10 JST | App | ERROR failed to open /tmp/session.lock |" >> timeline.md

# Batch log (假定 JST)
echo "| 09:01:55 JST | Batch | rm -rf /tmp/session.* |" >> timeline.md

# Nginx (JST +0900)
echo "| 09:02:12 JST | Nginx | POST /login 500 |" >> timeline.md
```

### Step 3: 按时间排序

```markdown
| 时间 (JST) | 来源 | 事件 |
|------------|------|------|
| 09:01:55 | Batch | rm -rf /tmp/session.* |
| 09:02:10 | App | ERROR failed to open /tmp/session.lock |
| 09:02:12 | Nginx | POST /login 500 |
```

### Step 4: 标注因果关系

```markdown
| 时间 (JST) | 来源 | 事件 | 备注 |
|------------|------|------|------|
| 09:01:55 | Batch | rm -rf /tmp/session.* | ← 根因 |
| 09:02:10 | App | ERROR failed to open /tmp/session.lock | ← 直接影响 |
| 09:02:12 | Nginx | POST /login 500 | ← 用户可见 |
```

---

## 障害報告書模板

日本企业的障害報告書（incident report）有固定格式：

### 完整模板

```markdown
# 障害報告書

## 件名/概要
[発生日時] 2024-06-25 09:02-09:20 JST ログイン機能500エラー増加

## 影響範囲
- 影響時間: 2024-06-25 09:02-09:20 JST (約18分間)
- 影響サービス: ログイン機能
- 影響ユーザー数: 約150件のリクエストが500エラー
- エラー率: 12.3%

## 原因
バッチ処理スクリプトが /tmp/session.* を削除。
アプリケーションのセッションロックファイルが消失し、500エラーが発生。

## 時系列
| 時刻 (JST) | イベント |
|------------|----------|
| 09:01:55 | Cron バッチ実行、/tmp/session.* 削除 |
| 09:02:10 | App ERROR: failed to open /tmp/session.lock |
| 09:02:12 | Nginx 500エラー開始 |
| 09:10:00 | 監視アラート受信、調査開始 |
| 09:15:00 | Cron タスク無効化、ロックファイル手動復旧 |
| 09:20:00 | サービス正常復旧確認 |

## 対応
1. 09:10 - アラート受信、ログ調査開始
2. 09:12 - batch ログで rm コマンド発見
3. 09:15 - Cron タスク停止、/tmp/session.lock 手動作成
4. 09:20 - サービス正常復旧確認

## 再発防止策
| 項目 | 対策 | 担当 | 期限 |
|------|------|------|------|
| 検知 | /tmp/session.lock 存在監視追加 | インフラ | 2024-06-28 |
| 予防 | Cron スクリプトにホワイトリスト導入 | 開発 | 2024-07-05 |
| 変更管理 | スクリプト変更時レビュー必須化 | チーム | 即時 |

## 教訓/フォローアップ
- tmp ディレクトリの一括削除は影響範囲を事前確認必須
- Health check にロックファイル検証追加を検討
```

### 各セクション解説

#### 件名/概要（概要）

**良い例**：
```
[JST] 2024-06-25 09:02-09:20 ログイン500増加
```

**悪い例**：
```
系统挂了
サーバーダウン
```

ポイント：
- 時間を明記
- 影響を一言で
- 専門用語OK

#### 影響範囲（影响范围）

**良い例**：
```
09:02-09:20 JST, 12.3% 登录请求返回 500
日本东区用户受影响，约 150 件请求失败
```

**悪い例**：
```
有点慢
用户受影响
```

ポイント：
- 時間範囲を明記
- 数値で量化
- ユーザー視点で影響を説明

#### 原因（原因）

**良い例**：
```
バッチが /tmp/session.* を削除
アプリのロックファイル缺失により 500 発生
```

**悪い例**：
```
程序有 bug
設定ミス
```

ポイント：
- 技術的に正確
- 因果関係を説明

#### 時系列（时间线）

**良い例**：
```
| 時刻 (JST) | イベント |
|------------|----------|
| 09:01:55 | Cron 実行 |
| 09:02:10 | App ERROR |
```

**悪い例**：
```
UTC と JST 混在
時刻なしで「その後」
```

ポイント：
- 時区を統一・明記
- 秒単位まで正確に
- 全てのキーイベントを含める

#### 再発防止策（防止再发）

**良い例**：
```
- 検知: 監視追加
- 予防: ホワイトリスト導入
- 変更管理: レビュー必須化
```

**悪い例**：
```
注意する
気をつける
教育を強化
```

ポイント：
- 具体的なアクション
- 担当と期限を明記
- 技術的な対策

---

## 実戦練習：批处理误删导致服务 500

### 场景描述

运维收到告警：「09:02 开始 login API 大量 500」。需要分析原因并撰写报告。

### 日志样本

**App 日志（UTC）：**
```
2024-06-25T00:02:10Z ERROR failed to open /tmp/session.lock: No such file
```

**Batch 日志（JST，无时区标记）：**
```
2024-06-25 09:01:55 rm -rf /tmp/session.*
```

**Nginx 日志（JST）：**
```
[25/Jun/2024:09:02:12 +0900] "POST /login" 500 321
```

### 分析步骤

**Step 1: 统一时区**

| 原始时间 | 来源时区 | JST 时间 |
|---------|---------|---------|
| 2024-06-25T00:02:10Z | UTC | 09:02:10 |
| 2024-06-25 09:01:55 | JST(假定) | 09:01:55 |
| 25/Jun/2024:09:02:12 +0900 | JST | 09:02:12 |

**Step 2: 排序时间线**

```
09:01:55 JST - Batch: rm -rf /tmp/session.*
09:02:10 JST - App: ERROR failed to open /tmp/session.lock
09:02:12 JST - Nginx: POST /login 500
```

**Step 3: 确认因果关系**

1. Batch 删除了 `/tmp/session.*`
2. App 无法打开 session.lock（15 秒后报错）
3. Nginx 返回 500（2 秒后用户可见）

### 发现要点

| 层次 | 发现 |
|------|------|
| **显而易见** | Batch 删除了 session 文件导致 App 500 |
| **需要细看** | Batch 日志无时区标记但假定 JST；App 用 UTC 需要转换 |

---

## 面试常见问题

### Q1: UTC/JST 混合时如何重建时间线？

**期望回答**：
> 1. 识别每个日志的时区（UTC、JST、无标记）
> 2. 统一转换到一个时区（通常选 JST）
> 3. 按转换后的时间排序
> 4. 标注原始时区以便追溯

**红旗回答**：
- 直接按原字符串排序
- 不关心时区差异

### Q2: 報告書里「再発防止」常见要素？

**期望回答**：
> - 检测机制：添加监控告警
> - 自动化：自愈/自动回滚
> - 变更管控：审批流程/变更冻结
> - 容量：预估/压测/限流

**红旗回答**：
- 写「加强培训」
- 写「注意」
- 无具体措施

---

## 常见错误

1. **时区混淆：JST(+0900) vs UTC**
   - 必须每个日志确认时区

2. **未统一时区就排序时间线**
   - 会导致因果关系错误

3. **報告書只写「已恢复」，无检测/再発防止**
   - 日本企业要求具体对策

---

## 障害報告書写作 Checklist

```markdown
- [ ] 件名包含时间和影响摘要
- [ ] 影響範囲有数值量化
- [ ] 原因技术准确
- [ ] 時系列时区统一且明确
- [ ] 対応有具体操作和时间
- [ ] 再発防止有具体措施、担当、期限
- [ ] 无敬语错误
- [ ] 无时区混淆
```

---

## 快速参考

| 需求 | 命令/格式 |
|------|----------|
| UTC → JST | `TZ='Asia/Tokyo' date -d "2024-06-25T00:02:10Z"` |
| epoch → JST | `TZ='Asia/Tokyo' date -d @1719273600` |
| 检查系统时区 | `timedatectl` |
| JST = UTC + 9 | 00:00 UTC = 09:00 JST |

---

## 下一步

- [06 · RCA 根因分析实战](../06-rca-practice/) - Five Whys 方法论 + 完整 RCA 练习

## 系列导航 / Series Nav

| 课程 | 主题 |
|------|------|
| [00 · Linux 日志系统概览](../00-linux-logs/) | journalctl, dmesg, auth.log |
| [01 · 日志分析工具与模式识别](../01-tools-patterns/) | grep/rg/jq/less |
| [02 · systemd 服务日志分析](../02-systemd-logs/) | crash loop, timeout |
| [03 · Web 服务器日志](../03-web-server-logs/) | Nginx/Apache 5xx |
| [04 · AWS 日志实战](../04-aws-logs/) | CloudTrail, VPC Flow |
| **05 · 故障时间线重建** | 当前 |
| [06 · RCA 根因分析实战](../06-rca-practice/) | Five Whys |
