# 06 - ä¼ä¸šå®æˆ˜ä¸æ—¥æœ¬ IT è¿ç»´

> **ç›®æ ‡**ï¼šæŒæ¡ CloudFormation ä¼ä¸šçº§è¿ç»´èƒ½åŠ›ï¼Œç†è§£æ—¥æœ¬ IT èŒåœºçš„å˜æ›´ç®¡ç†æµç¨‹
> **æ—¶é—´**ï¼š90 åˆ†é’Ÿ
> **è´¹ç”¨**ï¼š$0.50-1.00ï¼ˆCloudTrailã€Configã€CloudWatchï¼‰
> **å‰ç½®**ï¼šå®Œæˆ [05 - Drift æ£€æµ‹ä¸èµ„æºå¯¼å…¥](../05-drift-import/)

---

## å°†å­¦åˆ°çš„å†…å®¹

1. ä½¿ç”¨ StackSets å®ç°å¤šè´¦æˆ·/å¤šåŒºåŸŸéƒ¨ç½²
2. é…ç½® cfn-guard ç­–ç•¥æ£€æŸ¥ï¼ˆPolicy as Codeï¼‰
3. è®¾è®¡æ—¥æœ¬ä¼ä¸šé£æ ¼çš„å¤‰æ›´ç®¡ç†æµç¨‹
4. é…ç½®å®¡è®¡åˆè§„ï¼ˆCloudTrail + Configï¼‰
5. ç»¼åˆæ¼”ç»ƒï¼šç›‘æ§åŸºç¡€è®¾æ–½ + å¤‰æ›´ç®¡ç†æ›¸

---

## ä¸ºä»€ä¹ˆå­¦è¿™ä¸ªï¼Ÿï¼ˆæ—¥æœ¬ IT èŒåœºèƒŒæ™¯ï¼‰

åœ¨æ—¥æœ¬çš„ SIerï¼ˆSystem Integratorï¼‰å’Œä¼ä¸š IT ç¯å¢ƒä¸­ï¼ŒåŸºç¡€è®¾æ–½å˜æ›´éœ€è¦ä¸¥æ ¼çš„æµç¨‹ï¼š

![Japanese IT Enterprise Change Management Flow](images/japan-it-change-flow.png)

<details>
<summary>ğŸ“ ASCII æºç ï¼ˆç‚¹å‡»å±•å¼€ï¼‰</summary>

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ—¥æœ¬ IT ä¼ä¸šå˜æ›´ç®¡ç†æµç¨‹                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚   é–‹ç™ºæ‹…å½“         é‹ç”¨æ‹…å½“          æ‰¿èªè€…           å®Ÿè¡Œè€…                   â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚   â”‚ å¤‰æ›´  â”‚â”€â”€â”€â”€â”€â”€â–¶â”‚ChangeSetâ”‚â”€â”€â”€â”€â”€â”€â–¶â”‚ æ‰¿èª  â”‚â”€â”€â”€â”€â”€â”€â–¶â”‚ å®Ÿè¡Œ  â”‚                   â”‚
â”‚   â”‚ ç”³è«‹  â”‚       â”‚ ä½œæˆ   â”‚       â”‚      â”‚       â”‚      â”‚                   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚       â”‚              â”‚              â”‚              â”‚                        â”‚
â”‚       â–¼              â–¼              â–¼              â–¼                        â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚   â”‚å¤‰æ›´ç®¡ç†â”‚       â”‚å½±éŸ¿ç¯„å›²â”‚       â”‚æ‰¿èªè¨˜éŒ²â”‚       â”‚ è¨¼è·¡  â”‚                   â”‚
â”‚   â”‚  ç¥¨   â”‚       â”‚ã‚¹ã‚¯ã‚·ãƒ§â”‚       â”‚ã‚¿ã‚¤ãƒ ã‚¹â”‚       â”‚CloudTâ”‚                   â”‚
â”‚   â”‚      â”‚       â”‚      â”‚       â”‚ã‚¿ãƒ³ãƒ— â”‚       â”‚rail  â”‚                   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚                                                                             â”‚
â”‚   å¤‰æ›´ç®¡ç†æ›¸      ChangeSet        æ‰¿èªãƒ¡ãƒ¼ãƒ«      CloudTrail                   â”‚
â”‚   (Excel/Md)     screenshot       (ã‚¨ãƒ“ãƒ‡ãƒ³ã‚¹)     API ãƒ­ã‚°                    â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

</details>

**æ—¥æœ¬ä¼ä¸šçš„ç‰¹ç‚¹**ï¼š

| æ—¥è¯­æœ¯è¯­ | è¯»éŸ³ | å«ä¹‰ | CloudFormation å¯¹åº” |
|----------|------|------|---------------------|
| å¤‰æ›´ç®¡ç† | ã¸ã‚“ã“ã†ã‹ã‚“ã‚Š | å˜æ›´ç®¡ç† | ChangeSet å®¡æ‰¹æµç¨‹ |
| ç›£æŸ»å¯¾å¿œ | ã‹ã‚“ã•ãŸã„ãŠã† | å®¡è®¡åˆè§„ | CloudTrail + Config |
| è¨¼è·¡ | ã—ã‚‡ã†ã›ã | å®¡è®¡æ—¥å¿— | CloudTrail API è®°å½• |
| é‹ç”¨ç›£è¦– | ã†ã‚“ã‚ˆã†ã‹ã‚“ã— | è¿ç»´ç›‘æ§ | CloudWatch Alarms |
| è¨­è¨ˆæ›¸ | ã›ã£ã‘ã„ã—ã‚‡ | è®¾è®¡æ–‡æ¡£ | CFn Template = è®¾è®¡ä¹¦ |

---

## Step 1 â€” å…ˆè·‘èµ·æ¥ï¼éƒ¨ç½²ç›‘æ§åŸºç¡€è®¾æ–½ï¼ˆ15 åˆ†é’Ÿï¼‰

> å…ˆä½“éªŒä¼ä¸šçº§ç›‘æ§å‘Šè­¦ï¼Œå†ç†è§£èƒŒååŸç†ã€‚

### 1.1 å‡†å¤‡æ¨¡æ¿

æœ¬è¯¾æä¾›ä¸¤ä¸ªå®Œæ•´æ¨¡æ¿ï¼š

```
code/
â”œâ”€â”€ audit-infra.yaml         # CloudTrail + Configï¼ˆå®¡è®¡åˆè§„ï¼‰
â”œâ”€â”€ monitoring-alarms.yaml   # CloudWatch Alarmsï¼ˆè¿ç»´ç›‘æ§ï¼‰
â””â”€â”€ cfn-guard-rules/         # Policy as Code è§„åˆ™
    â”œâ”€â”€ s3-encryption.guard
    â””â”€â”€ required-tags.guard
```

### 1.2 éƒ¨ç½² CloudWatch ç›‘æ§å‘Šè­¦

å…ˆä»ç®€å•çš„ç›‘æ§å‘Šè­¦å¼€å§‹ï¼š

1. ç™»å½• AWS Console â†’ CloudFormation
2. ç‚¹å‡» **Create stack** â†’ **With new resources (standard)**
3. é€‰æ‹© **Upload a template file**
4. ä¸Šä¼  `code/monitoring-alarms.yaml`
5. Stack name: `enterprise-monitoring`

<!-- SCREENSHOT: cfn-enterprise-monitoring-create -->

6. å‚æ•°è®¾ç½®ï¼š
   - **NotificationEmail**: ä½ çš„é‚®ç®±ï¼ˆæ¥æ”¶å‘Šè­¦ï¼‰
   - **CPUThreshold**: 80ï¼ˆCPU è¶…è¿‡ 80% å‘Šè­¦ï¼‰
   - **MemoryThreshold**: 85ï¼ˆå†…å­˜è¶…è¿‡ 85% å‘Šè­¦ï¼‰

7. ç‚¹å‡» **Next** â†’ **Next**
8. âš ï¸ **é‡è¦**ï¼šåœ¨æœ€åä¸€é¡µï¼Œä½ **å¿…é¡»**å‹¾é€‰ä»¥ä¸‹å¤é€‰æ¡†æ‰èƒ½åˆ›å»º Stackï¼š
   - â˜‘ï¸ **I acknowledge that AWS CloudFormation might create IAM resources.**

   > è¿™æ˜¯å› ä¸ºæ¨¡æ¿ä¸­åŒ…å« SNS Topic Policy ç­‰ IAM ç›¸å…³èµ„æºã€‚
   > å¦‚æœä¸å‹¾é€‰ï¼ŒCreate æŒ‰é’®ä¼šä¿æŒç°è‰²æ— æ³•ç‚¹å‡»ï¼

9. ç‚¹å‡» **Submit**

### 1.3 ç¡®è®¤ SNS è®¢é˜…

éƒ¨ç½²å®Œæˆåï¼Œæ£€æŸ¥é‚®ç®±ï¼š

1. æ‰¾åˆ°æ¥è‡ª AWS çš„è®¢é˜…ç¡®è®¤é‚®ä»¶
2. ç‚¹å‡» **Confirm subscription** é“¾æ¥
3. çœ‹åˆ° "Subscription confirmed!" é¡µé¢

<!-- SCREENSHOT: sns-subscription-confirm -->

### 1.4 éªŒè¯å‘Šè­¦å·²åˆ›å»º

1. è¿›å…¥ CloudWatch Console â†’ **Alarms** â†’ **All alarms**
2. æ‰¾åˆ°ä»¥ `enterprise-monitoring` å¼€å¤´çš„å‘Šè­¦
3. çŠ¶æ€åº”ä¸º `INSUFFICIENT_DATA`ï¼ˆå°šæ— ç›‘æ§æ•°æ®ï¼‰

æ­å–œï¼ä½ å·²ç»éƒ¨ç½²äº†ä¼ä¸šçº§ç›‘æ§åŸºç¡€è®¾æ–½ï¼

---

## Step 2 â€” å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿï¼ˆ10 åˆ†é’Ÿï¼‰

### 2.1 ç›‘æ§æ¶æ„

![Enterprise Monitoring Architecture](images/enterprise-monitoring-arch.png)

<details>
<summary>ğŸ“ ASCII æºç ï¼ˆç‚¹å‡»å±•å¼€ï¼‰</summary>

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       Enterprise Monitoring Architecture                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚   â”‚   EC2     â”‚         â”‚CloudWatch â”‚         â”‚   SNS     â”‚                â”‚
â”‚   â”‚  (ç›‘æ§)    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚  Alarm    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚  Topic    â”‚                â”‚
â”‚   â”‚           â”‚ Metrics â”‚  (å‘Šè­¦)    â”‚ Trigger â”‚  (é€šçŸ¥)    â”‚                â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                                                       â”‚                      â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚                      â”‚
â”‚   â”‚   RDS     â”‚         â”‚CloudWatch â”‚               â–¼                      â”‚
â”‚   â”‚  (ç›‘æ§)    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚  Alarm    â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚   â”‚           â”‚ Metrics â”‚  (å‘Šè­¦)    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚   Email   â”‚               â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚  (è¿ç»´)    â”‚               â”‚
â”‚                                                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                                                                             â”‚
â”‚   é€šè¿‡ CloudFormation ä¸€é”®éƒ¨ç½²ï¼Œç¡®ä¿æ‰€æœ‰ç¯å¢ƒå‘Šè­¦é…ç½®ä¸€è‡´                          â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

</details>

### 2.2 æ¨¡æ¿ç»“æ„è§£æ

æ‰“å¼€ `monitoring-alarms.yaml`ï¼Œå…³é”®ç»„ä»¶ï¼š

```yaml
Resources:
  # 1. SNS Topicï¼ˆé€šçŸ¥æ¸ é“ï¼‰
  AlertTopic:
    Type: AWS::SNS::Topic
    Properties:
      TopicName: !Sub '${AWS::StackName}-alerts'

  # 2. Email è®¢é˜…
  EmailSubscription:
    Type: AWS::SNS::Subscription
    Properties:
      TopicArn: !Ref AlertTopic
      Protocol: email
      Endpoint: !Ref NotificationEmail

  # 3. CloudWatch Alarmï¼ˆå‘Šè­¦è§„åˆ™ï¼‰
  HighCPUAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmDescription: "CPU ä½¿ç”¨ç‡è¶…è¿‡é˜ˆå€¼ - ç•°å¸¸æ¤œçŸ¥"
      MetricName: CPUUtilization
      Namespace: AWS/EC2
      Threshold: !Ref CPUThreshold
      AlarmActions:
        - !Ref AlertTopic  # è§¦å‘æ—¶å‘é€é€šçŸ¥
```

**æ—¥æœ¬ IT åœºæ™¯**ï¼šè¿™å¥—æ¶æ„åœ¨æ—¥æœ¬ä¼ä¸šå«ã€Œé‹ç”¨ç›£è¦–ã€ï¼ˆã†ã‚“ã‚ˆã†ã‹ã‚“ã—ï¼‰ã€‚å‘Šè­¦é‚®ä»¶é€šå¸¸å‘é€åˆ°è¿ç»´å›¢é˜Ÿçš„å…±äº«é‚®ç®±ï¼Œç”±å½“å€¼äººå‘˜å“åº”ã€‚

---

## Step 3 â€” æ ¸å¿ƒæ¦‚å¿µï¼šä¼ä¸šçº§ CloudFormationï¼ˆ20 åˆ†é’Ÿï¼‰

### 3.1 StackSetsï¼šå¤šè´¦æˆ·/å¤šåŒºåŸŸéƒ¨ç½²

åœ¨å¤§å‹ä¼ä¸šï¼Œé€šå¸¸æœ‰å¤šä¸ª AWS è´¦æˆ·ï¼ˆå¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§ã€å®‰å…¨å®¡è®¡ç­‰ï¼‰ã€‚StackSets å…è®¸ä½ ç”¨ä¸€ä¸ªæ¨¡æ¿éƒ¨ç½²åˆ°å¤šä¸ªè´¦æˆ·/åŒºåŸŸã€‚

![StackSets Architecture](images/stacksets-architecture.png)

<details>
<summary>ğŸ“ ASCII æºç ï¼ˆç‚¹å‡»å±•å¼€ï¼‰</summary>

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           StackSets æ¶æ„                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚   ç®¡ç†è´¦æˆ· (Administrator Account)                                            â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                         StackSet                                     â”‚   â”‚
â”‚   â”‚                    (ä¸€ä¸ªæ¨¡æ¿, å¤šå¤„éƒ¨ç½²)                                  â”‚   â”‚
â”‚   â”‚                           â”‚                                          â”‚   â”‚
â”‚   â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚   â”‚
â”‚   â”‚        â–¼                  â–¼                  â–¼                      â”‚   â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚   â”‚
â”‚   â”‚   â”‚é–‹ç™ºè´¦æˆ·â”‚         â”‚æœ¬ç•ªè´¦æˆ·â”‚         â”‚ç›£æŸ»è´¦æˆ·â”‚                 â”‚   â”‚
â”‚   â”‚   â”‚(dev)  â”‚         â”‚(prod)  â”‚         â”‚(audit) â”‚                 â”‚   â”‚
â”‚   â”‚   â”‚       â”‚         â”‚        â”‚         â”‚        â”‚                 â”‚   â”‚
â”‚   â”‚   â”‚Tokyo  â”‚         â”‚Tokyo   â”‚         â”‚Tokyo   â”‚                 â”‚   â”‚
â”‚   â”‚   â”‚Osaka  â”‚         â”‚Osaka   â”‚         â”‚Virginiaâ”‚                 â”‚   â”‚
â”‚   â”‚   â”‚       â”‚         â”‚Singaporeâ”‚        â”‚        â”‚                 â”‚   â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚   â”‚
â”‚   â”‚                                                                      â”‚   â”‚
â”‚   â”‚   Stack Instance    Stack Instance    Stack Instance                â”‚   â”‚
â”‚   â”‚   (å„è´¦æˆ·/åŒºåŸŸ)      (å„è´¦æˆ·/åŒºåŸŸ)      (å„è´¦æˆ·/åŒºåŸŸ)                   â”‚   â”‚
â”‚   â”‚                                                                      â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

</details>

**ä¸¤ç§éƒ¨ç½²æ¨¡å¼**ï¼š

| æ¨¡å¼ | åç§° | é€‚ç”¨åœºæ™¯ | é…ç½®å¤æ‚åº¦ |
|------|------|----------|------------|
| Self-managed | è‡ªç®¡ç† | å°‘é‡è´¦æˆ·ã€é Organizations | éœ€æ‰‹åŠ¨é…ç½® IAM è§’è‰² |
| Service-managed | æœåŠ¡ç®¡ç† | Organizations ç¯å¢ƒ | è‡ªåŠ¨é…ç½®ï¼Œæ¨è |

**æ—¥æœ¬ä¼ä¸šåœºæ™¯**ï¼š

```
å…¸å‹å¤šè´¦æˆ·ç»“æ„:
â”œâ”€â”€ ç®¡ç†è´¦æˆ· (root)
â”œâ”€â”€ é–‹ç™º (Development)
â”œâ”€â”€ ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚° (Staging)
â”œâ”€â”€ æœ¬ç•ª (Production)
â”œâ”€â”€ ç›£æŸ»ãƒ»ãƒ­ã‚° (Audit/Logging)
â””â”€â”€ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ (Security)
```

### 3.2 cfn-guardï¼šPolicy as Code

cfn-guard æ˜¯ AWS å¼€æºå·¥å…·ï¼Œåœ¨éƒ¨ç½²å‰æ£€æŸ¥æ¨¡æ¿æ˜¯å¦ç¬¦åˆç»„ç»‡ç­–ç•¥ã€‚

**å®‰è£…**ï¼š

```bash
# macOS
brew install cloudformation-guard

# Linux
curl -L https://github.com/aws-cloudformation/cloudformation-guard/releases/latest/download/cfn-guard-v3-ubuntu-latest.tar.gz | tar xz
sudo mv cfn-guard /usr/local/bin/
```

**ç¤ºä¾‹è§„åˆ™**ï¼ˆ`cfn-guard-rules/s3-encryption.guard`ï¼‰ï¼š

```ruby
# S3 Bucket å¿…é¡»å¯ç”¨åŠ å¯†
# æ—¥æœ¬ä¼ä¸šå®‰å…¨åŸºå‡†ï¼šå…¨ã¦ã® S3 ãƒã‚±ãƒƒãƒˆã¯æš—å·åŒ–å¿…é ˆ

let s3_buckets = Resources.*[ Type == 'AWS::S3::Bucket' ]

rule s3_encryption_enabled when %s3_buckets !empty {
    %s3_buckets.Properties.BucketEncryption exists
    <<
        [å¿…é ˆ] S3 ãƒã‚±ãƒƒãƒˆã«ã¯æš—å·åŒ–è¨­å®šãŒå¿…è¦ã§ã™
        ç›£æŸ»è¦ä»¶: ãƒ‡ãƒ¼ã‚¿æš—å·åŒ–ã¯å¿…é ˆ
    >>
}
```

**éªŒè¯æ¨¡æ¿**ï¼š

```bash
cfn-guard validate \
  --data your-template.yaml \
  --rules cfn-guard-rules/s3-encryption.guard
```

### 3.3 CloudFormation Hooks

Hooks åœ¨ Stack/ChangeSet çº§åˆ«è¿›è¡ŒéªŒè¯ï¼Œæ¯” cfn-guard æ›´å¼ºå¤§ä½†é…ç½®æ›´å¤æ‚ã€‚

| ç‰¹æ€§ | cfn-guard | CloudFormation Hooks |
|------|-----------|---------------------|
| æ‰§è¡Œä½ç½® | æœ¬åœ°/CI | AWS æœåŠ¡ç«¯ |
| å¼ºåˆ¶åŠ› | å–å†³äº CI é…ç½® | å¯é…ç½®ä¸ºå¼ºåˆ¶é˜»æ­¢ |
| æ”¯æŒèµ„æº | CloudFormation æ¨¡æ¿ | CloudFormation + ç¬¬ä¸‰æ–¹ |
| å¤æ‚åº¦ | ä½ | ä¸­-é«˜ |

**æ¨èæ–¹æ¡ˆ**ï¼š
1. CI/CD é˜¶æ®µä½¿ç”¨ cfn-guardï¼ˆå¿«é€Ÿåé¦ˆï¼‰
2. ç”Ÿäº§è´¦æˆ·é…ç½® Hooksï¼ˆæœ€åé˜²çº¿ï¼‰

---

## Step 4 â€” åŠ¨æ‰‹å®éªŒï¼šéƒ¨ç½²å®¡è®¡åŸºç¡€è®¾æ–½ï¼ˆ15 åˆ†é’Ÿï¼‰

> ç›®æ ‡ï¼šéƒ¨ç½² CloudTrail + Configï¼Œå»ºç«‹å®Œæ•´çš„å®¡è®¡ä½“ç³»ã€‚

### 4.1 éƒ¨ç½² CloudTrail + Config

1. CloudFormation Console â†’ **Create stack**
2. ä¸Šä¼  `code/audit-infra.yaml`
3. Stack name: `enterprise-audit`

<!-- SCREENSHOT: cfn-audit-infra-create -->

4. å‚æ•°è®¾ç½®ï¼š
   - **EnableCloudTrail**: true
   - **EnableConfig**: true
   - **RetentionDays**: 90ï¼ˆæ—¥å¿—ä¿ç•™ 90 å¤©ï¼‰

5. ç‚¹å‡» **Next** â†’ **Next** â†’ å‹¾é€‰ **I acknowledge...** â†’ **Submit**

### 4.2 éªŒè¯ CloudTrail

1. è¿›å…¥ CloudTrail Console
2. ç‚¹å‡»å·¦ä¾§ **Trails**
3. æ‰¾åˆ° `enterprise-audit-trail`
4. çŠ¶æ€åº”ä¸º **Logging**

### 4.3 éªŒè¯ Config

1. è¿›å…¥ Config Console
2. ç‚¹å‡» **Rules**
3. æ‰¾åˆ°éƒ¨ç½²çš„åˆè§„è§„åˆ™ï¼š
   - `s3-bucket-server-side-encryption-enabled`
   - `ec2-instance-managed-by-systems-manager`

### 4.4 æ¨¡æ‹Ÿå®¡è®¡åœºæ™¯

ç°åœ¨åˆ›å»ºä¸€ä¸ªæ–° Stackï¼Œè§‚å¯Ÿ CloudTrail è®°å½•ï¼š

```bash
# æŸ¥çœ‹æœ€è¿‘çš„ CloudFormation API è°ƒç”¨
aws cloudtrail lookup-events \
  --lookup-attributes AttributeKey=EventSource,AttributeValue=cloudformation.amazonaws.com \
  --max-results 5
```

è¾“å‡ºç¤ºä¾‹ï¼š

```json
{
  "EventName": "CreateStack",
  "Username": "your-user",
  "EventTime": "2025-12-22T10:30:00Z",
  "Resources": [
    {
      "ResourceType": "AWS::CloudFormation::Stack",
      "ResourceName": "enterprise-monitoring"
    }
  ]
}
```

**æ—¥æœ¬å®¡è®¡åœºæ™¯**ï¼šå½“å†…éƒ¨å®¡è®¡ï¼ˆå†…éƒ¨ç›£æŸ»ï¼‰æˆ–å¤–éƒ¨å®¡è®¡ï¼ˆå¤–éƒ¨ç›£æŸ»ï¼‰æ¥æ£€æŸ¥æ—¶ï¼Œè¿™äº›è®°å½•å°±æ˜¯ä½ çš„ã€Œè¨¼è·¡ã€ï¼ˆã‚¨ãƒ“ãƒ‡ãƒ³ã‚¹ï¼‰ã€‚

---

## Step 5 â€” æ—¥æœ¬ IT å˜æ›´ç®¡ç†æµç¨‹ï¼ˆ15 åˆ†é’Ÿï¼‰

### 5.1 å˜æ›´ç®¡ç†çš„å®Œæ•´æµç¨‹

åœ¨æ—¥æœ¬ä¼ä¸šï¼ŒCloudFormation å˜æ›´é€šå¸¸éœ€è¦éµå¾ªè¿™ä¸ªæµç¨‹ï¼š

![Change Management Flow](images/change-management-flow.png)

<details>
<summary>ğŸ“ ASCII æºç ï¼ˆç‚¹å‡»å±•å¼€ï¼‰</summary>

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å¤‰æ›´ç®¡ç†ãƒ•ãƒ­ãƒ¼ (Change Management Flow)                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Phase 1: å¤‰æ›´ç”³è«‹ (Change Request)                                 â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                  â”‚    â”‚
â”‚  â”‚  â”‚  é–‹ç™ºè€…ãŒ     â”‚  â”€â”€â”€â”€â”€â”€â–¶  å¤‰æ›´ç®¡ç†æ›¸ä½œæˆ                          â”‚    â”‚
â”‚  â”‚  â”‚  å¤‰æ›´ã‚’è¨ˆç”»   â”‚           (Excel/Markdown)                       â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                              â”‚                                              â”‚
â”‚                              â–¼                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Phase 2: ChangeSet ä½œæˆ (Create ChangeSet)                         â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚    â”‚
â”‚  â”‚  â”‚  aws cfn     â”‚â”€â”€â”€â–¶â”‚  ChangeSet   â”‚â”€â”€â”€â–¶  ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆå–å¾—   â”‚    â”‚
â”‚  â”‚  â”‚  create-     â”‚    â”‚  (Preview)   â”‚      (å¤‰æ›´ç®¡ç†æ›¸ã«æ·»ä»˜)       â”‚    â”‚
â”‚  â”‚  â”‚  change-set  â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                              â”‚                                              â”‚
â”‚                              â–¼                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Phase 3: æ‰¿èª (Approval)                                           â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚    â”‚
â”‚  â”‚  â”‚  é‹ç”¨ãƒãƒ¼ãƒ    â”‚â”€â”€â”€â–¶â”‚  ä¸Šé•·æ‰¿èª    â”‚â”€â”€â”€â–¶â”‚  æ‰¿èªãƒ¡ãƒ¼ãƒ«   â”‚         â”‚    â”‚
â”‚  â”‚  â”‚  ãƒ¬ãƒ“ãƒ¥ãƒ¼    â”‚    â”‚  (Manager)   â”‚    â”‚  (è¨¼è·¡ä¿å­˜)   â”‚         â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                              â”‚                                              â”‚
â”‚                              â–¼                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Phase 4: å®Ÿè¡Œ (Execute)                                            â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚    â”‚
â”‚  â”‚  â”‚  ä½œæ¥­æ—¥æ™‚    â”‚â”€â”€â”€â–¶â”‚  ChangeSet   â”‚â”€â”€â”€â–¶â”‚  CloudTrail   â”‚         â”‚    â”‚
â”‚  â”‚  â”‚  èª¿æ•´       â”‚    â”‚  Execute     â”‚    â”‚  è¨¼è·¡è¨˜éŒ²     â”‚         â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

</details>

### 5.2 å¤‰æ›´ç®¡ç†æ›¸ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ

æœ¬è¯¾æä¾›äº†æ—¥æœ¬ä¼ä¸šé£æ ¼çš„å¤‰æ›´ç®¡ç†æ›¸æ¨¡æ¿ï¼ˆè§ `templates/å¤‰æ›´ç®¡ç†æ›¸.md`ï¼‰ã€‚

å…³é”®è¦ç´ ï¼š

| é¡¹ç›® | æ—¥è¯­ | è¯´æ˜ |
|------|------|------|
| å¤‰æ›´æ¦‚è¦ | ã¸ã‚“ã“ã†ãŒã„ã‚ˆã† | å˜æ›´å†…å®¹æ¦‚è¿° |
| å½±éŸ¿ç¯„å›² | ãˆã„ãã‚‡ã†ã¯ã‚“ã„ | å½±å“èŒƒå›´åˆ†æ |
| ä½œæ¥­æ‰‹é † | ã•ãã‚‡ã†ã¦ã˜ã‚…ã‚“ | å…·ä½“æ“ä½œæ­¥éª¤ |
| åˆ‡ã‚Šæˆ»ã—æ‰‹é † | ãã‚Šã‚‚ã©ã—ã¦ã˜ã‚…ã‚“ | å›æ»šæ­¥éª¤ |
| æ‰¿èªè€… | ã—ã‚‡ã†ã«ã‚“ã—ã‚ƒ | å®¡æ‰¹äºº |

### 5.3 å®è·µï¼šåˆ›å»º ChangeSet å¹¶è®°å½•

**åœºæ™¯**ï¼šéœ€è¦ç»™ç›‘æ§ Stack æ·»åŠ ä¸€ä¸ªæ–°çš„å‘Šè­¦ã€‚

1. ä¿®æ”¹ `monitoring-alarms.yaml`ï¼Œæ·»åŠ ç£ç›˜ç›‘æ§ï¼š

```yaml
  DiskSpaceAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmDescription: "ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨ç‡è¶…é - å®¹é‡ç¢ºèªå¿…è¦"
      MetricName: DiskSpaceUtilization
      Namespace: CWAgent
      Statistic: Average
      Period: 300
      EvaluationPeriods: 2
      Threshold: 90
      AlarmActions:
        - !Ref AlertTopic
```

2. åˆ›å»º ChangeSetï¼ˆä¸æ‰§è¡Œï¼‰ï¼š

```bash
aws cloudformation create-change-set \
  --stack-name enterprise-monitoring \
  --change-set-name add-disk-alarm-$(date +%Y%m%d) \
  --template-body file://code/monitoring-alarms.yaml \
  --parameters ParameterKey=NotificationEmail,UsePreviousValue=true
```

3. æŸ¥çœ‹ ChangeSet è¯¦æƒ…ï¼š

```bash
aws cloudformation describe-change-set \
  --stack-name enterprise-monitoring \
  --change-set-name add-disk-alarm-$(date +%Y%m%d)
```

4. **æˆªå›¾ä¿å­˜**ï¼šåœ¨ Console æŸ¥çœ‹ ChangeSetï¼Œæˆªå›¾ä½œä¸ºå¤‰æ›´ç®¡ç†æ›¸çš„é™„ä»¶ã€‚

5. è·å¾—æ‰¿è®¤åæ‰§è¡Œï¼š

```bash
aws cloudformation execute-change-set \
  --stack-name enterprise-monitoring \
  --change-set-name add-disk-alarm-$(date +%Y%m%d)
```

---

## Step 6 â€” cfn-guard ç­–ç•¥éªŒè¯ï¼ˆ10 åˆ†é’Ÿï¼‰

### 6.1 ç¼–å†™ç»„ç»‡ç­–ç•¥è§„åˆ™

æœ¬è¯¾æä¾›ä¸¤ä¸ªç¤ºä¾‹è§„åˆ™ï¼š

**1. S3 åŠ å¯†å¿…é¡»ï¼ˆ`cfn-guard-rules/s3-encryption.guard`ï¼‰**

```ruby
# å…¨ã¦ã® S3 ãƒã‚±ãƒƒãƒˆã¯æš—å·åŒ–ãŒå¿…é ˆ
let s3_buckets = Resources.*[ Type == 'AWS::S3::Bucket' ]

rule s3_encryption_enabled when %s3_buckets !empty {
    %s3_buckets.Properties.BucketEncryption exists
    <<
        [CRITICAL] S3 ãƒã‚±ãƒƒãƒˆã®æš—å·åŒ–è¨­å®šãŒå¿…è¦ã§ã™
        - BucketEncryption ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’è¿½åŠ ã—ã¦ãã ã•ã„
        - å‚è€ƒ: https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/aws-properties-s3-bucket-bucketencryption.html
    >>
}
```

**2. å¿…é¡»æ ‡ç­¾ï¼ˆ`cfn-guard-rules/required-tags.guard`ï¼‰**

```ruby
# æ—¥æœ¬ä¼æ¥­ã‚¿ã‚°è¦ä»¶ï¼šEnvironment, Owner, Project ã¯å¿…é ˆ
let all_resources = Resources.*

rule required_tags {
    %all_resources.Properties.Tags exists
    %all_resources.Properties.Tags[ Key == 'Environment' ] !empty
    %all_resources.Properties.Tags[ Key == 'Owner' ] !empty
    <<
        [å¿…é ˆ] ä»¥ä¸‹ã®ã‚¿ã‚°ãŒå¿…è¦ã§ã™:
        - Environment (dev/stg/prod)
        - Owner (æ‹…å½“è€…ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹)

        ã‚¿ã‚°ã¯è«‹æ±‚ç®¡ç†ãƒ»ãƒªã‚½ãƒ¼ã‚¹ç®¡ç†ã«å¿…é ˆã§ã™ã€‚
    >>
}
```

### 6.2 åœ¨ CI/CD ä¸­ä½¿ç”¨

å…¸å‹çš„ GitHub Actions é…ç½®ï¼š

```yaml
name: CloudFormation Validation
on:
  pull_request:
    paths:
      - '**.yaml'
      - '**.yml'

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install cfn-guard
        run: |
          curl -L https://github.com/aws-cloudformation/cloudformation-guard/releases/latest/download/cfn-guard-v3-ubuntu-latest.tar.gz | tar xz
          sudo mv cfn-guard /usr/local/bin/

      - name: Validate templates
        run: |
          for template in $(find . -name "*.yaml" -path "*/cloudformation/*"); do
            echo "Validating: $template"
            cfn-guard validate --data "$template" --rules cfn-guard-rules/
          done
```

---

## Step 7 â€” æ¸…ç†èµ„æºï¼ˆ5 åˆ†é’Ÿï¼‰

> **é‡è¦**ï¼šCloudTrail å’Œ Config ä¼šäº§ç”ŸæŒç»­è´¹ç”¨ï¼Œå®éªŒå®Œæˆåè¯·åˆ é™¤ï¼

### 7.1 åˆ é™¤é¡ºåº

ç”±äºèµ„æºä¾èµ–å…³ç³»ï¼ŒæŒ‰ä»¥ä¸‹é¡ºåºåˆ é™¤ï¼š

```bash
# 1. åˆ é™¤ç›‘æ§ Stack
aws cloudformation delete-stack --stack-name enterprise-monitoring

# 2. ç­‰å¾…åˆ é™¤å®Œæˆ
aws cloudformation wait stack-delete-complete --stack-name enterprise-monitoring

# 3. åˆ é™¤å®¡è®¡ Stack
aws cloudformation delete-stack --stack-name enterprise-audit

# 4. ç­‰å¾…åˆ é™¤å®Œæˆ
aws cloudformation wait stack-delete-complete --stack-name enterprise-audit
```

### 7.2 éªŒè¯æ¸…ç†

```bash
aws cloudformation list-stacks \
  --stack-status-filter DELETE_COMPLETE \
  --query "StackSummaries[?contains(StackName, 'enterprise')]"
```

### 7.3 æ‰‹åŠ¨æ£€æŸ¥

ç¡®ä¿ä»¥ä¸‹èµ„æºå·²åˆ é™¤ï¼š

- [ ] CloudWatch Alarms
- [ ] SNS Topics
- [ ] CloudTrail Trails
- [ ] Config Rules
- [ ] S3 Bucketsï¼ˆæ—¥å¿—æ¡¶å¯èƒ½éœ€è¦å…ˆæ¸…ç©ºï¼‰

---

## èŒåœºå°è´´å£«

### æ—¥æœ¬ IT ä¼ä¸šçš„å˜æ›´ç®¡ç†æ–‡åŒ–

**1. æ‰¿èªãƒ•ãƒ­ãƒ¼ï¼ˆå®¡æ‰¹æµç¨‹ï¼‰**

æ—¥æœ¬ä¼ä¸šçš„å˜æ›´é€šå¸¸éœ€è¦å¤šçº§å®¡æ‰¹ï¼š

```
é–‹ç™ºæ‹…å½“ â†’ ãƒãƒ¼ãƒ ãƒªãƒ¼ãƒ€ãƒ¼ â†’ èª²é•· â†’ éƒ¨é•·ï¼ˆå¤§å‹å¤‰æ›´ï¼‰
```

CloudFormation çš„ ChangeSet æˆªå›¾æ˜¯é‡è¦çš„å®¡æ‰¹ææ–™ã€‚

**2. ä½œæ¥­æ™‚é–“å¸¯ï¼ˆå·¥ä½œæ—¶é—´çª—å£ï¼‰**

```
é€šå¸¸å¤‰æ›´: å¹³æ—¥ 10:00-17:00
ç·Šæ€¥å¤‰æ›´: è¦ç›¸è«‡ï¼ˆæ‰¿èªè€…ã®è¨±å¯å¿…é ˆï¼‰
å®šæœŸãƒ¡ãƒ³ãƒ†: æ¯æœˆç¬¬2åœŸæ›œ 22:00-ç¿Œ6:00
```

**3. è¨¼è·¡ç®¡ç†ï¼ˆå®¡è®¡æ—¥å¿—ï¼‰**

æ—¥æœ¬çš„é‡‘èãƒ»åŒ»ç™‚ãƒ»æ”¿åºœé¡¹ç›®å¯¹å®¡è®¡è¦æ±‚å¾ˆé«˜ï¼š

- CloudTrail æ—¥å¿—ä¿ç•™ 1-7 å¹´
- å˜æ›´ç®¡ç†ç¥¨éœ€è¦é•¿æœŸä¿å­˜
- å®šæœŸå†…éƒ¨å®¡è®¡ï¼ˆå¹´ 1-2 å›ï¼‰

### é¢è¯•å¸¸è§é—®é¢˜

**Q: StackSets ã¨é€šå¸¸ã® Stack ã®é•ã„ã¯ï¼Ÿ**

A: StackSets ã¯è¤‡æ•°ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒ»ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã«åŒä¸€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä¸€æ‹¬å±•é–‹ã§ãã‚‹ã€‚Organizations ã¨çµ±åˆã™ã‚‹ã¨ã€æ–°è¦ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆæ™‚ã«è‡ªå‹•çš„ã« Stack ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤å¯èƒ½ã€‚ã‚¬ãƒãƒŠãƒ³ã‚¹å¼·åŒ–ã«æœ‰åŠ¹ã€‚

ï¼ˆStackSets å¯ä»¥å°†åŒä¸€æ¨¡æ¿ä¸€é”®éƒ¨ç½²åˆ°å¤šä¸ªè´¦æˆ·/åŒºåŸŸã€‚ä¸ Organizations é›†æˆåï¼Œåˆ›å»ºæ–°è´¦æˆ·æ—¶å¯ä»¥è‡ªåŠ¨éƒ¨ç½² Stackã€‚å¯¹æ²»ç†å¾ˆæœ‰å¸®åŠ©ã€‚ï¼‰

**Q: CloudFormation ã®ç›£æŸ»å¯¾å¿œã¯ã©ã†ã—ã¦ã„ã¾ã™ã‹ï¼Ÿ**

A: 3ã¤ã®å±¤ã§å¯¾å¿œï¼š
1. CloudTrail ã§å…¨ API æ“ä½œã‚’è¨˜éŒ²
2. Config ã§ç¶™ç¶šçš„ãªã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹ãƒã‚§ãƒƒã‚¯
3. ChangeSet ã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’å¤‰æ›´ç®¡ç†ç¥¨ã«æ·»ä»˜

ï¼ˆä¸‰å±‚åº”å¯¹ï¼š1. CloudTrail è®°å½•æ‰€æœ‰ API æ“ä½œ 2. Config æŒç»­åˆè§„æ£€æŸ¥ 3. ChangeSet æˆªå›¾é™„åœ¨å˜æ›´ç®¡ç†ç¥¨ä¸Šï¼‰

**Q: cfn-guard ã¯ä½•ã«ä½¿ã„ã¾ã™ã‹ï¼Ÿ**

A: ãƒ‡ãƒ—ãƒ­ã‚¤å‰ã®ãƒãƒªã‚·ãƒ¼ãƒã‚§ãƒƒã‚¯ã€‚CI/CD ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã«çµ„ã¿è¾¼ã‚“ã§ã€æš—å·åŒ–å¿…é ˆãƒ»ã‚¿ã‚°å¿…é ˆãªã©ã®çµ„ç¹”ãƒ«ãƒ¼ãƒ«ã‚’å¼·åˆ¶ã€‚Shift-left ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®å®Ÿè·µã€‚

ï¼ˆéƒ¨ç½²å‰çš„ç­–ç•¥æ£€æŸ¥ã€‚é›†æˆåˆ° CI/CD æµæ°´çº¿ï¼Œå¼ºåˆ¶æ‰§è¡ŒåŠ å¯†å¿…é¡»ã€æ ‡ç­¾å¿…é¡»ç­‰ç»„ç»‡è§„åˆ™ã€‚å®è·µ Shift-left å®‰å…¨ã€‚ï¼‰

---

## æ£€æŸ¥æ¸…å•

å®Œæˆæœ¬è¯¾åï¼Œä½ åº”è¯¥èƒ½å¤Ÿï¼š

- [ ] è§£é‡Š StackSets çš„ç”¨é€”å’Œä¸¤ç§éƒ¨ç½²æ¨¡å¼
- [ ] ä½¿ç”¨ cfn-guard éªŒè¯æ¨¡æ¿æ˜¯å¦ç¬¦åˆç»„ç»‡ç­–ç•¥
- [ ] æè¿°æ—¥æœ¬ä¼ä¸šçš„å˜æ›´ç®¡ç†æµç¨‹ï¼ˆå¤‰æ›´ç”³è«‹ â†’ æ‰¿èª â†’ å®Ÿè¡Œ â†’ è¨¼è·¡ï¼‰
- [ ] éƒ¨ç½² CloudTrail + Config å®¡è®¡åŸºç¡€è®¾æ–½
- [ ] é…ç½® CloudWatch Alarms ç›‘æ§å‘Šè­¦
- [ ] åˆ›å»º ChangeSet å¹¶è§£é‡Šå…¶åœ¨å¤‰æ›´ç®¡ç†ä¸­çš„ä½œç”¨
- [ ] å¡«å†™å¤‰æ›´ç®¡ç†æ›¸çš„å…³é”®é¡¹ç›®

---

## è¯¾ç¨‹æ€»ç»“ï¼šCloudFormation ç³»åˆ—å›é¡¾

æ­å–œä½ å®Œæˆäº† CloudFormation å®Œæ•´è¯¾ç¨‹ï¼å›é¡¾ä¸€ä¸‹ä½ å­¦åˆ°çš„å†…å®¹ï¼š

| è¯¾ç¨‹ | ä¸»é¢˜ | å…³é”®æŠ€èƒ½ |
|------|------|----------|
| 00 | åŸºç¡€ä¸ç¬¬ä¸€ä¸ª Stack | Template, Stack, Resource æ¦‚å¿µ |
| 01 | æ¨¡æ¿è¯­æ³•ä¸å†…ç½®å‡½æ•° | Parameters, Mappings, Conditions, !Ref, !Sub |
| 02 | å®‰å…¨è¿ç»´ | ChangeSet, DeletionPolicy, StackPolicy, å›æ»š |
| 03 | ç°ä»£å·¥å…· | Infrastructure Composer, IaC Generator |
| 04 | å¤šæ ˆæ¶æ„ | Nested Stacks, Cross-stack References |
| 05 | Drift ä¸å¯¼å…¥ | Drift Detection, Resource Import |
| **06** | **ä¼ä¸šå®æˆ˜** | **StackSets, cfn-guard, å¤‰æ›´ç®¡ç†, ç›£æŸ»å¯¾å¿œ** |

### ä¸‹ä¸€æ­¥å»ºè®®

1. **å®è·µ**ï¼šåœ¨ä¸ªäººé¡¹ç›®ä¸­åº”ç”¨ CloudFormation
2. **è®¤è¯**ï¼šè€ƒå– AWS SAA/SOAï¼ŒCloudFormation æ˜¯é‡ç‚¹è€ƒå¯Ÿå†…å®¹
3. **æ·±å…¥**ï¼šå­¦ä¹  [Terraform ç³»åˆ—](../../terraform/)ï¼ŒæŒæ¡å¤šäº‘ IaC
4. **è¿›é˜¶**ï¼šæ¢ç´¢ AWS CDKï¼ˆç”¨ä»£ç è€Œé YAML å®šä¹‰åŸºç¡€è®¾æ–½ï¼‰

---

## å»¶ä¼¸é˜…è¯»

- [AWS StackSets ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¬ã‚¤ãƒ‰](https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/what-is-cfnstacksets.html)
- [cfn-guard GitHub](https://github.com/aws-cloudformation/cloudformation-guard)
- [AWS CloudTrail ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¬ã‚¤ãƒ‰](https://docs.aws.amazon.com/ja_jp/awscloudtrail/latest/userguide/)
- [AWS Config ãƒ«ãƒ¼ãƒ«ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹](https://docs.aws.amazon.com/ja_jp/config/latest/developerguide/managed-rules-by-aws-config.html)
- [Terraform ç³»åˆ—](../../terraform/) - å¤šäº‘ IaC å¯¹æ¯”å­¦ä¹ 

---

## ç³»åˆ—å¯¼èˆª

[â† 05 - Drift æ£€æµ‹ä¸èµ„æºå¯¼å…¥](../05-drift-import/) | [Home](../) | [Terraform ç³»åˆ— â†’](../../terraform/)
