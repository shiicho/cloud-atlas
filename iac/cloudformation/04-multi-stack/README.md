# 04 - å¤šæ ˆæ¶æ„ä¸è·¨æ ˆå¼•ç”¨

> **ç›®æ ‡**ï¼šæŒæ¡ CloudFormation å¤šæ ˆæ¶æ„è®¾è®¡ï¼Œå®ç°æ¨¡å—åŒ–å’Œè·¨æ ˆé€šä¿¡
> **æ—¶é—´**ï¼š50 åˆ†é’Ÿ
> **è´¹ç”¨**ï¼šVPC + Subnetsï¼ˆå…è´¹å±‚ï¼‰
> **å‰ç½®**ï¼š[03 - ç°ä»£å·¥å…·](../03-modern-tools/)

---

## å°†å­¦åˆ°çš„å†…å®¹

1. ç†è§£å•ä½“æ¨¡æ¿ï¼ˆMonolithic Templateï¼‰çš„é—®é¢˜
2. ä½¿ç”¨ Nested Stacks å®ç°æ¨¡å—åŒ–
3. ä½¿ç”¨ Exports/ImportValue å®ç°è·¨æ ˆå¼•ç”¨
4. è®¾è®¡ Layer åŒ–æ¶æ„ï¼šNetwork â†’ Foundations â†’ Application
5. é€‰æ‹© Nested Stacks vs Cross-Stack References

---

## Step 1 â€” å…ˆè·‘èµ·æ¥ï¼è·¨æ ˆå¼•ç”¨ï¼ˆ10 åˆ†é’Ÿï¼‰

> å…ˆ"å°åˆ°"è·¨æ ˆå¼•ç”¨çš„ä¾¿åˆ©ï¼Œå†ç†è§£èƒŒååŸç†ã€‚

### 1.1 å‡†å¤‡ Network Stack æ¨¡æ¿

åˆ›å»º `network-stack.yaml`ï¼Œå®šä¹‰ VPC å’Œå­ç½‘ï¼š

```yaml
AWSTemplateFormatVersion: '2010-09-09'
Description: Network Layer - VPC and Subnets (exports for cross-stack reference)

Parameters:
  Environment:
    Type: String
    Default: dev
    AllowedValues: [dev, staging, prod]

Resources:
  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.0.0.0/16
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value: !Sub '${Environment}-vpc'

  PublicSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.1.0/24
      AvailabilityZone: !Select [0, !GetAZs '']
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub '${Environment}-public-1'

  PublicSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.2.0/24
      AvailabilityZone: !Select [1, !GetAZs '']
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub '${Environment}-public-2'

Outputs:
  VpcId:
    Description: VPC ID
    Value: !Ref VPC
    Export:
      Name: !Sub '${Environment}-VpcId'

  PublicSubnet1Id:
    Description: Public Subnet 1 ID
    Value: !Ref PublicSubnet1
    Export:
      Name: !Sub '${Environment}-PublicSubnet1Id'

  PublicSubnet2Id:
    Description: Public Subnet 2 ID
    Value: !Ref PublicSubnet2
    Export:
      Name: !Sub '${Environment}-PublicSubnet2Id'
```

> ä½ ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨è¯¾ç¨‹ä»£ç ï¼š`code/network-stack.yaml`

### 1.2 éƒ¨ç½² Network Stack

1. ç™»å½• AWS Consoleï¼Œè¿›å…¥ **CloudFormation**
2. ç‚¹å‡» **Create stack** â†’ **With new resources (standard)**
3. é€‰æ‹© **Upload a template file**ï¼Œä¸Šä¼  `network-stack.yaml`
4. **Stack name**ï¼š`dev-network-stack`
5. **Environment**ï¼šä¿æŒé»˜è®¤ `dev`
6. ç‚¹å‡» **Next** â†’ **Next** â†’ **Submit**

<!-- SCREENSHOT: network-stack-create -->

ç­‰å¾… Stack çŠ¶æ€å˜ä¸º `CREATE_COMPLETE`ã€‚

### 1.3 éªŒè¯ Exports

1. åœ¨ CloudFormation Consoleï¼Œç‚¹å‡»å·¦ä¾§å¯¼èˆªæ çš„ **Exports**
2. ä½ ä¼šçœ‹åˆ°ä¸‰ä¸ªå¯¼å‡ºå€¼ï¼š
   - `dev-VpcId`
   - `dev-PublicSubnet1Id`
   - `dev-PublicSubnet2Id`

<!-- SCREENSHOT: cloudformation-exports -->

### 1.4 å‡†å¤‡ App Stack æ¨¡æ¿

åˆ›å»º `app-stack.yaml`ï¼Œå¼•ç”¨ Network Stack çš„è¾“å‡ºï¼š

```yaml
AWSTemplateFormatVersion: '2010-09-09'
Description: Application Layer - imports VPC from network stack

Parameters:
  Environment:
    Type: String
    Default: dev
    AllowedValues: [dev, staging, prod]

Resources:
  AppSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Application Security Group
      VpcId: !ImportValue
        Fn::Sub: '${Environment}-VpcId'
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: !Sub '${Environment}-app-sg'

Outputs:
  SecurityGroupId:
    Description: Application Security Group ID
    Value: !Ref AppSecurityGroup
```

> ä½ ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨è¯¾ç¨‹ä»£ç ï¼š`code/app-stack.yaml`

### 1.5 éƒ¨ç½² App Stack

1. åˆ›å»ºæ–° Stackï¼Œä¸Šä¼  `app-stack.yaml`
2. **Stack name**ï¼š`dev-app-stack`
3. **Environment**ï¼š`dev`
4. ç‚¹å‡» **Next** â†’ **Next** â†’ **Submit**

<!-- SCREENSHOT: app-stack-create -->

### 1.6 éªŒè¯è·¨æ ˆå¼•ç”¨

1. è¿›å…¥ **EC2 Console** â†’ **Security Groups**
2. æ‰¾åˆ° `dev-app-sg`
3. ç¡®è®¤å®ƒåˆ›å»ºåœ¨æ­£ç¡®çš„ VPC ä¸­

æ­å–œï¼ä½ åˆšåˆšå®ç°äº† CloudFormation è·¨æ ˆå¼•ç”¨ï¼

---

## Step 2 â€” å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿï¼ˆ5 åˆ†é’Ÿï¼‰

### 2.1 è·¨æ ˆå¼•ç”¨åŸç†

![Cross-Stack Reference åŸç†](images/cross-stack-reference.png)

<details>
<summary>ğŸ“ ASCII æºç ï¼ˆç‚¹å‡»å±•å¼€ï¼‰</summary>

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Cross-Stack Reference åŸç†                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚   Network Stack                          App Stack                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚   â”‚  Resources:     â”‚                   â”‚  Resources:     â”‚        â”‚
â”‚   â”‚    VPC          â”‚                   â”‚    SG           â”‚        â”‚
â”‚   â”‚    Subnets      â”‚                   â”‚                 â”‚        â”‚
â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤        â”‚
â”‚   â”‚  Outputs:       â”‚                   â”‚  !ImportValue   â”‚        â”‚
â”‚   â”‚    Export:      â”‚ â”€â”€â”€â”€å¼•ç”¨â”€â”€â”€â”€â–¶    â”‚   dev-VpcId     â”‚        â”‚
â”‚   â”‚    dev-VpcId    â”‚                   â”‚                 â”‚        â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚   â”‚                AWS CloudFormation Exports                â”‚      â”‚
â”‚   â”‚   dev-VpcId: vpc-0123456789                              â”‚      â”‚
â”‚   â”‚   dev-PublicSubnet1Id: subnet-aaa                        â”‚      â”‚
â”‚   â”‚   dev-PublicSubnet2Id: subnet-bbb                        â”‚      â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

</details>

### 2.2 Export ä¸ ImportValue

**å¯¼å‡ºï¼ˆExportï¼‰**ï¼šåœ¨ Outputs ä¸­ä½¿ç”¨ `Export.Name`

```yaml
Outputs:
  VpcId:
    Value: !Ref VPC
    Export:
      Name: dev-VpcId    # å…¨å±€å”¯ä¸€çš„å¯¼å‡ºåç§°
```

**å¯¼å…¥ï¼ˆImportValueï¼‰**ï¼šåœ¨å…¶ä»– Stack ä¸­å¼•ç”¨

```yaml
Resources:
  MyResource:
    Properties:
      VpcId: !ImportValue dev-VpcId
```

### 2.3 ä¾èµ–å…³ç³»

å½“ Stack B å¯¼å…¥ Stack A çš„ Export æ—¶ï¼š

| æ“ä½œ | å…è®¸ï¼Ÿ | è¯´æ˜ |
|------|--------|------|
| æ›´æ–° Stack A çš„å…¶ä»–èµ„æº | Yes | ä¸å½±å“å¯¼å‡ºå€¼ |
| åˆ é™¤ Stack A çš„ Export | **No** | è¢«ä¾èµ–æ—¶æ— æ³•åˆ é™¤ |
| åˆ é™¤ Stack A | **No** | å¿…é¡»å…ˆåˆ é™¤ Stack B |

è¿™ç§ä¿æŠ¤æœºåˆ¶é˜²æ­¢æ„å¤–ç ´åè·¨æ ˆä¾èµ–ï¼

---

## Step 3 â€” ä¸ºä»€ä¹ˆéœ€è¦å¤šæ ˆï¼Ÿï¼ˆ5 åˆ†é’Ÿï¼‰

### 3.1 å•ä½“æ¨¡æ¿çš„é—®é¢˜

![å•ä½“æ¨¡æ¿é—®é¢˜](images/monolithic-problems.png)

<details>
<summary>ğŸ“ ASCII æºç ï¼ˆç‚¹å‡»å±•å¼€ï¼‰</summary>

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     å•ä½“æ¨¡æ¿ (Monolithic Template) é—®é¢˜               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚   å•ä½“æ¨¡æ¿ (5000+ è¡Œ)                                                â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚   â”‚  VPC                                                     â”‚      â”‚
â”‚   â”‚  Subnets (6)                                             â”‚      â”‚
â”‚   â”‚  Route Tables (3)                                        â”‚      â”‚
â”‚   â”‚  NAT Gateway                                             â”‚      â”‚
â”‚   â”‚  Security Groups (10)                                    â”‚      â”‚
â”‚   â”‚  ALB + Target Groups                                     â”‚      â”‚
â”‚   â”‚  EC2 Instances (5)                                       â”‚      â”‚
â”‚   â”‚  RDS Cluster                                             â”‚      â”‚
â”‚   â”‚  ElastiCache                                             â”‚      â”‚
â”‚   â”‚  S3 Buckets (3)                                          â”‚      â”‚
â”‚   â”‚  IAM Roles (8)                                           â”‚      â”‚
â”‚   â”‚  CloudWatch Alarms (20)                                  â”‚      â”‚
â”‚   â”‚  ...                                                     â”‚      â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                                                     â”‚
â”‚   é—®é¢˜:                                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚   â”‚ 1. éƒ¨ç½²æ…¢     â”‚ â”‚ 2. éš¾ç»´æŠ¤    â”‚ â”‚ 3. çˆ†ç‚¸åŠå¾„å¤§ â”‚              â”‚
â”‚   â”‚ 30+ åˆ†é’Ÿ     â”‚ â”‚ 100+ èµ„æº    â”‚ â”‚ ä¸€é”™å…¨åœ     â”‚              â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

</details>

| é—®é¢˜ | è¯´æ˜ | å½±å“ |
|------|------|------|
| **éƒ¨ç½²æ…¢** | æ‰€æœ‰èµ„æºä¸²è¡Œ/å¹¶è¡Œå¤„ç† | ä¸€æ¬¡éƒ¨ç½² 30+ åˆ†é’Ÿ |
| **éš¾ç»´æŠ¤** | 5000+ è¡Œ YAML | æ‰¾ä¸€ä¸ªå‚æ•°è¦ç¿»å¾ˆä¹… |
| **çˆ†ç‚¸åŠå¾„å¤§** | ä»»ä½•é”™è¯¯å½±å“å…¨éƒ¨ | åº”ç”¨æ”¹åç½‘ç»œä¹Ÿå›æ»š |
| **æƒé™éš¾åˆ†** | ç½‘ç»œ/åº”ç”¨åŒæ¨¡æ¿ | å¼€å‘è€…èƒ½åŠ¨ç½‘ç»œé…ç½® |
| **å¤ç”¨å›°éš¾** | é€»è¾‘è€¦åˆä¸¥é‡ | æ— æ³•åªç”¨ VPC éƒ¨åˆ† |

### 3.2 åˆ†å±‚è§£å†³æ–¹æ¡ˆ

![Layer åŒ–æ¶æ„è®¾è®¡](images/layered-solution.png)

<details>
<summary>ğŸ“ ASCII æºç ï¼ˆç‚¹å‡»å±•å¼€ï¼‰</summary>

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Layer åŒ–æ¶æ„è®¾è®¡                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚   Layer 3: Application                    å˜æ›´é¢‘ç‡: é«˜              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
â”‚   â”‚  EC2, ECS, Lambda               â”‚    ç‹¬ç«‹éƒ¨ç½²ã€å¿«é€Ÿè¿­ä»£         â”‚
â”‚   â”‚  Application Security Groups    â”‚                              â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚
â”‚                    â”‚ ImportValue                                    â”‚
â”‚                    â–¼                                                â”‚
â”‚   Layer 2: Foundations                    å˜æ›´é¢‘ç‡: ä¸­              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
â”‚   â”‚  ALB, RDS, ElastiCache          â”‚    åŸºç¡€æœåŠ¡ã€ç¨³å®šè¿è¡Œ         â”‚
â”‚   â”‚  S3, Secrets Manager            â”‚                              â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚
â”‚                    â”‚ ImportValue                                    â”‚
â”‚                    â–¼                                                â”‚
â”‚   Layer 1: Network                        å˜æ›´é¢‘ç‡: ä½              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
â”‚   â”‚  VPC, Subnets, Route Tables     â”‚    ç½‘ç»œåŸºç¡€ã€å¾ˆå°‘å˜æ›´         â”‚
â”‚   â”‚  NAT Gateway, VPN               â”‚                              â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

</details>

**æŒ‰ç”Ÿå‘½å‘¨æœŸåˆ†å±‚**ï¼š

| Layer | å†…å®¹ | å˜æ›´é¢‘ç‡ | ç®¡ç†è€… |
|-------|------|----------|--------|
| **Network** | VPC, Subnets, NAT | æä½ | ç½‘ç»œå›¢é˜Ÿ |
| **Foundations** | RDS, ALB, S3 | ä½ | å¹³å°å›¢é˜Ÿ |
| **Application** | EC2, Lambda, ECS | é«˜ | åº”ç”¨å›¢é˜Ÿ |

---

## Step 4 â€” Nested Stacksï¼ˆ10 åˆ†é’Ÿï¼‰

> Nested Stacks æ˜¯å¦ä¸€ç§æ¨¡å—åŒ–æ–¹å¼ï¼Œé€‚åˆç´§å¯†è€¦åˆçš„ç»„ä»¶ã€‚

### 4.1 Nested Stacks vs Cross-Stack References

![Nested Stacks vs Cross-Stack References](images/nested-vs-cross-stack.png)

<details>
<summary>ğŸ“ ASCII æºç ï¼ˆç‚¹å‡»å±•å¼€ï¼‰</summary>

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Nested Stacks vs Cross-Stack References                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚   Nested Stacks (çˆ¶å­å…³ç³»)              Cross-Stack (å…„å¼Ÿå…³ç³»)       â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚   â”‚   Parent Stack      â”‚              â”‚   Stack A           â”‚     â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚              â”‚   Export: VpcId     â”‚     â”‚
â”‚   â”‚   â”‚  Child: VPC   â”‚ â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚                         â”‚                â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚   â”‚   â”‚  Child: App   â”‚ â”‚              â”‚   Stack B           â”‚     â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚              â”‚   ImportValue       â”‚     â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                     â”‚
â”‚   ç‰¹ç‚¹:                                 ç‰¹ç‚¹:                        â”‚
â”‚   â€¢ ä¸€èµ·åˆ›å»º/åˆ é™¤                        â€¢ ç‹¬ç«‹ç”Ÿå‘½å‘¨æœŸ               â”‚
â”‚   â€¢ ä¸€èµ·å›æ»š                             â€¢ ç‹¬ç«‹éƒ¨ç½²                   â”‚
â”‚   â€¢ çˆ¶ Stack æ§åˆ¶æ‰€æœ‰                    â€¢ æ¾è€¦åˆ                     â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

</details>

| ç‰¹æ€§ | Nested Stacks | Cross-Stack References |
|------|---------------|------------------------|
| **å…³ç³»** | çˆ¶å­ | å…„å¼Ÿ |
| **ç”Ÿå‘½å‘¨æœŸ** | ä¸€èµ·åˆ›å»º/åˆ é™¤ | ç‹¬ç«‹ |
| **å›æ»š** | ä¸€èµ·å›æ»š | ç‹¬ç«‹å›æ»š |
| **éƒ¨ç½²é¡ºåº** | è‡ªåŠ¨å¤„ç† | éœ€æ‰‹åŠ¨è€ƒè™‘ |
| **é€‚ç”¨åœºæ™¯** | ç´§å¯†è€¦åˆç»„ä»¶ | æ¾è€¦åˆå±‚ |

### 4.2 åˆ›å»º Nested Stack å­æ¨¡æ¿

åˆ›å»º `nested-stacks/child-vpc.yaml`ï¼š

```yaml
AWSTemplateFormatVersion: '2010-09-09'
Description: Child Stack - VPC (used by parent stack)

Parameters:
  Environment:
    Type: String
  VpcCidr:
    Type: String
    Default: 10.0.0.0/16

Resources:
  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: !Ref VpcCidr
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value: !Sub '${Environment}-vpc'

  PublicSubnet:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.1.0/24
      AvailabilityZone: !Select [0, !GetAZs '']
      Tags:
        - Key: Name
          Value: !Sub '${Environment}-public'

Outputs:
  VpcId:
    Value: !Ref VPC
  SubnetId:
    Value: !Ref PublicSubnet
```

### 4.3 åˆ›å»º Parent Stack

åˆ›å»º `nested-stacks/parent.yaml`ï¼š

```yaml
AWSTemplateFormatVersion: '2010-09-09'
Description: Parent Stack - orchestrates nested stacks

Parameters:
  Environment:
    Type: String
    Default: dev
  TemplatesBucket:
    Type: String
    Description: S3 bucket containing nested stack templates

Resources:
  # è°ƒç”¨ VPC å­æ ˆ
  VpcStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub 'https://${TemplatesBucket}.s3.amazonaws.com/child-vpc.yaml'
      Parameters:
        Environment: !Ref Environment

  # ä½¿ç”¨å­æ ˆè¾“å‡ºåˆ›å»ºèµ„æº
  AppSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: App SG in nested VPC
      VpcId: !GetAtt VpcStack.Outputs.VpcId
      Tags:
        - Key: Name
          Value: !Sub '${Environment}-app-sg'

Outputs:
  VpcId:
    Description: VPC ID from nested stack
    Value: !GetAtt VpcStack.Outputs.VpcId
  SubnetId:
    Description: Subnet ID from nested stack
    Value: !GetAtt VpcStack.Outputs.SubnetId
```

### 4.4 Nested Stack å…³é”®è¯­æ³•

**è°ƒç”¨å­æ ˆ**ï¼š

```yaml
Type: AWS::CloudFormation::Stack
Properties:
  TemplateURL: https://bucket.s3.amazonaws.com/template.yaml
  Parameters:
    ParamName: ParamValue
```

**è·å–å­æ ˆè¾“å‡º**ï¼š

```yaml
!GetAtt StackLogicalId.Outputs.OutputKey
```

### 4.5 Nested Stack æ³¨æ„äº‹é¡¹

| æ³¨æ„ç‚¹ | è¯´æ˜ |
|--------|------|
| **æ¨¡æ¿å­˜å‚¨** | å­æ¨¡æ¿å¿…é¡»åœ¨ S3 ä¸Š |
| **URL æ ¼å¼** | ä½¿ç”¨ HTTPS URL |
| **æ›´æ–°ä¼ æ’­** | æ›´æ–°çˆ¶æ ˆä¼šæ£€æŸ¥æ‰€æœ‰å­æ ˆ |
| **åˆ é™¤é¡ºåº** | åˆ é™¤çˆ¶æ ˆä¼šè‡ªåŠ¨åˆ é™¤æ‰€æœ‰å­æ ˆ |

---

## Step 5 â€” é€‰æ‹©å“ªç§æ–¹å¼ï¼Ÿï¼ˆ5 åˆ†é’Ÿï¼‰

### 5.1 å†³ç­–æµç¨‹

![æ¶æ„é€‰æ‹©å†³ç­–æµç¨‹](images/decision-flow.png)

<details>
<summary>ğŸ“ ASCII æºç ï¼ˆç‚¹å‡»å±•å¼€ï¼‰</summary>

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         æ¶æ„é€‰æ‹©å†³ç­–æµç¨‹                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚   ç»„ä»¶éœ€è¦ç‹¬ç«‹éƒ¨ç½²å—ï¼Ÿ                                                â”‚
â”‚          â”‚                                                          â”‚
â”‚     Yes  â”‚   No                                                     â”‚
â”‚          â”‚                                                          â”‚
â”‚          â–¼                                                          â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”                                                   â”‚
â”‚   â”‚             â”‚                                                   â”‚
â”‚   â–¼             â–¼                                                   â”‚
â”‚   Cross-Stack   ç»„ä»¶ç”Ÿå‘½å‘¨æœŸç›¸åŒå—ï¼Ÿ                                  â”‚
â”‚   References           â”‚                                            â”‚
â”‚                   Yes  â”‚   No                                       â”‚
â”‚                        â”‚                                            â”‚
â”‚                        â–¼                                            â”‚
â”‚                 â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”                                     â”‚
â”‚                 â”‚             â”‚                                     â”‚
â”‚                 â–¼             â–¼                                     â”‚
â”‚             Nested        Cross-Stack                               â”‚
â”‚             Stacks        References                                â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

</details>

### 5.2 åœºæ™¯æ¨è

| åœºæ™¯ | æ¨èæ–¹å¼ | ç†ç”± |
|------|----------|------|
| VPC + App åˆ†ç¦» | **Cross-Stack** | ä¸åŒç”Ÿå‘½å‘¨æœŸã€ä¸åŒå›¢é˜Ÿ |
| ALB + EC2 ç»„åˆ | **Nested** | ç´§å¯†è€¦åˆã€ä¸€èµ·éƒ¨ç½² |
| å¤šç¯å¢ƒ VPC å¤ç”¨ | **Cross-Stack** | åŒä¸€ VPC å¤šä¸ªåº”ç”¨å¼•ç”¨ |
| ä¸€æ¬¡æ€§å®Œæ•´ç¯å¢ƒ | **Nested** | ç¯å¢ƒæ•´ä½“ç®¡ç† |

### 5.3 æ—¥æœ¬ä¼ä¸šå¸¸è§æ¨¡å¼

åœ¨æ—¥æœ¬çš„ SIer é¡¹ç›®ä¸­ï¼Œå¸¸è§çš„åˆ†å±‚æ¨¡å¼ï¼š

```
æœ¬ç•ªç’°å¢ƒ (Production)
â”œâ”€â”€ 01-network-stack       â† ç½‘ç»œå›¢é˜Ÿç®¡ç†ã€å¤‰æ›´ç®¡ç†å³æ ¼
â”œâ”€â”€ 02-security-stack      â† å®‰å…¨å›¢é˜Ÿç®¡ç†
â”œâ”€â”€ 03-database-stack      â† DBA ç®¡ç†
â””â”€â”€ 04-application-stack   â† åº”ç”¨å›¢é˜Ÿç®¡ç†ã€é »ç¹æ›´æ–°
```

> æ—¥æœ¬çš„è¿ç»´ç°åœºï¼Œè¿™ç§åˆ†å±‚å«åšã€Œãƒ¬ã‚¤ãƒ¤ãƒ¼åˆ†é›¢ã€ã€‚
> æ¯ä¸ªå±‚æœ‰ä¸åŒçš„å¤‰æ›´ç®¡ç†æµç¨‹å’Œæ‰¿èªè€…ã€‚

---

## Step 6 â€” Service Catalog ç®€ä»‹ï¼ˆ3 åˆ†é’Ÿï¼‰

> ä¼ä¸šçº§æ¨¡æ¿åˆ†å‘å·¥å…·ã€‚

### 6.1 ä»€ä¹ˆæ˜¯ Service Catalogï¼Ÿ

Service Catalog è®©ä½ ï¼š
- é¢„å®šä¹‰åˆè§„çš„ CloudFormation æ¨¡æ¿
- æ§åˆ¶è°å¯ä»¥ä½¿ç”¨å“ªäº›æ¨¡æ¿
- å¼€å‘è€…è‡ªåŠ©ç”³è¯·èµ„æº

![Service Catalog æ¦‚å¿µ](images/service-catalog.png)

<details>
<summary>ğŸ“ ASCII æºç ï¼ˆç‚¹å‡»å±•å¼€ï¼‰</summary>

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Service Catalog æ¦‚å¿µ                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚   Platform Team                         Developers                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚   â”‚  åˆ›å»º Product   â”‚                   â”‚  æµè§ˆ Catalog   â”‚        â”‚
â”‚   â”‚  (CFn Template) â”‚                   â”‚  é€‰æ‹© Product   â”‚        â”‚
â”‚   â”‚  è®¾ç½®æƒé™       â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶  â”‚  Launch Stack   â”‚        â”‚
â”‚   â”‚  ç‰ˆæœ¬ç®¡ç†       â”‚                   â”‚  è‡ªåŠ¨åˆè§„!      â”‚        â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                                     â”‚
â”‚   é€‚ç”¨åœºæ™¯:                                                          â”‚
â”‚   â€¢ å¤§å‹ä¼ä¸šæ ‡å‡†åŒ–                                                    â”‚
â”‚   â€¢ åˆè§„è¦æ±‚ä¸¥æ ¼ï¼ˆé‡‘è/æ”¿åºœï¼‰                                          â”‚
â”‚   â€¢ å¼€å‘è€…è‡ªåŠ©æœåŠ¡                                                    â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

</details>

### 6.2 ä¸å¤šæ ˆæ¶æ„çš„å…³ç³»

| æ–¹å¼ | ç”¨é€” |
|------|------|
| **Cross-Stack** | è¿ç»´å›¢é˜Ÿå†…éƒ¨åˆ†å±‚ |
| **Nested Stacks** | æ¨¡å—åŒ–å¤ç”¨ |
| **Service Catalog** | ä¼ä¸šçº§æ¨¡æ¿åˆ†å‘ |

Service Catalog çš„ Product å†…éƒ¨å¯ä»¥ä½¿ç”¨ Nested Stacksï¼

---

## Step 7 â€” åæ¨¡å¼è­¦å‘Šï¼ˆ3 åˆ†é’Ÿï¼‰

### 7.1 é¿å…è¿™äº›é—®é¢˜

| åæ¨¡å¼ | é—®é¢˜ | è§£å†³æ–¹æ¡ˆ |
|--------|------|----------|
| **5000+ è¡Œå•ä½“æ¨¡æ¿** | éš¾ç»´æŠ¤ã€éƒ¨ç½²æ…¢ | æŒ‰ç”Ÿå‘½å‘¨æœŸåˆ†å±‚ |
| **å¾ªç¯ä¾èµ–** | Stack A â†’ B â†’ A | é‡æ–°è®¾è®¡ä¾èµ–å…³ç³» |
| **å¿½ç•¥åˆ é™¤é¡ºåº** | åˆ é™¤å¤±è´¥ | å…ˆåˆ åº”ç”¨ã€ååˆ ç½‘ç»œ |
| **ç¡¬ç¼–ç  Export åç§°** | ç¯å¢ƒå†²çª | ä½¿ç”¨ `${Environment}-` å‰ç¼€ |

### 7.2 å¾ªç¯ä¾èµ–ç¤ºä¾‹

```yaml
# é”™è¯¯ç¤ºä¾‹ - å¾ªç¯ä¾èµ–ï¼

# Stack A
Resources:
  ResourceA:
    Properties:
      DependsOn: !ImportValue StackB-Output

Outputs:
  OutputA:
    Export:
      Name: StackA-Output

# Stack B
Resources:
  ResourceB:
    Properties:
      DependsOn: !ImportValue StackA-Output  # å¾ªç¯!

Outputs:
  OutputB:
    Export:
      Name: StackB-Output
```

**è§£å†³æ–¹æ¡ˆ**ï¼šé‡æ–°è®¾è®¡ï¼Œè®©ä¾èµ–å•å‘æµåŠ¨ã€‚

---

## Step 8 â€” åŠ¨æ‰‹ç»ƒä¹ ï¼šä¸‰å±‚æ¶æ„ï¼ˆ10 åˆ†é’Ÿï¼‰

> è¿ç”¨æ‰€å­¦ï¼Œéƒ¨ç½²ä¸€ä¸ªå®Œæ•´çš„ä¸‰å±‚æ¶æ„ã€‚

### 8.1 æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              dev-app-stack                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Security Group (App)              â”‚   â”‚
â”‚  â”‚  â†’ ImportValue: dev-VpcId          â”‚   â”‚
â”‚  â”‚  â†’ ImportValue: dev-ALBSecurityGroupId â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              dev-alb-stack                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ALB Security Group                â”‚   â”‚
â”‚  â”‚  â†’ ImportValue: dev-VpcId          â”‚   â”‚
â”‚  â”‚  â†’ ImportValue: dev-PublicSubnetIdsâ”‚   â”‚
â”‚  â”‚  Export: dev-ALBSecurityGroupId    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              dev-network-stack             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  VPC, Subnets, IGW                 â”‚   â”‚
â”‚  â”‚  Export: dev-VpcId                 â”‚   â”‚
â”‚  â”‚  Export: dev-PublicSubnetIds       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 8.2 éƒ¨ç½²é¡ºåº

1. **Network Stack** â†’ å¯¼å‡º VPCã€Subnet
2. **ALB Stack** â†’ å¯¼å…¥ VPCï¼Œå¯¼å‡º SG
3. **App Stack** â†’ å¯¼å…¥æ‰€æœ‰ä¾èµ–

### 8.3 éªŒè¯æ–¹æ³•

åœ¨ CloudFormation Console çš„ **Exports** é¡µé¢ï¼š
- ç¡®è®¤æ‰€æœ‰ Export éƒ½å­˜åœ¨
- ç‚¹å‡» Export å¯ä»¥çœ‹åˆ°å“ªäº› Stack åœ¨ä½¿ç”¨å®ƒ

---

## Step 9 â€” æ¸…ç†èµ„æºï¼ˆ5 åˆ†é’Ÿï¼‰

> **é‡è¦**ï¼šæŒ‰æ­£ç¡®é¡ºåºåˆ é™¤ï¼

### 9.1 åˆ é™¤é¡ºåº

**å¿…é¡»æŒ‰ä¾èµ–å…³ç³»çš„åå‘åˆ é™¤**ï¼š

1. å…ˆåˆ é™¤ `dev-app-stack`ï¼ˆä¾èµ–æœ€å¤šï¼‰
2. å†åˆ é™¤ `dev-alb-stack`ï¼ˆå¦‚æœæœ‰ï¼‰
3. æœ€ååˆ é™¤ `dev-network-stack`ï¼ˆè¢«ä¾èµ–æœ€å¤šï¼‰

### 9.2 åˆ é™¤æ­¥éª¤

1. é€‰æ‹© `dev-app-stack` â†’ **Delete**
2. ç­‰å¾… `DELETE_COMPLETE`
3. é€‰æ‹© `dev-network-stack` â†’ **Delete**
4. ç­‰å¾… `DELETE_COMPLETE`

### 9.3 å¦‚æœåˆ é™¤å¤±è´¥

å¦‚æœçœ‹åˆ°é”™è¯¯ï¼š

```
Export dev-VpcId cannot be deleted as it is in use by dev-app-stack
```

è¯´æ˜è¿˜æœ‰ Stack åœ¨å¼•ç”¨è¿™ä¸ª Exportï¼Œå…ˆåˆ é™¤ä¾èµ–çš„ Stackã€‚

---

## èŒåœºå°è´´å£«

### æ—¥æœ¬ä¼ä¸šçš„å¤šæ ˆç®¡ç†

åœ¨æ—¥æœ¬çš„ IT ç°åœºï¼Œå¤šæ ˆæ¶æ„é€šå¸¸æ¶‰åŠï¼š

**1. å¤‰æ›´ç®¡ç†åˆ†é›¢**

```
Network Stack â†’ å¤‰æ›´ç®¡ç†å§”å“¡ä¼šã®æ‰¿èªå¿…é ˆï¼ˆæœˆ1å›ï¼‰
App Stack    â†’ ãƒãƒ¼ãƒ ãƒªãƒ¼ãƒ€ãƒ¼æ‰¿èªã§å¯ï¼ˆæ—¥æ¬¡ï¼‰
```

**2. æ¨©é™åˆ†é›¢**

| å±‚ | æ¨©é™è€… | IAM è®¾ç½® |
|---|--------|----------|
| Network | ã‚¤ãƒ³ãƒ•ãƒ©ãƒãƒ¼ãƒ  | å…¨æƒé™ |
| App | é–‹ç™ºãƒãƒ¼ãƒ  | åªèƒ½æ“ä½œ App Stack |

**3. è¯è¿¹ç®¡ç†**

æ¯æ¬¡ Stack æ“ä½œéƒ½éœ€è¦è®°å½•ï¼š
- ChangeSet æˆªå›¾
- å®Ÿè¡Œå‰/å®Ÿè¡Œå¾Œã®çŠ¶æ…‹
- æ‰¿èªè€…ç½²å

### å¸¸è§æ—¥è¯­æœ¯è¯­

| æ—¥è¯­ | è¯»éŸ³ | ä¸­æ–‡ | è‹±æ–‡ |
|------|------|------|------|
| è¦ªã‚¹ã‚¿ãƒƒã‚¯ | ãŠã‚„ã™ãŸã£ã | çˆ¶æ ˆ | Parent Stack |
| å­ã‚¹ã‚¿ãƒƒã‚¯ | ã“ã™ãŸã£ã | å­æ ˆ | Child Stack |
| ä¾å­˜é–¢ä¿‚ | ã„ãã‚“ã‹ã‚“ã‘ã„ | ä¾èµ–å…³ç³» | Dependencies |
| ãƒ¬ã‚¤ãƒ¤ãƒ¼åˆ†é›¢ | ã‚Œã„ã‚„ãƒ¼ã¶ã‚“ã‚Š | å±‚åˆ†ç¦» | Layer Separation |

---

## æ£€æŸ¥æ¸…å•

å®Œæˆæœ¬è¯¾åï¼Œä½ åº”è¯¥èƒ½å¤Ÿï¼š

- [ ] è§£é‡Šå•ä½“æ¨¡æ¿çš„ 3 ä¸ªä¸»è¦é—®é¢˜
- [ ] ä½¿ç”¨ Export å’Œ ImportValue å®ç°è·¨æ ˆå¼•ç”¨
- [ ] åŒºåˆ† Nested Stacks å’Œ Cross-Stack References çš„é€‚ç”¨åœºæ™¯
- [ ] è®¾è®¡ Layer åŒ–æ¶æ„ï¼ˆNetwork â†’ Foundations â†’ Appï¼‰
- [ ] æŒ‰æ­£ç¡®é¡ºåºåˆ é™¤æœ‰ä¾èµ–å…³ç³»çš„ Stacks

---

## é¢è¯•å‡†å¤‡

### ã‚ˆãã‚ã‚‹è³ªå•ï¼ˆå¸¸è§é¢è¯•é¢˜ï¼‰

**Q: Nested Stacks ã¨ Cross-Stack References ã®é•ã„ã¯ï¼Ÿ**

A: Nested ã¯è¦ªå­é–¢ä¿‚ã§ä¸€ç·’ã«ç®¡ç†ã€‚è¦ª Stack ã‚’å‰Šé™¤ã™ã‚‹ã¨å­ã‚‚å…¨ã¦å‰Šé™¤ã•ã‚Œã‚‹ã€‚Cross-Stack ã¯ç‹¬ç«‹ã—ãŸã‚¹ã‚¿ãƒƒã‚¯é–“ã§å€¤ã‚’å…±æœ‰ã€‚ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ãŒåŒã˜ãªã‚‰ Nestedã€é•ã†ãªã‚‰ Cross-Stack ã‚’ä½¿ã†ã€‚

ï¼ˆNested æ˜¯çˆ¶å­å…³ç³»ï¼Œä¸€èµ·ç®¡ç†ã€‚åˆ é™¤çˆ¶ Stack ä¼šåˆ é™¤æ‰€æœ‰å­æ ˆã€‚Cross-Stack æ˜¯ç‹¬ç«‹æ ˆä¹‹é—´å…±äº«å€¼ã€‚ç”Ÿå‘½å‘¨æœŸç›¸åŒç”¨ Nestedï¼Œä¸åŒç”¨ Cross-Stackã€‚ï¼‰

**Q: Export ã‚’å‰Šé™¤ã§ããªã„å ´åˆã¯ã©ã†ã—ã¾ã™ã‹ï¼Ÿ**

A: ãã® Export ã‚’ ImportValue ã—ã¦ã„ã‚‹ Stack ã‚’å…ˆã«å‰Šé™¤ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚CloudFormation Console ã® Exports ç”»é¢ã§ã€ã©ã® Stack ãŒä½¿ç”¨ã—ã¦ã„ã‚‹ã‹ç¢ºèªã§ãã‚‹ã€‚

ï¼ˆéœ€è¦å…ˆåˆ é™¤å¼•ç”¨è¯¥ Export çš„ Stackã€‚å¯ä»¥åœ¨ CloudFormation Console çš„ Exports é¡µé¢ç¡®è®¤å“ªäº› Stack åœ¨ä½¿ç”¨ã€‚ï¼‰

**Q: å¤§è¦æ¨¡ãª CloudFormation ç’°å¢ƒã‚’ã©ã†è¨­è¨ˆã—ã¾ã™ã‹ï¼Ÿ**

A: ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«åˆ¥ã«ãƒ¬ã‚¤ãƒ¤ãƒ¼åˆ†é›¢ï¼ˆNetwork / Foundations / Applicationï¼‰ã€‚å„ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯ Cross-Stack References ã§é€£æºã€‚å¤‰æ›´é »åº¦ã®é«˜ã„ Application å±¤ã¯ç‹¬ç«‹ã—ã¦ãƒ‡ãƒ—ãƒ­ã‚¤å¯èƒ½ã«ã™ã‚‹ã€‚

ï¼ˆæŒ‰ç”Ÿå‘½å‘¨æœŸåˆ†å±‚ï¼ˆNetwork / Foundations / Applicationï¼‰ã€‚å„å±‚é€šè¿‡ Cross-Stack References è¿æ¥ã€‚å˜æ›´é¢‘ç‡é«˜çš„ Application å±‚å¯ç‹¬ç«‹éƒ¨ç½²ã€‚ï¼‰

---

## å»¶ä¼¸é˜…è¯»

- [AWS CloudFormation - Nested Stacks](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/using-cfn-nested-stacks.html)
- [Cross-Stack References](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/walkthrough-crossstackref.html)
- [AWS Service Catalog](https://docs.aws.amazon.com/servicecatalog/latest/adminguide/introduction.html)
- å¯¹æ¯”å­¦ä¹ ï¼š[Terraform 08 - é¡¹ç›®å¸ƒå±€](../../terraform/08-layout/)

---

## ä¸‹ä¸€æ­¥

ä½ å·²ç»æŒæ¡äº†å¤šæ ˆæ¶æ„è®¾è®¡ã€‚ä¸‹ä¸€è¯¾æˆ‘ä»¬å°†å­¦ä¹ ï¼š

- Drift æ£€æµ‹ï¼ˆé…ç½®ä¸ç°å®ä¸åŒ¹é…ï¼‰
- èµ„æºå¯¼å…¥ï¼ˆå°†ç°æœ‰èµ„æºçº³å…¥ CloudFormation ç®¡ç†ï¼‰
- Stack Refactoringï¼ˆ2025 æ–°åŠŸèƒ½ï¼‰

--> [05 - Drift æ£€æµ‹ä¸èµ„æºå¯¼å…¥](../05-drift-import/)

---

## ç³»åˆ—å¯¼èˆª

[<-- 03 - ç°ä»£å·¥å…·](../03-modern-tools/) | [Home](../) | [05 - Drift æ£€æµ‹ -->](../05-drift-import/)
