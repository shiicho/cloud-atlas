# =============================================================================
# ALB Stack - ALB Security Group Layer
# =============================================================================
#
# Middle layer Stack for Step 8 exercise
# Imports VPC and Subnet from Network Stack, exports ALB Security Group ID
#
# Usage:
#   1. First deploy network-stack.yaml (dev-network-stack)
#   2. Then deploy this template (dev-alb-stack)
#   3. Finally deploy app-stack.yaml (dev-app-stack)
#
# Cleanup order:
#   1. First delete dev-app-stack
#   2. Then delete dev-alb-stack
#   3. Finally delete dev-network-stack
#
# =============================================================================

AWSTemplateFormatVersion: '2010-09-09'
Description: |
  ALB Layer Stack - Security Group for Application Load Balancer
  Imports VPC from network-stack, exports ALB SG for app-stack

Parameters:
  Environment:
    Type: String
    Default: dev
    AllowedValues: [dev, staging, prod]
    Description: Environment name (must match network-stack)

Resources:
  # ALB Security Group - Allow HTTP/HTTPS inbound
  ALBSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: !Sub 'Security group for ${Environment} ALB'
      VpcId: !ImportValue
        Fn::Sub: '${Environment}-VpcId'
      SecurityGroupIngress:
        # HTTP inbound
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
          Description: HTTP from internet
        # HTTPS inbound
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
          Description: HTTPS from internet
      Tags:
        - Key: Name
          Value: !Sub '${Environment}-alb-sg'
        - Key: Environment
          Value: !Ref Environment
        - Key: ManagedBy
          Value: CloudFormation
        - Key: Layer
          Value: ALB

Outputs:
  ALBSecurityGroupId:
    Description: ALB Security Group ID (for app-stack reference)
    Value: !Ref ALBSecurityGroup
    Export:
      Name: !Sub '${Environment}-ALBSecurityGroupId'

  ALBSecurityGroupVpcId:
    Description: VPC ID where ALB SG was created
    Value: !ImportValue
      Fn::Sub: '${Environment}-VpcId'
