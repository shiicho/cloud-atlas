# =============================================================================
# Parent Stack - Nested Stacks Orchestration
# =============================================================================
#
# Parent stack template - Orchestrates multiple child stacks for modular deployment
#
# What are Nested Stacks?
#   - Parent stack calls child stacks via AWS::CloudFormation::Stack resource
#   - Child templates must be stored on S3
#   - Parent and child stacks create, delete, and rollback together
#
# Usage steps:
#   1. Upload child-vpc.yaml to S3 bucket
#   2. Create this parent stack via Console
#   3. Specify TemplatesBucket parameter as your S3 bucket name
#
# Difference from Cross-Stack:
#   - Nested: Parent-child relationship, same lifecycle
#   - Cross-Stack: Sibling relationship, independent lifecycle
#
# =============================================================================

AWSTemplateFormatVersion: '2010-09-09'
Description: |
  Parent Stack - Orchestrates nested child stacks.
  Demonstrates modular architecture with AWS::CloudFormation::Stack.

# -----------------------------------------------------------------------------
# Metadata - Console parameter grouping
# -----------------------------------------------------------------------------
Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: Environment Configuration
        Parameters:
          - Environment
      - Label:
          default: Template Storage
        Parameters:
          - TemplatesBucket
      - Label:
          default: Network Configuration
        Parameters:
          - VpcCidr
    ParameterLabels:
      Environment:
        default: Environment Name
      TemplatesBucket:
        default: S3 Bucket (for child stack templates)
      VpcCidr:
        default: VPC CIDR

# -----------------------------------------------------------------------------
# Parameters - Input parameters
# -----------------------------------------------------------------------------
Parameters:
  Environment:
    Type: String
    Default: dev
    AllowedValues:
      - dev
      - staging
      - prod
    Description: Environment name

  TemplatesBucket:
    Type: String
    Description: |
      S3 Bucket name where child stack templates are stored.
      Example: my-cfn-templates-bucket
      Child template should be uploaded to: s3://bucket-name/nested-stacks/child-vpc.yaml

  VpcCidr:
    Type: String
    Default: 10.0.0.0/16
    AllowedPattern: '^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/([0-9]|[1-2][0-9]|3[0-2]))$'
    Description: VPC CIDR block

# -----------------------------------------------------------------------------
# Resources - Resource definitions
# -----------------------------------------------------------------------------
Resources:

  # ---------------------------------------------------------------------------
  # Nested Stack: VPC Layer
  # ---------------------------------------------------------------------------
  # Calls child stack to create VPC and related network resources
  VpcStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      # Child template URL (must be S3 HTTPS URL)
      TemplateURL: !Sub 'https://${TemplatesBucket}.s3.${AWS::Region}.amazonaws.com/nested-stacks/child-vpc.yaml'
      # Pass parameters to child stack
      Parameters:
        Environment: !Ref Environment
        VpcCidr: !Ref VpcCidr
      # Child stack tags
      Tags:
        - Key: Name
          Value: !Sub '${Environment}-vpc-stack'
        - Key: Environment
          Value: !Ref Environment
        - Key: StackType
          Value: Nested
      # Timeout setting (minutes)
      TimeoutInMinutes: 10

  # ---------------------------------------------------------------------------
  # Resources created using child stack outputs
  # ---------------------------------------------------------------------------
  # This Security Group uses VPC child stack output
  ApplicationSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Application Security Group created by parent stack
      # Get child stack Outputs
      VpcId: !GetAtt VpcStack.Outputs.VpcId
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: !Sub '${Environment}-app-sg'
        - Key: Environment
          Value: !Ref Environment
        - Key: ManagedBy
          Value: CloudFormation-ParentStack

  # ---------------------------------------------------------------------------
  # Another example using child stack output
  # ---------------------------------------------------------------------------
  DatabaseSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Database Security Group
      VpcId: !GetAtt VpcStack.Outputs.VpcId
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 3306
          ToPort: 3306
          SourceSecurityGroupId: !Ref ApplicationSecurityGroup
      Tags:
        - Key: Name
          Value: !Sub '${Environment}-db-sg'
        - Key: Environment
          Value: !Ref Environment

# -----------------------------------------------------------------------------
# Outputs - Output values
# -----------------------------------------------------------------------------
Outputs:

  # Parent stack's own Stack ID
  ParentStackId:
    Description: Parent Stack ID
    Value: !Ref 'AWS::StackId'

  # Child stack Stack ID
  VpcStackId:
    Description: VPC Nested Stack ID
    Value: !Ref VpcStack

  # VPC ID from child stack
  VpcId:
    Description: VPC ID (from nested stack)
    Value: !GetAtt VpcStack.Outputs.VpcId

  # Subnet from child stack
  PublicSubnetId:
    Description: Public Subnet ID (from nested stack)
    Value: !GetAtt VpcStack.Outputs.SubnetId

  # Security groups created by parent stack
  ApplicationSecurityGroupId:
    Description: Application Security Group ID (created by parent)
    Value: !Ref ApplicationSecurityGroup

  DatabaseSecurityGroupId:
    Description: Database Security Group ID (created by parent)
    Value: !Ref DatabaseSecurityGroup

  # Deployment notes
  DeploymentNotes:
    Description: Important deployment information
    Value: !Sub |
      Nested Stack deployment successful!

      Important notes:
      1. Deleting parent stack will automatically delete all child stacks
      2. Updating parent stack will check all child stack changes
      3. Child stack changes should be made through parent stack

      View child stack:
      CloudFormation Console -> Select parent stack -> Resources tab -> Click VpcStack
