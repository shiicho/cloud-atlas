# =============================================================================
# Application Stack - Application Layer Template
# =============================================================================
#
# Application layer template - Creates application resources using exported
# values from Network Stack
#
# Prerequisites:
#   Must first deploy network-stack.yaml and ensure Exports are available
#
# Usage:
#   1. Ensure {Environment}-network-stack is deployed
#   2. Upload this template via Console
#   3. Recommended Stack name: {environment}-app-stack
#   4. Environment parameter must match network-stack!
#
# Referenced Imports:
#   - {Environment}-VpcId
#   - {Environment}-PublicSubnet1Id
#   - {Environment}-PublicSubnet2Id
#   - {Environment}-PrivateSubnetIds
#
# =============================================================================

AWSTemplateFormatVersion: '2010-09-09'
Description: |
  Application Layer Stack - Security Groups and Resources
  Imports values from network-stack via cross-stack references.
  Deploy AFTER network-stack is complete.

# -----------------------------------------------------------------------------
# Parameters - Input parameters
# -----------------------------------------------------------------------------
Parameters:
  Environment:
    Type: String
    Default: dev
    AllowedValues:
      - dev
      - staging
      - prod
    Description: |
      Environment name - must match network-stack Environment parameter!
      Used to find correct Export name.

  AllowedCidr:
    Type: String
    Default: 0.0.0.0/0
    Description: CIDR allowed to access ALB (recommend restricting for production)

  AppPort:
    Type: Number
    Default: 8080
    Description: Application listening port

# -----------------------------------------------------------------------------
# Resources - Resource definitions
# -----------------------------------------------------------------------------
Resources:

  # ---------------------------------------------------------------------------
  # ALB Security Group - Load Balancer Security Group
  # ---------------------------------------------------------------------------
  ALBSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for Application Load Balancer
      # Cross-stack reference: Import VpcId from network-stack
      VpcId: !ImportValue
        Fn::Sub: '${Environment}-VpcId'
      SecurityGroupIngress:
        # HTTP
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: !Ref AllowedCidr
        # HTTPS
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: !Ref AllowedCidr
      SecurityGroupEgress:
        - IpProtocol: '-1'
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: !Sub '${Environment}-alb-sg'
        - Key: Environment
          Value: !Ref Environment
        - Key: ManagedBy
          Value: CloudFormation

  # ---------------------------------------------------------------------------
  # Application Security Group - Application Security Group
  # ---------------------------------------------------------------------------
  AppSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for Application instances
      VpcId: !ImportValue
        Fn::Sub: '${Environment}-VpcId'
      SecurityGroupIngress:
        # Only allow traffic from ALB
        - IpProtocol: tcp
          FromPort: !Ref AppPort
          ToPort: !Ref AppPort
          SourceSecurityGroupId: !Ref ALBSecurityGroup
      SecurityGroupEgress:
        - IpProtocol: '-1'
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: !Sub '${Environment}-app-sg'
        - Key: Environment
          Value: !Ref Environment
        - Key: ManagedBy
          Value: CloudFormation

  # ---------------------------------------------------------------------------
  # Database Security Group - Database Security Group
  # ---------------------------------------------------------------------------
  DatabaseSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for Database (RDS)
      VpcId: !ImportValue
        Fn::Sub: '${Environment}-VpcId'
      SecurityGroupIngress:
        # Only allow traffic from App
        - IpProtocol: tcp
          FromPort: 3306
          ToPort: 3306
          SourceSecurityGroupId: !Ref AppSecurityGroup
        - IpProtocol: tcp
          FromPort: 5432
          ToPort: 5432
          SourceSecurityGroupId: !Ref AppSecurityGroup
      Tags:
        - Key: Name
          Value: !Sub '${Environment}-db-sg'
        - Key: Environment
          Value: !Ref Environment
        - Key: ManagedBy
          Value: CloudFormation

  # ---------------------------------------------------------------------------
  # Application Load Balancer (Example)
  # ---------------------------------------------------------------------------
  # Note: This is just an example, actual use requires Target Group and Listener

  # ApplicationLoadBalancer:
  #   Type: AWS::ElasticLoadBalancingV2::LoadBalancer
  #   Properties:
  #     Name: !Sub '${Environment}-alb'
  #     Scheme: internet-facing
  #     SecurityGroups:
  #       - !Ref ALBSecurityGroup
  #     Subnets:
  #       # Use Split to split comma-separated subnet list
  #       - !ImportValue
  #           Fn::Sub: '${Environment}-PublicSubnet1Id'
  #       - !ImportValue
  #           Fn::Sub: '${Environment}-PublicSubnet2Id'
  #     Tags:
  #       - Key: Name
  #         Value: !Sub '${Environment}-alb'

# -----------------------------------------------------------------------------
# Outputs - Output values
# -----------------------------------------------------------------------------
Outputs:

  # ALB Security Group ID (no Export - avoids conflict with alb-stack.yaml)
  ALBSecurityGroupId:
    Description: ALB Security Group ID (created internally by this stack)
    Value: !Ref ALBSecurityGroup

  # App Security Group ID
  AppSecurityGroupId:
    Description: Application Security Group ID
    Value: !Ref AppSecurityGroup
    Export:
      Name: !Sub '${Environment}-AppSecurityGroupId'

  # Database Security Group ID
  DatabaseSecurityGroupId:
    Description: Database Security Group ID
    Value: !Ref DatabaseSecurityGroup
    Export:
      Name: !Sub '${Environment}-DatabaseSecurityGroupId'

  # Display referenced VPC (to verify cross-stack reference works)
  ImportedVpcId:
    Description: VPC ID imported from network-stack
    Value: !ImportValue
      Fn::Sub: '${Environment}-VpcId'
