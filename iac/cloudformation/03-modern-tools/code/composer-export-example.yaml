# =============================================================================
# composer-export-example.yaml
# Infrastructure Composer Export Example - Simplified Three-Tier Architecture
# =============================================================================
#
# This template demonstrates typical output from Infrastructure Composer.
# Based on the Mini Project's three-tier architecture design, simplified for learning.
#
# Architecture:
#   - VPC + 2 Public Subnets + 2 Private Subnets
#   - Internet Gateway + Route Table
#   - Application Load Balancer (Public)
#   - EC2 Instance (Private)
#   - Security Groups
#
# Usage:
#   1. CloudFormation Console -> Create stack
#   2. Upload this file
#   3. Fill in Parameters (KeyPair etc.)
#   4. Wait for CREATE_COMPLETE
#
# Validation:
#   - cfn-lint composer-export-example.yaml
#
# Cleanup:
#   - CloudFormation Console -> Delete stack
#
# =============================================================================

AWSTemplateFormatVersion: '2010-09-09'

# -----------------------------------------------------------------------------
# Description
# -----------------------------------------------------------------------------
# Infrastructure Composer generated templates automatically add descriptions.
# Here we manually added more detailed explanations.

Description: |
  Infrastructure Composer Export Example
  Three-tier Architecture: VPC + ALB + EC2
  CloudFormation Course Lesson 03 Sample Template

# -----------------------------------------------------------------------------
# Metadata
# -----------------------------------------------------------------------------
# Infrastructure Composer generates this Metadata block for restoring
# visual layout when reopening in Console.

Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: "Network Configuration"
        Parameters:
          - VpcCidr
      - Label:
          default: "EC2 Configuration"
        Parameters:
          - InstanceType
          - LatestAmiId

# -----------------------------------------------------------------------------
# Parameters
# -----------------------------------------------------------------------------
# Using parameters makes templates more flexible and reusable across environments.

Parameters:

  # VPC CIDR Block
  VpcCidr:
    Type: String
    Default: "10.0.0.0/16"
    Description: VPC CIDR Block
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/([0-9]|[1-2][0-9]|3[0-2]))$

  # EC2 Instance Type
  InstanceType:
    Type: String
    Default: t3.micro
    Description: EC2 Instance Type
    AllowedValues:
      - t3.micro
      - t3.small
      - t3.medium

  # Latest Amazon Linux 2023 AMI (using SSM Parameter)
  # This is AWS recommended approach, automatically gets latest AMI ID
  LatestAmiId:
    Type: AWS::SSM::Parameter::Value<AWS::EC2::Image::Id>
    Default: /aws/service/ami-amazon-linux-latest/al2023-ami-kernel-default-x86_64
    Description: Latest Amazon Linux 2023 AMI ID (auto-resolved from SSM)

# -----------------------------------------------------------------------------
# Resources
# -----------------------------------------------------------------------------
# Resource definitions automatically generated by Infrastructure Composer.
# Includes VPC, Subnet, IGW, Route Table, ALB, EC2, Security Groups.

Resources:

  # ---------------------------------------------------------------------------
  # VPC
  # ---------------------------------------------------------------------------

  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: !Ref VpcCidr
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-VPC"
        - Key: ManagedBy
          Value: CloudFormation

  # ---------------------------------------------------------------------------
  # Internet Gateway
  # ---------------------------------------------------------------------------

  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-IGW"

  # VPC and IGW Association
  VPCGatewayAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref VPC
      InternetGatewayId: !Ref InternetGateway

  # ---------------------------------------------------------------------------
  # Subnets
  # ---------------------------------------------------------------------------
  # 2 Public Subnets (for ALB)
  # 2 Private Subnets (for EC2)

  PublicSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: "10.0.1.0/24"
      AvailabilityZone: !Select
        - 0
        - !GetAZs ""
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-PublicSubnet1"

  PublicSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: "10.0.2.0/24"
      AvailabilityZone: !Select
        - 1
        - !GetAZs ""
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-PublicSubnet2"

  PrivateSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: "10.0.3.0/24"
      AvailabilityZone: !Select
        - 0
        - !GetAZs ""
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-PrivateSubnet1"

  PrivateSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: "10.0.4.0/24"
      AvailabilityZone: !Select
        - 1
        - !GetAZs ""
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-PrivateSubnet2"

  # ---------------------------------------------------------------------------
  # Route Tables
  # ---------------------------------------------------------------------------

  # Public Route Table
  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-PublicRT"

  # Default route to IGW
  PublicRoute:
    Type: AWS::EC2::Route
    DependsOn: VPCGatewayAttachment
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: "0.0.0.0/0"
      GatewayId: !Ref InternetGateway

  # Associate Public Subnet to Public Route Table
  PublicSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet1
      RouteTableId: !Ref PublicRouteTable

  PublicSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet2
      RouteTableId: !Ref PublicRouteTable

  # ---------------------------------------------------------------------------
  # Security Groups
  # ---------------------------------------------------------------------------

  # ALB Security Group - Allow HTTP/HTTPS traffic
  ALBSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: !Sub "${AWS::StackName}-ALB-SG"
      GroupDescription: Security group for ALB
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: "0.0.0.0/0"
          Description: Allow HTTP from anywhere
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: "0.0.0.0/0"
          Description: Allow HTTPS from anywhere
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-ALB-SG"

  # EC2 Security Group - Only allow traffic from ALB
  EC2SecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: !Sub "${AWS::StackName}-EC2-SG"
      GroupDescription: Security group for EC2 instances
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          SourceSecurityGroupId: !Ref ALBSecurityGroup
          Description: Allow HTTP from ALB only
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-EC2-SG"

  # ---------------------------------------------------------------------------
  # Application Load Balancer
  # ---------------------------------------------------------------------------

  ApplicationLoadBalancer:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    Properties:
      Name: !Sub "${AWS::StackName}-ALB"
      Type: application
      Scheme: internet-facing
      Subnets:
        - !Ref PublicSubnet1
        - !Ref PublicSubnet2
      SecurityGroups:
        - !Ref ALBSecurityGroup
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-ALB"

  # ALB Target Group
  ALBTargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      Name: !Sub "${AWS::StackName}-TG"
      Port: 80
      Protocol: HTTP
      VpcId: !Ref VPC
      TargetType: instance
      HealthCheckEnabled: true
      HealthCheckPath: /
      HealthCheckProtocol: HTTP
      Targets:
        - Id: !Ref EC2Instance
          Port: 80

  # ALB Listener
  ALBListener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      LoadBalancerArn: !Ref ApplicationLoadBalancer
      Port: 80
      Protocol: HTTP
      DefaultActions:
        - Type: forward
          TargetGroupArn: !Ref ALBTargetGroup

  # ---------------------------------------------------------------------------
  # EC2 Instance
  # ---------------------------------------------------------------------------
  # Simplified: Only creates one instance for demonstration

  # IAM Role for EC2 (for SSM access)
  EC2Role:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub "${AWS::StackName}-EC2Role"
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-EC2Role"

  # Instance Profile
  EC2InstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      InstanceProfileName: !Sub "${AWS::StackName}-EC2Profile"
      Roles:
        - !Ref EC2Role

  # EC2 Instance
  # Note: Placed in Public Subnet so UserData can access internet to install software
  # Production should use Private Subnet + NAT Gateway
  EC2Instance:
    Type: AWS::EC2::Instance
    Properties:
      InstanceType: !Ref InstanceType
      ImageId: !Ref LatestAmiId
      # Using Public Subnet to ensure UserData can download packages
      # ALB will forward traffic to this instance
      SubnetId: !Ref PublicSubnet1
      SecurityGroupIds:
        - !Ref EC2SecurityGroup
      IamInstanceProfile: !Ref EC2InstanceProfile
      # UserData: Install and start simple web server
      UserData:
        Fn::Base64: |
          #!/bin/bash
          yum update -y
          yum install -y httpd
          systemctl start httpd
          systemctl enable httpd
          echo "<h1>Hello from CloudFormation!</h1>" > /var/www/html/index.html
          echo "<p>Instance ID: $(curl -s http://169.254.169.254/latest/meta-data/instance-id)</p>" >> /var/www/html/index.html
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-WebServer"
        - Key: ManagedBy
          Value: CloudFormation

# -----------------------------------------------------------------------------
# Outputs
# -----------------------------------------------------------------------------
# Export important resource information for later use or debugging.

Outputs:

  VPCId:
    Description: VPC ID
    Value: !Ref VPC
    Export:
      Name: !Sub "${AWS::StackName}-VPCId"

  ALBDNSName:
    Description: ALB DNS Name (access this URL to view web page)
    Value: !GetAtt ApplicationLoadBalancer.DNSName

  ALBArn:
    Description: ALB ARN
    Value: !Ref ApplicationLoadBalancer

  EC2InstanceId:
    Description: EC2 Instance ID
    Value: !Ref EC2Instance

  PublicSubnets:
    Description: Public Subnet IDs
    Value: !Join
      - ","
      - - !Ref PublicSubnet1
        - !Ref PublicSubnet2
    Export:
      Name: !Sub "${AWS::StackName}-PublicSubnets"

  PrivateSubnets:
    Description: Private Subnet IDs
    Value: !Join
      - ","
      - - !Ref PrivateSubnet1
        - !Ref PrivateSubnet2
    Export:
      Name: !Sub "${AWS::StackName}-PrivateSubnets"

# =============================================================================
# About Infrastructure Composer Export
# =============================================================================
#
# Characteristics of templates generated by Infrastructure Composer:
#
# 1. Auto-generated Metadata
#    - Contains visual layout information
#    - Allows Canvas restoration when reopening
#
# 2. Smart Dependency Inference
#    - Automatically adds !Ref and !GetAtt
#    - Automatically handles resource creation order
#
# 3. Best Practices
#    - Uses !Sub for dynamic name generation
#    - Uses SSM Parameter for AMI ID
#    - Adds necessary Tags
#
# This template has been optimized from Composer export with:
#   - Added detailed English comments
#   - Optimized Security Group rules
#   - Added UserData example
#   - Added cross-stack Export
#
# =============================================================================
