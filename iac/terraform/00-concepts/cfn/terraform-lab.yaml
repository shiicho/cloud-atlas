AWSTemplateFormatVersion: '2010-09-09'
Description: |
  Terraform Learning Lab Environment
  - EC2 instance with Terraform, AWS CLI, Git pre-installed
  - Dedicated 'terraform' user for course work
  - SSM Session Manager access (no SSH key needed)
  - VS Code Remote-SSH compatible
  - IAM Role with scoped permissions for learning exercises
  - S3 bucket for Terraform remote state (with versioning)
  - sync-course script for easy code synchronization

Parameters:
  InstanceType:
    Type: String
    Default: t3.small
    AllowedValues:
      - t3.micro
      - t3.small
      - t3.medium
    Description: EC2 instance type (t3.small recommended for comfortable development)

  VpcCidr:
    Type: String
    Default: 10.0.0.0/16
    Description: VPC CIDR block

  SubnetCidr:
    Type: String
    Default: 10.0.1.0/24
    Description: Public subnet CIDR block

  Project:
    Type: String
    Default: terraform-lab
    Description: Project name for tagging

Resources:
  # ===========================================================================
  # VPC & Networking
  # ===========================================================================

  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: !Ref VpcCidr
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value: !Sub ${Project}-vpc

  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: !Sub ${Project}-igw

  AttachGateway:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref VPC
      InternetGatewayId: !Ref InternetGateway

  PublicSubnet:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !Ref SubnetCidr
      AvailabilityZone: !Select [0, !GetAZs '']
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub ${Project}-public-subnet

  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub ${Project}-public-rt

  PublicRoute:
    Type: AWS::EC2::Route
    DependsOn: AttachGateway
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway

  SubnetRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet
      RouteTableId: !Ref PublicRouteTable

  # ===========================================================================
  # Security Group
  # ===========================================================================

  SecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for Terraform lab instance
      VpcId: !Ref VPC
      # No inbound rules - SSM Session Manager doesn't need them
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0
          Description: Allow all outbound traffic
      Tags:
        - Key: Name
          Value: !Sub ${Project}-sg

  # ===========================================================================
  # S3 Bucket for Terraform State
  # ===========================================================================

  TfStateBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub 'tfstate-${Project}-${AWS::AccountId}'
      VersioningConfiguration:
        Status: Enabled
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      Tags:
        - Key: Name
          Value: !Sub ${Project}-tfstate
        - Key: Purpose
          Value: terraform-state

  # ===========================================================================
  # S3 Bucket Auto-Cleanup (Lambda Custom Resource)
  # ===========================================================================
  # Automatically empties the S3 bucket on stack deletion
  # Handles versioned objects and delete markers

  S3BucketCleanupRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub ${Project}-S3CleanupRole
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: S3CleanupPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:ListBucket
                  - s3:ListBucketVersions
                  - s3:DeleteObject
                  - s3:DeleteObjectVersion
                Resource:
                  - !GetAtt TfStateBucket.Arn
                  - !Sub "${TfStateBucket.Arn}/*"

  S3BucketCleanupLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub /aws/lambda/${Project}-S3BucketCleanup
      RetentionInDays: 7

  S3BucketCleanupFunction:
    Type: AWS::Lambda::Function
    DependsOn: S3BucketCleanupLogGroup
    Properties:
      FunctionName: !Sub ${Project}-S3BucketCleanup
      Description: Empties S3 bucket on CloudFormation stack deletion
      Handler: index.handler
      Role: !GetAtt S3BucketCleanupRole.Arn
      Runtime: nodejs20.x
      Timeout: 300
      Code:
        ZipFile: |
          const { S3Client, ListObjectsV2Command, DeleteObjectsCommand, ListObjectVersionsCommand } = require("@aws-sdk/client-s3");
          const response = require('cfn-response');
          const s3 = new S3Client();

          const sendResponse = (event, context, ...args) => {
            return new Promise((resolve, reject) => {
              context.done = (err) => { err ? reject(err) : resolve(); };
              response.send(event, context, ...args);
            });
          };

          const deleteObjects = async (bucket) => {
            console.log(`Deleting objects from ${bucket}`);
            let token;
            while (true) {
              const res = await s3.send(new ListObjectsV2Command({ Bucket: bucket, ContinuationToken: token }));
              const objects = (res.Contents || []).map((item) => ({ Key: item.Key }));
              if (objects.length > 0) {
                await s3.send(new DeleteObjectsCommand({ Bucket: bucket, Delete: { Objects: objects } }));
              }
              if (!res.IsTruncated) break;
              token = res.NextContinuationToken;
            }
          };

          const deleteVersions = async (bucket) => {
            console.log(`Deleting versions and delete markers from ${bucket}`);
            let keyMarker, versionIdMarker;
            while (true) {
              const res = await s3.send(new ListObjectVersionsCommand({ Bucket: bucket, KeyMarker: keyMarker, VersionIdMarker: versionIdMarker }));
              const objects = (res.Versions || []).concat(res.DeleteMarkers || []).map((item) => ({ Key: item.Key, VersionId: item.VersionId }));
              if (objects.length > 0) {
                await s3.send(new DeleteObjectsCommand({ Bucket: bucket, Delete: { Objects: objects } }));
              }
              if (!res.IsTruncated) break;
              keyMarker = res.NextKeyMarker;
              versionIdMarker = res.NextVersionIdMarker;
            }
          };

          exports.handler = async (event, context) => {
            console.log('Request:', JSON.stringify(event, null, 2));
            try {
              if (event.RequestType === 'Delete') {
                const bucket = event.ResourceProperties.Bucket;
                await deleteObjects(bucket);
                await deleteVersions(bucket);
                console.log(`Bucket ${bucket} emptied successfully`);
              }
            } catch (err) {
              console.error('Error:', err);
              return sendResponse(event, context, response.FAILED, { Error: err.message });
            }
            return sendResponse(event, context, response.SUCCESS, {});
          };

  TfStateBucketCleaner:
    Type: Custom::EmptyS3Bucket
    DependsOn: S3BucketCleanupLogGroup  # Ensures log group deleted AFTER Lambda finishes
    Properties:
      ServiceToken: !GetAtt S3BucketCleanupFunction.Arn
      Bucket: !Ref TfStateBucket

  # ===========================================================================
  # IAM Role for EC2 (SSM + Terraform permissions)
  # ===========================================================================

  InstanceRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub ${Project}-TerraformLabRole
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore      # SSM Session Manager
        - arn:aws:iam::aws:policy/AmazonSSMFullAccess               # SSM Parameter Store (lesson 12)
        - arn:aws:iam::aws:policy/AmazonS3FullAccess                # S3 exercises
        - arn:aws:iam::aws:policy/AmazonVPCFullAccess               # VPC/networking exercises
        - arn:aws:iam::aws:policy/AWSCloudFormationFullAccess       # CFN stack operations (lesson 11)
      Policies:
        - PolicyName: TerraformLearningPermissions
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              # EC2: Describe + Instance lifecycle (lesson 08-layout)
              - Sid: EC2Permissions
                Effect: Allow
                Action:
                  - ec2:Describe*
                  - ec2:CreateTags
                  - ec2:DeleteTags
                  - ec2:RunInstances
                  - ec2:TerminateInstances
                  - ec2:StartInstances
                  - ec2:StopInstances
                  - ec2:ModifyInstanceAttribute
                Resource: '*'
              # IAM: User + Role + InstanceProfile + OIDC (lessons 06, 08, 11)
              - Sid: IAMPermissions
                Effect: Allow
                Action:
                  - iam:CreateUser
                  - iam:DeleteUser
                  - iam:GetUser
                  - iam:ListUsers
                  - iam:TagUser
                  - iam:UntagUser
                  - iam:ListGroupsForUser
                  - iam:CreateRole
                  - iam:DeleteRole
                  - iam:GetRole
                  - iam:TagRole
                  - iam:UntagRole
                  - iam:PassRole
                  - iam:GetRolePolicy
                  - iam:PutRolePolicy
                  - iam:DeleteRolePolicy
                  - iam:ListRolePolicies
                  - iam:AttachRolePolicy
                  - iam:DetachRolePolicy
                  - iam:ListAttachedRolePolicies
                  - iam:CreateInstanceProfile
                  - iam:DeleteInstanceProfile
                  - iam:GetInstanceProfile
                  - iam:TagInstanceProfile
                  - iam:UntagInstanceProfile
                  - iam:AddRoleToInstanceProfile
                  - iam:RemoveRoleFromInstanceProfile
                  - iam:ListInstanceProfilesForRole
                  - iam:CreateOpenIDConnectProvider
                  - iam:DeleteOpenIDConnectProvider
                  - iam:GetOpenIDConnectProvider
                  - iam:ListOpenIDConnectProviders
                  - iam:TagOpenIDConnectProvider
                  - iam:UntagOpenIDConnectProvider
                  - sts:GetCallerIdentity
                Resource: '*'
              # RDS: Subnet groups only (lesson 08-layout)
              - Sid: RDSPermissions
                Effect: Allow
                Action:
                  - rds:CreateDBSubnetGroup
                  - rds:DeleteDBSubnetGroup
                  - rds:DescribeDBSubnetGroups
                  - rds:ModifyDBSubnetGroup
                  - rds:AddTagsToResource
                  - rds:RemoveTagsFromResource
                  - rds:ListTagsForResource
                Resource: '*'

  InstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Roles:
        - !Ref InstanceRole

  # ===========================================================================
  # EC2 Instance
  # ===========================================================================

  Instance:
    Type: AWS::EC2::Instance
    Properties:
      ImageId: !Sub '{{resolve:ssm:/aws/service/ami-amazon-linux-latest/al2023-ami-kernel-default-x86_64}}'
      InstanceType: !Ref InstanceType
      IamInstanceProfile: !Ref InstanceProfile
      SubnetId: !Ref PublicSubnet
      SecurityGroupIds:
        - !Ref SecurityGroup
      Tags:
        - Key: Name
          Value: terraform-dev
        - Key: Project
          Value: !Ref Project
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          set -ex

          # Update system
          dnf update -y

          # Install required packages
          dnf install -y git jq unzip python3-pip

          # Install Terraform
          dnf install -y yum-utils
          yum-config-manager --add-repo https://rpm.releases.hashicorp.com/AmazonLinux/hashicorp.repo
          dnf install -y terraform

          # Install terraform-docs (for lesson 07-modules)
          curl -Lo ./terraform-docs.tar.gz https://github.com/terraform-docs/terraform-docs/releases/download/v0.21.0/terraform-docs-v0.21.0-linux-amd64.tar.gz
          tar -xzf terraform-docs.tar.gz
          chmod +x terraform-docs
          mv terraform-docs /usr/local/bin/
          rm terraform-docs.tar.gz

          # Install Trivy security scanner (for lesson 12-security)
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin

          # Install tflint (Terraform Linter - for lesson 13-testing)
          curl -s https://raw.githubusercontent.com/terraform-linters/tflint/master/install_linux.sh | bash

          # Install pre-commit (Git hooks framework - for lesson 13-testing)
          pip3 install pre-commit

          # Install OPA (Open Policy Agent - for lesson 13-testing)
          curl -L -o /usr/local/bin/opa https://openpolicyagent.org/downloads/latest/opa_linux_amd64_static
          chmod +x /usr/local/bin/opa

          # Verify installations
          terraform version
          terraform-docs --version
          trivy --version
          tflint --version
          pre-commit --version
          opa version
          aws --version
          git --version

          # Set hostname
          hostnamectl set-hostname terraform-dev

          # ===========================================================================
          # Create dedicated course user: terraform
          # ===========================================================================
          useradd -m -s /bin/bash terraform

          # Set up SSH directory for VS Code Remote
          mkdir -p /home/terraform/.ssh
          chmod 700 /home/terraform/.ssh
          touch /home/terraform/.ssh/authorized_keys
          chmod 600 /home/terraform/.ssh/authorized_keys
          chown -R terraform:terraform /home/terraform/.ssh

          # ===========================================================================
          # Install sync-course script
          # ===========================================================================
          cat > /usr/local/bin/sync-course << 'SYNCEOF'
          #!/bin/bash
          # sync-course - Synchronize course repository
          # Handles first-time clone and subsequent updates with conflict resolution

          REPO_DIR=~/cloud-atlas
          REPO_URL=https://github.com/shiicho/cloud-atlas

          echo "ðŸ”„ Syncing course repository..."

          if [ ! -d "$REPO_DIR" ]; then
              # First time: sparse clone
              echo "ðŸ“¥ First time setup - cloning repository..."
              git clone --filter=blob:none --sparse $REPO_URL $REPO_DIR
              cd $REPO_DIR && git sparse-checkout set iac/terraform
              echo "âœ… Course repository cloned!"
          else
              cd $REPO_DIR

              # Check for uncommitted changes
              if [ -n "$(git status --porcelain)" ]; then
                  echo "âš ï¸  Local changes detected..."
              fi

              # Try fast-forward pull (no conflicts)
              if git pull --ff-only 2>/dev/null; then
                  echo "âœ… Course repository updated!"
              else
                  # Conflicts detected - backup and force update
                  echo "âš ï¸  Conflicts detected. Backing up your changes..."
                  BACKUP_DIR=~/cloud-atlas-backup-$(date +%Y%m%d-%H%M%S)
                  cp -r $REPO_DIR $BACKUP_DIR
                  echo "ðŸ“ Backup created: $BACKUP_DIR"

                  # Force update
                  git fetch origin
                  git reset --hard origin/main

                  # Re-apply sparse checkout
                  git sparse-checkout set iac/terraform

                  echo "âœ… Course repository force-updated!"
                  echo "ðŸ“ Your previous work is in: $BACKUP_DIR"
              fi
          fi

          echo ""
          echo "ðŸ“‚ Course directory: $REPO_DIR/iac/terraform"
          SYNCEOF
          chmod +x /usr/local/bin/sync-course

          # ===========================================================================
          # Configure terraform user environment
          # ===========================================================================
          cat >> /home/terraform/.bashrc << 'EOF'

          # Terraform aliases
          alias tf='terraform'
          alias tfi='terraform init'
          alias tfp='terraform plan'
          alias tfa='terraform apply'
          alias tfd='terraform destroy'
          alias tfo='terraform output'
          alias tfs='terraform state'

          # Prompt with current directory
          export PS1='[terraform@\h:\w]\$ '

          # Editor
          export EDITOR=vim

          # Auto-sync course on login (optional - just shows reminder)
          echo ""
          echo "ðŸ’¡ Run 'sync-course' to update course materials"
          echo ""
          EOF

          chown terraform:terraform /home/terraform/.bashrc

          # ===========================================================================
          # Initial course setup for terraform user
          # ===========================================================================
          su - terraform -c "sync-course"

          # ===========================================================================
          # Create welcome message
          # ===========================================================================
          cat > /etc/motd << 'EOF'

          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘           Terraform Learning Lab Environment                  â•‘
          â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
          â•‘                                                               â•‘
          â•‘  ðŸ‘¤ Course User: terraform                                    â•‘
          â•‘                                                               â•‘
          â•‘  ðŸš€ Quick Start:                                              â•‘
          â•‘     sudo su - terraform                                       â•‘
          â•‘     sync-course                                               â•‘
          â•‘     cd ~/cloud-atlas/iac/terraform/01-first-resource/code     â•‘
          â•‘                                                               â•‘
          â•‘  ðŸ“ Aliases: tf, tfi, tfp, tfa, tfd, tfo, tfs                 â•‘
          â•‘                                                               â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

          EOF

          # Signal completion
          echo "UserData script completed successfully" > /var/log/userdata-complete.log

Outputs:
  InstanceId:
    Description: EC2 Instance ID (use this for VS Code SSH config)
    Value: !Ref Instance

  InstancePrivateIp:
    Description: Private IP address of the instance
    Value: !GetAtt Instance.PrivateIp

  VpcId:
    Description: VPC ID
    Value: !Ref VPC

  SubnetId:
    Description: Subnet ID
    Value: !Ref PublicSubnet

  SSMConnectCommand:
    Description: Command to connect via SSM
    Value: !Sub 'aws ssm start-session --target ${Instance} --region ${AWS::Region}'

  VSCodeSSHConfig:
    Description: SSH config for VS Code Remote (use terraform user)
    Value: !Sub |
      Host terraform-lab
        HostName ${Instance}
        User terraform
        ProxyCommand aws ssm start-session --target %h --document-name AWS-StartSSHSession --parameters 'portNumber=%p' --region ${AWS::Region}

  CourseUser:
    Description: Dedicated course user (switch to this user after connecting)
    Value: terraform

  TfStateBucketName:
    Description: S3 bucket for Terraform remote state (use with use_lockfile=true)
    Value: !Ref TfStateBucket

  TfBackendConfig:
    Description: Backend configuration for your Terraform projects
    Value: !Sub |
      terraform {
        backend "s3" {
          bucket       = "${TfStateBucket}"
          key          = "your-project/terraform.tfstate"
          region       = "${AWS::Region}"
          encrypt      = true
          use_lockfile = true
        }
      }
