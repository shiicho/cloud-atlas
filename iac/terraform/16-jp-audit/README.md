# 16 - æ—¥æœ¬ ITï¼šç›£æŸ»å¯¾å¿œã¨ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

> **ç›®æ¨™**ï¼šæŒæ¡æ—¥æœ¬ IT ä¼æ¥­ã«ãŠã‘ã‚‹ç›£æŸ»å¯¾å¿œã®å®Ÿè·µæ–¹æ³•ï¼ŒåŒ…æ‹¬è¨¼è·¡åé›†ã€è¨­è¨ˆæ›¸ä½œæˆã€éšœå®³å¾©æ—§æ‰‹é †
> **å‰ç½®**ï¼šå·²å®Œæˆ [15 - æ—¥æœ¬ ITï¼šå¤‰æ›´ç®¡ç†ã¨æ‰¿èªãƒ•ãƒ­ãƒ¼](../15-jp-change-mgmt/)
> **æ™‚é–“**ï¼š60-90 åˆ†
> **è²»ç”¨**ï¼šS3 + CloudTrailï¼ˆæ¥µä½æˆæœ¬ï¼‰ï¼ŒKMSï¼ˆå…è²»å±¤å†…ï¼‰

---

## å°†å­¦åˆ°çš„å†…å®¹

1. **ç›£æŸ»è¨¼è·¡ï¼ˆAudit Trailï¼‰** - S3 versioningã€ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°ã€CloudTrail è¨˜éŒ²
2. **è¨­è¨ˆæ›¸ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ** - æ—¥æœ¬ä¼æ¥­æ¨™æº–çš„ãªæ§‹æˆå›³ + ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ä¸€è¦§
3. **ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹å¯¾å¿œ** - ISMS/ISMAP/SOC2 è¦ä»¶ã¸ã®å¯¾å¿œ
4. **éšœå®³å¾©æ—§æ‰‹é †** - State ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ»ãƒªã‚¹ãƒˆã‚¢ãƒ»ãƒ­ãƒƒã‚¯è§£é™¤

---

## å…ˆè·‘èµ·æ¥ï¼š5 åˆ†é’Ÿæ­å»ºç›£æŸ»ãƒ­ã‚°åŸºç›¤

> å…ˆä½“éªŒç›‘æŸ»ãƒ­ã‚°æ”¶é›†ç³»ç»Ÿï¼Œå†ç†è§£ä¸ºä»€ä¹ˆéœ€è¦è¿™äº›ã€‚

### å¿«é€Ÿä½“éªŒæ­¥éª¤

```bash
# 1. å…‹éš†ç¤ºä¾‹ä»£ç ï¼ˆå¦‚æœå°šæœªå…‹éš†ï¼‰
# GitHubï¼ˆæµ·å¤–ç”¨æˆ·ï¼‰
git clone --filter=blob:none --sparse https://github.com/shiicho/cloud-atlas ~/cloud-atlas
cd ~/cloud-atlas && git sparse-checkout set iac/terraform

# Giteeï¼ˆä¸­å›½å¤§é™†ç”¨æˆ·ï¼‰
git clone --filter=blob:none --sparse https://gitee.com/shiicho/cloud-atlas ~/cloud-atlas
cd ~/cloud-atlas && git sparse-checkout set iac/terraform

# 2. è¿›å…¥ç¤ºä¾‹ç›®å½•
cd ~/cloud-atlas/iac/terraform/16-jp-audit/code/audit-logging-setup
```

æŸ¥çœ‹æ–‡ä»¶ç»“æ„ï¼š

```
code/
â”œâ”€â”€ audit-logging-setup/     # ç›£æŸ»ãƒ­ã‚°åŸºç›¤ Terraform
â”‚   â”œâ”€â”€ main.tf              # S3 + CloudTrail æ§‹æˆ
â”‚   â”œâ”€â”€ variables.tf
â”‚   â”œâ”€â”€ outputs.tf
â”‚   â””â”€â”€ backend.tf
â”œâ”€â”€ templates/               # æ—¥æœ¬ä¼æ¥­å‘ã‘è¨­è¨ˆæ›¸ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
â”‚   â”œâ”€â”€ è¨­è¨ˆæ›¸-template.md
â”‚   â”œâ”€â”€ ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ä¸€è¦§.md
â”‚   â””â”€â”€ éšœå®³å¾©æ—§æ‰‹é †.md
â””â”€â”€ state-recovery/          # State å¾©æ—§ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
    â”œâ”€â”€ backup.sh
    â”œâ”€â”€ restore.sh
    â””â”€â”€ unlock.sh
```

### éƒ¨ç½²ç›£æŸ»ãƒ­ã‚°åŸºç›¤

```bash
# åˆæœŸåŒ–
terraform init

# ç¢ºèªï¼ˆdry-runï¼‰
terraform plan

# é©ç”¨
terraform apply
```

**è¾“å‡ºç¤ºä¾‹**ï¼š

```
Apply complete! Resources: 6 added, 0 changed, 0 destroyed.

Outputs:

state_bucket_arn = "arn:aws:s3:::tfstate-myproject-abc123"
cloudtrail_arn = "arn:aws:cloudtrail:ap-northeast-1:123456789012:trail/terraform-audit-trail"
log_bucket_arn = "arn:aws:s3:::tfstate-logs-myproject-abc123"
```

**æ­å–œï¼ä½ å·²ç»æ­å»ºäº†ç¬¦åˆæ—¥æœ¬ IT ç›‘æŸ»è¦æ±‚çš„ Terraform åŸºç›¤ã€‚**

---

## å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿç›£æŸ»å¯¾å¿œçš„å…¨å±€å›¾

### Terraform ç›£æŸ»ãƒ­ã‚°ã®å…¨ä½“åƒ

![Terraform Audit Log Architecture](images/terraform-audit-architecture.png)

<details>
<summary>View ASCII source</summary>

```
              Terraform Audit Log Architecture

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                        CI/CD Pipeline                           â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
  â”‚  â”‚   PR Plan   â”‚â”€â”€â”€â–¶â”‚   Approve   â”‚â”€â”€â”€â–¶â”‚   Apply     â”‚          â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜          â”‚
  â”‚         â”‚                  â”‚                  â”‚                 â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                  â”‚                  â”‚
            â–¼                  â–¼                  â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚   GitHub Logs   â”‚  â”‚   Git History   â”‚  â”‚   CloudTrail    â”‚
  â”‚   (plan output) â”‚  â”‚   (approvers)   â”‚  â”‚   (API calls)   â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                    â”‚                    â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚    S3 State Bucket    â”‚
                    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
                    â”‚  â”‚  Versioning âœ“   â”‚  â”‚
                    â”‚  â”‚  Access Logs âœ“  â”‚  â”‚
                    â”‚  â”‚  Encryption âœ“   â”‚  â”‚
                    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   ç›£æŸ»è¨¼è·¡ï¼ˆEvidenceï¼‰  â”‚
                    â”‚   - å¤‰æ›´å±¥æ­´           â”‚
                    â”‚   - ã‚¢ã‚¯ã‚»ã‚¹è¨˜éŒ²        â”‚
                    â”‚   - API æ“ä½œè¨˜éŒ²        â”‚
                    â”‚   - æ‰¿èªãƒ•ãƒ­ãƒ¼          â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

</details>

### ç›£æŸ»è¦ä»¶ã¨ Terraform å¯¾å¿œ

| ç›£æŸ»è¦ä»¶ | Terraform ã§ã®å¯¾å¿œ | è¨¼è·¡ï¼ˆã‚¨ãƒ“ãƒ‡ãƒ³ã‚¹ï¼‰ |
|---------|-------------------|------------------|
| **å¤‰æ›´å±¥æ­´** | S3 Versioning | State ã®å…¨ãƒãƒ¼ã‚¸ãƒ§ãƒ³ |
| **ã‚¢ã‚¯ã‚»ã‚¹è¨˜éŒ²** | S3 Access Logs | èª°ãŒã„ã¤ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸã‹ |
| **API æ“ä½œè¨˜éŒ²** | CloudTrail | apply æ™‚ã® AWS API å‘¼ã³å‡ºã— |
| **æ‰¿èªãƒ•ãƒ­ãƒ¼** | GitHub PR + CODEOWNERS | ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ»æ‰¿èªã®è¨˜éŒ² |
| **æ§‹æˆç®¡ç†** | Git + Terraform ã‚³ãƒ¼ãƒ‰ | Infrastructure as Code |

---

## æ ¸å¿ƒæ¦‚å¿µ

### 1. S3 Versioning for Stateï¼ˆå¤‰æ›´å±¥æ­´ä¿æŒï¼‰

![S3 Versioning for Terraform State](images/s3-versioning-state.png)

<details>
<summary>View ASCII source</summary>

```
           S3 Versioning for Terraform State

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                    S3 State Bucket                          â”‚
  â”‚                                                             â”‚
  â”‚  terraform.tfstate                                          â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
  â”‚  â”‚                                                     â”‚    â”‚
  â”‚  â”‚  Version 1 (2025-01-10)  â† åˆæœŸæ§‹ç¯‰                 â”‚    â”‚
  â”‚  â”‚    â”‚                                                â”‚    â”‚
  â”‚  â”‚    â–¼                                                â”‚    â”‚
  â”‚  â”‚  Version 2 (2025-01-12)  â† EC2 è¿½åŠ                  â”‚    â”‚
  â”‚  â”‚    â”‚                                                â”‚    â”‚
  â”‚  â”‚    â–¼                                                â”‚    â”‚
  â”‚  â”‚  Version 3 (2025-01-15)  â† RDS è¨­å®šå¤‰æ›´            â”‚    â”‚
  â”‚  â”‚    â”‚                                                â”‚    â”‚
  â”‚  â”‚    â–¼                                                â”‚    â”‚
  â”‚  â”‚  Version 4 (Current)     â† æœ€æ–°                    â”‚    â”‚
  â”‚  â”‚                                                     â”‚    â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
  â”‚                                                             â”‚
  â”‚  âœ“ å…¨ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’è‡ªå‹•ä¿æŒ                                   â”‚
  â”‚  âœ“ ä»»æ„ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«ãƒªã‚¹ãƒˆã‚¢å¯èƒ½                            â”‚
  â”‚  âœ“ ç›£æŸ»è¦ä»¶ã‚’æº€ãŸã™å¤‰æ›´å±¥æ­´                                  â”‚
  â”‚                                                             â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

</details>

**Terraform ã‚³ãƒ¼ãƒ‰ï¼ˆVersioning æœ‰åŠ¹åŒ–ï¼‰**ï¼š

```hcl
# State ãƒã‚±ãƒƒãƒˆã®ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°è¨­å®š
resource "aws_s3_bucket_versioning" "tfstate" {
  bucket = aws_s3_bucket.tfstate.id

  versioning_configuration {
    status = "Enabled"  # å¿…é ˆï¼šå…¨å¤‰æ›´å±¥æ­´ã‚’ä¿æŒ
  }
}

# ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ãƒ«ãƒ¼ãƒ«ï¼ˆå¤ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’è‡ªå‹•å‰Šé™¤ï¼‰
resource "aws_s3_bucket_lifecycle_configuration" "tfstate" {
  bucket = aws_s3_bucket.tfstate.id

  rule {
    id     = "expire-old-versions"
    status = "Enabled"

    noncurrent_version_expiration {
      noncurrent_days = 365  # 1å¹´é–“ä¿æŒï¼ˆç›£æŸ»è¦ä»¶ã«å¿œã˜ã¦èª¿æ•´ï¼‰
    }
  }
}
```

### 2. S3 Access Logsï¼ˆã‚¢ã‚¯ã‚»ã‚¹è¨˜éŒ²ï¼‰

S3 Access Logs ã¯ã€Œèª°ãŒã€ã„ã¤ã€State ãƒ•ã‚¡ã‚¤ãƒ«ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸã‹ã€ã‚’è¨˜éŒ²ã—ã¾ã™ã€‚

![S3 Access Logs Flow](images/s3-access-logs.png)

<details>
<summary>View ASCII source</summary>

```
                  S3 Access Logs Flow

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                             â”‚
  â”‚   CI/CD          Developer       Admin                      â”‚
  â”‚     â”‚               â”‚              â”‚                        â”‚
  â”‚     â”‚ terraform     â”‚ aws s3       â”‚ aws s3api              â”‚
  â”‚     â”‚ apply         â”‚ cp           â”‚ get-object             â”‚
  â”‚     â–¼               â–¼              â–¼                        â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
  â”‚  â”‚                S3 State Bucket                       â”‚   â”‚
  â”‚  â”‚               (terraform.tfstate)                    â”‚   â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
  â”‚                          â”‚                                  â”‚
  â”‚                          â”‚ Access Logs                      â”‚
  â”‚                          â–¼                                  â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
  â”‚  â”‚              S3 Access Logs Bucket                   â”‚   â”‚
  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
  â”‚  â”‚  â”‚ Timestamp: 2025-01-15T10:00:00Z               â”‚  â”‚   â”‚
  â”‚  â”‚  â”‚ Requester: arn:aws:iam::123456789:role/CI     â”‚  â”‚   â”‚
  â”‚  â”‚  â”‚ Operation: REST.GET.OBJECT                     â”‚  â”‚   â”‚
  â”‚  â”‚  â”‚ Key: prod/terraform.tfstate                    â”‚  â”‚   â”‚
  â”‚  â”‚  â”‚ HTTP Status: 200                               â”‚  â”‚   â”‚
  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
  â”‚                                                             â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

</details>

**Terraform ã‚³ãƒ¼ãƒ‰ï¼ˆAccess Logs æœ‰åŠ¹åŒ–ï¼‰**ï¼š

```hcl
# ãƒ­ã‚°ä¿å­˜ç”¨ãƒã‚±ãƒƒãƒˆ
resource "aws_s3_bucket" "logs" {
  bucket = "${var.project}-tfstate-logs-${random_id.suffix.hex}"
}

# State ãƒã‚±ãƒƒãƒˆã®ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°è¨­å®š
resource "aws_s3_bucket_logging" "tfstate" {
  bucket = aws_s3_bucket.tfstate.id

  target_bucket = aws_s3_bucket.logs.id
  target_prefix = "access-logs/"
}
```

### 3. CloudTrailï¼ˆAWS API å‘¼ã³å‡ºã—è¨˜éŒ²ï¼‰

CloudTrail ã¯ `terraform apply` æ™‚ã®å…¨ AWS API å‘¼ã³å‡ºã—ã‚’è¨˜éŒ²ã—ã¾ã™ã€‚

```hcl
# CloudTrail è¨­å®š
resource "aws_cloudtrail" "terraform" {
  name                          = "terraform-audit-trail"
  s3_bucket_name                = aws_s3_bucket.cloudtrail.id
  include_global_service_events = true
  is_multi_region_trail         = true
  enable_log_file_validation    = true  # ãƒ­ã‚°æ”¹ç«„æ¤œçŸ¥

  event_selector {
    read_write_type           = "All"
    include_management_events = true
  }
}
```

**CloudTrail ãƒ­ã‚°ä¾‹**ï¼š

```json
{
  "eventTime": "2025-01-15T10:00:00Z",
  "eventSource": "ec2.amazonaws.com",
  "eventName": "RunInstances",
  "userIdentity": {
    "arn": "arn:aws:iam::123456789012:role/TerraformApplyRole"
  },
  "sourceIPAddress": "1.2.3.4",
  "requestParameters": {
    "instanceType": "t3.micro",
    "imageId": "ami-0abcdef1234567890"
  }
}
```

---

## æ ¸å¿ƒæ¦‚å¿µï¼šæ—¥æœ¬ä¼æ¥­ã®è¨­è¨ˆæ›¸æ–‡åŒ–

### è¨­è¨ˆæ›¸ï¼ˆDesign Documentï¼‰ã®ä½ç½®ã¥ã‘

æ—¥æœ¬ IT ä¼æ¥­ã§ã¯ã€è¨­è¨ˆæ›¸ï¼ˆã›ã£ã‘ã„ã—ã‚‡ï¼‰ã¯éå¸¸ã«é‡è¦–ã•ã‚Œã¾ã™ã€‚

![Design Document Culture in Japan IT](images/design-doc-culture.png)

<details>
<summary>View ASCII source</summary>

```
        Design Document Culture in Japan IT (è¨­è¨ˆæ›¸æ–‡åŒ–)

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                   Traditional Approach                      â”‚
  â”‚                                                             â”‚
  â”‚  è¨­è¨ˆæ›¸ (Word/Excel)      ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ä¸€è¦§ (Excel)             â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
  â”‚  â”‚ â–  åŸºæœ¬æƒ…å ±       â”‚     â”‚ ãƒªã‚½ãƒ¼ã‚¹â”‚ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿â”‚              â”‚
  â”‚  â”‚ â–  æ§‹æˆå›³         â”‚     â”‚ EC2    â”‚t3.micro â”‚              â”‚
  â”‚  â”‚ â–  ãƒªã‚½ãƒ¼ã‚¹ä¸€è¦§   â”‚     â”‚ RDS    â”‚db.t3    â”‚              â”‚
  â”‚  â”‚ â–  ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£   â”‚     â”‚ ...    â”‚...      â”‚              â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
  â”‚        âš ï¸ æ‰‹å‹•æ›´æ–°ã€ä¹–é›¢ãƒªã‚¹ã‚¯                               â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                   IaC + Auto-Generation                      â”‚
  â”‚                                                             â”‚
  â”‚  Terraform Code           terraform-docs                    â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
  â”‚  â”‚ variables.tf    â”‚â”€â”€â”€â”€â–¶â”‚ README.md       â”‚                â”‚
  â”‚  â”‚ main.tf         â”‚     â”‚ (è‡ªå‹•ç”Ÿæˆ)       â”‚                â”‚
  â”‚  â”‚ outputs.tf      â”‚     â”‚ - Inputs        â”‚                â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚ - Outputs       â”‚                â”‚
  â”‚                          â”‚ - Resources     â”‚                â”‚
  â”‚                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
  â”‚        âœ“ ã‚³ãƒ¼ãƒ‰ã¨å¸¸ã«åŒæœŸã€ä¹–é›¢ãªã—                          â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

</details>

### ISMS / ISMAP / SOC2 å¯¾å¿œ

æ—¥æœ¬ä¼æ¥­ã§æ±‚ã‚ã‚‰ã‚Œã‚‹ä¸»è¦ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£èªè¨¼ï¼š

| èªè¨¼ | æ­£å¼åç§° | å¯¾è±¡ | Terraform ã§ã®å¯¾å¿œ |
|-----|---------|------|-------------------|
| **ISMS** | æƒ…å ±ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆã‚·ã‚¹ãƒ†ãƒ  | æ—¥æœ¬ä¼æ¥­å…¨èˆ¬ | ãƒ­ã‚°ä¿æŒã€ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã€æš—å·åŒ– |
| **ISMAP** | æ”¿åºœæƒ…å ±ã‚·ã‚¹ãƒ†ãƒ ã®ãŸã‚ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è©•ä¾¡åˆ¶åº¦ | æ”¿åºœç³»ãƒ»æº–å…¬å…± | CloudTrailå¿…é ˆã€90æ—¥ä»¥ä¸Šãƒ­ã‚°ä¿æŒ |
| **SOC2** | Service Organization Control 2 | SaaSã€ã‚¯ãƒ©ã‚¦ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹ | å¤‰æ›´ç®¡ç†ã€ç›£æŸ»è¨¼è·¡ã€å¯ç”¨æ€§ |

**ISMAP è¦ä»¶ã® Terraform å¯¾å¿œä¾‹**ï¼š

```hcl
# ISMAP è¦ä»¶: 90æ—¥ä»¥ä¸Šã®ãƒ­ã‚°ä¿æŒ
resource "aws_s3_bucket_lifecycle_configuration" "cloudtrail_logs" {
  bucket = aws_s3_bucket.cloudtrail.id

  rule {
    id     = "ismap-log-retention"
    status = "Enabled"

    transition {
      days          = 90
      storage_class = "GLACIER"  # 90æ—¥å¾Œã¯ Glacier ã«ç§»è¡Œ
    }

    expiration {
      days = 2555  # 7å¹´é–“ä¿æŒï¼ˆä¸€éƒ¨è¦ä»¶ï¼‰
    }
  }
}

# ISMAP è¦ä»¶: ãƒ­ã‚°æ”¹ç«„é˜²æ­¢ï¼ˆObject Lockï¼‰
resource "aws_s3_bucket_object_lock_configuration" "cloudtrail" {
  bucket = aws_s3_bucket.cloudtrail.id

  rule {
    default_retention {
      mode = "GOVERNANCE"
      days = 90
    }
  }
}
```

---

## å‹•æ‰‹ç·´ç¿’ï¼šè¨­è¨ˆæ›¸ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä½œæˆ

### Step 1ï¼šæ§‹æˆå›³ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ç¢ºèª

```bash
cat ~/cloud-atlas/iac/terraform/16-jp-audit/code/templates/è¨­è¨ˆæ›¸-template.md
```

**è¨­è¨ˆæ›¸ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ**ï¼ˆcode/templates/ ã«å®Œå…¨ç‰ˆã‚ã‚Šï¼‰:

```markdown
# ã‚¤ãƒ³ãƒ•ãƒ©æ§‹æˆè¨­è¨ˆæ›¸

## 1. åŸºæœ¬æƒ…å ±
| é …ç›® | å†…å®¹ |
|------|------|
| ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå | myproject |
| ç’°å¢ƒ | production / staging / development |
| ä½œæˆæ—¥ | 2025-01-15 |
| ä½œæˆè€… | ã‚¤ãƒ³ãƒ•ãƒ©ãƒãƒ¼ãƒ  |
| æ‰¿èªè€… | ã€‡ã€‡èª²é•· |

## 2. ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆå›³
[ã“ã“ã«æ§‹æˆå›³ã‚’æŒ¿å…¥]

## 3. ãƒªã‚½ãƒ¼ã‚¹ä¸€è¦§
terraform-docs ã§è‡ªå‹•ç”Ÿæˆå¯èƒ½

## 4. ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ä¸€è¦§
åˆ¥ç´™ã€Œãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ä¸€è¦§.mdã€å‚ç…§

## 5. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­è¨ˆ
...
```

### Step 2ï¼šterraform-docs ã§è‡ªå‹•ç”Ÿæˆ

```bash
# terraform-docs ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
brew install terraform-docs

# ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆç”Ÿæˆ
cd ~/cloud-atlas/iac/terraform/16-jp-audit/code/audit-logging-setup
terraform-docs markdown . > README.md

# ç”Ÿæˆçµæœã‚’ç¢ºèª
cat README.md
```

**å‡ºåŠ›ä¾‹**ï¼š

```markdown
## Requirements

| Name | Version |
|------|---------|
| terraform | >= 1.0 |
| aws | ~> 5.0 |

## Providers

| Name | Version |
|------|---------|
| aws | ~> 5.0 |

## Resources

| Name | Type |
|------|------|
| aws_s3_bucket.tfstate | resource |
| aws_s3_bucket_versioning.tfstate | resource |
...
```

---

## å‹•æ‰‹ç·´ç¿’ï¼šéšœå®³å¾©æ—§æ¼”ç¿’

### ã‚·ãƒŠãƒªã‚ªï¼šState ãƒ•ã‚¡ã‚¤ãƒ«ç ´æã‹ã‚‰ã®å¾©æ—§

æ—¥æœ¬ IT ç¾å ´ã§æœ€ã‚‚æã‚Œã‚‰ã‚Œã‚‹éšœå®³ã‚·ãƒŠãƒªã‚ªã®ä¸€ã¤ã§ã™ã€‚

![State Disaster Recovery Flow](images/state-recovery-flow.png)

<details>
<summary>View ASCII source</summary>

```
           State Disaster Recovery Flow (éšœå®³å¾©æ—§ãƒ•ãƒ­ãƒ¼)

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                    éšœå®³ç™ºç”Ÿ (Incident)                       â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚ âš ï¸ State ãƒ•ã‚¡ã‚¤ãƒ«ç ´æ                                  â”‚  â”‚
  â”‚  â”‚ âš ï¸ terraform plan ã§äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼                   â”‚  â”‚
  â”‚  â”‚ âš ï¸ Lock ãŒè§£é™¤ã§ããªã„                                 â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                   Step 1: å½±éŸ¿ç¯„å›²ç¢ºèª                       â”‚
  â”‚  $ terraform state list                                     â”‚
  â”‚  $ aws s3api list-object-versions --bucket tfstate-bucket   â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                   Step 2: æ­£å¸¸ãª Version ã‚’ç‰¹å®š              â”‚
  â”‚  $ aws s3api get-object --version-id GOOD_VERSION           â”‚
  â”‚      --bucket tfstate-bucket state-backup.json              â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                   Step 3: Lock è§£é™¤ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰          â”‚
  â”‚  $ terraform force-unlock LOCK_ID                           â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                   Step 4: ãƒªã‚¹ãƒˆã‚¢ + ç¢ºèª                    â”‚
  â”‚  $ aws s3 cp state-backup.json s3://bucket/terraform.tfstateâ”‚
  â”‚  $ terraform plan  # å·®åˆ†ãªã—ã‚’ç¢ºèª                          â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                   Step 5: ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆãƒ¬ãƒãƒ¼ãƒˆä½œæˆ            â”‚
  â”‚  - ç™ºç”Ÿæ—¥æ™‚ã€å½±éŸ¿ç¯„å›²ã€åŸå› ã€å¯¾å¿œå†…å®¹ã€å†ç™ºé˜²æ­¢ç­–            â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

</details>

### å¾©æ—§ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œï¼ˆæ¼”ç¿’ï¼‰

```bash
# 1. ã¾ãšç¾åœ¨ã® State ã‚’ç¢ºèª
terraform state list

# 2. ãƒãƒ¼ã‚¸ãƒ§ãƒ³ä¸€è¦§ã‚’ç¢ºèª
aws s3api list-object-versions \
  --bucket your-tfstate-bucket \
  --prefix path/to/terraform.tfstate \
  --query 'Versions[*].{VersionId:VersionId,LastModified:LastModified,Size:Size}' \
  --output table

# 3. ç‰¹å®šã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ç¢ºèª
aws s3api get-object \
  --bucket your-tfstate-bucket \
  --key path/to/terraform.tfstate \
  --version-id VERSION_ID_HERE \
  state-backup.json

# 4. å†…å®¹ã‚’ç¢ºèª
cat state-backup.json | jq '.resources | length'
```

### State Lock è§£é™¤ï¼ˆç·Šæ€¥æ™‚ï¼‰

```bash
# DynamoDB ã®ãƒ­ãƒƒã‚¯ã‚’ç¢ºèª
aws dynamodb scan \
  --table-name terraform-locks \
  --query 'Items[*].{LockID:LockID.S,Info:Info.S}'

# ãƒ­ãƒƒã‚¯è§£é™¤ï¼ˆå¼·åˆ¶ï¼‰
terraform force-unlock LOCK_ID_HERE

# ã¾ãŸã¯ DynamoDB ã‹ã‚‰ç›´æ¥å‰Šé™¤
aws dynamodb delete-item \
  --table-name terraform-locks \
  --key '{"LockID":{"S":"your-lock-id"}}'
```

---

## è·å ´å°è²¼å£«ï¼šç›£æŸ»å¯¾å¿œã®å®Ÿè·µ

### ç›£æŸ»å“¡ã‹ã‚‰ã®å…¸å‹çš„ãªè³ªå•ã¨å›ç­”ä¾‹

| ç›£æŸ»å“¡ã®è³ªå• | å›ç­”ä¾‹ | è¨¼è·¡ã®å ´æ‰€ |
|-------------|--------|-----------|
| ã€Œã„ã¤ã€èª°ãŒã€ã“ã® EC2 ã‚’ä½œæˆã—ã¾ã—ãŸã‹ï¼Ÿã€ | ã€Œ2025/01/15 ã« CI/CD ã‹ã‚‰ terraform apply ã‚’å®Ÿè¡Œã—ã¾ã—ãŸã€ | CloudTrail ãƒ­ã‚° |
| ã€Œå¤‰æ›´ã¯æ‰¿èªã•ã‚Œã¦ã„ã¾ã™ã‹ï¼Ÿã€ | ã€ŒGitHub PR ã§èª²é•·æ‰¿èªå¾Œã« apply ã•ã‚Œã¦ã„ã¾ã™ã€ | GitHub PR å±¥æ­´ |
| ã€Œéå»ã®æ§‹æˆã«æˆ»ã›ã¾ã™ã‹ï¼Ÿã€ | ã€ŒS3 Versioning ã§ State å±¥æ­´ã‚’ä¿æŒã—ã¦ã„ã¾ã™ã€ | S3 ãƒãƒ¼ã‚¸ãƒ§ãƒ³ |
| ã€Œè¨­è¨ˆæ›¸ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿã€ | ã€Œterraform-docs ã§è‡ªå‹•ç”Ÿæˆã—ã¦ã„ã¾ã™ã€ | Git ãƒªãƒã‚¸ãƒˆãƒª |

### ISMS å†…éƒ¨ç›£æŸ»ã§ã‚ˆãã‚ã‚‹æŒ‡æ‘˜äº‹é …

```
æŒ‡æ‘˜äº‹é … 1: ãƒ­ã‚°ä¿æŒæœŸé–“ãŒè¦å®šã‚’æº€ãŸã—ã¦ã„ãªã„
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
æ˜¯æ­£: S3 Lifecycle ã§ä¿æŒæœŸé–“ã‚’ 1å¹´â†’3å¹´ã«å»¶é•·

æŒ‡æ‘˜äº‹é … 2: State ã¸ã®ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ãŒè¨˜éŒ²ã•ã‚Œã¦ã„ãªã„
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
æ˜¯æ­£: S3 Access Logging ã‚’æœ‰åŠ¹åŒ–

æŒ‡æ‘˜äº‹é … 3: ç·Šæ€¥å¤‰æ›´æ™‚ã®æ‰‹é †ãŒæ–‡æ›¸åŒ–ã•ã‚Œã¦ã„ãªã„
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
æ˜¯æ­£: éšœå®³å¾©æ—§æ‰‹é †æ›¸ï¼ˆéšœå®³å¾©æ—§æ‰‹é †.mdï¼‰ã‚’æ•´å‚™
```

### æ—¥æœ¬èªé¢æ¥å¯¾ç­–

**Q: Terraform ã®ç›£æŸ»å¯¾å¿œã¯ã©ã†ã—ã¦ã„ã¾ã™ã‹ï¼Ÿ**

A: State ã¯ S3 ã«ä¿å­˜ã—ã€Versioning ã§å¤‰æ›´å±¥æ­´ã‚’ä¿æŒã—ã¦ã„ã¾ã™ã€‚CloudTrail ã§ API ãƒ­ã‚°ã‚’å–å¾—ã—ã€CI/CD ã® plan/apply ãƒ­ã‚°ã‚‚ GitHub Actions ã§ä¿å­˜ã—ã¦ã„ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€Œã„ã¤ã€èª°ãŒã€ä½•ã‚’å¤‰æ›´ã—ãŸã‹ã€ã‚’ã™ã¹ã¦è¿½è·¡å¯èƒ½ã§ã™ã€‚è¨­è¨ˆæ›¸ã¯ terraform-docs ã§è‡ªå‹•ç”Ÿæˆã—ã€Git ã§ç®¡ç†ã—ã¦ã„ã¾ã™ã€‚

**Q: State ãƒ•ã‚¡ã‚¤ãƒ«ãŒç ´æã—ãŸå ´åˆã€ã©ã†å¯¾å¿œã—ã¾ã™ã‹ï¼Ÿ**

A: ã¾ãš S3 Versioning ã‹ã‚‰éå»ã®æ­£å¸¸ãªãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ç‰¹å®šã—ã€ãƒªã‚¹ãƒˆã‚¢ã—ã¾ã™ã€‚DynamoDB ã®ãƒ­ãƒƒã‚¯ãŒæ®‹ã£ã¦ã„ã‚‹å ´åˆã¯ force-unlock ã—ã¾ã™ã€‚å¾©æ—§å¾Œã¯ terraform plan ã§æƒ³å®šå¤–ã®å·®åˆ†ãŒãªã„ã‹ç¢ºèªã—ã€ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆãƒ¬ãƒãƒ¼ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚

---

## æ¤œæŸ»æ¸…å•

å®Œæˆä»¥ä¸‹æ£€æŸ¥é¡¹ï¼Œç¡®è®¤ä½ å·²æŒæ¡æœ¬è¯¾å†…å®¹ï¼š

- [ ] S3 Versioning ã§ State ã®å¤‰æ›´å±¥æ­´ã‚’ä¿æŒã§ãã‚‹
- [ ] S3 Access Logs ã§ State ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨˜éŒ²ã§ãã‚‹
- [ ] CloudTrail ã§ terraform apply ã® API å‘¼ã³å‡ºã—ã‚’è¿½è·¡ã§ãã‚‹
- [ ] è¨­è¨ˆæ›¸ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®æ§‹æˆã‚’ç†è§£ã—ã¦ã„ã‚‹
- [ ] terraform-docs ã§ README ã‚’è‡ªå‹•ç”Ÿæˆã§ãã‚‹
- [ ] ISMS/ISMAP/SOC2 ã®åŸºæœ¬è¦ä»¶ã‚’ç†è§£ã—ã¦ã„ã‚‹
- [ ] State éšœå®³æ™‚ã®å¾©æ—§æ‰‹é †ã‚’å®Ÿè¡Œã§ãã‚‹
- [ ] State Lock ã®å¼·åˆ¶è§£é™¤ãŒã§ãã‚‹

---

## é¢è©¦æº–å‚™

**Q: Terraform ã®ç›£æŸ»å¯¾å¿œã¯ã©ã†ã—ã¦ã„ã¾ã™ã‹ï¼Ÿ**

A: State ã¯ S3 versioning ã§å±¥æ­´ä¿æŒã€CloudTrail ã§ API ãƒ­ã‚°ã€plan/apply ãƒ­ã‚°ã¯ CI ã§ä¿å­˜ã€‚ISMS è¦ä»¶ã«å¿œã˜ã¦ãƒ­ã‚°ä¿æŒæœŸé–“ã‚’è¨­å®šã—ã€Object Lock ã§æ”¹ç«„é˜²æ­¢ã‚‚å¯¾å¿œå¯èƒ½ã€‚

**Q: State ãƒ•ã‚¡ã‚¤ãƒ«ãŒç ´æã—ãŸå ´åˆã®å¯¾å¿œæ‰‹é †ã¯ï¼Ÿ**

A: ã¾ãšå½±éŸ¿ç¯„å›²ç¢ºèªã€æ¬¡ã« S3 ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‹ã‚‰æ­£å¸¸ãª State ã‚’ç‰¹å®šã—ãƒªã‚¹ãƒˆã‚¢ã€‚Lock ãŒæ®‹ã£ã¦ã„ã‚Œã° force-unlockã€‚å¾©æ—§å¾Œã¯ plan ã§å·®åˆ†ç¢ºèªã—ã€ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆãƒ¬ãƒãƒ¼ãƒˆä½œæˆã€‚

**Q: è¨­è¨ˆæ›¸ã®ç®¡ç†ã¯ã©ã†ã—ã¦ã„ã¾ã™ã‹ï¼Ÿ**

A: terraform-docs ã§è‡ªå‹•ç”Ÿæˆã—ãŸå†…å®¹ã‚’ Git ç®¡ç†ã€‚ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ä¸€è¦§ã¯ variables.tf ã‹ã‚‰æŠ½å‡ºå¯èƒ½ã€‚æ§‹æˆå›³ã¯ Terraform Graph ã‚„å¤–éƒ¨ãƒ„ãƒ¼ãƒ«ï¼ˆCloudcraft ãªã©ï¼‰ã§ä½œæˆã—ã€è¨­è¨ˆæ›¸ã«æ·»ä»˜ã€‚

**Q: ISMS ç›£æŸ»ã§ Terraform ã«é–¢ã™ã‚‹æŒ‡æ‘˜ã‚’å—ã‘ãŸã“ã¨ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ**

A: ãƒ­ã‚°ä¿æŒæœŸé–“ã®è¨­å®šã€State ã¸ã®ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹è¨˜éŒ²ã€ç·Šæ€¥å¤‰æ›´æ‰‹é †ã®æ–‡æ›¸åŒ–ãªã©ãŒå…¸å‹çš„ãªæŒ‡æ‘˜äº‹é …ã€‚Terraform ã®æ©Ÿèƒ½ã¨ AWS ã‚µãƒ¼ãƒ“ã‚¹ã‚’çµ„ã¿åˆã‚ã›ã¦æ˜¯æ­£å¯¾å¿œã‚’è¡Œã„ã¾ã—ãŸã€‚

---

## ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### State Version ãŒè¦‹ã¤ã‹ã‚‰ãªã„

```
Error: Failed to get object version list
```

**åŸå› **: ãƒã‚±ãƒƒãƒˆã§ Versioning ãŒæœ‰åŠ¹åŒ–ã•ã‚Œã¦ã„ãªã„

**å¯¾ç­–**:
```bash
# Versioning çŠ¶æ…‹ã‚’ç¢ºèª
aws s3api get-bucket-versioning --bucket your-bucket

# æœ‰åŠ¹åŒ–
aws s3api put-bucket-versioning \
  --bucket your-bucket \
  --versioning-configuration Status=Enabled
```

### CloudTrail ãƒ­ã‚°ãŒç©º

```
Error: No log files found in S3 bucket
```

**ç¢ºèªãƒã‚¤ãƒ³ãƒˆ**:
1. CloudTrail ãŒæœ‰åŠ¹åŒ–ã•ã‚Œã¦ã„ã‚‹ã‹
2. S3 ãƒã‚±ãƒƒãƒˆãƒãƒªã‚·ãƒ¼ã§ CloudTrail ã‹ã‚‰ã®æ›¸ãè¾¼ã¿ãŒè¨±å¯ã•ã‚Œã¦ã„ã‚‹ã‹
3. ãƒ­ã‚°é…ä¿¡ã« 15åˆ†ç¨‹åº¦ã®é…å»¶ãŒã‚ã‚‹

### Lock ãŒè§£é™¤ã§ããªã„

```
Error: Error locking state: Error acquiring the state lock
```

**å¯¾ç­–**:
```bash
# Lock ID ã‚’ç¢ºèª
terraform plan 2>&1 | grep "Lock Info"

# å¼·åˆ¶è§£é™¤
terraform force-unlock LOCK_ID

# ãã‚Œã§ã‚‚è§£é™¤ã§ããªã„å ´åˆã¯ DynamoDB ã‚’ç›´æ¥æ“ä½œ
aws dynamodb delete-item \
  --table-name terraform-locks \
  --key '{"LockID":{"S":"your-lock-id"}}'
```

---

## å»¶ä¼¸é˜…è¯»

- [AWS CloudTrail User Guide](https://docs.aws.amazon.com/awscloudtrail/latest/userguide/)
- [S3 Versioning](https://docs.aws.amazon.com/AmazonS3/latest/userguide/Versioning.html)
- [terraform-docs](https://terraform-docs.io/)
- [ISMAP ã‚¯ãƒ©ã‚¦ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹ãƒªã‚¹ãƒˆ](https://www.ismap.go.jp/csm?id=cloud_service_list)
- [15 - æ—¥æœ¬ ITï¼šå¤‰æ›´ç®¡ç†ã¨æ‰¿èªãƒ•ãƒ­ãƒ¼](../15-jp-change-mgmt/) - å‰èª²

---

## æ¸…ç†èµ„æº

> âš ï¸ **æœ¬è¯¾æ¶‰åŠå¤šä¸ª AWS èµ„æº**ï¼Œè¯·åŠ¡å¿…æ¸…ç†ä»¥é¿å…è´¹ç”¨ï¼š

```bash
cd ~/cloud-atlas/iac/terraform/16-jp-audit/code/audit-logging-setup

# 1. æ¸…ç©º S3 Bucket å†…å®¹ï¼ˆå¿…é¡»å…ˆæ¸…ç©ºæ‰èƒ½åˆ é™¤ï¼‰
TFSTATE_BUCKET=$(terraform output -raw state_bucket_name 2>/dev/null || echo "")
LOG_BUCKET=$(terraform output -raw log_bucket_name 2>/dev/null || echo "")

if [ -n "$TFSTATE_BUCKET" ]; then
  aws s3 rm s3://$TFSTATE_BUCKET --recursive
fi

if [ -n "$LOG_BUCKET" ]; then
  aws s3 rm s3://$LOG_BUCKET --recursive
fi

# 2. åˆ é™¤ Terraform ç®¡ç†çš„èµ„æº
terraform destroy -auto-approve

# 3. ç¡®è®¤èµ„æºå·²åˆ é™¤
aws s3 ls | grep tfstate
aws cloudtrail describe-trails --query 'trailList[*].Name'
```

---

## ç³»åˆ—å°èˆª

â† [15 Â· å¤‰æ›´ç®¡ç†](../15-jp-change-mgmt/) | [Home](../) | ğŸ‰ Course Complete!
