# Terraform State 障害復旧手順書

---

## ドキュメント管理情報

| 項目 | 内容 |
|------|------|
| プロジェクト名 | {PROJECT_NAME} |
| 作成日 | YYYY-MM-DD |
| 作成者 | {AUTHOR_NAME} |
| 承認者 | {APPROVER_NAME} |
| 版数 | 1.0 |

---

## 1. 概要

### 1.1 本書の目的

Terraform State ファイルに関する障害が発生した際の復旧手順を定義する。

### 1.2 対象障害

| 障害種別 | 概要 | 重要度 |
|---------|------|--------|
| State 破損 | State ファイルが読み取れない | 高 |
| State 消失 | State ファイルが削除された | 高 |
| Lock 残留 | State Lock が解除されない | 中 |
| State 不整合 | 実際のリソースと State の乖離 | 中 |

### 1.3 関連リソース

| リソース | 値 | 備考 |
|---------|---|------|
| State バケット | {STATE_BUCKET_NAME} | |
| Lock テーブル | {LOCK_TABLE_NAME} | |
| KMS キー | {KMS_KEY_ALIAS} | |
| CloudTrail | {CLOUDTRAIL_NAME} | |

---

## 2. 障害判定フロー

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         障害判定フローチャート                            │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   terraform plan 実行                                                   │
│        │                                                                │
│        ├──── 成功 ───────────────────────────────▶ 正常                │
│        │                                                                │
│        └──── エラー                                                     │
│                │                                                        │
│                ├── "Error acquiring the state lock"                     │
│                │        │                                               │
│                │        └──▶ 「3. Lock 残留の復旧」へ                   │
│                │                                                        │
│                ├── "Failed to load state"                               │
│                │        │                                               │
│                │        └──▶ 「4. State 破損の復旧」へ                  │
│                │                                                        │
│                ├── "state file does not exist"                          │
│                │        │                                               │
│                │        └──▶ 「5. State 消失の復旧」へ                  │
│                │                                                        │
│                └── "planned changes" (想定外の差分)                     │
│                         │                                               │
│                         └──▶ 「6. State 不整合の復旧」へ                │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 3. Lock 残留の復旧

### 3.1 症状

```
Error: Error acquiring the state lock

Error message: ConditionalCheckFailedException: The conditional request failed
Lock Info:
  ID:        12345678-1234-1234-1234-123456789012
  Path:      s3://bucket/path/terraform.tfstate
  Operation: OperationTypeApply
  Who:       user@hostname
  Version:   1.9.0
  Created:   2025-01-15 10:00:00.000000000 +0000 UTC
```

### 3.2 原因

- terraform apply が途中でキャンセルされた
- CI/CD パイプラインがタイムアウトした
- ネットワーク断で Lock 解除が失敗した

### 3.3 復旧手順

#### Step 1: Lock 情報の確認

```bash
# Lock ID を確認（エラーメッセージから取得）
LOCK_ID="12345678-1234-1234-1234-123456789012"

# DynamoDB で確認
aws dynamodb scan \
  --table-name terraform-locks \
  --filter-expression "contains(LockID, :prefix)" \
  --expression-attribute-values '{":prefix":{"S":"terraform.tfstate"}}' \
  --query 'Items[*]'
```

#### Step 2: Lock 解除

```bash
# terraform コマンドで解除（推奨）
terraform force-unlock $LOCK_ID

# terraform コマンドが使えない場合は DynamoDB を直接操作
aws dynamodb delete-item \
  --table-name terraform-locks \
  --key '{"LockID":{"S":"s3://bucket/path/terraform.tfstate-md5"}}'
```

#### Step 3: 動作確認

```bash
terraform plan
```

### 3.4 注意事項

- **必ず他の作業者がいないことを確認してから実行**
- force-unlock は最後の手段。まず作業者に確認

---

## 4. State 破損の復旧

### 4.1 症状

```
Error: Failed to load state: ...
```

または

```
Error: Error loading state: state data in S3 is not valid JSON
```

### 4.2 原因

- apply 中のネットワーク断で State が中途半端に書き込まれた
- S3 への書き込み失敗
- 手動編集による破損

### 4.3 復旧手順

#### Step 1: 影響範囲の確認

```bash
# 環境を確認
echo "対象環境: production / staging / development"

# 最終更新時刻を確認
aws s3api head-object \
  --bucket STATE_BUCKET \
  --key path/to/terraform.tfstate \
  --query 'LastModified'
```

#### Step 2: バージョン一覧の取得

```bash
aws s3api list-object-versions \
  --bucket STATE_BUCKET \
  --prefix path/to/terraform.tfstate \
  --query 'Versions[*].{VersionId:VersionId,LastModified:LastModified,Size:Size}' \
  --output table
```

**出力例**:
```
-------------------------------------------------------------
|                    ListObjectVersions                      |
+--------------------------+-------------------+-------------+
|       LastModified       |       Size        | VersionId   |
+--------------------------+-------------------+-------------+
| 2025-01-15T10:00:00+00:00|       52000       | ABC123...   | ← 破損
| 2025-01-15T09:30:00+00:00|       45000       | DEF456...   | ← 正常（候補）
| 2025-01-14T18:00:00+00:00|       44500       | GHI789...   | ← 正常
+--------------------------+-------------------+-------------+
```

#### Step 3: 正常なバージョンの確認

```bash
# 候補バージョンをダウンロード
VERSION_ID="DEF456..."

aws s3api get-object \
  --bucket STATE_BUCKET \
  --key path/to/terraform.tfstate \
  --version-id $VERSION_ID \
  state-backup.json

# JSON として有効か確認
jq . state-backup.json > /dev/null && echo "Valid JSON"

# リソース数を確認
jq '.resources | length' state-backup.json
```

#### Step 4: リストア

```bash
# 正常なバージョンを最新として復元
aws s3api copy-object \
  --bucket STATE_BUCKET \
  --copy-source "STATE_BUCKET/path/to/terraform.tfstate?versionId=$VERSION_ID" \
  --key path/to/terraform.tfstate
```

#### Step 5: 動作確認

```bash
# plan を実行し、想定外の差分がないか確認
terraform plan

# 差分が発生する場合は Step 6 へ
```

#### Step 6: 差分がある場合の対応

```bash
# 差分の内容を確認
# - リソース追加（+）: リストア後に apply された変更。手動で再 apply
# - リソース削除（-）: リストア後に作成されたリソース。import が必要
# - リソース変更（~）: Drift。内容を確認して apply または ignore
```

### 4.4 注意事項

- リストア前に現在の（破損した）State をバックアップ
- リストア後の plan 差分は必ず確認
- 本番環境では上長の承認を得てから実行

---

## 5. State 消失の復旧

### 5.1 症状

```
Error: state file does not exist
```

または

S3 バケットに State ファイルが存在しない

### 5.2 原因

- 誤って `terraform state rm` で全リソースを削除
- S3 バケットの誤削除
- 悪意のある削除

### 5.3 復旧手順

#### Step 1: S3 バージョン履歴から復元

```bash
# 削除されたオブジェクトを含めて一覧表示
aws s3api list-object-versions \
  --bucket STATE_BUCKET \
  --prefix path/to/terraform.tfstate \
  --query '{Versions:Versions[*].{VersionId:VersionId,LastModified:LastModified},DeleteMarkers:DeleteMarkers[*].{VersionId:VersionId,LastModified:LastModified}}'
```

DeleteMarker がある場合は削除されている

```bash
# DeleteMarker を削除して復元
aws s3api delete-object \
  --bucket STATE_BUCKET \
  --key path/to/terraform.tfstate \
  --version-id DELETE_MARKER_VERSION_ID
```

#### Step 2: 完全に消失している場合

State のバージョンが全くない場合は、リソースを re-import する必要がある

```bash
# 1. 空の State を初期化
terraform init

# 2. 既存リソースを特定（AWS CLI や Console で確認）

# 3. import コマンドで再登録
terraform import aws_instance.web i-0123456789abcdef0
terraform import aws_s3_bucket.logs bucket-name
# ... 全リソースを import
```

### 5.4 注意事項

- import 作業は時間がかかる。リソース数を事前に把握
- import 後は必ず plan で差分を確認

---

## 6. State 不整合の復旧

### 6.1 症状

```
terraform plan で想定外の差分（Drift）が表示される
```

### 6.2 原因

- Console から手動変更された
- 他のツール（AWS CLI、別の Terraform）で変更された
- AWS 側の自動変更（パッチ適用など）

### 6.3 復旧手順

#### Step 1: Drift の確認

```bash
terraform plan -detailed-exitcode
# exit code 2 = 差分あり
```

#### Step 2: 差分の分析

```bash
terraform plan -out=plan.out
terraform show -json plan.out | jq '.resource_changes[] | {address,actions}'
```

#### Step 3: 対応方針の決定

| Drift の内容 | 対応方針 |
|-------------|---------|
| Terraform で管理すべき変更 | apply で上書き |
| 手動変更を維持したい | `ignore_changes` を追加 |
| State を現実に合わせたい | `terraform apply -refresh-only` |

#### Step 4: 対応実行

```bash
# Terraform で上書き
terraform apply

# または State を現実に合わせる
terraform apply -refresh-only
```

---

## 7. インシデントレポート

障害復旧後は以下の情報を記録する：

| 項目 | 内容 |
|------|------|
| 発生日時 | |
| 検知日時 | |
| 復旧完了日時 | |
| 対象環境 | |
| 障害種別 | |
| 影響範囲 | |
| 原因 | |
| 実施した復旧手順 | |
| 再発防止策 | |
| 対応者 | |

---

## 8. 予防策

### 8.1 定期バックアップ

```bash
# 毎日の State バックアップスクリプト
#!/bin/bash
DATE=$(date +%Y%m%d)
aws s3 cp s3://STATE_BUCKET/path/to/terraform.tfstate \
  s3://BACKUP_BUCKET/terraform-state-backup/$DATE/terraform.tfstate
```

### 8.2 監視設定

- CloudWatch Alarm で State バケットへのアクセス異常を検知
- S3 Event Notification で削除イベントを通知

### 8.3 権限制御

- State バケットへの直接アクセスを制限
- CI/CD 経由のみで terraform apply を許可

---

## 9. 連絡先

| 役割 | 担当者 | 連絡先 |
|------|-------|-------|
| インフラチームリーダー | | |
| オンコール担当 | | |
| AWS サポート | | ケース起票 |

---

## 10. 改訂履歴

| 版数 | 日付 | 変更内容 | 変更者 |
|------|------|----------|--------|
| 1.0 | YYYY-MM-DD | 初版作成 | |
| | | | |
