# =============================================================================
# .github/workflows/terraform-plan.yml
# PR æ—¶è‡ªåŠ¨è¿è¡Œ terraform plan
# =============================================================================
#
# è§¦å‘æ¡ä»¶ï¼š
# - åˆ›å»ºæˆ–æ›´æ–° PR åˆ° main åˆ†æ”¯
# - PR ä¸­åŒ…å« Terraform æ–‡ä»¶å˜æ›´
#
# åŠŸèƒ½ï¼š
# - è¿è¡Œ terraform fmt æ£€æŸ¥
# - è¿è¡Œ terraform validate
# - è¿è¡Œ tflint
# - è¿è¡Œ Trivy å®‰å…¨æ‰«æ
# - è¿è¡Œ terraform plan
# - å°† plan ç»“æžœä½œä¸º PR è¯„è®º
#
# =============================================================================

name: Terraform Plan

on:
  pull_request:
    branches:
      - main
    paths:
      - 'environments/**'
      - 'modules/**'
      - '.github/workflows/terraform-*.yml'

# æƒé™é…ç½®
permissions:
  id-token: write      # OIDC è®¤è¯éœ€è¦
  contents: read       # è¯»å–ä»£ç 
  pull-requests: write # å†™å…¥ PR è¯„è®º

# é˜²æ­¢å¹¶å‘è¿è¡Œ
concurrency:
  group: terraform-plan-${{ github.ref }}
  cancel-in-progress: true

env:
  TF_VERSION: "1.14.3"
  AWS_REGION: "ap-northeast-1"
  WORKING_DIRECTORY: "environments/dev"

jobs:
  # ---------------------------------------------------------------------------
  # ä»£ç è´¨é‡æ£€æŸ¥
  # ---------------------------------------------------------------------------
  lint:
    name: Lint & Security
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      # æ ¼å¼æ£€æŸ¥
      - name: Terraform Format Check
        id: fmt
        run: terraform fmt -check -recursive
        continue-on-error: true

      # è¯­æ³•éªŒè¯
      - name: Terraform Init (for validate)
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: terraform init -backend=false

      - name: Terraform Validate
        id: validate
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: terraform validate -no-color
        continue-on-error: true

      # tflint
      - name: Setup tflint
        uses: terraform-linters/setup-tflint@v6
        with:
          tflint_version: latest

      - name: Init tflint
        run: tflint --init
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Run tflint
        id: tflint
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: tflint --format compact
        continue-on-error: true

      # Trivy å®‰å…¨æ‰«æï¼ˆtfsec çš„ç»§æ‰¿è€…ï¼‰
      - name: Run Trivy
        id: trivy
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: ${{ env.WORKING_DIRECTORY }}
          exit-code: '0'
          severity: 'HIGH,CRITICAL'

      # æ£€æŸ¥ç»“æžœæ±‡æ€»
      - name: Check Results
        if: steps.fmt.outcome == 'failure' || steps.validate.outcome == 'failure'
        run: |
          echo "## Quality Check Results" >> $GITHUB_STEP_SUMMARY
          echo "- Format: ${{ steps.fmt.outcome }}" >> $GITHUB_STEP_SUMMARY
          echo "- Validate: ${{ steps.validate.outcome }}" >> $GITHUB_STEP_SUMMARY
          echo "- tflint: ${{ steps.tflint.outcome }}" >> $GITHUB_STEP_SUMMARY
          exit 1

  # ---------------------------------------------------------------------------
  # Terraform Plan
  # ---------------------------------------------------------------------------
  plan:
    name: Terraform Plan
    runs-on: ubuntu-latest
    needs: lint

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      # OIDC è®¤è¯åˆ° AWS
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      # Terraform Init
      - name: Terraform Init
        id: init
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: terraform init
        continue-on-error: true

      # Terraform Plan
      - name: Terraform Plan
        id: plan
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          terraform plan -no-color -out=tfplan 2>&1 | tee plan_output.txt
          echo "plan_exitcode=$?" >> $GITHUB_OUTPUT
        continue-on-error: true

      # ä¿å­˜ Plan è¾“å‡º
      - name: Save Plan Output
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan
          path: |
            ${{ env.WORKING_DIRECTORY }}/tfplan
            ${{ env.WORKING_DIRECTORY }}/plan_output.txt

      # PR è¯„è®º
      - name: Comment on PR
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const planOutput = fs.readFileSync('${{ env.WORKING_DIRECTORY }}/plan_output.txt', 'utf8');

            // æˆªæ–­è¿‡é•¿çš„è¾“å‡º
            const maxLength = 60000;
            let truncatedPlan = planOutput;
            if (planOutput.length > maxLength) {
              truncatedPlan = planOutput.substring(0, maxLength) + '\n\n... (output truncated)';
            }

            const output = `## Terraform Plan Results

            ### Environment: \`dev\`

            #### ðŸ”§ Init: \`${{ steps.init.outcome }}\`
            #### ðŸ“‹ Plan: \`${{ steps.plan.outcome }}\`

            <details>
            <summary>Show Plan Output</summary>

            \`\`\`terraform
            ${truncatedPlan}
            \`\`\`

            </details>

            ---
            *Pusher: @${{ github.actor }}, Action: \`${{ github.event_name }}\`, Workflow: \`${{ github.workflow }}\`*
            `;

            // æŸ¥æ‰¾å¹¶æ›´æ–°çŽ°æœ‰è¯„è®ºï¼Œæˆ–åˆ›å»ºæ–°è¯„è®º
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' && comment.body.includes('Terraform Plan Results')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: output
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: output
              });
            }

      # Plan å¤±è´¥æ—¶é€€å‡º
      - name: Plan Status
        if: steps.plan.outcome == 'failure'
        run: exit 1
