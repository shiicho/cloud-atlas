# =============================================================================
# .github/workflows/terraform-plan.yml
# PR æ—¶è‡ªåŠ¨è¿è¡Œ terraform planï¼ˆå¤šçŽ¯å¢ƒæ”¯æŒï¼‰
# =============================================================================
#
# è§¦å‘æ¡ä»¶ï¼š
# - åˆ›å»ºæˆ–æ›´æ–° PR åˆ° main åˆ†æ”¯
# - PR ä¸­åŒ…å« Terraform æ–‡ä»¶å˜æ›´
#
# åŠŸèƒ½ï¼š
# - è¿è¡Œ terraform fmt æ£€æŸ¥
# - è¿è¡Œ terraform validate
# - è¿è¡Œ tflint
# - è¿è¡Œ Trivy å®‰å…¨æ‰«æ
# - å¯¹æ‰€æœ‰çŽ¯å¢ƒè¿è¡Œ terraform plan
# - å°† plan ç»“æžœä½œä¸º PR è¯„è®º
#
# å‚è€ƒï¼š11-cicd è¯¾ç¨‹ä¸­çš„ CI/CD è®¾è®¡åŽŸåˆ™
#
# =============================================================================

name: Terraform Plan

on:
  pull_request:
    branches:
      - main
    paths:
      - 'environments/**'
      - 'modules/**'
      - '.github/workflows/terraform-*.yml'

# æƒé™é…ç½®
permissions:
  id-token: write      # OIDC è®¤è¯éœ€è¦
  contents: read       # è¯»å–ä»£ç 
  pull-requests: write # å†™å…¥ PR è¯„è®º

# é˜²æ­¢å¹¶å‘è¿è¡Œ
concurrency:
  group: terraform-plan-${{ github.ref }}
  cancel-in-progress: true

env:
  TF_VERSION: "1.14.3"
  AWS_REGION: "ap-northeast-1"

jobs:
  # ---------------------------------------------------------------------------
  # æ£€æµ‹å˜æ›´çš„çŽ¯å¢ƒ
  # ---------------------------------------------------------------------------
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      environments: ${{ steps.detect.outputs.environments }}
      has_changes: ${{ steps.detect.outputs.has_changes }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Detect changed environments
        id: detect
        run: |
          # èŽ·å–å˜æ›´çš„æ–‡ä»¶
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)

          # æ£€æµ‹å˜æ›´çš„çŽ¯å¢ƒ
          ENVS=()

          # å¦‚æžœæ¨¡å—å˜æ›´ï¼Œæ‰€æœ‰çŽ¯å¢ƒéƒ½éœ€è¦ plan
          if echo "$CHANGED_FILES" | grep -q "^modules/"; then
            ENVS=("dev" "staging" "prod")
          else
            # æ£€æµ‹ç‰¹å®šçŽ¯å¢ƒå˜æ›´
            if echo "$CHANGED_FILES" | grep -q "^environments/dev/"; then
              ENVS+=("dev")
            fi
            if echo "$CHANGED_FILES" | grep -q "^environments/staging/"; then
              ENVS+=("staging")
            fi
            if echo "$CHANGED_FILES" | grep -q "^environments/prod/"; then
              ENVS+=("prod")
            fi
          fi

          # å¦‚æžœæ²¡æœ‰æ£€æµ‹åˆ°å˜æ›´ï¼Œé»˜è®¤ plan dev
          if [ ${#ENVS[@]} -eq 0 ]; then
            ENVS=("dev")
          fi

          # è½¬æ¢ä¸º JSON æ•°ç»„
          JSON_ENVS=$(printf '%s\n' "${ENVS[@]}" | jq -R . | jq -s .)
          echo "environments=$JSON_ENVS" >> $GITHUB_OUTPUT
          echo "has_changes=true" >> $GITHUB_OUTPUT

          echo "## Changed Environments" >> $GITHUB_STEP_SUMMARY
          for env in "${ENVS[@]}"; do
            echo "- $env" >> $GITHUB_STEP_SUMMARY
          done

  # ---------------------------------------------------------------------------
  # ä»£ç è´¨é‡æ£€æŸ¥ï¼ˆåªè¿è¡Œä¸€æ¬¡ï¼‰
  # ---------------------------------------------------------------------------
  lint:
    name: Lint & Security
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.has_changes == 'true'

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      # æ ¼å¼æ£€æŸ¥ï¼ˆå…¨å±€ï¼‰
      - name: Terraform Format Check
        id: fmt
        run: terraform fmt -check -recursive
        continue-on-error: true

      # tflint
      - name: Setup tflint
        uses: terraform-linters/setup-tflint@v6
        with:
          tflint_version: latest

      - name: Init tflint
        run: tflint --init
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Run tflint on modules
        id: tflint
        run: |
          for module in modules/*/; do
            echo "Linting $module"
            tflint --chdir="$module" --format compact || true
          done
        continue-on-error: true

      # Trivy å®‰å…¨æ‰«æ
      - name: Run Trivy
        id: trivy
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: 'environments/'
          exit-code: '0'
          severity: 'HIGH,CRITICAL'

      # æ£€æŸ¥ç»“æžœæ±‡æ€»
      - name: Lint Summary
        run: |
          echo "## Quality Check Results" >> $GITHUB_STEP_SUMMARY
          echo "- Format: ${{ steps.fmt.outcome }}" >> $GITHUB_STEP_SUMMARY
          echo "- tflint: ${{ steps.tflint.outcome }}" >> $GITHUB_STEP_SUMMARY
          echo "- Trivy: ${{ steps.trivy.outcome }}" >> $GITHUB_STEP_SUMMARY

      - name: Fail on format error
        if: steps.fmt.outcome == 'failure'
        run: |
          echo "::error::Terraform format check failed. Run 'terraform fmt -recursive' to fix."
          exit 1

  # ---------------------------------------------------------------------------
  # Terraform Planï¼ˆæ¯ä¸ªçŽ¯å¢ƒï¼‰
  # ---------------------------------------------------------------------------
  plan:
    name: Plan - ${{ matrix.environment }}
    runs-on: ubuntu-latest
    needs: [detect-changes, lint]
    strategy:
      fail-fast: false
      matrix:
        environment: ${{ fromJson(needs.detect-changes.outputs.environments) }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      # OIDC è®¤è¯åˆ° AWS
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      # Terraform Init
      - name: Terraform Init
        id: init
        working-directory: environments/${{ matrix.environment }}
        run: terraform init
        continue-on-error: true

      # Terraform Validate
      - name: Terraform Validate
        id: validate
        working-directory: environments/${{ matrix.environment }}
        run: terraform validate -no-color
        continue-on-error: true

      # Terraform Plan
      - name: Terraform Plan
        id: plan
        working-directory: environments/${{ matrix.environment }}
        run: |
          terraform plan -no-color -out=tfplan 2>&1 | tee plan_output.txt
          echo "exitcode=$?" >> $GITHUB_OUTPUT
        continue-on-error: true

      # ä¿å­˜ Plan è¾“å‡º
      - name: Save Plan Output
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan-${{ matrix.environment }}
          path: |
            environments/${{ matrix.environment }}/tfplan
            environments/${{ matrix.environment }}/plan_output.txt

      # PR è¯„è®º
      - name: Comment on PR
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const environment = '${{ matrix.environment }}';
            const planOutput = fs.readFileSync(`environments/${environment}/plan_output.txt`, 'utf8');

            // æˆªæ–­è¿‡é•¿çš„è¾“å‡º
            const maxLength = 60000;
            let truncatedPlan = planOutput;
            if (planOutput.length > maxLength) {
              truncatedPlan = planOutput.substring(0, maxLength) + '\n\n... (output truncated)';
            }

            const output = `## Terraform Plan Results - \`${environment}\`

            #### ðŸ”§ Init: \`${{ steps.init.outcome }}\`
            #### âœ… Validate: \`${{ steps.validate.outcome }}\`
            #### ðŸ“‹ Plan: \`${{ steps.plan.outcome }}\`

            <details>
            <summary>Show Plan Output</summary>

            \`\`\`terraform
            ${truncatedPlan}
            \`\`\`

            </details>

            ---
            *Environment: \`${environment}\` | Pusher: @${{ github.actor }}*
            `;

            // æŸ¥æ‰¾å¹¶æ›´æ–°çŽ°æœ‰è¯„è®ºï¼Œæˆ–åˆ›å»ºæ–°è¯„è®º
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const commentMarker = `## Terraform Plan Results - \`${environment}\``;
            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' && comment.body.includes(commentMarker)
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: output
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: output
              });
            }

      # Plan å¤±è´¥æ—¶é€€å‡º
      - name: Plan Status
        if: steps.plan.outcome == 'failure'
        run: exit 1
