# =============================================================================
# .github/workflows/terraform-apply.yml
# 手动触发 terraform apply（需要审批）
# =============================================================================
#
# 触发条件：
# - 手动触发（workflow_dispatch）
# - 或者合并到 main 分支后自动触发
#
# 审批流程：
# - 使用 GitHub Environments 实现审批门禁
# - production 环境需要指定审批者批准
#
# =============================================================================

name: Terraform Apply

on:
  # 手动触发
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod
      auto_approve:
        description: 'Skip confirmation (dev only)'
        required: false
        default: false
        type: boolean

  # 合并到 main 时触发（可选，默认禁用）
  # push:
  #   branches:
  #     - main
  #   paths:
  #     - 'environments/**'
  #     - 'modules/**'

# 权限配置
permissions:
  id-token: write
  contents: read

# 防止并发 apply
concurrency:
  group: terraform-apply-${{ inputs.environment || 'dev' }}
  cancel-in-progress: false  # Apply 不能取消

env:
  TF_VERSION: "1.9.0"
  AWS_REGION: "ap-northeast-1"

jobs:
  # ---------------------------------------------------------------------------
  # 确定环境和工作目录
  # ---------------------------------------------------------------------------
  setup:
    name: Setup
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
      working_directory: ${{ steps.set-env.outputs.working_directory }}

    steps:
      - name: Set Environment
        id: set-env
        run: |
          ENV="${{ inputs.environment || 'dev' }}"
          echo "environment=$ENV" >> $GITHUB_OUTPUT
          echo "working_directory=environments/$ENV" >> $GITHUB_OUTPUT
          echo "## Target Environment: $ENV" >> $GITHUB_STEP_SUMMARY

  # ---------------------------------------------------------------------------
  # Plan（Apply 前再次 Plan 确认）
  # ---------------------------------------------------------------------------
  plan:
    name: Plan
    runs-on: ubuntu-latest
    needs: setup
    outputs:
      plan_exitcode: ${{ steps.plan.outputs.exitcode }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Terraform Init
        working-directory: ${{ needs.setup.outputs.working_directory }}
        run: terraform init

      - name: Terraform Plan
        id: plan
        working-directory: ${{ needs.setup.outputs.working_directory }}
        run: |
          terraform plan -detailed-exitcode -no-color -out=tfplan 2>&1 | tee plan_output.txt
          echo "exitcode=$?" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Upload Plan
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan-${{ needs.setup.outputs.environment }}
          path: |
            ${{ needs.setup.outputs.working_directory }}/tfplan
            ${{ needs.setup.outputs.working_directory }}/plan_output.txt

      - name: Plan Summary
        run: |
          echo "## Plan Result" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.plan.outputs.exitcode }}" == "0" ]; then
            echo "✅ No changes needed" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.plan.outputs.exitcode }}" == "2" ]; then
            echo "⚠️ Changes detected - apply required" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Plan failed" >> $GITHUB_STEP_SUMMARY
          fi

  # ---------------------------------------------------------------------------
  # Apply（需要审批）
  # ---------------------------------------------------------------------------
  apply:
    name: Apply
    runs-on: ubuntu-latest
    needs: [setup, plan]
    # 只有 Plan 检测到变更时才 Apply（exitcode 2）
    if: needs.plan.outputs.plan_exitcode == '2'

    # 使用 GitHub Environment 实现审批
    # 需要在 Repository Settings > Environments 中配置
    environment:
      name: ${{ needs.setup.outputs.environment }}
      url: ${{ steps.apply.outputs.url }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Download Plan
        uses: actions/download-artifact@v4
        with:
          name: terraform-plan-${{ needs.setup.outputs.environment }}
          path: ${{ needs.setup.outputs.working_directory }}

      - name: Terraform Init
        working-directory: ${{ needs.setup.outputs.working_directory }}
        run: terraform init

      - name: Terraform Apply
        id: apply
        working-directory: ${{ needs.setup.outputs.working_directory }}
        run: |
          terraform apply -auto-approve tfplan 2>&1 | tee apply_output.txt

          # 提取输出（如果有 ALB URL）
          ALB_URL=$(terraform output -raw alb_url 2>/dev/null || echo "")
          if [ -n "$ALB_URL" ]; then
            echo "url=$ALB_URL" >> $GITHUB_OUTPUT
          fi

      - name: Apply Summary
        if: always()
        run: |
          echo "## Apply Result" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.apply.outcome }}" == "success" ]; then
            echo "✅ Apply completed successfully" >> $GITHUB_STEP_SUMMARY

            # 显示重要输出
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Outputs" >> $GITHUB_STEP_SUMMARY
            cd ${{ needs.setup.outputs.working_directory }}
            terraform output -no-color >> $GITHUB_STEP_SUMMARY 2>/dev/null || true
          else
            echo "❌ Apply failed" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload Apply Output
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: terraform-apply-${{ needs.setup.outputs.environment }}
          path: ${{ needs.setup.outputs.working_directory }}/apply_output.txt

  # ---------------------------------------------------------------------------
  # 通知（Apply 完成后）
  # ---------------------------------------------------------------------------
  notify:
    name: Notify
    runs-on: ubuntu-latest
    needs: [setup, apply]
    if: always()

    steps:
      - name: Notify Success
        if: needs.apply.result == 'success'
        run: |
          echo "## Deployment Notification" >> $GITHUB_STEP_SUMMARY
          echo "✅ ${{ needs.setup.outputs.environment }} environment deployed successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Deployed by: @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "Time: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY

      - name: Notify Failure
        if: needs.apply.result == 'failure'
        run: |
          echo "## Deployment Notification" >> $GITHUB_STEP_SUMMARY
          echo "❌ ${{ needs.setup.outputs.environment }} deployment failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Please check the workflow logs for details." >> $GITHUB_STEP_SUMMARY
