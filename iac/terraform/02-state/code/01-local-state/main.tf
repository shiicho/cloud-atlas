# main.tf
# Local State 反模式演示
#
# 本文件创建一个简单的 S3 Bucket，使用 Local State。
# 用于演示 Local State 在团队协作中的问题。
#
# 问题：
# 1. State 只在本机，其他团队成员看不到
# 2. 没有锁机制，并发 apply 会覆盖
# 3. State 可能包含敏感信息，本地存储不安全
# 4. 机器故障会丢失 State

# -----------------------------------------------------------------------------
# Random ID - 生成唯一后缀
# -----------------------------------------------------------------------------

resource "random_id" "suffix" {
  byte_length = 4
}

# -----------------------------------------------------------------------------
# S3 Bucket - 演示资源
# -----------------------------------------------------------------------------

resource "aws_s3_bucket" "demo" {
  bucket = "state-demo-local-${random_id.suffix.hex}"

  tags = {
    Name        = "State Demo - Local"
    Environment = "learning"
    Warning     = "This uses local state - NOT for production!"
  }
}

# -----------------------------------------------------------------------------
# 反模式说明
# -----------------------------------------------------------------------------
#
# 运行 terraform apply 后，检查当前目录：
#
#   ls -la terraform.tfstate
#
# 这个文件包含：
# - 资源的完整状态
# - 可能的敏感信息（密码、密钥）
# - 依赖关系映射
#
# 问题场景：
#
#   开发者 A                    开发者 B
#   ─────────                  ─────────
#   clone repo                 clone repo
#   terraform apply            terraform apply
#   (创建资源)                  (不知道 A 已创建)
#        │                          │
#        ▼                          ▼
#   local tfstate              local tfstate
#   (version 1)                (version 1)
#        │                          │
#        └──────────┬───────────────┘
#                   ▼
#              谁的 State 是正确的？
#              资源会被重复创建或冲突
#
# 解决方案：使用远程后端（S3 + 原生锁定）
# → 参见 ../02-s3-backend/
# -----------------------------------------------------------------------------
