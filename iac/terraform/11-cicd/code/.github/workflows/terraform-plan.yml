# terraform-plan.yml
# PR æ—¶è‡ªåŠ¨è¿è¡Œ terraform planï¼Œç»“æœä½œä¸ºè¯„è®ºå‘å¸ƒåˆ° PR
#
# åŠŸèƒ½ï¼š
# - è‡ªåŠ¨æ ¼å¼åŒ–æ£€æŸ¥ (terraform fmt)
# - è‡ªåŠ¨éªŒè¯ (terraform validate)
# - ç”Ÿæˆ plan å¹¶å‘å¸ƒåˆ° PR è¯„è®º
# - å¯é€‰ï¼šInfracost æˆæœ¬ä¼°ç®—

name: Terraform Plan

on:
  pull_request:
    branches:
      - main
    paths:
      - '**/*.tf'
      - '.github/workflows/terraform-*.yml'

# æƒé™è®¾ç½®
# id-token: OIDC è®¤è¯éœ€è¦
# contents: è¯»å–ä»£ç 
# pull-requests: å†™å…¥ PR è¯„è®º
permissions:
  id-token: write
  contents: read
  pull-requests: write

env:
  # Terraform å·¥ä½œç›®å½•ï¼ˆæ ¹ç›®å½•ï¼‰
  TF_WORKING_DIR: .
  # AWS åŒºåŸŸ
  AWS_REGION: ap-northeast-1
  # Terraform ç‰ˆæœ¬
  TF_VERSION: "1.14.3"

jobs:
  # =============================================================================
  # Job: terraform-plan
  # =============================================================================
  terraform-plan:
    name: Terraform Plan
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ${{ env.TF_WORKING_DIR }}

    steps:
      # -------------------------------------------------------------------------
      # Step 1: Checkout ä»£ç 
      # -------------------------------------------------------------------------
      - name: Checkout
        uses: actions/checkout@v6

      # -------------------------------------------------------------------------
      # Step 2: é…ç½® AWS å‡­è¯ï¼ˆOIDC æ–¹å¼ï¼‰
      # -------------------------------------------------------------------------
      # ä½¿ç”¨ OIDC è®¤è¯ï¼Œæ— éœ€å­˜å‚¨ Access Key
      # IAM Role éœ€è¦é¢„å…ˆé…ç½®ä¿¡ä»»ç­–ç•¥
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          # ä¼šè¯åç§°ï¼Œä¾¿äº CloudTrail è¿½è¸ª
          role-session-name: GitHubActions-TerraformPlan

      # -------------------------------------------------------------------------
      # Step 3: å®‰è£… Terraform
      # -------------------------------------------------------------------------
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          # å¯ç”¨ wrapper ä»¥æ•è·è¾“å‡º
          terraform_wrapper: true

      # -------------------------------------------------------------------------
      # Step 4: æ ¼å¼åŒ–æ£€æŸ¥
      # -------------------------------------------------------------------------
      # terraform fmt -check ä¸ä¼šä¿®æ”¹æ–‡ä»¶ï¼Œåªæ£€æŸ¥æ ¼å¼
      - name: Terraform Format Check
        id: fmt
        run: terraform fmt -check -recursive
        continue-on-error: true

      # -------------------------------------------------------------------------
      # Step 5: åˆå§‹åŒ–
      # -------------------------------------------------------------------------
      - name: Terraform Init
        id: init
        run: terraform init -no-color

      # -------------------------------------------------------------------------
      # Step 6: éªŒè¯é…ç½®
      # -------------------------------------------------------------------------
      - name: Terraform Validate
        id: validate
        run: terraform validate -no-color

      # -------------------------------------------------------------------------
      # Step 7: ç”Ÿæˆ Plan
      # -------------------------------------------------------------------------
      - name: Terraform Plan
        id: plan
        run: |
          set -o pipefail
          terraform plan -no-color -out=tfplan 2>&1 | tee plan_output.txt
        continue-on-error: true

      # -------------------------------------------------------------------------
      # Step 8: å‘å¸ƒ Plan ç»“æœåˆ° PR è¯„è®º
      # -------------------------------------------------------------------------
      - name: Post Plan to PR
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        env:
          PLAN: ${{ steps.plan.outputs.stdout }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // è¯»å– plan è¾“å‡º
            const fs = require('fs');
            const planOutput = fs.readFileSync('${{ env.TF_WORKING_DIR }}/plan_output.txt', 'utf8');

            // æˆªæ–­è¿‡é•¿çš„è¾“å‡ºï¼ˆGitHub è¯„è®ºæœ‰å­—ç¬¦é™åˆ¶ï¼‰
            const maxLength = 60000;
            const truncatedPlan = planOutput.length > maxLength
              ? planOutput.substring(0, maxLength) + '\n\n... (output truncated)'
              : planOutput;

            // æ„å»ºè¯„è®ºå†…å®¹
            const output = `## Terraform Plan Results

            | Step | Status |
            |------|--------|
            | Format | ${{ steps.fmt.outcome == 'success' && 'âœ… Passed' || 'âš ï¸ Failed' }} |
            | Init | ${{ steps.init.outcome == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |
            | Validate | ${{ steps.validate.outcome == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |
            | Plan | ${{ steps.plan.outcome == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |

            <details><summary>ğŸ“‹ Plan Output (click to expand)</summary>

            \`\`\`hcl
            ${truncatedPlan}
            \`\`\`

            </details>

            ---
            *Pusher: @${{ github.actor }}, Action: \`${{ github.event_name }}\`*
            *Workflow: \`${{ github.workflow }}\`*`;

            // æŸ¥æ‰¾å·²æœ‰è¯„è®º
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('## Terraform Plan Results')
            );

            // æ›´æ–°æˆ–åˆ›å»ºè¯„è®º
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: output
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: output
              });
            }

      # -------------------------------------------------------------------------
      # Step 9: ä¿å­˜ Plan æ–‡ä»¶ï¼ˆä¾› Apply ä½¿ç”¨ï¼‰
      # -------------------------------------------------------------------------
      - name: Upload Plan Artifact
        uses: actions/upload-artifact@v4
        with:
          name: tfplan-${{ github.event.pull_request.number }}
          path: ${{ env.TF_WORKING_DIR }}/tfplan
          retention-days: 5

      # -------------------------------------------------------------------------
      # Step 10: æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯
      # -------------------------------------------------------------------------
      - name: Check Plan Status
        if: steps.plan.outcome == 'failure'
        run: |
          echo "::error::Terraform plan failed. Please review the output above."
          exit 1

      - name: Check Format Status
        if: steps.fmt.outcome == 'failure'
        run: |
          echo "::warning::Terraform files are not properly formatted. Run 'terraform fmt' locally."
