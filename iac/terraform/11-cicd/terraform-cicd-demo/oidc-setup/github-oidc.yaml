# github-oidc.yaml
# CloudFormation: GitHub Actions OIDC Provider and IAM Role
#
# This template creates:
# 1. OIDC Identity Provider (trusts GitHub)
# 2. IAM Role (GitHub Actions can assume)
# 3. Policies for Terraform operations
#
# Deploy:
#   aws cloudformation deploy \
#     --template-file github-oidc.yaml \
#     --stack-name github-oidc-terraform \
#     --capabilities CAPABILITY_NAMED_IAM \
#     --parameter-overrides \
#       GitHubOrg=YOUR_USERNAME \
#       RepoName=YOUR_REPO_NAME

AWSTemplateFormatVersion: '2010-09-09'
Description: GitHub Actions OIDC Provider and IAM Role for Terraform CI/CD

# =============================================================================
# Parameters
# =============================================================================
Parameters:
  GitHubOrg:
    Type: String
    Description: Your GitHub username or organization name

  RepoName:
    Type: String
    Description: Your GitHub repository name

  OIDCAudience:
    Type: String
    Default: sts.amazonaws.com
    Description: OIDC Audience (keep default)

  CreateOIDCProvider:
    Type: String
    Default: 'true'
    AllowedValues:
      - 'true'
      - 'false'
    Description: |
      Set to 'false' if OIDC provider already exists in this account.
      Run: aws iam list-open-id-connect-providers to check.

# =============================================================================
# Conditions
# =============================================================================
Conditions:
  ShouldCreateOIDCProvider: !Equals [!Ref CreateOIDCProvider, 'true']

# =============================================================================
# Resources
# =============================================================================
Resources:
  # ---------------------------------------------------------------------------
  # OIDC Identity Provider
  # ---------------------------------------------------------------------------
  # Registers GitHub as a trusted identity provider in AWS
  # One per AWS account (shared by all repos)
  # NOTE: Conditional - skip if provider already exists (CreateOIDCProvider=false)
  GitHubOIDCProvider:
    Type: AWS::IAM::OIDCProvider
    Condition: ShouldCreateOIDCProvider
    Properties:
      Url: https://token.actions.githubusercontent.com
      ClientIdList:
        - !Ref OIDCAudience
      ThumbprintList:
        - 6938fd4d98bab03faadb97b34396831e3780aea1
        - 1c58a3a8518e8759bf075b76b750d4f2df264fcd
      Tags:
        - Key: Purpose
          Value: GitHub Actions OIDC

  # ---------------------------------------------------------------------------
  # IAM Role for GitHub Actions
  # ---------------------------------------------------------------------------
  # GitHub Actions will assume this role to run Terraform
  GitHubActionsRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub github-actions-${RepoName}
      Description: !Sub IAM Role for GitHub Actions (${GitHubOrg}/${RepoName})

      # Trust policy: Only trust GitHub Actions from YOUR repo
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              # Use created provider ARN if creating, otherwise construct ARN
              Federated: !If
                - ShouldCreateOIDCProvider
                - !GetAtt GitHubOIDCProvider.Arn
                - !Sub arn:aws:iam::${AWS::AccountId}:oidc-provider/token.actions.githubusercontent.com
            Action: sts:AssumeRoleWithWebIdentity
            Condition:
              StringEquals:
                token.actions.githubusercontent.com:aud: !Ref OIDCAudience
              StringLike:
                # Only YOUR repo can assume this role
                token.actions.githubusercontent.com:sub: !Sub repo:${GitHubOrg}/${RepoName}:*

      MaxSessionDuration: 3600

      Tags:
        - Key: Repository
          Value: !Sub ${GitHubOrg}/${RepoName}

  # ---------------------------------------------------------------------------
  # IAM Policy for Terraform
  # ---------------------------------------------------------------------------
  TerraformPolicy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: TerraformAccess
      Roles:
        - !Ref GitHubActionsRole
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          # S3 State Backend Access
          # Allows Terraform to read/write state to the shared state bucket
          - Sid: S3StateBackendAccess
            Effect: Allow
            Action:
              - s3:GetObject
              - s3:PutObject
              - s3:DeleteObject
              - s3:ListBucket
            Resource:
              - arn:aws:s3:::tfstate-terraform-course-*
              - arn:aws:s3:::tfstate-terraform-course-*/11-cicd/*

          # S3 operations (for demo bucket - the actual resource we manage)
          - Sid: S3DemoResourceAccess
            Effect: Allow
            Action:
              - s3:CreateBucket
              - s3:DeleteBucket
              - s3:Get*
              - s3:Put*
              - s3:List*
            Resource:
              - arn:aws:s3:::cicd-demo-*
              - arn:aws:s3:::cicd-demo-*/*

          # Read-only for data sources
          - Sid: ReadOnlyAccess
            Effect: Allow
            Action:
              - iam:Get*
              - iam:List*
              - ec2:Describe*
            Resource: "*"

# =============================================================================
# Outputs
# =============================================================================
Outputs:
  RoleArn:
    Description: |
      IAM Role ARN - Add this to GitHub Secrets as AWS_ROLE_ARN
    Value: !GetAtt GitHubActionsRole.Arn

  OIDCProviderArn:
    Description: OIDC Provider ARN
    Value: !If
      - ShouldCreateOIDCProvider
      - !GetAtt GitHubOIDCProvider.Arn
      - !Sub arn:aws:iam::${AWS::AccountId}:oidc-provider/token.actions.githubusercontent.com

  NextStep:
    Description: Next step after deployment
    Value: !Sub |
      1. Copy the RoleArn output above
      2. Go to GitHub repo > Settings > Secrets > Actions
      3. Add secret: AWS_ROLE_ARN = <the RoleArn value>
