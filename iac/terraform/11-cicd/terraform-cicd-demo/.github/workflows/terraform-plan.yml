# terraform-plan.yml
# PR triggers terraform plan, posts result as PR comment
#
# This is YOUR repo's workflow! When you create a PR:
# 1. This workflow runs automatically
# 2. terraform plan result appears as a PR comment
# 3. Review the plan before merging
#
# Prerequisites:
# - AWS_ROLE_ARN secret configured (from OIDC setup)

name: Terraform Plan

on:
  pull_request:
    branches:
      - main
    paths:
      - '**/*.tf'
      - '.github/workflows/terraform-*.yml'

permissions:
  id-token: write      # OIDC authentication
  contents: read       # Read repository
  pull-requests: write # Post PR comments

env:
  AWS_REGION: ap-northeast-1
  TF_VERSION: "1.14.3"

jobs:
  terraform-plan:
    name: Terraform Plan
    runs-on: ubuntu-latest

    steps:
      # -----------------------------------------------------------------------
      # Step 1: Checkout code
      # -----------------------------------------------------------------------
      - name: Checkout
        uses: actions/checkout@v6

      # -----------------------------------------------------------------------
      # Step 2: Configure AWS credentials (OIDC)
      # -----------------------------------------------------------------------
      # No Access Key needed! OIDC provides temporary credentials
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-TerraformPlan

      # -----------------------------------------------------------------------
      # Step 3: Setup Terraform
      # -----------------------------------------------------------------------
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: true

      # -----------------------------------------------------------------------
      # Step 4: Format check
      # -----------------------------------------------------------------------
      - name: Terraform Format Check
        id: fmt
        run: terraform fmt -check -recursive
        continue-on-error: true

      # -----------------------------------------------------------------------
      # Step 5: Initialize
      # -----------------------------------------------------------------------
      - name: Terraform Init
        id: init
        run: terraform init -no-color

      # -----------------------------------------------------------------------
      # Step 6: Validate
      # -----------------------------------------------------------------------
      - name: Terraform Validate
        id: validate
        run: terraform validate -no-color

      # -----------------------------------------------------------------------
      # Step 7: Plan
      # -----------------------------------------------------------------------
      - name: Terraform Plan
        id: plan
        run: |
          set -o pipefail
          terraform plan -no-color -out=tfplan 2>&1 | tee plan_output.txt
        continue-on-error: true

      # -----------------------------------------------------------------------
      # Step 8: Post plan to PR comment
      # -----------------------------------------------------------------------
      - name: Post Plan to PR
        uses: actions/github-script@v8
        if: github.event_name == 'pull_request'
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const planOutput = fs.readFileSync('plan_output.txt', 'utf8');

            // Truncate if too long
            const maxLength = 60000;
            const truncatedPlan = planOutput.length > maxLength
              ? planOutput.substring(0, maxLength) + '\n\n... (truncated)'
              : planOutput;

            const output = `## Terraform Plan Results

            | Step | Status |
            |------|--------|
            | Format | ${{ steps.fmt.outcome == 'success' && '✅ Passed' || '⚠️ Check formatting' }} |
            | Init | ${{ steps.init.outcome == 'success' && '✅ Passed' || '❌ Failed' }} |
            | Validate | ${{ steps.validate.outcome == 'success' && '✅ Passed' || '❌ Failed' }} |
            | Plan | ${{ steps.plan.outcome == 'success' && '✅ Passed' || '❌ Failed' }} |

            <details><summary>Plan Output (click to expand)</summary>

            \`\`\`hcl
            ${truncatedPlan}
            \`\`\`

            </details>

            ---
            *Triggered by: @${{ github.actor }}*`;

            // Find existing bot comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('## Terraform Plan Results')
            );

            // Update or create comment
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: output
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: output
              });
            }

      # -----------------------------------------------------------------------
      # Step 9: Fail if plan failed
      # -----------------------------------------------------------------------
      - name: Check Plan Status
        if: steps.plan.outcome == 'failure'
        run: |
          echo "::error::Terraform plan failed. Check the PR comment for details."
          exit 1
