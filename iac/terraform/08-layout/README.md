# 08 - é¡¹ç›®å¸ƒå±€ä¸å¤šç¯å¢ƒç­–ç•¥

> **ç›®æ ‡**ï¼šè®¾è®¡ Terraform é¡¹ç›®çš„ç›®å½•ç»“æ„ï¼Œå®ç°å¤šç¯å¢ƒç®¡ç†  
> **å‰ç½®**ï¼šå·²å®Œæˆ [07 - æ¨¡å—åŒ–è®¾è®¡](../07-modules/)  
> **æ—¶é—´**ï¼š45-50 åˆ†é’Ÿ  
> **è´¹ç”¨**ï¼šS3 Bucketï¼ˆå…è´¹å±‚ï¼‰

---

## å°†å­¦åˆ°çš„å†…å®¹

1. Workspaces vs Directory ç»“æ„å¯¹æ¯”åŠé€‰æ‹©
2. Monorepo vs Polyrepo æ¶æ„å†³ç­–
3. åˆ†å±‚è®¾è®¡ï¼ˆNetwork / Foundations / Applicationï¼‰
4. ç¯å¢ƒæå‡ç­–ç•¥ï¼ˆPromotionï¼‰
5. DRY æ¨¡å¼ä»‹ç»ï¼ˆTerragrunt ç®€ä»‹ï¼‰

---

## Step 1 - ç¯å¢ƒå‡†å¤‡ä¸è¿æ¥ï¼ˆ2 åˆ†é’Ÿï¼‰

è¿æ¥åˆ°ä½ çš„ Terraform Lab å®ä¾‹ã€‚

**è·å–å®ä¾‹ IDï¼š**

```bash
aws cloudformation describe-stacks \
  --stack-name terraform-lab \
  --region ap-northeast-1 \
  --query 'Stacks[0].Outputs[?OutputKey==`InstanceId`].OutputValue' \
  --output text
```

> **ğŸ’¡ è¿æ¥æ–¹å¼**ï¼ˆé€‰æ‹©ä½ ç†Ÿæ‚‰çš„ï¼‰ï¼š  
> - **AWS Console**ï¼šEC2 â†’ é€‰æ‹©å®ä¾‹ â†’ Connect â†’ Session Manager  
> - **AWS CLI**ï¼š`aws ssm start-session --target <å®ä¾‹ID> --region ap-northeast-1`  
> - **VS Code**ï¼šRemote-SSH è¿æ¥ï¼ˆå¦‚å·²é…ç½®ï¼‰  
>
> **â“ æ²¡æœ‰å®ä¾‹ï¼Ÿ** Stack ä¸å­˜åœ¨æˆ–å®ä¾‹å·²ç»ˆæ­¢ï¼Ÿ  
> â†’ [é‡æ–°éƒ¨ç½²å®éªŒç¯å¢ƒ](../00-concepts/lab-setup.md)

è¿æ¥åï¼Œåˆ‡æ¢åˆ°è¯¾ç¨‹ç”¨æˆ·å¹¶åŒæ­¥ä»£ç ï¼š

```bash
sudo su - terraform
sync-course
```

ç¡®è®¤ä¸Šä¸€è¯¾çš„èµ„æºå·²æ¸…ç†ï¼š

```bash
cd ~/cloud-atlas/iac/terraform/07-modules/code/environments/dev
terraform state list  # åº”ä¸ºç©º
```

---

## Step 2 - ç«‹å³ä½“éªŒï¼šWorkspacesï¼ˆ5 åˆ†é’Ÿï¼‰

> å…ˆ"å°åˆ°" Workspaces çš„ä¾¿åˆ©ï¼Œå†ç†è§£å…¶å±€é™ã€‚

### 2.1 è¿›å…¥ç¤ºä¾‹ä»£ç ç›®å½•

```bash
cd ~/cloud-atlas/iac/terraform/08-layout/code/workspaces
ls -la
```

```
.
â”œâ”€â”€ main.tf          # S3 Bucket èµ„æº
â”œâ”€â”€ variables.tf     # è¾“å…¥å˜é‡
â”œâ”€â”€ outputs.tf       # è¾“å‡ºå€¼
â””â”€â”€ providers.tf     # Provider é…ç½®
```

### 2.2 åˆ›å»ºå’Œåˆ‡æ¢ Workspaces

```bash
# åˆå§‹åŒ–
terraform init

# æŸ¥çœ‹å½“å‰ workspace
terraform workspace list
```

```
* default
```

```bash
# åˆ›å»ºå¹¶åˆ‡æ¢åˆ° dev workspace
terraform workspace new dev

# åˆ›å»º staging workspace
terraform workspace new staging

# æŸ¥çœ‹æ‰€æœ‰ workspaces
terraform workspace list
```

```
  default
* staging
  dev
```

### 2.3 åœ¨ä¸åŒ Workspace éƒ¨ç½²

```bash
# åˆ‡æ¢åˆ° dev
terraform workspace select dev

# éƒ¨ç½² dev ç¯å¢ƒ
terraform apply -auto-approve
```

```
Outputs:

bucket_name = "demo-bucket-dev-a1b2c3d4"
environment = "dev"
```

```bash
# åˆ‡æ¢åˆ° staging
terraform workspace select staging

# éƒ¨ç½² staging ç¯å¢ƒ
terraform apply -auto-approve
```

```
Outputs:

bucket_name = "demo-bucket-staging-e5f6g7h8"
environment = "staging"
```

**åŒä¸€ä»½ä»£ç ï¼Œä¸¤ä¸ªç‹¬ç«‹çš„ Stateï¼**

---

## Step 3 - å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿï¼ˆ5 åˆ†é’Ÿï¼‰

### 3.1 Workspaces åŸç†

![Workspace State Isolation](images/workspace-state-isolation.png)

<details>
<summary>View ASCII source</summary>

```
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  åŒä¸€ä»½ä»£ç  (main.tf)    â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â–¼               â–¼               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  default state  â”‚ â”‚    dev state    â”‚ â”‚  staging state  â”‚
â”‚ terraform.tfstateâ”‚ â”‚ terraform.tfstateâ”‚ â”‚ terraform.tfstateâ”‚
â”‚   .d/default    â”‚ â”‚     .d/dev      â”‚ â”‚   .d/staging    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â–¼                   â–¼                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AWS Resources  â”‚ â”‚  AWS Resources  â”‚ â”‚  AWS Resources  â”‚
â”‚  (default env)  â”‚ â”‚   (dev env)     â”‚ â”‚  (staging env)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

</details>

### 3.2 State æ–‡ä»¶ä½ç½®

```bash
# æŸ¥çœ‹æœ¬åœ° state ç›®å½•ç»“æ„
ls -la terraform.tfstate.d/
```

```
drwxr-xr-x  dev/
drwxr-xr-x  staging/
```

æ¯ä¸ª workspace æœ‰ç‹¬ç«‹çš„ state æ–‡ä»¶ã€‚

### 3.3 åœ¨ä»£ç ä¸­ä½¿ç”¨ workspace

```hcl
resource "aws_s3_bucket" "demo" {
  bucket = "demo-bucket-${terraform.workspace}-${random_id.suffix.hex}"

  tags = {
    Environment = terraform.workspace
  }
}
```

`terraform.workspace` å˜é‡è‡ªåŠ¨è·å–å½“å‰ workspace åç§°ã€‚

---

## Step 4 - Workspaces çš„å±€é™ï¼ˆ5 åˆ†é’Ÿï¼‰

> Workspaces é€‚åˆç®€å•åœºæ™¯ï¼Œä½†ä¼ä¸šçº§åœºæ™¯æœ‰æ˜æ˜¾å±€é™ã€‚

### 4.1 å±€é™æ€§åˆ†æ

| å±€é™ | è¯´æ˜ | é£é™© |
|------|------|------|
| **åŒä»£ç çº¦æŸ** | æ‰€æœ‰ç¯å¢ƒå¿…é¡»ä½¿ç”¨ç›¸åŒé…ç½® | æ— æ³•ä¸º prod å•ç‹¬é…ç½® |
| **åˆ‡æ¢é£é™©** | éœ€æ‰‹åŠ¨åˆ‡æ¢ workspace | è¯¯æ“ä½œå¯èƒ½å½±å“é”™è¯¯ç¯å¢ƒ |
| **æƒé™éš¾åˆ†ç¦»** | åŒç›®å½•éš¾ä»¥è®¾ç½®ä¸åŒæƒé™ | éš¾ä»¥é™åˆ¶ prod è®¿é—® |
| **CI/CD å¤æ‚** | éœ€åœ¨ pipeline ä¸­åˆ‡æ¢ workspace | å¢åŠ å‡ºé”™å¯èƒ½ |

### 4.2 é€‚ç”¨åœºæ™¯

| åœºæ™¯ | æ¨è |
|------|------|
| ä¸ªäººé¡¹ç›®ã€å°å›¢é˜Ÿ | Workspaces |
| éœ€è¦ç¯å¢ƒå·®å¼‚åŒ–é…ç½® | Directory |
| ä¸¥æ ¼æƒé™åˆ†ç¦»ï¼ˆprod éš”ç¦»ï¼‰ | Directory |
| CI/CD è‡ªåŠ¨åŒ– | Directory |

---

## Step 5 - Directory ç»“æ„ï¼ˆä¼ä¸šçº§ï¼‰ï¼ˆ10 åˆ†é’Ÿï¼‰

> ä¼ä¸šçº§æ¨èï¼šæ¯ç¯å¢ƒç‹¬ç«‹ç›®å½•ã€‚

### 5.1 æŸ¥çœ‹ç›®å½•ç»“æ„

```bash
cd ~/cloud-atlas/iac/terraform/08-layout/code/directory-structure
tree -L 3
```

```
.
â”œâ”€â”€ modules/
â”‚   â””â”€â”€ s3-bucket/
â”‚       â”œâ”€â”€ main.tf
â”‚       â”œâ”€â”€ variables.tf
â”‚       â””â”€â”€ outputs.tf
â”œâ”€â”€ environments/
â”‚   â”œâ”€â”€ dev/
â”‚   â”‚   â”œâ”€â”€ main.tf
â”‚   â”‚   â”œâ”€â”€ variables.tf
â”‚   â”‚   â”œâ”€â”€ terraform.tfvars
â”‚   â”‚   â””â”€â”€ backend.tf
â”‚   â”œâ”€â”€ staging/
â”‚   â”‚   â”œâ”€â”€ main.tf
â”‚   â”‚   â”œâ”€â”€ variables.tf
â”‚   â”‚   â”œâ”€â”€ terraform.tfvars
â”‚   â”‚   â””â”€â”€ backend.tf
â”‚   â””â”€â”€ prod/
â”‚       â”œâ”€â”€ main.tf
â”‚       â”œâ”€â”€ variables.tf
â”‚       â”œâ”€â”€ terraform.tfvars
â”‚       â””â”€â”€ backend.tf
â””â”€â”€ README.md
```

### 5.2 æ¯ç¯å¢ƒç‹¬ç«‹ State

```hcl
# environments/dev/backend.tf
terraform {
  backend "s3" {
    bucket       = "my-terraform-state"
    key          = "dev/terraform.tfstate"    # dev ç‹¬ç«‹è·¯å¾„
    region       = "ap-northeast-1"
    use_lockfile = true  # Terraform 1.10+ åŸç”Ÿ S3 é”å®š
    encrypt      = true
  }
}

# environments/prod/backend.tf
terraform {
  backend "s3" {
    bucket       = "my-terraform-state"
    key          = "prod/terraform.tfstate"   # prod ç‹¬ç«‹è·¯å¾„
    region       = "ap-northeast-1"
    use_lockfile = true  # Terraform 1.10+ åŸç”Ÿ S3 é”å®š
    encrypt      = true
  }
}
```

### 5.3 ç¯å¢ƒå·®å¼‚åŒ–é…ç½®

```hcl
# environments/dev/terraform.tfvars
environment   = "dev"
instance_type = "t3.small"
min_capacity  = 1
max_capacity  = 2

# environments/prod/terraform.tfvars
environment   = "prod"
instance_type = "t3.large"
min_capacity  = 3
max_capacity  = 10
```

### 5.4 éƒ¨ç½²æµç¨‹

```bash
# éƒ¨ç½² dev
cd environments/dev
terraform init
terraform apply

# éƒ¨ç½² prodï¼ˆå®Œå…¨ç‹¬ç«‹ï¼‰
cd ../prod
terraform init
terraform apply
```

**æ— åˆ‡æ¢é£é™©ï¼Œä¸ä¼šè¯¯æ“ä½œï¼**

---

## Step 6 - åˆ†å±‚è®¾è®¡ï¼ˆ10 åˆ†é’Ÿï¼‰

> å¤§å‹é¡¹ç›®éœ€è¦åˆ†å±‚ç®¡ç†ï¼Œé¿å…"ä¸€æ¬¡ apply å…¨éƒ¨"çš„é£é™©ã€‚

### 6.1 åˆ†å±‚åŸåˆ™

![Layered Architecture](images/layered-architecture.png)

<details>
<summary>View ASCII source</summary>

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Layer 3: Application                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚   EC2    â”‚  â”‚   ECS    â”‚  â”‚  Lambda  â”‚      â”‚
â”‚  â”‚Instances â”‚  â”‚ Services â”‚  â”‚Functions â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚            å˜æ›´é¢‘ç¹ | å½±å“èŒƒå›´å°                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â–² ä¾èµ–
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Layer 2: Foundations                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚   RDS    â”‚  â”‚ElastiCache â”‚  â”‚    S3    â”‚    â”‚
â”‚  â”‚Databases â”‚  â”‚  Clusters  â”‚  â”‚ Buckets  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚            å˜æ›´ä¸­ç­‰ | å½±å“èŒƒå›´ä¸­                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â–² ä¾èµ–
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Layer 1: Network                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚   VPC    â”‚  â”‚ Subnets  â”‚  â”‚ Route53  â”‚      â”‚
â”‚  â”‚          â”‚  â”‚  NAT GW  â”‚  â”‚  Zones   â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚            å˜æ›´å°‘ | å½±å“èŒƒå›´å¤§                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

</details>

### 6.2 æŸ¥çœ‹åˆ†å±‚ç›®å½•ç»“æ„

```bash
cd ~/cloud-atlas/iac/terraform/08-layout/code/layered
tree -L 3
```

```
.
â”œâ”€â”€ 01-network/
â”‚   â”œâ”€â”€ dev/
â”‚   â”‚   â”œâ”€â”€ main.tf
â”‚   â”‚   â”œâ”€â”€ outputs.tf
â”‚   â”‚   â””â”€â”€ backend.tf
â”‚   â””â”€â”€ prod/
â”‚       â””â”€â”€ ...
â”œâ”€â”€ 02-foundations/
â”‚   â”œâ”€â”€ dev/
â”‚   â”‚   â”œâ”€â”€ main.tf          # å¼•ç”¨ 01-network çš„ outputs
â”‚   â”‚   â”œâ”€â”€ data.tf          # remote_state æ•°æ®æº
â”‚   â”‚   â””â”€â”€ backend.tf
â”‚   â””â”€â”€ prod/
â”‚       â””â”€â”€ ...
â”œâ”€â”€ 03-application/
â”‚   â”œâ”€â”€ dev/
â”‚   â”‚   â”œâ”€â”€ main.tf          # å¼•ç”¨ 01 å’Œ 02 çš„ outputs
â”‚   â”‚   â”œâ”€â”€ data.tf
â”‚   â”‚   â””â”€â”€ backend.tf
â”‚   â””â”€â”€ prod/
â”‚       â””â”€â”€ ...
â””â”€â”€ README.md
```

### 6.3 è·¨å±‚æ•°æ®å…±äº«

```hcl
# 02-foundations/dev/data.tf
# è¯»å– network å±‚çš„ outputs
data "terraform_remote_state" "network" {
  backend = "s3"
  config = {
    bucket = "my-terraform-state"
    key    = "dev/network/terraform.tfstate"
    region = "ap-northeast-1"
  }
}

# ä½¿ç”¨ network å±‚çš„è¾“å‡º
resource "aws_db_instance" "main" {
  # å¼•ç”¨ network å±‚çš„ subnet IDs
  db_subnet_group_name = data.terraform_remote_state.network.outputs.db_subnet_group_name
  vpc_security_group_ids = [
    data.terraform_remote_state.network.outputs.db_security_group_id
  ]
  # ...
}
```

### 6.4 åˆ†å±‚ä¼˜åŠ¿

| ä¼˜åŠ¿ | è¯´æ˜ |
|------|------|
| **é™ä½çˆ†ç‚¸åŠå¾„** | åº”ç”¨å±‚å˜æ›´ä¸å½±å“ç½‘ç»œå±‚ |
| **å¹¶è¡Œå¼€å‘** | ä¸åŒå›¢é˜Ÿç®¡ç†ä¸åŒå±‚ |
| **å®¡æ‰¹åˆ†ç¦»** | ç½‘ç»œå±‚å˜æ›´éœ€é¢å¤–å®¡æ‰¹ |
| **æ¢å¤ç®€å•** | åªéœ€å›æ»šå—å½±å“çš„å±‚ |

---

## Step 7 - Monorepo vs Polyrepoï¼ˆ5 åˆ†é’Ÿï¼‰

### 7.1 ä¸¤ç§æ–¹å¼å¯¹æ¯”

![Monorepo vs Polyrepo](images/monorepo-vs-polyrepo.png)

<details>
<summary>View ASCII source</summary>

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Monorepo                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ terraform-infrastructure/                 â”‚  â”‚
â”‚  â”‚ â”œâ”€â”€ modules/                              â”‚  â”‚
â”‚  â”‚ â”œâ”€â”€ network/                              â”‚  â”‚
â”‚  â”‚ â”œâ”€â”€ foundations/                          â”‚  â”‚
â”‚  â”‚ â””â”€â”€ applications/                         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  [ç»Ÿä¸€ç‰ˆæœ¬] [åŸå­æäº¤] [æ˜“äºé‡æ„] [ä»“åº“è‡ƒè‚¿] [æƒé™éš¾åˆ†ç¦»] â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Polyrepo                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ tf-network  â”‚ â”‚ tf-database â”‚ â”‚ tf-app-xyzâ”‚  â”‚
â”‚  â”‚ (team-infra)â”‚ â”‚ (team-data) â”‚ â”‚ (team-xyz)â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  [æƒé™æ¸…æ™°] [ç‹¬ç«‹å‘å¸ƒ] [å°å›¢é˜Ÿè‡ªæ²»] [ç‰ˆæœ¬åè°ƒ] [è·¨ä»“åº“å˜æ›´å¤æ‚] â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

</details>

### 7.2 é€‰æ‹©å»ºè®®

| åœºæ™¯ | æ¨è | ç†ç”± |
|------|------|------|
| å°å‹å›¢é˜Ÿï¼ˆ<10äººï¼‰ | Monorepo | ç®€å•ã€ç»Ÿä¸€ |
| å¤§å‹ç»„ç»‡ | Polyrepo | æƒé™ã€è‡ªæ²» |
| å¹³å°å›¢é˜Ÿ + åº”ç”¨å›¢é˜Ÿ | æ··åˆ | å¹³å°ç”¨ Monorepoï¼Œåº”ç”¨ç”¨ Polyrepo |

---

## Step 8 - ç¯å¢ƒæå‡ç­–ç•¥ï¼ˆ5 åˆ†é’Ÿï¼‰

> å¦‚ä½•å°†å˜æ›´ä» dev å®‰å…¨åœ°æ¨è¿›åˆ° prodï¼Ÿ

### 8.1 ä¸¤ç§ç­–ç•¥

![Promotion Strategies](images/promotion-strategies.png)

<details>
<summary>View ASCII source</summary>

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Strategy 1: Branch-based Promotion                  â”‚
â”‚                                                             â”‚
â”‚  feature â”€â”€PRâ”€â”€â–¶ develop â”€â”€PRâ”€â”€â–¶ staging â”€â”€PRâ”€â”€â–¶ main      â”‚
â”‚            (dev)    (dev)    (staging)   (prod)            â”‚
â”‚                                                             â”‚
â”‚          ç®€å•ç›´è§‚ï¼Œä½† main å¯èƒ½ä¸ develop åç¦»               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Strategy 2: Artifact-based Promotion                â”‚
â”‚                                                             â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚              â”‚  main (single branch) â”‚                      â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚                          â–¼                                  â”‚
â”‚    build â”€â”€â–¶ test â”€â”€â–¶ deploy dev â”€â”€â–¶ deploy prod           â”‚
â”‚                          â”‚                                  â”‚
â”‚                          â–¼                                  â”‚
â”‚               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚               â”‚ [versioned artifact] â”‚                      â”‚
â”‚               â”‚       v1.2.3         â”‚                      â”‚
â”‚               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚         å•ä¸€åˆ†æ”¯ï¼Œartifact ç‰ˆæœ¬åŒ–ï¼Œæ›´å¯è¿½æº¯                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

</details>

### 8.2 æ—¥æœ¬ä¼ä¸šå¸¸è§æµç¨‹

åœ¨æ—¥æœ¬ IT ç°åœºï¼Œå˜æ›´ç®¡ç†ï¼ˆå¤‰æ›´ç®¡ç†ï¼‰é€šå¸¸éµå¾ªä¸¥æ ¼çš„å®¡æ‰¹æµç¨‹ï¼š

```
1. å¼€å‘è€…æäº¤ PRï¼ˆå¤‰æ›´ç”³è«‹ï¼‰
2. Plan è¾“å‡ºé™„åˆ° PRï¼ˆå¤‰æ›´å†…å®¹ç¢ºèªï¼‰
3. ãƒ¬ãƒ“ãƒ¥ãƒ¼ + æ‰¿èª
4. dev ç¯å¢ƒ Apply + éªŒè¯
5. æäº¤ staging ç”³è¯·ï¼ˆæœ¬ç•ªå‰ãƒ†ã‚¹ãƒˆï¼‰
6. staging éªŒè¯å®Œæˆ
7. æäº¤ prod ç”³è¯·ï¼ˆæœ¬ç•ªé©ç”¨ï¼‰
8. å¤‰æ›´ç®¡ç†å§”å“¡ä¼šæ‰¿èª
9. prod Applyï¼ˆé€šå¸¸åœ¨æ¥­å‹™æ™‚é–“å¤–ï¼‰
```

> æ—¥æœ¬çš„è¿ç»´ç°åœºï¼Œè¿™å«åšã€Œå¤‰æ›´ç®¡ç†ã€(henkou kanri)ã€‚  
> æ¯æ¬¡ prod å˜æ›´éƒ½éœ€è¦ç•™ä¸‹è¯è¿¹ï¼ˆã‚¨ãƒ“ãƒ‡ãƒ³ã‚¹ï¼‰ã€‚

---

## Step 9 - DRY æ¨¡å¼ï¼šTerragrunt ç®€ä»‹ï¼ˆ5 åˆ†é’Ÿï¼‰

> å½“ Directory ç»“æ„å¯¼è‡´å¤§é‡é‡å¤æ—¶ï¼ŒTerragrunt å¯ä»¥å¸®åŠ©ä¿æŒ DRYã€‚

### 9.1 é—®é¢˜ï¼šé‡å¤çš„ backend é…ç½®

```hcl
# environments/dev/backend.tf
terraform {
  backend "s3" {
    bucket       = "my-terraform-state"
    key          = "dev/terraform.tfstate"     # åªæœ‰è¿™é‡Œä¸åŒ
    region       = "ap-northeast-1"
    use_lockfile = true
    encrypt      = true
  }
}

# environments/staging/backend.tf
terraform {
  backend "s3" {
    bucket       = "my-terraform-state"
    key          = "staging/terraform.tfstate" # åªæœ‰è¿™é‡Œä¸åŒ
    region       = "ap-northeast-1"
    use_lockfile = true
    encrypt      = true
  }
}

# environments/prod/backend.tf
# ... åŒæ ·çš„é‡å¤
```

### 9.2 Terragrunt è§£å†³æ–¹æ¡ˆ

```hcl
# terragrunt.hcl (æ ¹ç›®å½•)
remote_state {
  backend = "s3"
  generate = {
    path      = "backend.tf"
    if_exists = "overwrite_terragrunt"
  }
  config = {
    bucket       = "my-terraform-state"
    key          = "${path_relative_to_include()}/terraform.tfstate"
    region       = "ap-northeast-1"
    use_lockfile = true  # Terraform 1.10+ åŸç”Ÿ S3 é”å®š
    encrypt      = true
  }
}

# environments/dev/terragrunt.hcl
include "root" {
  path = find_in_parent_folders()
}

inputs = {
  environment = "dev"
}
```

### 9.3 Terragrunt åŠŸèƒ½æ¦‚è§ˆ

| åŠŸèƒ½ | è¯´æ˜ |
|------|------|
| **DRY Backend** | è‡ªåŠ¨ç”Ÿæˆ backend.tf |
| **DRY Inputs** | ç»§æ‰¿å’Œè¦†ç›–å˜é‡ |
| **ä¾èµ–ç®¡ç†** | è‡ªåŠ¨æ£€æµ‹å±‚é—´ä¾èµ– |
| **run-all** | ä¸€æ¬¡éƒ¨ç½²å¤šä¸ªç¯å¢ƒ |

### 9.4 æ˜¯å¦ä½¿ç”¨ Terragruntï¼Ÿ

| åœºæ™¯ | å»ºè®® |
|------|------|
| 2-3 ä¸ªç¯å¢ƒ | åŸç”Ÿ Terraform è¶³å¤Ÿ |
| 5+ ç¯å¢ƒ + åˆ†å±‚ | è€ƒè™‘ Terragrunt |
| å›¢é˜Ÿç†Ÿæ‚‰åº¦ä½ | å…ˆæŒæ¡åŸç”Ÿ Terraform |

> æœ¬è¯¾ç¨‹ä¸æ·±å…¥ Terragruntï¼Œä½†äº†è§£å®ƒçš„å­˜åœ¨å¯¹èŒä¸šå‘å±•æœ‰å¸®åŠ©ã€‚  
> å®˜æ–¹æ–‡æ¡£ï¼šhttps://terragrunt.gruntwork.io/

---

## Step 10 - åŠ¨æ‰‹ç»ƒä¹ ï¼šè®¾è®¡å¤šç¯å¢ƒç›®å½•å¸ƒå±€ï¼ˆ10 åˆ†é’Ÿï¼‰

> è¿ç”¨æœ¬è¯¾æ‰€å­¦ï¼Œè®¾è®¡ä¸€ä¸ªä¸‰ç¯å¢ƒç›®å½•ç»“æ„ã€‚

### 10.1 éœ€æ±‚

è®¾è®¡ä¸€ä¸ªåŒ…å«ä»¥ä¸‹å†…å®¹çš„ç›®å½•ç»“æ„ï¼š
- ä¸‰ä¸ªç¯å¢ƒï¼šdev / staging / prod
- å…±äº«æ¨¡å—ï¼šVPCã€S3
- ä¸¤å±‚æ¶æ„ï¼šnetwork + application

### 10.2 å‚è€ƒç­”æ¡ˆ

```
my-infrastructure/
â”œâ”€â”€ modules/
â”‚   â”œâ”€â”€ vpc/
â”‚   â”‚   â”œâ”€â”€ main.tf
â”‚   â”‚   â”œâ”€â”€ variables.tf
â”‚   â”‚   â””â”€â”€ outputs.tf
â”‚   â””â”€â”€ s3-bucket/
â”‚       â”œâ”€â”€ main.tf
â”‚       â”œâ”€â”€ variables.tf
â”‚       â””â”€â”€ outputs.tf
â”œâ”€â”€ layers/
â”‚   â”œâ”€â”€ 01-network/
â”‚   â”‚   â”œâ”€â”€ dev/
â”‚   â”‚   â”‚   â”œâ”€â”€ main.tf
â”‚   â”‚   â”‚   â”œâ”€â”€ variables.tf
â”‚   â”‚   â”‚   â”œâ”€â”€ terraform.tfvars
â”‚   â”‚   â”‚   â””â”€â”€ backend.tf
â”‚   â”‚   â”œâ”€â”€ staging/
â”‚   â”‚   â”‚   â””â”€â”€ ...
â”‚   â”‚   â””â”€â”€ prod/
â”‚   â”‚       â””â”€â”€ ...
â”‚   â””â”€â”€ 02-application/
â”‚       â”œâ”€â”€ dev/
â”‚       â”‚   â”œâ”€â”€ main.tf
â”‚       â”‚   â”œâ”€â”€ data.tf          # remote_state
â”‚       â”‚   â”œâ”€â”€ variables.tf
â”‚       â”‚   â”œâ”€â”€ terraform.tfvars
â”‚       â”‚   â””â”€â”€ backend.tf
â”‚       â”œâ”€â”€ staging/
â”‚       â”‚   â””â”€â”€ ...
â”‚       â””â”€â”€ prod/
â”‚           â””â”€â”€ ...
â””â”€â”€ README.md
```

---

> **ğŸ”¬ è¿›é˜¶å®éªŒ**ï¼šæƒ³åŠ¨æ‰‹éƒ¨ç½² Directory Structure å’Œ Layered Architecture ç¤ºä¾‹ï¼Ÿ  
> â†’ [è¿›é˜¶å®éªŒï¼šå¤šç¯å¢ƒå¸ƒå±€å®è·µ](./lab-advanced.md)ï¼ˆ30-40 åˆ†é’Ÿï¼ŒåŒ…å«å®Œæ•´éªŒè¯æ­¥éª¤ï¼‰

---

## Step 11 - æ¸…ç†èµ„æºï¼ˆ3 åˆ†é’Ÿï¼‰

```bash
# æ¸…ç† workspaces ç¤ºä¾‹
cd ~/cloud-atlas/iac/terraform/08-layout/code/workspaces

# æ¸…ç† staging
terraform workspace select staging
terraform destroy -auto-approve

# æ¸…ç† dev
terraform workspace select dev
terraform destroy -auto-approve

# åˆ é™¤ workspaces
terraform workspace select default
terraform workspace delete staging
terraform workspace delete dev
```

```
Deleted workspace "staging"!
Deleted workspace "dev"!
```

---

## æœ¬è¯¾å°ç»“

| ç­–ç•¥ | é€‚ç”¨åœºæ™¯ | ä¼˜åŠ¿ | åŠ£åŠ¿ |
|------|----------|------|------|
| **Workspaces** | å°å‹é¡¹ç›®ã€ä¸ªäºº | ç®€å•ã€å¿«é€Ÿ | åŒä»£ç çº¦æŸã€åˆ‡æ¢é£é™© |
| **Directory** | ä¼ä¸šçº§ã€å¤šå›¢é˜Ÿ | éš”ç¦»ã€æƒé™åˆ†ç¦» | é…ç½®é‡å¤ |
| **åˆ†å±‚è®¾è®¡** | å¤§å‹é¡¹ç›® | é™ä½çˆ†ç‚¸åŠå¾„ | å¤æ‚åº¦å¢åŠ  |
| **Terragrunt** | è¶…å¤šç¯å¢ƒ | DRY é…ç½® | å­¦ä¹ æˆæœ¬ |

**æ ¸å¿ƒå†³ç­–æµç¨‹**ï¼š

![Decision Flow](images/decision-flow.png)

<details>
<summary>View ASCII source</summary>

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  å¤šç¯å¢ƒéœ€æ±‚?     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â–¼                                 â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ ç¯å¢ƒé…ç½®ç›¸åŒ?  â”‚                 â”‚ é…ç½®éœ€å·®å¼‚åŒ–?  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
            â–¼                                 â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Workspaces   â”‚                 â”‚ Directory ç»“æ„ â”‚
    â”‚  (ç®€å•åœºæ™¯)    â”‚                 â”‚   (ä¼ä¸šçº§)     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                                              â”‚
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â–¼                               â–¼
                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                      â”‚  2-3 ä¸ªç¯å¢ƒ  â”‚                 â”‚  5+ ä¸ªç¯å¢ƒ   â”‚
                      â”‚ åŸç”Ÿ Terraformâ”‚                 â”‚ è€ƒè™‘ Terragruntâ”‚
                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

</details>

---

## ä¸‹ä¸€æ­¥

é¡¹ç›®å¸ƒå±€è®¾è®¡å¥½äº†ï¼Œæ¥ä¸‹æ¥å­¦ä¹ å¦‚ä½•å°†ç°æœ‰èµ„æºå¯¼å…¥ Terraform ç®¡ç†ã€‚

--> [09 - æ—¢å­˜åŸºç¡€è®¾æ–½å¯¼å…¥ (Import)](../09-import/)

---

## é¢è¯•å‡†å¤‡

**ã‚ˆãã‚ã‚‹è³ªå•**

**Q: Workspaces ã¨ Directory structure ã®ä½¿ã„åˆ†ã‘ã¯ï¼Ÿ**

A: Workspaces ã¯åŒä¸€ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ã§ç’°å¢ƒåˆ†é›¢ï¼ˆå°è¦æ¨¡ãƒ»å€‹äººï¼‰ã€‚Directory structure ã¯ç’°å¢ƒã”ã¨ã«ç•°ãªã‚‹è¨­å®šãŒå¯èƒ½ã§ã€æ¨©é™åˆ†é›¢ã‚‚å®¹æ˜“ï¼ˆå¤§è¦æ¨¡ãƒ»ä¼æ¥­ç´šï¼‰ã€‚æœ¬ç•ªç’°å¢ƒã®èª¤æ“ä½œé˜²æ­¢ã«ã¯ Directory ã‚’æ¨å¥¨ã€‚

**Q: å¤šç’°å¢ƒã®å¤‰æ›´ç®¡ç†ã¯ã©ã†ã—ã¦ã„ã¾ã™ã‹ï¼Ÿ**

A: dev --> staging --> prod ã®é †ã§æ®µéšçš„ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã€‚å„ç’°å¢ƒã§ plan ç¢ºèª + ãƒ¬ãƒ“ãƒ¥ãƒ¼ + æ‰¿èªã‚’çµŒã¦ applyã€‚æœ¬ç•ªã¯å¤‰æ›´ç®¡ç†å§”å“¡ä¼šã®æ‰¿èªå¾Œã€æ¥­å‹™æ™‚é–“å¤–ã«å®Ÿæ–½ã€‚

**Q: åˆ†å±¤è¨­è¨ˆï¼ˆLayeringï¼‰ã®ç›®çš„ã¯ï¼Ÿ**

A: çˆ†ç™ºåŠå¾„ï¼ˆBlast Radiusï¼‰ã®ç¸®å°ã€‚ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å±¤ã®å¤‰æ›´ãŒãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å±¤ã«å½±éŸ¿ã—ãªã„ã€‚ãƒãƒ¼ãƒ é–“ã®è²¬ä»»åˆ†é›¢ã‚‚å¯èƒ½ã€‚

**Q: Terragrunt ã‚’ä½¿ã†åˆ¤æ–­åŸºæº–ã¯ï¼Ÿ**

A: 5ç’°å¢ƒä»¥ä¸Š + åˆ†å±¤è¨­è¨ˆã§è¨­å®šã®é‡è¤‡ãŒé¡•è‘—ãªå ´åˆã«æ¤œè¨ã€‚ã¾ãšã¯åŸç”Ÿ Terraform ã‚’ãƒã‚¹ã‚¿ãƒ¼ã™ã‚‹ã“ã¨ã‚’æ¨å¥¨ã€‚

---

## ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

**ã‚ˆãã‚ã‚‹å•é¡Œ**

**Workspace åˆ‡ã‚Šæ›¿ãˆå¿˜ã‚Œ**

```
Error: Resource already exists
```

```bash
# ç¾åœ¨ã® workspace ã‚’ç¢ºèª
terraform workspace show
```

**remote_state ã§ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚‰ãªã„**

```
Error: Unable to find remote state
```

--> ä¾å­˜ã™ã‚‹å±¤ãŒå…ˆã«ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã€‚State ãƒ‘ã‚¹ãŒæ­£ã—ã„ã‹ç¢ºèªã€‚

**Backend è¨­å®šã®å¤‰æ›´ã‚¨ãƒ©ãƒ¼**

```
Error: Backend configuration changed
```

```bash
# Backend å¤‰æ›´æ™‚ã¯ -reconfigure
terraform init -reconfigure
```

**S3 Lifecycle é…ç½®è­¦å‘Šï¼ˆAWS Provider 5.xï¼‰**

```
Warning: Invalid Attribute Combination
No attribute specified when one (and only one) of
[rule[0].filter,rule[0].prefix] is required
```

è¿™æ˜¯ AWS Provider 5.x çš„å˜æ›´ã€‚å³ä½¿è§„åˆ™é€‚ç”¨äºå…¨æ¡¶å¯¹è±¡ï¼Œä¹Ÿéœ€è¦æ˜¾å¼æŒ‡å®š `filter {}`ï¼š

```hcl
resource "aws_s3_bucket_lifecycle_configuration" "example" {
  bucket = aws_s3_bucket.bucket.id
  rule {
    id     = "cleanup"
    status = "Enabled"
    filter {}  # â† å¿…é¡»æ·»åŠ ï¼Œå³ä½¿æ˜¯ç©ºçš„
    expiration {
      days = 30
    }
  }
}
```

> **èƒŒæ™¯**ï¼š2024å¹´9æœˆ Amazon S3 æ›´æ–°äº†å°å¯¹è±¡çš„é»˜è®¤è½¬æ¢è¡Œä¸ºã€‚AWS Provider åœ¨ v5.70.0 åè°ƒæ•´äº†å®ç°ï¼Œè¦æ±‚æ˜¾å¼æŒ‡å®š filter ä»¥é¿å…æ„å¤–è¡Œä¸ºã€‚  
> å‚è€ƒï¼š[GitHub Issue #41710](https://github.com/hashicorp/terraform-provider-aws/issues/41710)

---

## èŒåœºå°è´´å£«

åœ¨æ—¥æœ¬çš„ IT ç°åœºï¼Œå¤šç¯å¢ƒç®¡ç†é€šå¸¸æ¶‰åŠä»¥ä¸‹æ¦‚å¿µï¼š

| æ—¥æœ¬èª | ä¸­æ–‡ | è¯´æ˜ |
|--------|------|------|
| é–‹ç™ºç’°å¢ƒ | å¼€å‘ç¯å¢ƒ | å¼€å‘è€…è‡ªç”±ä½¿ç”¨ |
| æ¤œè¨¼ç’°å¢ƒ | éªŒè¯ç¯å¢ƒ | åŠŸèƒ½æµ‹è¯• |
| ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚° | Staging | æœ¬ç•ªåŒç­‰ç’°å¢ƒã§ã®æœ€çµ‚ç¢ºèª |
| æœ¬ç•ªç’°å¢ƒ | ç”Ÿäº§ç¯å¢ƒ | å®é™…è¿è¡Œ |
| å¤‰æ›´ç®¡ç† | å˜æ›´ç®¡ç† | å˜æ›´å®¡æ‰¹æµç¨‹ |
| æ‰¿èªãƒ•ãƒ­ãƒ¼ | å®¡æ‰¹æµç¨‹ | å¤šçº§å®¡æ‰¹ |

å¤§ä¼ä¸šé€šå¸¸è¦æ±‚ï¼š
- æœ¬ç•ªå¤‰æ›´ã¯äº‹å‰ç”³è«‹å¿…é ˆ
- å¤‰æ›´å†…å®¹ã®è¨¼è·¡ï¼ˆã‚¨ãƒ“ãƒ‡ãƒ³ã‚¹ï¼‰ä¿å­˜
- æ¥­å‹™æ™‚é–“å¤–ã§ã®ä½œæ¥­
- éšœå®³æ™‚ã®åˆ‡ã‚Šæˆ»ã—æ‰‹é †æ›¸

---

## ç³»åˆ—å¯¼èˆª

â† [07 Â· æ¨¡å—åŒ–è®¾è®¡](../07-modules/) | [Home](../) | [09 Â· Import â†’](../09-import/)
