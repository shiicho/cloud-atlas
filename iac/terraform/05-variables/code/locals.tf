# locals.tf
# 本地值定义
#
# locals 用于：
# 1. 计算派生值（避免重复计算）
# 2. 组合多个变量
# 3. 简化复杂表达式
#
# 与 variable 的区别：
# - variable: 外部输入，可以通过 -var 等方式覆盖
# - locals: 内部计算，只能在代码中定义，外部不可覆盖

locals {
  # -------------------------------------------------------------------------
  # 命名前缀
  # -------------------------------------------------------------------------
  # 组合项目名和环境，用于资源命名
  name_prefix = "${var.project}-${var.environment}"

  # -------------------------------------------------------------------------
  # 通用标签
  # -------------------------------------------------------------------------
  # 合并默认标签和用户自定义标签
  common_tags = merge(
    {
      Project     = var.project
      Environment = var.environment
      ManagedBy   = "terraform"
      Lesson      = "05-variables"
    },
    var.extra_tags
  )

  # -------------------------------------------------------------------------
  # 环境特定配置
  # -------------------------------------------------------------------------
  # 根据环境选择实例类型
  instance_type = lookup(var.instance_types, var.environment, "t3.micro")

  # 环境标识
  is_production = var.environment == "prod"

  # -------------------------------------------------------------------------
  # 条件计算
  # -------------------------------------------------------------------------
  # 生产环境启用额外保护
  enable_protection = local.is_production ? true : false

  # 根据环境设置生命周期
  lifecycle_days = var.lifecycle_days > 0 ? var.lifecycle_days : (
    local.is_production ? 365 : 30
  )
}

# -----------------------------------------------------------------------------
# 使用 locals 的好处
# -----------------------------------------------------------------------------
#
# 1. 减少重复：
#    bucket = "${local.name_prefix}-${random_id.suffix.hex}"
#    而不是：
#    bucket = "${var.project}-${var.environment}-${random_id.suffix.hex}"
#
# 2. 集中管理：
#    修改命名规则只需改一处
#
# 3. 可读性：
#    local.is_production 比 var.environment == "prod" 更清晰
#
# 4. 计算缓存：
#    复杂表达式只计算一次
# -----------------------------------------------------------------------------
