# 06 · 云迁移：HULFT Square / AWS VPC 设计

> **目标**：掌握云环境中的 HULFT 部署与现代化方案  
> **前置**：[05 · 作业连携与错误处理](../05-job-integration/)  
> **适用**：日本 SIer/银行 IT 岗位面试准备  
> **时长**：约 60 分钟

## 为什么学习云迁移？

```
日本企业云迁移趋势（クラウドシフト）：

• 政府推动：デジタル庁主导的云优先政策
• 银行跟进：三菱 UFJ、みずほ等大行开始 AWS/Azure 采用
• 混合架构：On-Premises + Cloud 是过渡期常态
• 面试热点：「クラウド環境でのHULFT設計経験は？」
```

## 将完成的内容

1. 理解 HULFT Square vs 传统 HULFT 的区别
2. 设计 AWS VPC 中的 HULFT 部署架构
3. 选择 VPN vs Direct Connect 的场景
4. 了解 HULFT Integrate（云原生 ETL）

---

## Step 1 — HULFT Square 概述

### 什么是 HULFT Square？

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      HULFT Square vs 传统 HULFT                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   传统 HULFT                          HULFT Square                          │
│   ┌─────────────────────┐            ┌─────────────────────┐               │
│   │                     │            │                     │               │
│   │  On-Premises        │            │  SaaS Relay         │               │
│   │  节点对节点直连     │            │  云端中继服务       │               │
│   │                     │            │                     │               │
│   │  • 直接端口开放     │            │  • 无需直接开端口   │               │
│   │  • 防火墙穿透       │            │  • TLS 双向认证     │               │
│   │  • 自建 HA          │            │  • 托管服务         │               │
│   │  • 完全控制         │            │  • 简化运维         │               │
│   │                     │            │                     │               │
│   └─────────────────────┘            └─────────────────────┘               │
│                                                                             │
│   适用：内部系统间                    适用：B2B、多伙伴                     │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### HULFT Square 架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      HULFT Square 中继架构                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   企业 A                    HULFT Square Cloud              企业 B          │
│   ┌─────────┐              ┌─────────────────┐            ┌─────────┐     │
│   │         │   出站       │                 │   出站     │         │     │
│   │ HULFT   │ ──HTTPS───→ │   中继服务      │ ←──HTTPS── │ HULFT   │     │
│   │ Agent   │              │   (SaaS)        │            │ Agent   │     │
│   │         │              │                 │            │         │     │
│   └─────────┘              │  • 路由管理     │            └─────────┘     │
│       ↑                    │  • 证书管理     │                ↑           │
│       │                    │  • 审计日志     │                │           │
│   无需入站                 └─────────────────┘            无需入站        │
│   开放端口                                                开放端口        │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘

优势：
• 双方都只需出站 HTTPS (443)
• 无需协调防火墙规则
• 托管 TLS 证书
• 适合多伙伴场景
```

### 传统 vs Square 选择

| 场景 | 推荐方案 | 原因 |
|------|----------|------|
| 内部系统间传输 | 传统 HULFT | 完全控制、低延迟 |
| 单一可信伙伴 | 传统 + VPN | 成本更低 |
| 多个外部伙伴 | HULFT Square | 避免维护多个 VPN 隧道 |
| 伙伴无法管理 FW | HULFT Square | 只需出站 HTTPS |
| 快速对接新伙伴 | HULFT Square | 无需 FW 变更申请 |

---

## Step 2 — AWS VPC 中的 HULFT 架构

### 推荐架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      AWS VPC HULFT 高可用架构                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│                              VPC (10.0.0.0/16)                              │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                                                                     │   │
│   │   Private Subnet (AZ-a)           Private Subnet (AZ-c)            │   │
│   │   10.0.1.0/24                     10.0.2.0/24                      │   │
│   │   ┌─────────────────┐             ┌─────────────────┐              │   │
│   │   │                 │             │                 │              │   │
│   │   │  HULFT Primary  │             │  HULFT Standby  │              │   │
│   │   │  (EC2)          │             │  (EC2)          │              │   │
│   │   │  10.0.1.10      │             │  10.0.2.10      │              │   │
│   │   │                 │             │                 │              │   │
│   │   └────────┬────────┘             └────────┬────────┘              │   │
│   │            │                               │                       │   │
│   │            └───────────┬───────────────────┘                       │   │
│   │                        │                                           │   │
│   │                 ┌──────┴──────┐                                    │   │
│   │                 │     NLB     │  ← Network Load Balancer           │   │
│   │                 │             │    (内部用、非公开)                 │   │
│   │                 └──────┬──────┘                                    │   │
│   │                        │                                           │   │
│   └────────────────────────┼───────────────────────────────────────────┘   │
│                            │                                               │
│                     ┌──────┴──────┐                                        │
│                     │   VPN GW    │  或 Direct Connect                     │
│                     │   / DX GW   │                                        │
│                     └──────┬──────┘                                        │
│                            │                                               │
└────────────────────────────┼───────────────────────────────────────────────┘
                             │
                      On-Premises
                      ┌─────────────┐
                      │ HULFT Node  │
                      └─────────────┘
```

### 关键设计要点

```
✅ 安全设计：

1. 私有子网部署
   • HULFT 实例无公网 IP
   • 只能通过 VPN/DX 访问
   • 避免 8594/8500 公网暴露

2. SSM 管理访问
   • 无需 Bastion Host
   • 通过 Session Manager 登录
   • 无需 SSH 密钥管理

3. Security Group 最小权限
   • 只允许特定源 IP 访问 8594/8500
   • 管理端口限制为 SSM

4. Multi-AZ 高可用
   • Primary/Standby 分布在不同 AZ
   • NLB 自动故障转移
```

### Security Group 配置

```
# HULFT Security Group

Inbound Rules:
┌──────────────────────────────────────────────────────────────────────────┐
│ Type        │ Port   │ Source                    │ Description          │
├──────────────────────────────────────────────────────────────────────────┤
│ Custom TCP  │ 8594   │ On-Prem CIDR (10.1.0.0/16)│ HULFT Control        │
│ Custom TCP  │ 8500   │ On-Prem CIDR (10.1.0.0/16)│ HULFT Data           │
│ Custom TCP  │ 8594   │ Self (HULFT SG)           │ HULFT HA Sync        │
│ Custom TCP  │ 8500   │ Self (HULFT SG)           │ HULFT HA Sync        │
└──────────────────────────────────────────────────────────────────────────┘

Outbound Rules:
┌──────────────────────────────────────────────────────────────────────────┐
│ Type        │ Port   │ Destination               │ Description          │
├──────────────────────────────────────────────────────────────────────────┤
│ Custom TCP  │ 8594   │ On-Prem CIDR (10.1.0.0/16)│ HULFT Control        │
│ Custom TCP  │ 8500   │ On-Prem CIDR (10.1.0.0/16)│ HULFT Data           │
│ HTTPS       │ 443    │ 0.0.0.0/0                 │ SSM, Updates         │
└──────────────────────────────────────────────────────────────────────────┘

⚠️ 绝对不要：
   • Inbound 0.0.0.0/0 到 8594/8500
   • 公网 IP 直接暴露 HULFT 端口
```

> 💡 **面试要点 #1**
>
> **问题**：「AWSでHULFTノードを配置する際、8594/8500ポートを公開しないようにするにはどうしますか？」
>
> （中文参考：在 AWS 中部署 HULFT 节点时，如何避免公开暴露 8594/8500 端口？）
>
> **期望回答**：
> - 私有子网部署，无公网 IP
> - 通过 SSM 管理访问（无需 Bastion）
> - NLB 或 Transit Gateway 进行内部路由
> - Security Group 限制 8594/8500 只允许特定对端
> - 通过 VPN 或 Direct Connect 连接 On-Premises

---

## Step 3 — VPN vs Direct Connect

### 连接选项对比

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    VPN vs Direct Connect 对比                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   Site-to-Site VPN                    Direct Connect (DX)                   │
│   ┌─────────────────────┐            ┌─────────────────────┐               │
│   │                     │            │                     │               │
│   │  ┌───┐   Internet   │            │  ┌───┐  专用线路    │               │
│   │  │VPN├──~~~~~~~~~~~─┤            │  │ DX├─────────────┤               │
│   │  │ GW│   加密隧道   │            │  │ GW│  物理连接   │               │
│   │  └───┘              │            │  └───┘             │               │
│   │                     │            │                     │               │
│   │  优点：             │            │  优点：             │               │
│   │  • 快速部署         │            │  • 稳定带宽         │               │
│   │  • 成本低           │            │  • 低延迟           │               │
│   │  • 默认加密         │            │  • 可预测性能       │               │
│   │                     │            │                     │               │
│   │  缺点：             │            │  缺点：             │               │
│   │  • 延迟/抖动较高    │            │  • 成本高           │               │
│   │  • 带宽有限         │            │  • 部署周期长       │               │
│   │  • 网络质量依赖 ISP │            │  • 需要物理施工     │               │
│   │                     │            │                     │               │
│   └─────────────────────┘            └─────────────────────┘               │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 详细对比

| 特性 | Site-to-Site VPN | Direct Connect |
|------|------------------|----------------|
| **部署时间** | 数小时 | 数周~数月 |
| **月成本** | ~$50/隧道 | $200+/端口 + 线路费 |
| **带宽** | 最大 1.25 Gbps | 1/10/100 Gbps |
| **延迟** | 变化大（网络依赖） | 稳定低延迟 |
| **抖动** | 较高 | 极低 |
| **加密** | 默认 IPSec | 需额外配置 |
| **可用性** | 双隧道 Active/Passive | 双 DX 或 DX+VPN 备份 |

### HULFT 传输场景选择

```
场景 1：开发/测试环境
────────────────────────
推荐：VPN
原因：
• 成本低
• 数据量小
• 延迟要求不高

场景 2：生产日次批处理
────────────────────────
推荐：Direct Connect
原因：
• 固定批处理窗口（23:00-06:00）
• 大数据量（数 GB）
• 必须按时完成

场景 3：混合（推荐银行）
────────────────────────
推荐：DX Primary + VPN Backup
原因：
• DX 提供稳定性能
• VPN 作为灾备
• 符合银行 BCP 要求
```

### VPN 下的 HULFT 调优

```bash
# VPN 环境下常见问题和调优

问题 1：延迟导致超时
────────────────────
解决：增加超时时间
SEND_TIMEOUT=600      # 从默认 300 增加
ACK_TIMEOUT=120       # 从默认 60 增加

问题 2：抖动导致频繁重试
────────────────────────
解决：增加重试间隔
RETRY_INTERVAL=180    # 从默认 60 增加
RETRY_COUNT=5         # 适当增加重试次数

问题 3：MTU 不匹配
────────────────────
症状：大文件传输失败，小文件正常
原因：VPN overhead 减少 MTU（1500→1400）
解决：
  - 检查 MTU: ping -M do -s 1472 <peer>
  - 配置 MSS Clamping
  - 或在 HULFT 侧减小 block size
```

> 💡 **面试要点 #2**
>
> **问题**：「Direct ConnectとVPNでHULFTを運用する場合、それぞれどのような考慮事項がありますか？」
>
> （中文参考：通过 Direct Connect 和 VPN 运行 HULFT 时，各有什么注意事项？）
>
> **期望回答**：
> - **DX**：稳定带宽、低延迟，适合批处理窗口
> - **VPN**：抖动较高，需调整重试超时
> - 两者都需检查 MTU（可能需要 MSS Clamp）
> - 推荐双 DX 或 DX+VPN 备份以保证可用性

---

## Step 4 — HULFT Square vs VPN 选择

### 决策流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                   HULFT Square vs VPN 决策流程                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│                        需要与外部伙伴传输？                                  │
│                              │                                              │
│                    ┌─────────┴─────────┐                                    │
│                    │                   │                                    │
│                   Yes                  No                                   │
│                    │                   │                                    │
│                    ▼                   ▼                                    │
│            伙伴数量多少？          内部系统 → 传统 HULFT + VPN/DX           │
│                    │                                                        │
│          ┌─────────┴─────────┐                                              │
│          │                   │                                              │
│       1-2 个伙伴         3+ 个伙伴                                          │
│          │                   │                                              │
│          ▼                   ▼                                              │
│   伙伴能管理 FW？      HULFT Square                                         │
│          │              (避免维护多个 VPN)                                  │
│    ┌─────┴─────┐                                                            │
│    │           │                                                            │
│   Yes          No                                                           │
│    │           │                                                            │
│    ▼           ▼                                                            │
│  VPN/DX    HULFT Square                                                     │
│  (成本低)  (伙伴只需出站 HTTPS)                                             │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 成本对比示例

```
场景：与 5 个外部伙伴传输

方案 A：传统 HULFT + 5 个 VPN
────────────────────────────────
• 5 × VPN 隧道: $250/月
• 5 × FW 变更工时: 初期成本高
• 维护：5 套 VPN 监控

方案 B：HULFT Square
────────────────────────────────
• Square 订阅: ~$XXX/月（按伙伴/流量）
• FW 变更：0（只需出站 443）
• 维护：统一管理界面

结论：
• 伙伴少 → VPN 更便宜
• 伙伴多 → Square 运维成本更低
• 伙伴不配合 FW → Square 唯一选择
```

> 💡 **面试要点 #3**
>
> **问题**：「パートナー接続において、Site-to-Site VPNではなくHULFT Squareを選択するのはどのような場合ですか？」
>
> （中文参考：在伙伴连接中，什么情况下选择 HULFT Square 而不是 Site-to-Site VPN？）
>
> **期望回答**：
> - **HULFT Square 选择场景**：
>   - 多个外部伙伴（避免多 VPN 隧道）
>   - 伙伴无法/不愿管理防火墙规则
>   - 需要托管 TLS 证书
>   - 多租户或 B2B 场景
> - **VPN 选择场景**：
>   - 单一可信伙伴
>   - 需要完全控制配置
>   - 成本敏感

---

## Step 5 — HULFT Integrate 简介

### 什么是 HULFT Integrate？

```
HULFT Integrate = iPaaS / ETL 产品

┌─────────────────────────────────────────────────────────────────────────────┐
│                      HULFT Integrate 定位                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   HULFT (传统)              HULFT Integrate                                 │
│   ┌─────────────────┐      ┌─────────────────────────────────────────┐     │
│   │                 │      │                                         │     │
│   │  文件传输       │      │  数据集成平台                           │     │
│   │  A → B          │      │                                         │     │
│   │                 │      │  • 工作流设计器                         │     │
│   │  Store-and-     │      │  • 数据映射/转换                        │     │
│   │  Forward        │      │  • 多数据源连接器                       │     │
│   │                 │      │    (SAP, Salesforce, DB, REST...)      │     │
│   │                 │      │  • 云原生部署                           │     │
│   │                 │      │                                         │     │
│   └─────────────────┘      └─────────────────────────────────────────┘     │
│                                                                             │
│   类似竞品：Talend, Informatica, AWS Glue, Azure Data Factory              │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 使用场景

```
场景：复杂 ETL + 文件传输

传统方式：
┌─────┐    ┌─────┐    ┌─────┐    ┌─────┐
│ SAP │───→│ ETL │───→│HULFT│───→│ DWH │
│     │    │脚本 │    │     │    │     │
└─────┘    └─────┘    └─────┘    └─────┘
           (自建)

HULFT Integrate：
┌─────┐    ┌─────────────────────────────┐    ┌─────┐
│ SAP │───→│      HULFT Integrate        │───→│ DWH │
│     │    │  (ETL + Transfer 一体化)    │    │     │
└─────┘    └─────────────────────────────┘    └─────┘
```

### 何时考虑 Integrate

| 场景 | 传统 HULFT | HULFT Integrate |
|------|------------|-----------------|
| 简单文件传输 | ✅ 足够 | 过度设计 |
| 需要数据转换 | 需配合脚本 | ✅ 内置 |
| 多数据源集成 | 需要开发 | ✅ 连接器 |
| 云原生架构 | 需要改造 | ✅ 原生支持 |
| 成本敏感 | ✅ 更便宜 | 订阅费较高 |

---

## Step 6 — 实践：设计 AWS HULFT 架构

### 练习：架构设计

**场景**：设计一个符合以下要求的架构：

```
要求：
1. AWS 上部署 HULFT 节点
2. 与 On-Premises 核心系统连接
3. 与 2 个外部银行伙伴连接
4. 高可用（Multi-AZ）
5. 符合银行安全标准
```

### 设计步骤

```
Step 1: 确定网络架构
─────────────────────
□ VPC CIDR 规划
□ 子网划分（Public/Private/每个 AZ）
□ 路由表设计

Step 2: 确定连接方式
─────────────────────
□ On-Prem 连接：DX + VPN Backup
□ 外部伙伴：HULFT Square（2+ 伙伴）

Step 3: 安全设计
─────────────────────
□ Security Group 规则
□ NACL 规则（可选）
□ IAM 角色（SSM 访问）

Step 4: 高可用设计
─────────────────────
□ Multi-AZ 部署
□ NLB 配置
□ 故障转移机制

Step 5: 监控告警
─────────────────────
□ CloudWatch 指标
□ 日志收集
□ 告警设置
```

### 参考架构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        完整架构设计                                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   外部银行 A ──┐                                                            │
│               │      ┌─────────────────┐                                   │
│   外部银行 B ──┼─────→│  HULFT Square   │                                   │
│               │      │  (SaaS)         │                                   │
│               │      └────────┬────────┘                                   │
│                               │ HTTPS                                       │
│                               ▼                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                           AWS VPC                                    │   │
│   │  ┌─────────────────────────────────────────────────────────────┐    │   │
│   │  │                     Private Subnets                          │    │   │
│   │  │   ┌─────────────┐              ┌─────────────┐              │    │   │
│   │  │   │ HULFT       │              │ HULFT       │              │    │   │
│   │  │   │ Primary     │◄────────────►│ Standby     │              │    │   │
│   │  │   │ (AZ-a)      │    Sync      │ (AZ-c)      │              │    │   │
│   │  │   └──────┬──────┘              └──────┬──────┘              │    │   │
│   │  │          │                            │                      │    │   │
│   │  │          └────────────┬───────────────┘                      │    │   │
│   │  │                       │                                      │    │   │
│   │  │                ┌──────┴──────┐                               │    │   │
│   │  │                │     NLB     │                               │    │   │
│   │  │                └──────┬──────┘                               │    │   │
│   │  └───────────────────────┼──────────────────────────────────────┘    │   │
│   │                          │                                           │   │
│   │   ┌──────────────────────┼──────────────────────────────────────┐    │   │
│   │   │         Transit Gateway / VPN + DX Gateway                   │    │   │
│   │   └──────────────────────┼──────────────────────────────────────┘    │   │
│   └──────────────────────────┼───────────────────────────────────────────┘   │
│                              │                                               │
│                    ┌─────────┴─────────┐                                     │
│                    │                   │                                     │
│             Direct Connect           VPN                                     │
│             (Primary)              (Backup)                                  │
│                    │                   │                                     │
│                    └─────────┬─────────┘                                     │
│                              │                                               │
│                    ┌─────────┴─────────┐                                     │
│                    │   On-Premises     │                                     │
│                    │   HULFT Core      │                                     │
│                    └───────────────────┘                                     │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 设计文档模板

```yaml
# HULFT AWS 架构设计文档

## 1. 概要
project_name: "银行文件传输云迁移"
environment: production
region: ap-northeast-1

## 2. 网络设计
vpc:
  cidr: "10.0.0.0/16"
  subnets:
    private_a: "10.0.1.0/24"
    private_c: "10.0.2.0/24"

## 3. 连接设计
on_premises:
  primary: "Direct Connect 1Gbps"
  backup: "Site-to-Site VPN"
external_partners:
  method: "HULFT Square"
  partners: ["Bank A", "Bank B"]

## 4. 安全设计
security_groups:
  hulft_sg:
    inbound:
      - port: 8594
        source: "10.1.0.0/16"  # On-Prem
      - port: 8500
        source: "10.1.0.0/16"
    outbound:
      - port: 443
        destination: "0.0.0.0/0"  # SSM, Square

## 5. 高可用设计
availability:
  multi_az: true
  nlb: true
  failover: "automatic"

## 6. 监控
monitoring:
  cloudwatch_metrics: true
  log_group: "/hulft/production"
  alerts:
    - name: "Transfer Failed"
      metric: "RC >= 8"
      action: "SNS → Ops Team"
```

---

## 常见错误

| 错误 | 后果 | 预防 |
|------|------|------|
| 公网暴露 8594/8500 | 安全风险 | 私有子网 + VPN/DX |
| 单 AZ 部署 | 无高可用 | Multi-AZ + NLB |
| VPN 抖动未调优 | 频繁重试超时 | 调整 timeout/retry |
| MTU 不匹配 | 大文件传输失败 | MSS Clamp |

---

## 小结

| 主题 | 要点 |
|------|------|
| HULFT Square | SaaS 中继，适合多伙伴 B2B |
| AWS VPC | 私有子网、SSM 管理、Multi-AZ |
| VPN vs DX | VPN 快速低成本，DX 稳定高性能 |
| 选择策略 | 伙伴多→Square，内部→VPN/DX |
| Integrate | iPaaS 产品，复杂 ETL 场景 |

---

## 系列总结

恭喜完成 HULFT 入门系列！

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      HULFT 系列学习路径回顾                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   00 概念与架构 ──→ 01 网络与安全 ──→ 02 安装配置                          │
│        │                │                  │                                │
│   Store-and-Forward   端口/FW/账户      Lab 搭建                           │
│   术语（集信/配信）   NAT Hairpin       节点配置                            │
│                                                                             │
│        ↓                                                                    │
│                                                                             │
│   03 字符编码 ────→ 04 集信/配信 ────→ 05 作业联动                         │
│        │                │                  │                                │
│   SJIS/UTF-8/EBCDIC   重试/去重          JP1 集成                          │
│   文字化け防止        転送グループ       RC 处理                            │
│                                                                             │
│        ↓                                                                    │
│                                                                             │
│   06 云迁移 ────────────────────────────────────────────────               │
│        │                                                                    │
│   HULFT Square / AWS VPC / VPN vs DX                                       │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘

📝 面试准备：每课都有 💡 面试要点，复习这些问答！
🎯 实践建议：搭建 2 节点 Lab 实际操作
🚀 下一步：挑战银行 IT 岗位面试！
```

---

## 系列导航 / Series Nav

| 课程 | 主题 |
|------|------|
| 00 · 概念与架构 | Store-and-Forward, 术语 |
| 01 · 网络与安全 | 端口、防火墙、服务账户 |
| 02 · 安装配置 | HULFT8 双节点 Lab |
| 03 · 字符编码 | SJIS↔UTF-8, EBCDIC |
| 04 · 集信/配信实战 | 传输组、重试机制 |
| 05 · 作业联动 | JP1 集成、日志分析 |
| **06 · 云迁移** | ← 当前课程（最终课） |
