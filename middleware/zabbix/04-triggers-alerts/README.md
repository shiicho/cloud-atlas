# 04 Â· è§¦å‘å™¨ä¸å‘Šè­¦é€šçŸ¥ï¼ˆTriggers & Alertsï¼‰

> **ç›®æ ‡**ï¼šé…ç½®è§¦å‘å™¨ã€é‚®ä»¶é€šçŸ¥å’Œç»´æŠ¤çª—å£  
> **å‰ç½®**ï¼š[03 Â· åŸºç¡€ç›‘æ§ + æ­»æ´»æ£€æŸ¥](../03-monitoring-basics/)  
> **è´¹ç”¨**ï¼šå®éªŒç¯å¢ƒæŒç»­äº§ç”Ÿè´¹ç”¨ï¼ˆçº¦ $0.03/å°æ—¶ï¼‰ï¼›å®Œæˆç³»åˆ—åè¯·åˆ é™¤å †æ ˆ  
> **æ—¶é—´**ï¼š30-35 åˆ†é’Ÿ  
> **å®æˆ˜é¡¹ç›®**ï¼šé…ç½®ç£ç›˜å‘Šè­¦ + Golden Week ç»´æŠ¤çª—å£

## å°†å­¦åˆ°çš„å†…å®¹

1. åˆ›å»ºè‡ªå®šä¹‰è§¦å‘å™¨
2. ç†è§£ Severity çº§åˆ«å’Œä¾èµ–å…³ç³»
3. é…ç½® Email é€šçŸ¥
4. åˆ›å»º Actionï¼ˆè§¦å‘å™¨ â†’ é€šçŸ¥ï¼‰
5. è®¾ç½®ç»´æŠ¤çª—å£ï¼ˆMaintenance Windowï¼‰
6. å®è·µå‘Šè­¦ç¡®è®¤ï¼ˆAcknowledgmentï¼‰

---

## Step 1 â€” åˆ›å»ºè‡ªå®šä¹‰è§¦å‘å™¨

### 1.1 è§¦å‘å™¨å·¥ä½œåŸç†

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Trigger å·¥ä½œæµç¨‹                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  Item é‡‡é›†æ•°æ®                                               â”‚
â”‚       â”‚                                                      â”‚
â”‚       â–¼                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚ Expression è¯„ä¼° â”‚â”€â”€â”€â”€â–ºâ”‚ çŠ¶æ€: OK/PROBLEM â”‚               â”‚
â”‚  â”‚ last() < 20     â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚                          â”‚
â”‚                                   â–¼                          â”‚
â”‚                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚                         â”‚ Event ç”Ÿæˆ      â”‚                  â”‚
â”‚                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                                   â”‚                          â”‚
â”‚                                   â–¼                          â”‚
â”‚                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚                         â”‚ Action æ‰§è¡Œ     â”‚                  â”‚
â”‚                         â”‚ (å‘é€é€šçŸ¥)      â”‚                  â”‚
â”‚                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 åˆ›å»ºç£ç›˜ç©ºé—´è§¦å‘å™¨

> ğŸ’¡ **æ¨¡æ¿å·²åŒ…å«è§¦å‘å™¨**ï¼š  
> `Linux by Zabbix agent active` æ¨¡æ¿å·²å†…ç½®ç£ç›˜ç©ºé—´è§¦å‘å™¨ï¼ˆ`FS [/]: Space is critically low`ã€`FS [/]: Space is low`ï¼‰ã€‚  
> æœ¬èŠ‚åˆ›å»ºè‡ªå®šä¹‰è§¦å‘å™¨æ˜¯ä¸ºäº†**å­¦ä¹ è§¦å‘å™¨é…ç½®æµç¨‹**ã€‚ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œä¼˜å…ˆä½¿ç”¨æˆ–ä¿®æ”¹æ¨¡æ¿å†…ç½®è§¦å‘å™¨ã€‚

1. ã€ŒData collectionã€â†’ã€ŒHostsã€â†’ ç‚¹å‡» `monitored-host-01`
2. åˆ‡æ¢åˆ°ã€ŒTriggersã€æ ‡ç­¾é¡µ
3. ç‚¹å‡»ã€ŒCreate triggerã€

**åŸºæœ¬é…ç½®**ï¼š

| å­—æ®µ | å€¼ |
|------|-----|
| Name | `Disk space is low on {HOST.NAME} ({ITEM.LASTVALUE})` |
| Severity | `Warning` |
| Expression | è§ä¸‹æ–¹ |

**æ„å»º Expression**ï¼š

ç‚¹å‡»ã€ŒAddã€æ‰“å¼€è¡¨è¾¾å¼æ„å»ºå™¨ï¼š

| å­—æ®µ | å€¼ |
|------|-----|
| Item | `FS [/]: Space: Used, in %` |
| Function | `last()` |
| Result | `>=80` |

å®Œæ•´è¡¨è¾¾å¼ç¤ºä¾‹ï¼š
```
last(/monitored-host-01/vfs.fs.dependent.size[/,pused])>=80
```

> ğŸ’¡ **Item Key è¯´æ˜**ï¼š  
> `Linux by Zabbix agent active` æ¨¡æ¿ä½¿ç”¨ Dependent Item Discovery æ¨¡å¼ï¼Œç£ç›˜ç©ºé—´ç™¾åˆ†æ¯”çš„ Key æ˜¯ `vfs.fs.dependent.size[/,pused]`ï¼ˆæ³¨æ„ `dependent` å‰ç¼€ï¼‰ï¼Œè€Œä¸æ˜¯æ—§ç‰ˆçš„ `vfs.fs.size[/,pused]`ã€‚

**Recovery expression**ï¼ˆé˜²æ­¢ Flappingï¼‰ï¼š
```
last(/monitored-host-01/vfs.fs.dependent.size[/,pused])<75
```

> ğŸ’¡ **Hysteresisï¼ˆæ»åï¼‰**ï¼šProblem é˜ˆå€¼ 80%ï¼ŒRecovery é˜ˆå€¼ 75%ï¼Œé¿å…åœ¨ä¸´ç•Œå€¼é™„è¿‘åå¤è§¦å‘

4. ç‚¹å‡»ã€ŒAddã€

### 1.3 åˆ›å»º High çº§åˆ«è§¦å‘å™¨ï¼ˆç”¨äºé‚®ä»¶æµ‹è¯•ï¼‰

> ğŸ’¡ **ä¸ºä»€ä¹ˆéœ€è¦ä¸¤ä¸ªè§¦å‘å™¨ï¼Ÿ**  
> - Warning (80%): æ—©æœŸé¢„è­¦ï¼Œè¿ç»´äººå‘˜å…³æ³¨  
> - High (90%): ç´§æ€¥å‘Šè­¦ï¼Œè§¦å‘é‚®ä»¶é€šçŸ¥  
>
> åç»­ Step 4 ä¼šé…ç½®é€šçŸ¥è§„åˆ™ï¼ˆActionï¼‰ï¼Œè®¾ä¸º `Severity >= High`ï¼Œåªæœ‰ High çº§åˆ«ä»¥ä¸Šæ‰ä¼šå‘é€é‚®ä»¶ã€‚

é‡å¤ä¸Šè¿°æ­¥éª¤åˆ›å»ºç¬¬äºŒä¸ªè§¦å‘å™¨ï¼š

| å­—æ®µ | å€¼ |
|------|-----|
| Name | `Disk space is critically low on {HOST.NAME} ({ITEM.LASTVALUE})` |
| Severity | `High` |
| Expression | `last(/monitored-host-01/vfs.fs.dependent.size[/,pused])>=90` |
| Recovery expression | `last(/monitored-host-01/vfs.fs.dependent.size[/,pused])<85` |

ç‚¹å‡»ã€ŒAddã€å®Œæˆåˆ›å»ºã€‚

> âœ… **éªŒè¯**ï¼šã€ŒData collectionã€â†’ã€ŒHostsã€â†’ ç‚¹å‡» Host â†’ã€ŒTriggersã€æ ‡ç­¾é¡µï¼Œç¡®è®¤ä¸¤ä¸ªè§¦å‘å™¨å·²åˆ›å»ºã€‚

**è§¦å‘å™¨æ€»ç»“**ï¼š

| è§¦å‘å™¨ | é˜ˆå€¼ | Severity | é‚®ä»¶é€šçŸ¥ |
|--------|------|----------|----------|
| Disk space is low | >= 80% | Warning | âŒ |
| Disk space is critically low | >= 90% | High | âœ… |

### 1.4 Severity çº§åˆ«

| çº§åˆ« | é¢œè‰² | ç”¨é€” |
|------|------|------|
| Not classified | ç°è‰² | æœªåˆ†ç±» |
| Information | æµ…è“ | ä¿¡æ¯æç¤º |
| Warning | é»„è‰² | è­¦å‘Šï¼Œéœ€å…³æ³¨ |
| Average | æ©™è‰² | ä¸€èˆ¬ä¸¥é‡ |
| High | çº¢è‰² | ä¸¥é‡é—®é¢˜ |
| Disaster | æ·±çº¢ | ç¾éš¾çº§åˆ« |

> ğŸ‡¯ğŸ‡µ **æ—¥æœ¬ IT ç¾å ´ã§ã®å¯¾å¿œãƒ¬ãƒ™ãƒ«**ï¼š  
>
> | Severity | å¯¾å¿œåŒºåˆ† | SLAç›®å®‰ | é€šçŸ¥æ–¹æ³• |  
> |----------|---------|---------|----------|  
> | Disaster | é‡å¤§éšœå®³ï¼ˆP1ï¼‰ | å³æ™‚å¯¾å¿œ | é›»è©±é€£çµ¡å¿…é ˆ |  
> | High | ç·Šæ€¥éšœå®³ï¼ˆP2ï¼‰ | 15åˆ†ä»¥å†… | SMS + ãƒãƒ£ãƒƒãƒˆ |  
> | Average | é€šå¸¸éšœå®³ï¼ˆP3ï¼‰ | 1æ™‚é–“ä»¥å†… | ãƒ¡ãƒ¼ãƒ« + ãƒã‚±ãƒƒãƒˆ |  
> | Warning | è»½å¾®ï¼ˆP4ï¼‰ | ç¿Œå–¶æ¥­æ—¥ | ãƒ¡ãƒ¼ãƒ«ã®ã¿ |

---

## Step 2 â€” ç†è§£è§¦å‘å™¨ä¾èµ–

### 2.1 ä¾èµ–å…³ç³»åœºæ™¯

```
åœºæ™¯ï¼šç½‘ç»œè®¾å¤‡æ•…éšœå¯¼è‡´æ‰€æœ‰æœåŠ¡å™¨ä¸å¯è¾¾

ä¸ä½¿ç”¨ä¾èµ–ï¼š
  - Switch down â† è§¦å‘
  - Server A unreachable â† è§¦å‘
  - Server B unreachable â† è§¦å‘
  - Server C unreachable â† è§¦å‘
  = å¤§é‡é‡å¤å‘Šè­¦ï¼

ä½¿ç”¨ä¾èµ–ï¼š
  - Switch down â† è§¦å‘
  - Server A unreachable â† è¢«æŠ‘åˆ¶ï¼ˆä¾èµ– Switchï¼‰
  - Server B unreachable â† è¢«æŠ‘åˆ¶
  - Server C unreachable â† è¢«æŠ‘åˆ¶
  = åªæ”¶åˆ° 1 ä¸ªå‘Šè­¦
```

### 2.2 é…ç½®ä¾èµ–

1. ç¼–è¾‘ Trigger
2. åˆ‡æ¢åˆ°ã€ŒDependenciesã€æ ‡ç­¾é¡µ
3. ç‚¹å‡»ã€ŒAddã€é€‰æ‹©çˆ¶è§¦å‘å™¨
4. ä¿å­˜

> ğŸ’¡ **Lab ç¯å¢ƒé™åˆ¶**ï¼šæœ¬å®éªŒç¯å¢ƒä¸ºåŒä¸»æœºç»“æ„ï¼Œéš¾ä»¥æ¼”ç¤ºçœŸå®çš„å¤šå±‚ä¾èµ–åœºæ™¯ã€‚  
>
> **ç”Ÿäº§ç¯å¢ƒå…¸å‹ç”¨ä¾‹**ï¼š  
>
> | æ¨¡å¼ | çˆ¶è§¦å‘å™¨ | å­è§¦å‘å™¨ | æ•ˆæœ |  
> |------|----------|----------|------|  
> | ç½‘ç»œå±‚çº§ | Core Switch down | Server unreachable | äº¤æ¢æœºæ•…éšœæ—¶ï¼ŒæŠ‘åˆ¶æœåŠ¡å™¨å‘Šè­¦ |  
> | é˜ˆå€¼çº§è” | ç£ç›˜ Critical (90%) | ç£ç›˜ Warning (80%) | é¿å…åŒæ—¶è§¦å‘ä¸¤ä¸ªå‘Šè­¦ |  
> | æœåŠ¡ä¾èµ– | Database down | Application down | DB æ•…éšœæ—¶ï¼ŒæŠ‘åˆ¶åº”ç”¨å‘Šè­¦ |  
> | ç»´æŠ¤çª—å£ | Maintenance active | Service alerts | è®¡åˆ’ç»´æŠ¤æœŸé—´æŠ‘åˆ¶å‘Šè­¦ |  
>
> **æ—¥æœ¬è¿ç»´ç°åœº**ç§°æ­¤ä¸ºã€Œéšœå®³é€£é–ã€ï¼ˆæ•…éšœè¿é”ï¼‰å¯¹ç­–ï¼Œæ˜¯é˜²æ­¢å‘Šè­¦é£æš´çš„å¿…å¤‡é…ç½®ã€‚  
>
> ğŸ’¡ **å¯æµ‹è¯•åœºæ™¯**ï¼šStep 5 å°†é…ç½®ç»´æŠ¤çª—å£ï¼Œå±Šæ—¶å¯è§‚å¯Ÿå‘Šè­¦æŠ‘åˆ¶æ•ˆæœã€‚

---

## Step 3 â€” é…ç½® Email é€šçŸ¥

> ğŸ’¡ **æœ¬è¯¾ä½¿ç”¨ Lab ç¯å¢ƒ**ï¼šå®éªŒç¯å¢ƒé¢„è£…äº† Mailpitï¼ˆå‡ SMTP æœåŠ¡å™¨ï¼‰ï¼Œæ— éœ€é…ç½®çœŸå®é‚®ç®±å³å¯æµ‹è¯•é‚®ä»¶é€šçŸ¥ã€‚  
> ç”Ÿäº§ç¯å¢ƒé…ç½®è¯·å‚è€ƒ [3.5 èŠ‚](#35-ç”Ÿäº§ç¯å¢ƒå‚è€ƒå¯é€‰)ã€‚

### 3.1 äº†è§£ Mailpitï¼ˆLab ç¯å¢ƒï¼‰

Mailpit æ˜¯ä¸€ä¸ªè½»é‡çº§å‡ SMTP æœåŠ¡å™¨ï¼š
- æ•è·æ‰€æœ‰å‘é€çš„é‚®ä»¶ï¼ˆä¸ä¼šå‘é€åˆ°å¤–éƒ¨ï¼‰
- æä¾› Web UI æŸ¥çœ‹é‚®ä»¶å†…å®¹
- é€‚åˆå¼€å‘å’Œæµ‹è¯•ç¯å¢ƒ

**è®¿é—® Mailpit Web UI**ï¼š

```bash
# æŸ¥çœ‹ Mailpit Web UI åœ°å€
aws cloudformation describe-stacks --stack-name zabbix-lab \
  --query 'Stacks[0].Outputs[?OutputKey==`MailpitWebURL`].OutputValue' \
  --output text
```

ç¤ºä¾‹ï¼š`http://<ZabbixServerIP>:8025`

åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€æ­¤åœ°å€ï¼Œç¨åæ‰€æœ‰ Zabbix å‘é€çš„é‚®ä»¶éƒ½ä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œã€‚

> âš ï¸ **Mailpit æœªå¯åŠ¨ï¼Ÿ**  
> ```bash  
> # æ£€æŸ¥çŠ¶æ€  
> sudo systemctl status mailpit  
>
> # é‡å¯æœåŠ¡  
> sudo systemctl restart mailpit  
> ```

### 3.2 é…ç½® Zabbix SMTP

1. ã€ŒAlertsã€â†’ã€ŒMedia typesã€
2. ç‚¹å‡»ã€ŒEmailã€ï¼ˆç³»ç»Ÿé¢„ç½®ï¼‰

é…ç½® SMTP æŒ‡å‘ Mailpitï¼š

| å­—æ®µ | å€¼ |
|------|-----|
| SMTP server | `localhost` |
| SMTP server port | `1025` |
| SMTP helo | `zabbix-lab.local` |
| SMTP email | `zabbix@zabbix-lab.local` |
| Connection security | `None` |
| Authentication | `None` |

3. ç‚¹å‡»ã€ŒUpdateã€ä¿å­˜

### 3.3 æµ‹è¯•é‚®ä»¶å‘é€

1. è¿”å› Media types åˆ—è¡¨
2. åœ¨ Email è¡Œçš„ã€ŒActionã€åˆ—ï¼ˆæœ€å³ä¾§ï¼Œå¯èƒ½éœ€è¦æ¨ªå‘æ»šåŠ¨ï¼‰ç‚¹å‡»ã€ŒTestã€
3. è¾“å…¥ä»»æ„é‚®ç®±åœ°å€ï¼ˆå¦‚ `test@example.com`ï¼‰ï¼Œç‚¹å‡»ã€ŒTestã€
4. åœ¨ Mailpit Web UI ä¸­ç¡®è®¤æ”¶åˆ°æµ‹è¯•é‚®ä»¶

> ğŸ’¡ **Test æŒ‰é’®ä½ç½®**ï¼šTest åŠŸèƒ½åœ¨ Media types **åˆ—è¡¨é¡µ**çš„ Action åˆ—ï¼Œä¸åœ¨ç¼–è¾‘å¯¹è¯æ¡†å†…ã€‚  
> è¿™æ˜¯ Zabbix 4.2+ ä»¥æ¥çš„æ ‡å‡†è®¾è®¡ã€‚

### 3.4 ä¸ºç”¨æˆ·é…ç½® Media

é…ç½®å“ªäº›ç”¨æˆ·æ¥æ”¶é‚®ä»¶é€šçŸ¥ï¼š

1. ã€ŒUsersã€â†’ã€ŒUsersã€
2. ç‚¹å‡»ä½ çš„ç”¨æˆ·åï¼ˆå¦‚ `Admin` æˆ– `ops-test`ï¼‰
3. åˆ‡æ¢åˆ°ã€ŒMediaã€æ ‡ç­¾é¡µ
4. ç‚¹å‡»ã€ŒAddã€

| å­—æ®µ | å€¼ |
|------|-----|
| Type | Email |
| Send to | `admin@zabbix-lab.local`ï¼ˆä»»æ„åœ°å€ï¼ŒMailpit ä¼šæ•è·ï¼‰ |
| When active | 1-7,00:00-24:00ï¼ˆå…¨å¤©å€™ï¼‰ |
| Use if severity | å‹¾é€‰ Warning åŠä»¥ä¸Šçº§åˆ« |

5. ç‚¹å‡»ã€ŒAddã€â†’ã€ŒUpdateã€

### 3.5 ç”Ÿäº§ç¯å¢ƒå‚è€ƒï¼ˆå¯é€‰ï¼‰

> âš ï¸ **æœ¬èŠ‚ä»…ä¾›å‚è€ƒ**ï¼ŒLab ç¯å¢ƒè¯·ä½¿ç”¨ä¸Šè¿° Mailpit é…ç½®ã€‚

**Gmail SMTP**ï¼š

| å­—æ®µ | å€¼ |
|------|-----|
| SMTP server | smtp.gmail.com |
| SMTP server port | 587 |
| SMTP helo | gmail.com |
| SMTP email | your-email@gmail.com |
| Connection security | STARTTLS |
| Authentication | Username and password |
| Username | your-email@gmail.com |
| Password | App passwordï¼ˆéç™»å½•å¯†ç ï¼‰ |

> ğŸ’¡ **Gmail æ³¨æ„**ï¼šéœ€è¦å¯ç”¨ 2FA å¹¶åˆ›å»º App Passwordã€‚è¿›å…¥ Google è´¦æˆ· â†’ å®‰å…¨ â†’ åº”ç”¨ä¸“ç”¨å¯†ç 

**AWS SES**ï¼š

| å­—æ®µ | å€¼ |
|------|-----|
| SMTP server | email-smtp.ap-northeast-1.amazonaws.com |
| SMTP server port | 587 |
| Connection security | STARTTLS |
| Username | SES SMTP username |
| Password | SES SMTP password |

> ğŸ’¡ **SES æ³¨æ„**ï¼šæ–°è´¦æˆ·åœ¨ Sandbox æ¨¡å¼ï¼Œåªèƒ½å‘é€åˆ°å·²éªŒè¯é‚®ç®±ã€‚éœ€ç”³è¯·ç”Ÿäº§ç¯å¢ƒè®¿é—®ã€‚

---

## Step 4 â€” åˆ›å»º Action

Action å®šä¹‰ã€Œè§¦å‘å™¨è§¦å‘æ—¶åšä»€ä¹ˆã€ã€‚

### 4.1 åˆ›å»ºé€šçŸ¥ Action

1. ã€ŒAlertsã€â†’ã€ŒActionsã€â†’ã€ŒTrigger actionsã€
2. ç‚¹å‡»ã€ŒCreate actionã€

**Action æ ‡ç­¾é¡µ**ï¼š

| å­—æ®µ | å€¼ |
|------|-----|
| Name | `Notify on High severity problems` |
| Conditions | æ·»åŠ æ¡ä»¶ï¼ˆè§ä¸‹ï¼‰ |

**æ·»åŠ  Conditions**ï¼š
- Trigger severity `>=` `High`
- Host group `=` `Lab/Linux servers`ï¼ˆå‚è€ƒ [02 Â· Host ç®¡ç†](../02-host-management/) åˆ›å»ºï¼‰

**Operations æ ‡ç­¾é¡µ**ï¼š

ç‚¹å‡»ã€ŒAddã€æ·»åŠ æ“ä½œï¼š

| å­—æ®µ | å€¼ |
|------|-----|
| Operation type | Send message |
| Send to user groups | é€‰æ‹©ç”¨æˆ·ç»„ï¼ˆå¦‚ Zabbix administratorsï¼‰ |
| Send only to | Email |

**Default subject**ï¼š
```
[{TRIGGER.SEVERITY}] {TRIGGER.NAME}
```

**Default message**ï¼š
```
Host: {HOST.NAME}
Problem: {TRIGGER.NAME}
Severity: {TRIGGER.SEVERITY}
Time: {EVENT.DATE} {EVENT.TIME}
Current value: {ITEM.LASTVALUE}

Original problem ID: {EVENT.ID}
```

**Recovery operations æ ‡ç­¾é¡µ**ï¼š

æ·»åŠ æ¢å¤é€šçŸ¥ï¼š
- Operation type: Send message
- ä½¿ç”¨ç›¸åŒç”¨æˆ·ç»„

**Recovery subject**ï¼š
```
[RESOLVED] {TRIGGER.NAME}
```

**Recovery message**ï¼š
```
Host: {HOST.NAME}
Problem: {TRIGGER.NAME}
Status: RESOLVED

Resolved at: {EVENT.RECOVERY.DATE} {EVENT.RECOVERY.TIME}
Duration: {EVENT.DURATION}

Original problem ID: {EVENT.ID}
```

3. ç‚¹å‡»ã€ŒAddã€

### 4.2 æµ‹è¯•å‘Šè­¦

#### 4.2.1 ç†è§£ç£ç›˜ä½¿ç”¨ç‡

é¦–å…ˆåœ¨ Monitored Host ä¸ŠæŸ¥çœ‹å½“å‰ç£ç›˜çŠ¶æ€ï¼š

```bash
df -h /
```

è¾“å‡ºç¤ºä¾‹ï¼š
```
Filesystem      Size  Used Avail Use% Mounted on
/dev/nvme0n1p1  8.0G  1.8G  6.3G  22% /
```

**å„åˆ—å«ä¹‰**ï¼š

| åˆ— | å«ä¹‰ | ç¤ºä¾‹ |
|----|------|------|
| Filesystem | è®¾å¤‡å | /dev/nvme0n1p1 |
| Size | æ€»å®¹é‡ | 8.0G |
| Used | å·²ä½¿ç”¨ | 1.8G |
| Avail | å¯ç”¨ç©ºé—´ | 6.3G |
| Use% | ä½¿ç”¨ç‡ | 22% |
| Mounted on | æŒ‚è½½ç‚¹ | / |

**è®¡ç®—ç¤ºä¾‹**ï¼ˆæ‰‹åŠ¨æ–¹å¼ï¼‰ï¼š
- æ€»å®¹é‡ 8GBï¼Œå½“å‰ä½¿ç”¨ 22%ï¼ˆ1.8GBï¼‰
- ç›®æ ‡ 85%ï¼šéœ€è¦ 8GB Ã— 85% = 6.8GB
- éœ€è¦é¢å¤–åˆ›å»ºï¼š6.8GB - 1.8GB = **5GB æ–‡ä»¶**

#### 4.2.2 ä½¿ç”¨è¾…åŠ©è„šæœ¬

ä¸ºæ–¹ä¾¿æµ‹è¯•ï¼Œæˆ‘ä»¬æä¾›äº†è¾…åŠ©è„šæœ¬è‡ªåŠ¨è®¡ç®—å¹¶åˆ›å»ºæµ‹è¯•æ–‡ä»¶ã€‚

> âš ï¸ **åœ¨ Monitored Host ä¸Šæ‰§è¡Œ**ï¼ˆä¸æ˜¯ Zabbix Serverï¼‰

```bash
# ä¸‹è½½è„šæœ¬ï¼ˆå¦‚æœå°šæœªå…‹éš†ä»“åº“ï¼‰
cd ~
curl -O https://raw.githubusercontent.com/shiicho/cloud-atlas/main/middleware/zabbix/04-triggers-alerts/code/fill-disk.sh
chmod +x fill-disk.sh

# æŸ¥çœ‹å½“å‰çŠ¶æ€å’Œå¸®åŠ©
./fill-disk.sh
```

> ğŸ’¡ **è„šæœ¬ç‰¹ç‚¹**ï¼š  
> - è‡ªåŠ¨è®¡ç®—æ‰€éœ€æ–‡ä»¶å¤§å°  
> - æ–‡ä»¶ä¿å­˜åœ¨ç”¨æˆ·ç›®å½•ï¼ˆæ— éœ€ sudoï¼‰  
> - æ”¯æŒå°æ•°æ ¼å¼ï¼ˆ85 æˆ– 0.85ï¼‰  
> - æ˜¾ç¤ºè¯¦ç»†çš„è®¡ç®—è¿‡ç¨‹

#### 4.2.3 æµ‹è¯• Warning è§¦å‘å™¨ï¼ˆ80%ï¼‰

```bash
# å¡«å……åˆ° 85%
./fill-disk.sh 85

# ç¡®è®¤ä½¿ç”¨ç‡
df -h /
```

ç­‰å¾… 1-2 åˆ†é’Ÿï¼Œåœ¨ Zabbix Web UI æ£€æŸ¥ï¼š

1. ã€ŒMonitoringã€â†’ã€ŒProblemsã€
2. ç¡®è®¤çœ‹åˆ° **Warning** çº§åˆ«å‘Šè­¦ï¼š`Disk space is low on monitored-host-01`
3. æ£€æŸ¥ Mailpitï¼š**ä¸ä¼šæ”¶åˆ°é‚®ä»¶**ï¼ˆAction è¿‡æ»¤äº† Warning çº§åˆ«ï¼‰

#### 4.2.4 æµ‹è¯• High è§¦å‘å™¨ï¼ˆ90%ï¼‰+ é‚®ä»¶é€šçŸ¥

```bash
# å¡«å……åˆ° 95%
./fill-disk.sh 95

# ç¡®è®¤ä½¿ç”¨ç‡
df -h /
```

ç­‰å¾… 1-2 åˆ†é’Ÿï¼Œåœ¨ Zabbix Web UI æ£€æŸ¥ï¼š

1. ã€ŒMonitoringã€â†’ã€ŒProblemsã€
2. ç¡®è®¤çœ‹åˆ° **High** çº§åˆ«å‘Šè­¦ï¼š`Disk space is critically low on monitored-host-01`
3. æ£€æŸ¥ Mailpit Web UIï¼š**åº”æ”¶åˆ°é‚®ä»¶é€šçŸ¥** âœ…

> ğŸ’¡ **ä¸ºä»€ä¹ˆåªæœ‰ High æ”¶åˆ°é‚®ä»¶ï¼Ÿ**  
> Step 4.1 åˆ›å»ºçš„ Action æ¡ä»¶æ˜¯ `Severity >= High`ã€‚  
> - Warning (80%): æ˜¾ç¤ºåœ¨ Problemsï¼Œä½†ä¸å‘é‚®ä»¶  
> - High (90%): æ˜¾ç¤ºåœ¨ Problemsï¼Œä¸”å‘é€é‚®ä»¶

#### 4.2.5 æ¸…ç†æµ‹è¯•æ–‡ä»¶

```bash
# åˆ é™¤æµ‹è¯•æ–‡ä»¶
./fill-disk.sh clean

# ç¡®è®¤æ¢å¤
df -h /
```

ç­‰å¾… 1-2 åˆ†é’Ÿï¼Œç¡®è®¤ï¼š
1. ã€ŒMonitoringã€â†’ã€ŒProblemsã€ä¸­å‘Šè­¦è‡ªåŠ¨æ¢å¤ï¼ˆRecoveryï¼‰
2. Mailpit æ”¶åˆ°æ¢å¤é€šçŸ¥é‚®ä»¶

---

## Step 5 â€” é…ç½®ç»´æŠ¤çª—å£

> åœºæ™¯ï¼šGolden Weekï¼ˆæ—¥æœ¬é»„é‡‘å‘¨ï¼‰æœŸé—´æŠ‘åˆ¶å‘Šè­¦

### 5.1 åˆ›å»ºç»´æŠ¤çª—å£

1. ã€ŒData collectionã€â†’ã€ŒMaintenanceã€
2. ç‚¹å‡»ã€ŒCreate maintenance periodã€

**Maintenance æ ‡ç­¾é¡µ**ï¼š

| å­—æ®µ | å€¼ |
|------|-----|
| Name | `Lab Test Maintenance` |
| Maintenance type | `With data collection`ï¼ˆç»§ç»­é‡‡é›†ä½†ä¸å‘Šè­¦ï¼‰ |
| Active since | ï¼ˆå½“å‰æ—¶é—´ï¼‰ |
| Active till | ï¼ˆå½“å‰æ—¶é—´ + 10 åˆ†é’Ÿï¼‰ |

> ğŸ’¡ **Lab æµ‹è¯•**ï¼šè®¾ç½® 10 åˆ†é’Ÿçª—å£ä¾¿äºç«‹å³éªŒè¯æ•ˆæœã€‚ç”Ÿäº§ç¯å¢ƒå¯è®¾ç½®æ›´é•¿æ—¶é—´ï¼ˆå¦‚ Golden Week 5 å¤©ï¼‰ã€‚

> âš ï¸ **æ—¶åŒºæ³¨æ„**ï¼šç»´æŠ¤çª—å£æ—¶é—´åŸºäº Zabbix Server æ—¶åŒºã€‚ç¡®ä¿å·²åœ¨ [01 Â· Server åˆå§‹åŒ–](../01-server-setup/) ä¸­è®¾ç½®ä¸º Asia/Tokyoã€‚

**Periods æ ‡ç­¾é¡µ**ï¼š

ç‚¹å‡»ã€ŒAddã€ï¼š
- Period type: One time only
- Date: ï¼ˆä»Šå¤©æ—¥æœŸï¼‰
- Maintenance period length: 10 minutes

**Hosts & groups æ ‡ç­¾é¡µ**ï¼š

- Host groups: é€‰æ‹©éœ€è¦ç»´æŠ¤çš„ç»„
- æˆ– Hosts: é€‰æ‹©ç‰¹å®šä¸»æœº

3. ç‚¹å‡»ã€ŒAddã€

### 5.2 ç»´æŠ¤çª—å£ç±»å‹

| ç±»å‹ | æ•°æ®é‡‡é›† | å‘Šè­¦ | ç”¨é€” |
|------|----------|------|------|
| With data collection | âœ… | âŒ | è®¡åˆ’å†…åœæœºã€å‡æœŸ |
| No data collection | âŒ | âŒ | ç¡¬ä»¶ç»´æŠ¤ã€ç½‘ç»œåˆ‡å‰² |

### 5.3 éªŒè¯ç»´æŠ¤çª—å£

1. åœ¨ç»´æŠ¤æœŸé—´ï¼Œä¸»æœºå›¾æ ‡æ˜¾ç¤ºç»´æŠ¤æ ‡è®°
2. ã€ŒProblemsã€ä¸­å‘Šè­¦è¢«æŠ‘åˆ¶ï¼ˆä½†ä»è®°å½•ï¼‰
3. ç»´æŠ¤ç»“æŸåè‡ªåŠ¨æ¢å¤

---

## Step 6 â€” å‘Šè­¦ç¡®è®¤ï¼ˆAcknowledgmentï¼‰

> ğŸ’¡ **å‰ææ¡ä»¶**ï¼šéœ€è¦æœ‰æ´»è·ƒçš„ Problem æ‰èƒ½ç»ƒä¹ ç¡®è®¤æ“ä½œã€‚  
> å¦‚æœä¹‹å‰å·²æ¸…ç†å®Œæ¯•ï¼Œå¯ç”¨ `./fill-disk.sh 85` é‡æ–°è§¦å‘ä¸€ä¸ªå‘Šè­¦ã€‚

### 6.1 ç¡®è®¤é—®é¢˜

1. ã€ŒMonitoringã€â†’ã€ŒProblemsã€
2. åœ¨é—®é¢˜è¡Œçš„ã€ŒActionsã€åˆ—ç‚¹å‡»ã€ŒUpdateã€
3. åœ¨ã€ŒUpdate problemã€å¯¹è¯æ¡†ä¸­ï¼š
   - å‹¾é€‰ã€ŒAcknowledgeã€å¤é€‰æ¡†
   - åœ¨ã€ŒMessageã€ä¸­æè¿°å¤„ç†æƒ…å†µ
   - å¯é€‰æ“ä½œï¼š
     - Change severityï¼ˆè°ƒæ•´ä¸¥é‡çº§åˆ«ï¼‰
     - Suppressï¼ˆæš‚æ—¶æŠ‘åˆ¶å‘Šè­¦ï¼‰
     - Close problemï¼ˆæ‰‹åŠ¨å…³é—­ï¼‰
4. ç‚¹å‡»ã€ŒUpdateã€æäº¤

> ğŸ’¡ **Zabbix 7.0 UI**ï¼šå‘Šè­¦ç¡®è®¤é€šè¿‡ã€ŒUpdateã€å¯¹è¯æ¡†å®Œæˆï¼Œ  
> æä¾›æ›´å¤šé€‰é¡¹ï¼ˆè°ƒæ•´ä¸¥é‡çº§åˆ«ã€æŠ‘åˆ¶ã€å…³é—­ï¼‰åœ¨åŒä¸€ç•Œé¢ä¸­ã€‚

### 6.2 ç¡®è®¤æµç¨‹æœ€ä½³å®è·µ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  å‘Šè­¦å¤„ç†æµç¨‹                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  1. æ”¶åˆ°å‘Šè­¦ â”€â”€â–º 2. ç¡®è®¤æ”¶åˆ°ï¼ˆAckï¼‰                         â”‚
â”‚                      â”‚                                       â”‚
â”‚                      â–¼                                       â”‚
â”‚               3. å¼€å§‹å¤„ç†ï¼ˆè®°å½•ï¼‰                            â”‚
â”‚                      â”‚                                       â”‚
â”‚                      â–¼                                       â”‚
â”‚               4. é—®é¢˜è§£å†³                                    â”‚
â”‚                      â”‚                                       â”‚
â”‚               â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”                               â”‚
â”‚               â”‚             â”‚                                â”‚
â”‚               â–¼             â–¼                                â”‚
â”‚          è‡ªåŠ¨æ¢å¤      æ‰‹åŠ¨å…³é—­                              â”‚
â”‚         (Recovery)   (Close problem)                         â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Mini-Projectï¼šå®Œæ•´å‘Šè­¦é“¾è·¯é…ç½®

> åœºæ™¯ï¼šä¸º Lab ç¯å¢ƒé…ç½®å®Œæ•´çš„ç£ç›˜å‘Šè­¦é“¾è·¯

### è¦æ±‚

1. **åˆ›å»ºè§¦å‘å™¨**
   - Warning: ç£ç›˜ > 80%
   - High: ç£ç›˜ > 90%
   - Disaster: ç£ç›˜ > 95%

2. **é…ç½® Action**
   - ä¸ºæ¯ä¸ªä¸¥é‡çº§åˆ«åˆ›å»ºç‹¬ç«‹ Action
   - ä½¿ç”¨ Mailpit éªŒè¯é‚®ä»¶å‘é€

3. **é…ç½®ç»´æŠ¤çª—å£**
   - è®¾ç½®ã€Œä»ç°åœ¨èµ· 5 åˆ†é’Ÿåã€çš„çŸ­çª—å£
   - æŠ‘åˆ¶é Disaster çº§åˆ«å‘Šè­¦
   - è§‚å¯Ÿçª—å£æœŸé—´çš„è¡Œä¸ºå·®å¼‚

4. **æµ‹è¯•**
   - ä½¿ç”¨ `fill-disk.sh` è§¦å‘å„çº§åˆ«å‘Šè­¦
   - åœ¨ Mailpit Web UI éªŒè¯é€šçŸ¥
   - éªŒè¯ç»´æŠ¤çª—å£æŠ‘åˆ¶æ•ˆæœ

> ğŸ’¡ **è¿›é˜¶é€šçŸ¥æ¸ é“**ï¼šç”Ÿäº§ç¯å¢ƒä¸­å¸¸ç”¨ Slackã€PagerDutyã€Opsgenie ç­‰å³æ—¶é€šçŸ¥ã€‚  
> Zabbix 7.0 å†…ç½® 40+ Webhook æ¨¡æ¿ï¼Œé…ç½®æ–¹æ³•å‚è€ƒå®˜æ–¹æ–‡æ¡£ã€‚

---

## é¢è¯•é—®ç­”

### Q: ãƒˆãƒªã‚¬ãƒ¼ã®ãƒ•ãƒ©ãƒƒãƒ”ãƒ³ã‚°ã‚’é˜²ãã«ã¯ï¼Ÿ

**A**:
- **ãƒ’ã‚¹ãƒ†ãƒªã‚·ã‚¹è¨­å®š**: Problem expression ã¨ Recovery expression ã§ç•°ãªã‚‹é–¾å€¤ã‚’è¨­å®šï¼ˆä¾‹ï¼š80% ã§è­¦å‘Šã€75% ã§å›å¾©ï¼‰
- **{$THRESHOLD} ãƒã‚¯ãƒ­**: é–¾å€¤ã‚’ãƒã‚¯ãƒ­åŒ–ã—ã¦èª¿æ•´ã—ã‚„ã™ã
- **Multiple PROBLEM events**: åŒã˜ãƒˆãƒªã‚¬ãƒ¼ã‹ã‚‰ã®é‡è¤‡ã‚¤ãƒ™ãƒ³ãƒˆç”Ÿæˆã‚’åˆ¶å¾¡
- **nodata() é–¢æ•°**: ãƒ‡ãƒ¼ã‚¿æ¬ ææ™‚ã®èª¤æ¤œçŸ¥ã‚’é˜²æ­¢

### Q: Maintenance Window ã®ä½¿ã„æ–¹ã¯ï¼Ÿ

**A**:
- **è¨ˆç”»åœæ­¢**: ã‚µãƒ¼ãƒãƒ¼ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã€ãƒ‘ãƒƒãƒé©ç”¨æ™‚
- **å®šæœŸãƒ¡ãƒ³ãƒ†**: æ¯é€±æ—¥æ›œæ·±å¤œãªã©å®šæœŸä½œæ¥­æ™‚é–“
- **é•·æœŸä¼‘æš‡**: Golden Weekã€å¹´æœ«å¹´å§‹ãªã©
- **With/Without data collection**: ãƒ‡ãƒ¼ã‚¿ç¶™ç¶šã®å¿…è¦æ€§ã§é¸æŠ
- **ä¸€æ™‚æŠ‘åˆ¶**: èª¤å ±å¯¾å¿œä¸­ã®ä¸€æ™‚çš„ãªæŠ‘åˆ¶ã«ã‚‚ä½¿ç”¨

---

## å¸¸è§é”™è¯¯

| é”™è¯¯ | åŸå›  | è§£å†³æ–¹æ¡ˆ |
|------|------|----------|
| é‚®ä»¶æœªå‘é€ | SMTP é…ç½®é”™è¯¯ | ä½¿ç”¨ Test åŠŸèƒ½éªŒè¯ |
| Action ä¸è§¦å‘ | Conditions ä¸åŒ¹é… | æ£€æŸ¥ä¸¥é‡çº§åˆ«ã€Host group æ¡ä»¶ |
| ç»´æŠ¤çª—å£æ— æ•ˆ | æ—¶åŒºè®¾ç½®é”™è¯¯ | ç¡®è®¤ Zabbix æ—¶åŒºä¸º Asia/Tokyo |
| é‡å¤å‘Šè­¦ | æœªé…ç½® Recovery | æ·»åŠ  Recovery expression |

### æ’æŸ¥ Action

1. ã€ŒReportsã€â†’ã€ŒAction logã€
2. æŸ¥çœ‹ Action æ‰§è¡Œå†å²
3. æ£€æŸ¥å¤±è´¥åŸå› 

---

## æœ¬è¯¾å°ç»“

| æ¦‚å¿µ | è¦ç‚¹ |
|------|------|
| Trigger | åŸºäº Item æ•°æ®çš„å‘Šè­¦æ¡ä»¶ |
| Expression | è§¦å‘æ¡ä»¶è¡¨è¾¾å¼ |
| Recovery | æ¢å¤æ¡ä»¶ï¼Œé˜²æ­¢ Flapping |
| Severity | 6 ä¸ªçº§åˆ«ï¼Œç”¨äºåˆ†çº§å“åº” |
| Action | è§¦å‘å™¨ â†’ é€šçŸ¥çš„æ˜ å°„ |
| Maintenance | è®¡åˆ’å†…æŠ‘åˆ¶å‘Šè­¦ |
| Acknowledgment | å‘Šè­¦ç¡®è®¤å’Œå¤„ç†è®°å½• |

---

## æ¸…ç†æé†’

> âš ï¸ **è´¹ç”¨æé†’**ï¼šå®éªŒç¯å¢ƒæŒç»­äº§ç”Ÿè´¹ç”¨ã€‚å®Œæˆæ•´ä¸ªç³»åˆ—åï¼Œè¯·åˆ é™¤ CloudFormation å †æ ˆã€‚  
> è¯¦è§ â†’ [00 Â· æ¸…ç†èµ„æº](../00-architecture-lab/#æ¸…ç†èµ„æº)

---

## ä¸‹ä¸€æ­¥

å‘Šè­¦å·²é…ç½®ï¼ä¸‹ä¸€è¯¾æˆ‘ä»¬å°†å­¦ä¹ æ—¥å¿—ç›‘æ§ã€è‡ªå®šä¹‰æŒ‡æ ‡å’Œ SNMP å…¥é—¨ã€‚

â†’ [05 Â· æ—¥å¿— + è‡ªå®šä¹‰æŒ‡æ ‡](../05-logs-custom/)

## ç³»åˆ—å¯¼èˆª

â† [03 Â· åŸºç¡€ç›‘æ§](../03-monitoring-basics/) | [ç³»åˆ—é¦–é¡µ](../) | [05 Â· æ—¥å¿— + è‡ªå®šä¹‰æŒ‡æ ‡](../05-logs-custom/) â†’
