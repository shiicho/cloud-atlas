# 05 Â· æ—¥å¿—ç›‘æ§ + è‡ªå®šä¹‰æŒ‡æ ‡ï¼ˆLogs & Custom Metricsï¼‰

> **ç›®æ ‡**ï¼šé…ç½®æ—¥å¿—ç›‘æ§ã€UserParameter è‡ªå®šä¹‰æŒ‡æ ‡å’Œ SNMP å…¥é—¨
> **å‰ç½®**ï¼š[04 Â· è§¦å‘å™¨ä¸å‘Šè­¦](../04-triggers-alerts/)
> **è´¹ç”¨**ï¼šå®éªŒç¯å¢ƒæŒç»­äº§ç”Ÿè´¹ç”¨ï¼ˆçº¦ $0.03/å°æ—¶ï¼‰ï¼›å®Œæˆç³»åˆ—åè¯·åˆ é™¤å †æ ˆ
> **æ—¶é—´**ï¼š30-35 åˆ†é’Ÿ
> **å®æˆ˜é¡¹ç›®**ï¼šé…ç½® ERROR æ—¥å¿—å‘Šè­¦ + è‡ªå®šä¹‰é˜Ÿåˆ—æ·±åº¦ç›‘æ§

## å°†å­¦åˆ°çš„å†…å®¹

1. é…ç½®æ—¥å¿—ç›‘æ§ï¼ˆlog[] vs logrt[]ï¼‰
2. åˆ›å»ºæ—¥å¿—è§¦å‘å™¨
3. UserParameter è‡ªå®šä¹‰æŒ‡æ ‡
4. Template ç»§æ‰¿å’Œ Macro ä¼˜å…ˆçº§
5. SNMP ç›‘æ§å…¥é—¨

---

## Step 1 â€” ç†è§£æ—¥å¿—ç›‘æ§

### 1.1 log[] vs logrt[]

| Key | ç”¨é€” | ç‰¹ç‚¹ |
|-----|------|------|
| `log[file,regexp]` | ç›‘æ§é™æ€æ–‡ä»¶ | æ–‡ä»¶åå›ºå®š |
| `logrt[regexp,regexp]` | ç›‘æ§è½®è½¬æ—¥å¿— | æ”¯æŒæ—¥æœŸé€šé…ç¬¦ |
| `log.count[file,regexp]` | ç»Ÿè®¡åŒ¹é…è¡Œæ•° | è¿”å›æ•°å€¼ï¼Œå‡å°‘ DB è´Ÿæ‹… |
| `logrt.count[regexp,regexp]` | ç»Ÿè®¡è½®è½¬æ—¥å¿—åŒ¹é…æ•° | é€‚åˆå‘Šè­¦è®¡æ•°åœºæ™¯ |

> ğŸ’¡ **æ¨è**ï¼šå¦‚æœåªéœ€è¦ç»Ÿè®¡ ERROR æ•°é‡è§¦å‘å‘Šè­¦ï¼Œä¼˜å…ˆä½¿ç”¨ `log.count[]` è€Œé `log[]`ï¼Œå¯å¤§å¹…å‡å°‘æ•°æ®åº“å­˜å‚¨ã€‚

### 1.2 æ—¥å¿—ç›‘æ§å·¥ä½œåŸç†

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   æ—¥å¿—ç›‘æ§æµç¨‹                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  /var/log/messages                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚ Dec  8 10:00:01 host INFO: Started      â”‚                â”‚
â”‚  â”‚ Dec  8 10:00:02 host ERROR: Failed      â”‚ â—„â”€â”€ æ–°è¡Œ      â”‚
â”‚  â”‚ Dec  8 10:00:03 host INFO: Completed    â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                      â”‚                                       â”‚
â”‚                      â–¼                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚ Zabbix Agent                            â”‚                â”‚
â”‚  â”‚ - è®°å½•ä¸Šæ¬¡è¯»å–ä½ç½®                       â”‚                â”‚
â”‚  â”‚ - æ£€æµ‹æ–°è¡Œ                               â”‚                â”‚
â”‚  â”‚ - æ­£åˆ™åŒ¹é… (ERROR)                       â”‚                â”‚
â”‚  â”‚ - å‘é€åŒ¹é…è¡Œåˆ° Server                    â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                      â”‚                                       â”‚
â”‚                      â–¼                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚ Zabbix Server                           â”‚                â”‚
â”‚  â”‚ - å­˜å‚¨æ—¥å¿—å†…å®¹                           â”‚                â”‚
â”‚  â”‚ - è¯„ä¼°è§¦å‘å™¨                             â”‚                â”‚
â”‚  â”‚ - ç”Ÿæˆå‘Šè­¦                               â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Step 2 â€” é…ç½®æ—¥å¿—ç›‘æ§

### 2.1 åˆ›å»ºæ—¥å¿—ç›‘æ§ Item

1. ã€ŒData collectionã€â†’ã€ŒHostsã€â†’ ç‚¹å‡» `monitored-host-01`
2. åˆ‡æ¢åˆ°ã€ŒItemsã€â†’ã€ŒCreate itemã€

**åŸºæœ¬é…ç½®**ï¼š

| å­—æ®µ | å€¼ |
|------|-----|
| Name | `System log ERROR messages` |
| Type | `Zabbix agent (active)` |
| Key | `log[/var/log/messages,ERROR,,100,skip]` |
| Type of information | `Log` |
| Update interval | `1m` |

**Key å‚æ•°è¯´æ˜**ï¼ˆå®Œæ•´ 9 å‚æ•°ï¼‰ï¼š
```
log[file, regexp, encoding, maxlines, mode, output, maxdelay, options, persistent_dir]
    â”‚      â”‚       â”‚         â”‚        â”‚      â”‚       â”‚         â”‚        â”‚
    â”‚      â”‚       â”‚         â”‚        â”‚      â”‚       â”‚         â”‚        â””â”€ æŒä¹…åŒ–ç›®å½•ï¼ˆAgent é‡å¯åç»§ç»­ï¼‰
    â”‚      â”‚       â”‚         â”‚        â”‚      â”‚       â”‚         â””â”€ é€‰é¡¹ï¼ˆmtime-noreread ç­‰ï¼‰
    â”‚      â”‚       â”‚         â”‚        â”‚      â”‚       â””â”€ æœ€å¤§å»¶è¿Ÿç§’æ•°
    â”‚      â”‚       â”‚         â”‚        â”‚      â””â”€ è¾“å‡ºæ ¼å¼ï¼ˆ\0 ç­‰ï¼‰
    â”‚      â”‚       â”‚         â”‚        â””â”€ skip: è·³è¿‡å·²æœ‰å†…å®¹; all: è¯»å–å…¨éƒ¨
    â”‚      â”‚       â”‚         â””â”€ æ¯æ¬¡æœ€å¤šè¯»å–è¡Œæ•°ï¼ˆæ¯ç§’ï¼‰
    â”‚      â”‚       â””â”€ å­—ç¬¦ç¼–ç ï¼ˆUTF-8 ç­‰ï¼‰
    â”‚      â””â”€ æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…
    â””â”€ æ—¥å¿—æ–‡ä»¶è·¯å¾„
```

> âš ï¸ **maxlines å«ä¹‰**ï¼š`maxlines` æ˜¯**æ¯ç§’**æœ€å¤šå¤„ç†çš„è¡Œæ•°ï¼Œè€Œéæ¯æ¬¡é‡‡é›†ã€‚é«˜é¢‘æ—¥å¿—åœºæ™¯éœ€é€‚å½“æé«˜æ­¤å€¼ã€‚

3. ç‚¹å‡»ã€ŒAddã€

### 2.2 logrt[] è½®è½¬æ—¥å¿—ç¤ºä¾‹

å¯¹äºæŒ‰æ—¥æœŸè½®è½¬çš„æ—¥å¿—ï¼ˆå¦‚ `app.log.2024-01-01`ï¼‰ï¼Œä½¿ç”¨ `logrt[]`ï¼š

| å­—æ®µ | å€¼ |
|------|-----|
| Name | `Application log ERROR (rotated)` |
| Type | `Zabbix agent (active)` |
| Key | `logrt[/var/log/myapp/app\.log.*,ERROR,,100,skip]` |
| Type of information | `Log` |

> ğŸ’¡ **logrt[] æ–‡ä»¶åæ¨¡å¼**ï¼šç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æ­£åˆ™è¡¨è¾¾å¼ï¼Œ`\.` è½¬ä¹‰ç‚¹å·ï¼Œ`.*` åŒ¹é…æ—¥æœŸåç¼€ã€‚

### 2.3 åˆ›å»ºæ—¥å¿—è§¦å‘å™¨

1. åœ¨åŒä¸€ä¸»æœºï¼Œã€ŒTriggersã€â†’ã€ŒCreate triggerã€

| å­—æ®µ | å€¼ |
|------|-----|
| Name | `ERROR detected in system log on {HOST.NAME}` |
| Severity | `Average` |
| Expression | `count(/monitored-host-01/log[/var/log/messages,ERROR,,100,skip],5m)>0` |

è¿™ä¸ªè§¦å‘å™¨åœ¨ 5 åˆ†é’Ÿå†…æ£€æµ‹åˆ°ä»»ä½• ERROR æ—¶è§¦å‘ã€‚

### 2.3 æµ‹è¯•æ—¥å¿—ç›‘æ§

```bash
# åœ¨ Monitored Host ä¸Šç”Ÿæˆæµ‹è¯•æ—¥å¿—
sudo logger "ERROR: Test error message for Zabbix monitoring"

# ç­‰å¾… 1-2 åˆ†é’Ÿ
```

åœ¨ Web UI éªŒè¯ï¼š
1. ã€ŒMonitoringã€â†’ã€ŒLatest dataã€â†’ æ‰¾åˆ°æ—¥å¿— Item
2. ç‚¹å‡»ã€ŒHistoryã€æŸ¥çœ‹æ•è·çš„æ—¥å¿—
3. ã€ŒMonitoringã€â†’ã€ŒProblemsã€æŸ¥çœ‹è§¦å‘çš„å‘Šè­¦

### 2.4 é˜²æ­¢ DB è†¨èƒ€

> âš ï¸ æ—¥å¿—ç›‘æ§å¯èƒ½å¯¼è‡´æ•°æ®åº“å¿«é€Ÿå¢é•¿

**æœ€ä½³å®è·µ**ï¼š
- è®¾ç½®åˆç†çš„ `maxlines`ï¼ˆå¦‚ 100ï¼‰
- ç¼©çŸ­ History ä¿ç•™æœŸï¼ˆå¦‚ 7 å¤©ï¼‰
- ä½¿ç”¨ç²¾ç¡®çš„æ­£åˆ™è¡¨è¾¾å¼ï¼Œé¿å…åŒ¹é…è¿‡å¤š

```ini
# Item è®¾ç½®
History storage period: 7d
Trends storage period: 0 (æ—¥å¿—ä¸éœ€è¦ Trends)
```

---

## Step 3 â€” UserParameter è‡ªå®šä¹‰æŒ‡æ ‡

> ğŸ¯ **é¢è¯•é«˜é¢‘é—®é¢˜**ï¼šUserParameter ã®æ³¨æ„ç‚¹ã¯ï¼Ÿ

### 3.1 ä»€ä¹ˆæ˜¯ UserParameter

UserParameter å…è®¸ä½ å®šä¹‰è‡ªå®šä¹‰ç›‘æ§å‘½ä»¤ï¼š

```ini
# æ ¼å¼
UserParameter=<key>,<command>

# ç¤ºä¾‹
UserParameter=custom.queue.depth,cat /var/app/queue/depth.txt
UserParameter=custom.cpu.temp,sensors | grep "Core 0" | awk '{print $3}'
```

### 3.2 åˆ›å»º UserParameter

åœ¨ Monitored Host ä¸Šï¼š

```bash
# åˆ›å»ºé…ç½®æ–‡ä»¶
sudo vim /etc/zabbix/zabbix_agent2.d/userparameter_custom.conf
```

æ·»åŠ è‡ªå®šä¹‰ç›‘æ§ï¼š

```ini
# åº”ç”¨é˜Ÿåˆ—æ·±åº¦ï¼ˆæ¨¡æ‹Ÿï¼‰
UserParameter=custom.queue.depth,cat /tmp/queue_depth.txt 2>/dev/null || echo 0

# httpd è¿æ¥æ•°
UserParameter=custom.httpd.connections,ss -tn state established | grep -c :80 || echo 0

# è‡ªå®šä¹‰å¸¦å‚æ•°
UserParameter=custom.file.linecount[*],wc -l < $1 2>/dev/null || echo 0
```

åˆ›å»ºæµ‹è¯•æ•°æ®ï¼š

```bash
# åˆ›å»ºæ¨¡æ‹Ÿé˜Ÿåˆ—æ·±åº¦æ–‡ä»¶
echo "42" | sudo tee /tmp/queue_depth.txt
```

é‡å¯ Agentï¼š

```bash
sudo systemctl restart zabbix-agent2
```

### 3.3 æµ‹è¯• UserParameter

```bash
# æµ‹è¯•è‡ªå®šä¹‰ Key
zabbix_agent2 -t custom.queue.depth
# é¢„æœŸè¾“å‡º: 42

zabbix_agent2 -t custom.httpd.connections
# é¢„æœŸè¾“å‡º: å½“å‰è¿æ¥æ•°

zabbix_agent2 -t 'custom.file.linecount[/etc/passwd]'
# é¢„æœŸè¾“å‡º: /etc/passwd è¡Œæ•°
```

### 3.4 åœ¨ Web UI åˆ›å»º Item

1. ã€ŒData collectionã€â†’ã€ŒHostsã€â†’ã€ŒItemsã€â†’ã€ŒCreate itemã€

| å­—æ®µ | å€¼ |
|------|-----|
| Name | `Application queue depth` |
| Type | `Zabbix agent` |
| Key | `custom.queue.depth` |
| Type of information | `Numeric (unsigned)` |
| Update interval | `30s` |

2. åˆ›å»ºè§¦å‘å™¨ï¼š

| å­—æ®µ | å€¼ |
|------|-----|
| Name | `Queue depth too high on {HOST.NAME}` |
| Expression | `last(/monitored-host-01/custom.queue.depth)>100` |

### 3.5 UserParameter æœ€ä½³å®è·µ

| æ³¨æ„ç‚¹ | è¯´æ˜ |
|--------|------|
| **Timeout** | ç¡®ä¿å‘½ä»¤åœ¨ Timeout å†…å®Œæˆï¼ˆZabbix 7.0 æ”¯æŒ Item çº§ Timeoutï¼‰ |
| **è¿”å›å€¼** | å¿…é¡»è¿”å›æ­£ç¡®ç±»å‹ï¼ˆæ•°å­—/å­—ç¬¦ä¸²ï¼‰ |
| **é‡å¯** | ä¿®æ”¹åéœ€é‡å¯ Agentï¼ˆæˆ–ç”¨ `zabbix_agent2 -R userparameter_reload`ï¼‰ |
| **å®‰å…¨** | é¿å…æ‰§è¡Œç”¨æˆ·è¾“å…¥ï¼Œä½¿ç”¨ç™½åå•ï¼ˆè§ä¸‹æ–¹è¯¦ç»†è¯´æ˜ï¼‰ |
| **æµ‹è¯•** | å…ˆç”¨ `zabbix_agent2 -t` æµ‹è¯• |

### 3.6 UserParameter å®‰å…¨è­¦å‘Š

> âš ï¸ **å‘½ä»¤æ³¨å…¥é£é™©**ï¼šå¸¦å‚æ•°çš„ UserParameter å¯èƒ½è¢«æ¶æ„åˆ©ç”¨

**å±é™©ç¤ºä¾‹**ï¼ˆâŒ ä¸è¦è¿™æ ·åšï¼‰ï¼š
```ini
# å±é™©ï¼ç›´æ¥ä½¿ç”¨ç”¨æˆ·è¾“å…¥ä½œä¸ºå‘½ä»¤å‚æ•°
UserParameter=custom.exec[*],/usr/bin/myapp $1
# æ”»å‡»è€…å¯èƒ½ä¼ å…¥: ; rm -rf / æˆ– $(cat /etc/passwd)
```

**å®‰å…¨åšæ³•**ï¼ˆâœ… æ¨èï¼‰ï¼š
```ini
# æ–¹æ³• 1ï¼šä½¿ç”¨ DenyKey é™åˆ¶å±é™© Keyï¼ˆæ¨èï¼‰
DenyKey=system.run[*]

# æ–¹æ³• 2ï¼šç™½åå•å›ºå®šå‚æ•°
UserParameter=custom.status[*],case "$1" in web) echo "web";; db) echo "db";; *) echo "invalid";; esac

# æ–¹æ³• 3ï¼šå‚æ•°éªŒè¯è„šæœ¬
UserParameter=custom.safe[*],/usr/local/bin/safe_wrapper.sh "$1"
# safe_wrapper.sh å†…éƒ¨è¿›è¡Œè¾“å…¥éªŒè¯
```

**AllowKey/DenyKey é…ç½®**ï¼ˆZabbix 7.0 æ¨èï¼‰ï¼š
```ini
# /etc/zabbix/zabbix_agent2.conf
# ä»…å…è®¸ç‰¹å®š system.run å‘½ä»¤
AllowKey=system.run[/usr/bin/uptime]
DenyKey=system.run[*]
```

---

## Step 4 â€” Template ç»§æ‰¿ä¸ Macro

### 4.1 Macro ä¼˜å…ˆçº§

```
Macro ä¼˜å…ˆçº§ï¼ˆé«˜ â†’ ä½ï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Host macro                       â”‚ â† æœ€é«˜ä¼˜å…ˆçº§
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 2. Host prototype macro (LLD)       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 3. Template macro (ç›´æ¥é“¾æ¥)        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 4. Template macro (åµŒå¥—ç»§æ‰¿)        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 5. Global macro                     â”‚ â† æœ€ä½ä¼˜å…ˆçº§
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 ä½¿ç”¨ Macro è‡ªå®šä¹‰é˜ˆå€¼

1. ç¼–è¾‘ Trigger Expressionï¼Œä½¿ç”¨ Macroï¼š
   ```
   last(/host/vfs.fs.size[/,pused])>{$DISK_WARN_THRESHOLD}
   ```

2. åœ¨ Host çº§åˆ«å®šä¹‰ Macroï¼š
   - ã€ŒData collectionã€â†’ã€ŒHostsã€â†’ ç¼–è¾‘ä¸»æœº
   - ã€ŒMacrosã€æ ‡ç­¾é¡µ
   - æ·»åŠ ï¼š`{$DISK_WARN_THRESHOLD}` = `80`

3. ä¸åŒä¸»æœºå¯ä»¥æœ‰ä¸åŒé˜ˆå€¼ï¼Œæ— éœ€ä¿®æ”¹ Trigger

### 4.3 Clone Template è¿›è¡Œå®šåˆ¶

1. ã€ŒData collectionã€â†’ã€ŒTemplatesã€
2. æ‰¾åˆ°è¦å®šåˆ¶çš„æ¨¡æ¿
3. ç‚¹å‡»ã€ŒFull cloneã€
4. ä¿®æ”¹åç§°å’Œå†…å®¹
5. å°†å®šåˆ¶æ¨¡æ¿é“¾æ¥åˆ°ç‰¹å®šä¸»æœº

---

## Step 5 â€” SNMP ç›‘æ§å…¥é—¨

### 5.1 SNMP åŸºç¡€æ¦‚å¿µ

| æœ¯è¯­ | è¯´æ˜ |
|------|------|
| OID | Object Identifierï¼Œå”¯ä¸€æ ‡è¯†ç›‘æ§é¡¹ |
| MIB | Management Information Baseï¼ŒOID å®šä¹‰åº“ |
| Community | è®¤è¯å­—ç¬¦ä¸²ï¼ˆv1/v2cï¼‰ |
| SNMPv3 | æ”¯æŒåŠ å¯†å’Œè®¤è¯çš„ç‰ˆæœ¬ |

### 5.2 éªŒè¯ SNMP æœåŠ¡

åœ¨ Monitored Host ä¸Šï¼š

```bash
# ç¡®è®¤ snmpd å·²å®‰è£…ï¼ˆCloudFormation åº”å·²å®‰è£…ï¼‰
rpm -qa | grep net-snmp
# å¦‚æœªå®‰è£…ï¼š
# sudo dnf install -y net-snmp net-snmp-utils

# ç¡®è®¤ snmpd è¿è¡Œ
sudo systemctl status snmpd
# å¦‚æœªè¿è¡Œï¼š
# sudo systemctl enable --now snmpd

# æœ¬åœ°æµ‹è¯• SNMP
snmpwalk -v2c -c public localhost .1.3.6.1.2.1.1.1
# åº”è¿”å›ç³»ç»Ÿæè¿°
```

> ğŸ’¡ **ç”Ÿäº§ç¯å¢ƒå®‰å…¨å»ºè®®**ï¼šSNMPv2c ä½¿ç”¨æ˜æ–‡ community stringï¼Œç”Ÿäº§ç¯å¢ƒåº”ä½¿ç”¨ SNMPv3ï¼ˆæ”¯æŒåŠ å¯†å’Œè®¤è¯ï¼‰ã€‚

### 5.3 ä» Server æµ‹è¯• SNMP

åœ¨ Zabbix Server ä¸Šï¼š

```bash
# å®‰è£… SNMP å·¥å…·
sudo dnf install -y net-snmp-utils

# æµ‹è¯•åˆ° Monitored Host çš„ SNMP
snmpwalk -v2c -c public <MonitoredHostPrivateIP> .1.3.6.1.2.1.1.1
```

### 5.4 æ·»åŠ  SNMP Interface

1. ã€ŒData collectionã€â†’ã€ŒHostsã€â†’ ç¼–è¾‘ `monitored-host-01`
2. ã€ŒInterfacesã€â†’ã€ŒAddã€â†’ã€ŒSNMPã€

| å­—æ®µ | å€¼ |
|------|-----|
| IP address | `<MonitoredHostPrivateIP>` |
| Port | `161` |
| SNMP version | `SNMPv2` |
| SNMP community | `public` |

3. ç‚¹å‡»ã€ŒUpdateã€

### 5.5 åˆ›å»º SNMP Item

1. ã€ŒItemsã€â†’ã€ŒCreate itemã€

| å­—æ®µ | å€¼ |
|------|-----|
| Name | `System description (SNMP)` |
| Type | `SNMP agent` |
| Key | `sysDescr` |
| SNMP OID | `.1.3.6.1.2.1.1.1.0` |
| Type of information | `Character` |

### 5.6 Agent vs SNMP é€‰æ‹©

| åœºæ™¯ | æ¨è |
|------|------|
| Linux/Windows æœåŠ¡å™¨ | Zabbix Agentï¼ˆæ›´å¤šæŒ‡æ ‡ï¼‰ |
| ç½‘ç»œè®¾å¤‡ï¼ˆäº¤æ¢æœºã€è·¯ç”±å™¨ï¼‰ | SNMP |
| æ— æ³•å®‰è£… Agent çš„è®¾å¤‡ | SNMP |
| éœ€è¦æ·±åº¦åº”ç”¨ç›‘æ§ | Agent + UserParameter |

---

## Mini-Projectï¼šå®Œæ•´æ—¥å¿— + è‡ªå®šä¹‰ç›‘æ§

> åœºæ™¯ï¼šç›‘æ§ä¸€ä¸ª Web åº”ç”¨çš„é”™è¯¯æ—¥å¿—å’Œé˜Ÿåˆ—æ·±åº¦

### è¦æ±‚

1. **æ—¥å¿—ç›‘æ§**
   - ç›‘æ§ `/var/log/httpd/error_log`ï¼ˆæˆ–åˆ›å»ºæ¨¡æ‹Ÿæ—¥å¿—ï¼‰
   - è§¦å‘å™¨ï¼š5 åˆ†é’Ÿå†…è¶…è¿‡ 10 æ¡ ERROR

2. **è‡ªå®šä¹‰æŒ‡æ ‡**
   - åˆ›å»º UserParameter ç›‘æ§åº”ç”¨è¿æ¥æ•°
   - è§¦å‘å™¨ï¼šè¿æ¥æ•° > 50 å‘Šè­¦

3. **SNMP ç›‘æ§**
   - æ·»åŠ  SNMP Interface
   - åˆ›å»ºç³»ç»Ÿè¿è¡Œæ—¶é—´ (sysUpTime) Item

### æ¨¡æ‹Ÿç¯å¢ƒ

```bash
# åˆ›å»ºæ¨¡æ‹Ÿæ—¥å¿—
sudo mkdir -p /var/log/myapp
sudo touch /var/log/myapp/app.log
sudo chmod 644 /var/log/myapp/app.log

# ç”Ÿæˆæµ‹è¯•é”™è¯¯æ—¥å¿—
for i in {1..15}; do
  echo "$(date '+%Y-%m-%d %H:%M:%S') ERROR: Test error $i" | sudo tee -a /var/log/myapp/app.log
done
```

---

## é¢è¯•é—®ç­”

### Q: UserParameter ã®æ³¨æ„ç‚¹ã¯ï¼Ÿ

**A**:
- **Timeout**: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ 3 ç§’ä»¥å†…ã«å®Œäº†ã™ã‚‹å¿…è¦ã‚ã‚Šã€‚é•·ã„ã‚³ãƒãƒ³ãƒ‰ã¯éåŒæœŸå‡¦ç†
- **æˆ»ã‚Šå€¤ã®å‹**: Item ã® Type of information ã¨ä¸€è‡´ã•ã›ã‚‹
- **å†èµ·å‹•å¿…è¦**: è¨­å®šå¤‰æ›´å¾Œã¯ `systemctl restart zabbix-agent2`
- **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**: ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã‚’ãã®ã¾ã¾å®Ÿè¡Œã—ãªã„ã€ãƒ‘ã‚¹/ã‚³ãƒãƒ³ãƒ‰ã®ãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆåŒ–
- **ãƒ†ã‚¹ãƒˆ**: æœ¬ç•ªç™»éŒ²å‰ã« `zabbix_agent2 -t` ã§ãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚¹ãƒˆ

### Q: SNMP ã¨ Agentã€ã©ã¡ã‚‰ã‚’ã„ã¤ä½¿ã†ï¼Ÿ

**A**:
- **Agent**: ã‚µãƒ¼ãƒãƒ¼ç›£è¦–ã«æœ€é©ã€‚è©³ç´°ãªãƒ¡ãƒˆãƒªã‚¯ã‚¹ã€ã‚«ã‚¹ã‚¿ãƒ ç›£è¦–ã€Active ãƒ¢ãƒ¼ãƒ‰ã§ NAT è¶Šã—å¯èƒ½
- **SNMP**: ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ©Ÿå™¨ï¼ˆãƒ«ãƒ¼ã‚¿ãƒ¼ã€ã‚¹ã‚¤ãƒƒãƒï¼‰ã«å¿…é ˆã€‚Agent ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸å¯ã®ç’°å¢ƒ
- **ä½µç”¨**: ã‚µãƒ¼ãƒãƒ¼ã§ã‚‚ Agent + SNMP ä¸¡æ–¹è¨­å®šã—ã€Agent éšœå®³æ™‚ã®ä»£æ›¿ç›£è¦–

---

## å¸¸è§é”™è¯¯

| é”™è¯¯ | åŸå›  | è§£å†³æ–¹æ¡ˆ |
|------|------|----------|
| Log item æ— æ•°æ® | Agent æ— è¯»å–æƒé™ | ç¡®è®¤ zabbix ç”¨æˆ·å¯è¯»å–æ—¥å¿— |
| UserParameter è¿”å›ç©º | å‘½ä»¤é”™è¯¯æˆ–è¶…æ—¶ | æœ¬åœ°æµ‹è¯• `zabbix_agent2 -t` |
| SNMP timeout | é˜²ç«å¢™é˜»æ­¢ UDP 161 | æ£€æŸ¥å®‰å…¨ç»„ |
| DB å¿«é€Ÿå¢é•¿ | æ—¥å¿— maxlines è¿‡å¤§ | å‡å° maxlinesï¼Œç¼©çŸ­ History |

---

## æœ¬è¯¾å°ç»“

| æ¦‚å¿µ | è¦ç‚¹ |
|------|------|
| log[] | é™æ€æ—¥å¿—æ–‡ä»¶ç›‘æ§ |
| logrt[] | è½®è½¬æ—¥å¿—ç›‘æ§ |
| maxlines | æ¯æ¬¡æœ€å¤§è¯»å–è¡Œæ•°ï¼Œé˜²æ­¢ DB è†¨èƒ€ |
| UserParameter | è‡ªå®šä¹‰ç›‘æ§å‘½ä»¤ |
| Macro | å¯é…ç½®å‚æ•°ï¼Œæ”¯æŒç»§æ‰¿ä¼˜å…ˆçº§ |
| SNMP | ç½‘ç»œè®¾å¤‡æ ‡å‡†åè®® |

---

## æ¸…ç†æé†’

> âš ï¸ **è´¹ç”¨æé†’**ï¼šå®éªŒç¯å¢ƒæŒç»­äº§ç”Ÿè´¹ç”¨ã€‚å®Œæˆæ•´ä¸ªç³»åˆ—åï¼Œè¯·åˆ é™¤ CloudFormation å †æ ˆã€‚
> è¯¦è§ â†’ [00 Â· æ¸…ç†èµ„æº](../00-architecture-lab/#æ¸…ç†èµ„æº)

---

## ä¸‹ä¸€æ­¥

æ—¥å¿—å’Œè‡ªå®šä¹‰ç›‘æ§å·²é…ç½®ï¼æœ€åä¸€è¯¾æˆ‘ä»¬å°†å­¦ä¹  LLDã€Proxy æ¦‚å¿µå’Œç›‘è§†è¨­è¨ˆæ›¸ã€‚

â†’ [06 Â· æ‰©å±•ä¸è¿ç»´å®è·µ](../06-ops-advanced/)

## ç³»åˆ—å¯¼èˆª

â† [04 Â· è§¦å‘å™¨ä¸å‘Šè­¦](../04-triggers-alerts/) | [ç³»åˆ—é¦–é¡µ](../) | [06 Â· æ‰©å±•ä¸è¿ç»´å®è·µ](../06-ops-advanced/) â†’
