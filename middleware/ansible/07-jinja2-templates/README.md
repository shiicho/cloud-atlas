# 07 Â· Jinja2 æ¨¡æ¿å¼•æ“è¯¦è§£ï¼ˆTemplate Engine Masteryï¼‰

> **ç›®æ ‡**ï¼šæŒæ¡ Jinja2 æ¨¡æ¿æŠ€æœ¯  
> **å‰ç½®**ï¼š[06 Â· Roles ä¸ Galaxy](../06-roles-galaxy/)  
> **æ—¶é—´**ï¼š35 åˆ†é’Ÿ  
> **å®æˆ˜é¡¹ç›®**ï¼šæ¨¡æ¿åŒ– Nginx é…ç½®

---

## å°†å­¦åˆ°çš„å†…å®¹

1. Jinja2 è¯­æ³•ï¼šå˜é‡ã€è¿‡æ»¤å™¨ã€æµ‹è¯•
2. æ§åˆ¶ç»“æ„ï¼šforã€if
3. å¸¸ç”¨è¿‡æ»¤å™¨
4. template æ¨¡å—ä½¿ç”¨
5. å¤æ‚é…ç½®æ–‡ä»¶ç”Ÿæˆ

---

## Step 1 â€” Jinja2 åŸºç¡€è¯­æ³•

```jinja2
{# è¿™æ˜¯æ³¨é‡Š #}

{# å˜é‡è¾“å‡º #}
{{ variable }}

{# è¡¨è¾¾å¼/è¯­å¥ #}
{% if condition %}
  ...
{% endif %}

{# è¿‡æ»¤å™¨ #}
{{ variable | filter }}
```

---

## Step 2 â€” å˜é‡å’Œè¿‡æ»¤å™¨

### 2.1 å˜é‡è®¿é—®

```jinja2
{# ç®€å•å˜é‡ #}
{{ http_port }}

{# å­—å…¸å±æ€§ #}
{{ server.name }}
{{ server['name'] }}

{# åˆ—è¡¨å…ƒç´  #}
{{ servers[0] }}

{# Facts #}
{{ ansible_hostname }}
{{ ansible_default_ipv4.address }}
```

### 2.2 å¸¸ç”¨è¿‡æ»¤å™¨

| è¿‡æ»¤å™¨ | è¯´æ˜ | ç¤ºä¾‹ |
|--------|------|------|
| `default` | é»˜è®¤å€¼ | `{{ var \| default('none') }}` |
| `upper/lower` | å¤§å°å†™ | `{{ name \| upper }}` |
| `join` | è¿æ¥åˆ—è¡¨ | `{{ list \| join(',') }}` |
| `int/float` | ç±»å‹è½¬æ¢ | `{{ '80' \| int }}` |
| `regex_replace` | æ­£åˆ™æ›¿æ¢ | `{{ str \| regex_replace('a', 'b') }}` |
| `to_yaml/to_json` | åºåˆ—åŒ– | `{{ dict \| to_yaml }}` |
| `b64encode` | Base64 ç¼–ç  | `{{ str \| b64encode }}` |
| `hash` | å“ˆå¸Œ | `{{ str \| hash('sha256') }}` |

### 2.3 è¿‡æ»¤å™¨ç¤ºä¾‹

```jinja2
{# é»˜è®¤å€¼ #}
Listen {{ http_port | default(80) }}

{# è¿æ¥åˆ—è¡¨ #}
AllowFrom {{ allowed_ips | join(' ') }}

{# æ¡ä»¶é»˜è®¤ #}
ServerName {{ server_name | default(ansible_hostname) }}

{# å­—ç¬¦ä¸²æ“ä½œ #}
DocumentRoot /var/www/{{ app_name | lower }}
```

---

## Step 3 â€” æ§åˆ¶ç»“æ„

### 3.1 æ¡ä»¶è¯­å¥

```jinja2
{% if debug_mode %}
LogLevel debug
{% else %}
LogLevel warn
{% endif %}

{# å¤šæ¡ä»¶ #}
{% if env == 'production' %}
MaxClients 200
{% elif env == 'staging' %}
MaxClients 100
{% else %}
MaxClients 50
{% endif %}
```

### 3.2 å¾ªç¯è¯­å¥

```jinja2
{# åŸºæœ¬å¾ªç¯ #}
{% for server in upstream_servers %}
server {{ server }};
{% endfor %}

{# å¸¦ç´¢å¼• #}
{% for server in servers %}
server_{{ loop.index }} = {{ server }}
{% endfor %}

{# å¾ªç¯å˜é‡ #}
{# loop.index    - ä» 1 å¼€å§‹çš„ç´¢å¼• #}
{# loop.index0   - ä» 0 å¼€å§‹çš„ç´¢å¼• #}
{# loop.first    - æ˜¯å¦ç¬¬ä¸€ä¸ª #}
{# loop.last     - æ˜¯å¦æœ€åä¸€ä¸ª #}
```

### 3.3 å¤æ‚ç¤ºä¾‹

```jinja2
upstream backend {
{% for server in backend_servers %}
    server {{ server.host }}:{{ server.port | default(8080) }} weight={{ server.weight | default(1) }};
{% endfor %}
}
```

---

## Step 4 â€” Template æ¨¡å—

### 4.1 åŸºæœ¬ç”¨æ³•

```yaml
- name: Deploy config
  ansible.builtin.template:
    src: nginx.conf.j2
    dest: /etc/nginx/nginx.conf
    owner: root
    group: root
    mode: '0644'
    backup: yes         # åˆ›å»ºå¤‡ä»½
  notify: Reload nginx
```

### 4.2 æ¨¡æ¿éªŒè¯

```yaml
- name: Deploy nginx config
  ansible.builtin.template:
    src: nginx.conf.j2
    dest: /etc/nginx/nginx.conf
    validate: nginx -t -c %s   # éƒ¨ç½²å‰éªŒè¯
```

---

## Step 5 â€” å®æˆ˜ï¼šNginx é…ç½®æ¨¡æ¿

### å˜é‡æ–‡ä»¶

```yaml
# vars/main.yaml
nginx_worker_processes: auto
nginx_worker_connections: 1024
upstream_servers:
  - host: 10.0.1.10
    port: 8080
    weight: 3
  - host: 10.0.1.11
    port: 8080
    weight: 2
server_name: example.com
ssl_enabled: true
```

### æ¨¡æ¿æ–‡ä»¶

```jinja2
# templates/nginx.conf.j2
# Generated by Ansible - DO NOT EDIT MANUALLY
# Managed by: {{ ansible_hostname }}
# Generated: {{ ansible_date_time.iso8601 }}

worker_processes {{ nginx_worker_processes | default('auto') }};

events {
    worker_connections {{ nginx_worker_connections | default(1024) }};
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    # Upstream servers
{% if upstream_servers is defined and upstream_servers | length > 0 %}
    upstream backend {
{% for server in upstream_servers %}
        server {{ server.host }}:{{ server.port | default(8080) }} weight={{ server.weight | default(1) }};
{% endfor %}
    }
{% endif %}

    server {
        listen 80;
{% if ssl_enabled | default(false) %}
        listen 443 ssl;
        ssl_certificate     /etc/nginx/ssl/cert.pem;
        ssl_certificate_key /etc/nginx/ssl/key.pem;
{% endif %}
        server_name {{ server_name | default('_') }};

        location / {
{% if upstream_servers is defined %}
            proxy_pass http://backend;
{% else %}
            root /var/www/html;
            index index.html;
{% endif %}
        }

        # Health check
        location /health {
            return 200 'OK';
            add_header Content-Type text/plain;
        }
    }
}
```

---

## Step 6 â€” /etc/hosts æ¨¡æ¿

```jinja2
# templates/hosts.j2
# Managed by Ansible
127.0.0.1   localhost
::1         localhost

# Inventory hosts
{% for host in groups['all'] %}
{{ hostvars[host]['ansible_default_ipv4']['address'] }}  {{ host }}
{% endfor %}
```

---

## Mini-Projectï¼šé…ç½®æ–‡ä»¶æ¨¡æ¿åŒ–

1. åˆ›å»º Nginx è´Ÿè½½å‡è¡¡é…ç½®æ¨¡æ¿
2. åŠ¨æ€ç”Ÿæˆ upstream åˆ—è¡¨
3. æ ¹æ®ç¯å¢ƒå¯ç”¨/ç¦ç”¨ SSL
4. éªŒè¯ï¼š`nginx -t` é€šè¿‡

---

## åŠ¨æ‰‹å‰æ£€æŸ¥æ¸…å•

| # | æ£€æŸ¥é¡¹ | éªŒè¯å‘½ä»¤ |
|---|--------|----------|
| 1 | æ¨¡æ¿æ–‡ä»¶å­˜åœ¨ | `ls templates/*.j2` |
| 2 | æ¨¡æ¿è¯­æ³•æ­£ç¡® | `ansible-playbook site.yaml --syntax-check` |
| 3 | å˜é‡å·²å®šä¹‰ | `ansible-inventory --host node1 --yaml` |
| 4 | å¹²è¿è¡ŒéªŒè¯ | `ansible-playbook site.yaml -C -D` |

---

## æ—¥æœ¬ä¼æ¥­ç¾å ´ãƒãƒ¼ãƒˆ

> ğŸ’¼ **æ¨¡æ¿ç®¡ç†çš„ä¼ä¸šå®è·µ**

| è¦ç‚¹ | è¯´æ˜ |
|------|------|
| **ç®¡ç†è€…ã‚³ãƒ¡ãƒ³ãƒˆ** | æ¨¡æ¿å¼€å¤´æ·»åŠ  `# Managed by Ansible - DO NOT EDIT` |
| **ç”Ÿæˆæ™‚åˆ»è¨˜éŒ²** | æ·»åŠ  `{{ ansible_date_time.iso8601 }}` ä¾¿äºè¿½è¸ª |
| **validate å¿…é ˆ** | é…ç½®æ–‡ä»¶å¿…é¡»ä½¿ç”¨ `validate` å‚æ•°éªŒè¯è¯­æ³• |
| **backup æ¨å¥¨** | ä½¿ç”¨ `backup: yes` ä¿ç•™å˜æ›´å‰å¤‡ä»½ |
| **ç’°å¢ƒåˆ¥å¤‰æ•°** | ä¸åŒç¯å¢ƒçš„é…ç½®å€¼æ”¾ `group_vars/{env}.yaml` |
| **æ©Ÿå¯†æƒ…å ±** | æ•æ„Ÿå˜é‡ä½¿ç”¨ Vault åŠ å¯†ï¼Œä¸è¦ç¡¬ç¼–ç  |

```yaml
# ç”Ÿäº§ç¯å¢ƒæ¨¡æ¿éƒ¨ç½²æ ‡å‡†åšæ³•
- name: Deploy nginx config
  ansible.builtin.template:
    src: nginx.conf.j2
    dest: /etc/nginx/nginx.conf
    owner: root
    group: root
    mode: '0644'
    backup: yes              # â† å¤‡ä»½åŸæ–‡ä»¶
    validate: nginx -t -c %s  # â† è¯­æ³•éªŒè¯
  notify: Reload nginx
```

> ğŸ“‹ **é¢è¯•/å…¥åœºæ—¶å¯èƒ½è¢«é—®**ï¼š
> - ã€Œãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã§æ°—ã‚’ã¤ã‘ã‚‹ã“ã¨ã¯ï¼Ÿã€â†’ validate ã§æ§‹æ–‡ãƒã‚§ãƒƒã‚¯ã€backup ã§å¤‰æ›´å‰ä¿å­˜
> - ã€ŒJinja2 ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã§ä¸€ç•ªä½¿ã†ã®ã¯ï¼Ÿã€â†’ defaultï¼ˆæœªå®šç¾©å¤‰æ•°å¯¾ç­–ï¼‰ã€joinï¼ˆãƒªã‚¹ãƒˆçµåˆï¼‰

---

## é¢è¯•è¦ç‚¹

> **å•é¡Œ**ï¼štemplate ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¨ copy ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®é•ã„ã¯ï¼Ÿ
>
> **å›ç­”**ï¼š
> - template ã¯ Jinja2 ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’å‡¦ç†ã€å¤‰æ•°ã‚’å±•é–‹
> - copy ã¯ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãã®ã¾ã¾ã‚³ãƒ”ãƒ¼
> - å‹•çš„å†…å®¹ã¯ templateã€é™çš„ãƒ•ã‚¡ã‚¤ãƒ«ã¯ copy ã‚’ä½¿ç”¨

---

## æœ¬è¯¾å°ç»“

| æ¦‚å¿µ | è¦ç‚¹ |
|------|------|
| `{{ }}` | å˜é‡è¾“å‡º |
| `{% %}` | æ§åˆ¶è¯­å¥ |
| `{# #}` | æ³¨é‡Š |
| è¿‡æ»¤å™¨ | `\| default()`, `\| join()` |
| template æ¨¡å— | éƒ¨ç½² Jinja2 æ¨¡æ¿ |

---

## ç³»åˆ—å¯¼èˆª

â† [06 Â· Roles](../06-roles-galaxy/) | [Home](../) | [Next â†’](../08-error-handling/)
