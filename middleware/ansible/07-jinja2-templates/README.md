# 07 · Jinja2 模板引擎详解（Template Engine Mastery）

> **目标**：掌握 Jinja2 模板技术
> **前置**：[06 · Roles 与 Galaxy](../06-roles-galaxy/)
> **时间**：35 分钟
> **实战项目**：模板化 Nginx 配置

---

## 将学到的内容

1. Jinja2 语法：变量、过滤器、测试
2. 控制结构：for、if
3. 常用过滤器
4. template 模块使用
5. 复杂配置文件生成

---

## Step 1 — Jinja2 基础语法

```jinja2
{# 这是注释 #}

{# 变量输出 #}
{{ variable }}

{# 表达式/语句 #}
{% if condition %}
  ...
{% endif %}

{# 过滤器 #}
{{ variable | filter }}
```

---

## Step 2 — 变量和过滤器

### 2.1 变量访问

```jinja2
{# 简单变量 #}
{{ http_port }}

{# 字典属性 #}
{{ server.name }}
{{ server['name'] }}

{# 列表元素 #}
{{ servers[0] }}

{# Facts #}
{{ ansible_hostname }}
{{ ansible_default_ipv4.address }}
```

### 2.2 常用过滤器

| 过滤器 | 说明 | 示例 |
|--------|------|------|
| `default` | 默认值 | `{{ var \| default('none') }}` |
| `upper/lower` | 大小写 | `{{ name \| upper }}` |
| `join` | 连接列表 | `{{ list \| join(',') }}` |
| `int/float` | 类型转换 | `{{ '80' \| int }}` |
| `regex_replace` | 正则替换 | `{{ str \| regex_replace('a', 'b') }}` |
| `to_yaml/to_json` | 序列化 | `{{ dict \| to_yaml }}` |
| `b64encode` | Base64 编码 | `{{ str \| b64encode }}` |
| `hash` | 哈希 | `{{ str \| hash('sha256') }}` |

### 2.3 过滤器示例

```jinja2
{# 默认值 #}
Listen {{ http_port | default(80) }}

{# 连接列表 #}
AllowFrom {{ allowed_ips | join(' ') }}

{# 条件默认 #}
ServerName {{ server_name | default(ansible_hostname) }}

{# 字符串操作 #}
DocumentRoot /var/www/{{ app_name | lower }}
```

---

## Step 3 — 控制结构

### 3.1 条件语句

```jinja2
{% if debug_mode %}
LogLevel debug
{% else %}
LogLevel warn
{% endif %}

{# 多条件 #}
{% if env == 'production' %}
MaxClients 200
{% elif env == 'staging' %}
MaxClients 100
{% else %}
MaxClients 50
{% endif %}
```

### 3.2 循环语句

```jinja2
{# 基本循环 #}
{% for server in upstream_servers %}
server {{ server }};
{% endfor %}

{# 带索引 #}
{% for server in servers %}
server_{{ loop.index }} = {{ server }}
{% endfor %}

{# 循环变量 #}
{# loop.index    - 从 1 开始的索引 #}
{# loop.index0   - 从 0 开始的索引 #}
{# loop.first    - 是否第一个 #}
{# loop.last     - 是否最后一个 #}
```

### 3.3 复杂示例

```jinja2
upstream backend {
{% for server in backend_servers %}
    server {{ server.host }}:{{ server.port | default(8080) }} weight={{ server.weight | default(1) }};
{% endfor %}
}
```

---

## Step 4 — Template 模块

### 4.1 基本用法

```yaml
- name: Deploy config
  ansible.builtin.template:
    src: nginx.conf.j2
    dest: /etc/nginx/nginx.conf
    owner: root
    group: root
    mode: '0644'
    backup: yes         # 创建备份
  notify: Reload nginx
```

### 4.2 模板验证

```yaml
- name: Deploy nginx config
  ansible.builtin.template:
    src: nginx.conf.j2
    dest: /etc/nginx/nginx.conf
    validate: nginx -t -c %s   # 部署前验证
```

---

## Step 5 — 实战：Nginx 配置模板

### 变量文件

```yaml
# vars/main.yaml
nginx_worker_processes: auto
nginx_worker_connections: 1024
upstream_servers:
  - host: 10.0.1.10
    port: 8080
    weight: 3
  - host: 10.0.1.11
    port: 8080
    weight: 2
server_name: example.com
ssl_enabled: true
```

### 模板文件

```jinja2
# templates/nginx.conf.j2
# Generated by Ansible - DO NOT EDIT MANUALLY
# Managed by: {{ ansible_hostname }}
# Generated: {{ ansible_date_time.iso8601 }}

worker_processes {{ nginx_worker_processes | default('auto') }};

events {
    worker_connections {{ nginx_worker_connections | default(1024) }};
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    # Upstream servers
{% if upstream_servers is defined and upstream_servers | length > 0 %}
    upstream backend {
{% for server in upstream_servers %}
        server {{ server.host }}:{{ server.port | default(8080) }} weight={{ server.weight | default(1) }};
{% endfor %}
    }
{% endif %}

    server {
        listen 80;
{% if ssl_enabled | default(false) %}
        listen 443 ssl;
        ssl_certificate     /etc/nginx/ssl/cert.pem;
        ssl_certificate_key /etc/nginx/ssl/key.pem;
{% endif %}
        server_name {{ server_name | default('_') }};

        location / {
{% if upstream_servers is defined %}
            proxy_pass http://backend;
{% else %}
            root /var/www/html;
            index index.html;
{% endif %}
        }

        # Health check
        location /health {
            return 200 'OK';
            add_header Content-Type text/plain;
        }
    }
}
```

---

## Step 6 — /etc/hosts 模板

```jinja2
# templates/hosts.j2
# Managed by Ansible
127.0.0.1   localhost
::1         localhost

# Inventory hosts
{% for host in groups['all'] %}
{{ hostvars[host]['ansible_default_ipv4']['address'] }}  {{ host }}
{% endfor %}
```

---

## Mini-Project：配置文件模板化

1. 创建 Nginx 负载均衡配置模板
2. 动态生成 upstream 列表
3. 根据环境启用/禁用 SSL
4. 验证：`nginx -t` 通过

---

## 面试要点

> **問題**：template モジュールと copy モジュールの違いは？
>
> **回答**：
> - template は Jinja2 テンプレートを処理、変数を展開
> - copy はファイルをそのままコピー
> - 動的内容は template、静的ファイルは copy を使用

---

## 本课小结

| 概念 | 要点 |
|------|------|
| `{{ }}` | 变量输出 |
| `{% %}` | 控制语句 |
| `{# #}` | 注释 |
| 过滤器 | `\| default()`, `\| join()` |
| template 模块 | 部署 Jinja2 模板 |

---

## 系列导航

← [06 · Roles](../06-roles-galaxy/) | [Home](../) | [Next →](../08-error-handling/)
