# =============================================================================
# 05-aws-ec2-dynamic.yaml - AWS EC2 Dynamic Inventory
# =============================================================================
#
# CONCEPT: Auto-discover EC2 instances instead of manual host list
#
# Prerequisites:
#   1. Install amazon.aws collection:
#      ansible-galaxy collection install amazon.aws
#
#   2. Configure AWS credentials:
#      aws configure
#      # or use IAM role on EC2
#
# Usage:
#   # List discovered hosts
#   ansible-inventory -i 05-aws-ec2-dynamic.yaml --list
#
#   # Ping all discovered hosts
#   ansible -i 05-aws-ec2-dynamic.yaml all -m ping
#
#   # Target specific tag group
#   ansible -i 05-aws-ec2-dynamic.yaml tag_Environment_production -m ping
#
# =============================================================================

---
# This line tells Ansible to use the aws_ec2 inventory plugin
# この行でaws_ec2プラグインを使用することを指定
plugin: amazon.aws.aws_ec2

# AWS region to query
# 対象リージョン
regions:
  - ap-northeast-1  # Tokyo

# Only include running instances
# 実行中のインスタンスのみ
filters:
  instance-state-name: running
  # Optional: filter by specific tag
  # tag:Project: ansible-lab

# How to name hosts in inventory
# インベントリでのホスト名の付け方
hostnames:
  # Priority order: try Name tag first, then private IP
  - tag:Name
  - private-ip-address

# Create groups based on tags
# タグに基づいてグループを作成
keyed_groups:
  # Group by Environment tag: tag_Environment_production, tag_Environment_staging
  - key: tags.Environment
    prefix: tag_Environment
    separator: "_"

  # Group by instance type: instance_type_t3_micro, instance_type_t3_small
  - key: instance_type
    prefix: instance_type

  # Group by availability zone: az_ap_northeast_1a
  - key: placement.availability_zone
    prefix: az

# Add these variables to all hosts
# 全ホストに追加する変数
compose:
  ansible_host: private_ip_address
  ansible_user: ec2-user
  # For Amazon Linux 2023
  ansible_python_interpreter: /usr/bin/python3
