# =============================================================================
# 03-with-handler.yaml - Playbook with Handlers
# =============================================================================
#
# CONCEPT: Handlers run only when notified, typically for service restarts
#
# What's new from 02:
#   + handlers: section for triggered actions
#   + notify: to trigger a handler
#
# Handler behavior:
#   - Only runs if the notifying task reports "changed"
#   - Runs at the END of the play (not immediately)
#   - Runs only ONCE even if notified multiple times
#
# Compare with previous:
#   diff 02-with-vars.yaml 03-with-handler.yaml
#
# Run with:
#   ansible-playbook 03-with-handler.yaml
#
# =============================================================================
---
- name: Configure web server with handler
  hosts: all
  become: true  # Run as root (sudo)

  vars:
    config_file: /tmp/app.conf
    app_port: 8080

  tasks:
    - name: Create application config file
      ansible.builtin.copy:
        dest: "{{ config_file }}"
        content: |
          # Application Configuration
          # アプリケーション設定
          port={{ app_port }}
          debug=false
        mode: '0644'
      # When this task changes the file, notify the handler
      # ファイルが変更されたらハンドラーに通知
      notify: Restart application

    - name: Show config file content
      ansible.builtin.command: cat {{ config_file }}
      register: config_content
      changed_when: false  # This is just for display, not a change

    - name: Display config
      ansible.builtin.debug:
        var: config_content.stdout_lines

  # Handlers section - runs at the END of the play
  # ハンドラーセクション - プレイの最後に実行
  handlers:
    - name: Restart application
      ansible.builtin.debug:
        msg: "Would restart application service here (simulated)"
      # In real scenario:
      # ansible.builtin.service:
      #   name: myapp
      #   state: restarted
