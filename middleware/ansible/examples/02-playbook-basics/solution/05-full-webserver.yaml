# =============================================================================
# 05-full-webserver.yaml - Complete Web Server Deployment
# =============================================================================
#
# CONCEPT: Real-world playbook combining all previous concepts
#
# Includes:
#   - Variables with defaults
#   - Conditionals (when)
#   - Loops
#   - Handlers
#   - Tags
#   - Multiple plays
#
# This playbook:
#   1. Installs nginx
#   2. Deploys a custom index.html
#   3. Ensures nginx is running
#   4. Verifies the deployment
#
# Run with:
#   ansible-playbook 05-full-webserver.yaml
#
#   # Only deploy config
#   ansible-playbook 05-full-webserver.yaml --tags config
#
#   # Skip verification
#   ansible-playbook 05-full-webserver.yaml --skip-tags verify
#
# =============================================================================
---
# Play 1: Deploy web server
# プレイ1：Webサーバーのデプロイ
- name: Deploy nginx web server
  hosts: webservers
  become: true

  vars:
    # Web server configuration
    # Webサーバー設定
    http_port: 80
    server_name: "{{ ansible_hostname }}"
    document_root: /var/www/html

    # Page content
    page_title: "Welcome to {{ server_name }}"
    page_body: "Deployed by Ansible at {{ ansible_date_time.iso8601 }}"

  tasks:
    # Installation
    # インストール
    - name: Install nginx
      ansible.builtin.package:
        name: nginx
        state: present
      tags:
        - install
        - setup

    - name: Ensure document root exists
      ansible.builtin.file:
        path: "{{ document_root }}"
        state: directory
        mode: '0755'
      tags:
        - setup

    # Configuration
    # 設定
    - name: Deploy index.html
      ansible.builtin.template:
        src: index.html.j2
        dest: "{{ document_root }}/index.html"
        mode: '0644'
      notify: Reload nginx
      tags:
        - config
        - deploy

    # This task creates a simple template inline (for demo without files)
    - name: Create simple index.html (inline)
      ansible.builtin.copy:
        dest: "{{ document_root }}/index.html"
        content: |
          <!DOCTYPE html>
          <html>
          <head>
            <title>{{ page_title }}</title>
            <meta charset="utf-8">
          </head>
          <body>
            <h1>{{ page_title }}</h1>
            <p>{{ page_body }}</p>
            <hr>
            <p>Server: {{ server_name }}</p>
            <p>OS: {{ ansible_distribution }} {{ ansible_distribution_version }}</p>
          </body>
          </html>
        mode: '0644'
      notify: Reload nginx
      tags:
        - config
        - deploy

    # Service management
    # サービス管理
    - name: Ensure nginx is started and enabled
      ansible.builtin.service:
        name: nginx
        state: started
        enabled: true
      tags:
        - service

  handlers:
    - name: Reload nginx
      ansible.builtin.service:
        name: nginx
        state: reloaded

# Play 2: Verify deployment
# プレイ2：デプロイの検証
- name: Verify web server deployment
  hosts: webservers
  become: false

  tasks:
    - name: Check nginx is responding
      ansible.builtin.uri:
        url: "http://{{ ansible_host }}:80/"
        return_content: true
      register: webpage
      tags:
        - verify

    - name: Show page title
      ansible.builtin.debug:
        msg: "Page accessible: {{ 'Welcome' in webpage.content }}"
      tags:
        - verify

# Play 3: Summary (runs on localhost)
# プレイ3：サマリー（localhostで実行）
- name: Deployment summary
  hosts: localhost
  connection: local
  gather_facts: false

  tasks:
    - name: Print summary
      ansible.builtin.debug:
        msg:
          - "================================"
          - "Deployment Complete!"
          - "================================"
          - "Deployed to: {{ groups['webservers'] | default(['no hosts']) | join(', ') }}"
          - "Check: http://<host-ip>:80/"
          - "================================"
      tags:
        - always
