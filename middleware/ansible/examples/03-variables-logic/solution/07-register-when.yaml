# =============================================================================
# 07-register-when.yaml - Combining Register + When
# =============================================================================
#
# CONCEPT: Use registered values in conditional execution
#
# This is the most powerful pattern:
#   1. Run a check/command
#   2. Register the result
#   3. Use the result in 'when' conditions
#
# Common patterns:
#   - Check if file exists → create if not
#   - Check if service running → start if not
#   - Check if package installed → install if not
#
# =============================================================================
---
- name: Register + When patterns
  hosts: all
  become: true

  vars:
    app_config: /tmp/myapp.conf
    required_packages:
      - htop
      - jq

  tasks:
    # Pattern 1: File existence check → create if missing
    # パターン1：ファイル存在チェック → 存在しなければ作成
    - name: Check if config file exists
      ansible.builtin.stat:
        path: "{{ app_config }}"
      register: config_check

    - name: Create config file if missing
      ansible.builtin.copy:
        dest: "{{ app_config }}"
        content: |
          # Auto-generated config
          created_at={{ ansible_date_time.iso8601 }}
        mode: '0644'
      when: not config_check.stat.exists

    - name: Config already exists
      ansible.builtin.debug:
        msg: "Config file already exists, skipping creation"
      when: config_check.stat.exists

    # Pattern 2: Command output check
    # パターン2：コマンド出力チェック
    - name: Get free disk space
      ansible.builtin.command: df -BG / --output=avail
      register: disk_space
      changed_when: false

    - name: Parse disk space (remove header and 'G')
      ansible.builtin.set_fact:
        free_gb: "{{ disk_space.stdout_lines[1] | regex_replace('[^0-9]', '') | int }}"

    - name: Warn if disk space low (< 5GB)
      ansible.builtin.debug:
        msg: "WARNING: Only {{ free_gb }}GB free disk space!"
      when: free_gb | int < 5

    - name: Disk space OK
      ansible.builtin.debug:
        msg: "Disk space OK: {{ free_gb }}GB available"
      when: free_gb | int >= 5

    # Pattern 3: Service status → action
    # パターン3：サービス状態 → アクション
    - name: Check if nginx is installed
      ansible.builtin.command: which nginx
      register: nginx_check
      ignore_errors: true
      changed_when: false

    - name: Nginx is installed
      ansible.builtin.debug:
        msg: "Nginx found at {{ nginx_check.stdout }}"
      when: nginx_check.rc == 0

    - name: Nginx is NOT installed
      ansible.builtin.debug:
        msg: "Nginx not found - would install here"
      when: nginx_check.rc != 0

    # Pattern 4: Loop with conditional
    # パターン4：条件付きループ
    - name: Check each required package
      ansible.builtin.command: "rpm -q {{ item }}"
      register: package_checks
      loop: "{{ required_packages }}"
      ignore_errors: true
      changed_when: false

    - name: Show missing packages
      ansible.builtin.debug:
        msg: "Package {{ item.item }} is NOT installed"
      loop: "{{ package_checks.results }}"
      when: item.rc != 0
      loop_control:
        label: "{{ item.item }}"

    # Pattern 5: Complex condition with registered value
    # パターン5：登録値を使った複合条件
    - name: Get system load
      ansible.builtin.command: cat /proc/loadavg
      register: loadavg
      changed_when: false

    - name: Parse load average
      ansible.builtin.set_fact:
        current_load: "{{ loadavg.stdout.split()[0] | float }}"

    - name: Alert if high load AND production
      ansible.builtin.debug:
        msg: "ALERT: High load {{ current_load }} on production!"
      when:
        - current_load | float > 2.0
        - "'prod' in ansible_hostname or true"  # Demo condition

    # Summary pattern: Check → Register → Decide → Act
    # サマリーパターン：チェック → 登録 → 判断 → 実行
    - name: Summary - Complete workflow
      ansible.builtin.debug:
        msg: |
          === Workflow Complete ===
          Config exists: {{ config_check.stat.exists }}
          Free disk: {{ free_gb }}GB
          Nginx installed: {{ nginx_check.rc == 0 }}
          Current load: {{ current_load }}
          ========================
