# =============================================================================
# 06-register-basic.yaml - Capturing Task Output
# =============================================================================
#
# CONCEPT: Use 'register' to capture task output for later use
#
# register: saves the result of a task to a variable
#
# Common registered fields:
#   .rc          - Return code (0 = success)
#   .stdout      - Standard output as string
#   .stdout_lines - Standard output as list
#   .stderr      - Standard error
#   .changed     - Whether task made changes
#   .failed      - Whether task failed
#
# Compare with previous:
#   diff 05-when-multiple.yaml 06-register-basic.yaml
#
# =============================================================================
---
- name: Capturing task output with register
  hosts: all
  gather_facts: true

  tasks:
    # Register command output
    # コマンド出力を登録
    - name: Get current date
      ansible.builtin.command: date +%Y-%m-%d
      register: date_result
      changed_when: false  # Command doesn't change anything

    - name: Show registered variable (full)
      ansible.builtin.debug:
        var: date_result

    - name: Show just stdout
      ansible.builtin.debug:
        msg: "Today is: {{ date_result.stdout }}"

    # Register multi-line output
    # 複数行出力の登録
    - name: List files in /tmp
      ansible.builtin.command: ls -la /tmp
      register: tmp_files
      changed_when: false

    - name: Show as lines (list)
      ansible.builtin.debug:
        msg: "Found {{ tmp_files.stdout_lines | length }} lines"

    - name: Show first 3 lines
      ansible.builtin.debug:
        var: tmp_files.stdout_lines[:3]

    # Register package check
    # パッケージチェックの登録
    - name: Check if htop is installed
      ansible.builtin.command: which htop
      register: htop_check
      ignore_errors: true  # Don't fail if not found
      changed_when: false

    - name: Show htop check result
      ansible.builtin.debug:
        msg: "htop found: {{ htop_check.rc == 0 }}"

    # Register file stat
    # ファイル状態の登録
    - name: Check if config file exists
      ansible.builtin.stat:
        path: /etc/hostname
      register: config_stat

    - name: Show file info
      ansible.builtin.debug:
        msg: |
          File exists: {{ config_stat.stat.exists }}
          Size: {{ config_stat.stat.size }} bytes
          Mode: {{ config_stat.stat.mode }}

    # Register service status
    # サービス状態の登録
    - name: Check sshd service status
      ansible.builtin.command: systemctl is-active sshd
      register: sshd_status
      changed_when: false
      ignore_errors: true

    - name: Show sshd status
      ansible.builtin.debug:
        msg: "SSHD is {{ sshd_status.stdout }}"
