# =============================================================================
# 05-when-multiple.yaml - Multiple Conditions (AND/OR)
# =============================================================================
#
# CONCEPT: Combine multiple conditions with and/or
#
# Syntax:
#   AND: when: condition1 and condition2
#   OR:  when: condition1 or condition2
#   List: when:  (all must be true = AND)
#           - condition1
#           - condition2
#
# Compare with previous:
#   diff 04-when-basic.yaml 05-when-multiple.yaml
#
# =============================================================================
---
- name: Multiple conditions demonstration
  hosts: all
  become: true

  vars:
    env: production
    enable_feature_a: true
    enable_feature_b: false
    min_memory_mb: 512
    allowed_regions:
      - ap-northeast-1
      - ap-northeast-3

  tasks:
    # AND with 'and' keyword
    # 'and' キーワードによるAND条件
    - name: Production AND Amazon Linux
      ansible.builtin.debug:
        msg: "Production Amazon Linux server"
      when: env == "production" and ansible_distribution == "Amazon"

    # AND with list syntax (preferred for multiple conditions)
    # リスト構文によるAND条件（複数条件の場合推奨）
    - name: Multiple AND conditions (list syntax)
      ansible.builtin.debug:
        msg: "All conditions met!"
      when:
        - env == "production"
        - ansible_distribution == "Amazon"
        - ansible_memory_mb.real.total > min_memory_mb

    # OR with 'or' keyword
    # 'or' キーワードによるOR条件
    - name: Amazon OR Ubuntu
      ansible.builtin.debug:
        msg: "This is either Amazon or Ubuntu"
      when: ansible_distribution == "Amazon" or ansible_distribution == "Ubuntu"

    # OR using 'in' (cleaner for multiple values)
    # 'in' を使ったOR条件（複数値の場合クリーン）
    - name: Supported distribution check
      ansible.builtin.debug:
        msg: "{{ ansible_distribution }} is supported"
      when: ansible_distribution in ['Amazon', 'Ubuntu', 'CentOS']

    # Complex: AND + OR combined
    # 複合条件：AND + OR の組み合わせ
    - name: Complex condition
      ansible.builtin.debug:
        msg: "Complex condition met"
      when: >
        env == "production" and
        (ansible_distribution == "Amazon" or ansible_distribution == "Ubuntu")

    # Feature flags with AND
    # フィーチャーフラグのAND条件
    - name: Both features enabled
      ansible.builtin.debug:
        msg: "Both Feature A and B are enabled"
      when: enable_feature_a and enable_feature_b

    - name: Either feature enabled
      ansible.builtin.debug:
        msg: "At least one feature is enabled"
      when: enable_feature_a or enable_feature_b

    # NOT with multiple conditions
    # NOT と複数条件
    - name: Not development and not debugging
      ansible.builtin.debug:
        msg: "Not in dev mode and no debugging"
      when:
        - env != "development"
        - not enable_feature_b

    # Practical: OS-specific package installation
    # 実用例：OS固有のパッケージインストール
    - name: Install package on RHEL-based (Amazon/CentOS)
      ansible.builtin.debug:
        msg: "Would use dnf/yum here"
      when: ansible_os_family == "RedHat"

    - name: Install package on Debian-based (Ubuntu/Debian)
      ansible.builtin.debug:
        msg: "Would use apt here"
      when: ansible_os_family == "Debian"
