---
# 05-loops-advanced.yaml - 高级循环模式
# 学习目标: 掌握 with_sequence, with_dict, until 等高级循环

- name: Advanced Loop Patterns
  hosts: all
  become: true

  vars:
    user_directories:
      alice:
        - documents
        - downloads
        - scripts
      bob:
        - projects
        - data

    services_config:
      sshd:
        port: 22
        enabled: true
      httpd:
        port: 80
        enabled: false

  tasks:
    # with_sequence - 数字序列
    - name: Create numbered directories
      ansible.builtin.file:
        path: "/tmp/dir_{{ item }}"
        state: directory
        mode: '0755'
      with_sequence: start=1 end=5 format=%02d

    # with_sequence - 带步进
    - name: Create even numbered files
      ansible.builtin.file:
        path: "/tmp/even_{{ item }}.txt"
        state: touch
        mode: '0644'
      with_sequence: start=0 end=10 stride=2

    # with_dict - 字典遍历
    - name: Show service configuration
      ansible.builtin.debug:
        msg: "Service {{ item.key }}: port={{ item.value.port }}, enabled={{ item.value.enabled }}"
      with_dict: "{{ services_config }}"

    # with_subelements - 嵌套循环
    - name: Create user directories
      ansible.builtin.file:
        path: "/home/{{ item.0.key }}/{{ item.1 }}"
        state: directory
        mode: '0755'
        owner: "{{ item.0.key }}"
      with_subelements:
        - "{{ user_directories | dict2items }}"
        - value
      loop_control:
        label: "{{ item.0.key }}/{{ item.1 }}"
      ignore_errors: true  # 用户可能不存在

    # until - 重试直到成功
    - name: Wait for file to appear (simulated)
      ansible.builtin.command: test -f /tmp/dir_01
      register: result
      until: result.rc == 0
      retries: 3
      delay: 1
      changed_when: false

    # 随机选择
    - name: Pick a random color
      ansible.builtin.debug:
        msg: "Selected color: {{ item }}"
      with_random_choice:
        - red
        - green
        - blue
        - yellow

    # 清理
    - name: Cleanup test directories
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      loop:
        - /tmp/dir_01
        - /tmp/dir_02
        - /tmp/dir_03
        - /tmp/dir_04
        - /tmp/dir_05
      tags: cleanup
...
