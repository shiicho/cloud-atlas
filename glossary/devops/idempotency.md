# 幂等性（Idempotency）

**TL;DR**：同一操作执行一次和执行多次，结果完全相同。自动化运维的核心原则。

## 日常类比

| 场景 | 幂等 | 非幂等 |
|------|------|--------|
| 电梯按钮 | 按 1 次和按 10 次，都只到目标楼层 | - |
| 开灯开关 | "打开灯"指令执行多次，灯始终是开 | - |
| ATM 取款 | - | 每次操作都扣钱 |

## 为什么重要？

```
┌─────────────────────────────────────────────────────┐
│  网络超时，脚本自动重试...                            │
│                                                     │
│  非幂等操作：                                        │
│    创建用户 → 创建用户 → 创建用户                     │
│    结果：3 个重复用户 ❌                              │
│                                                     │
│  幂等操作：                                          │
│    确保用户存在 → 确保用户存在 → 确保用户存在          │
│    结果：1 个用户 ✅                                  │
└─────────────────────────────────────────────────────┘
```

## 在自动化工具中

| 工具 | 幂等实现 |
|------|----------|
| **Ansible** | 模块设计为幂等；`state: present` 而非 `create` |
| **Terraform** | 声明式；检测当前状态，只修改差异 |
| **HTTP API** | GET/PUT/DELETE 幂等；POST 通常非幂等 |

## 如何写幂等代码？

```bash
# ❌ 非幂等：每次追加
echo "export PATH=/opt/bin:$PATH" >> ~/.bashrc

# ✅ 幂等：先检查再追加
grep -q '/opt/bin' ~/.bashrc || echo "export PATH=/opt/bin:$PATH" >> ~/.bashrc
```

## 面试一句话

> **問**：べき等性とは何ですか？  
> **答**：同じ操作を何度実行しても、結果が同じになる性質です。Ansible や Terraform の設計原則です。

---

→ 相关：[Ansible Ad-hoc 命令](../../middleware/ansible/03-adhoc-modules/) · [Terraform 概念](../../devops/terraform/00-concepts/)
