# OIDC 身份认证（OpenID Connect）

**TL;DR**：基于 OAuth 2.0 的身份认证协议。让第三方应用验证用户身份，无需管理密码。

## 日常类比

| 场景 | 传统方式 | OIDC 方式 |
|------|----------|-----------|
| 酒店入住 | 每家酒店单独注册账号 | 用护照（身份提供者）证明身份 |
| 网站登录 | 为每个网站创建密码 | "使用 Google 登录" |
| 系统访问 | 存储长期密钥 | 临时令牌，自动过期 |

## 为什么重要？

```
┌─────────────────────────────────────────────────────────────┐
│  传统方式：长期凭证                                           │
│                                                             │
│    应用 ←──── Access Key ────→ 云服务                        │
│              (永不过期，泄露风险高)                            │
│                                                             │
├─────────────────────────────────────────────────────────────┤
│  OIDC 方式：联合身份                                          │
│                                                             │
│    应用 ──→ 身份提供者 ──→ 云服务                             │
│           (GitHub/Google)   (验证身份，发放临时凭证)           │
│                                                             │
│    ✅ 无需存储长期密钥                                        │
│    ✅ 令牌自动过期（通常 1 小时）                              │
│    ✅ 可审计谁在何时访问                                      │
└─────────────────────────────────────────────────────────────┘
```

## 核心概念

| 术语 | 英文 | 说明 |
|------|------|------|
| 身份提供者 | Identity Provider (IdP) | 验证用户身份的服务（GitHub、Google、Okta） |
| 服务提供者 | Service Provider (SP) | 需要验证用户身份的应用（AWS、Azure） |
| ID Token | ID Token | JWT 格式的身份证明，包含用户信息 |
| Claims | Claims | Token 中的声明（用户名、邮箱、所属组织） |

## OIDC 认证流程

```
┌──────────┐     ┌──────────────┐     ┌──────────────┐
│  Client  │     │ Identity     │     │   Service    │
│  (App)   │     │ Provider     │     │   Provider   │
└────┬─────┘     └──────┬───────┘     └──────┬───────┘
     │                  │                    │
     │ 1. 请求认证       │                    │
     │─────────────────→│                    │
     │                  │                    │
     │ 2. 返回 ID Token │                    │
     │←─────────────────│                    │
     │                  │                    │
     │ 3. 携带 Token 请求访问                 │
     │──────────────────────────────────────→│
     │                  │                    │
     │                  │ 4. 验证 Token 签名  │
     │                  │←───────────────────│
     │                  │                    │
     │ 5. 授予临时凭证                        │
     │←──────────────────────────────────────│
```

## 常见应用场景

| 场景 | 身份提供者 | 服务提供者 | 用途 |
|------|-----------|-----------|------|
| CI/CD 流水线 | GitHub Actions | AWS | 无密钥部署 |
| 企业 SSO | Okta / Azure AD | 内部应用 | 统一登录 |
| 社交登录 | Google / Facebook | 网站 | 用户注册 |
| Kubernetes | OIDC Provider | K8s API | Pod 身份 |

## 与 OAuth 2.0 的区别

| 特性 | OAuth 2.0 | OIDC |
|------|-----------|------|
| 目的 | 授权（Authorization） | 认证（Authentication） |
| 返回内容 | Access Token | Access Token + **ID Token** |
| 用户信息 | 需要额外请求 | ID Token 中包含 |
| 标准化 | 授权框架 | 身份认证协议 |

**简单理解**：OAuth 回答"你能做什么"，OIDC 回答"你是谁"。

## 安全优势

| 优势 | 说明 |
|------|------|
| 无密钥管理 | 不需要在 CI/CD 中存储长期凭证 |
| 自动轮换 | Token 短期有效，自动过期 |
| 最小权限 | Token 包含 scope 限制 |
| 可追溯 | CloudTrail 记录谁在何时访问 |
| 标准协议 | 跨平台兼容，广泛支持 |

## 面试一句话

> **問**：OIDC とは何ですか？
> **答**：OAuth 2.0 を拡張した認証プロトコルです。GitHub Actions から AWS への認証など、パスワードレスで安全なアクセスを実現します。ID Token により「誰がアクセスしているか」を証明できます。

---

→ 相关：[GitHub Actions OIDC](../../iac/terraform/11-cicd/) · [AWS IAM](../../aws/iam/) · [OAuth 2.0](./oauth.md)
