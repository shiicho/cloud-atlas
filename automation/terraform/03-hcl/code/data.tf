# data.tf
# Data Sources 演示
#
# Data Sources 用于查询现有资源，而不是创建新资源。
# 常见用途：
# 1. 获取最新 AMI ID（避免硬编码）
# 2. 查询可用区列表
# 3. 获取账户 ID、区域信息
# 4. 引用手动创建的资源

# -----------------------------------------------------------------------------
# 可用区查询
# -----------------------------------------------------------------------------
# 查询当前区域所有可用的 Availability Zones
#
# 使用方式：
#   data.aws_availability_zones.available.names[0]
#   → 返回第一个可用区，如 "ap-northeast-1a"

data "aws_availability_zones" "available" {
  state = "available"

  # 可选：排除特定类型的可用区
  # filter {
  #   name   = "opt-in-status"
  #   values = ["opt-in-not-required"]
  # }
}

# -----------------------------------------------------------------------------
# 最新 Amazon Linux 2023 AMI
# -----------------------------------------------------------------------------
# 查询最新的 Amazon Linux 2023 AMI ID
#
# 为什么使用 Data Source 而不是硬编码 AMI ID？
# 1. AMI ID 在不同区域不同
# 2. AMI 会定期更新（安全补丁）
# 3. 硬编码会导致代码不可移植
#
# 使用方式：
#   data.aws_ami.al2023.id
#   → 返回 AMI ID，如 "ami-0a1b2c3d4e5f6g7h8"

data "aws_ami" "al2023" {
  most_recent = true
  owners      = ["amazon"]

  filter {
    name   = "name"
    values = ["al2023-ami-*-x86_64"]
  }

  filter {
    name   = "virtualization-type"
    values = ["hvm"]
  }

  filter {
    name   = "root-device-type"
    values = ["ebs"]
  }
}

# -----------------------------------------------------------------------------
# 当前 AWS 账户信息
# -----------------------------------------------------------------------------
# 获取当前调用者的身份信息
#
# 使用方式：
#   data.aws_caller_identity.current.account_id
#   → 返回 AWS 账户 ID

data "aws_caller_identity" "current" {}

# -----------------------------------------------------------------------------
# 当前区域信息
# -----------------------------------------------------------------------------
# 获取当前 Provider 配置的区域
#
# 使用方式：
#   data.aws_region.current.name
#   → 返回区域名，如 "ap-northeast-1"

data "aws_region" "current" {}

# -----------------------------------------------------------------------------
# Data Source vs Resource 对比
# -----------------------------------------------------------------------------
#
# | 类型     | 作用        | State 中记录 | 示例                          |
# |----------|-------------|--------------|-------------------------------|
# | resource | 创建新资源  | 是           | aws_vpc.main                  |
# | data     | 查询现有    | 是（只读）   | data.aws_ami.al2023           |
#
# Data Source 也会记录在 State 中，但只包含查询结果，不管理资源生命周期。
# -----------------------------------------------------------------------------
