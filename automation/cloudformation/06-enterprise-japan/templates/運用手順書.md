# 運用手順書

## CloudFormation Stack 操作手順

> CloudFormation Stack の作成・更新・削除に関する標準運用手順

---

## 文書情報

| 項目 | 内容 |
|------|------|
| 文書番号 | OPE-CFN-001 |
| 版数 | v1.0 |
| 作成日 | YYYY/MM/DD |
| 最終更新日 | YYYY/MM/DD |
| 作成者 | |
| 承認者 | |

---

## 目次

1. [概要](#1-概要)
2. [事前準備](#2-事前準備)
3. [Stack 作成手順](#3-stack-作成手順)
4. [Stack 更新手順](#4-stack-更新手順)
5. [Stack 削除手順](#5-stack-削除手順)
6. [トラブルシューティング](#6-トラブルシューティング)
7. [緊急時対応](#7-緊急時対応)

---

## 1. 概要

### 1.1 目的

本手順書は、AWS CloudFormation Stack の作成・更新・削除における標準的な操作手順を定めるものです。

### 1.2 対象者

- 運用担当者
- インフラエンジニア
- 変更作業実施者

### 1.3 前提条件

- AWS マネジメントコンソールへのアクセス権限
- CloudFormation 操作に必要な IAM 権限
- 変更管理書の承認完了

---

## 2. 事前準備

### 2.1 確認事項チェックリスト

作業開始前に以下を確認してください：

- [ ] 変更管理書の承認完了
- [ ] AWS コンソールへのログイン可能
- [ ] 対象アカウント・リージョンの確認
- [ ] テンプレートファイルの準備
- [ ] パラメータ値の確認
- [ ] 関係者への事前連絡完了

### 2.2 作業環境確認

```bash
# AWS CLI 設定確認
aws sts get-caller-identity

# 対象リージョン確認
aws configure get region
```

### 2.3 バックアップ

更新・削除作業の前に必要に応じてバックアップを取得：

- [ ] RDS スナップショット
- [ ] EBS スナップショット
- [ ] S3 バケットデータ
- [ ] 設定情報のエクスポート

---

## 3. Stack 作成手順

### 3.1 コンソールからの作成

#### 手順

1. **AWS コンソールにログイン**
   - URL: https://console.aws.amazon.com/
   - 対象アカウントであることを確認

2. **CloudFormation サービスに移動**
   - 検索バーで「CloudFormation」を入力
   - リージョンを確認（右上）

3. **Stack 作成開始**
   - 「スタックの作成」→「新しいリソースを使用（標準）」

4. **テンプレートのアップロード**
   - 「テンプレートファイルのアップロード」を選択
   - ファイルを選択してアップロード
   - 「次へ」をクリック

5. **スタックの詳細設定**
   - スタック名: 命名規則に従う
   - パラメータ: 変更管理書の値を入力
   - 「次へ」をクリック

6. **スタックオプション**
   - タグ: 必須タグを設定
     - Environment: dev/stg/prod
     - Owner: 担当者
     - Project: プロジェクト名
   - 「次へ」をクリック

7. **確認と作成**
   - 全設定を確認
   - 「AWS CloudFormation によって IAM リソースが作成される場合があることを承認します」にチェック
   - 「送信」をクリック

8. **作成完了確認**
   - イベントタブで進捗確認
   - ステータスが `CREATE_COMPLETE` になることを確認

#### 作成完了後の確認

- [ ] Stack ステータス: CREATE_COMPLETE
- [ ] リソースタブで全リソース作成確認
- [ ] 出力タブで必要な値を記録
- [ ] 実際のリソース動作確認

### 3.2 CLI からの作成

```bash
# Stack 作成
aws cloudformation create-stack \
  --stack-name <stack-name> \
  --template-body file://template.yaml \
  --parameters \
    ParameterKey=Param1,ParameterValue=Value1 \
    ParameterKey=Param2,ParameterValue=Value2 \
  --tags \
    Key=Environment,Value=prod \
    Key=Owner,Value=ops-team \
  --capabilities CAPABILITY_IAM

# 作成完了を待機
aws cloudformation wait stack-create-complete \
  --stack-name <stack-name>

# ステータス確認
aws cloudformation describe-stacks \
  --stack-name <stack-name> \
  --query 'Stacks[0].StackStatus'
```

---

## 4. Stack 更新手順

### 4.1 ChangeSet を使用した更新（推奨）

**重要**: 本番環境では必ず ChangeSet を使用してください。

#### 手順

1. **ChangeSet 作成**

   ```bash
   aws cloudformation create-change-set \
     --stack-name <stack-name> \
     --change-set-name <change-set-name> \
     --template-body file://template.yaml \
     --parameters \
       ParameterKey=Param1,ParameterValue=NewValue1
   ```

2. **ChangeSet 内容確認**

   ```bash
   aws cloudformation describe-change-set \
     --stack-name <stack-name> \
     --change-set-name <change-set-name>
   ```

   **確認ポイント**:
   - `Action`: Add, Modify, Remove
   - `Replacement`: True の場合は要注意（リソース再作成）
   - `Scope`: 変更される属性

3. **コンソールでスクリーンショット取得**
   - 変更管理書に添付するため

4. **ChangeSet 実行**

   ```bash
   aws cloudformation execute-change-set \
     --stack-name <stack-name> \
     --change-set-name <change-set-name>
   ```

5. **更新完了確認**

   ```bash
   aws cloudformation wait stack-update-complete \
     --stack-name <stack-name>
   ```

### 4.2 コンソールからの更新

1. CloudFormation コンソールで対象 Stack を選択
2. 「更新」をクリック
3. 「既存テンプレートを置き換える」を選択
4. 新しいテンプレートをアップロード
5. パラメータを確認・修正
6. **「変更セットのプレビュー」で必ず確認**
7. 問題なければ「送信」

---

## 5. Stack 削除手順

### 5.1 削除前確認

**重要**: 削除は取り消せません。十分な確認を行ってください。

確認チェックリスト:
- [ ] 変更管理書の承認完了
- [ ] 依存する他の Stack がないことを確認
- [ ] 必要なバックアップ取得完了
- [ ] DeletionPolicy: Retain のリソースを把握
- [ ] 関係者への最終確認完了

### 5.2 削除手順

#### CLI

```bash
# Stack 削除
aws cloudformation delete-stack \
  --stack-name <stack-name>

# 削除完了を待機
aws cloudformation wait stack-delete-complete \
  --stack-name <stack-name>
```

#### コンソール

1. CloudFormation コンソールで対象 Stack を選択
2. 「削除」をクリック
3. 確認ダイアログで「削除」を再度クリック
4. イベントタブで削除進捗を確認
5. Stack が一覧から消えることを確認

### 5.3 削除後確認

- [ ] Stack が一覧から削除されていること
- [ ] リソースが削除されていること（Retain 除く）
- [ ] 関連する監視設定の確認
- [ ] DNS 設定など外部連携の確認

---

## 6. トラブルシューティング

### 6.1 よくあるエラーと対処

#### CREATE_FAILED

| エラー | 原因 | 対処 |
|--------|------|------|
| Resource limit exceeded | リソース上限到達 | Service Quotas で上限引き上げ申請 |
| Access Denied | IAM 権限不足 | 必要な権限を追加 |
| Invalid parameter | パラメータ値が不正 | パラメータ値を確認・修正 |

#### UPDATE_ROLLBACK_FAILED

```bash
# 問題のあるリソースをスキップして続行
aws cloudformation continue-update-rollback \
  --stack-name <stack-name> \
  --resources-to-skip <logical-resource-id>
```

#### DELETE_FAILED

S3 バケットが空でない場合:
```bash
# バケット内オブジェクト削除
aws s3 rm s3://<bucket-name> --recursive

# 再度 Stack 削除
aws cloudformation delete-stack --stack-name <stack-name>
```

### 6.2 ログ確認方法

```bash
# Stack イベント確認
aws cloudformation describe-stack-events \
  --stack-name <stack-name> \
  --query 'StackEvents[?ResourceStatus==`CREATE_FAILED` || ResourceStatus==`UPDATE_FAILED`]'

# CloudTrail でAPI操作確認
aws cloudtrail lookup-events \
  --lookup-attributes AttributeKey=EventSource,AttributeValue=cloudformation.amazonaws.com
```

---

## 7. 緊急時対応

### 7.1 緊急連絡先

| 役割 | 担当者 | 電話番号 | メール |
|------|--------|---------|--------|
| 一次対応 | | | |
| エスカレーション先 | | | |
| AWS サポート | | | |

### 7.2 障害発生時フロー

```
障害検知
    │
    ▼
一次切り分け（5分以内）
    │
    ├── 自動ロールバック中 → 完了まで監視
    │
    ├── 手動対応必要 → 切り戻し手順実行
    │
    └── 判断不能 → エスカレーション
```

### 7.3 緊急連絡テンプレート

```
【緊急】CloudFormation 障害発生

■ 発生日時: YYYY/MM/DD HH:MM
■ 対象 Stack:
■ 事象:
■ 影響:
■ 現在の対応状況:
■ 次回報告予定:

担当:
連絡先:
```

---

## 改訂履歴

| 版数 | 日付 | 変更内容 | 変更者 |
|------|------|---------|--------|
| v1.0 | YYYY/MM/DD | 初版作成 | |
| | | | |

---

*このテンプレートは CloudFormation 課程 Lesson 06 の教材です。*
*実際の業務では、組織のルールに合わせてカスタマイズしてください。*
