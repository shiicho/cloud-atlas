---
# 05-loops-advanced.yaml - 高级循环模式
# 学习目标: 掌握 range, dict2items, subelements 等现代循环语法
# 注意: 使用现代 loop + filter 语法，替代旧版 with_* 语法

- name: Advanced Loop Patterns
  hosts: all
  become: true

  vars:
    user_directories:
      alice:
        - documents
        - downloads
        - scripts
      bob:
        - projects
        - data

    services_config:
      sshd:
        port: 22
        enabled: true
      httpd:
        port: 80
        enabled: false

  tasks:
    # range filter - 数字序列（现代写法，替代 with_sequence）
    - name: Create numbered directories
      ansible.builtin.file:
        path: "/tmp/dir_{{ '%02d' | format(item) }}"
        state: directory
        mode: '0755'
      loop: "{{ range(1, 6) | list }}"

    # range with step - 带步进（现代写法）
    - name: Create even numbered files
      ansible.builtin.file:
        path: "/tmp/even_{{ item }}.txt"
        state: touch
        mode: '0644'
      loop: "{{ range(0, 11, 2) | list }}"

    # dict2items - 字典遍历（现代写法，替代 with_dict）
    - name: Show service configuration
      ansible.builtin.debug:
        msg: "Service {{ item.key }}: port={{ item.value.port }}, enabled={{ item.value.enabled }}"
      loop: "{{ services_config | dict2items }}"

    # subelements - 嵌套循环（现代写法，替代 with_subelements）
    - name: Create user directories
      ansible.builtin.file:
        path: "/home/{{ item.0.key }}/{{ item.1 }}"
        state: directory
        mode: '0755'
        owner: "{{ item.0.key }}"
      loop: "{{ user_directories | dict2items | subelements('value') }}"
      loop_control:
        label: "{{ item.0.key }}/{{ item.1 }}"
      ignore_errors: true  # 用户可能不存在

    # until - 重试直到成功（保持不变，这是正确用法）
    - name: Wait for file to appear (simulated)
      ansible.builtin.command: test -f /tmp/dir_01
      register: result
      until: result.rc == 0
      retries: 3
      delay: 1
      changed_when: false

    # random filter - 随机选择（现代写法，替代 with_random_choice）
    - name: Pick a random color
      ansible.builtin.debug:
        msg: "Selected color: {{ ['red', 'green', 'blue', 'yellow'] | random }}"

    # 清理
    - name: Cleanup test directories
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      loop:
        - /tmp/dir_01
        - /tmp/dir_02
        - /tmp/dir_03
        - /tmp/dir_04
        - /tmp/dir_05
      tags: cleanup
...
